/*==============================================================*/
/* Database name:  InnoLS                                       */
/* DBMS name:      Microsoft SQL Server 2008                    */
/* Created on:     10/3/2015 9:29:01 PM                         */
/*==============================================================*/


if exists (select 1
          from sysobjects
          where id = object_id('dbo.Trigger_UpdateFlowStep')
          and type = 'TR')
   drop trigger dbo.Trigger_UpdateFlowStep
go

if exists (select 1
          from sysobjects
          where id = object_id('dbo.Trigger_UpdatePlanState')
          and type = 'TR')
   drop trigger dbo.Trigger_UpdatePlanState
go

if exists (select 1
          from sysobjects
          where id = object_id('Trigger_UpdateStaff')
          and type = 'TR')
   drop trigger Trigger_UpdateStaff
go

if exists (select 1
          from sysobjects
          where id = object_id('Trigger_InsertStaff')
          and type = 'TR')
   drop trigger Trigger_InsertStaff
go

if exists (select 1
          from sysobjects
          where id = object_id('Trigger_DeleteStaff')
          and type = 'TR')
   drop trigger Trigger_DeleteStaff
go

if exists (select 1
          from sysobjects
          where  id = object_id('CancelDeliverPlan')
          and type in ('P','PC'))
   drop procedure CancelDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('CancelDispatchBill')
          and type in ('P','PC'))
   drop procedure CancelDispatchBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('CheckDispatchBill')
          and type in ('P','PC'))
   drop procedure CheckDispatchBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('CheckForReturnDispatch')
          and type in ('P','PC'))
   drop procedure CheckForReturnDispatch
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateContractGoods')
          and type in ('P','PC'))
   drop procedure UpdateContractGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateDeliverBillGoods')
          and type in ('P','PC'))
   drop procedure UpdateDeliverBillGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertMoveWarehouseBillGoods')
          and type in ('P','PC'))
   drop procedure InsertMoveWarehouseBillGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertOutWarehouseBillGoods')
          and type in ('P','PC'))
   drop procedure InsertOutWarehouseBillGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('SubmitPrintShipmentBill')
          and type in ('P','PC'))
   drop procedure SubmitPrintShipmentBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateShipmentBillGoods')
          and type in ('P','PC'))
   drop procedure UpdateShipmentBillGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertDeliverPlanGoods')
          and type in ('P','PC'))
   drop procedure InsertDeliverPlanGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('SubmitDeliverPlan')
          and type in ('P','PC'))
   drop procedure SubmitDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('CustomerAgreeDeliverPlan')
          and type in ('P','PC'))
   drop procedure CustomerAgreeDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('CheckStock')
          and type in ('P','PC'))
   drop procedure CheckStock
go

if exists (select 1
          from sysobjects
          where  id = object_id('CompareDate')
          and type in ('IF', 'FN', 'TF'))
   drop function CompareDate
go

if exists (select 1
          from sysobjects
          where  id = object_id('CopyDeliverPlan')
          and type in ('P','PC'))
   drop procedure CopyDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('CustomerDisagreeDeliverPlan')
          and type in ('P','PC'))
   drop procedure CustomerDisagreeDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteAccount')
          and type in ('P','PC'))
   drop procedure DeleteAccount
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteAccountPermissions')
          and type in ('P','PC'))
   drop procedure DeleteAccountPermissions
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteApproveFlowStep')
          and type in ('P','PC'))
   drop procedure DeleteApproveFlowStep
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteApproveFlowStepConditions')
          and type in ('P','PC'))
   drop procedure DeleteApproveFlowStepConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCarrier')
          and type in ('P','PC'))
   drop procedure DeleteCarrier
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCarrierCar')
          and type in ('P','PC'))
   drop procedure DeleteCarrierCar
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCarrierCars')
          and type in ('P','PC'))
   drop procedure DeleteCarrierCars
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCarrierDrivers')
          and type in ('P','PC'))
   drop procedure DeleteCarrierDrivers
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCarrierSettlementExpressions')
          and type in ('P','PC'))
   drop procedure DeleteCarrierSettlementExpressions
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCarrierTransportChargesSettlement')
          and type in ('P','PC'))
   drop procedure DeleteCarrierTransportChargesSettlement
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCarrierTransportChargesSettlementDetails')
          and type in ('P','PC'))
   drop procedure DeleteCarrierTransportChargesSettlementDetails
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCarrierTransportPrices')
          and type in ('P','PC'))
   drop procedure DeleteCarrierTransportPrices
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCity')
          and type in ('P','PC'))
   drop procedure DeleteCity
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteContract')
          and type in ('P','PC'))
   drop procedure DeleteContract
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteContractDeliverPlans')
          and type in ('P','PC'))
   drop procedure DeleteContractDeliverPlans
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteContractFine')
          and type in ('P','PC'))
   drop procedure DeleteContractFine
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteContractReverse')
          and type in ('P','PC'))
   drop procedure DeleteContractReverse
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteContractReverseDetails')
          and type in ('P','PC'))
   drop procedure DeleteContractReverseDetails
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCountry')
          and type in ('P','PC'))
   drop procedure DeleteCountry
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCustomer')
          and type in ('P','PC'))
   drop procedure DeleteCustomer
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCustomerForceFeePrices')
          and type in ('P','PC'))
   drop procedure DeleteCustomerForceFeePrices
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCustomerStorageAndForceFeeSettlement')
          and type in ('P','PC'))
   drop procedure DeleteCustomerStorageAndForceFeeSettlement
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCustomerStorageFeePrices')
          and type in ('P','PC'))
   drop procedure DeleteCustomerStorageFeePrices
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCustomerTransportChargesSettlement')
          and type in ('P','PC'))
   drop procedure DeleteCustomerTransportChargesSettlement
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCustomerTransportChargesSettlementDetails')
          and type in ('P','PC'))
   drop procedure DeleteCustomerTransportChargesSettlementDetails
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteCustomerTransportPrices')
          and type in ('P','PC'))
   drop procedure DeleteCustomerTransportPrices
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDeliverBill')
          and type in ('P','PC'))
   drop procedure DeleteDeliverBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDeliverBillAllGoods')
          and type in ('P','PC'))
   drop procedure DeleteDeliverBillAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDeliverBillCarrierTransportPrice')
          and type in ('P','PC'))
   drop procedure DeleteDeliverBillCarrierTransportPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDeliverBillCustomerTransportPrice')
          and type in ('P','PC'))
   drop procedure DeleteDeliverBillCustomerTransportPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDeliverPlan')
          and type in ('P','PC'))
   drop procedure DeleteDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDeliverPlanAllGoods')
          and type in ('P','PC'))
   drop procedure DeleteDeliverPlanAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDispatchBill')
          and type in ('P','PC'))
   drop procedure DeleteDispatchBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDispatchBillAllGoods')
          and type in ('P','PC'))
   drop procedure DeleteDispatchBillAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDispatchBillDeliverPlan')
          and type in ('P','PC'))
   drop procedure DeleteDispatchBillDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDispatchBillDeliverPlanAllGoods')
          and type in ('P','PC'))
   drop procedure DeleteDispatchBillDeliverPlanAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteDispatchBillDeliverPlans')
          and type in ('P','PC'))
   drop procedure DeleteDispatchBillDeliverPlans
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteEnterWarehouseBill')
          and type in ('P','PC'))
   drop procedure DeleteEnterWarehouseBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteEnterWarehouseBillAllGoods')
          and type in ('P','PC'))
   drop procedure DeleteEnterWarehouseBillAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteEnterWarehouseBillGoods')
          and type in ('P','PC'))
   drop procedure DeleteEnterWarehouseBillGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteGoods')
          and type in ('P','PC'))
   drop procedure DeleteGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteGoodsType')
          and type in ('P','PC'))
   drop procedure DeleteGoodsType
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteGroupPermissions')
          and type in ('P','PC'))
   drop procedure DeleteGroupPermissions
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteMoveWarehouseBill')
          and type in ('P','PC'))
   drop procedure DeleteMoveWarehouseBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteOrganization')
          and type in ('P','PC'))
   drop procedure DeleteOrganization
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteOutWarehouseBill')
          and type in ('P','PC'))
   drop procedure DeleteOutWarehouseBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteOutWarehouseBillAllGoods')
          and type in ('P','PC'))
   drop procedure DeleteOutWarehouseBillAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeletePermissionGroup')
          and type in ('P','PC'))
   drop procedure DeletePermissionGroup
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeletePosition')
          and type in ('P','PC'))
   drop procedure DeletePosition
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteProvince')
          and type in ('P','PC'))
   drop procedure DeleteProvince
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteReceiver')
          and type in ('P','PC'))
   drop procedure DeleteReceiver
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteReceiverDistances')
          and type in ('P','PC'))
   drop procedure DeleteReceiverDistances
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteShipmentBill')
          and type in ('P','PC'))
   drop procedure DeleteShipmentBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteShipmentBillAllGoods')
          and type in ('P','PC'))
   drop procedure DeleteShipmentBillAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteStaff')
          and type in ('P','PC'))
   drop procedure DeleteStaff
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteTransportLimitedPrice')
          and type in ('P','PC'))
   drop procedure DeleteTransportLimitedPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('DeleteWarehouse')
          and type in ('P','PC'))
   drop procedure DeleteWarehouse
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadFunctions')
          and type in ('P','PC'))
   drop procedure LoadFunctions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadPermissionGroups')
          and type in ('P','PC'))
   drop procedure LoadPermissionGroups
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertPermissionGroup')
          and type in ('P','PC'))
   drop procedure InsertPermissionGroup
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAccountPermissions')
          and type in ('P','PC'))
   drop procedure LoadAccountPermissions
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertAccountPermission')
          and type in ('P','PC'))
   drop procedure InsertAccountPermission
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadOpLogs')
          and type in ('P','PC'))
   drop procedure LoadOpLogs
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadLoginLogs')
          and type in ('P','PC'))
   drop procedure LoadLoginLogs
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadOrganizations')
          and type in ('P','PC'))
   drop procedure LoadOrganizations
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAccounts')
          and type in ('P','PC'))
   drop procedure LoadAccounts
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadPositions')
          and type in ('P','PC'))
   drop procedure LoadPositions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadPosition')
          and type in ('P','PC'))
   drop procedure LoadPosition
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCountrys')
          and type in ('P','PC'))
   drop procedure LoadCountrys
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCountry')
          and type in ('P','PC'))
   drop procedure InsertCountry
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCountry')
          and type in ('P','PC'))
   drop procedure LoadCountry
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateCountry')
          and type in ('P','PC'))
   drop procedure UpdateCountry
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadProvinces')
          and type in ('P','PC'))
   drop procedure LoadProvinces
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadProvince')
          and type in ('P','PC'))
   drop procedure LoadProvince
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertProvince')
          and type in ('P','PC'))
   drop procedure InsertProvince
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateProvince')
          and type in ('P','PC'))
   drop procedure UpdateProvince
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCitys')
          and type in ('P','PC'))
   drop procedure LoadCitys
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCity')
          and type in ('P','PC'))
   drop procedure LoadCity
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCity')
          and type in ('P','PC'))
   drop procedure InsertCity
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateCity')
          and type in ('P','PC'))
   drop procedure UpdateCity
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertOrganization')
          and type in ('P','PC'))
   drop procedure InsertOrganization
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadOrganization')
          and type in ('P','PC'))
   drop procedure LoadOrganization
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateOrganization')
          and type in ('P','PC'))
   drop procedure UpdateOrganization
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertPosition')
          and type in ('P','PC'))
   drop procedure InsertPosition
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdatePosition')
          and type in ('P','PC'))
   drop procedure UpdatePosition
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertStaff')
          and type in ('P','PC'))
   drop procedure InsertStaff
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateStaff')
          and type in ('P','PC'))
   drop procedure UpdateStaff
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomer')
          and type in ('P','PC'))
   drop procedure LoadCustomer
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertDeliverPlan')
          and type in ('P','PC'))
   drop procedure InsertDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateDeliverPlan')
          and type in ('P','PC'))
   drop procedure UpdateDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertOutWarehouseBill')
          and type in ('P','PC'))
   drop procedure InsertOutWarehouseBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCustomer')
          and type in ('P','PC'))
   drop procedure InsertCustomer
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateCustomer')
          and type in ('P','PC'))
   drop procedure UpdateCustomer
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadProvincesByCountry')
          and type in ('P','PC'))
   drop procedure LoadProvincesByCountry
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCitysByProvince')
          and type in ('P','PC'))
   drop procedure LoadCitysByProvince
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadGoodsTypes')
          and type in ('P','PC'))
   drop procedure LoadGoodsTypes
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadGoodsType')
          and type in ('P','PC'))
   drop procedure LoadGoodsType
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateGoodsType')
          and type in ('P','PC'))
   drop procedure UpdateGoodsType
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadStaffsExcludeSelfAndSubordinates')
          and type in ('P','PC'))
   drop procedure LoadStaffsExcludeSelfAndSubordinates
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadPermissionGroup')
          and type in ('P','PC'))
   drop procedure LoadPermissionGroup
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAppVersion')
          and type in ('P','PC'))
   drop procedure LoadAppVersion
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadSubGoodsTypes')
          and type in ('P','PC'))
   drop procedure LoadSubGoodsTypes
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadStaff')
          and type in ('P','PC'))
   drop procedure LoadStaff
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadStaffs')
          and type in ('P','PC'))
   drop procedure LoadStaffs
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadGroupPermissions')
          and type in ('P','PC'))
   drop procedure LoadGroupPermissions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadFunctionPermission')
          and type in ('P','PC'))
   drop procedure LoadFunctionPermission
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertGroupPermission')
          and type in ('P','PC'))
   drop procedure InsertGroupPermission
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdatePermissionGroup')
          and type in ('P','PC'))
   drop procedure UpdatePermissionGroup
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadStaffsByOrganId')
          and type in ('P','PC'))
   drop procedure LoadStaffsByOrganId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAllStaffsByOrganId')
          and type in ('P','PC'))
   drop procedure LoadAllStaffsByOrganId
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertAccount')
          and type in ('P','PC'))
   drop procedure InsertAccount
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAccount')
          and type in ('P','PC'))
   drop procedure LoadAccount
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomers')
          and type in ('P','PC'))
   drop procedure LoadCustomers
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateAccount')
          and type in ('P','PC'))
   drop procedure UpdateAccount
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadActiveAccounts')
          and type in ('P','PC'))
   drop procedure LoadActiveAccounts
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAllSubGoodsTypes')
          and type in ('P','PC'))
   drop procedure LoadAllSubGoodsTypes
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCitysByCountry')
          and type in ('P','PC'))
   drop procedure LoadCitysByCountry
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertGoodsType')
          and type in ('P','PC'))
   drop procedure InsertGoodsType
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerTransportPricesByCustomerId')
          and type in ('P','PC'))
   drop procedure LoadCustomerTransportPricesByCustomerId
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCustomerTransportPrice')
          and type in ('P','PC'))
   drop procedure InsertCustomerTransportPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAllGoodsByConditions')
          and type in ('P','PC'))
   drop procedure LoadAllGoodsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertEnterWarehouseBillGoods')
          and type in ('P','PC'))
   drop procedure InsertEnterWarehouseBillGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertGoods')
          and type in ('P','PC'))
   drop procedure InsertGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadGoods')
          and type in ('P','PC'))
   drop procedure LoadGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateEnterWarehouseBillGoods')
          and type in ('P','PC'))
   drop procedure UpdateEnterWarehouseBillGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateGoods')
          and type in ('P','PC'))
   drop procedure UpdateGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadWarehouses')
          and type in ('P','PC'))
   drop procedure LoadWarehouses
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertWarehouse')
          and type in ('P','PC'))
   drop procedure InsertWarehouse
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadWarehouse')
          and type in ('P','PC'))
   drop procedure LoadWarehouse
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateWarehouse')
          and type in ('P','PC'))
   drop procedure UpdateWarehouse
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarriers')
          and type in ('P','PC'))
   drop procedure LoadCarriers
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierCars')
          and type in ('P','PC'))
   drop procedure LoadCarrierCars
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierTransportPrices')
          and type in ('P','PC'))
   drop procedure LoadCarrierTransportPrices
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertDispatchBill')
          and type in ('P','PC'))
   drop procedure InsertDispatchBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateDispatchBill')
          and type in ('P','PC'))
   drop procedure UpdateDispatchBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateContract')
          and type in ('P','PC'))
   drop procedure UpdateContract
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCarrier')
          and type in ('P','PC'))
   drop procedure InsertCarrier
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCarrierTransportPrice')
          and type in ('P','PC'))
   drop procedure InsertCarrierTransportPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCarrierCar')
          and type in ('P','PC'))
   drop procedure InsertCarrierCar
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrier')
          and type in ('P','PC'))
   drop procedure LoadCarrier
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateCarrier')
          and type in ('P','PC'))
   drop procedure UpdateCarrier
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierDrivers')
          and type in ('P','PC'))
   drop procedure LoadCarrierDrivers
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCarrierDriver')
          and type in ('P','PC'))
   drop procedure InsertCarrierDriver
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadTransportLimitedPricesByConditions')
          and type in ('P','PC'))
   drop procedure LoadTransportLimitedPricesByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertTransportLimitedPrice')
          and type in ('P','PC'))
   drop procedure InsertTransportLimitedPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadTransportLimitedPrice')
          and type in ('P','PC'))
   drop procedure LoadTransportLimitedPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateTransportLimitedPrice')
          and type in ('P','PC'))
   drop procedure UpdateTransportLimitedPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAccountPermission')
          and type in ('P','PC'))
   drop procedure LoadAccountPermission
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadReceivers')
          and type in ('P','PC'))
   drop procedure LoadReceivers
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCars')
          and type in ('P','PC'))
   drop procedure LoadCars
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDriversByCarNo')
          and type in ('P','PC'))
   drop procedure LoadDriversByCarNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDriver')
          and type in ('P','PC'))
   drop procedure LoadDriver
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadReceiverByName')
          and type in ('P','PC'))
   drop procedure LoadReceiverByName
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarByCarNo')
          and type in ('P','PC'))
   drop procedure LoadCarByCarNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadGoodsByGoodsNo')
          and type in ('P','PC'))
   drop procedure LoadGoodsByGoodsNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerByName')
          and type in ('P','PC'))
   drop procedure LoadCustomerByName
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadGoodsStocksByConditions')
          and type in ('P','PC'))
   drop procedure LoadGoodsStocksByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadSubmitDeliverPlans')
          and type in ('P','PC'))
   drop procedure LoadSubmitDeliverPlans
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverPlan')
          and type in ('P','PC'))
   drop procedure LoadDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverPlanAllGoods')
          and type in ('P','PC'))
   drop procedure LoadDeliverPlanAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverPlanGoodsBalancesByConditions')
          and type in ('P','PC'))
   drop procedure LoadDeliverPlanGoodsBalancesByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerApproveDeliverPlans')
          and type in ('P','PC'))
   drop procedure LoadCustomerApproveDeliverPlans
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertEnterWarehouseBill')
          and type in ('P','PC'))
   drop procedure InsertEnterWarehouseBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertApproveFlowStep')
          and type in ('P','PC'))
   drop procedure InsertApproveFlowStep
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateApproveFlowStep')
          and type in ('P','PC'))
   drop procedure UpdateApproveFlowStep
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadApproveFlowStep')
          and type in ('P','PC'))
   drop procedure LoadApproveFlowStep
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadApproveFlowStepsByFlowType')
          and type in ('P','PC'))
   drop procedure LoadApproveFlowStepsByFlowType
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertApproveFlowStepCondition')
          and type in ('P','PC'))
   drop procedure InsertApproveFlowStepCondition
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadApproveFlowStepConditionsByStepId')
          and type in ('P','PC'))
   drop procedure LoadApproveFlowStepConditionsByStepId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadApproveFlowStepConditionsByFlowType')
          and type in ('P','PC'))
   drop procedure LoadApproveFlowStepConditionsByFlowType
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadApproveDeliverPlans')
          and type in ('P','PC'))
   drop procedure LoadApproveDeliverPlans
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverPlansByConditions')
          and type in ('P','PC'))
   drop procedure LoadDeliverPlansByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadForeignDeliverPlans')
          and type in ('P','PC'))
   drop procedure LoadForeignDeliverPlans
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchDeliverPlans')
          and type in ('P','PC'))
   drop procedure LoadDispatchDeliverPlans
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAllDispatchBillGoodsByConditions')
          and type in ('P','PC'))
   drop procedure LoadAllDispatchBillGoodsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchBillDeliverPlansByCarNo')
          and type in ('P','PC'))
   drop procedure LoadDispatchBillDeliverPlansByCarNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierByCarNo')
          and type in ('P','PC'))
   drop procedure LoadCarrierByCarNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierTransportPrice')
          and type in ('P','PC'))
   drop procedure LoadCarrierTransportPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchPaperPlanAllGoods')
          and type in ('P','PC'))
   drop procedure LoadDispatchPaperPlanAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertDispatchBillDeliverPlan')
          and type in ('P','PC'))
   drop procedure InsertDispatchBillDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertDispatchBillGoods')
          and type in ('P','PC'))
   drop procedure InsertDispatchBillGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadSubmitDispatchBillByCarNo')
          and type in ('P','PC'))
   drop procedure LoadSubmitDispatchBillByCarNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadSubmitDispatchBills')
          and type in ('P','PC'))
   drop procedure LoadSubmitDispatchBills
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadReceiverDistance')
          and type in ('P','PC'))
   drop procedure LoadReceiverDistance
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierSettlementExpressions')
          and type in ('P','PC'))
   drop procedure LoadCarrierSettlementExpressions
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCarrierSettlementExpression')
          and type in ('P','PC'))
   drop procedure InsertCarrierSettlementExpression
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierSettlementExpression')
          and type in ('P','PC'))
   drop procedure LoadCarrierSettlementExpression
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchBillDeliverPlans')
          and type in ('P','PC'))
   drop procedure LoadDispatchBillDeliverPlans
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchBillAllGoods')
          and type in ('P','PC'))
   drop procedure LoadDispatchBillAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchBillAllGoodsByPlanId')
          and type in ('P','PC'))
   drop procedure LoadDispatchBillAllGoodsByPlanId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchBillAllGoodsByCarNoAndPlanId')
          and type in ('P','PC'))
   drop procedure LoadDispatchBillAllGoodsByCarNoAndPlanId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchBillAllGoodsByCarNo')
          and type in ('P','PC'))
   drop procedure LoadDispatchBillAllGoodsByCarNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchDeliverPlanAllGoods')
          and type in ('P','PC'))
   drop procedure LoadDispatchDeliverPlanAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchedDeliverPlanAllGoods')
          and type in ('P','PC'))
   drop procedure LoadDispatchedDeliverPlanAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchBillDeliverPlan')
          and type in ('P','PC'))
   drop procedure LoadDispatchBillDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateDispatchBillDeliverPlan')
          and type in ('P','PC'))
   drop procedure UpdateDispatchBillDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchBill')
          and type in ('P','PC'))
   drop procedure LoadDispatchBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('SubmitDispatchBill')
          and type in ('P','PC'))
   drop procedure SubmitDispatchBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadPrintAllocateShipmentBills')
          and type in ('P','PC'))
   drop procedure LoadPrintAllocateShipmentBills
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadShipmentBillAllGoods')
          and type in ('P','PC'))
   drop procedure LoadShipmentBillAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadShipmentBill')
          and type in ('P','PC'))
   drop procedure LoadShipmentBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadSubmitShipmentBills')
          and type in ('P','PC'))
   drop procedure LoadSubmitShipmentBills
go

if exists (select 1
          from sysobjects
          where  id = object_id('SubmitShipmentBill')
          and type in ('P','PC'))
   drop procedure SubmitShipmentBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadOutWarehouseBill')
          and type in ('P','PC'))
   drop procedure LoadOutWarehouseBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadOutWarehouseBillAllGoods')
          and type in ('P','PC'))
   drop procedure LoadOutWarehouseBillAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateOutWarehouseBill')
          and type in ('P','PC'))
   drop procedure UpdateOutWarehouseBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateOutWarehouseBillGoods')
          and type in ('P','PC'))
   drop procedure UpdateOutWarehouseBillGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadEnterWarehouseBill')
          and type in ('P','PC'))
   drop procedure LoadEnterWarehouseBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadEnterWarehouseBillAllGoods')
          and type in ('P','PC'))
   drop procedure LoadEnterWarehouseBillAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateEnterWarehouseBill')
          and type in ('P','PC'))
   drop procedure UpdateEnterWarehouseBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadPrintDeliverBills')
          and type in ('P','PC'))
   drop procedure LoadPrintDeliverBills
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillAllGoods')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBill')
          and type in ('P','PC'))
   drop procedure LoadDeliverBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('SubmitPrintDeliverBill')
          and type in ('P','PC'))
   drop procedure SubmitPrintDeliverBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadReceiptDeliverBillsByConditions')
          and type in ('P','PC'))
   drop procedure LoadReceiptDeliverBillsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateDeliverBillReceipt')
          and type in ('P','PC'))
   drop procedure UpdateDeliverBillReceipt
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContractDispatchBills')
          and type in ('P','PC'))
   drop procedure LoadContractDispatchBills
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertContract')
          and type in ('P','PC'))
   drop procedure InsertContract
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertContractDeliverPlan')
          and type in ('P','PC'))
   drop procedure InsertContractDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadSubmitContracts')
          and type in ('P','PC'))
   drop procedure LoadSubmitContracts
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContract')
          and type in ('P','PC'))
   drop procedure LoadContract
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContractDeliverPlans')
          and type in ('P','PC'))
   drop procedure LoadContractDeliverPlans
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateContractDeliverPlan')
          and type in ('P','PC'))
   drop procedure UpdateContractDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('SubmitContract')
          and type in ('P','PC'))
   drop procedure SubmitContract
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadPrintContracts')
          and type in ('P','PC'))
   drop procedure LoadPrintContracts
go

if exists (select 1
          from sysobjects
          where  id = object_id('SubmitPrintContract')
          and type in ('P','PC'))
   drop procedure SubmitPrintContract
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateContractApprover')
          and type in ('P','PC'))
   drop procedure UpdateContractApprover
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadApproveContractsByConditions')
          and type in ('P','PC'))
   drop procedure LoadApproveContractsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContractPriceOverPercentage')
          and type in ('P','PC'))
   drop procedure LoadContractPriceOverPercentage
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateContractApproveState')
          and type in ('P','PC'))
   drop procedure UpdateContractApproveState
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateContractDeliverPlanApprovedTransportPrice')
          and type in ('P','PC'))
   drop procedure UpdateContractDeliverPlanApprovedTransportPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadReverseContractsByConditions')
          and type in ('P','PC'))
   drop procedure LoadReverseContractsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContractReverseDetails')
          and type in ('P','PC'))
   drop procedure LoadContractReverseDetails
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertContractReverse')
          and type in ('P','PC'))
   drop procedure InsertContractReverse
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertContractReverseDetail')
          and type in ('P','PC'))
   drop procedure InsertContractReverseDetail
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContractReversesByConditions')
          and type in ('P','PC'))
   drop procedure LoadContractReversesByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContractReverseDetailsByReverseId')
          and type in ('P','PC'))
   drop procedure LoadContractReverseDetailsByReverseId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadStaffAccounts')
          and type in ('P','PC'))
   drop procedure LoadStaffAccounts
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadFineContractsByConditions')
          and type in ('P','PC'))
   drop procedure LoadFineContractsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateContractFineAmount')
          and type in ('P','PC'))
   drop procedure UpdateContractFineAmount
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadEnterWarehouseBillGoodsByConditions')
          and type in ('P','PC'))
   drop procedure LoadEnterWarehouseBillGoodsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadOutWarehouseBillGoodsByConditions')
          and type in ('P','PC'))
   drop procedure LoadOutWarehouseBillGoodsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertMoveWarehouseBill')
          and type in ('P','PC'))
   drop procedure InsertMoveWarehouseBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadMoveWarehouseBillGoodsByConditions')
          and type in ('P','PC'))
   drop procedure LoadMoveWarehouseBillGoodsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadEnterOutBalanceSummariesByConditions')
          and type in ('P','PC'))
   drop procedure LoadEnterOutBalanceSummariesByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadStatStorageAndForceFeeByConditions')
          and type in ('P','PC'))
   drop procedure LoadStatStorageAndForceFeeByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadConsigningDeliverPlanDeliverGoodsByConditions')
          and type in ('P','PC'))
   drop procedure LoadConsigningDeliverPlanDeliverGoodsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadStocktakingByConditions')
          and type in ('P','PC'))
   drop procedure LoadStocktakingByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerReceivers')
          and type in ('P','PC'))
   drop procedure LoadCustomerReceivers
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierCarsByName')
          and type in ('P','PC'))
   drop procedure LoadCarrierCarsByName
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerStatementByConditions')
          and type in ('P','PC'))
   drop procedure LoadCustomerStatementByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadGenerateBusinessPayersByTimespan')
          and type in ('P','PC'))
   drop procedure LoadGenerateBusinessPayersByTimespan
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCustomerTransportChargesSettlement')
          and type in ('P','PC'))
   drop procedure InsertCustomerTransportChargesSettlement
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCustomerTransportChargesSettlementDetail')
          and type in ('P','PC'))
   drop procedure InsertCustomerTransportChargesSettlementDetail
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerTransportChargesSettlementsByConditions')
          and type in ('P','PC'))
   drop procedure LoadCustomerTransportChargesSettlementsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerTransportChargesSettlementDetails')
          and type in ('P','PC'))
   drop procedure LoadCustomerTransportChargesSettlementDetails
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadGenerateBusinessCarriersByTimespan')
          and type in ('P','PC'))
   drop procedure LoadGenerateBusinessCarriersByTimespan
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierStatementByConditions')
          and type in ('P','PC'))
   drop procedure LoadCarrierStatementByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierByName')
          and type in ('P','PC'))
   drop procedure LoadCarrierByName
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCarrierTransportChargesSettlement')
          and type in ('P','PC'))
   drop procedure InsertCarrierTransportChargesSettlement
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCarrierTransportChargesSettlementDetail')
          and type in ('P','PC'))
   drop procedure InsertCarrierTransportChargesSettlementDetail
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierTransportChargesSettlementsByConditions')
          and type in ('P','PC'))
   drop procedure LoadCarrierTransportChargesSettlementsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarrierTransportChargesSettlementDetails')
          and type in ('P','PC'))
   drop procedure LoadCarrierTransportChargesSettlementDetails
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadOrganTotalOutputDetailsByConditions')
          and type in ('P','PC'))
   drop procedure LoadOrganTotalOutputDetailsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillNosByNo')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillNosByNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillByNo')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillByNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillCustomerTransportPriceByDeliverBillId')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillCustomerTransportPriceByDeliverBillId
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertDeliverBillCustomerTransportPrice')
          and type in ('P','PC'))
   drop procedure InsertDeliverBillCustomerTransportPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerTransportPriceByPlanId')
          and type in ('P','PC'))
   drop procedure LoadCustomerTransportPriceByPlanId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillCustomerTransportPricesByConditions')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillCustomerTransportPricesByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContractFinesByConditions')
          and type in ('P','PC'))
   drop procedure LoadContractFinesByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContractPriceOverAmount')
          and type in ('P','PC'))
   drop procedure LoadContractPriceOverAmount
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillReceiptsByConditions')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillReceiptsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchDeliverPlansByCustomerIdAndWarehouse')
          and type in ('P','PC'))
   drop procedure LoadDispatchDeliverPlansByCustomerIdAndWarehouse
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadApproveFlowNextStepsByFlowTypeAndStepNum')
          and type in ('P','PC'))
   drop procedure LoadApproveFlowNextStepsByFlowTypeAndStepNum
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAllGoodsByGoodsNo')
          and type in ('P','PC'))
   drop procedure LoadAllGoodsByGoodsNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerNamesByName')
          and type in ('P','PC'))
   drop procedure LoadCustomerNamesByName
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadReceiverNamesByName')
          and type in ('P','PC'))
   drop procedure LoadReceiverNamesByName
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerTotalOutputDetailsByConditions')
          and type in ('P','PC'))
   drop procedure LoadCustomerTotalOutputDetailsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadShipmentBillsByConditions')
          and type in ('P','PC'))
   drop procedure LoadShipmentBillsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillsByConditions')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('ReturnModifyContract')
          and type in ('P','PC'))
   drop procedure ReturnModifyContract
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchBillAllGoodsByContractIdAndPlanId')
          and type in ('P','PC'))
   drop procedure LoadDispatchBillAllGoodsByContractIdAndPlanId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadOutWarehouseBillByShipmentBillId')
          and type in ('P','PC'))
   drop procedure LoadOutWarehouseBillByShipmentBillId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadGenerateStorageAndForceFeeCustomersByTimespan')
          and type in ('P','PC'))
   drop procedure LoadGenerateStorageAndForceFeeCustomersByTimespan
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCustomerStorageAndForceFeeSettlement')
          and type in ('P','PC'))
   drop procedure InsertCustomerStorageAndForceFeeSettlement
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerStorageAndForceFeeSettlementsByConditions')
          and type in ('P','PC'))
   drop procedure LoadCustomerStorageAndForceFeeSettlementsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadReceiverDistances')
          and type in ('P','PC'))
   drop procedure LoadReceiverDistances
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertReceiver')
          and type in ('P','PC'))
   drop procedure InsertReceiver
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertReceiverDistance')
          and type in ('P','PC'))
   drop procedure InsertReceiverDistance
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadReceiver')
          and type in ('P','PC'))
   drop procedure LoadReceiver
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateReceiver')
          and type in ('P','PC'))
   drop procedure UpdateReceiver
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContractApproveComments')
          and type in ('P','PC'))
   drop procedure LoadContractApproveComments
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadStockEndDifferencesByConditions')
          and type in ('P','PC'))
   drop procedure LoadStockEndDifferencesByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDispatchCanPlanAllGoods')
          and type in ('P','PC'))
   drop procedure LoadDispatchCanPlanAllGoods
go

if exists (select 1
          from sysobjects
          where  id = object_id('ReturnDeliverPlan')
          and type in ('P','PC'))
   drop procedure ReturnDeliverPlan
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadPendingCount')
          and type in ('P','PC'))
   drop procedure LoadPendingCount
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarriersByConditions')
          and type in ('P','PC'))
   drop procedure LoadCarriersByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomersByConditions')
          and type in ('P','PC'))
   drop procedure LoadCustomersByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('MergeDispatchBills')
          and type in ('P','PC'))
   drop procedure MergeDispatchBills
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCarsByCarNo')
          and type in ('P','PC'))
   drop procedure LoadCarsByCarNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateCarrierCar')
          and type in ('P','PC'))
   drop procedure UpdateCarrierCar
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadPrintDispatchedShipmentBills')
          and type in ('P','PC'))
   drop procedure LoadPrintDispatchedShipmentBills
go

if exists (select 1
          from sysobjects
          where  id = object_id('GetTotalStock')
          and type in ('P','PC'))
   drop procedure GetTotalStock
go

if exists (select 1
          from sysobjects
          where  id = object_id('SubtractStock')
          and type in ('P','PC'))
   drop procedure SubtractStock
go

if exists (select 1
          from sysobjects
          where  id = object_id('SubtractStockEndDifferences')
          and type in ('P','PC'))
   drop procedure SubtractStockEndDifferences
go

if exists (select 1
          from sysobjects
          where  id = object_id('ReturnDispatchDeliverBill')
          and type in ('P','PC'))
   drop procedure ReturnDispatchDeliverBill
go

if exists (select 1
          from sysobjects
          where  id = object_id('RestoreStock')
          and type in ('P','PC'))
   drop procedure RestoreStock
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadEnterWarehouseBillByPlanId')
          and type in ('P','PC'))
   drop procedure LoadEnterWarehouseBillByPlanId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerForceFeePricesByCustomerId')
          and type in ('P','PC'))
   drop procedure LoadCustomerForceFeePricesByCustomerId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerStorageFeePricesByCustomerId')
          and type in ('P','PC'))
   drop procedure LoadCustomerStorageFeePricesByCustomerId
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCustomerForceFeePrice')
          and type in ('P','PC'))
   drop procedure InsertCustomerForceFeePrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertCustomerStorageFeePrice')
          and type in ('P','PC'))
   drop procedure InsertCustomerStorageFeePrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateCustomerForceFeePrice')
          and type in ('P','PC'))
   drop procedure UpdateCustomerForceFeePrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateCustomerStorageFeePrice')
          and type in ('P','PC'))
   drop procedure UpdateCustomerStorageFeePrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerForceFeePrice')
          and type in ('P','PC'))
   drop procedure LoadCustomerForceFeePrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadCustomerStorageFeePrice')
          and type in ('P','PC'))
   drop procedure LoadCustomerStorageFeePrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadApproveContractsOwnOrgansByTimespan')
          and type in ('P','PC'))
   drop procedure LoadApproveContractsOwnOrgansByTimespan
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadContractsByConditions')
          and type in ('P','PC'))
   drop procedure LoadContractsByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadReverseContractsByContractIds')
          and type in ('P','PC'))
   drop procedure LoadReverseContractsByContractIds
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillsOwnOrgansByTimespan')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillsOwnOrgansByTimespan
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillsPayersByTimespan')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillsPayersByTimespan
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateShipmentBillDeliveryNo')
          and type in ('P','PC'))
   drop procedure UpdateShipmentBillDeliveryNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateDeliverBillDeliveryNo')
          and type in ('P','PC'))
   drop procedure UpdateDeliverBillDeliveryNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadStocksByEnterWarehouseBillId')
          and type in ('P','PC'))
   drop procedure LoadStocksByEnterWarehouseBillId
go

if exists (select 1
          from sysobjects
          where  id = object_id('UpdateStockDeliveryNo')
          and type in ('P','PC'))
   drop procedure UpdateStockDeliveryNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadShipmentBillsByPlanId')
          and type in ('P','PC'))
   drop procedure LoadShipmentBillsByPlanId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillsByPlanId')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillsByPlanId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadOutWarehouseBillsByPlanId')
          and type in ('P','PC'))
   drop procedure LoadOutWarehouseBillsByPlanId
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillCarrierTransportPriceByDeliverBillId')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillCarrierTransportPriceByDeliverBillId
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertDeliverBillCarrierTransportPrice')
          and type in ('P','PC'))
   drop procedure InsertDeliverBillCarrierTransportPrice
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadDeliverBillCarrierTransportPricesByConditions')
          and type in ('P','PC'))
   drop procedure LoadDeliverBillCarrierTransportPricesByConditions
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertOpLog')
          and type in ('P','PC'))
   drop procedure InsertOpLog
go

if exists (select 1
          from sysobjects
          where  id = object_id('InsertLoginLog')
          and type in ('P','PC'))
   drop procedure InsertLoginLog
go

if exists (select 1
          from sysobjects
          where  id = object_id('GetId')
          and type in ('P','PC'))
   drop procedure GetId
go

if exists (select 1
          from sysobjects
          where  id = object_id('GetNo')
          and type in ('P','PC'))
   drop procedure GetNo
go

if exists (select 1
          from sysobjects
          where  id = object_id('LoadAccountByName')
          and type in ('P','PC'))
   drop procedure LoadAccountByName
go



/********************************************************************************************
 * 
 *
 * 
 * @AccountId
 *
 * 
 * 
*******************************************************************************************/
create procedure GetId
@AccountId bigint,
@Id bigint output
with encryption
as
declare @AccountName nvarchar(50)
declare @MaxValue bigint
begin
	set nocount on

    /**/
    /*set xact_abort on*/

    while 1=1
    begin
		/**/
		select @Id = CurrentValue, @MaxValue = MaxValue from IdGenerator where AccountId = @AccountId and Working = 1
		if @@rowcount = 0
		begin
			/**/
			select @AccountName = Name, @Id = OnlineStartId from Account where Id = @AccountId 
            if @@rowcount = 0
            begin
                raiserror (150002,18,1)
                return -1
            end
            
            /*10*/
            set @MaxValue = @Id + 999999999
            
            insert into IdGenerator 
                (
                    Id,
                    AccountId,
                    AccountName,
                    Working,
                    CurrentValue,
                    StartValue,
                    MinValue,
                    MaxValue
                ) 
            values 
                (
                    newid(),
                    @AccountId,
                    @AccountName,
                    1,
                    @Id,
                    @Id,
                    @Id,
                    @MaxValue
                )
        end

        /**/
        if @Id + 1 > @MaxValue
        begin
            raiserror (150003,18,1)
            return -2
        end
        
        /*1*/
        update IdGenerator set CurrentValue = @Id + 1 where AccountId = @AccountId and CurrentValue = @Id and Working = 1
        if @@rowcount > 0
        begin
            break
        end
    end
    
    return 0 
end
go



/********************************************************************************************
 * 
 *
 * 
 * @OpStaffId
 * @OpStaffName
 * @OpName
 * @OpParams
 *
 * 
 * @OpRet
 *
*******************************************************************************************/
create procedure InsertOpLog
@OpStaffId bigint,
@OpStaffName nvarchar(50),
@OpName nvarchar(500),
@OpParams nvarchar(max),
@OpRet int output
with encryption
as
declare @Id bigint
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	exec GetId @OpStaffId, @Id output

	/*OpLogs*/
	insert into OpLog (Id,StaffId,StaffName,OpTime,OpName,OpParams) values (@Id,@OpStaffId,@OpStaffName,getdate(),@OpName,@OpParams)
	if @@rowcount=0
	begin
		set @OpRet = -1
		return -1
	end

	set @OpRet = 0
	return 0
end
go


create procedure CancelDeliverPlan 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    update DeliverPlan set 
        PlanState = formatmessage(150243),
        Remark = isnull(Remark,'') + ' ' + convert(nvarchar(10),getdate(),120) + formatmessage(150569)
    where 
        Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150270,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150330)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure CancelDispatchBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from ShipmentBill where DispatchBillId = @Id and PrintState = 1)
    begin
        raiserror (150680,18,1)
        return -1
    end
    
    /**/
    update DispatchBill set BillState = formatmessage(150241) where Id = @Id and BillState = formatmessage(150242)
    if @@rowcount = 0
    begin
        raiserror (150367,18,1)
        return -2
    end
    
    
    /**/
    delete from ShipmentBillGoods where ShipmentBillId in (select Id from ShipmentBill where DispatchBillId = @Id)
    delete from ShipmentBill where DispatchBillId = @Id 
    

    /**/
    delete from DeliverBillGoods where DeliverBillId in (select Id from DeliverBill where DispatchBillId = @Id)
    delete from DeliverBill where DispatchBillId = @Id
    
    
    /**/
    delete from ContractDeliverPlan where ContractId in (select Id from Contract where DispatchBillId = @Id)
    delete from Contract where DispatchBillId = @Id
    
    
    /**/
    select @OpName = formatmessage(150371)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure CheckDispatchBill
@Id bigint, 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @CarryingCapacity int
declare @TotalPackages int 
declare @TotalTunnages numeric(25,9)
declare @TotalPiles numeric(25,9)
declare @TotalTenThousands numeric(25,9)
declare @TotalTransportCharges numeric(25,9)
declare @PlanTotalPackages int 
declare @PlanTotalTunnages numeric(25,9)
declare @PlanTotalPiles numeric(25,9)
declare @PlanTotalTenThousands numeric(25,9)
declare @PlanTotalTransportCharges numeric(25,9)
declare @GoodsTotalPackages int 
declare @GoodsTotalTunnages numeric(25,9)
declare @GoodsTotalPiles numeric(25,9)
declare @GoodsTotalTenThousands numeric(25,9)
declare @ErrText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @CarryingCapacity = isnull(cc.CarryingCapacity,0),
        @TotalPackages = db.TotalPackages, 
        @TotalTunnages = db.TotalTunnages, 
        @TotalPiles = db.TotalPiles, 
        @TotalTenThousands = db.TotalTenThousands, 
        @TotalTransportCharges = db.TotalTransportCharges 
    from 
        DispatchBill db left join 
        CarrierCar cc on db.CarrierId = cc.CarrierId and db.CarNo = cc.CarNo 
    where 
        db.Id = @Id 
        
    if @@rowcount = 0
    begin
        raiserror (150319,18,1)
        return -1
    end
    
    /**/
    select 
        @PlanTotalPackages = isnull(sum(Packages),0), 
        @PlanTotalTunnages = isnull(sum(Tunnages),0.0),
        @PlanTotalPiles = isnull(sum(Piles),0.0),
        @PlanTotalTenThousands = isnull(sum(TenThousands),0.0),
        @PlanTotalTransportCharges = isnull(sum(TransportCharges),0.0) 
    from 
        DispatchBillDeliverPlan 
    where 
        DispatchBillId = @Id 
        
    /**/
    select 
        @GoodsTotalPackages = isnull(sum(Packages),0), 
        @GoodsTotalTunnages = isnull(sum(Tunnages),0.0),
        @GoodsTotalPiles = isnull(sum(Piles),0.0),
        @GoodsTotalTenThousands = isnull(sum(TenThousands),0.0) 
    from 
        DispatchBillGoods 
    where 
        DispatchBillId = @Id 
        
    /**/
    if @TotalPackages <> @PlanTotalPackages or @TotalTunnages <> @PlanTotalTunnages or @TotalPiles <> @PlanTotalPiles or @TotalTenThousands <> @PlanTotalTenThousands or @TotalTransportCharges <> @PlanTotalTransportCharges
    begin
        /*set @ErrText = 'TotalPackages=' + convert(nvarchar,@TotalPackages) + ',' +
                       'PlanTotalPackages=' + convert(nvarchar,@PlanTotalPackages) + ',' +
                       'TotalTunnages=' + convert(nvarchar,@TotalTunnages) + ',' +
                       'PlanTotalTunnages=' + convert(nvarchar,@PlanTotalTunnages) + ',' +
                       'TotalPiles=' + convert(nvarchar,@TotalPiles) + ',' +
                       'PlanTotalPiles=' + convert(nvarchar,@PlanTotalPiles) + ',' +
                       'TotalTenThousands=' + convert(nvarchar,@TotalTenThousands) + ',' +
                       'PlanTotalTenThousands=' + convert(nvarchar,@PlanTotalTenThousands) + ',' +
                       'TotalTransportCharges=' + convert(nvarchar,@TotalTransportCharges) + ',' +
                       'PlanTotalTransportCharges=' + convert(nvarchar,@PlanTotalTransportCharges)*/
                       
        /*raiserror (@ErrText,18,1)*/
        raiserror (150320,18,1)
        return -2
    end
    
    /**/
    if @TotalPackages <> @GoodsTotalPackages or @TotalTunnages <> @GoodsTotalTunnages or @TotalPiles <> @GoodsTotalPiles or @TotalTenThousands <> @GoodsTotalTenThousands 
    begin
        raiserror (150324,18,1)
        return -3
    end
    
    /**/
    if @PlanTotalPackages <> @GoodsTotalPackages or @PlanTotalTunnages <> @GoodsTotalTunnages or @PlanTotalPiles <> @GoodsTotalPiles or @PlanTotalTenThousands <> @GoodsTotalTenThousands 
    begin
        raiserror (150325,18,1)
        return -4
    end
    
    /**/
    if abs(@TotalTunnages) > @CarryingCapacity 
    begin
        raiserror (150366,18,1)
        return -5
    end
    
    /**/
    set @OpName = formatmessage(150328)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -6
    end
    
    return 0
end
go


create procedure CheckForReturnDispatch 
@DeliverBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @DispatchBillId bigint
declare @ContractId bigint
declare @PlanId bigint
declare @DeliveryNo nvarchar(20)
declare @ReturnTime datetime
declare @CustomerTransportChargesSettlementId bigint
declare @Msg nvarchar(max)
declare @ErrText nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    set @Msg = ''

    /**************************************************************************************************************************************/
    /*1.*/
    select @DispatchBillId = DispatchBillId from DeliverBill where Id = @DeliverBillId
    if @@rowcount = 0
    begin
        raiserror (150703,18,1)
        return -1
    end
       
    /**************************************************************************************************************************************/
    /*2.*/
    if exists(select * from Contract where DispatchBillId = @DispatchBillId)
    begin
        select @ContractId = Id from Contract where DispatchBillId = @DispatchBillId
        if @@rowcount = 0
        begin
            raiserror (150692,18,1)
            return -2
        end
    
        /**/
        if exists(select * from ContractReverseDetail where ContractId = @ContractId)
        begin
            set @Msg = @Msg + formatmessage(150704)
        end
    
    end
    
    /**************************************************************************************************************************************/
    /*3.*/
    declare Cursor1 cursor local for 
        select PlanId from DispatchBillDeliverPlan where DispatchBillId = @DispatchBillId 
            
    open Cursor1
    fetch next from Cursor1 into @PlanId
    while @@fetch_status = 0
    begin
        if exists(select * from DeliverBill where PlanId = @PlanId and DispatchBillId = @DispatchBillId)
        begin
            declare Cursor2 cursor local for 
                select Id from DeliverBill where PlanId = @PlanId and DispatchBillId = @DispatchBillId
            
            open Cursor2
            fetch next from Cursor2 into @DeliverBillId
            while @@fetch_status = 0
            begin
                select @DeliveryNo = DeliveryNo, @ReturnTime = ReturnTime, @CustomerTransportChargesSettlementId = CustomerTransportChargesSettlementId from DeliverBill where Id = @DeliverBillId
                if @@rowcount = 0
                begin
                    raiserror (150415,18,1)
                    return -3
                end
                
                /**/
                if @ReturnTime is not null
                begin
                    set @Msg = @Msg + formatmessage(150705, @DeliveryNo)
                end
                
                /**/
                if @CustomerTransportChargesSettlementId is not null and @CustomerTransportChargesSettlementId > 0
                begin
                    set @Msg = @Msg + formatmessage(150706, @DeliveryNo)
                end
                
                /**/
                if exists(select * from CarrierTransportChargesSettlementDetail where DeliverBillId = @DeliverBillId)
                begin
                    set @Msg = @Msg + formatmessage(150707, @DeliveryNo)
                end
            
                fetch next from Cursor2 into @DeliverBillId
            end
        
            close Cursor2
            deallocate Cursor2
        end
        
        fetch next from Cursor1 into @PlanId
    end 
        
    close Cursor1
    deallocate Cursor1
    
    
    /**/
    select @OpName = formatmessage(150711)
    select @OpParams = N'DeliverBillId=' + convert(nvarchar,@DeliverBillId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    print @Msg
    
    return 0
end
go


create procedure CheckStock 
@CustomerId bigint,
@PlanType nvarchar(10),
@GoodsId bigint,
@GoodsNo nvarchar(20),
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Warehouse nvarchar(20),
@Location nvarchar(10),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint,
@ConsignedDeliveryNo nvarchar(20),
@Packages int,
@Piles numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @StockPackages int
declare @StockPiles numeric(25,9)
declare @NotDeliverPackages int
declare @NotDeliverPiles numeric(25,9)
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
    begin
        /**/
        select 
            @StockPackages = sum(Packages),
            @StockPiles = sum(Piles)
        from 
            Stock 
        where 
            GoodsId = @GoodsId and 
            BatchNo = @BatchNo and 
            Packing = @Packing and 
            Warehouse = @Warehouse and 
            Location = @Location and 
            ProductionDate = @ProductionDate and 
            EnterWarehouseBillId = @EnterWarehouseBillId and 
            DeliveryNo = @ConsignedDeliveryNo
                
        if @StockPackages is null and @StockPiles is null
        begin
		    set @ErrorText = formatmessage(150252) + @GoodsNo
            raiserror (@ErrorText,18,1)
            return -1
        end
            
        /**/
        select 
            @NotDeliverPackages = sum(r0.NotDeliverPackages),
            @NotDeliverPiles = sum(r0.NotDeliverPiles)
        from 
            (
                select 
                    dp.Id,
                    case when dp.PlanState = formatmessage(150242) then isnull(r1.PlanPackages,0) - isnull(r4.DeliverPackages,0) else isnull(r2.DispatchPackages,0) + isnull(r3.ShipmentPackages,0) end as NotDeliverPackages,
                    case when dp.PlanState = formatmessage(150242) then isnull(r1.PlanPiles,0) - isnull(r4.DeliverPiles,0) else isnull(r2.DispatchPiles,0) + isnull(r3.ShipmentPiles,0) end as NotDeliverPiles
                from 
                    (
                        select 
                            Id,
                            PlanState 
                        from 
                            DeliverPlan 
                        where 
                            CustomerId = @CustomerId and 
                            ConsignedDeliveryNo = @ConsignedDeliveryNo and 
                            Warehouse = @Warehouse and 
                            (
                                PlanState = formatmessage(150242) or
                                PlanState = formatmessage(150243)
                            )
                    ) as dp left join 
                    (
                        select 
                            PlanId,
                            isnull(sum(Packages), 0) as PlanPackages,
                            isnull(sum(Piles), 0) as PlanPiles
                        from 
                            DeliverPlanGoods 
                        where 
                            PlanId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverPlan 
                                where 
                                    CustomerId = @CustomerId and 
                                    ConsignedDeliveryNo = @ConsignedDeliveryNo and 
                                    Warehouse = @Warehouse and 
                                    (
                                        PlanState = formatmessage(150242) or
                                        PlanState = formatmessage(150243)
                                    )
                            ) and 
                            GoodsId = @GoodsId and 
                            BatchNo = @BatchNo and 
                            Packing = @Packing and 
                            Location = @Location and 
                            ProductionDate = @ProductionDate and 
                            EnterWarehouseBillId = @EnterWarehouseBillId
                        group by 
                            PlanId 
                    ) as r1 on dp.Id = r1.PlanId left join 
                    (
                        select 
                            PlanId,
                            isnull(sum(Packages),0) as DispatchPackages,
                            isnull(sum(Piles), 0) as DispatchPiles
                        from 
                            DispatchBillGoods 
                        where 
                            PlanId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverPlan 
                                where 
                                    CustomerId = @CustomerId and 
                                    ConsignedDeliveryNo = @ConsignedDeliveryNo and 
                                    Warehouse = @Warehouse and 
                                    (
                                        PlanState = formatmessage(150242) or
                                        PlanState = formatmessage(150243)
                                    )
                            ) and 
                            DispatchBillId in 
                            (
                                select 
                                    Id 
                                from 
                                    DispatchBill 
                                where 
                                    BillState = formatmessage(150241)
                            ) and 
                            GoodsId = @GoodsId and 
                            BatchNo = @BatchNo and 
                            Packing = @Packing and 
                            Location = @Location and 
                            ProductionDate = @ProductionDate and 
                            EnterWarehouseBillId = @EnterWarehouseBillId
                        group by 
                            PlanId 
                    ) as r2 on dp.Id = r2.PlanId left join 
                    (
                        select 
                            b.PlanId,
                            isnull(sum(g.Packages),0) as ShipmentPackages,
                            isnull(sum(g.Piles), 0) as ShipmentPiles
                        from 
                            ShipmentBillGoods g join 
                            ShipmentBill b on g.ShipmentBillId = b.Id 
                        where 
                            b.PlanId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverPlan 
                                where 
                                    CustomerId = @CustomerId and 
                                    ConsignedDeliveryNo = @ConsignedDeliveryNo and 
                                    Warehouse = @Warehouse and 
                                    (
                                        PlanState = formatmessage(150242) or
                                        PlanState = formatmessage(150243)
                                    )
                            ) and 
                            b.PrintState <> 1 and 
                            g.GoodsId = @GoodsId and 
                            g.BatchNo = @BatchNo and 
                            g.Packing = @Packing and 
                            g.Location = @Location and 
                            g.ProductionDate = @ProductionDate and 
                            g.EnterWarehouseBillId = @EnterWarehouseBillId
                        group by 
                            b.PlanId 
                    ) as r3 on dp.Id = r3.PlanId left join 
                    (
                        select 
                            b.PlanId,
                            isnull(sum(g.Packages),0) as DeliverPackages,
                            isnull(sum(g.Piles), 0) as DeliverPiles
                        from 
                            ShipmentBillGoods g join 
                            ShipmentBill b on g.ShipmentBillId = b.Id 
                        where 
                            b.PlanId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverPlan 
                                where 
                                    CustomerId = @CustomerId and 
                                    ConsignedDeliveryNo = @ConsignedDeliveryNo and 
                                    Warehouse = @Warehouse and 
                                    (
                                        PlanState = formatmessage(150242) or
                                        PlanState = formatmessage(150243)
                                    )
                            ) and 
                            b.PrintState = 1 and 
                            g.GoodsId = @GoodsId and 
                            g.BatchNo = @BatchNo and 
                            g.Packing = @Packing and 
                            g.Location = @Location and 
                            g.ProductionDate = @ProductionDate and 
                            g.EnterWarehouseBillId = @EnterWarehouseBillId
                        group by 
                            b.PlanId 
                    ) as r4 on dp.Id = r4.PlanId 
            ) as r0
            
        /**/
        if @PlanType = formatmessage(150256) and (@StockPackages - @NotDeliverPackages) < @Packages
        begin
		    set @ErrorText = formatmessage(150253) + @GoodsNo
            raiserror (@ErrorText,18,1)
            return -2
        end
        else
        begin
            if @PlanType = formatmessage(150257) and (@StockPiles - @NotDeliverPiles) < @Piles
            begin
		        set @ErrorText = formatmessage(150253) + @GoodsNo
                raiserror (@ErrorText,18,1)
                return -3
            end
        end
    end
    else
    begin
        /**/
        select 
            @StockPackages = sum(Packages),
            @StockPiles = sum(Piles)
        from 
            Stock 
        where 
            CustomerId = @CustomerId and 
            GoodsId = @GoodsId and 
            BatchNo = @BatchNo and 
            Packing = @Packing and 
            Warehouse = @Warehouse and 
            Location = @Location and 
            ProductionDate = @ProductionDate and 
            EnterWarehouseBillId = @EnterWarehouseBillId and
            DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)
                
        if @StockPackages is null and @StockPiles is null
        begin
		    set @ErrorText = formatmessage(150254) + @GoodsNo
            raiserror (@ErrorText,18,1)
            return -4
        end
            
        /**/
        select 
            @NotDeliverPackages = sum(r0.NotDeliverPackages),
            @NotDeliverPiles = sum(r0.NotDeliverPiles) 
        from 
            (
                select 
                    dp.Id,
                    case when dp.PlanState = formatmessage(150242) then isnull(r1.PlanPackages,0) - isnull(r4.DeliverPackages,0) else isnull(r2.DispatchPackages,0) + isnull(r3.ShipmentPackages,0) end as NotDeliverPackages,
                    case when dp.PlanState = formatmessage(150242) then isnull(r1.PlanPiles,0) - isnull(r4.DeliverPiles,0) else isnull(r2.DispatchPiles,0) + isnull(r3.ShipmentPiles,0) end as NotDeliverPiles
                from 
                    (
                        select 
                            Id,
                            PlanState 
                        from 
                            DeliverPlan 
                        where 
                            CustomerId = @CustomerId and 
                            Warehouse = @Warehouse and 
                            (
                                ConsignedDeliveryNo is null or
                                ConsignedDeliveryNo = ''
                            ) and 
                            (
                                PlanState = formatmessage(150242) or
                                PlanState = formatmessage(150243)
                            )
                    ) as dp left join 
                    (
                        select 
                            PlanId,
                            isnull(sum(Packages), 0) as PlanPackages,
                            isnull(sum(Piles), 0) as PlanPiles
                        from 
                            DeliverPlanGoods 
                        where 
                            PlanId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverPlan 
                                where 
                                    CustomerId = @CustomerId and 
                                    Warehouse = @Warehouse and 
                                    (
                                        ConsignedDeliveryNo is null or
                                        ConsignedDeliveryNo = ''
                                    ) and 
                                    (
                                        PlanState = formatmessage(150242) or
                                        PlanState = formatmessage(150243)
                                    )
                            ) and 
                            GoodsId = @GoodsId and 
                            BatchNo = @BatchNo and 
                            Packing = @Packing and 
                            Location = @Location and 
                            ProductionDate = @ProductionDate and 
                            EnterWarehouseBillId = @EnterWarehouseBillId 
                        group by 
                            PlanId 
                    ) as r1 on dp.Id = r1.PlanId left join 
                    (
                        select 
                            PlanId,
                            isnull(sum(Packages),0) as DispatchPackages,
                            isnull(sum(Piles), 0) as DispatchPiles
                        from 
                            DispatchBillGoods 
                        where 
                            PlanId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverPlan 
                                where 
                                    CustomerId = @CustomerId and 
                                    Warehouse = @Warehouse and 
                                    (
                                        ConsignedDeliveryNo is null or
                                        ConsignedDeliveryNo = ''
                                    ) and 
                                    (
                                        PlanState = formatmessage(150242) or
                                        PlanState = formatmessage(150243)
                                    )
                            ) and 
                            DispatchBillId in 
                            (
                                select 
                                    Id 
                                from 
                                    DispatchBill 
                                where 
                                    BillState = formatmessage(150241)
                            ) and 
                            GoodsId = @GoodsId and 
                            BatchNo = @BatchNo and 
                            Packing = @Packing and 
                            Location = @Location and 
                            ProductionDate = @ProductionDate and 
                            EnterWarehouseBillId = @EnterWarehouseBillId
                        group by 
                            PlanId 
                    ) as r2 on dp.Id = r2.PlanId left join 
                    (
                        select 
                            b.PlanId,
                            isnull(sum(g.Packages),0) as ShipmentPackages,
                            isnull(sum(g.Piles), 0) as ShipmentPiles
                        from 
                            ShipmentBillGoods g join 
                            ShipmentBill b on g.ShipmentBillId = b.Id 
                        where 
                            b.PlanId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverPlan 
                                where 
                                    CustomerId = @CustomerId and 
                                    Warehouse = @Warehouse and 
                                    (
                                        ConsignedDeliveryNo is null or
                                        ConsignedDeliveryNo = ''
                                    ) and 
                                    (
                                        PlanState = formatmessage(150242) or
                                        PlanState = formatmessage(150243)
                                    )
                            ) and 
                            b.PrintState <> 1 and 
                            g.GoodsId = @GoodsId and 
                            g.BatchNo = @BatchNo and 
                            g.Packing = @Packing and 
                            g.Location = @Location and 
                            g.ProductionDate = @ProductionDate and 
                            g.EnterWarehouseBillId = @EnterWarehouseBillId
                        group by 
                            b.PlanId 
                    ) as r3 on dp.Id = r3.PlanId left join 
                    (
                        select 
                            b.PlanId,
                            isnull(sum(g.Packages),0) as DeliverPackages,
                            isnull(sum(g.Piles), 0) as DeliverPiles
                        from 
                            ShipmentBillGoods g join 
                            ShipmentBill b on g.ShipmentBillId = b.Id 
                        where 
                            b.PlanId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverPlan 
                                where 
                                    CustomerId = @CustomerId and 
                                    Warehouse = @Warehouse and 
                                    (
                                        ConsignedDeliveryNo is null or
                                        ConsignedDeliveryNo = ''
                                    ) and 
                                    (
                                        PlanState = formatmessage(150242) or
                                        PlanState = formatmessage(150243)
                                    )
                            ) and 
                            b.PrintState = 1 and 
                            g.GoodsId = @GoodsId and 
                            g.BatchNo = @BatchNo and 
                            g.Packing = @Packing and 
                            g.Location = @Location and 
                            g.ProductionDate = @ProductionDate and 
                            g.EnterWarehouseBillId = @EnterWarehouseBillId
                        group by 
                            b.PlanId 
                    ) as r4 on dp.Id = r4.PlanId 
            ) as r0
                
        /**/
        if @PlanType = formatmessage(150256) and (@StockPackages - @NotDeliverPackages) < @Packages
        begin
		    set @ErrorText = formatmessage(150255) + @GoodsNo
            raiserror (@ErrorText,18,1)
            return -5
        end
        else
        begin
            if @PlanType = formatmessage(150257) and (@StockPiles - @NotDeliverPiles) < @Piles
            begin
		        set @ErrorText = formatmessage(150255) + @GoodsNo
                raiserror (@ErrorText,18,1)
                return -6
            end
        end
    end

   
    /**/
    set @OpName = formatmessage(150650)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'PlanType=' + @PlanType + N',' + 
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' + 
                    N'GoodsNo=' + @GoodsNo + N',' + 
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'Warehouse=' + @Warehouse + N',' +
                    N'Location=' + @Location + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId) + N',' +
                    N'ConsignedDeliveryNo=' + @ConsignedDeliveryNo + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -7
    end
    
    return 0
end
go


create function CompareDate (@Date1 datetime,@Date2 datetime)
returns int 
with encryption 
begin
    declare @strDate1 nvarchar(10)
    declare @strDate2 nvarchar(10)
    declare @ret int 
    
    set @strDate1 = convert(nvarchar(10),@Date1,120)
    set @strDate2 = convert(nvarchar(10),@Date2,120)
    
    if @strDate1 < @strDate2 
    begin
        set @ret = -1
    end
    else
    begin
        if @strDate1 > @strDate2
            set @ret = 1
        else
            set @ret = 0
    end
    return @ret
end
go


create procedure GetNo
@TableName nvarchar(20),
@No nvarchar(20) output
with encryption
as
declare @CurrentDate date
declare @CurrentValue int 
begin
	set nocount on

    /**/
    /*set xact_abort on*/

    while 1=1
    begin
		/**/
		select @CurrentDate = CurrentDate, @CurrentValue = CurrentValue from NoGenerator where TableName = @TableName 
		if @@rowcount = 0 
		begin
            begin try
                insert into NoGenerator 
                    (
                        Id,
                        TableName,
                        Prefix,
                        CurrentDate,
                        CurrentValue 
                    ) 
                values 
                    (
                        newid(),
                        @TableName,
                        N'',
                        getdate(),
                        1 
                    )
            end try
            begin catch
            
            end catch
            
            continue
        end
        else
        begin
            if convert(nvarchar(10),@CurrentDate,120) <> convert(nvarchar(10),getdate(),120)
            begin
                begin try
                    update NoGenerator set 
                        CurrentDate = getdate(), 
                        CurrentValue =1 
                    where 
                        TableName = @TableName and 
                        CurrentDate = @CurrentDate and 
                        CurrentValue = @CurrentValue 
                end try 
                begin catch
            
                end catch
                
                continue
            end
        end

        /*1*/
        update NoGenerator set CurrentValue = @CurrentValue + 1 where TableName = @TableName and CurrentValue = @CurrentValue and CurrentDate = @CurrentDate 

        if @@rowcount > 0
        begin
            break
        end
    end
    
    set @No = convert(nvarchar(8),@CurrentDate,112) + right('000' + convert(nvarchar, @CurrentValue), 3)
    
    return 0 
end
go


create procedure CopyDeliverPlan 
@Id bigint,
@NewPlanId bigint output,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @PlanNo nvarchar(20)
declare @NewId bigint
declare @GoodsId bigint
declare @GoodsName nvarchar(50)
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @GoodsNo nvarchar(20)
declare @Brand nvarchar(20)
declare @SpecModel nvarchar(50)
declare @GWeight nvarchar(20)
declare @Grade nvarchar(10)
declare @PieceWeight numeric(25,9)
declare @Packing nvarchar(10)
declare @BatchNo nvarchar(20)
declare @Location nvarchar(10)
declare @Packages int
declare @Tunnages numeric(25,9)
declare @Piles numeric(25,9)
declare @TenThousands numeric(25,9)
declare @ProductionDate nvarchar(10)
declare @EnterWarehouseBillId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    exec GetId @OpStaffId, @NewPlanId output 
    
    exec GetNo N'DeliverPlan', @PlanNo output
    set @PlanNo = N'J' + @PlanNo 
    
    insert into DeliverPlan 
    (
        Id, 
        PlanNo,
        PlanType,
        CustomerId,
        CustomerName,
        ShipmentNo,
        DeliveryNo,
        DeliverType,
        ReceiverName,
        ReceiverCountry,
        ReceiverProvince,
        ReceiverCity,
        ReceiverAddress,
        ReceiverContact,
        ReceiverContactTel,
        OrderNo,
        ReceiveType,
        CarNo,
        TrailerNo,
        DriverName,
        DriverLicenseNo,
        DriverMobileTel,
        DriverHomeTel,
        CarrierId,
        CarrierName,
        Warehouse,
        ArrivalTime,
        PayerId,
        PayerName,
        IsConsigning,
        ConsignedDeliveryNo,
        IsInstalment,
        StartCountry,
        StartProvince,
        StartCity,
        Remark,
        CreatorId,
        CreatorName,
        CreateOrganId,
        CreateOrganName,
        CreateTime,
        OwnOrganId,
        OwnOrganName,
        PlanState
    ) 
    select 
        @NewPlanId, 
        @PlanNo,
        PlanType,
        CustomerId,
        CustomerName,
        ShipmentNo,
        DeliveryNo,
        DeliverType,
        ReceiverName,
        ReceiverCountry,
        ReceiverProvince,
        ReceiverCity,
        ReceiverAddress,
        ReceiverContact,
        ReceiverContactTel,
        OrderNo,
        ReceiveType,
        CarNo,
        TrailerNo,
        DriverName,
        DriverLicenseNo,
        DriverMobileTel,
        DriverHomeTel,
        CarrierId,
        CarrierName,
        Warehouse,
        ArrivalTime,
        PayerId,
        PayerName,
        IsConsigning,
        ConsignedDeliveryNo,
        IsInstalment,
        StartCountry,
        StartProvince,
        StartCity,
        Remark,
        CreatorId,
        CreatorName,
        CreateOrganId,
        CreateOrganName,
        CreateTime,
        OwnOrganId,
        OwnOrganName,
        PlanState 
    from 
        DeliverPlan 
    where 
        Id = @Id 
            
    if @@rowcount=0
    begin
        raiserror (150547,18,1)
        return -1
    end
    
    /**/
    declare Cursor1 cursor local for 
        select 
            GoodsId, 
            GoodsName, 
            TypeId, 
            TypeName, 
            TypeFullPath, 
            TypeFullName, 
            GoodsNo, 
            Brand, 
            SpecModel, 
            GWeight, 
            Grade, 
            PieceWeight, 
            Packing, 
            BatchNo, 
            Location,
            Packages, 
            Tunnages, 
            Piles, 
            TenThousands,
            ProductionDate,
            EnterWarehouseBillId
        from 
            DeliverPlanGoods 
        where 
            PlanId = @Id 
            
    open Cursor1
    fetch next from Cursor1 into 
        @GoodsId, 
        @GoodsName, 
        @TypeId, 
        @TypeName, 
        @TypeFullPath, 
        @TypeFullName, 
        @GoodsNo, 
        @Brand, 
        @SpecModel, 
        @GWeight, 
        @Grade, 
        @PieceWeight, 
        @Packing, 
        @BatchNo, 
        @Location,
        @Packages, 
        @Tunnages, 
        @Piles, 
        @TenThousands,
        @ProductionDate,
        @EnterWarehouseBillId
    
    while @@fetch_status = 0
    begin
        exec GetId @OpStaffId, @NewId output 
    
        insert into DeliverPlanGoods 
            (
                Id,
                PlanId,
                GoodsId,
                GoodsName,
                TypeId,
                TypeName,
                TypeFullPath,
                TypeFullName,
                GoodsNo,
                Brand,
                SpecModel,
                GWeight,
                Grade,
                PieceWeight,
                Packing,
                BatchNo,
                Location,
                Packages,
                Tunnages,
                Piles,
                TenThousands,
                ProductionDate,
                EnterWarehouseBillId
            )
        values
            (
                @NewId,
                @NewPlanId,
                @GoodsId,
                @GoodsName,
                @TypeId,
                @TypeName,
                @TypeFullPath,
                @TypeFullName,
                @GoodsNo,
                @Brand,
                @SpecModel,
                @GWeight,
                @Grade,
                @PieceWeight,
                @Packing,
                @BatchNo,
                @Location,
                @Packages,
                @Tunnages,
                @Piles,
                @TenThousands,
                @ProductionDate,
                @EnterWarehouseBillId
            )
    
        if @@rowcount = 0
        begin
            raiserror (150548,18,1)
            return -2
        end
        
        fetch next from Cursor1 into 
            @GoodsId, 
            @GoodsName, 
            @TypeId, 
            @TypeName, 
            @TypeFullPath, 
            @TypeFullName, 
            @GoodsNo, 
            @Brand, 
            @SpecModel, 
            @GWeight, 
            @Grade, 
            @PieceWeight, 
            @Packing, 
            @BatchNo, 
            @Location,
            @Packages, 
            @Tunnages, 
            @Piles, 
            @TenThousands,
            @ProductionDate,
            @EnterWarehouseBillId
    end 
        
    close Cursor1
    deallocate Cursor1 
    
    
    /**/
    select @OpName = formatmessage(150549)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure GetTotalStock
@CustomerId bigint,
@Warehouse nvarchar(20),
@BalanceTunnages numeric(25,9) output,
@BalancePiles numeric(25,9) output,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption
as
declare @StockTunnages numeric(25,9)
declare @StockPiles numeric(25,9)
declare @NotDeliverTunnages numeric(25,9) 
declare @NotDeliverPiles numeric(25,9) 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
	set nocount on

    /**/
    /*set xact_abort on*/

    /**/
    select 
        @StockTunnages = isnull(sum(Tunnages), 0),
        @StockPiles = isnull(sum(Piles), 0)
    from 
        Stock 
    where 
        CustomerId = @CustomerId and 
        DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)
           
    /**/
    select 
        @NotDeliverTunnages = sum(r0.NotDeliverTunnages),
        @NotDeliverPiles = sum(r0.NotDeliverPiles)
    from 
        (
            select 
                dp.Id,
                case when dp.PlanState = formatmessage(150242) then isnull(r1.PlanTunnages,0) - isnull(r4.DeliverTunnages,0) else isnull(r2.DispatchTunnages,0) + isnull(r3.ShipmentTunnages,0) end as NotDeliverTunnages,
                case when dp.PlanState = formatmessage(150242) then isnull(r1.PlanPiles,0) - isnull(r4.DeliverPiles,0) else isnull(r2.DispatchPiles,0) + isnull(r3.ShipmentPiles,0) end as NotDeliverPiles
            from 
                (
                    select 
                        Id,
                        PlanState 
                    from 
                        DeliverPlan 
                    where 
                        CustomerId = @CustomerId and 
                        (
                            ConsignedDeliveryNo is null or
                            ConsignedDeliveryNo = ''
                        ) and 
                        Warehouse = @Warehouse and 
                        (
                            PlanState = formatmessage(150242) or
                            PlanState = formatmessage(150243)
                        )
                ) as dp left join 
                (
                    select 
                        PlanId,
                        isnull(sum(Tunnages), 0) as PlanTunnages,
                        isnull(sum(Piles), 0) as PlanPiles
                    from 
                        DeliverPlanGoods 
                    where 
                        PlanId in 
                        (
                            select 
                                Id 
                            from 
                                DeliverPlan 
                            where 
                                CustomerId = @CustomerId and 
                                (
                                    ConsignedDeliveryNo is null or
                                    ConsignedDeliveryNo = ''
                                ) and 
                                Warehouse = @Warehouse and 
                                (
                                    PlanState = formatmessage(150242) or
                                    PlanState = formatmessage(150243)
                                )
                        ) 
                    group by 
                        PlanId 
                ) as r1 on dp.Id = r1.PlanId left join 
                (
                    select 
                        PlanId,
                        isnull(sum(Tunnages),0) as DispatchTunnages,
                        isnull(sum(Piles), 0) as DispatchPiles
                    from 
                        DispatchBillGoods 
                    where 
                        PlanId in 
                        (
                            select 
                                Id 
                            from 
                                DeliverPlan 
                            where 
                                CustomerId = @CustomerId and 
                                (
                                    ConsignedDeliveryNo is null or
                                    ConsignedDeliveryNo = ''
                                ) and 
                                Warehouse = @Warehouse and 
                                (
                                    PlanState = formatmessage(150242) or
                                    PlanState = formatmessage(150243)
                                )
                        ) and 
                        DispatchBillId in 
                        (
                            select 
                                Id 
                            from 
                                DispatchBill 
                            where 
                                BillState = formatmessage(150241)
                        ) 
                    group by 
                        PlanId 
                ) as r2 on dp.Id = r2.PlanId left join 
                (
                    select 
                        b.PlanId,
                        isnull(sum(g.Tunnages),0) as ShipmentTunnages,
                        isnull(sum(g.Piles), 0) as ShipmentPiles
                    from 
                        ShipmentBillGoods g join 
                        ShipmentBill b on g.ShipmentBillId = b.Id 
                    where 
                        b.PlanId in 
                        (
                            select 
                                Id 
                            from 
                                DeliverPlan 
                            where 
                                CustomerId = @CustomerId and 
                                (
                                    ConsignedDeliveryNo is null or
                                    ConsignedDeliveryNo = ''
                                ) and 
                                Warehouse = @Warehouse and 
                                (
                                    PlanState = formatmessage(150242) or
                                    PlanState = formatmessage(150243)
                                )
                        ) and 
                        b.PrintState <> 1 
                    group by 
                        b.PlanId 
                ) as r3 on dp.Id = r3.PlanId left join 
                (
                    select 
                        b.PlanId,
                        isnull(sum(g.Tunnages),0) as DeliverTunnages,
                        isnull(sum(g.Piles), 0) as DeliverPiles
                    from 
                        ShipmentBillGoods g join 
                        ShipmentBill b on g.ShipmentBillId = b.Id 
                    where 
                        b.PlanId in 
                        (
                            select 
                                Id 
                            from 
                                DeliverPlan 
                            where 
                                CustomerId = @CustomerId and 
                                (
                                    ConsignedDeliveryNo is null or
                                    ConsignedDeliveryNo = ''
                                ) and 
                                Warehouse = @Warehouse and 
                                (
                                    PlanState = formatmessage(150242) or
                                    PlanState = formatmessage(150243)
                                )
                        ) and 
                        b.PrintState = 1 
                    group by 
                        b.PlanId 
                ) as r4 on dp.Id = r4.PlanId 
        ) as r0
    
    /**/
    set @BalanceTunnages = @StockTunnages - @NotDeliverTunnages
    set @BalancePiles = @StockPiles - @NotDeliverPiles

    
    /**/
    select @OpName = formatmessage(150651)
    select @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'Warehouse=' + @Warehouse
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0 
end
go


create procedure CustomerAgreeDeliverPlan 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @CustomerId bigint
declare @PlanType nvarchar(10)
declare @Warehouse nvarchar(20)
declare @ConsignedDeliveryNo nvarchar(20)
declare @GoodsId bigint
declare @GoodsNo nvarchar(20)
declare @BatchNo nvarchar(20)
declare @Packing nvarchar(10)
declare @Location nvarchar(10)
declare @Packages int 
declare @ProductionDate nvarchar(10)
declare @EnterWarehouseBillId bigint
declare @Tunnages numeric(25,9) 
declare @StockTunnages numeric(25,9)
declare @StockPiles numeric(25,9)
declare @ErrText nvarchar(max)
declare @WarningStock int
declare @StopStock int
declare @StepName nvarchar(50)
declare @StepNum int 
declare @DisposerId bigint
declare @DisposerName nvarchar(50)
declare @CurrentDisposeFlowStepNum int 
declare @MaxApproveTime datetime
declare @LastIsAgreed bit 
declare @LastStepNum int 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @CustomerId = CustomerId, 
        @PlanType = PlanType, 
        @Warehouse = Warehouse, 
        @ConsignedDeliveryNo = ConsignedDeliveryNo 
    from 
        DeliverPlan 
    where 
        Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150251,18,1)
        return -1
    end
    
    /**/
    if @PlanType = formatmessage(150256)
    begin
        /*1.*/
        declare CheckStock_Cursor cursor local for 
            select 
                GoodsId, 
                GoodsNo, 
                BatchNo, 
                Packing, 
                Location, 
                Packages, 
                Tunnages, 
                ProductionDate, 
                EnterWarehouseBillId 
            from 
                DeliverPlanGoods 
            where 
                PlanId = @Id 
            
        open CheckStock_Cursor
        
        fetch next from CheckStock_Cursor into 
            @GoodsId, 
            @GoodsNo, 
            @BatchNo, 
            @Packing, 
            @Location, 
            @Packages, 
            @Tunnages, 
            @ProductionDate, 
            @EnterWarehouseBillId
            
        while @@fetch_status = 0
        begin
            begin try
                exec CheckStock 
                @CustomerId, 
                @PlanType,
                @GoodsId, 
                @GoodsNo, 
                @BatchNo, 
                @Packing, 
                @Warehouse, 
                @Location, 
                @ProductionDate, 
                @EnterWarehouseBillId, 
                @ConsignedDeliveryNo,
                @Packages,
                0,
                @OpStaffId, 
                @OpStaffName 
            end try
            begin catch
                select @ErrText = error_message()
                raiserror (@ErrText,18,1)
                return -2
            end catch
            
            fetch next from CheckStock_Cursor into 
                @GoodsId, 
                @GoodsNo, 
                @BatchNo, 
                @Packing, 
                @Location, 
                @Packages, 
                @Tunnages, 
                @ProductionDate, 
                @EnterWarehouseBillId
        end
        close CheckStock_Cursor
        deallocate CheckStock_Cursor
        
        /*2.*/
        select @WarningStock = WarningStock, @StopStock = StopStock from Customer where Id = @CustomerId 
        if @@rowcount = 0
        begin
            set @WarningStock = 0
            set @StopStock = 0
        end
            
        exec GetTotalStock @CustomerId, @Warehouse, @StockTunnages output, @StockPiles output, @OpStaffId, @OpStaffName
                
        select @Tunnages = isnull(sum(Tunnages), 0) from DeliverPlanGoods where PlanId = @Id 
                
        /**/
        if (@StockTunnages - @Tunnages) < @StopStock 
        begin
            /**/
            set @CurrentDisposeFlowStepNum = 0 
            select @MaxApproveTime = isnull(max(ApproveTime),getdate()) from DeliverPlanApproveComment where PlanId = @Id and StepNum > 0
            select @LastIsAgreed = IsAgreed, @LastStepNum = StepNum from DeliverPlanApproveComment where ApproveTime = @MaxApproveTime and PlanId = @Id 
            if @@rowcount > 0
            begin
                if @LastIsAgreed = 0 set @CurrentDisposeFlowStepNum = @LastStepNum - 1 
            end
        
            /**/
            select top (1) @StepName = StepName, @StepNum = StepNum, @DisposerId = DisposerId, @DisposerName = DisposerName from ApproveFlowStep where FlowType = formatmessage(150284) and StepNum > @CurrentDisposeFlowStepNum order by StepNum
            if @@rowcount = 0
            begin
                /**/
                update DeliverPlan set PlanState = formatmessage(150242), DisposeFlowStepNum = null, DisposeFlowStepName = null, DisposerId = null, DisposerName = null where Id = @Id
                if @@rowcount = 0
                begin
                    raiserror (150291,18,1)
                    return -3
                end
            end
            else
            begin
                update DeliverPlan set PlanState = formatmessage(150283), DisposeFlowStepNum = @StepNum, DisposeFlowStepName = @StepName, DisposerId = @DisposerId, DisposerName = @DisposerName where Id = @Id
                if @@rowcount = 0
                begin
                    raiserror (150290,18,1)
                    return -4
                end
                
                /**/
                select @ErrText = formatmessage(150519, @DisposerName)
                raiserror (@ErrText,0,1)
            end
        end
        else 
        begin
            /**/
            update DeliverPlan set PlanState = formatmessage(150242), DisposeFlowStepNum = null, DisposeFlowStepName = null, DisposerId = null, DisposerName = null where Id = @Id
            if @@rowcount = 0
            begin
                raiserror (150291,18,1)
                return -5
            end
              
            /**/
            if (@StockTunnages - @Tunnages) < @WarningStock 
            begin
                raiserror (150289,0,1)
            end
        end
    end
    /**/
    else 
    begin
        update DeliverPlan set PlanState = formatmessage(150242), DisposeFlowStepNum = null, DisposeFlowStepName = null, DisposerId = null, DisposerName = null where Id = @Id
        if @@rowcount = 0
        begin
            raiserror (150291,18,1)
            return -6
        end
    end
    
    /**/
    select @OpName = formatmessage(150273)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -7
    end
    
    return 0
end
go


create procedure CustomerDisagreeDeliverPlan 
@Id bigint,
@ApproveComment nvarchar(200),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @ApproveId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    exec GetId @OpStaffId, @ApproveId output 
        
    insert into DeliverPlanApproveComment 
        (Id, PlanId, ApproverId, ApproverName, IsAgreed, ApproveComment, ApproveTime, StepNum)
    values 
        (@ApproveId, @Id, @OpStaffId, @OpStaffName, 0, @ApproveComment, getdate(), 0)
        
    if @@rowcount = 0
    begin
        raiserror (150288,18,1)
        return -1
    end
    
    /**/
    update DeliverPlan set PlanState = formatmessage(150241) where Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150270,18,1)
        return -2
    end
    
    /**/
    select @OpName = formatmessage(150274)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure DeleteAccount 
@Id bigint, 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max) 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    set @Sql = 'delete from AccountPermission where AccountId = ' + convert(nvarchar,@Id) 
    exec (@Sql) 
    

    /*ID*/
    set @Sql = 'delete from IdGenerator where AccountId = ' + convert(nvarchar,@Id) 
    exec (@Sql) 
    
    
    /**/
    set @Sql = 'delete from Account where Id = ' + convert(nvarchar,@Id) 
    exec (@Sql) 
    
    
    /**/
    set @OpName = formatmessage(150171)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @AccountId
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure DeleteAccountPermissions
@AccountId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	if exists(select 1 from AccountPermission where AccountId = @AccountId)
	begin
        /**/
		delete from AccountPermission where AccountId = @AccountId
		if @@rowcount=0
		begin
			raiserror (150014,18,1)
            return -1
        end

        /**/
        select @OpName = formatmessage(150015)
        select @OpParams = N'AccountId=' + convert(nvarchar,@AccountId)
        
        exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
        if @OpRet = 1
        begin
            raiserror (150001,18,1)
            return -2
        end
    end
    
    return 0
end
go


create procedure DeleteApproveFlowStep 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @StepNum int
declare @FlowType nvarchar(50)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @StepNum = StepNum, @FlowType = FlowType from ApproveFlowStep where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150116,18,1)
        return -1
    end
    
    /**/
    delete from ApproveFlowStep where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150117,18,1)
        return -2
    end
    
    /**/
    update ApproveFlowStep set StepNum = StepNum - 1 where StepNum > @StepNum and FlowType = @FlowType
    if @@error <> 0
    begin
        raiserror (150118,18,1)
        return -3
    end
    
    /**/
    set @OpName = formatmessage(150119)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure DeleteApproveFlowStepConditions 
@StepId bigint, 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    delete from ApproveFlowStepCondition where StepId = @StepId 
    
    if @@error <> 0
    begin
        raiserror (150120,18,1)
        return -1
    end
    
    /**/
    set @OpName = formatmessage(150121)
    set @OpParams = N'StepId=' + convert(nvarchar,@StepId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteCarrier
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from Carrier where Id = @Id
    
    if @@rowcount=0
    begin
        raiserror (150212,18,1)
        return -1
    end
    
    /**/
    set @OpName = formatmessage(150213)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteCarrierCar
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from CarrierCar where Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150643,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150644)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteCarrierCars
@CarrierId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from CarrierCar where CarrierId = @CarrierId
    
    /**/
    set @OpName = formatmessage(150211)
    set @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteCarrierDrivers
@CarrierId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from CarrierDriver where CarrierId = @CarrierId
    
    /**/
    set @OpName = formatmessage(150218)
    set @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteCarrierSettlementExpressions
@CarrierId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from CarrierSettlementExpression where CarrierId = @CarrierId
    
    /**/
    set @OpName = formatmessage(150337)
    set @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteCarrierTransportChargesSettlement 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from CarrierTransportChargesSettlement where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150561,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150581)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteCarrierTransportChargesSettlementDetails 
@CarrierTransportChargesSettlementId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from CarrierTransportChargesSettlementDetail where CarrierTransportChargesSettlementId = @CarrierTransportChargesSettlementId 
    if @@rowcount = 0
    begin
        raiserror (150562,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150582)
    select @OpParams = N'CarrierTransportChargesSettlementId=' + convert(nvarchar,@CarrierTransportChargesSettlementId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteCarrierTransportPrices
@CarrierId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from CarrierTransportPrice where CarrierId = @CarrierId
    
    /**/
    set @OpName = formatmessage(150210)
    set @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure DeleteCity
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	set @Sql = 'delete from City where Id = ' + convert(nvarchar,@Id)
    exec (@Sql) 
    
    /**/
    set @OpName = formatmessage(150051)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteContract 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from Contract where Id = @Id and IsPrestowage = 1
    
    if @@rowcount = 0
    begin
        raiserror (150122,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150123)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteContractDeliverPlans 
@ContractId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from ContractDeliverPlan where ContractId = @ContractId 
    
    if @@rowcount = 0
    begin
        raiserror (150124,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150125)
    select @OpParams = N'ContractId=' + convert(nvarchar,@ContractId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteContractFine 
@ContractId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    update Contract set FineAmount = null, FineTime = null where Id = @ContractId
    if @@rowcount = 0
    begin
        raiserror (150572,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150573)
    select @OpParams = N'ContractId=' + convert(nvarchar,@ContractId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteContractReverse 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from ContractReverse where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150553,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150570)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteContractReverseDetails 
@ReverseId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from ContractReverseDetail where ReverseId = @ReverseId 
    if @@rowcount = 0
    begin
        raiserror (150551,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150571)
    select @OpParams = N'ReverseId=' + convert(nvarchar,@ReverseId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure DeleteCountry
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	set @Sql = 'delete from Country where Id = ' + convert(nvarchar,@Id)
    exec (@Sql) 
    
    /**/
    set @OpName = formatmessage(150033)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure DeleteCustomer
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from AccountPermission where AccountId in (select Id from Account where OrganId = @Id)
    
    
    /*ID*/
    delete from IdGenerator where AccountId in (select Id from Account where OrganId = @Id)

   
    /**/
    delete from Account where OrganId = @Id 
    
    /**/
    delete from Customer where Id = @Id
    
    if @@rowcount = 0
    begin
		raiserror (150108,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150109)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteCustomerForceFeePrices
@CustomerId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from CustomerForceFeePrice where CustomerId = @CustomerId
    
    /**/
    set @OpName = formatmessage(150662)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteCustomerStorageAndForceFeeSettlement 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from CustomerStorageAndForceFeeSettlement where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150590,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150591)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteCustomerStorageFeePrices
@CustomerId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from CustomerStorageFeePrice where CustomerId = @CustomerId
    
    /**/
    set @OpName = formatmessage(150663)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteCustomerTransportChargesSettlement 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from CustomerTransportChargesSettlement where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150559,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150577)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteCustomerTransportChargesSettlementDetails 
@CustomerTransportChargesSettlementId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    update DeliverBill set CustomerTransportChargesSettlementId = null where Id in (select DeliverBillId from CustomerTransportChargesSettlementDetail where CustomerTransportChargesSettlementId = @CustomerTransportChargesSettlementId)
    if @@rowcount = 0
    begin
        raiserror (150578,18,1)
        return -1
    end
    
    /**/
    delete from CustomerTransportChargesSettlementDetail where CustomerTransportChargesSettlementId = @CustomerTransportChargesSettlementId 
    if @@rowcount = 0
    begin
        raiserror (150579,18,1)
        return -2
    end
    
    /**/
    select @OpName = formatmessage(150580)
    select @OpParams = N'CustomerTransportChargesSettlementId=' + convert(nvarchar,@CustomerTransportChargesSettlementId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure DeleteCustomerTransportPrices
@CustomerId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from CustomerTransportPrice where CustomerId = @CustomerId
    
    /**/
    set @OpName = formatmessage(150176)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteDeliverBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from DeliverBill where Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150424,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150425)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteDeliverBillAllGoods 
@DeliverBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
   
    /**/
    delete from DeliverBillGoods where DeliverBillId = @DeliverBillId 
    if @@rowcount = 0
    begin
        raiserror (150426,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150427)
    select @OpParams = N'DeliverBillId=' + convert(nvarchar,@DeliverBillId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteDeliverBillCarrierTransportPrice 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from CarrierTransportChargesSettlementDetail where DeliverBillId in (select DeliverBillId from DeliverBillCarrierTransportPrice where Id = @Id))
    begin
        raiserror (150700,18,1)
        return -1
    end
    
    /**/
    delete from DeliverBillCarrierTransportPrice where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150701,18,1)
        return -2
    end
    
    /**/
    select @OpName = formatmessage(150702)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure DeleteDeliverBillCustomerTransportPrice 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from CustomerTransportChargesSettlementDetail where DeliverBillId in (select DeliverBillId from DeliverBillCustomerTransportPrice where Id = @Id))
    begin
        raiserror (150574,18,1)
        return -1
    end
    
    /**/
    delete from DeliverBillCustomerTransportPrice where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150575,18,1)
        return -2
    end
    
    /**/
    select @OpName = formatmessage(150576)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure RestoreStock 
@OutWarehouseBillId bigint,
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @StockOutWarehouseDetailId bigint
declare @StockId bigint
declare @OutWarehouseBillPackages int
declare @OutWarehouseBillTunnages numeric(25,9)
declare @OutWarehouseBillPiles numeric(25,9)
declare @OutWarehouseBillTenThousands numeric(25,9)
declare @CreateTime1 datetime
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    declare Cursor1 cursor local for 
        select 
            Id, 
            StockId, 
            Packages, 
            Tunnages,
            Piles,
            TenThousands
        from 
            StockOutWarehouseDetail 
        where 
            OutWarehouseBillId = @OutWarehouseBillId 
            
    open Cursor1
    fetch next from Cursor1 into 
        @StockOutWarehouseDetailId, 
        @StockId, 
        @OutWarehouseBillPackages, 
        @OutWarehouseBillTunnages,
        @OutWarehouseBillPiles,
        @OutWarehouseBillTenThousands
        
    while @@fetch_status = 0
    begin
        /**/
        update Stock set 
            Packages = Packages + @OutWarehouseBillPackages, 
            Tunnages = Tunnages + @OutWarehouseBillTunnages,
            Piles = Piles + @OutWarehouseBillPiles,
            TenThousands = TenThousands + @OutWarehouseBillTenThousands
        where 
            Id = @StockId 
        if @@rowcount = 0
        begin
            raiserror (150421,18,1)
            return -1
        end
        
        /**/
        delete from StockOutWarehouseDetail where Id = @StockOutWarehouseDetailId 
        if @@rowcount = 0
        begin
            raiserror (150422,18,1)
            return -2
        end
        
        /**/
        set @CreateTime1 = @CreateTime
        while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
        begin
            update StockDaily set 
                Packages = Packages + @OutWarehouseBillPackages, 
                Tunnages = Tunnages + @OutWarehouseBillTunnages,
                Piles = Piles + @OutWarehouseBillPiles,
                TenThousands = TenThousands + @OutWarehouseBillTenThousands
            where 
                StockId = @StockId and 
                convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
            if @@rowcount = 0
            begin
                raiserror (150649,18,1)
                return -3
            end
            
            set @CreateTime1 = dateadd(day,1,@CreateTime1)
        end
        
        fetch next from Cursor1 into 
            @StockOutWarehouseDetailId, 
            @StockId, 
            @OutWarehouseBillPackages, 
            @OutWarehouseBillTunnages,
            @OutWarehouseBillPiles,
            @OutWarehouseBillTenThousands
    end
        
    close Cursor1
    deallocate Cursor1 

   
    /**/
    set @OpName = formatmessage(150654)
    set @OpParams = N'OutWarehouseBillId=' + convert(nvarchar,@OutWarehouseBillId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure DeleteDeliverPlan 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @ErrText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if not exists(select * from DeliverPlan where Id = @Id)
    begin
        raiserror (150603,18,1)
        return -1
    end
    
    if exists(select * from DeliverPlan where Id = @Id and IsDelete = 1)
    begin
        raiserror (150604,18,1)
        return -2
    end
    
    /**/
    if exists(select * from ContractDeliverPlan where PlanId = @Id)
    begin
        declare @ContractId bigint
        declare @ContractPackages int
        declare @ContractTunnages numeric(25,9)
        declare @ContractPiles numeric(25,9)
        declare @ContractTenThousands numeric(25,9)
        declare @ContractTransportCharges numeric(25,9)
        declare @ContractApprovedTransportCharges numeric(25,9)
        
        declare Cursor1 cursor local for 
            select ContractId from ContractDeliverPlan where PlanId = @Id
            
        open Cursor1
        fetch next from Cursor1 into @ContractId
        while @@fetch_status = 0
        begin
            /**/
            select 
                @ContractPackages = Packages,
                @ContractTunnages = Tunnages,
                @ContractPiles = Piles,
                @ContractTenThousands = TenThousands,
                @ContractTransportCharges = TransportCharges,
                @ContractApprovedTransportCharges = isnull(ApprovedTransportCharges,0.0)
            from 
                ContractDeliverPlan 
            where 
                ContractId = @ContractId and 
                PlanId = @Id 
            if @@rowcount = 0
            begin
                raiserror (150143,18,1)
                return -3
            end
            
            /**/
            if exists(select * from ContractApproveComment where ContractId = @ContractId)
            begin
                update Contract set 
                    TotalPackages = TotalPackages - @ContractPackages,
                    TotalTunnages = TotalTunnages - @ContractTunnages,
                    TotalPiles = TotalPiles - @ContractPiles,
                    TotalTenThousands = TotalTenThousands - @ContractTenThousands,
                    TotalTransportCharges = TotalTransportCharges - @ContractApprovedTransportCharges,
                    ResidualTransportCharges = TotalTransportCharges - @ContractApprovedTransportCharges - PrepayTransportCharges 
                where 
                    Id = @ContractId 
                if @@rowcount = 0
                begin
                    raiserror (150154,18,1)
                    return -4
                end
            end
            else
            begin
                update Contract set 
                    TotalPackages = TotalPackages - @ContractPackages,
                    TotalTunnages = TotalTunnages - @ContractTunnages,
                    TotalPiles = TotalPiles - @ContractPiles,
                    TotalTenThousands = TotalTenThousands - @ContractTenThousands,
                    TotalTransportCharges = TotalTransportCharges - @ContractTransportCharges,
                    ResidualTransportCharges = TotalTransportCharges - @ContractTransportCharges - PrepayTransportCharges 
                where 
                    Id = @ContractId 
                if @@rowcount = 0
                begin
                    raiserror (150154,18,1)
                    return -5
                end
            end
            
            /*0*/
            delete from Contract where Id = @ContractId and TotalPackages = 0 and TotalTunnages = 0 and TotalPiles = 0 and TotalTenThousands = 0 
            if @@error <> 0
            begin
                raiserror (150122,18,1)
                return -6
            end
            
            /**/
            declare @ReverseId bigint
            declare @ReverseAmount numeric(25,9)
            declare @WithholdAmount numeric(25,9)
            declare @FactpaymentAmount numeric(25,9)
                
            declare Cursor2 cursor local for 
                select ReverseId from ContractReverseDetail where ContractId = @ContractId
            
            open Cursor2
            fetch next from Cursor2 into @ReverseId
            while @@fetch_status = 0
            begin
                select 
                    @ReverseAmount = ReverseAmount,
                    @WithholdAmount = WithholdAmount,
                    @FactpaymentAmount = FactpaymentAmount 
                from 
                    ContractReverseDetail 
                where 
                    ReverseId = @ReverseId and 
                    ContractId = @ContractId 
                if @@rowcount = 0
                begin
                    raiserror (150550,18,1)
                    return -7
                end
                    
                update ContractReverse set 
                    ReverseAmount = ReverseAmount - @ReverseAmount,
                    WithholdAmount = WithholdAmount - @WithholdAmount,
                    FactpaymentAmount = FactpaymentAmount - @FactpaymentAmount
                where 
                    Id = @ReverseId
                if @@rowcount = 0
                begin
                    raiserror (150552,18,1)
                    return -8
                end
                    
                delete from ContractReverse where Id = @ReverseId and ReverseAmount = 0
                if @@error <> 0
                begin
                    raiserror (150553,18,1)
                    return -9
                end
                    
                fetch next from Cursor2 into @ReverseId
            end
                
            close Cursor2
            deallocate Cursor2
            
            delete from ContractReverseDetail where ContractId = @ContractId 
            if @@error <> 0
            begin
                raiserror (150551,18,1)
                return -10
            end

            fetch next from Cursor1 into @ContractId
        end 
        
        close Cursor1
        deallocate Cursor1 
        
        /**/
        delete from ContractApproveComment where PlanId = @Id
        
        /**/
        delete from ContractDeliverPlan where PlanId = @Id
        if @@rowcount = 0
        begin
            raiserror (150124,18,1)
            return -11
        end
    end
    
    /**/
    if exists(select * from OutWarehouseBill where PlanId = @Id)
    begin
        declare @OutWarehouseBillId bigint
        declare @CreateTime datetime
        
        declare Cursor3 cursor local for 
            select Id, CreateTime from OutWarehouseBill where PlanId = @Id
            
        open Cursor3
        fetch next from Cursor3 into @OutWarehouseBillId, @CreateTime
        while @@fetch_status = 0
        begin
            /**/
            delete from OutWarehouseBillGoods where OutWarehouseBillId = @OutWarehouseBillId 
            if @@rowcount = 0
            begin
                raiserror (150554,18,1)
                return -12
            end
            
            /**/
            begin try
                exec RestoreStock @OutWarehouseBillId, @CreateTime, @OpStaffId, @OpStaffName 
            end try
            begin catch
                select @ErrText = error_message()
                raiserror (@ErrText,18,1)
                return -13
            end catch
            
            fetch next from Cursor3 into @OutWarehouseBillId, @CreateTime
        end
        
        close Cursor3
        deallocate Cursor3 
        
        /**/
        delete from OutWarehouseBill where PlanId = @Id 
        if @@rowcount = 0
        begin
            raiserror (150555,18,1)
            return -14
        end
    end
    
    /**/
    if exists(select * from EnterWarehouseBill where PlanId = @Id)
    begin
        declare @EnterWarehouseBillId bigint
        declare @CustomerId bigint
        declare @GoodsId bigint
        declare @BatchNo nvarchar(20)
        declare @Packing nvarchar(10)
        declare @Warehouse nvarchar(20)
        declare @Location nvarchar(10)
        declare @Packages int
        declare @Tunnages numeric(25,9)
        declare @Piles numeric(25,9)
        declare @TenThousands numeric(25,9)
        declare @ProductionDate nvarchar(10)
        declare @StockId bigint
        
        declare Cursor5 cursor local for 
            select Id, CustomerId, Warehouse from EnterWarehouseBill where PlanId = @Id
            
        open Cursor5
        fetch next from Cursor5 into @EnterWarehouseBillId, @CustomerId, @Warehouse
        while @@fetch_status = 0
        begin
            /**/
            declare Cursor6 cursor local for 
                select 
                    GoodsId, 
                    BatchNo, 
                    Packing,
                    Location, 
                    Packages, 
                    Tunnages,
                    Piles,
                    TenThousands,
                    ProductionDate
                from 
                    EnterWarehouseBillGoods 
                where 
                    EnterWarehouseBillId = @EnterWarehouseBillId
        
            open Cursor6
            fetch next from Cursor6 into 
                @GoodsId, 
                @BatchNo, 
                @Packing,
                @Location, 
                @Packages, 
                @Tunnages,
                @Piles,
                @TenThousands,
                @ProductionDate
                
            while @@fetch_status = 0
            begin
                /**/
                select 
                    @StockId = Id 
                from 
                    Stock 
                where 
                    CustomerId = @CustomerId and
                    GoodsId = @GoodsId and 
                    BatchNo = @BatchNo and 
                    Packing = @Packing and
                    Warehouse = @Warehouse and
                    Location = @Location and 
                    Packages = @Packages and 
                    Tunnages = @Tunnages and 
                    Piles = @Piles and 
                    TenThousands = @TenThousands and 
                    ProductionDate = @ProductionDate and
                    EnterWarehouseBillId = @EnterWarehouseBillId
                if @@rowcount = 0
                begin
                    raiserror (150392,18,1)
                    return -15
                end
    
                delete from Stock where Id = @StockId
                if @@rowcount = 0
                begin
                    raiserror (150556,18,1)
                    return -16
                end
    
                /**/
                delete from StockDaily where StockId = @StockId
                
                fetch next from Cursor6 into 
                    @GoodsId, 
                    @BatchNo, 
                    @Packing,
                    @Location, 
                    @Packages, 
                    @Tunnages,
                    @Piles,
                    @TenThousands,
                    @ProductionDate
            end
            
            close Cursor6
            deallocate Cursor6
        
            /**/
            delete from EnterWarehouseBillGoods where EnterWarehouseBillId = @EnterWarehouseBillId 
            if @@rowcount = 0
            begin
                raiserror (150408,18,1)
                return -17
            end
            
            fetch next from Cursor5 into @EnterWarehouseBillId, @CustomerId, @Warehouse
        end
        
        close Cursor5
        deallocate Cursor5
        
        /**/
        delete from EnterWarehouseBill where PlanId = @Id 
        if @@rowcount = 0
        begin
            raiserror (150555,18,1)
            return -18
        end
    end
    
    /**/
    if exists(select * from DeliverBill where PlanId = @Id)
    begin
        declare @DeliverBillId bigint
        
        declare Cursor7 cursor local for 
            select Id from DeliverBill where PlanId = @Id
            
        open Cursor7
        fetch next from Cursor7 into @DeliverBillId
        while @@fetch_status = 0
        begin
            /**/
            delete from DeliverBillGoods where DeliverBillId = @DeliverBillId 
            if @@rowcount = 0
            begin
                raiserror (150426,18,1)
                return -19
            end
            
            /**/
            delete from DeliverBillCustomerTransportPrice where DeliverBillId = @DeliverBillId 
            if @@error <> 0
            begin
                raiserror (150557,18,1)
                return -20
            end
            
            /**/
            delete from DeliverBillCarrierTransportPrice where DeliverBillId = @DeliverBillId 
            if @@error <> 0
            begin
                raiserror (150697,18,1)
                return -21
            end
            
            /**/
            declare @CustomerTransportChargesSettlementId bigint
            declare @TransportCharges numeric(25,9)
            declare @CarpoolFee numeric(25,9)
                
            declare Cursor8 cursor local for 
                select CustomerTransportChargesSettlementId, TransportCharges, CarpoolFee from CustomerTransportChargesSettlementDetail where DeliverBillId = @DeliverBillId
            
            open Cursor8
            fetch next from Cursor8 into @CustomerTransportChargesSettlementId, @TransportCharges, @CarpoolFee
            while @@fetch_status = 0
            begin
                update CustomerTransportChargesSettlement set InvoiceAmount = InvoiceAmount - @TransportCharges - @CarpoolFee where Id = @CustomerTransportChargesSettlementId
                if @@rowcount = 0
                begin
                    raiserror (150485,18,1)
                    return -22
                end
                    
                delete from CustomerTransportChargesSettlement where Id = @CustomerTransportChargesSettlementId and InvoiceAmount = 0
                if @@error <> 0
                begin
                    raiserror (150559,18,1)
                    return -23
                end
                    
                fetch next from Cursor8 into @CustomerTransportChargesSettlementId, @TransportCharges, @CarpoolFee
            end
                
            close Cursor8
            deallocate Cursor8
            
            delete from CustomerTransportChargesSettlementDetail where DeliverBillId = @DeliverBillId 
            if @@error <> 0
            begin
                raiserror (150558,18,1)
                return -24
            end
            
            /**/
            declare @CarrierTransportChargesSettlementId bigint
                
            declare Cursor9 cursor local for 
                select CarrierTransportChargesSettlementId, TransportCharges from CarrierTransportChargesSettlementDetail where DeliverBillId = @DeliverBillId
            
            open Cursor9
            fetch next from Cursor9 into @CarrierTransportChargesSettlementId, @TransportCharges
            while @@fetch_status = 0
            begin
                update CarrierTransportChargesSettlement set 
                    SettlementAmount = SettlementAmount - @TransportCharges,
                    FactpaymentAmount =  SettlementAmount - @TransportCharges - WithholdAmount
                where 
                    Id = @CarrierTransportChargesSettlementId
                if @@rowcount = 0
                begin
                    raiserror (150560,18,1)
                    return -25
                end
                    
                delete from CarrierTransportChargesSettlement where Id = @CarrierTransportChargesSettlementId and SettlementAmount = 0
                if @@error <> 0
                begin
                    raiserror (150561,18,1)
                    return -26
                end
                    
                fetch next from Cursor9 into @CarrierTransportChargesSettlementId, @TransportCharges
            end
                
            close Cursor9
            deallocate Cursor9
            
            delete from CarrierTransportChargesSettlementDetail where DeliverBillId = @DeliverBillId 
            if @@error <> 0
            begin
                raiserror (150562,18,1)
                return -27
            end
            
            fetch next from Cursor7 into @DeliverBillId
        end
        
        close Cursor7
        deallocate Cursor7
        
        /**/
        delete from DeliverBill where PlanId = @Id 
        if @@rowcount = 0
        begin
            raiserror (150424,18,1)
            return -28
        end
    end
    
    /**/
    if exists(select * from ShipmentBill where PlanId = @Id)
    begin
        delete from ShipmentBillGoods where ShipmentBillId in (select Id from ShipmentBill where PlanId = @Id)
        if @@rowcount = 0
        begin
            raiserror (150382,18,1)
            return -29
        end
        
        delete from ShipmentBill where PlanId = @Id
        if @@rowcount = 0
        begin
            raiserror (150563,18,1)
            return -30
        end
    end
    
    /**/
    if exists(select * from DispatchBillDeliverPlan where PlanId = @Id)
    begin
        declare @DispatchBillId bigint
        declare @DispatchPackages int
        declare @DispatchTunnages numeric(25,9)
        declare @DispatchPiles numeric(25,9)
        declare @DispatchTenThousands numeric(25,9)
        declare @DispatchTransportCharges numeric(25,9)
        
        declare Cursor10 cursor local for 
            select DispatchBillId, Packages, Tunnages, Piles, TenThousands, TransportCharges from DispatchBillDeliverPlan where PlanId = @Id
            
        open Cursor10
        fetch next from Cursor10 into @DispatchBillId, @DispatchPackages, @DispatchTunnages, @DispatchPiles, @DispatchTenThousands, @DispatchTransportCharges
        while @@fetch_status = 0
        begin
            delete from DispatchBillGoods where DispatchBillId = @DispatchBillId and PlanId = @Id
            if @@rowcount = 0
            begin
                raiserror (150353,18,1)
                return -31
            end
            
            /**/
            update DispatchBill set 
                TotalPackages = TotalPackages - @DispatchPackages,
                TotalTunnages = TotalTunnages - @DispatchTunnages,
                TotalPiles = TotalPiles - @DispatchPiles,
                TotalTenThousands = TotalTenThousands - @DispatchTenThousands,
                TotalTransportCharges = TotalTransportCharges - @DispatchTransportCharges 
            where 
                Id = @DispatchBillId
            if @@rowcount = 0
            begin
                raiserror (150315,18,1)
                return -32
            end
            
            /*0*/
            delete from DispatchBill where Id = @DispatchBillId and TotalPackages = 0 and TotalTunnages = 0 and TotalPiles = 0 and TotalTenThousands = 0
            if @@error <> 0
            begin
                raiserror (150349,18,1)
                return -33
            end
            
            fetch next from Cursor10 into @DispatchBillId, @DispatchPackages, @DispatchTunnages, @DispatchPiles, @DispatchTenThousands, @DispatchTransportCharges
        end
        
        close Cursor10
        deallocate Cursor10
        
        /**/
        delete from DispatchBillDeliverPlan where PlanId = @Id
        if @@rowcount = 0
        begin
            raiserror (150351,18,1)
            return -34
        end
    end

    
    /**/
    if exists(select * from DeliverPlan where Id = @Id and PlanState = formatmessage(150241))
    begin
        delete from DeliverPlanGoods where PlanId = @Id
        if @@rowcount = 0
        begin
            raiserror (150564,18,1)
            return -35
        end
        
        delete from DeliverPlan where Id = @Id 
        if @@rowcount = 0
        begin
            raiserror (150268,18,1)
            return -36
        end
        
        delete from DeliverPlanApproveComment where PlanId = @Id
        if @@error <> 0
        begin
            raiserror (150565,18,1)
            return -37
        end
    end
    else
    begin
        update DeliverPlan set 
            PlanState = formatmessage(150243),
            Remark = isnull(Remark,'') + ' ' + convert(nvarchar(10),getdate(),120) + formatmessage(150569),
            IsDelete = 1
        where 
            Id = @Id 
        if @@rowcount = 0
        begin
            raiserror (150329,18,1)
            return -38
        end
    end
    
    
    /**/
    select @OpName = formatmessage(150269)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -39
    end
    
    return 0
end
go


create procedure DeleteDeliverPlanAllGoods 
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from DeliverPlanGoods where PlanId = @PlanId 
    
    /**/
    select @OpName = formatmessage(150266)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteDispatchBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from DispatchBill where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150349,18,1)
        return -1
    end
    
    /**/
    delete from ContractDeliverPlan where ContractId in (select Id from Contract where DispatchBillId = @Id)
    delete from Contract where DispatchBillId = @Id
    
    
    /**/
    select @OpName = formatmessage(150350)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteDispatchBillAllGoods 
@DispatchBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from DispatchBillGoods where DispatchBillId = @DispatchBillId 
    
    
    /**/
    select @OpName = formatmessage(150354)
    select @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteDispatchBillDeliverPlan 
@DispatchBillId bigint,
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @ContractId bigint
declare @TotalPackages int
declare @TotalTunnages numeric(25,9)
declare @TotalPiles numeric(25,9)
declare @TotalTenThousands numeric(25,9)
declare @TotalTransportCharges numeric(25,9)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from DispatchBillDeliverPlan where DispatchBillId = @DispatchBillId and PlanId = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150363,18,1)
        return -1
    end
    
    /**/
    if exists(select * from Contract where DispatchBillId = @DispatchBillId)
    begin
        select @ContractId = Id from Contract where DispatchBillId = @DispatchBillId
        if @@rowcount = 0
        begin
            raiserror (150692,18,1)
            return -2
        end
        
        select 
            @TotalPackages = isnull(sum(Packages),0), 
            @TotalTunnages = isnull(sum(Tunnages),0.0),
            @TotalPiles = isnull(sum(Piles),0.0),
            @TotalTenThousands = isnull(sum(TenThousands),0.0),
            @TotalTransportCharges = isnull(sum(TransportCharges),0.0)
        from 
            DispatchBillDeliverPlan 
        where 
            DispatchBillId = @DispatchBillId and 
            PlanId in (select Id from DeliverPlan where ReceiveType = formatmessage(150348))
            
        if @TotalPackages = 0 and @TotalTunnages = 0 and @TotalPiles = 0 and @TotalTenThousands = 0 and @TotalTransportCharges = 0
        begin
            /**/
            delete from Contract where Id = @ContractId
            if @@rowcount = 0
            begin
                raiserror (150122,18,1)
                return -3
            end
        end
        else
        begin
            /**/
            update Contract set 
                TotalPackages = @TotalPackages,
                TotalTunnages = @TotalTunnages,
                TotalPiles = @TotalPiles,
                TotalTenThousands = @TotalTenThousands,
                TotalTransportCharges = @TotalTransportCharges,
                ResidualTransportCharges = @TotalTransportCharges - PrepayTransportCharges
            where 
                Id = @ContractId
            if @@rowcount = 0
            begin
                raiserror (150154,18,1)
                return -4
            end
        end
        
        /**/
        delete from ContractDeliverPlan where ContractId = @ContractId and PlanId = @PlanId
    end
   
    
    /**/
    select @OpName = formatmessage(150364)
    select @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) + N',' +
                       N'PlanId=' + convert(nvarchar,@PlanId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -5
    end
    
    return 0
end
go


create procedure DeleteDispatchBillDeliverPlanAllGoods 
@DispatchBillId bigint,
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from DispatchBillGoods where DispatchBillId = @DispatchBillId and PlanId = @PlanId 
    
    if @@rowcount = 0
    begin
        raiserror (150353,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150354)
    select @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) + N',' +
                       N'PlanId=' + convert(nvarchar,@PlanId)
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteDispatchBillDeliverPlans 
@DispatchBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from DispatchBillDeliverPlan where DispatchBillId = @DispatchBillId 
    
    if @@rowcount = 0
    begin
        raiserror (150351,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150352)
    select @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteEnterWarehouseBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from EnterWarehouseBill where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150605,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150606)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteEnterWarehouseBillAllGoods 
@EnterWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @CustomerId bigint
declare @Warehouse nvarchar(20)
declare @EnterType nvarchar(20)
declare @GoodsId bigint
declare @BatchNo nvarchar(20)
declare @Packing nvarchar(10)
declare @Location nvarchar(10)
declare @Packages int
declare @Tunnages numeric(25,9)
declare @Piles numeric(25,9)
declare @TenThousands numeric(25,9)
declare @ProductionDate nvarchar(10)
declare @StockId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @CustomerId = CustomerId, @Warehouse = Warehouse, @EnterType = EnterType from EnterWarehouseBill where Id = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150281,18,1)
        return -1
    end
    
    /**/
    declare Cursor1 cursor local for 
        select 
            GoodsId, 
            BatchNo, 
            Packing,
            Location, 
            Packages, 
            Tunnages,
            Piles,
            TenThousands,
            ProductionDate 
        from 
            EnterWarehouseBillGoods 
        where 
            EnterWarehouseBillId = @EnterWarehouseBillId
        
    open Cursor1
    fetch next from Cursor1 into 
        @GoodsId, 
        @BatchNo, 
        @Packing, 
        @Location, 
        @Packages, 
        @Tunnages, 
        @Piles, 
        @TenThousands, 
        @ProductionDate
        
    while @@fetch_status = 0
    begin
        /**/
        if @EnterType = formatmessage(150629)
        begin
            update Stock set 
                Tunnages = Tunnages - @Tunnages,
                EnterWarehouseBillId = OriginalEnterWarehouseBillId,
                OriginalEnterWarehouseBillId = 0
            where 
                CustomerId = @CustomerId and
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and
                Warehouse = @Warehouse and
                Location = @Location and 
                Packages = 0 and 
                Tunnages = 0 and 
                Piles = 0 and 
                TenThousands = 0 and
                ProductionDate = @ProductionDate and
                EnterWarehouseBillId = @EnterWarehouseBillId
            
            if @@rowcount = 0
            begin
                raiserror (150623,18,1)
                return -2
            end
        end
        else
        begin
            select 
                @StockId = Id 
            from 
                Stock 
            where 
                CustomerId = @CustomerId and
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and
                Warehouse = @Warehouse and
                Location = @Location and 
                Packages = @Packages and 
                Tunnages = @Tunnages and 
                Piles = @Piles and 
                TenThousands = @TenThousands and
                ProductionDate = @ProductionDate and
                EnterWarehouseBillId = @EnterWarehouseBillId
            if @@rowcount = 0
            begin
                raiserror (150392,18,1)
                return -3
            end
        
            delete from Stock where Id = @StockId
            if @@rowcount = 0
            begin
                raiserror (150556,18,1)
                return -4
            end
            
            /**/
            delete from StockDaily where StockId = @StockId
        end
                
        fetch next from Cursor1 into 
            @GoodsId, 
            @BatchNo, 
            @Packing, 
            @Location, 
            @Packages, 
            @Tunnages, 
            @Piles, 
            @TenThousands, 
            @ProductionDate
    end
            
    close Cursor1
    deallocate Cursor1
        
    /**/
    delete from EnterWarehouseBillGoods where EnterWarehouseBillId = @EnterWarehouseBillId 
    if @@rowcount = 0
    begin
        raiserror (150408,18,1)
        return -5
    end
    
    
    /**/
    select @OpName = formatmessage(150409)
    select @OpParams = N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -6
    end
    
    return 0
end
go


create procedure DeleteEnterWarehouseBillGoods 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @EnterWarehouseBillId bigint
declare @GoodsId bigint
declare @BatchNo nvarchar(20)
declare @Location nvarchar(10) 
declare @Packages int
declare @Tunnages numeric(25,9)
declare @Piles numeric(25,9)
declare @TenThousands numeric(25,9)
declare @Packing nvarchar(10)
declare @ProductionDate nvarchar(10)
declare @CustomerId bigint
declare @Warehouse nvarchar(20)
declare @StockId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @EnterWarehouseBillId = EnterWarehouseBillId,
        @GoodsId = GoodsId, 
        @BatchNo = BatchNo, 
        @Location = Location,
        @Packages = Packages,
        @Tunnages = Tunnages,
        @Piles = Piles,
        @TenThousands = TenThousands,
        @Packing = Packing,
        @ProductionDate = ProductionDate
    from 
        EnterWarehouseBillGoods 
    where 
        Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150410,18,1)
        return -1
    end
    
    /**/
    select 
        @CustomerId = CustomerId,
        @Warehouse = Warehouse 
    from 
        EnterWarehouseBill 
    where 
        Id = @EnterWarehouseBillId 
    if @@rowcount = 0
    begin
        raiserror (150281,18,1)
        return -2
    end
    
    /**/
    delete from EnterWarehouseBillGoods where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150408,18,1)
        return -3
    end
    
   
    /**/
    select 
        @StockId = Id 
    from 
        Stock 
    where 
        CustomerId = @CustomerId and 
        GoodsId = @GoodsId and 
        BatchNo = @BatchNo and 
        Packing = @Packing and
        ProductionDate = @ProductionDate and
        Warehouse = @Warehouse and 
        Location = @Location and 
        Packages = @Packages and 
        Tunnages = @Tunnages and
        Piles = @Piles and 
        TenThousands = @TenThousands and
        EnterWarehouseBillId = @EnterWarehouseBillId 
    if @@rowcount = 0
    begin
        raiserror (150392,18,1)
        return -4
    end
    
    delete from Stock where Id = @StockId
    if @@rowcount = 0
    begin
        raiserror (150556,18,1)
        return -5
    end
    
    /**/
    delete from StockDaily where StockId = @StockId
    
    
    /**/
    select @OpName = formatmessage(150409)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -6
    end
    
    return 0
end
go


create procedure DeleteGoods 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from Goods where Id = @Id 
    
    if @@rowcount=0
    begin
        raiserror (150184,18,1)
        return -1
    end

    /**/
    select @OpName = formatmessage(150185)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure DeleteGoodsType 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select 1 from GoodsType where FullPath like (select FullPath + '%' from GoodsType where Id = @Id) and (Id in (select distinct TypeId from Goods)))
    begin
        raiserror (150099,18,1)
        return -1
    end
    
    /**/
    delete from GoodsType where FullPath like (select FullPath + '%' from GoodsType where Id = @Id)
    if @@rowcount=0
    begin
        raiserror (150100,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150101)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @GroupId
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure DeleteGroupPermissions
@GroupId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	if exists(select 1 from SysGroupPermission where GroupId = @GroupId)
	begin
        /**/
		delete from SysGroupPermission where GroupId = @GroupId
        
		if @@rowcount=0
		begin
			raiserror (150160,18,1)
            return -1
        end

        /**/
        select @OpName = formatmessage(150161)
        select @OpParams = N'GroupId=' + convert(nvarchar,@GroupId)
        
        exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
        if @OpRet = 1
        begin
            raiserror (150001,18,1)
            return -2
        end
    end
    
    return 0
end
go


create procedure DeleteMoveWarehouseBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @CustomerId bigint
declare @ConsignedDeliveryNo nvarchar(20)
declare @Warehouse nvarchar(20)
declare @GoodsId bigint
declare @BatchNo nvarchar(20)
declare @Packing nvarchar(10)
declare @ProductionDate nvarchar(10)
declare @Location nvarchar(10)
declare @EnterWarehouseBillId bigint
declare @DeliveryNo nvarchar(20)
declare @NewLocation nvarchar(10)
declare @NewPackages int
declare @NewTunnages numeric(25,9)
declare @NewPiles numeric(25,9)
declare @NewTenThousands numeric(25,9)
declare @CreateTime datetime
declare @CreateTime1 datetime
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @CustomerId = CustomerId, 
        @Warehouse = Warehouse, 
        @ConsignedDeliveryNo = ConsignedDeliveryNo,
        @CreateTime = CreateTime
    from 
        MoveWarehouseBill 
    where 
        Id = @Id 
        
    if @@rowcount = 0
    begin
        raiserror (150466,18,1)
        return -1
    end
    
    /**/
    declare Cursor1 cursor local for 
        select 
            GoodsId, 
            BatchNo, 
            Packing,
            Location, 
            ProductionDate,
            EnterWarehouseBillId, 
            DeliveryNo, 
            NewLocation, 
            NewPackages, 
            NewTunnages,
            NewPiles,
            NewTenThousands
        from 
            MoveWarehouseBillGoods 
        where 
            MoveWarehouseBillId = @Id 
            
    open Cursor1
    
    fetch next from Cursor1 into 
        @GoodsId, 
        @BatchNo, 
        @Packing, 
        @Location, 
        @ProductionDate, 
        @EnterWarehouseBillId, 
        @DeliveryNo, 
        @NewLocation, 
        @NewPackages, 
        @NewTunnages,
        @NewPiles,
        @NewTenThousands
    
    while @@fetch_status = 0
    begin
        if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
        begin
            /**/
            update Stock set 
                Packages = Packages - @NewPackages,
                Tunnages = Tunnages - @NewTunnages,
                Piles = Piles - @NewPiles,
                TenThousands = TenThousands - @NewTenThousands
            where 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and
                Warehouse = @Warehouse and 
                Location = @NewLocation and 
                Packages >= @NewPackages and 
                Tunnages >= @NewTunnages and
                Piles >= @NewPiles and 
                TenThousands >= @NewTenThousands and
                ProductionDate = @ProductionDate and
                EnterWarehouseBillId = @EnterWarehouseBillId and 
                DeliveryNo = @ConsignedDeliveryNo
            if @@rowcount = 0
            begin
                raiserror (150607,18,1)
                return -2
            end
            
            set @CreateTime1 = @CreateTime
            while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
            begin
                update StockDaily set 
                    Packages = Packages - @NewPackages,
                    Tunnages = Tunnages - @NewTunnages,
                    Piles = Piles - @NewPiles,
                    TenThousands = TenThousands - @NewTenThousands
                where 
                    StockId in 
                    (
                        select 
                            Id
                        from 
                            Stock 
                        where 
                            GoodsId = @GoodsId and 
                            BatchNo = @BatchNo and 
                            Packing = @Packing and
                            Warehouse = @Warehouse and 
                            Location = @NewLocation and 
                            Packages >= @NewPackages and 
                            Tunnages >= @NewTunnages and
                            Piles >= @NewPiles and 
                            TenThousands >= @NewTenThousands and
                            ProductionDate = @ProductionDate and
                            EnterWarehouseBillId = @EnterWarehouseBillId and 
                            DeliveryNo = @ConsignedDeliveryNo
                    ) and 
                    convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
            
                set @CreateTime1 = dateadd(day,1,@CreateTime1)
            end
            
            /**/
            update Stock set 
                Packages = Packages + @NewPackages,
                Tunnages = Tunnages + @NewTunnages,
                Piles = Piles + @NewPiles,
                TenThousands = TenThousands + @NewTenThousands
            where 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and
                Warehouse = @Warehouse and 
                Location = @Location and 
                ProductionDate = @ProductionDate and
                EnterWarehouseBillId = @EnterWarehouseBillId and 
                DeliveryNo = @ConsignedDeliveryNo 
            if @@rowcount = 0
            begin
                raiserror (150295,18,1)
                return -3
            end
            
            set @CreateTime1 = @CreateTime
            while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
            begin
                update StockDaily set 
                    Packages = Packages + @NewPackages,
                    Tunnages = Tunnages + @NewTunnages,
                    Piles = Piles + @NewPiles,
                    TenThousands = TenThousands + @NewTenThousands
                where 
                    StockId in 
                    (
                        select 
                            Id
                        from 
                            Stock 
                        where 
                            GoodsId = @GoodsId and 
                            BatchNo = @BatchNo and 
                            Packing = @Packing and
                            Warehouse = @Warehouse and 
                            Location = @Location and 
                            ProductionDate = @ProductionDate and
                            EnterWarehouseBillId = @EnterWarehouseBillId and 
                            DeliveryNo = @ConsignedDeliveryNo 
                    ) and 
                    convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
            
                set @CreateTime1 = dateadd(day,1,@CreateTime1)
            end
        end
        else
        begin
            /**/
            update Stock set 
                Packages = Packages - @NewPackages,
                Tunnages = Tunnages - @NewTunnages,
                Piles = Piles - @NewPiles,
                TenThousands = TenThousands - @NewTenThousands
            where 
                CustomerId = @CustomerId and 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and
                Warehouse = @Warehouse and 
                Location = @NewLocation and 
                Packages >= @NewPackages and 
                Tunnages >= @NewTunnages and
                Piles >= @NewPiles and 
                TenThousands >= @NewTenThousands and
                ProductionDate = @ProductionDate and
                EnterWarehouseBillId = @EnterWarehouseBillId and 
                DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1) and 
                DeliveryNo = @DeliveryNo
            if @@rowcount = 0
            begin
                raiserror (150607,18,1)
                return -4
            end
            
            set @CreateTime1 = @CreateTime
            while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
            begin
                update StockDaily set 
                    Packages = Packages - @NewPackages,
                    Tunnages = Tunnages - @NewTunnages,
                    Piles = Piles - @NewPiles,
                    TenThousands = TenThousands - @NewTenThousands
                where 
                    StockId in 
                    (
                        select 
                            Id
                        from 
                            Stock 
                        where 
                            CustomerId = @CustomerId and 
                            GoodsId = @GoodsId and 
                            BatchNo = @BatchNo and 
                            Packing = @Packing and
                            Warehouse = @Warehouse and 
                            Location = @NewLocation and 
                            Packages >= @NewPackages and 
                            Tunnages >= @NewTunnages and
                            Piles >= @NewPiles and 
                            TenThousands >= @NewTenThousands and
                            ProductionDate = @ProductionDate and
                            EnterWarehouseBillId = @EnterWarehouseBillId and 
                            DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1) and 
                            DeliveryNo = @DeliveryNo
                    ) and 
                    convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
            
                set @CreateTime1 = dateadd(day,1,@CreateTime1)
            end
            
            /**/
            update Stock set 
                Packages = Packages + @NewPackages,
                Tunnages = Tunnages + @NewTunnages,
                Piles = Piles + @NewPiles,
                TenThousands = TenThousands + @NewTenThousands
            where 
                CustomerId = @CustomerId and 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and
                Warehouse = @Warehouse and 
                Location = @Location and 
                ProductionDate = @ProductionDate and
                EnterWarehouseBillId = @EnterWarehouseBillId and 
                DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1) and 
                DeliveryNo = @DeliveryNo 
            if @@rowcount = 0
            begin
                raiserror (150295,18,1)
                return -5
            end
            
            set @CreateTime1 = @CreateTime
            while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
            begin
                update StockDaily set 
                    Packages = Packages + @NewPackages,
                    Tunnages = Tunnages + @NewTunnages,
                    Piles = Piles + @NewPiles,
                    TenThousands = TenThousands + @NewTenThousands
                where 
                    StockId in 
                    (
                        select 
                            Id
                        from 
                            Stock 
                        where 
                            CustomerId = @CustomerId and 
                            GoodsId = @GoodsId and 
                            BatchNo = @BatchNo and 
                            Packing = @Packing and
                            Warehouse = @Warehouse and 
                            Location = @Location and 
                            ProductionDate = @ProductionDate and
                            EnterWarehouseBillId = @EnterWarehouseBillId and 
                            DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1) and 
                            DeliveryNo = @DeliveryNo 
                    ) and 
                    convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
            
                set @CreateTime1 = dateadd(day,1,@CreateTime1)
            end
        end
        
        fetch next from Cursor1 into 
            @GoodsId, 
            @BatchNo, 
            @Packing, 
            @Location, 
            @ProductionDate, 
            @EnterWarehouseBillId, 
            @DeliveryNo, 
            @NewLocation, 
            @NewPackages, 
            @NewTunnages,
            @NewPiles,
            @NewTenThousands
    end
        
    close Cursor1
    deallocate Cursor1 
    
   
    /**/
    delete from MoveWarehouseBill where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150608,18,1)
        return -6
    end
    
    delete from MoveWarehouseBillGoods where MoveWarehouseBillId = @Id
    if @@rowcount = 0
    begin
        raiserror (150609,18,1)
        return -7
    end
    
    
    /**/
    select @OpName = formatmessage(150610)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -8
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure DeleteOrganization 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @FullPath nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    select @FullPath = FullPath from Organization where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150061,18,1)
        return -1
    end
    
    /**/
    exec ('select * from Staff where OrganId in (select Id from Organization where FullPath like ''' + @FullPath + '%'')')
    if @@rowcount > 0
    begin
        raiserror (150062,18,1)
        return -2
    end
    
    /**/
    exec ('delete from Organization where FullPath like ''' + @FullPath + '%''')
    if @@rowcount=0
    begin
        raiserror (150063,18,1)
        return -3
    end

    /**/
    select @OpName = formatmessage(150064)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure DeleteOutWarehouseBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @CreateTime datetime
declare @ErrText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @CreateTime = CreateTime from OutWarehouseBill where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150395,18,1)
        return -1
    end
    
    /**/
    begin try
        exec RestoreStock @Id, @CreateTime, @OpStaffId, @OpStaffName 
    end try
    begin catch
        select @ErrText = error_message()
        raiserror (@ErrText,18,1)
        return -2
    end catch
    
    /**/
    delete from OutWarehouseBill where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150555,18,1)
        return -3
    end
    
    /**/
    select @OpName = formatmessage(150567)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure DeleteOutWarehouseBillAllGoods 
@OutWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from OutWarehouseBillGoods where OutWarehouseBillId = @OutWarehouseBillId 
    
    if @@rowcount = 0
    begin
        raiserror (150554,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150568)
    select @OpParams = N'OutWarehouseBillId=' + convert(nvarchar,@OutWarehouseBillId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure DeletePermissionGroup
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    if exists(select * from AccountPermission where GroupId = @Id)
    begin
		raiserror (150010,18,1)
        return -1
    end

	/**/
	delete from SysGroup where Id = @Id
	if @@rowcount=0
	begin
		raiserror (150011,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150012)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end

    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure DeletePosition 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    delete from Position where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150070,18,1)
        return -1
    end

    /**/
    select @OpName = formatmessage(150071)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
* 
*
* 
* @Id
* @OpStaffId
* @OpStaffName
*
*******************************************************************************************/
create procedure DeleteProvince
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	set @Sql = 'delete from Province where Id = ' + convert(nvarchar,@Id)
    exec (@Sql) 
    
    /**/
    set @OpName = formatmessage(150042)
    set @OpParams = N'Id=' + convert(nvarchar,@Id)
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteReceiver
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from Receiver where Id = @Id
    
    if @@rowcount=0
    begin
        raiserror (150601,18,1)
        return -1
    end
    
    /**/
    set @OpName = formatmessage(150602)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteReceiverDistances
@ReceiverName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    delete from ReceiverDistance where ReceiverName = @ReceiverName
    
    /**/
    set @OpName = formatmessage(150600)
    set @OpParams = N'ReceiverName=' + @ReceiverName 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteShipmentBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from ShipmentBill where Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150384,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150385)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteShipmentBillAllGoods 
@ShipmentBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    delete from ShipmentBillGoods where ShipmentBillId = @ShipmentBillId 
    
    if @@rowcount = 0
    begin
        raiserror (150386,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150387)
    select @OpParams = N'ShipmentBillId=' + convert(nvarchar,@ShipmentBillId) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure DeleteStaff 
@Id bigint, 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OrganId bigint
declare @Sql nvarchar(max) 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @OrganId = OrganId from Staff where Id = @Id 
    
    if @OrganId is null or @OrganId = 0 
    begin
        raiserror (150080,18,1)
        return -1
    end
    
    
    /**/
    set @Sql = 'delete from AccountPermission where AccountId in (select Id from Account where OrganId = ' +  convert(nvarchar,@OrganId) + ' and StaffId = ' + convert(nvarchar,@Id) + ')'
    exec (@Sql) 
   
    
    /*ID*/
    set @Sql = 'delete from IdGenerator where AccountId in (select Id from Account where OrganId = ' +  convert(nvarchar,@OrganId) + ' and StaffId = ' + convert(nvarchar,@Id) + ')'
    exec (@Sql) 

   
    /**/
    set @Sql = 'delete from Account where OrganId = ' + convert(nvarchar,@OrganId) + ' and StaffId = ' + convert(nvarchar,@Id) 
    exec (@Sql) 
    
    
    /**/
    set @Sql = 'delete from Staff where Id = ' + convert(nvarchar,@Id) 
    exec (@Sql) 
    
    
    /**/
    set @OpName = formatmessage(150081)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure DeleteTransportLimitedPrice
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	delete from TransportLimitedPrice where Id = @Id
    
    
    /**/
    set @OpName = formatmessage(150227)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure DeleteWarehouse
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	set @Sql = 'delete from Warehouse where Id = ' + convert(nvarchar,@Id)
    exec (@Sql) 
    
    /**/
    set @OpName = formatmessage(150195)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure InsertAccount 
@Id bigint output,
@Name nvarchar(20),
@Password nvarchar(50),
@AccountType nvarchar(20),
@OrganId bigint,
@StaffId bigint,
@StaffName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OrganFullName nvarchar(500)
declare @OnlineStartId bigint 
declare @OfflineStartId bigint 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if @AccountType = formatmessage(150162)
    begin
        select @OrganFullName = FullName from Organization where Id = @OrganId 
    end
    else 
    begin
        select @OrganFullName = Name from Customer where Id = @OrganId 
    end
    
    if @OrganFullName is null or @OrganFullName = ''
    begin
        raiserror (150164,18,1)
        return -1
    end
    
    /**/
    if @AccountType = formatmessage(150162)
    begin
        select @StaffName = (case when FamilyName is null then N'' else FamilyName end + Name) from Staff where Id = @StaffId 
    end
    
    if @StaffName is null or @StaffName = ''
    begin
        raiserror (150165,18,1)
        return -2
    end
    
    /*10*/
    select @OnlineStartId = max(OfflineStartId) from Account 
    
    /*201-2000000000*/
    if @OnlineStartId is null
        set @OnlineStartId = 2000000001
        
    /*ID*/
    while 1 = 1
    begin
        set @OnlineStartId = @OnlineStartId + 1000000000
        set @OfflineStartId = @OnlineStartId + 1000000000
        
        if exists(select * from OpLog where Id >= @OnlineStartId and Id < @OfflineStartId + 1000000000)
        begin
            set @OnlineStartId = @OfflineStartId
            continue 
        end
        else 
        begin
            break
        end
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into Account 
        (
            Id,
            Name,
            Password,
            AccountType,
            OrganId,
            OrganFullName,
            StaffId,
            StaffName,
            IsCancel,
            OnlineStartId,
            OfflineStartId,
            CreateTime
        )
    values
        (
            @Id,
            @Name,
            @Password,
            @AccountType,
            @OrganId,
            @OrganFullName,
            @StaffId,
            @StaffName,
            0,
            @OnlineStartId,
            @OfflineStartId,
            getdate()
        )
        
    if @@rowcount = 0
    begin
        raiserror (150166,18,1)
        return -3
    end

    /**/
    select @OpName = formatmessage(150167)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'Name=' + @Name + N',' +
                       N'Password=' + @Password + N',' +
                       N'AccountType=' + @AccountType + N',' +
                       N'OrganId=' + convert(nvarchar,@OrganId) + N',' +
                       N'StaffId=' + convert(nvarchar,@StaffId) + N',' +
                       N'StaffName=' + @StaffName 

    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @AccountId
 * @PermissionGroupId
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure InsertAccountPermission
@AccountId bigint,
@GroupId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Id bigint 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

    /**/
    exec GetId @OpStaffId, @Id output 

	/**/
	insert into AccountPermission (Id, AccountId, GroupId) values (@Id, @AccountId, @GroupId)
    
	if @@rowcount=0
	begin
		raiserror (150016,18,1)
        return -1
    end

    /**/
    select @OpName = formatmessage(150017)
    select @OpParams = N'AccountId=' + convert(nvarchar,@AccountId) + N',' +
                       N'GroupId=' + convert(nvarchar,@GroupId)
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure InsertApproveFlowStep 
@Id bigint output,
@StepName nvarchar(50),
@StepNum int,
@FlowType nvarchar(50),
@DisposerId bigint,
@ConditionExpression nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @DisposerName nvarchar(50)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @DisposerName = (case when FamilyName is null then N'' else FamilyName end + Name) from Staff where Id = @DisposerId 
    
    if @@rowcount = 0
    begin
        raiserror (150287,18,1)
        return -1
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into ApproveFlowStep 
        (
            Id,
            StepName,
            StepNum,
            FlowType,
            DisposerId,
            DisposerName,
            ConditionExpression
        )
    values
        (
            @Id,
            @StepName,
            @StepNum,
            @FlowType,
            @DisposerId,
            @DisposerName,
            @ConditionExpression
        )
    
    if @@rowcount = 0
    begin
        raiserror (150126,18,1)
        return -2
    end
    
    /**/
    set @OpName = formatmessage(150127)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'FlowType=' + @FlowType + N',' +
                    N'StepName=' + @StepName + N',' +
                    N'StepNum=' + convert(nvarchar,@StepNum) + N',' +
                    N'DisposerId=' + convert(nvarchar,@DisposerId) + N',' +
                    N'ConditionExpression=' + @ConditionExpression 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertApproveFlowStepCondition 
@StepId bigint,
@FlowType nvarchar(50),
@ConditionNum int,
@FieldName nvarchar(50),
@CompareOperator nvarchar(20),
@FieldValue nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into ApproveFlowStepCondition 
        (
            Id,
            StepId,
            FlowType,
            ConditionNum,
            FieldName,
            CompareOperator,
            FieldValue
        )
    values
        (
            @Id,
            @StepId,
            @FlowType,
            @ConditionNum,
            @FieldName,
            @CompareOperator,
            @FieldValue
        )
    
    if @@rowcount = 0
    begin
        raiserror (150128,18,1)
        return -1
    end
    
    /**/
    set @OpName = formatmessage(150129)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'StepId=' + convert(nvarchar,@StepId) + N',' +
                    N'FlowType=' + @FlowType + N',' +
                    N'ConditionNum=' + convert(nvarchar,@ConditionNum) + N',' +
                    N'FieldName=' + @FieldName + N',' +
                    N'CompareOperator=' + @CompareOperator + N',' +
                    N'FieldValue=' + @FieldValue 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure InsertCarrier
@Id bigint output, 
@Name nvarchar(50),
@BusinessType nvarchar(10),
@PaymentType nvarchar(10),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from Carrier where Name = @Name)
    begin
        raiserror (150497,18,1)
        return -1
    end

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into Carrier 
        (
            Id,
            Name,
            BusinessType,
            PaymentType 
        )
    values
        (
            @Id,
            @Name,
            @BusinessType,
            @PaymentType 
        )
    
    if @@rowcount = 0
    begin
        raiserror (150199,18,1)
        return -2
    end
    
    /**/
    set @OpName = formatmessage(150200)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'Name=' + @Name + N',' +
                    N'BusinessType=' + @BusinessType + N',' +
                    N'PaymentType=' + @PaymentType 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertCarrierCar
@CarrierId bigint, 
@CarNo nvarchar(20),
@TrailerNo nvarchar(10),
@CarryingCapacity int,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from CarrierCar where CarNo = @CarNo)
    begin
        raiserror (150209,18,1)
        return -1
    end

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into CarrierCar 
        (
            Id,
            CarrierId,
            CarNo,
            TrailerNo,
            CarryingCapacity
        )
    values
        (
            @Id,
            @CarrierId,
            @CarNo,
            @TrailerNo,
            @CarryingCapacity
        )
    
    if @@rowcount = 0
    begin
        raiserror (150203,18,1)
        return -2
    end
    
    /**/
    set @OpName = formatmessage(150204)
    set @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                    N'CarNo=' + @CarNo + N',' +
                    N'TrailerNo=' + @TrailerNo + N',' +
                    N'CarryingCapacity=' + convert(nvarchar,@CarryingCapacity) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertCarrierDriver
@CarrierId bigint, 
@CarNo nvarchar(max),
@Name nvarchar(20),
@LicenseNo nvarchar(20),
@MobileTel nvarchar(20),
@HomeTel nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from CarrierDriver where LicenseNo = @LicenseNo and CarrierId = @CarrierId)
    begin
        raiserror (150215,18,1)
        return -1
    end

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into CarrierDriver 
        (
            Id,
            CarrierId,
            CarNo,
            Name,
            LicenseNo,
            MobileTel,
            HomeTel
        )
    values
        (
            @Id,
            @CarrierId,
            @CarNo,
            @Name,
            @LicenseNo,
            @MobileTel,
            @HomeTel
        )
    
    if @@rowcount = 0
    begin
        raiserror (150216,18,1)
        return -2
    end
    
    /**/
    set @OpName = formatmessage(150217)
    set @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                    N'CarNo=' + @CarNo + N',' +
                    N'Name=' + @Name + N',' +
                    N'LicenseNo=' + @LicenseNo + N',' +
                    N'MobileTel=' + @MobileTel + N',' +
                    N'HomeTel=' + @HomeTel 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertCarrierSettlementExpression
@CarrierId bigint, 
@PlanType nvarchar(10),
@TransportChargeExpression nvarchar(100),
@TransportPriceExpression nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into CarrierSettlementExpression 
        (
            Id,
            CarrierId,
            PlanType,
            TransportChargeExpression,
            TransportPriceExpression
        )
    values
        (
            @Id,
            @CarrierId,
            @PlanType,
            @TransportChargeExpression,
            @TransportPriceExpression
        )
    
    if @@rowcount = 0
    begin
        raiserror (150335,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150336)
    set @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                    N'PlanType=' + @PlanType + N',' +
                    N'TransportChargeExpression=' + @TransportChargeExpression + N',' +
                    N'TransportPriceExpression=' + @TransportPriceExpression 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure InsertCarrierTransportChargesSettlement
@Id bigint output,
@CarrierId bigint,
@CarrierName nvarchar(50),
@SettlementAmount numeric(25,9),
@WithholdAmount numeric(25,9),
@FactpaymentAmount numeric(25,9),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into CarrierTransportChargesSettlement 
    (
        Id, 
        CarrierId,
        CarrierName,
        SettlementAmount,
        WithholdAmount,
        FactpaymentAmount,
        Remark,
        CreatorId,
        CreatorName,
        CreateTime 
    ) 
    values 
    (
        @Id, 
        @CarrierId,
        @CarrierName,
        @SettlementAmount,
        @WithholdAmount,
        @FactpaymentAmount,
        @Remark,
        @OpStaffId,
        @OpStaffName,
        getdate()
    )
    if @@rowcount=0
    begin
        raiserror (150498,18,1)
        return -1
    end
            
    
    /**/
    select @OpName = formatmessage(150499)
    select @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                       N'CarrierName=' + @CarrierName + N',' +
                       N'SettlementAmount=' + convert(nvarchar,@SettlementAmount) + N',' +
                       N'WithholdAmount=' + convert(nvarchar,@WithholdAmount) + N',' +
                       N'FactpaymentAmount=' + convert(nvarchar,@FactpaymentAmount) + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure InsertCarrierTransportChargesSettlementDetail
@CarrierTransportChargesSettlementId bigint,
@DeliverBillId bigint, 
@TransportCharges numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    insert into CarrierTransportChargesSettlementDetail 
        (
            Id,
            CarrierTransportChargesSettlementId,
            DeliverBillId,
            TransportCharges
        )
    values
        (
            @Id,
            @CarrierTransportChargesSettlementId,
            @DeliverBillId,
            @TransportCharges
        )
        
    if @@rowcount = 0
    begin
        raiserror (150500,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150501)
    set @OpParams = N'CarrierTransportChargesSettlementId=' + convert(nvarchar,@CarrierTransportChargesSettlementId) + N',' +
                    N'DeliverBillId=' + convert(nvarchar,@DeliverBillId) + N',' +
                    N'TransportCharges=' + convert(nvarchar,@TransportCharges) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure InsertCarrierTransportPrice
@CarrierId bigint, 
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@DestCountry nvarchar(20),
@DestProvince nvarchar(20),
@DestCity nvarchar(20),
@PlanType nvarchar(10),
@StartTime datetime,
@EndTime datetime,
@TransportPrice numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into CarrierTransportPrice 
        (
            Id,
            CarrierId,
            StartCountry,
            StartProvince,
            StartCity,
            DestCountry,
            DestProvince,
            DestCity,
            PlanType,
            StartTime,
            EndTime,
            TransportPrice
        )
    values
        (
            @Id,
            @CarrierId,
            @StartCountry,
            @StartProvince,
            @StartCity,
            @DestCountry,
            @DestProvince,
            @DestCity,
            @PlanType,
            @StartTime,
            @EndTime,
            @TransportPrice
        )
    
    if @@rowcount = 0
    begin
        raiserror (150201,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150202)
    set @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                    N'StartCountry=' + @StartCountry + N',' +
                    N'StartProvince=' + @StartProvince + N',' +
                    N'StartCity=' + @StartCity + N',' +
                    N'DestCountry=' + @DestCountry + N',' +
                    N'DestProvince=' + @DestProvince + N',' +
                    N'DestCity=' + @DestCity + N',' +
                    N'PlanType=' + @PlanType + N',' +
                    N'StartTime=' + convert(nvarchar(10),@StartTime,120) + N',' +
                    N'EndTime=' + convert(nvarchar(10),@EndTime,120) + N',' +
                    N'TransportPrice=' + convert(nvarchar,@TransportPrice) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @Name
 * @CountryName
 * @ProvinceName
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure InsertCity
@Name nvarchar(20),
@CountryName nvarchar(20),
@ProvinceName nvarchar(20),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	if exists(select 1 from City where Name = @Name and CountryName = @CountryName and ProvinceName = @ProvinceName)
	begin
		raiserror (150046,18,1)
        return -1
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into City 
    (
        Id, 
        Name, 
        CountryName, 
        ProvinceName, 
        Remark
    ) 
    values 
    (
        @Id, 
        @Name, 
        @CountryName, 
        @ProvinceName, 
        @Remark
    )
    
    if @@rowcount=0
    begin
        raiserror (150047,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150048)
    select @OpParams = N'Name=' + @Name + N',' +
                       N'CountryName=' + @CountryName + N',' +
                       N'ProvinceName=' + @ProvinceName + N',' +
                       N'Remark=' + @Remark 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertContract
@Id bigint output,
@DispatchBillId bigint,
@OriginalContractNo nvarchar(20),
@CarNo nvarchar(20),
@TrailerNo nvarchar(10),
@CarType nvarchar(10),
@DriverName nvarchar(20),
@DriverLicenseNo nvarchar(20),
@DriverMobileTel nvarchar(20),
@DriverHomeTel nvarchar(20),
@CarrierId bigint,
@CarrierName nvarchar(50),
@GoodsName nvarchar(500),
@Packing nvarchar(50),
@StartPlace nvarchar(20),
@DestPlace nvarchar(200),
@ShipmentTime datetime,
@ArrivalTime datetime,
@TotalPackages int,
@TotalTunnages numeric(25,9),
@TotalPiles numeric(25,9),
@TotalTenThousands numeric(25,9),
@TotalTransportCharges numeric(25,9),
@PrepayTransportCharges numeric(25,9),
@ResidualTransportCharges numeric(25,9),
@IsPrestowage bit,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @ContractNo nvarchar(20)
declare @CreateOrganId bigint
declare @CreateOrganName nvarchar(50)
declare @ContractState nvarchar(10)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    select @CreateOrganId = OrganId, @CreateOrganName = OrganFullName from Account where Id = @OpStaffId 
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    exec GetNo N'Contract', @ContractNo output
    set @ContractNo = N'H' + @ContractNo 
    
    /**/
    set @ContractState = formatmessage(150241)
    
    /**/
    insert into Contract 
    (
        Id, 
        DispatchBillId,
        ContractNo,
        OriginalContractNo,
        CarNo,
        TrailerNo,
        CarType,
        DriverName,
        DriverLicenseNo,
        DriverMobileTel,
        DriverHomeTel,
        CarrierId,
        CarrierName,
        GoodsName,
        Packing,
        StartPlace,
        DestPlace,
        ShipmentTime,
        ArrivalTime,
        TotalPackages,
        TotalTunnages,
        TotalPiles,
        TotalTenThousands,
        TotalTransportCharges,
        PrepayTransportCharges,
        ResidualTransportCharges,
        CreatorId,
        CreatorName,
        CreateOrganId,
        CreateOrganName,
        CreateTime,
        OwnOrganId,
        OwnOrganName,
        ContractState,
        PrintState,
        IsPrestowage
    ) 
    values 
    (
        @Id, 
        @DispatchBillId,
        @ContractNo,
        @OriginalContractNo,
        @CarNo,
        @TrailerNo,
        @CarType,
        @DriverName,
        @DriverLicenseNo,
        @DriverMobileTel,
        @DriverHomeTel,
        @CarrierId,
        @CarrierName,
        @GoodsName,
        @Packing,
        @StartPlace,
        @DestPlace,
        @ShipmentTime,
        @ArrivalTime,
        @TotalPackages,
        @TotalTunnages,
        @TotalPiles,
        @TotalTenThousands,
        @TotalTransportCharges,
        @PrepayTransportCharges,
        @ResidualTransportCharges,
        @OpStaffId,
        @OpStaffName,
        @CreateOrganId,
        @CreateOrganName,
        getdate(),
        @CreateOrganId,
        @CreateOrganName,
        @ContractState,
        0,
        @IsPrestowage
    )
    if @@rowcount=0
    begin
        raiserror (150130,18,1)
        return -2
    end
            
    
    /**/
    select @OpName = formatmessage(150131)
    select @OpParams = N'CarNo=' + @CarNo + N',' +
                       N'TrailerNo=' + @TrailerNo + N',' +
                       N'CarType=' + @CarType + N',' +
                       N'DriverName=' + @DriverName + N',' +
                       N'DriverLicenseNo=' + @DriverLicenseNo + N',' +
                       N'DriverMobileTel=' + @DriverMobileTel + N',' +
                       N'DriverHomeTel=' + @DriverHomeTel + N',' +
                       N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                       N'CarrierName=' + @CarrierName + N',' +
                       N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) + N',' +
                       N'GoodsName=' + @GoodsName + N',' +
                       N'Packing=' + @Packing + N',' +
                       N'StartPlace=' + @StartPlace + N',' +
                       N'DestPlace=' + @DestPlace + N',' +
                       N'ShipmentTime=' + convert(nvarchar,@ShipmentTime,120) + N',' +
                       N'ArrivalTime=' + convert(nvarchar,@ArrivalTime,120) + N',' +
                       N'TotalPackages=' + convert(nvarchar,@TotalPackages) + N',' +
                       N'TotalTunnages=' + convert(nvarchar,@TotalTunnages) + N',' +
                       N'TotalPiles=' + convert(nvarchar,@TotalPiles) + N',' +
                       N'TotalTenThousands=' + convert(nvarchar,@TotalTenThousands) + N',' +
                       N'TotalTransportCharges=' + convert(nvarchar,@TotalTransportCharges) + N',' +
                       N'OriginalContractNo=' + @OriginalContractNo + N',' +
                       N'IsPrestowage=' + convert(nvarchar,@IsPrestowage)
                       
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertContractDeliverPlan
@ContractId bigint,
@PlanId bigint, 
@Packages int,
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@TransportChargeExpression nvarchar(100),
@TransportPriceExpression nvarchar(100),
@KM int,
@TransportPrice numeric(25,9),
@TransportCharges numeric(25,9),
@Remark nvarchar(500),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @DispatchBillId bigint
declare @DispatchBillTransportPrice numeric(25,9)
declare @DispatchBillTransportCharges numeric(25,9)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    exec GetId @OpStaffId, @Id output 
    insert into ContractDeliverPlan 
        (
            Id,
            ContractId,
            PlanId,
            Packages,
            Tunnages,
            Piles,
            TenThousands,
            TransportChargeExpression,
            TransportPriceExpression,
            KM,
            TransportPrice,
            TransportCharges,
            Remark
        )
    values
        (
            @Id,
            @ContractId,
            @PlanId,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @TransportChargeExpression,
            @TransportPriceExpression,
            @KM,
            @TransportPrice,
            @TransportCharges,
            @Remark
        )
    if @@rowcount = 0
    begin
        raiserror (150132,18,1)
        return -1
    end
    
    /**/
    select @DispatchBillId = DispatchBillId from Contract where Id = @ContractId 
    if @@rowcount = 0
    begin
        raiserror (150142,18,1)
        return -2
    end
    
    /**/
    select @DispatchBillTransportPrice = TransportPrice, @DispatchBillTransportCharges = TransportCharges from DispatchBillDeliverPlan where DispatchBillId = @DispatchBillId and PlanId = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150434,18,1)
        return -3
    end
    
    /**/
    update DispatchBillDeliverPlan set TransportPrice = @TransportPrice, TransportCharges = @TransportCharges where DispatchBillId = @DispatchBillId and PlanId = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150359,18,1)
        return -4
    end
    
    /**/
    update DispatchBill set TotalTransportCharges = TotalTransportCharges - @DispatchBillTransportCharges + @TransportCharges where Id = @DispatchBillId 
    if @@rowcount = 0
    begin
        raiserror (150315,18,1)
        return -5
    end
    
    
    /**/
    set @OpName = formatmessage(150133)
    set @OpParams = N'ContractId=' + convert(nvarchar,@ContractId) + N',' +
                    N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'TransportChargeExpression=' + @TransportChargeExpression + N',' +
                    N'TransportPriceExpression=' + @TransportPriceExpression + N',' +
                    N'KM=' + convert(nvarchar,@KM) + N',' +
                    N'TransportPrice=' + convert(nvarchar,@TransportPrice) + N',' +
                    N'TransportCharges=' + convert(nvarchar,@TransportCharges) + N',' +
                    N'Remark=' + @Remark
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -6
    end
    
    return 0
end
go


create procedure InsertContractReverse
@Id bigint output,
@ReverseAmount numeric(25,9),
@WithholdAmount numeric(25,9),
@FactpaymentAmount numeric(25,9),
@CreatorId bigint,
@CreatorName nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into ContractReverse 
    (
        Id, 
        ReverseAmount,
        WithholdAmount,
        FactpaymentAmount,
        CreatorId,
        CreatorName,
        CreateTime
    ) 
    values 
    (
        @Id, 
        @ReverseAmount,
        @WithholdAmount,
        @FactpaymentAmount,
        @CreatorId,
        @CreatorName,
        getdate()
    )
    if @@rowcount=0
    begin
        raiserror (150448,18,1)
        return -1
    end
            
    
    /**/
    select @OpName = formatmessage(150449)
    select @OpParams = N'ReverseAmount=' + convert(nvarchar,@ReverseAmount) + N',' +
                       N'WithholdAmount=' + convert(nvarchar,@WithholdAmount) + N',' +
                       N'FactpaymentAmount=' + convert(nvarchar,@FactpaymentAmount) + N',' +
                       N'CreatorId=' + convert(nvarchar,@CreatorId) + N',' +
                       N'CreatorName=' + @CreatorName
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure InsertContractReverseDetail
@ReverseId bigint,
@ContractId bigint,
@ReverseAmount numeric(25,9),
@WithholdAmount numeric(25,9),
@FactpaymentAmount numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into ContractReverseDetail 
    (
        Id, 
        ReverseId,
        ContractId,
        ReverseAmount,
        WithholdAmount,
        FactpaymentAmount
    ) 
    values 
    (
        @Id, 
        @ReverseId,
        @ContractId,
        @ReverseAmount,
        @WithholdAmount,
        @FactpaymentAmount
    )
    if @@rowcount=0
    begin
        raiserror (150450,18,1)
        return -1
    end
            
    
    /**/
    select @OpName = formatmessage(150451)
    select @OpParams = N'ReverseId=' + convert(nvarchar,@ReverseId) + N',' +
                       N'ContractId=' + convert(nvarchar,@ContractId) + N',' +
                       N'ReverseAmount=' + convert(nvarchar,@ReverseAmount) + N',' +
                       N'WithholdAmount=' + convert(nvarchar,@WithholdAmount) + N',' +
                       N'FactpaymentAmount=' + convert(nvarchar,@FactpaymentAmount) 
                       
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Name
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure InsertCountry
@Name nvarchar(20),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	if exists(select 1 from Country where Name = @Name)
	begin
		raiserror (150026,18,1)
        return -1
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into Country (Id, Name, Remark) values (@Id, @Name, @Remark)
    if @@rowcount=0
    begin
        raiserror (150027,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150028)
    select @OpParams = N'Name=' + @Name + N',' +
                       N'Remark=' + @Remark 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertCustomer
@Id bigint output, 
@Name nvarchar(50),
@FullName nvarchar(50),
@WarningStock int,
@StopStock int,
@SettlementExpression nvarchar(100),
@ValuationMode nvarchar(20),
@GrossWeightRate numeric(25,9),
@Remark nvarchar(500),
@OwnOrganId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganName nvarchar(50)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from Customer where Name = @Name)
    begin
        raiserror (150084,18,1)
        return -1
    end
    
    /**/
    select @OwnOrganName = Name from Organization where Id = @OwnOrganId 
    if @@rowcount = 0
    begin
        raiserror (150073,18,1)
        return -2
    end

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into Customer 
        (
            Id,
            Name,
            FullName,
            WarningStock,
            StopStock,
            SettlementExpression,
            ValuationMode,
            GrossWeightRate,
            Remark,
            OwnOrganId,
            OwnOrganName
        )
    values
        (
            @Id,
            @Name,
            @FullName,
            @WarningStock,
            @StopStock,
            @SettlementExpression,
            @ValuationMode,
            @GrossWeightRate,
            @Remark,
            @OwnOrganId,
            @OwnOrganName
        )
    
    if @@rowcount = 0
    begin
        raiserror (150085,18,1)
        return -3
    end
    
    /**/
    set @OpName = formatmessage(150086)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'Name=' + @Name + N',' +
                    N'FullName=' + @FullName + N',' +
                    N'WarningStock=' + convert(nvarchar,@WarningStock) + N',' +
                    N'StopStock=' + convert(nvarchar,@StopStock) + N',' +
                    N'SettlementExpression=' + @SettlementExpression + N',' +
                    N'ValuationMode=' + @ValuationMode + N',' +
                    N'GrossWeightRate=' + convert(nvarchar,@GrossWeightRate) + N',' +
                    N'Remark=' + @Remark + N',' +
                    N'OwnOrganId=' + convert(nvarchar,@OwnOrganId) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure InsertCustomerForceFeePrice
@CustomerId bigint, 
@StartTime datetime,
@EndTime datetime,
@LoadingForceFeePrice numeric(25,9),
@UnloadingForceFeePrice numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into CustomerForceFeePrice 
        (
            Id,
            CustomerId,
            StartTime,
            EndTime,
            LoadingForceFeePrice,
            UnloadingForceFeePrice
        )
    values
        (
            @Id,
            @CustomerId,
            @StartTime,
            @EndTime,
            @LoadingForceFeePrice,
            @UnloadingForceFeePrice
        )
    
    if @@rowcount = 0
    begin
        raiserror (150658,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150659)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'StartTime=' + convert(nvarchar(10),@StartTime,120) + N',' +
                    N'EndTime=' + convert(nvarchar(10),@EndTime,120) + N',' +
                    N'LoadingForceFeePrice=' + convert(nvarchar,@LoadingForceFeePrice) + N',' +
                    N'UnloadingForceFeePrice=' + convert(nvarchar,@UnloadingForceFeePrice)
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure InsertCustomerStorageAndForceFeeSettlement
@Id bigint output,
@StartTime datetime,
@EndTime datetime,
@InvoiceNo nvarchar(20),
@CustomerId bigint,
@CustomerName nvarchar(50),
@InvoiceType nvarchar(10),
@InvoiceAmount numeric(25,9),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @CreateOrganId bigint
declare @CreateOrganName nvarchar(50)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    if exists(select * from CustomerStorageAndForceFeeSettlement where CustomerId = @CustomerId and convert(nvarchar(10),StartTime,120) < convert(nvarchar(10),@EndTime,120) and convert(nvarchar(10),EndTime,120) > convert(nvarchar(10),@StartTime,120))
    begin
        raiserror (150586,18,1)
        return -1
    end
    
    /**/
    select @CreateOrganId = OrganId, @CreateOrganName = OrganFullName from Account where Id = @OpStaffId 
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -2
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into CustomerStorageAndForceFeeSettlement 
    (
        Id, 
        StartTime,
        EndTime,
        InvoiceNo,
        CustomerId,
        CustomerName,
        InvoiceType,
        InvoiceAmount,
        Remark,
        CreatorId,
        CreatorName,
        CreateOrganId,
        CreateOrganName,
        CreateTime,
        OwnOrganId,
        OwnOrganName
    ) 
    values 
    (
        @Id, 
        @StartTime,
        @EndTime,
        @InvoiceNo,
        @CustomerId,
        @CustomerName,
        @InvoiceType,
        @InvoiceAmount,
        @Remark,
        @OpStaffId,
        @OpStaffName,
        @CreateOrganId,
        @CreateOrganName,
        getdate(),
        @CreateOrganId,
        @CreateOrganName
    )
    if @@rowcount=0
    begin
        raiserror (150584,18,1)
        return -3
    end
            
    
    /**/
    select @OpName = formatmessage(150585)
    select @OpParams = N'StartTime=' + convert(nvarchar,@StartTime,120) + N',' +
                       N'EndTime=' + convert(nvarchar,@EndTime,120) + N',' +
                       N'InvoiceNo=' + @InvoiceNo + N',' +
                       N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'InvoiceType=' + @InvoiceType + N',' +
                       N'InvoiceAmount=' + convert(nvarchar,@InvoiceAmount) + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure InsertCustomerStorageFeePrice
@CustomerId bigint, 
@StartTime datetime,
@EndTime datetime,
@StorageFeePrice numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into CustomerStorageFeePrice 
        (
            Id,
            CustomerId,
            StartTime,
            EndTime,
            StorageFeePrice
        )
    values
        (
            @Id,
            @CustomerId,
            @StartTime,
            @EndTime,
            @StorageFeePrice
        )
    
    if @@rowcount = 0
    begin
        raiserror (150660,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150661)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'StartTime=' + convert(nvarchar(10),@StartTime,120) + N',' +
                    N'EndTime=' + convert(nvarchar(10),@EndTime,120) + N',' +
                    N'StorageFeePrice=' + convert(nvarchar,@StorageFeePrice)
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure InsertCustomerTransportChargesSettlement
@Id bigint output,
@InvoiceNo nvarchar(20),
@CustomerId bigint,
@CustomerName nvarchar(50),
@InvoiceType nvarchar(10),
@InvoiceAmount numeric(25,9),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @CreateOrganId bigint
declare @CreateOrganName nvarchar(50)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    select @CreateOrganId = OrganId, @CreateOrganName = OrganFullName from Account where Id = @OpStaffId 
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into CustomerTransportChargesSettlement 
    (
        Id, 
        InvoiceNo,
        CustomerId,
        CustomerName,
        InvoiceType,
        InvoiceAmount,
        Remark,
        CreatorId,
        CreatorName,
        CreateOrganId,
        CreateOrganName,
        CreateTime,
        OwnOrganId,
        OwnOrganName
    ) 
    values 
    (
        @Id, 
        @InvoiceNo,
        @CustomerId,
        @CustomerName,
        @InvoiceType,
        @InvoiceAmount,
        @Remark,
        @OpStaffId,
        @OpStaffName,
        @CreateOrganId,
        @CreateOrganName,
        getdate(),
        @CreateOrganId,
        @CreateOrganName
    )
    if @@rowcount=0
    begin
        raiserror (150483,18,1)
        return -2
    end
            
    
    /**/
    select @OpName = formatmessage(150484)
    select @OpParams = N'InvoiceNo=' + @InvoiceNo + N',' +
                       N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'InvoiceType=' + @InvoiceType + N',' +
                       N'InvoiceAmount=' + convert(nvarchar,@InvoiceAmount) + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertCustomerTransportChargesSettlementDetail
@CustomerTransportChargesSettlementId bigint,
@DeliverBillId bigint, 
@TransportPrice numeric(25,9),
@TransportCharges numeric(25,9),
@CarpoolFee numeric(25,9),
@RiverCrossingCharges numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @DeliverBillNo nvarchar(20)
declare @OldCustomerTransportChargesSettlementId bigint
declare @OldInvoiceNo nvarchar(20)
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    insert into CustomerTransportChargesSettlementDetail 
        (
            Id,
            CustomerTransportChargesSettlementId,
            DeliverBillId,
            TransportPrice,
            TransportCharges,
            CarpoolFee,
            RiverCrossingCharges
        )
    values
        (
            @Id,
            @CustomerTransportChargesSettlementId,
            @DeliverBillId,
            @TransportPrice,
            @TransportCharges,
            @CarpoolFee,
            @RiverCrossingCharges
        )
        
    if @@rowcount = 0
    begin
        raiserror (150486,18,1)
        return -1
    end
    
    /**/
    select @DeliverBillNo = BillNo, @OldCustomerTransportChargesSettlementId = CustomerTransportChargesSettlementId from DeliverBill where Id = @DeliverBillId 
    if @@rowcount = 0
    begin
        raiserror (150415,18,1)
        return -2
    end
    
    if @OldCustomerTransportChargesSettlementId is not null and @OldCustomerTransportChargesSettlementId > 0
    begin
        select @OldInvoiceNo = InvoiceNo from CustomerTransportChargesSettlement where Id = @OldCustomerTransportChargesSettlementId 
        if @@rowcount = 0
        begin
            raiserror (150488,18,1)
            return -3
        end
        else
        begin
            set @ErrorText = formatmessage(150489, @DeliverBillNo, @OldInvoiceNo)
            raiserror (@ErrorText,18,1)
            return -4
        end
    end
    
    update DeliverBill set CustomerTransportChargesSettlementId = @CustomerTransportChargesSettlementId where Id = @DeliverBillId 
    if @@rowcount = 0
    begin
        raiserror (150485,18,1)
        return -5
    end
    
    
    /**/
    set @OpName = formatmessage(150487)
    set @OpParams = N'CustomerTransportChargesSettlementId=' + convert(nvarchar,@CustomerTransportChargesSettlementId) + N',' +
                    N'DeliverBillId=' + convert(nvarchar,@DeliverBillId) + N',' +
                    N'TransportPrice=' + convert(nvarchar,@TransportPrice) + N',' +
                    N'TransportCharges=' + convert(nvarchar,@TransportCharges) + N',' +
                    N'CarpoolFee=' + convert(nvarchar,@CarpoolFee) + N',' +
                    N'RiverCrossingCharges=' + convert(nvarchar,@RiverCrossingCharges)
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -6
    end
    
    return 0
end
go


create procedure InsertCustomerTransportPrice
@CustomerId bigint, 
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@DestCountry nvarchar(20),
@DestProvince nvarchar(20),
@DestCity nvarchar(20),
@MinTunnagesOrPiles numeric(25,9),
@MaxTunnagesOrPiles numeric(25,9),
@StartTime datetime,
@EndTime datetime,
@CarType nvarchar(10),
@TransportPrice numeric(25,9),
@RiverCrossingCharges numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into CustomerTransportPrice 
        (
            Id,
            CustomerId,
            StartCountry,
            StartProvince,
            StartCity,
            DestCountry,
            DestProvince,
            DestCity,
            MinTunnagesOrPiles,
            MaxTunnagesOrPiles,
            StartTime,
            EndTime,
            CarType,
            TransportPrice,
            RiverCrossingCharges
        )
    values
        (
            @Id,
            @CustomerId,
            @StartCountry,
            @StartProvince,
            @StartCity,
            @DestCountry,
            @DestProvince,
            @DestCity,
            @MinTunnagesOrPiles,
            @MaxTunnagesOrPiles,
            @StartTime,
            @EndTime,
            @CarType,
            @TransportPrice,
            @RiverCrossingCharges
        )
    
    if @@rowcount = 0
    begin
        raiserror (150174,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150175)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'StartCountry=' + @StartCountry + N',' +
                    N'StartProvince=' + @StartProvince + N',' +
                    N'StartCity=' + @StartCity + N',' +
                    N'DestCountry=' + @DestCountry + N',' +
                    N'DestProvince=' + @DestProvince + N',' +
                    N'DestCity=' + @DestCity + N',' +
                    N'MinTunnagesOrPiles=' + convert(nvarchar,@MinTunnagesOrPiles) + N',' +
                    N'MaxTunnagesOrPiles=' + convert(nvarchar,@MaxTunnagesOrPiles) + N',' +
                    N'StartTime=' + convert(nvarchar(10),@StartTime,120) + N',' +
                    N'EndTime=' + convert(nvarchar(10),@EndTime,120) + N',' +
                    N'CarType=' + @CarType + N',' +
                    N'TransportPrice=' + convert(nvarchar,@TransportPrice) + N',' +
                    N'RiverCrossingCharges=' + convert(nvarchar,@RiverCrossingCharges)
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure InsertDeliverBillCarrierTransportPrice
@DeliverBillId bigint,
@TransportPrice numeric(25,9),
@TransportCharges numeric(25,9),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Id bigint
declare @CreateOrganId bigint
declare @CreateOrganName nvarchar(50)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    if exists(select * from DeliverBillCarrierTransportPrice where DeliverBillId = @DeliverBillId)
    begin
        update DeliverBillCarrierTransportPrice set 
            TransportPrice = @TransportPrice, 
            TransportCharges = @TransportCharges,
            Remark = @Remark 
        where 
            DeliverBillId = @DeliverBillId 
            
        if @@rowcount=0
        begin
            raiserror (150694,18,1)
            return -1
        end
    end
    else
    begin
        /**/
        select @CreateOrganId = OrganId, @CreateOrganName = OrganFullName from Account where Id = @OpStaffId 
        if @@rowcount = 0
        begin
            raiserror (150004,18,1)
            return -2
        end
    
        /**/
        exec GetId @OpStaffId, @Id output 
    
        /**/
        insert into DeliverBillCarrierTransportPrice 
        (
            Id, 
            DeliverBillId,
            TransportPrice,
            TransportCharges,
            Remark,
            CreatorId,
            CreatorName,
            CreateOrganId,
            CreateOrganName,
            CreateTime 
        ) 
        values 
        (
            @Id, 
            @DeliverBillId,
            @TransportPrice,
            @TransportCharges,
            @Remark,
            @OpStaffId,
            @OpStaffName,
            @CreateOrganId,
            @CreateOrganName,
            getdate()
        )
        
        if @@rowcount=0
        begin
            raiserror (150695,18,1)
            return -3
        end
    end
    
    
    /**/
    select @OpName = formatmessage(150696)
    select @OpParams = N'DeliverBillId=' + convert(nvarchar,@DeliverBillId) + N',' +
                       N'TransportPrice=' + convert(nvarchar,@TransportPrice) + N',' +
                       N'TransportCharges=' + convert(nvarchar,@TransportCharges) + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure InsertDeliverBillCustomerTransportPrice
@DeliverBillId bigint,
@TransportPrice numeric(25,9),
@TransportCharges numeric(25,9),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Id bigint
declare @CreateOrganId bigint
declare @CreateOrganName nvarchar(50)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    if exists(select * from DeliverBillCustomerTransportPrice where DeliverBillId = @DeliverBillId)
    begin
        update DeliverBillCustomerTransportPrice set 
            TransportPrice = @TransportPrice, 
            TransportCharges = @TransportCharges,
            Remark = @Remark 
        where 
            DeliverBillId = @DeliverBillId 
            
        if @@rowcount=0
        begin
            raiserror (150509,18,1)
            return -1
        end
    end
    else
    begin
        /**/
        select @CreateOrganId = OrganId, @CreateOrganName = OrganFullName from Account where Id = @OpStaffId 
        if @@rowcount = 0
        begin
            raiserror (150004,18,1)
            return -2
        end
    
        /**/
        exec GetId @OpStaffId, @Id output 
    
        /**/
        insert into DeliverBillCustomerTransportPrice 
        (
            Id, 
            DeliverBillId,
            TransportPrice,
            TransportCharges,
            Remark,
            CreatorId,
            CreatorName,
            CreateOrganId,
            CreateOrganName,
            CreateTime 
        ) 
        values 
        (
            @Id, 
            @DeliverBillId,
            @TransportPrice,
            @TransportCharges,
            @Remark,
            @OpStaffId,
            @OpStaffName,
            @CreateOrganId,
            @CreateOrganName,
            getdate()
        )
        
        if @@rowcount=0
        begin
            raiserror (150510,18,1)
            return -3
        end
    end
    
    
    /**/
    select @OpName = formatmessage(150511)
    select @OpParams = N'DeliverBillId=' + convert(nvarchar,@DeliverBillId) + N',' +
                       N'TransportPrice=' + convert(nvarchar,@TransportPrice) + N',' +
                       N'TransportCharges=' + convert(nvarchar,@TransportCharges) + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure InsertDeliverPlan
@Id bigint output,
@PlanType nvarchar(10),
@CustomerId bigint,
@ShipmentNo nvarchar(20),
@DeliveryNo nvarchar(20),
@DeliverType nvarchar(10),
@ReceiverName nvarchar(50),
@ReceiverCountry nvarchar(20),
@ReceiverProvince nvarchar(20),
@ReceiverCity nvarchar(20),
@ReceiverAddress nvarchar(50),
@ReceiverContact nvarchar(20),
@ReceiverContactTel nvarchar(20),
@OrderNo nvarchar(20),
@ReceiveType nvarchar(10),
@CarNo nvarchar(20),
@TrailerNo nvarchar(10),
@DriverName nvarchar(20),
@DriverLicenseNo nvarchar(20),
@DriverMobileTel nvarchar(20),
@DriverHomeTel nvarchar(20),
@Warehouse nvarchar(20),
@ArrivalTime nvarchar(10),
@PayerId bigint,
@PayerName nvarchar(50),
@IsConsigning bit,
@ConsignedDeliveryNo nvarchar(20),
@IsInstalment bit,
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@Remark nvarchar(500),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @PlanNo nvarchar(20)
declare @CustomerName nvarchar(50)
declare @SettlementExpression nvarchar(100)
declare @OwnOrganId bigint
declare @OwnOrganName nvarchar(50)
declare @CarrierId bigint
declare @CarrierName nvarchar(50)
declare @CreatorName nvarchar(20)
declare @CreateOrganId bigint
declare @CreateOrganName nvarchar(50)
declare @ReceiverId bigint
declare @BusinessType nvarchar(10)
declare @PaymentType nvarchar(10)
declare @PlanState nvarchar(10)
declare @DriverId bigint
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
    begin
        if not exists(select * from Stock where Warehouse = @Warehouse and DeliveryNo = @ConsignedDeliveryNo and Packages > 0)
        begin
		    raiserror (150236,18,1)
            return -2
        end
    end

    /**/
    select @CustomerName = Name, @SettlementExpression = SettlementExpression, @OwnOrganId = OwnOrganId, @OwnOrganName = OwnOrganName from Customer where Id = @CustomerId 
    if @@rowcount = 0
    begin
        raiserror (150082,18,1)
        return -3
    end
    
    /**/
    if @CarNo is not null and @CarNo <> ''
    begin
        select @CarrierId = CarrierId from CarrierCar where CarNo = @CarNo 
        if @@rowcount = 0
        begin
            if @DriverName is not null and @DriverName <> ''
            begin
                /**/
                set @CarrierName = @DriverName 
                set @BusinessType = formatmessage(150341)
                set @PaymentType = formatmessage(150239)
            
                begin try
                    exec InsertCarrier @CarrierId output, @CarrierName, @BusinessType, @PaymentType, @OpStaffId, @OpStaffName 
                    exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, 0, @OpStaffId, @OpStaffName 
                    exec InsertCarrierDriver @CarrierId, @CarNo, @DriverName, @DriverLicenseNo, @DriverMobileTel, @DriverHomeTel, @OpStaffId, @OpStaffName
                end try
                begin catch
                    select @ErrorText = formatmessage(150199) + error_message()
                    raiserror (@ErrorText,18,1)
                    return -4
                end catch
            end
        end
        else
        begin
            select @CarrierName = Name from Carrier where Id = @CarrierId 
            if @@rowcount = 0
            begin
                raiserror (150205,18,1)
                return -5
            end
            
            if exists(select * from CarrierCar where CarrierId = @CarrierId and CarNo = @CarNo)
            begin
                /**/
                update CarrierCar set TrailerNo = @TrailerNo where CarrierId = @CarrierId and CarNo = @CarNo 
                if @@rowcount = 0
                begin
                    raiserror (150316,18,1)
                    return -6
                end
            end
            else
            begin
                /**/
                begin try
                    exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, 0, @OpStaffId, @OpStaffName 
                end try
                begin catch
                    select @ErrorText = formatmessage(150203) + error_message()
                    raiserror (@ErrorText,18,1)
                    return -7
                end catch
            end
            
            select @DriverId = Id from CarrierDriver where CarrierId = @CarrierId and LicenseNo = @DriverLicenseNo 
            if @@rowcount = 0
            begin
                if @DriverName is not null and @DriverName <> ''
                begin
                    /**/
                    begin try
                        exec InsertCarrierDriver @CarrierId, @CarNo, @DriverName, @DriverLicenseNo, @DriverMobileTel, @DriverHomeTel, @OpStaffId, @OpStaffName
                    end try
                    begin catch
                        select @ErrorText = formatmessage(150216) + error_message()
                        raiserror (@ErrorText,18,1)
                        return -8
                    end catch
                end
            end
            else
            begin
                if @DriverName is not null and @DriverName <> ''
                begin
                    /**/
                    update CarrierDriver set 
                        CarNo = case when charindex(@CarNo, CarNo) > 0 then CarNo else (case when CarNo is null or CarNo = '' then @CarNo else CarNo + ',' + @CarNo end) end,
                        Name = @DriverName, 
                        MobileTel = @DriverMobileTel, 
                        HomeTel = @DriverHomeTel 
                    where 
                        Id = @DriverId 
                    if @@rowcount = 0
                    begin
                        raiserror (150299,18,1)
                        return -9
                    end
                end
            end
        end
    end
    
    /**/
    if @PayerId is null or @PayerId = 0
    begin
        select @PayerId = Id from Customer where Name = @PayerName
        if @@rowcount = 0
        begin
            /**/
            begin try
                declare @ValuationMode nvarchar(20)
                set @ValuationMode = formatmessage(150620)
                
                exec InsertCustomer 
                    @PayerId output, 
                    @PayerName, 
                    @PayerName, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    @SettlementExpression, 
                    @ValuationMode,
                    1,
                    N'', 
                    @OwnOrganId, 
                    @OpStaffId, 
                    @OpStaffName 
            end try
            begin catch
                select @ErrorText = formatmessage(150240) + error_message()
                raiserror (@ErrorText,18,1)
                return -10
            end catch
        end
    end
    
    /**/
    select @CreatorName = StaffName, @CreateOrganId = OrganId, @CreateOrganName = OrganFullName from Account where Id = @OpStaffId 
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -11
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    exec GetNo N'DeliverPlan', @PlanNo output
    set @PlanNo = N'J' + @PlanNo 
    
    /**/
    set @PlanState = formatmessage(150241)
    
    /**/
    insert into DeliverPlan 
    (
        Id, 
        PlanNo,
        PlanType,
        CustomerId,
        CustomerName,
        ShipmentNo,
        DeliveryNo,
        DeliverType,
        ReceiverName,
        ReceiverCountry,
        ReceiverProvince,
        ReceiverCity,
        ReceiverAddress,
        ReceiverContact,
        ReceiverContactTel,
        OrderNo,
        ReceiveType,
        CarNo,
        TrailerNo,
        DriverName,
        DriverLicenseNo,
        DriverMobileTel,
        DriverHomeTel,
        CarrierId,
        CarrierName,
        Warehouse,
        ArrivalTime,
        PayerId,
        PayerName,
        IsConsigning,
        ConsignedDeliveryNo,
        IsInstalment,
        StartCountry,
        StartProvince,
        StartCity,
        Remark,
        CreatorId,
        CreatorName,
        CreateOrganId,
        CreateOrganName,
        CreateTime,
        OwnOrganId,
        OwnOrganName,
        PlanState
    ) 
    values 
    (
        @Id, 
        @PlanNo,
        @PlanType,
        @CustomerId,
        @CustomerName,
        @ShipmentNo,
        @DeliveryNo,
        @DeliverType,
        @ReceiverName,
        @ReceiverCountry,
        @ReceiverProvince,
        @ReceiverCity,
        @ReceiverAddress,
        @ReceiverContact,
        @ReceiverContactTel,
        @OrderNo,
        @ReceiveType,
        @CarNo,
        @TrailerNo,
        @DriverName,
        @DriverLicenseNo,
        @DriverMobileTel,
        @DriverHomeTel,
        @CarrierId,
        @CarrierName,
        @Warehouse,
        @ArrivalTime,
        @PayerId,
        @PayerName,
        @IsConsigning,
        @ConsignedDeliveryNo,
        @IsInstalment,
        @StartCountry,
        @StartProvince,
        @StartCity,
        @Remark,
        @OpStaffId,
        @CreatorName,
        @CreateOrganId,
        @CreateOrganName,
        @CreateTime,
        @OwnOrganId,
        @OwnOrganName,
        @PlanState 
    )
    
    if @@rowcount=0
    begin
        raiserror (150244,18,1)
        return -12
    end
    
    /**/
    if exists(select * from Receiver where Name = @ReceiverName)
    begin
        update Receiver set 
            Country = @ReceiverCountry, 
            Province = @ReceiverProvince, 
            City = @ReceiverCity, 
            Address = @ReceiverAddress, 
            Contact = @ReceiverContact, 
            ContactTel = @ReceiverContactTel 
        where 
            Name = @ReceiverName 
            
        if @@rowcount = 0
        begin
            raiserror (150245,18,1)
            return -13
        end
    end
    else
    begin
        exec GetId @OpStaffId, @ReceiverId output 
    
        insert into Receiver 
            (
                Id,
                Name,
                Country,
                Province,
                City,
                Address,
                Contact,
                ContactTel
            )
        values 
            (
                @ReceiverId,
                @ReceiverName,
                @ReceiverCountry,
                @ReceiverProvince,
                @ReceiverCity,
                @ReceiverAddress,
                @ReceiverContact,
                @ReceiverContactTel
            )
            
        if @@rowcount = 0
        begin
            raiserror (150246,18,1)
            return -14
        end
    end
    

    /**/
    select @OpName = formatmessage(150247)
    select @OpParams = N'PlanType=' + @PlanType + N',' +
                       N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'ShipmentNo=' + @ShipmentNo + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'DeliverType=' + @DeliverType + N',' +
                       N'ReceiverName=' + @ReceiverName + N',' +
                       N'ReceiverCountry=' + @ReceiverCountry + N',' +
                       N'ReceiverProvince=' + @ReceiverProvince + N',' +
                       N'ReceiverCity=' + @ReceiverCity + N',' +
                       N'ReceiverAddress=' + @ReceiverAddress + N',' +
                       N'ReceiverContact=' + @ReceiverContact + N',' +
                       N'ReceiverContactTel=' + @ReceiverContactTel + N',' +
                       N'OrderNo=' + @OrderNo + N',' +
                       N'ReceiveType=' + @ReceiveType + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'TrailerNo=' + @TrailerNo + N',' +
                       N'DriverName=' + @DriverName + N',' +
                       N'DriverLicenseNo=' + @DriverLicenseNo + N',' +
                       N'DriverMobileTel=' + @DriverMobileTel + N',' +
                       N'DriverHomeTel=' + @DriverHomeTel + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'ArrivalTime=' + @ArrivalTime + N',' +
                       N'PayerId=' + convert(nvarchar,@PayerId) + N',' +
                       N'PayerName=' + @PayerName + N',' +
                       N'IsConsigning=' + convert(nvarchar,@IsConsigning) + N',' +
                       N'ConsignedDeliveryNo=' + @ConsignedDeliveryNo + N',' +
                       N'IsInstalment=' + convert(nvarchar,@IsInstalment) + N',' +
                       N'StartCountry=' + @StartCountry + N',' +
                       N'StartProvince=' + @StartProvince + N',' +
                       N'StartCity=' + @StartCity + N',' +
                       N'Remark=' + @Remark + N',' +
                       N'CreateTime=' + convert(nvarchar,@CreateTime,120)
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -15
    end
    
    return 0
end
go


create procedure InsertDeliverPlanGoods
@PlanId bigint, 
@GoodsId bigint,
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Location nvarchar(10),
@Packages int,
@PieceWeight numeric(25,9),
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @ConsignedDeliveryNo nvarchar(20)
declare @CustomerId bigint
declare @PlanType nvarchar(10)
declare @GoodsName nvarchar(50)
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @GoodsNo nvarchar(20)
declare @Brand nvarchar(20)
declare @SpecModel nvarchar(50)
declare @GWeight nvarchar(20)
declare @Grade nvarchar(10)
declare @Warehouse nvarchar(20)
declare @ErrText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @GoodsNo = GoodsNo, 
        @GoodsName = Name, 
        @TypeId = TypeId, 
        @TypeName = TypeName, 
        @TypeFullPath = TypeFullPath, 
        @TypeFullName = TypeFullName, 
        @Brand = Brand, 
        @SpecModel = SpecModel, 
        @GWeight = GWeight, 
        @Grade = Grade 
    from 
        Goods 
    where 
        Id = @GoodsId 
    if @@rowcount = 0
    begin
        raiserror (150248,18,1)
        return -1
    end
    
    /**/
    select 
        @CustomerId = CustomerId, 
        @PlanType = PlanType, 
        @Warehouse = Warehouse, 
        @ConsignedDeliveryNo = ConsignedDeliveryNo 
    from 
        DeliverPlan 
    where 
        Id = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150251,18,1)
        return -2
    end
    
    /**/
    if @PlanType = formatmessage(150256) or @PlanType = formatmessage(150257)
    begin
        begin try
            exec CheckStock 
            @CustomerId, 
            @PlanType,
            @GoodsId, 
            @GoodsNo, 
            @BatchNo, 
            @Packing, 
            @Warehouse, 
            @Location, 
            @ProductionDate, 
            @EnterWarehouseBillId, 
            @ConsignedDeliveryNo,
            @Packages,
            @Piles,
            @OpStaffId, 
            @OpStaffName 
        end try
        begin catch
            select @ErrText = error_message()
            raiserror (@ErrText,18,1)
            return -3
        end catch
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into DeliverPlanGoods 
        (
            Id,
            PlanId,
            GoodsId,
            GoodsName,
            TypeId,
            TypeName,
            TypeFullPath,
            TypeFullName,
            GoodsNo,
            Brand,
            SpecModel,
            GWeight,
            Grade,
            PieceWeight,
            Packing,
            BatchNo,
            Location,
            Packages,
            Tunnages,
            Piles,
            TenThousands,
            ProductionDate,
            EnterWarehouseBillId 
        )
    values
        (
            @Id,
            @PlanId,
            @GoodsId,
            @GoodsName,
            @TypeId,
            @TypeName,
            @TypeFullPath,
            @TypeFullName,
            @GoodsNo,
            @Brand,
            @SpecModel,
            @GWeight,
            @Grade,
            @PieceWeight,
            @Packing,
            @BatchNo,
            @Location,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @ProductionDate,
            @EnterWarehouseBillId
        )
    
    if @@rowcount = 0
    begin
        raiserror (150249,18,1)
        return -4
    end
    
    /**/
    set @OpName = formatmessage(150250)
    set @OpParams = N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Location=' + @Location + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'PieceWeight=' + convert(nvarchar,@PieceWeight) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId)
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -5
    end
    
    return 0
end
go


create procedure InsertDispatchBill
@Id bigint output,
@CarNo nvarchar(20),
@TrailerNo nvarchar(10),
@CarType nvarchar(10),
@DriverName nvarchar(20),
@DriverLicenseNo nvarchar(20),
@DriverMobileTel nvarchar(20),
@DriverHomeTel nvarchar(20),
@CarrierId bigint,
@CarrierName nvarchar(50),
@CarryingCapacity int,
@BusinessType nvarchar(10),
@PaymentType nvarchar(10),
@TotalPackages int,
@TotalTunnages numeric(25,9),
@TotalPiles numeric(25,9),
@TotalTenThousands numeric(25,9),
@TotalTransportCharges numeric(25,9),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @DispatchBillNo nvarchar(20)
declare @AccountType nvarchar(20)
declare @CreatorName nvarchar(20)
declare @CreateOrganId bigint
declare @CreateOrganName nvarchar(50)
declare @OwnOrganId bigint
declare @OwnOrganName nvarchar(50)
declare @BillState nvarchar(10)
declare @DriverId bigint
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    select @AccountType = AccountType, @CreatorName = StaffName, @CreateOrganId = OrganId, @CreateOrganName = OrganFullName from Account where Id = @OpStaffId 
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end
    /**/
    if @AccountType = formatmessage(150163)
    begin
        select @OwnOrganId = OwnOrganId, @OwnOrganName = OwnOrganName from Customer where Id = @CreateOrganId 
        if @@rowcount = 0
        begin
            raiserror (150082,18,1)
            return -2
        end
    end
    else
    begin
        set @OwnOrganId = @CreateOrganId
        set @OwnOrganName = @CreateOrganName
    end
    
    /**/
    if @CarrierId is null or @CarrierId = 0 or not exists(select * from Carrier where Id = @CarrierId)
    begin
        if @CarrierName is not null and @CarrierName <> ''
        begin
            /**/
            begin try
                exec InsertCarrier @CarrierId output, @CarrierName, @BusinessType, @PaymentType, @OpStaffId, @OpStaffName 
                exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, @CarryingCapacity, @OpStaffId, @OpStaffName 
                if @DriverName is not null and @DriverName <> ''
                begin
                    exec InsertCarrierDriver @CarrierId, @CarNo, @DriverName, @DriverLicenseNo, @DriverMobileTel, @DriverHomeTel, @OpStaffId, @OpStaffName
                end
            end try
            begin catch
                select @ErrorText = formatmessage(150199) + error_message()
                raiserror (@ErrorText,18,1)
                return -3
            end catch
        end
    end
    else
    begin
        /**/
        if exists(select * from Carrier where Name = @CarrierName and Id <> @CarrierId)
        begin
            raiserror (150497,18,1)
            return -4
        end
        
        update Carrier set Name = @CarrierName, BusinessType = @BusinessType, PaymentType = @PaymentType where Id = @CarrierId 
        if @@rowcount = 0
        begin
            raiserror (150207,18,1)
            return -5
        end
        
        if exists(select * from CarrierCar where CarrierId = @CarrierId and CarNo = @CarNo)
        begin
            /**/
            update CarrierCar set TrailerNo = @TrailerNo, CarryingCapacity = @CarryingCapacity where CarrierId = @CarrierId and CarNo = @CarNo 
            if @@rowcount = 0
            begin
                raiserror (150316,18,1)
                return -6
            end
        end
        else
        begin
            /**/
            begin try
                exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, @CarryingCapacity, @OpStaffId, @OpStaffName 
            end try
            begin catch
                select @ErrorText = formatmessage(150203) + error_message()
                raiserror (@ErrorText,18,1)
                return -7
            end catch
        end
    
        select @DriverId = Id from CarrierDriver where CarrierId = @CarrierId and LicenseNo = @DriverLicenseNo 
        if @@rowcount = 0
        begin
            if @DriverName is not null and @DriverName <> ''
            begin
                /**/
                begin try
                    exec InsertCarrierDriver @CarrierId, @CarNo, @DriverName, @DriverLicenseNo, @DriverMobileTel, @DriverHomeTel, @OpStaffId, @OpStaffName
                end try
                begin catch
                    select @ErrorText = formatmessage(150216) + error_message()
                    raiserror (@ErrorText,18,1)
                    return -8
                end catch
            end
        end
        else
        begin
            if @DriverName is not null and @DriverName <> ''
            begin
                /**/
                update CarrierDriver set 
                    CarNo = case when charindex(@CarNo, CarNo) > 0 then CarNo else (case when CarNo is null or CarNo = '' then @CarNo else CarNo + ',' + @CarNo end) end,
                    Name = @DriverName, 
                    MobileTel = @DriverMobileTel, 
                    HomeTel = @DriverHomeTel 
                where 
                    Id = @DriverId 
                if @@rowcount = 0
                begin
                    raiserror (150299,18,1)
                    return -9
                end
            end
        end
    end
    
    /**/
    if @Id = 0
    begin
        /**/
        select @Id = Id from DispatchBill where CarNo = @CarNo and BillState = formatmessage(150241)
        if @@rowcount = 0
        begin
            /**/
            exec GetId @OpStaffId, @Id output 
    
            /**/
            exec GetNo N'DispatchBill', @DispatchBillNo output
            set @DispatchBillNo = N'D' + @DispatchBillNo 
    
            /**/
            set @BillState = formatmessage(150241)
    
            /**/
            insert into DispatchBill 
            (
                Id, 
                DispatchBillNo,
                CarNo,
                TrailerNo,
                CarType,
                DriverName,
                DriverLicenseNo,
                DriverMobileTel,
                DriverHomeTel,
                CarrierId,
                CarrierName,
                TotalPackages,
                TotalTunnages,
                TotalPiles,
                TotalTenThousands,
                TotalTransportCharges,
                CreatorId,
                CreatorName,
                CreateOrganId,
                CreateOrganName,
                CreateTime,
                OwnOrganId,
                OwnOrganName,
                BillState
            ) 
            values 
            (
                @Id, 
                @DispatchBillNo,
                @CarNo,
                @TrailerNo,
                @CarType,
                isnull(@DriverName,''),
                isnull(@DriverLicenseNo,''),
                isnull(@DriverMobileTel,''),
                isnull(@DriverHomeTel,''),
                isnull(@CarrierId,0),
                isnull(@CarrierName,''),
                @TotalPackages,
                @TotalTunnages,
                @TotalPiles,
                @TotalTenThousands,
                @TotalTransportCharges,
                @OpStaffId,
                @CreatorName,
                @CreateOrganId,
                @CreateOrganName,
                @CreateTime,
                @OwnOrganId,
                @OwnOrganName,
                @BillState 
            )
    
            if @@rowcount=0
            begin
                raiserror (150314,18,1)
                return -10
            end
        end
        else 
        begin
            /**/
            update DispatchBill set 
                TrailerNo = @TrailerNo,
                CarType = @CarType,
                DriverName = isnull(@DriverName,''),
                DriverLicenseNo = isnull(@DriverLicenseNo,''),
                DriverMobileTel = isnull(@DriverMobileTel,''),
                DriverHomeTel = isnull(@DriverHomeTel,''),
                CarrierId = isnull(@CarrierId,0),
                CarrierName = isnull(@CarrierName,''),
                TotalPackages = TotalPackages + @TotalPackages,
                TotalTunnages = TotalTunnages + @TotalTunnages,
                TotalPiles = TotalPiles + @TotalPiles,
                TotalTenThousands = TotalTenThousands + @TotalTenThousands,
                TotalTransportCharges = TotalTransportCharges + @TotalTransportCharges,
                CreateTime = @CreateTime
            where 
                Id = @Id 
            
            if @@rowcount=0
            begin
                raiserror (150315,18,1)
                return -11
            end
        end
    end
    else
    begin
        /**/
        update DispatchBill set 
            CarNo = @CarNo,
            TrailerNo = @TrailerNo,
            CarType = @CarType,
            DriverName = isnull(@DriverName,''),
            DriverLicenseNo = isnull(@DriverLicenseNo,''),
            DriverMobileTel = isnull(@DriverMobileTel,''),
            DriverHomeTel = isnull(@DriverHomeTel,''),
            CarrierId = isnull(@CarrierId,0),
            CarrierName = isnull(@CarrierName,''),
            TotalPackages = TotalPackages + @TotalPackages,
            TotalTunnages = TotalTunnages + @TotalTunnages,
            TotalPiles = TotalPiles + @TotalPiles,
            TotalTenThousands = TotalTenThousands + @TotalTenThousands,
            TotalTransportCharges = TotalTransportCharges + @TotalTransportCharges,
            CreateTime = @CreateTime
        where 
            Id = @Id 
            
        if @@rowcount=0
        begin
            raiserror (150315,18,1)
            return -12
        end
    end
    
    /**/
    select @OpName = formatmessage(150247)
    select @OpParams = N'CarNo=' + @CarNo + N',' +
                       N'TrailerNo=' + @TrailerNo + N',' +
                       N'CarType=' + @CarType + N',' +
                       N'DriverName=' + @DriverName + N',' +
                       N'DriverLicenseNo=' + @DriverLicenseNo + N',' +
                       N'DriverMobileTel=' + @DriverMobileTel + N',' +
                       N'DriverHomeTel=' + @DriverHomeTel + N',' +
                       N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                       N'CarrierName=' + @CarrierName + N',' +
                       N'CarryingCapacity=' + convert(nvarchar,@CarryingCapacity) + N',' +
                       N'BusinessType=' + @BusinessType + N',' +
                       N'PaymentType=' + @PaymentType + N',' +
                       N'TotalPackages=' + convert(nvarchar,@TotalPackages) + N',' +
                       N'TotalTunnages=' + convert(nvarchar,@TotalTunnages) + N',' +
                       N'TotalPiles=' + convert(nvarchar,@TotalPiles) + N',' +
                       N'TotalTenThousands=' + convert(nvarchar,@TotalTenThousands) + N',' +
                       N'TotalTransportCharges=' + convert(nvarchar,@TotalTransportCharges) + N',' +
                       N'CreateTime=' + convert(nvarchar,@CreateTime,120)
                       
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -13
    end
    
    return 0
end
go


create procedure InsertDispatchBillDeliverPlan
@DispatchBillId bigint,
@PlanId bigint, 
@Packages int,
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@TransportChargeExpression nvarchar(100),
@TransportPriceExpression nvarchar(100),
@KM int,
@TransportPrice numeric(25,9),
@TransportCharges numeric(25,9),
@ReceiveType nvarchar(10),
@Remark nvarchar(500),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @PlanType nvarchar(10)
declare @ReceiverName nvarchar(50)
declare @ReceiverCountry nvarchar(20)
declare @ReceiverProvince nvarchar(20)
declare @ReceiverCity nvarchar(20)
declare @StartCountry nvarchar(20)
declare @StartProvince nvarchar(20)
declare @StartCity nvarchar(20)
declare @CreateTime datetime
declare @EndTime datetime
declare @OldReceiveType nvarchar(10)
declare @CarrierId bigint 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from DispatchBillDeliverPlan where DispatchBillId = @DispatchBillId and PlanId = @PlanId)
    begin
        raiserror (150356,18,1)
        return -1
    end
    
    /**/
    select 
        @PlanType = PlanType, 
        @ReceiverName = ReceiverName, 
        @ReceiverCountry = ReceiverCountry, 
        @ReceiverProvince = ReceiverProvince, 
        @ReceiverCity = ReceiverCity, 
        @StartCountry = StartCountry, 
        @StartProvince = StartProvince, 
        @StartCity = StartCity,
        @CreateTime = CreateTime,
        @OldReceiveType = ReceiveType
    from 
        DeliverPlan 
    where 
        Id = @PlanId 
        
    if @@rowcount = 0
    begin
        raiserror (150251,18,1)
        return -2
    end
    
    /**/
    select 
        @CarrierId = CarrierId 
    from 
        DispatchBill 
    where 
        Id = @DispatchBillId 
    if @@rowcount = 0
    begin
        raiserror (150319,18,1)
        return -3
    end
    
    /**/
    if @TransportPrice is not null and @TransportPrice > 0
    begin
        if exists (
            select 
                * 
            from 
                CarrierTransportPrice 
            where 
                CarrierId = @CarrierId and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @ReceiverCountry and 
                DestProvince = @ReceiverProvince and 
                DestCity = @ReceiverCity and 
                PlanType = @PlanType and 
                convert(nvarchar(10),StartTime,120) <= convert(nvarchar(10),@CreateTime,120) and 
                convert(nvarchar(10),EndTime,120) >= convert(nvarchar(10),@CreateTime,120)
        )
        begin
            if not exists(select * from Carrier where Id = @CarrierId and BusinessType = formatmessage(150237))
            begin
                update CarrierTransportPrice set 
                    TransportPrice = @TransportPrice 
                where 
                    CarrierId = @CarrierId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @ReceiverCountry and 
                    DestProvince = @ReceiverProvince and 
                    DestCity = @ReceiverCity and 
                    PlanType = @PlanType and 
                    convert(nvarchar(10),StartTime,120) <= convert(nvarchar(10),@CreateTime,120) and 
                    convert(nvarchar(10),EndTime,120) >= convert(nvarchar(10),@CreateTime,120)
                    
                if @@rowcount = 0
                begin
                    raiserror (150339,18,1)
                    return -4
                end
            end
        end
        else
        begin
            select 
                @EndTime = min(StartTime)
            from 
                CarrierTransportPrice 
            where 
                CarrierId = @CarrierId and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @ReceiverCountry and 
                DestProvince = @ReceiverProvince and 
                DestCity = @ReceiverCity and 
                PlanType = @PlanType and 
                convert(nvarchar(10),StartTime,120) > convert(nvarchar(10),@CreateTime,120) 
                
            if @EndTime is null
            begin
                set @EndTime = cast('9999-12-31 23:59:59' as datetime)
            end
            else
            begin
                set @EndTime = cast(convert(nvarchar(10),dateadd(day,-1,@EndTime),120) + ' 23:59:59' as datetime)
            end
        
            exec GetId @OpStaffId, @Id output 
            insert into CarrierTransportPrice 
                (
                    Id,
                    CarrierId,
                    StartCountry,
                    StartProvince,
                    StartCity,
                    DestCountry,
                    DestProvince,
                    DestCity,
                    PlanType,
                    StartTime,
                    EndTime,
                    TransportPrice
                )
            values
                (
                    @Id,
                    @CarrierId,
                    @StartCountry,
                    @StartProvince,
                    @StartCity,
                    @ReceiverCountry,
                    @ReceiverProvince,
                    @ReceiverCity,
                    @PlanType,
                    cast(convert(nvarchar(10),@CreateTime,120) + ' 00:00:00' as datetime),
                    @EndTime,
                    @TransportPrice
                )
            if @@rowcount = 0
            begin
                raiserror (150201,18,1)
                return -5
            end
        end
    end
    
    /**/
    if (@TransportChargeExpression is not null and @TransportChargeExpression <> '') and (@TransportPriceExpression is not null and @TransportPriceExpression <> '')
    begin
        if exists (select * from CarrierSettlementExpression where CarrierId = @CarrierId and PlanType = @PlanType)
        begin
            update CarrierSettlementExpression set 
                TransportChargeExpression = @TransportChargeExpression, 
                TransportPriceExpression = @TransportPriceExpression 
            where 
                CarrierId = @CarrierId and 
                PlanType = @PlanType 
            if @@rowcount = 0
            begin
                raiserror (150340,18,1)
                return -6
            end
        end
        else
        begin
            exec GetId @OpStaffId, @Id output 
            insert into CarrierSettlementExpression 
                (
                    Id,
                    CarrierId,
                    PlanType,
                    TransportChargeExpression,
                    TransportPriceExpression
                )
            values
                (
                    @Id,
                    @CarrierId,
                    @PlanType,
                    @TransportChargeExpression,
                    @TransportPriceExpression
                )
            if @@rowcount = 0
            begin
                raiserror (150335,18,1)
                return -7
            end
        end
    end
    
    /**/
    if @KM is not null and @KM > 0
    begin
        if exists(
            select 
                * 
            from 
                ReceiverDistance 
            where 
                ReceiverName = @ReceiverName and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity
        )
        begin
            update ReceiverDistance set 
                KM = @KM 
            where 
                ReceiverName = @ReceiverName and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity
            if @@rowcount = 0
            begin
                raiserror (150331,18,1)
                return -8
            end
        end
        else
        begin
            exec GetId @OpStaffId, @Id output 
            insert into ReceiverDistance 
                (
                    Id, 
                    ReceiverName,
                    StartCountry, 
                    StartProvince, 
                    StartCity, 
                    KM
                ) 
            values 
                (
                    @Id, 
                    @ReceiverName,
                    @StartCountry, 
                    @StartProvince, 
                    @StartCity, 
                    @KM 
                )
            if @@rowcount = 0
            begin
                raiserror (150332,18,1)
                return -9
            end
        end
    end
    
    /**/
    if @OldReceiveType = formatmessage(150347)
    begin
        if @ReceiveType is not null and @ReceiveType <> '' and @ReceiveType <> @OldReceiveType
        begin
            update DeliverPlan set ReceiveType = @ReceiveType where Id = @PlanId 
            if @@rowcount = 0
            begin
                raiserror (150264,18,1)
                return -10
            end
        end
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    insert into DispatchBillDeliverPlan 
        (
            Id,
            DispatchBillId,
            PlanId,
            Packages,
            Tunnages,
            Piles,
            TenThousands,
            TransportChargeExpression,
            TransportPriceExpression,
            KM,
            TransportPrice,
            TransportCharges,
            Remark
        )
    values
        (
            @Id,
            @DispatchBillId,
            @PlanId,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @TransportChargeExpression,
            @TransportPriceExpression,
            @KM,
            @TransportPrice,
            @TransportCharges,
            @Remark
        )
    if @@rowcount = 0
    begin
        raiserror (150317,18,1)
        return -11
    end
    
    /**/
    set @OpName = formatmessage(150318)
    set @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) + N',' +
                    N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'TransportChargeExpression=' + @TransportChargeExpression + N',' +
                    N'TransportPriceExpression=' + @TransportPriceExpression + N',' +
                    N'KM=' + convert(nvarchar,@KM) + N',' +
                    N'TransportPrice=' + convert(nvarchar,@TransportPrice) + N',' +
                    N'TransportCharges=' + convert(nvarchar,@TransportCharges) + N',' +
                    N'ReceiveType=' + @ReceiveType + N',' +
                    N'Remark=' + @Remark
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -12
    end
    
    return 0
end
go


create procedure InsertDispatchBillGoods
@DispatchBillId bigint,
@PlanId bigint, 
@GoodsId bigint,
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Location nvarchar(10),
@Packages int,
@PieceWeight numeric(25,9),
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @PlanPackages int 
declare @PlanTunnages numeric(25,9)
declare @PlanPiles numeric(25,9)
declare @PlanTenThousands numeric(25,9)
declare @DispatchPackages int 
declare @DispatchTunnages numeric(25,9)
declare @DispatchPiles numeric(25,9)
declare @DispatchTenThousands numeric(25,9)
declare @Id bigint
declare @GoodsName nvarchar(50)
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @GoodsNo nvarchar(20)
declare @Brand nvarchar(20)
declare @SpecModel nvarchar(50)
declare @GWeight nvarchar(20)
declare @Grade nvarchar(10)
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @GoodsNo = GoodsNo, 
        @GoodsName = GoodsName, 
        @TypeId = TypeId, 
        @TypeName = TypeName, 
        @TypeFullPath = TypeFullPath, 
        @TypeFullName = TypeFullName, 
        @Brand = Brand, 
        @SpecModel = SpecModel, 
        @GWeight = GWeight, 
        @Grade = Grade, 
        @PlanPackages = Packages, 
        @PlanTunnages = Tunnages, 
        @PlanPiles = Piles, 
        @PlanTenThousands = TenThousands 
    from 
        DeliverPlanGoods 
    where 
        PlanId = @PlanId and 
        GoodsId = @GoodsId and 
        BatchNo = @BatchNo and 
        Packing = @Packing and 
        Location = @Location and 
        ProductionDate = @ProductionDate and 
        EnterWarehouseBillId = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150321,18,1)
        return -1
    end
    
    /**/
    select 
        @DispatchPackages = isnull(sum(Packages),0) + @Packages,
        @DispatchTunnages = isnull(sum(Tunnages),0.0) + @Tunnages,
        @DispatchPiles = isnull(sum(Piles),0.0) + @Piles,
        @DispatchTenThousands = isnull(sum(TenThousands),0.0) + @TenThousands 
    from 
        DispatchBillGoods 
    where 
        PlanId = @PlanId and 
        GoodsId = @GoodsId and 
        BatchNo = @BatchNo and 
        Packing = @Packing and 
        Location = @Location and 
        ProductionDate = @ProductionDate and 
        EnterWarehouseBillId = @EnterWarehouseBillId
        
    if (@PlanPackages > 0 and @DispatchPackages > @PlanPackages) or 
       (@PlanPackages < 0 and @DispatchPackages < @PlanPackages) or 
       (@PlanTunnages > 0 and @DispatchTunnages > @PlanTunnages) or 
       (@PlanTunnages < 0 and @DispatchTunnages < @PlanTunnages) or 
       (@PlanPiles > 0 and @DispatchPiles > @PlanPiles) or 
       (@PlanPiles < 0 and @DispatchPiles < @PlanPiles) or 
       (@PlanTenThousands > 0 and @DispatchTenThousands > @PlanTenThousands) or 
       (@PlanTenThousands < 0 and @DispatchTenThousands < @PlanTenThousands)
    begin
        set @ErrorText = @GoodsNo + @GoodsName + formatmessage(150365)
        raiserror (@ErrorText,18,1)
        return -2
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into DispatchBillGoods 
        (
            Id,
            DispatchBillId,
            PlanId,
            GoodsId,
            GoodsName,
            TypeId,
            TypeName,
            TypeFullPath,
            TypeFullName,
            GoodsNo,
            Brand,
            SpecModel,
            GWeight,
            Grade,
            PieceWeight,
            Packing,
            BatchNo,
            Location,
            Packages,
            Tunnages,
            Piles,
            TenThousands,
            ProductionDate,
            EnterWarehouseBillId 
        )
    values
        (
            @Id,
            @DispatchBillId,
            @PlanId,
            @GoodsId,
            @GoodsName,
            @TypeId,
            @TypeName,
            @TypeFullPath,
            @TypeFullName,
            @GoodsNo,
            @Brand,
            @SpecModel,
            @GWeight,
            @Grade,
            @PieceWeight,
            @Packing,
            @BatchNo,
            @Location,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @ProductionDate,
            @EnterWarehouseBillId 
        )
    if @@rowcount = 0
    begin
        raiserror (150322,18,1)
        return -3
    end
    
    /**/
    set @OpName = formatmessage(150323)
    set @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) + N',' +
                    N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'Location=' + @Location + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'PieceWeight=' + convert(nvarchar,@PieceWeight) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure InsertEnterWarehouseBill
@Id bigint output,
@PlanId bigint = null,
@CustomerId bigint,
@DeliveryNo nvarchar(20),
@EnterType nvarchar(10),
@IsConsigning bit,
@Warehouse nvarchar(20),
@ForceFee numeric(25,9),
@HasDrayage bit,
@Remark nvarchar(200),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @BillNo nvarchar(20)
declare @CustomerName nvarchar(50)
declare @CreatorName nvarchar(50)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    select @CustomerName = Name from Customer where Id = @CustomerId 
    if @@rowcount = 0
    begin
        raiserror (150082,18,1)
        return -1
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    exec GetNo N'EnterWarehouseBill', @BillNo output 
    if @EnterType = formatmessage(150276)
    begin
        set @BillNo = N'H' + @BillNo 
    end
    else
    begin
        set @BillNo = N'R' + @BillNo 
    end
    
    /**/
    insert into EnterWarehouseBill 
    (
        Id, 
        BillNo,
        PlanId,
        CustomerId,
        CustomerName,
        DeliveryNo,
        EnterType,
        IsConsigning,
        Warehouse,
        ForceFee,
        HasDrayage,
        Remark,
        CreatorId,
        CreatorName,
        CreateTime 
    ) 
    values 
    (
        @Id, 
        @BillNo,
        @PlanId,
        @CustomerId,
        @CustomerName,
        @DeliveryNo,
        @EnterType,
        @IsConsigning,
        @Warehouse,
        @ForceFee,
        @HasDrayage,
        @Remark,
        @OpStaffId,
        @OpStaffName,
        @CreateTime 
    )
    
    if @@rowcount=0
    begin
        raiserror (150277,18,1)
        return -2
    end
    

    /**/
    select @OpName = formatmessage(150278)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                       N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'EnterType=' + @EnterType + N',' +
                       N'IsConsigning=' + convert(nvarchar,@IsConsigning) + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'ForceFee=' + convert(nvarchar,@ForceFee) + N',' +
                       N'HasDrayage=' + convert(nvarchar,@HasDrayage) + N',' +
                       N'Remark=' + @Remark + N',' +
                       N'CreateTime=' + convert(nvarchar,@CreateTime,120)
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertGoods 
@Id bigint output,
@Name nvarchar(50),
@TypeId bigint,
@GoodsNo nvarchar(20),
@SpecModel nvarchar(100),
@GWeight nvarchar(20),
@Grade nvarchar(10),
@Brand nvarchar(20),
@PieceWeight nvarchar(20),
@Packing nvarchar(10),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @TmpGoodsNo nvarchar(20)
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from Goods where GoodsNo = @GoodsNo)
    begin
        raiserror (150186,18,1)
        return -1
    end

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    if @TypeId = 0
    begin
        set @TmpGoodsNo = @GoodsNo
        
        while 1 = 1
        begin
            select @TypeId = TypeId from Goods where GoodsNo like @TmpGoodsNo + '%'
            if @@rowcount = 0
            begin
                set @TmpGoodsNo = left(@TmpGoodsNo, len(@TmpGoodsNo) - 1)
                if @TmpGoodsNo is null or @TmpGoodsNo = ''
                begin
                    break
                end
            end
            else
            begin
                break
            end
        end
    end
    
    if @TypeId > 0
    begin
        select @TypeName = Name, @TypeFullPath = FullPath, @TypeFullName = FullName from GoodsType where Id = @TypeId 
        if @@rowcount = 0
        begin
            raiserror (150178,18,1)
            return -2
        end
    end
    else
    begin
        set @TypeName = ''
        set @TypeFullPath = ''
        set @TypeFullName = ''
    end
    
    
    /**/
    insert into Goods 
        (
            Id, 
            Name, 
            TypeId,
            TypeName,
            TypeFullPath,
            TypeFullName,
            GoodsNo,
            SpecModel,
            GWeight,
            Grade,
            Brand,
            PieceWeight,
            Packing,
            Remark
        ) 
    values 
        (
            @Id, 
            @Name, 
            @TypeId,
            @TypeName,
            @TypeFullPath,
            @TypeFullName,
            @GoodsNo,
            @SpecModel,
            @GWeight,
            @Grade,
            @Brand,
            @PieceWeight,
            @Packing,
            @Remark
        )
    
    if @@rowcount=0
    begin
        raiserror (150179,18,1)
        return -3
    end

    /**/
    select @OpName = formatmessage(150180)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'TypeId=' + convert(nvarchar,@TypeId) + N',' +
                       N'Name=' + @Name + N',' +
                       N'GoodsNo=' + @GoodsNo + N',' +
                       N'SpecModel=' + @SpecModel + N',' +
                       N'GWeight=' + @GWeight + N',' +
                       N'Grade=' + @Grade + N',' +
                       N'Brand=' + @Brand + N',' +
                       N'PieceWeight=' + @PieceWeight + N',' +
                       N'Packing=' + @Packing + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure UpdateGoods 
@Id bigint,
@Name nvarchar(50),
@TypeId bigint,
@GoodsNo nvarchar(20),
@SpecModel nvarchar(100),
@GWeight nvarchar(20),
@Grade nvarchar(10),
@Brand nvarchar(20),
@PieceWeight nvarchar(20),
@Packing nvarchar(10),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @TmpGoodsNo nvarchar(20)
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from Goods where GoodsNo = @GoodsNo and Id <> @Id)
    begin
        raiserror (150186,18,1)
        return -1
    end

    /**/
    if @TypeId = 0
    begin
        set @TmpGoodsNo = @GoodsNo
        
        while 1 = 1
        begin
            select @TypeId = TypeId from Goods where GoodsNo like @TmpGoodsNo + '%'
            if @@rowcount = 0
            begin
                set @TmpGoodsNo = left(@TmpGoodsNo, len(@TmpGoodsNo) - 1)
                if @TmpGoodsNo is null or @TmpGoodsNo = ''
                begin
                    break
                end
            end
            else
            begin
                break
            end
        end
    end
    
    if @TypeId > 0
    begin
        select @TypeName = Name, @TypeFullPath = FullPath, @TypeFullName = FullName from GoodsType where Id = @TypeId 
        if @@rowcount = 0
        begin
            raiserror (150178,18,1)
            return -2
        end
    end
    else
    begin
        set @TypeName = ''
        set @TypeFullPath = ''
        set @TypeFullName = ''
    end
    
    /**/
    update Goods set 
        Name = @Name, 
        TypeId = @TypeId,
        TypeName = @TypeName,
        TypeFullPath = @TypeFullPath,
        TypeFullName = @TypeFullName,
        GoodsNo = @GoodsNo,
        SpecModel = @SpecModel,
        GWeight = @GWeight,
        Grade = @Grade,
        Brand = @Brand,
        PieceWeight = @PieceWeight,
        Packing = @Packing,
        Remark = @Remark 
    where 
        Id = @Id
    
    if @@rowcount=0
    begin
        raiserror (150182,18,1)
        return -3
    end

    /**/
    select @OpName = formatmessage(150183)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'TypeId=' + convert(nvarchar,@TypeId) + N',' +
                       N'Name=' + @Name + N',' +
                       N'GoodsNo=' + @GoodsNo + N',' +
                       N'SpecModel=' + @SpecModel + N',' +
                       N'GWeight=' + @GWeight + N',' +
                       N'Grade=' + @Grade + N',' +
                       N'Brand=' + @Brand + N',' +
                       N'PieceWeight=' + @PieceWeight + N',' +
                       N'Packing=' + @Packing + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure InsertEnterWarehouseBillGoods
@Id bigint,
@CustomerId bigint,
@CustomerName nvarchar(50),
@GoodsId bigint,
@GoodsNo nvarchar(20),
@GoodsName nvarchar(50),
@Brand nvarchar(20),
@SpecModel nvarchar(50),
@GWeight nvarchar(20),
@Grade nvarchar(10),
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Warehouse nvarchar(20),
@Location nvarchar(10),
@Packages int,
@PieceWeight numeric(25,9),
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@ProductionDate nvarchar(10),
@ShipmentBillGoodsIds nvarchar(500),
@EnterWarehouseBillId bigint, 
@DeliveryNo nvarchar(20),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @EnterType nvarchar(20)
declare @StockId bigint
declare @ErrText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if @GoodsId is null or @GoodsId = 0
    begin
        if not exists(select * from Goods where GoodsNo = @GoodsNo)
        begin
            begin try
                exec InsertGoods @GoodsId output, @GoodsName, 0, @GoodsNo, @SpecModel, @GWeight, @Grade, @Brand, @PieceWeight, @Packing, N'', @OpStaffId, @OpStaffName 
            end try
            begin catch
                select @ErrText = formatmessage(150179) + error_message()
                raiserror (@ErrText,18,1)
                return -1
            end catch
        
            /**/
            select @TypeId = TypeId, @TypeName = TypeName, @TypeFullPath = TypeFullPath, @TypeFullName = TypeFullName from Goods where Id = @GoodsId 
            if @@rowcount = 0
            begin
                raiserror (150248,18,1)
                return -2
            end
        end
        else
        begin
            /**/
            select @GoodsId = Id, @TypeId = TypeId, @TypeName = TypeName, @TypeFullPath = TypeFullPath, @TypeFullName = TypeFullName from Goods where GoodsNo = @GoodsNo
            if @@rowcount = 0
            begin
                raiserror (150248,18,1)
                return -3
            end
    
            begin try
                exec UpdateGoods @GoodsId, @GoodsName, @TypeId, @GoodsNo, @SpecModel, @GWeight, @Grade, @Brand, @PieceWeight, @Packing, N'', @OpStaffId, @OpStaffName 
            end try
            begin catch
                select @ErrText = formatmessage(150182) + error_message()
                raiserror (@ErrText,18,1)
                return -4
            end catch
        end
    end
    else
    begin
        /**/
        select @TypeId = TypeId, @TypeName = TypeName, @TypeFullPath = TypeFullPath, @TypeFullName = TypeFullName from Goods where Id = @GoodsId 
        if @@rowcount = 0
        begin
            raiserror (150248,18,1)
            return -5
        end
    
        begin try
            exec UpdateGoods @GoodsId, @GoodsName, @TypeId, @GoodsNo, @SpecModel, @GWeight, @Grade, @Brand, @PieceWeight, @Packing, N'', @OpStaffId, @OpStaffName 
        end try
        begin catch
            select @ErrText = formatmessage(150182) + error_message()
            raiserror (@ErrText,18,1)
            return -6
        end catch
    end
    
    /**/
    select @EnterType = EnterType from EnterWarehouseBill where Id = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150281,18,1)
        return -7
    end
    
    /**/
    if @EnterType = formatmessage(150629)
    begin
        /*@IdStock*/
        update Stock set 
            Tunnages = 0,
            OriginalEnterWarehouseBillId = EnterWarehouseBillId,
            EnterWarehouseBillId = @EnterWarehouseBillId
        where 
            Id = @Id
        
        if @@rowcount = 0
        begin
            raiserror (150622,18,1)
            return -8
        end
    end
    else
    begin
        /**/
        exec GetId @OpStaffId, @StockId output 
        insert into Stock 
            (
                Id,
                CustomerId,
                CustomerName,
                GoodsId,
                GoodsNo,
                GoodsName,
                Brand,
                SpecModel,
                GWeight,
                Grade,
                PieceWeight,
                Packing,
                BatchNo,
                Warehouse,
                Location,
                Packages,
                Tunnages,
                Piles,
                TenThousands,
                ProductionDate,
                EnterWarehouseBillId,
                DeliveryNo
            )
        values 
            (
                @StockId,
                @CustomerId,
                @CustomerName,
                @GoodsId,
                @GoodsNo,
                @GoodsName,
                @Brand,
                @SpecModel,
                @GWeight,
                @Grade,
                @PieceWeight,
                @Packing,
                @BatchNo,
                @Warehouse,
                @Location,
                @Packages,
                @Tunnages,
                @Piles,
                @TenThousands,
                @ProductionDate,
                @EnterWarehouseBillId,
                @DeliveryNo
            )
        
        if @@rowcount = 0
        begin
            raiserror (150282,18,1)
            return -9
        end
        
        /**/
        while convert(nvarchar(10),@CreateTime,120) < convert(nvarchar(10),getdate(),120)
        begin
            insert into StockDaily
                (
                    StockId,
                    Packages,
                    Tunnages,
                    Piles,
                    TenThousands,
                    StorageFee,
                    CreateTime
                )
            values
                (
                    @StockId,
                    @Packages,
                    @Tunnages,
                    @Piles,
                    @TenThousands,
                    0,
                    cast(convert(nvarchar(10),@CreateTime,120) + ' 23:59:59' as datetime)
                )
            if @@rowcount = 0
            begin
                raiserror (150648,18,1)
                return -10
            end
            
            set @CreateTime = dateadd(day,1,@CreateTime)
        end
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    insert into EnterWarehouseBillGoods 
        (
            Id,
            EnterWarehouseBillId,
            GoodsId,
            GoodsName,
            TypeId,
            TypeName,
            TypeFullPath,
            TypeFullName,
            GoodsNo,
            Brand,
            SpecModel,
            GWeight,
            Grade,
            PieceWeight,
            Packing,
            BatchNo,
            Location,
            Packages,
            Tunnages,
            Piles,
            TenThousands,
            ProductionDate,
            ShipmentBillGoodsIds 
        )
    values
        (
            @Id,
            @EnterWarehouseBillId,
            @GoodsId,
            @GoodsName,
            @TypeId,
            @TypeName,
            @TypeFullPath,
            @TypeFullName,
            @GoodsNo,
            @Brand,
            @SpecModel,
            @GWeight,
            @Grade,
            @PieceWeight,
            @Packing,
            @BatchNo,
            @Location,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @ProductionDate,
            @ShipmentBillGoodsIds 
        )
    
    if @@rowcount = 0
    begin
        raiserror (150279,18,1)
        return -11
    end
    
    /**/
    set @OpName = formatmessage(150280)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId) + N',' +
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                    N'GoodsNo=' + @GoodsNo + N',' +
                    N'GoodsName=' + @GoodsName + N',' +
                    N'Brand=' + @Brand + N',' +
                    N'SpecModel=' + @SpecModel + N',' +
                    N'GWeight=' + @GWeight + N',' +
                    N'Grade=' + @Grade + N',' +
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'Location=' + @Location + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'PieceWeight=' + convert(nvarchar,@PieceWeight) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'ShipmentBillGoodsIds=' + @ShipmentBillGoodsIds + N',' +
                    N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'CustomerName=' + @CustomerName + N',' +
                    N'Warehouse=' + @Warehouse + N',' +
                    N'DeliveryNo=' + @DeliveryNo
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -12
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Name
 * @ParentId
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure InsertGoodsType 
@Name nvarchar(50),
@ParentId bigint,
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @FullPath nvarchar(500)
declare @FullName nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    if exists(select 1 from GoodsType where Name = @Name and ParentId = @ParentId)
    begin
        raiserror (150094,18,1)
        return -1
    end

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    if @ParentId = 0
    begin
        set @FullPath = N''
        set @FullName = N''
    end
    else
    begin
        select @FullPath = FullPath, @FullName = FullName from GoodsType where Id = @ParentId
        if @@rowcount = 0 
        begin
            set @FullPath = N''
            set @FullName = N''
        end
    end
    
    /**/
    if @FullPath = N''
        set @FullPath = convert(nvarchar,@Id) + N'\'
    else
        set @FullPath = @FullPath + convert(nvarchar,@Id) + N'\'
    
    if @FullName = N''
        set @FullName = @Name 
    else
        set @FullName = @FullName + N'\' + @Name
    
   
    /**/
    insert into GoodsType (Id, ParentId, Name, FullPath, FullName, Remark) values (@Id, @ParentId, @Name, @FullPath, @FullName, @Remark)
    
    if @@rowcount=0
    begin
        raiserror (150134,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150135)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'ParentId=' + convert(nvarchar,@ParentId) + N',' +
                       N'Name=' + @Name + N',' +
                       N'FullPath=' + @FullPath + N',' +
                       N'FullName=' + @FullName + N',' +
                       N'Remark=' + @Remark 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @GroupId
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure InsertGroupPermission
@GroupId bigint,
@FuncId bigint,
@AllowOpen bit,
@AllowNew bit,
@AllowModify bit,
@AllowDelete bit,
@AllowCancel bit,
@AllowDetail bit,
@AllowSearch bit,
@AllowSubmit bit,
@AllowApprove bit,
@AllowDispatch bit,
@AllowExport bit,
@AllowImport bit,
@AllowPrint bit,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	exec GetId @OpStaffId, @Id output
    
    /**/
    insert into SysGroupPermission 
        (
            Id,
            GroupId, 
            FuncId, 
            AllowOpen,
            AllowNew,
            AllowModify,
            AllowDelete,
            AllowCancel,
            AllowDetail,
            AllowSearch,
            AllowSubmit,
            AllowApprove,
            AllowDispatch,
            AllowExport,
            AllowImport,
            AllowPrint
        ) 
    values 
        (
            @Id,
            @GroupId, 
            @FuncId, 
            @AllowOpen,
            @AllowNew,
            @AllowModify,
            @AllowDelete,
            @AllowCancel,
            @AllowDetail,
            @AllowSearch,
            @AllowSubmit,
            @AllowApprove,
            @AllowDispatch,
            @AllowExport,
            @AllowImport,
            @AllowPrint
        )
    
    if @@rowcount=0
    begin
        raiserror (150114,18,1)
        return -1
    end

    /**/
	select @OpName = formatmessage(150115)
    set @OpParams = N'GroupId=' + convert(nvarchar,@GroupId) + N',' +
                    N'FuncId=' + convert(nvarchar,@FuncId) + N',' +
                    N'AllowOpen=' + convert(nvarchar,@AllowOpen) + N',' +
                    N'AllowNew=' + convert(nvarchar,@AllowNew) + N',' +
                    N'AllowModify=' + convert(nvarchar,@AllowModify) + N',' +
                    N'AllowDelete=' + convert(nvarchar,@AllowDelete) + N',' +
                    N'AllowCancel=' + convert(nvarchar,@AllowCancel) + N',' +
                    N'AllowDetail=' + convert(nvarchar,@AllowDetail) + N',' +
                    N'AllowSearch=' + convert(nvarchar,@AllowSearch) + N',' +
                    N'AllowSubmit=' + convert(nvarchar,@AllowSubmit) + N',' +
                    N'AllowApprove=' + convert(nvarchar,@AllowApprove) + N',' +
                    N'AllowDispatch=' + convert(nvarchar,@AllowDispatch) + N',' +
                    N'AllowExport=' + convert(nvarchar,@AllowExport) + N',' +
                    N'AllowImport=' + convert(nvarchar,@AllowImport) + N',' +
                    N'AllowPrint=' + convert(nvarchar,@AllowPrint) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure InsertLoginLog 
@OrganId bigint,
@OrganName nvarchar(50),
@StaffId bigint,
@StaffName nvarchar(50),
@HostIP nvarchar(30),
@HostName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into LoginLog 
        (
            Id,
            OrganId,
            OrganName,
            StaffId,
            StaffName,
            LoginTime,
            HostIP,
            HostName
        )
    values
        (
            @Id,
            @OrganId,
            @OrganName,
            @StaffId,
            @StaffName,
            getdate(),
            @HostIP,
            @HostName
        )
        
    if @@rowcount = 0
    begin
        raiserror (150168,18,1)
        return -1
    end

    return 0
end
go


create procedure InsertMoveWarehouseBill
@Id bigint output,
@CustomerId bigint,
@Warehouse nvarchar(20),
@ConsignedDeliveryNo nvarchar(20),
@Remark nvarchar(200),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @BillNo nvarchar(20)
declare @CustomerName nvarchar(50)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    select @CustomerName = Name from Customer where Id = @CustomerId 
    if @@rowcount = 0
    begin
        raiserror (150082,18,1)
        return -1
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    exec GetNo N'MoveWarehouseBill', @BillNo output 
    set @BillNo = N'Y' + @BillNo 
    
    /**/
    insert into MoveWarehouseBill 
    (
        Id, 
        BillNo,
        CustomerId,
        CustomerName,
        Warehouse,
        ConsignedDeliveryNo,
        Remark,
        CreatorId,
        CreatorName,
        CreateTime 
    ) 
    values 
    (
        @Id, 
        @BillNo,
        @CustomerId,
        @CustomerName,
        @Warehouse,
        @ConsignedDeliveryNo,
        @Remark,
        @OpStaffId,
        @OpStaffName,
        getdate() 
    )
    
    if @@rowcount=0
    begin
        raiserror (150464,18,1)
        return -2
    end
    

    /**/
    select @OpName = formatmessage(150465)
    select @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'ConsignedDeliveryNo=' + @ConsignedDeliveryNo + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertMoveWarehouseBillGoods
@MoveWarehouseBillId bigint, 
@GoodsId bigint,
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@PieceWeight numeric(25,9),
@Location nvarchar(10),
@Packages int,
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint,
@NewLocation nvarchar(10),
@NewPackages int,
@NewTunnages numeric(25,9),
@NewPiles numeric(25,9),
@NewTenThousands numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @DeliveryNo nvarchar(20)
declare @Id bigint
declare @CustomerId bigint
declare @CustomerName nvarchar(50)
declare @ConsignedDeliveryNo nvarchar(20)
declare @Warehouse nvarchar(20)
declare @GoodsName nvarchar(50)
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @GoodsNo nvarchar(20)
declare @Brand nvarchar(20)
declare @SpecModel nvarchar(50)
declare @GWeight nvarchar(20)
declare @Grade nvarchar(10)
declare @PlanType nvarchar(10)
declare @StockId bigint
declare @StockPackages int
declare @StockPiles numeric(25,9)
declare @StockTunnages numeric(25,9)
declare @StockTenThousands numeric(25,9)
declare @ErrText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @DeliveryNo = DeliveryNo 
    from 
        EnterWarehouseBill 
    where 
        Id = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        set @DeliveryNo = ''
    end
    
    /**/
    select 
        @CustomerId = CustomerId, 
        @CustomerName = CustomerName, 
        @Warehouse = Warehouse, 
        @ConsignedDeliveryNo = ConsignedDeliveryNo 
    from 
        MoveWarehouseBill 
    where 
        Id = @MoveWarehouseBillId 
    if @@rowcount = 0
    begin
        raiserror (150466,18,1)
        return -2
    end
    
    /**/
    select 
        @GoodsNo = GoodsNo, 
        @GoodsName = Name, 
        @TypeId = TypeId, 
        @TypeName = TypeName, 
        @TypeFullPath = TypeFullPath, 
        @TypeFullName = TypeFullName, 
        @Brand = Brand, 
        @SpecModel = SpecModel, 
        @GWeight = GWeight, 
        @Grade = Grade 
    from 
        Goods 
    where 
        Id = @GoodsId 
    if @@rowcount = 0
    begin
        raiserror (150248,18,1)
        return -3
    end
    
    /**/
    if @NewPackages > 0
        set @PlanType = formatmessage(150256)
    else
        set @PlanType = formatmessage(150257)
        
    begin try
        exec CheckStock 
        @CustomerId, 
        @PlanType,
        @GoodsId, 
        @GoodsNo, 
        @BatchNo, 
        @Packing, 
        @Warehouse, 
        @Location, 
        @ProductionDate, 
        @EnterWarehouseBillId, 
        @ConsignedDeliveryNo,
        @NewPackages,
        @NewPiles,
        @OpStaffId, 
        @OpStaffName 
    end try
    begin catch
        select @ErrText = error_message()
        raiserror (@ErrText,18,1)
        return -4
    end catch
    
    
    /**/
    exec GetId @OpStaffId, @Id output 
    insert into MoveWarehouseBillGoods 
        (
            Id,
            MoveWarehouseBillId,
            GoodsId,
            GoodsName,
            TypeId,
            TypeName,
            TypeFullPath,
            TypeFullName,
            GoodsNo,
            Brand,
            SpecModel,
            GWeight,
            Grade,
            PieceWeight,
            Packing,
            BatchNo,
            Location,
            Packages,
            Tunnages,
            Piles,
            TenThousands,
            ProductionDate,
            EnterWarehouseBillId,
            DeliveryNo,
            NewLocation,
            NewPackages,
            NewTunnages,
            NewPiles,
            NewTenThousands
        )
    values
        (
            @Id,
            @MoveWarehouseBillId,
            @GoodsId,
            @GoodsName,
            @TypeId,
            @TypeName,
            @TypeFullPath,
            @TypeFullName,
            @GoodsNo,
            @Brand,
            @SpecModel,
            @GWeight,
            @Grade,
            @PieceWeight,
            @Packing,
            @BatchNo,
            @Location,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @ProductionDate,
            @EnterWarehouseBillId,
            @DeliveryNo,
            @NewLocation,
            @NewPackages,
            @NewTunnages,
            @NewPiles,
            @NewTenThousands
        )
    if @@rowcount = 0
    begin
        raiserror (150467,18,1)
        return -5
    end
    
    /**/
    if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
    begin
        /**/
        select 
            @Id = Id 
        from 
            Stock 
        where 
            GoodsId = @GoodsId and 
            BatchNo = @BatchNo and 
            Packing = @Packing and 
            Warehouse = @Warehouse and 
            Location = @NewLocation and 
            (Packages > 0 or Piles > 0) and 
            ProductionDate = @ProductionDate and
            EnterWarehouseBillId = @EnterWarehouseBillId and 
            DeliveryNo = @DeliveryNo 
        if @@rowcount = 0
        begin
            exec GetId @OpStaffId, @Id output 
            insert into Stock 
                (
                    Id,
                    CustomerId,
                    CustomerName,
                    GoodsId,
                    GoodsNo,
                    GoodsName,
                    Brand,
                    SpecModel,
                    GWeight,
                    Grade,
                    PieceWeight,
                    Packing,
                    BatchNo,
                    Warehouse,
                    Location,
                    Packages,
                    Tunnages,
                    Piles,
                    TenThousands,
                    ProductionDate,
                    EnterWarehouseBillId,
                    DeliveryNo
                )
            values 
                (
                    @Id,
                    @CustomerId,
                    @CustomerName,
                    @GoodsId,
                    @GoodsNo,
                    @GoodsName,
                    @Brand,
                    @SpecModel,
                    @GWeight,
                    @Grade,
                    @PieceWeight,
                    @Packing,
                    @BatchNo,
                    @Warehouse,
                    @NewLocation,
                    @NewPackages,
                    @NewTunnages,
                    @NewPiles,
                    @NewTenThousands,
                    @ProductionDate,
                    @EnterWarehouseBillId,
                    @DeliveryNo
                )
            if @@rowcount = 0
            begin
                raiserror (150282,18,1)
                return -6
            end
        end
        else
        begin
            update Stock set 
                Packages = Packages + @NewPackages,
                Tunnages = Tunnages + @NewTunnages,
                Piles = Piles + @NewPiles,
                TenThousands = TenThousands + @NewTenThousands
            where 
                Id = @Id
            if @@rowcount = 0
            begin
                raiserror (150295,18,1)
                return -7
            end
        end
    
        /**/
        declare Cursor1 cursor local for 
            select 
                Id,
                Packages,
                Tunnages,
                Piles,
                TenThousands
            from 
                Stock 
            where 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and 
                Warehouse = @Warehouse and 
                Location = @Location and 
                (Packages > 0 or Piles > 0) and 
                ProductionDate = @ProductionDate and 
                EnterWarehouseBillId = @EnterWarehouseBillId and 
                DeliveryNo = @ConsignedDeliveryNo 
    
        open Cursor1
        
        fetch next from Cursor1 into @StockId, @StockPackages, @StockTunnages, @StockPiles, @StockTenThousands
        while @@fetch_status = 0
        begin
            if @StockPackages < @NewPackages or @StockPiles < @NewPiles
            begin
                update Stock set 
                    Packages = 0, 
                    Tunnages = 0,
                    Piles = 0,
                    TenThousands = 0
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -8
                end
            
                set @NewPackages = @NewPackages - @StockPackages 
                set @NewTunnages = @NewTunnages - @StockTunnages
                set @NewPiles = @NewPiles - @StockPiles
                set @NewTenThousands = @NewTenThousands - @StockTenThousands
            end
            else
            begin
                update Stock set 
                    Packages = Packages - @NewPackages, 
                    Tunnages = Tunnages - @NewTunnages,
                    Piles = Piles - @NewPiles,
                    TenThousands = TenThousands - @NewTenThousands
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -9
                end
            
                set @NewPackages = 0 
                set @NewTunnages = 0
                set @NewPiles = 0
                set @NewTenThousands = 0
            end
        
            fetch next from Cursor1 into @StockId, @StockPackages, @StockTunnages, @StockPiles, @StockTenThousands
        end
        
        close Cursor1
        deallocate Cursor1 
    
        if @NewPackages > 0 or @NewPiles > 0
        begin
            set @ErrText = formatmessage(150532, @GoodsNo, @BatchNo, @Location)
            raiserror (@ErrText,18,1)
            return -10
        end
    end
    else
    begin
        /**/
        select 
            @Id = Id 
        from 
            Stock 
        where 
            CustomerId = @CustomerId and 
            GoodsId = @GoodsId and 
            BatchNo = @BatchNo and 
            Packing = @Packing and
            Warehouse = @Warehouse and 
            Location = @NewLocation and 
            (Packages > 0 or Piles > 0) and 
            ProductionDate = @ProductionDate and
            EnterWarehouseBillId = @EnterWarehouseBillId and 
            DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1) and 
            DeliveryNo = @DeliveryNo
        if @@rowcount = 0
        begin
            exec GetId @OpStaffId, @Id output 
            insert into Stock 
                (
                    Id,
                    CustomerId,
                    CustomerName,
                    GoodsId,
                    GoodsNo,
                    GoodsName,
                    Brand,
                    SpecModel,
                    GWeight,
                    Grade,
                    PieceWeight,
                    Packing,
                    BatchNo,
                    Warehouse,
                    Location,
                    Packages,
                    Tunnages,
                    Piles,
                    TenThousands,
                    ProductionDate,
                    EnterWarehouseBillId,
                    DeliveryNo
                )
            values 
                (
                    @Id,
                    @CustomerId,
                    @CustomerName,
                    @GoodsId,
                    @GoodsNo,
                    @GoodsName,
                    @Brand,
                    @SpecModel,
                    @GWeight,
                    @Grade,
                    @PieceWeight,
                    @Packing,
                    @BatchNo,
                    @Warehouse,
                    @NewLocation,
                    @NewPackages,
                    @NewTunnages,
                    @NewPiles,
                    @NewTenThousands,
                    @ProductionDate,
                    @EnterWarehouseBillId,
                    @DeliveryNo
                )
            if @@rowcount = 0
            begin
                raiserror (150282,18,1)
                return -11
            end
        end
        else
        begin
            update Stock set 
                Packages = Packages + @NewPackages,
                Tunnages = Tunnages + @NewTunnages,
                Piles = Piles + @NewPiles,
                TenThousands = TenThousands + @NewTenThousands
            where 
                Id = @Id
            if @@rowcount = 0
            begin
                raiserror (150295,18,1)
                return -12
            end
        end

        /**/
        declare Cursor2 cursor local for 
            select 
                Id,
                Packages,
                Tunnages,
                Piles,
                TenThousands
            from 
                Stock 
            where 
                CustomerId = @CustomerId and 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and
                Warehouse = @Warehouse and 
                Location = @Location and 
                (Packages > 0 or Piles > 0) and 
                ProductionDate = @ProductionDate and
                EnterWarehouseBillId = @EnterWarehouseBillId and 
                DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1) and 
                DeliveryNo = @DeliveryNo
        
        open Cursor2
        
        fetch next from Cursor2 into @StockId, @StockPackages, @StockTunnages, @StockPiles, @StockTenThousands
        while @@fetch_status = 0
        begin
            if @StockPackages < @NewPackages or @StockPiles < @NewPiles
            begin
                update Stock set 
                    Packages = 0, 
                    Tunnages = 0,
                    Piles = 0,
                    TenThousands = 0
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -13
                end
            
                set @NewPackages = @NewPackages - @StockPackages 
                set @NewTunnages = @NewTunnages - @StockTunnages
                set @NewPiles = @NewPiles - @StockPiles
                set @NewTenThousands = @NewTenThousands - @StockTenThousands
            end
            else
            begin
                update Stock set 
                    Packages = Packages - @NewPackages, 
                    Tunnages = Tunnages - @NewTunnages,
                    Piles = Piles - @NewPiles,
                    TenThousands = TenThousands - @NewTenThousands
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -14
                end
            
                set @NewPackages = 0 
                set @NewTunnages = 0
                set @NewPiles = 0
                set @NewTenThousands = 0
            end
        
            fetch next from Cursor2 into @StockId, @StockPackages, @StockTunnages, @StockPiles, @StockTenThousands
        end
        
        close Cursor2
        deallocate Cursor2 
    
        if @NewPackages > 0 or @NewPiles > 0
        begin
            set @ErrText = formatmessage(150532, @GoodsNo, @BatchNo, @Location)
            raiserror (@ErrText,18,1)
            return -15
        end
    end
    
    
    /**/
    set @OpName = formatmessage(150468)
    set @OpParams = N'MoveWarehouseBillId=' + convert(nvarchar,@MoveWarehouseBillId) + N',' +
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'PieceWeight=' + convert(nvarchar,@PieceWeight) + N',' +
                    N'Location=' + @Location + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId) + N',' +
                    N'DeliveryNo=' + @DeliveryNo + N',' +
                    N'NewLocation=' + @NewLocation + N',' +
                    N'NewPackages=' + convert(nvarchar,@NewPackages) + N',' +
                    N'NewTunnages=' + convert(nvarchar,@NewTunnages) + N',' +
                    N'NewPiles=' + convert(nvarchar,@NewPiles) + N',' +
                    N'NewTenThousands=' + convert(nvarchar,@NewTenThousands) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -16
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Name
 * @ParentId
 * @CountryName
 * @ProvinceName
 * @CityName
 * @Address
 * @PostalCode
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure InsertOrganization 
@Name nvarchar(50),
@ParentId bigint,
@CountryName nvarchar(20),
@ProvinceName nvarchar(20),
@CityName nvarchar(20),
@Address nvarchar(50),
@PostalCode nvarchar(10),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint 
declare @FullPath nvarchar(500)
declare @FullName nvarchar(1000)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    if exists(select 1 from Organization where Name = @Name and ParentId = @ParentId)
    begin
        raiserror (150052,18,1)
        return -1
    end
    
    /*ID*/
    exec GetId @OpStaffId, @Id output 

    /**/
    if @ParentId = 0
    begin
        set @FullName = ''
        set @FullPath = ''
    end
    else
    begin
        select @FullName = FullName, @FullPath = FullPath from Organization where Id = @ParentId
        if @FullName is null set @FullName = ''
        if @FullPath is null set @FullPath = ''
    end
    
    /**/
    if @FullName = ''
        set @FullName = @Name 
    else
        set @FullName = @FullName + '\' + @Name 
        
    if @FullPath = ''
        set @FullPath = convert(nvarchar,@Id) + '\'
    else
        set @FullPath = @FullPath + convert(nvarchar,@Id) + '\'
        
    /**/
    insert into Organization 
        (
            Id,
            Name, 
            ParentId, 
            FullName,
            FullPath, 
            CountryName, 
            ProvinceName, 
            CityName, 
            Address, 
            PostalCode, 
            Remark
        )
    values 
        (
            @Id,
            @Name, 
            @ParentId, 
            @FullName,
            @FullPath, 
            @CountryName, 
            @ProvinceName, 
            @CityName,
            @Address,
            @PostalCode,
            @Remark
        )

    if @@rowcount=0
    begin
        raiserror (150053,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150054)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'Name=' + @Name + N',' +
                       N'ParentId=' + convert(nvarchar,@ParentId) + N',' +
                       N'CountryName=' + @CountryName + N',' +
                       N'ProvinceName=' + @ProvinceName + N',' +
                       N'CityName=' + @CityName + N',' +
                       N'Address=' + @Address + N',' +
                       N'PostalCode=' + @PostalCode + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertOutWarehouseBill
@Id bigint output,
@PlanId bigint,
@CustomerId bigint,
@CustomerName nvarchar(50),
@DeliveryNo nvarchar(20),
@OutType nvarchar(10),
@ReceiverName nvarchar(50),
@ReceiverCountry nvarchar(20),
@ReceiverProvince nvarchar(20),
@ReceiverCity nvarchar(20),
@ReceiverAddress nvarchar(50),
@ReceiverContact nvarchar(20),
@ReceiverContactTel nvarchar(20),
@ReceiveType nvarchar(10),
@CarNo nvarchar(20),
@TrailerNo nvarchar(10),
@CarrierId bigint,
@CarrierName nvarchar(50),
@PayerId bigint,
@PayerName nvarchar(50),
@IsConsigning bit,
@ConsignedDeliveryNo nvarchar(20),
@Warehouse nvarchar(20),
@ForceFee numeric(25,9),
@Remark nvarchar(200),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @SettlementExpression nvarchar(100)
declare @OwnOrganId bigint
declare @BusinessType nvarchar(10)
declare @PaymentType nvarchar(10)
declare @BillNo nvarchar(20)
declare @ReceiverId bigint
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    if exists(
            select 
                *
            from 
                DeliverPlan 
            where 
                PlanState = formatmessage(150242) and
                DeliverType = formatmessage(150305) and
                Id in 
                (
                    select 
                        dpg.PlanId 
                    from 
                        DeliverPlanGoods dpg left join 
                        (
                            select 
                                PlanId, 
                                GoodsId, 
                                isnull(sum(Packages), 0) as DispatchPackages, 
                                isnull(sum(Piles), 0.0) as DispatchPiles 
                            from 
                                DispatchBillGoods 
                            group by 
                                PlanId, 
                                GoodsId
                        ) as dbg on dpg.PlanId = dbg.PlanId and dpg.GoodsId = dbg.GoodsId 
                    where 
                        dpg.Packages - isnull(dbg.DispatchPackages, 0) > 0 or 
                        dpg.Piles - isnull(dbg.DispatchPiles, 0.0) > 0 
                    group by 
                        dpg.PlanId
                ) and 
                CustomerId = @CustomerId and 
                Warehouse = @Warehouse
        )
    begin
        raiserror (150527,18,1)
        return -1
    end
    
    /**/
    if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
    begin
        if not exists(select * from Stock where Warehouse = @Warehouse and DeliveryNo = @ConsignedDeliveryNo and Packages > 0)
        begin
		    raiserror (150236,18,1)
            return -3
        end
    end
    
    /**/
    select @SettlementExpression = SettlementExpression, @OwnOrganId = OwnOrganId from Customer where Id = @CustomerId 
    if @@rowcount = 0
    begin
        raiserror (150082,18,1)
        return -4
    end
    
    /**/
    if @CarrierId is null or @CarrierId = 0 or not exists(select * from Carrier where Id = @CarrierId)
    begin
        /**/
        set @BusinessType = formatmessage(150341)
        set @PaymentType = formatmessage(150239)
            
        begin try
            if @CarrierName is not null and @CarrierName <> ''
            begin
                exec InsertCarrier @CarrierId output, @CarrierName, @BusinessType, @PaymentType, @OpStaffId, @OpStaffName 
                
                if @CarNo is not null and @CarNo <> ''
                begin
                    exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, 0, @OpStaffId, @OpStaffName 
                end
            end
        end try
        begin catch
            select @ErrorText = formatmessage(150199) + error_message()
            raiserror (@ErrorText,18,1)
            return -5
        end catch
    end    
    else
    begin
        /**/
        update CarrierCar set TrailerNo = @TrailerNo where CarrierId = @CarrierId and CarNo = @CarNo 
        if @@rowcount = 0
        begin
            raiserror (150316,18,1)
            return -6
        end
    
        /**/
        if exists(select * from Carrier where Name = @CarrierName and Id <> @CarrierId)
        begin
            raiserror (150497,18,1)
            return -7
        end
        
        update Carrier set Name = @CarrierName where Id = @CarrierId 
        if @@rowcount = 0
        begin
            raiserror (150207,18,1)
            return -8
        end
    end
    
    /**/
    if @PayerId is null or @PayerId = 0
    begin
        select @PayerId = Id from Customer where Name = @PayerName
        if @@rowcount = 0
        begin
            /**/
            begin try
                declare @ValuationMode nvarchar(20)
                set @ValuationMode = formatmessage(150620)
                
                exec InsertCustomer 
                    @PayerId output, 
                    @PayerName, 
                    @PayerName, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    @SettlementExpression, 
                    @ValuationMode,
                    1,
                    N'', 
                    @OwnOrganId, 
                    @OpStaffId, 
                    @OpStaffName 
            end try
            begin catch
                select @ErrorText = formatmessage(150240) + error_message()
                raiserror (@ErrorText,18,1)
                return -9
            end catch
        end
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    exec GetNo N'OutWarehouseBill', @BillNo output
    if @OutType = formatmessage(150305)
    begin
        set @BillNo = N'C' + @BillNo 
    end
    else
    begin
        set @BillNo = N'H' + @BillNo 
    end
        
    insert into OutWarehouseBill 
        (
            Id,
            BillNo,
            ShipmentBillId,
            PlanId,
            CustomerId,
            CustomerName,
            DeliveryNo,
            OutType,
            ReceiverName,
            ReceiverCountry,
            ReceiverProvince,
            ReceiverCity,
            ReceiverAddress,
            ReceiverContact,
            ReceiverContactTel,
            ReceiveType,
            CarNo,
            TrailerNo,
            CarrierId,
            CarrierName,
            PayerId,
            PayerName,
            IsConsigning,
            ConsignedDeliveryNo,
            Warehouse,
            ForceFee,
            Remark,
            CreatorId,
            CreatorName,
            CreateTime
        )
    values 
        (
            @Id,
            @BillNo,
            0,
            @PlanId,
            @CustomerId,
            @CustomerName,
            @DeliveryNo,
            @OutType,
            @ReceiverName,
            @ReceiverCountry,
            @ReceiverProvince,
            @ReceiverCity,
            @ReceiverAddress,
            @ReceiverContact,
            @ReceiverContactTel,
            @ReceiveType,
            @CarNo,
            @TrailerNo,
            @CarrierId,
            @CarrierName,
            @PayerId,
            @PayerName,
            @IsConsigning,
            @ConsignedDeliveryNo,
            @Warehouse,
            @ForceFee,
            @Remark,
            @OpStaffId,
            @OpStaffName,
            @CreateTime
        )
        
    if @@rowcount = 0
    begin
        raiserror (150391,18,1)
        return -10
    end
    
    /**/
    if exists(select * from Receiver where Name = @ReceiverName)
    begin
        update Receiver set 
            Country = @ReceiverCountry, 
            Province = @ReceiverProvince, 
            City = @ReceiverCity, 
            Address = @ReceiverAddress, 
            Contact = @ReceiverContact, 
            ContactTel = @ReceiverContactTel 
        where 
            Name = @ReceiverName 
            
        if @@rowcount = 0
        begin
            raiserror (150245,18,1)
            return -11
        end
    end
    else
    begin
        exec GetId @OpStaffId, @ReceiverId output 
    
        insert into Receiver 
            (
                Id,
                Name,
                Country,
                Province,
                City,
                Address,
                Contact,
                ContactTel
            )
        values 
            (
                @ReceiverId,
                @ReceiverName,
                @ReceiverCountry,
                @ReceiverProvince,
                @ReceiverCity,
                @ReceiverAddress,
                @ReceiverContact,
                @ReceiverContactTel
            )
            
        if @@rowcount = 0
        begin
            raiserror (150246,18,1)
            return -12
        end
    end
        
    
    /**/
    select @OpName = formatmessage(150526)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                       N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'OutType=' + @OutType + N',' +
                       N'ReceiverName=' + @ReceiverName + N',' +
                       N'ReceiverCountry=' + @ReceiverCountry + N',' +
                       N'ReceiverProvince=' + @ReceiverProvince + N',' +
                       N'ReceiverCity=' + @ReceiverCity + N',' +
                       N'ReceiverAddress=' + @ReceiverAddress + N',' +
                       N'ReceiverContact=' + @ReceiverContact + N',' +
                       N'ReceiverContactTel=' + @ReceiverContactTel + N',' +
                       N'ReceiveType=' + @ReceiveType + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'TrailerNo=' + @TrailerNo + N',' +
                       N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                       N'CarrierName=' + @CarrierName + N',' +
                       N'PayerId=' + convert(nvarchar,@PayerId) + N',' +
                       N'PayerName=' + @PayerName + N',' +
                       N'IsConsigning=' + convert(nvarchar,@IsConsigning) + N',' +
                       N'ConsignedDeliveryNo=' + @ConsignedDeliveryNo + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'ForceFee=' + convert(nvarchar,@ForceFee) + N',' +
                       N'Remark=' + @Remark + N',' +
                       N'CreateTime=' + convert(nvarchar,@CreateTime,120)
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -13
    end
    
    return 0
end
go


create procedure SubtractStock 
@CustomerId bigint,
@DeliveryNo nvarchar(20),
@GoodsId bigint,
@GoodsNo nvarchar(20),
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Warehouse nvarchar(20),
@Location nvarchar(10),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint,
@ConsignedDeliveryNo nvarchar(20),
@Packages int,
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@OutWarehouseBillId bigint,
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @StockId bigint
declare @StockPackages int
declare @StockTunnages numeric(25,9)
declare @StockPiles numeric(25,9)
declare @StockTenThousands numeric(25,9)
declare @StockOutWarehouseDetailId bigint
declare @CreateTime1 datetime
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
    begin
        declare Cursor1 cursor local for 
            select 
                Id,
                Packages,
                Tunnages,
                Piles,
                TenThousands
            from 
                Stock 
            where 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and 
                Warehouse = @Warehouse and 
                Location = @Location and 
                (Packages > 0 or Tunnages > 0 or Piles > 0) and 
                ProductionDate = @ProductionDate and 
                EnterWarehouseBillId = @EnterWarehouseBillId and 
                DeliveryNo = @ConsignedDeliveryNo 
            
        open Cursor1
        fetch next from Cursor1 into @StockId, @StockPackages, @StockTunnages, @StockPiles, @StockTenThousands
        while @@fetch_status = 0
        begin
            if @StockPackages < @Packages or @StockPiles < @Piles
            begin
                update Stock set 
                    Packages = 0, 
                    Tunnages = 0,
                    Piles = 0,
                    TenThousands = 0
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -1
                end
                    
                exec GetId @OpStaffId, @StockOutWarehouseDetailId output 
                insert into StockOutWarehouseDetail 
                    (
                        Id, 
                        StockId, 
                        OutWarehouseBillId, 
                        Packages, 
                        Tunnages,
                        Piles,
                        TenThousands
                    )
                values 
                    (
                        @StockOutWarehouseDetailId,
                        @StockId,
                        @OutWarehouseBillId,
                        @StockPackages,
                        @StockTunnages,
                        @StockPiles,
                        @StockTenThousands
                    )
                if @@rowcount = 0
                begin
                    raiserror (150420,18,1)
                    return -2
                end
                
                set @CreateTime1 = @CreateTime
                while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
                begin
                    update StockDaily set 
                        Packages = Packages - @StockPackages,
                        Tunnages = Tunnages - @StockTunnages,
                        Piles = Piles - @StockPiles,
                        TenThousands = TenThousands - @StockTenThousands
                    where 
                        StockId = @StockId and 
                        convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
                    if @@rowcount = 0
                    begin
                        raiserror (150649,18,1)
                        return -3
                    end
            
                    set @CreateTime1 = dateadd(day,1,@CreateTime1)
                end
                    
                set @Packages = @Packages - @StockPackages
                set @Tunnages = @Tunnages - @StockTunnages
                set @Piles = @Piles - @StockPiles
                set @TenThousands = @TenThousands - @StockTenThousands
            end
            else
            begin
                update Stock set 
                    Packages = Packages - @Packages, 
                    Tunnages = Tunnages - @Tunnages,
                    Piles = Piles - @Piles,
                    TenThousands = TenThousands - @TenThousands
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -4
                end
                    
                exec GetId @OpStaffId, @StockOutWarehouseDetailId output 
                insert into StockOutWarehouseDetail 
                    (
                        Id, 
                        StockId, 
                        OutWarehouseBillId, 
                        Packages, 
                        Tunnages,
                        Piles,
                        TenThousands
                    )
                values 
                    (
                        @StockOutWarehouseDetailId,
                        @StockId,
                        @OutWarehouseBillId,
                        @Packages,
                        @Tunnages,
                        @Piles,
                        @TenThousands
                    )
                if @@rowcount = 0
                begin
                    raiserror (150420,18,1)
                    return -5
                end
                    
                set @CreateTime1 = @CreateTime
                while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
                begin
                    update StockDaily set 
                        Packages = Packages - @Packages,
                        Tunnages = Tunnages - @Tunnages,
                        Piles = Piles - @Piles,
                        TenThousands = TenThousands - @TenThousands
                    where 
                        StockId = @StockId and 
                        convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
                    if @@rowcount = 0
                    begin
                        raiserror (150649,18,1)
                        return -6
                    end
            
                    set @CreateTime1 = dateadd(day,1,@CreateTime1)
                end
                    
                set @Packages = 0
                set @Tunnages = 0
                set @Piles = 0
                set @TenThousands = 0
                
                break
            end
            
            fetch next from Cursor1 into @StockId, @StockPackages, @StockTunnages, @StockPiles, @StockTenThousands
        end
            
        close Cursor1
        deallocate Cursor1 
            
        if @Packages > 0 or @Tunnages > 0 or @Piles > 0 or @TenThousands > 0
        begin
            set @ErrorText = formatmessage(150529, @GoodsNo, @BatchNo, @Location)
            raiserror (@ErrorText,18,1)
            return -7
        end
    end
    else
    begin
        declare Cursor2 cursor local for 
            select 
                Id,
                Packages,
                Tunnages,
                Piles,
                TenThousands
            from 
                Stock 
            where 
                CustomerId = @CustomerId and 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and 
                Warehouse = @Warehouse and 
                Location = @Location and 
                (Packages > 0 or Tunnages > 0 or Piles > 0) and 
                ProductionDate = @ProductionDate and 
                EnterWarehouseBillId = @EnterWarehouseBillId and 
                DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1) and 
                DeliveryNo = @DeliveryNo
        
        open Cursor2
        fetch next from Cursor2 into @StockId, @StockPackages, @StockTunnages, @StockPiles, @StockTenThousands
        while @@fetch_status = 0
        begin
            if @StockPackages < @Packages or @StockPiles < @Piles
            begin
                update Stock set 
                    Packages = 0, 
                    Tunnages = 0,
                    Piles = 0,
                    TenThousands = 0
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -8
                end
                    
                exec GetId @OpStaffId, @StockOutWarehouseDetailId output 
                insert into StockOutWarehouseDetail 
                    (
                        Id, 
                        StockId, 
                        OutWarehouseBillId, 
                        Packages, 
                        Tunnages,
                        Piles,
                        TenThousands
                    )
                values 
                    (
                        @StockOutWarehouseDetailId,
                        @StockId,
                        @OutWarehouseBillId,
                        @StockPackages,
                        @StockTunnages,
                        @StockPiles,
                        @StockTenThousands
                    )
                if @@rowcount = 0
                begin
                    raiserror (150420,18,1)
                    return -9
                end
                
                set @CreateTime1 = @CreateTime
                while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
                begin
                    update StockDaily set 
                        Packages = Packages - @StockPackages,
                        Tunnages = Tunnages - @StockTunnages,
                        Piles = Piles - @StockPiles,
                        TenThousands = TenThousands - @StockTenThousands
                    where 
                        StockId = @StockId and 
                        convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
                    if @@rowcount = 0
                    begin
                        raiserror (150649,18,1)
                        return -10
                    end
            
                    set @CreateTime1 = dateadd(day,1,@CreateTime1)
                end
                
                set @Packages = @Packages - @StockPackages
                set @Tunnages = @Tunnages - @StockTunnages
                set @Piles = @Piles - @StockPiles
                set @TenThousands = @TenThousands - @StockTenThousands
            end
            else
            begin
                update Stock set 
                    Packages = Packages - @Packages, 
                    Tunnages = Tunnages - @Tunnages,
                    Piles = Piles - @Piles,
                    TenThousands = TenThousands - @TenThousands
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -11
                end
                    
                exec GetId @OpStaffId, @StockOutWarehouseDetailId output 
                insert into StockOutWarehouseDetail 
                    (
                        Id, 
                        StockId, 
                        OutWarehouseBillId, 
                        Packages, 
                        Tunnages,
                        Piles,
                        TenThousands
                    )
                values 
                    (
                        @StockOutWarehouseDetailId,
                        @StockId,
                        @OutWarehouseBillId,
                        @Packages,
                        @Tunnages,
                        @Piles,
                        @TenThousands
                    )
                if @@rowcount = 0
                begin
                    raiserror (150420,18,1)
                    return -12
                end
                
                set @CreateTime1 = @CreateTime
                while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
                begin
                    update StockDaily set 
                        Packages = Packages - @Packages,
                        Tunnages = Tunnages - @Tunnages,
                        Piles = Piles - @Piles,
                        TenThousands = TenThousands - @TenThousands
                    where 
                        StockId = @StockId and 
                        convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
                    if @@rowcount = 0
                    begin
                        raiserror (150649,18,1)
                        return -13
                    end
            
                    set @CreateTime1 = dateadd(day,1,@CreateTime1)
                end
                
                set @Packages = 0
                set @Tunnages = 0
                set @Piles = 0
                set @TenThousands = 0
                
                break
            end
            
            fetch next from Cursor2 into @StockId, @StockPackages, @StockTunnages, @StockPiles, @StockTenThousands
        end
            
        close Cursor2
        deallocate Cursor2 
        
        if @Packages > 0 or @Tunnages > 0 or @Piles > 0 or @TenThousands > 0
        begin
            set @ErrorText = formatmessage(150529, @GoodsNo, @BatchNo, @Location)
            raiserror (@ErrorText,18,1)
            return -14
        end
    end

   
    /**/
    set @OpName = formatmessage(150652)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'DeliveryNo=' + @DeliveryNo + N',' + 
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' + 
                    N'GoodsNo=' + @GoodsNo + N',' + 
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'Warehouse=' + @Warehouse + N',' +
                    N'Location=' + @Location + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId) + N',' +
                    N'ConsignedDeliveryNo=' + @ConsignedDeliveryNo + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'OutWarehouseBillId=' + convert(nvarchar,@OutWarehouseBillId) + N',' +
                    N'CreateTime=' + convert(nvarchar,@CreateTime)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -15
    end
    
    return 0
end
go


create procedure SubtractStockEndDifferences 
@CustomerId bigint,
@DeliveryNo nvarchar(20),
@GoodsId bigint,
@GoodsNo nvarchar(20),
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Warehouse nvarchar(20),
@Location nvarchar(10),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint,
@ConsignedDeliveryNo nvarchar(20),
@Tunnages numeric(25,9),
@OutWarehouseBillId bigint,
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @StockId bigint
declare @StockTunnages numeric(25,9)
declare @StockOutWarehouseDetailId bigint
declare @CreateTime1 datetime
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
    begin
        declare Cursor1 cursor local for 
            select 
                Id,
                Tunnages
            from 
                Stock 
            where 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and 
                Warehouse = @Warehouse and 
                Location = @Location and 
                Tunnages > 0 and 
                ProductionDate = @ProductionDate and 
                EnterWarehouseBillId = @EnterWarehouseBillId and 
                DeliveryNo = @ConsignedDeliveryNo 

        open Cursor1
        
        fetch next from Cursor1 into @StockId, @StockTunnages
        while @@fetch_status = 0
        begin
            if @StockTunnages < @Tunnages 
            begin
                update Stock set 
                    Tunnages = 0
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -1
                end
                
                exec GetId @OpStaffId, @StockOutWarehouseDetailId output 
                insert into StockOutWarehouseDetail 
                    (
                        Id, 
                        StockId, 
                        OutWarehouseBillId, 
                        Packages, 
                        Tunnages,
                        Piles,
                        TenThousands
                    )
                values 
                    (
                        @StockOutWarehouseDetailId,
                        @StockId,
                        @OutWarehouseBillId,
                        0,
                        @StockTunnages,
                        0,
                        0
                    )
                if @@rowcount = 0
                begin
                    raiserror (150420,18,1)
                    return -2
                end
                
                set @CreateTime1 = @CreateTime
                while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
                begin
                    update StockDaily set 
                        Packages = Packages,
                        Tunnages = Tunnages - @StockTunnages,
                        Piles = Piles,
                        TenThousands = TenThousands
                    where 
                        StockId = @StockId and 
                        convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
                    if @@rowcount = 0
                    begin
                        raiserror (150649,18,1)
                        return -3
                    end
            
                    set @CreateTime1 = dateadd(day,1,@CreateTime1)
                end
            
                set @Tunnages = @Tunnages - @StockTunnages
            end
            else
            begin
                update Stock set 
                    Tunnages = Tunnages - @Tunnages
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -4
                end
                    
                exec GetId @OpStaffId, @StockOutWarehouseDetailId output 
                insert into StockOutWarehouseDetail 
                    (
                        Id, 
                        StockId, 
                        OutWarehouseBillId, 
                        Packages, 
                        Tunnages,
                        Piles,
                        TenThousands
                    )
                values 
                    (
                        @StockOutWarehouseDetailId,
                        @StockId,
                        @OutWarehouseBillId,
                        0,
                        @Tunnages,
                        0,
                        0
                    )
                if @@rowcount = 0
                begin
                    raiserror (150420,18,1)
                    return -5
                end
                
                set @CreateTime1 = @CreateTime
                while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
                begin
                    update StockDaily set 
                        Packages = Packages,
                        Tunnages = Tunnages - @Tunnages,
                        Piles = Piles,
                        TenThousands = TenThousands
                    where 
                        StockId = @StockId and 
                        convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
                    if @@rowcount = 0
                    begin
                        raiserror (150649,18,1)
                        return -6
                    end
            
                    set @CreateTime1 = dateadd(day,1,@CreateTime1)
                end
                
                set @Tunnages = 0
                
                break
            end
        
            fetch next from Cursor1 into @StockId, @StockTunnages
        end
        
        close Cursor1
        deallocate Cursor1 
        
        if @Tunnages > 0 
        begin
            set @ErrorText = formatmessage(150529, @GoodsNo, @BatchNo, @Location)
            raiserror (@ErrorText,18,1)
            return -7
        end
    end
    else
    begin
        declare Cursor2 cursor local for 
            select 
                Id,
                Tunnages
            from 
                Stock 
            where 
                CustomerId = @CustomerId and 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and 
                Warehouse = @Warehouse and 
                Location = @Location and 
                Tunnages > 0 and 
                ProductionDate = @ProductionDate and 
                EnterWarehouseBillId = @EnterWarehouseBillId and 
                DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1) and 
                DeliveryNo = @DeliveryNo
                
        open Cursor2
        
        fetch next from Cursor2 into @StockId, @StockTunnages
        while @@fetch_status = 0
        begin
            if @StockTunnages < @Tunnages
            begin
                update Stock set 
                    Tunnages = 0
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -8
                end
                    
                exec GetId @OpStaffId, @StockOutWarehouseDetailId output 
                insert into StockOutWarehouseDetail 
                    (
                        Id, 
                        StockId, 
                        OutWarehouseBillId, 
                        Packages, 
                        Tunnages,
                        Piles,
                        TenThousands
                    )
                values 
                    (
                        @StockOutWarehouseDetailId,
                        @StockId,
                        @OutWarehouseBillId,
                        0,
                        @StockTunnages,
                        0,
                        0
                    )
                if @@rowcount = 0
                begin
                    raiserror (150420,18,1)
                    return -9
                end
                
                set @CreateTime1 = @CreateTime
                while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
                begin
                    update StockDaily set 
                        Packages = Packages,
                        Tunnages = Tunnages - @StockTunnages,
                        Piles = Piles,
                        TenThousands = TenThousands
                    where 
                        StockId = @StockId and 
                        convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
                    if @@rowcount = 0
                    begin
                        raiserror (150649,18,1)
                        return -10
                    end
            
                    set @CreateTime1 = dateadd(day,1,@CreateTime1)
                end
            
                set @Tunnages = @Tunnages - @StockTunnages
            end
            else
            begin
                update Stock set 
                    Tunnages = Tunnages - @Tunnages
                where 
                    Id = @StockId 
                if @@rowcount = 0
                begin
                    raiserror (150295,18,1)
                    return -11
                end
                    
                exec GetId @OpStaffId, @StockOutWarehouseDetailId output 
                insert into StockOutWarehouseDetail 
                    (
                        Id, 
                        StockId, 
                        OutWarehouseBillId, 
                        Packages, 
                        Tunnages,
                        Piles,
                        TenThousands
                    )
                values 
                    (
                        @StockOutWarehouseDetailId,
                        @StockId,
                        @OutWarehouseBillId,
                        0,
                        @Tunnages,
                        0,
                        0
                    )
                if @@rowcount = 0
                begin
                    raiserror (150420,18,1)
                    return -12
                end
                
                set @CreateTime1 = @CreateTime
                while convert(nvarchar(10),@CreateTime1,120) < convert(nvarchar(10),getdate(),120)
                begin
                    update StockDaily set 
                        Packages = Packages,
                        Tunnages = Tunnages - @Tunnages,
                        Piles = Piles,
                        TenThousands = TenThousands
                    where 
                        StockId = @StockId and 
                        convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime1,120)
                    if @@rowcount = 0
                    begin
                        raiserror (150649,18,1)
                        return -13
                    end
            
                    set @CreateTime1 = dateadd(day,1,@CreateTime1)
                end
            
                set @Tunnages = 0
                
                break
            end
        
            fetch next from Cursor2 into @StockId, @StockTunnages
        end
        
        close Cursor2
        deallocate Cursor2
        
        if @Tunnages > 0
        begin
            set @ErrorText = formatmessage(150529, @GoodsNo, @BatchNo, @Location)
            raiserror (@ErrorText,18,1)
            return -14
        end
    end

   
    /**/
    set @OpName = formatmessage(150653)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'DeliveryNo=' + @DeliveryNo + N',' + 
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' + 
                    N'GoodsNo=' + @GoodsNo + N',' + 
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'Warehouse=' + @Warehouse + N',' +
                    N'Location=' + @Location + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId) + N',' +
                    N'ConsignedDeliveryNo=' + @ConsignedDeliveryNo + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'OutWarehouseBillId=' + convert(nvarchar,@OutWarehouseBillId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -15
    end
    
    return 0
end
go


create procedure InsertOutWarehouseBillGoods
@OutWarehouseBillId bigint,
@GoodsId bigint,
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Location nvarchar(10),
@Packages int,
@PieceWeight numeric(25,9),
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint, 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @DeliveryNo nvarchar(20)
declare @GoodsNo nvarchar(20)
declare @GoodsName nvarchar(50)
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @Brand nvarchar(20)
declare @SpecModel nvarchar(50)
declare @GWeight nvarchar(20)
declare @Grade nvarchar(10)
declare @PlanType nvarchar(10)
declare @CustomerId bigint
declare @OutType nvarchar(20)
declare @Warehouse nvarchar(20)
declare @ConsignedDeliveryNo nvarchar(20)
declare @CreateTime datetime
declare @Id bigint
declare @ErrText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @DeliveryNo = DeliveryNo 
    from 
        EnterWarehouseBill 
    where 
        Id = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        set @DeliveryNo = ''
    end
    
    /**/
    select 
        @GoodsNo = GoodsNo, 
        @GoodsName = Name, 
        @TypeId = TypeId, 
        @TypeName = TypeName, 
        @TypeFullPath = TypeFullPath, 
        @TypeFullName = TypeFullName, 
        @Brand = Brand, 
        @SpecModel = SpecModel, 
        @GWeight = GWeight, 
        @Grade = Grade 
    from 
        Goods 
    where 
        Id = @GoodsId 
    if @@rowcount = 0
    begin
        raiserror (150248,18,1)
        return -1
    end
    
    /**/
    select 
        @CustomerId = CustomerId, 
        @OutType = OutType,
        @Warehouse = Warehouse, 
        @ConsignedDeliveryNo = ConsignedDeliveryNo,
        @CreateTime = CreateTime 
    from 
        OutWarehouseBill 
    where 
        Id = @OutWarehouseBillId 
    if @@rowcount = 0
    begin
        raiserror (150395,18,1)
        return -2
    end
    
    /**/
    if @Packages > 0
        set @PlanType = formatmessage(150256)
    else
        set @PlanType = formatmessage(150257)
    
    begin try
        exec CheckStock 
        @CustomerId, 
        @PlanType, 
        @GoodsId, 
        @GoodsNo, 
        @BatchNo, 
        @Packing, 
        @Warehouse, 
        @Location, 
        @ProductionDate, 
        @EnterWarehouseBillId, 
        @ConsignedDeliveryNo,
        @Packages,
        @Piles,
        @OpStaffId, 
        @OpStaffName 
    end try
    begin catch
        select @ErrText = error_message()
        raiserror (@ErrText,18,1)
        return -3
    end catch
    
    
    /**/
    exec GetId @OpStaffId, @Id output 
    insert into OutWarehouseBillGoods 
    (
        Id,
        OutWarehouseBillId,
        GoodsId,
        GoodsName,
        TypeId,
        TypeName,
        TypeFullPath,
        TypeFullName,
        GoodsNo,
        Brand,
        SpecModel,
        GWeight,
        Grade,
        PieceWeight,
        Packing,
        BatchNo,
        Location,
        Packages,
        Tunnages,
        Piles,
        TenThousands,
        ProductionDate,
        EnterWarehouseBillId,
        DeliveryNo 
    )
    values 
    (
        @Id,
        @OutWarehouseBillId,
        @GoodsId,
        @GoodsName,
        @TypeId,
        @TypeName,
        @TypeFullPath,
        @TypeFullName,
        @GoodsNo,
        @Brand,
        @SpecModel,
        @GWeight,
        @Grade,
        @PieceWeight,
        @Packing,
        @BatchNo,
        @Location,
        @Packages,
        @Tunnages,
        @Piles,
        @TenThousands,
        @ProductionDate,
        @EnterWarehouseBillId,
        @DeliveryNo 
    )
    if @@rowcount = 0
    begin
        raiserror (150393,18,1)
        return -4
    end
    
    /**/
    if @OutType = formatmessage(150630)
    begin
        begin try
            exec SubtractStockEndDifferences 
            @CustomerId, 
            @DeliveryNo, 
            @GoodsId, 
            @GoodsNo, 
            @BatchNo, 
            @Packing, 
            @Warehouse, 
            @Location, 
            @ProductionDate, 
            @EnterWarehouseBillId, 
            @ConsignedDeliveryNo,
            @Tunnages,
            @OutWarehouseBillId,
            @CreateTime,
            @OpStaffId, 
            @OpStaffName 
        end try
        begin catch
            select @ErrText = error_message()
            raiserror (@ErrText,18,1)
            return -5
        end catch
    end
    else
    begin
        begin try
            exec SubtractStock 
            @CustomerId, 
            @DeliveryNo, 
            @GoodsId, 
            @GoodsNo, 
            @BatchNo, 
            @Packing, 
            @Warehouse, 
            @Location, 
            @ProductionDate, 
            @EnterWarehouseBillId, 
            @ConsignedDeliveryNo,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @OutWarehouseBillId,
            @CreateTime,
            @OpStaffId, 
            @OpStaffName 
        end try
        begin catch
            select @ErrText = error_message()
            raiserror (@ErrText,18,1)
            return -6
        end catch
    end
    
    
    /**/
    set @OpName = formatmessage(150530)
    set @OpParams = N'OutWarehouseBillId=' + convert(nvarchar,@OutWarehouseBillId) + N',' +
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Location=' + @Location + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'PieceWeight=' + convert(nvarchar,@PieceWeight) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -7
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @Name
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure InsertPermissionGroup
@Id bigint output,
@Name nvarchar(50),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	exec GetId @OpStaffId, @Id output
    
    /**/
    insert into SysGroup (Id, Name, Remark) values (@Id, @Name, @Remark)
    
    if @@rowcount=0
    begin
        raiserror (150008,18,1)
        return -1
    end

    /**/
	select @OpName = formatmessage(150009)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'Name=' + @Name + N',' +
                    N'Remark=' + @Remark 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Name
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure InsertPosition 
@Name nvarchar(20),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    if exists(select 1 from Position where Name = @Name)
    begin
        raiserror (150065,18,1)
        return -1
    end
    
    /*ID*/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into Position 
        (
            Id,
            Name, 
            Remark
        )
    values 
        (
            @Id,
            @Name, 
            @Remark
        )

    if @@rowcount=0
    begin
        raiserror (150066,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150067)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'Name=' + @Name + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @Name
 * @CountryName
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure InsertProvince
@Name nvarchar(20),
@CountryName nvarchar(20),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Id bigint 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	if exists(select 1 from Province where Name = @Name and CountryName = @CountryName)
	begin
		raiserror (150037,18,1)
        return -1
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into Province (Id, Name, CountryName, Remark) values (@Id, @Name, @CountryName, @Remark)
    if @@rowcount=0
    begin
        raiserror (150038,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150039)
    select @OpParams = N'Name=' + @Name + N',' +
                       N'CountryName=' + @CountryName + N',' +
                       N'Remark=' + @Remark 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertReceiver
@Id bigint output, 
@Name nvarchar(50),
@CountryName nvarchar(20),
@ProvinceName nvarchar(20),
@CityName nvarchar(20),
@Address nvarchar(50),
@ReceiverContact nvarchar(20),
@ReceiverContactTel nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from Receiver where Name = @Name)
    begin
        raiserror (150593,18,1)
        return -1
    end

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into Receiver 
        (
            Id,
            Name,
            Country,
            Province,
            City,
            Address,
            Contact,
            ContactTel 
        )
    values
        (
            @Id,
            @Name,
            @CountryName,
            @ProvinceName,
            @CityName,
            @Address,
            @ReceiverContact,
            @ReceiverContactTel
        )
    
    if @@rowcount = 0
    begin
        raiserror (150246,18,1)
        return -2
    end
    
    /**/
    set @OpName = formatmessage(150594)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'Name=' + @Name + N',' +
                    N'CountryName=' + @CountryName + N',' +
                    N'ProvinceName=' + @ProvinceName + N',' +
                    N'CityName=' + @CityName + N',' +
                    N'Address=' + @Address + N',' +
                    N'ReceiverContact=' + @ReceiverContact + N',' +
                    N'ReceiverContactTel=' + @ReceiverContactTel 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertReceiverDistance
@ReceiverName nvarchar(50), 
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@KM int,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into ReceiverDistance 
        (
            Id,
            ReceiverName,
            StartCountry,
            StartProvince,
            StartCity,
            KM
        )
    values
        (
            @Id,
            @ReceiverName,
            @StartCountry,
            @StartProvince,
            @StartCity,
            @KM
        )
    
    if @@rowcount = 0
    begin
        raiserror (150595,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150596)
    set @OpParams = N'ReceiverName=' + @ReceiverName + N',' +
                    N'StartCountry=' + @StartCountry + N',' +
                    N'StartProvince=' + @StartProvince + N',' +
                    N'StartCity=' + @StartCity + N',' +
                    N'KM=' + convert(nvarchar,@KM) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @FamilyName
 * @Name
 * @Sex
 * @OrganId
 * @PositionId
 * @OfficeTel
 * @TelExt
 * @Fax
 * @MobileTel11
 * @MobileTel22
 * @MobileTel33
 * @EMail
 * @QQQQ
 * @BossStaffId,ID
 * @IsOrganLeader
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure InsertStaff 
@Id bigint output,
@FamilyName nvarchar(20),
@Name nvarchar(20),
@Sex nchar(1),
@OrganId bigint,
@PositionId bigint,
@OfficeTel nvarchar(20),
@TelExt nvarchar(20),
@Fax nvarchar(20),
@MobileTel1 nvarchar(20),
@MobileTel2 nvarchar(20),
@MobileTel3 nvarchar(20),
@EMail nvarchar(255),
@QQ nvarchar(20),
@IsOrganManager bit,
@IsOrganLeader bit,
@BossStaffId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OrganName nvarchar(50)
declare @OrganFullPath nvarchar(500)
declare @PositionName nvarchar(20)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if @IsOrganLeader = 1 and exists(select * from Staff where OrganId = @OrganId and IsOrganLeader = 1)
    begin
        raiserror (150072,18,1)
        return -1
    end
    
    /**/
    select @OrganName = Name, @OrganFullPath = FullPath from Organization where Id = @OrganId 
    if @@rowcount = 0
    begin
        raiserror (150073,18,1)
        return -2
    end
    
    /**/
    select @PositionName = Name from Position where Id = @PositionId 
    if @PositionName is null or @PositionName = ''
    begin
        raiserror (150074,18,1)
        return -3
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into Staff 
        (
            Id,
            FamilyName,
            Name,
            Sex,
            OrganId,
            OrganName,
			OrganFullPath,
            PositionId,
            PositionName,
            OfficeTel,
            TelExt,
            Fax,
            MobileTel1,
            MobileTel2,
            MobileTel3,
            EMail,
            QQ,
            BossStaffId,
            IsOrganManager,
            IsOrganLeader,
            CreateTime
        )
    values
        (
            @Id,
            @FamilyName,
            @Name,
            @Sex,
            @OrganId,
            @OrganName,
			@OrganFullPath,
            @PositionId,
            @PositionName,
            @OfficeTel,
            @TelExt,
            @Fax,
            @MobileTel1,
            @MobileTel2,
            @MobileTel3,
            @EMail,
            @QQ,
            @BossStaffId,
            @IsOrganManager,
            @IsOrganLeader,
            getdate()
        )
        
    if @@rowcount = 0
    begin
        raiserror (150075,18,1)
        return -4
    end

    /**/
    select @OpName = formatmessage(150076)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'FamilyName=' + @FamilyName + N',' +
                       N'Name=' + @Name + N',' +
                       N'Sex=' + @Sex + N',' +
                       N'OrganId=' + convert(nvarchar,@OrganId) + N',' +
                       N'OrganName=' + @OrganName + N',' +
					   N'OrganFullPath=' + @OrganFullPath + N',' +
                       N'PositionId=' + convert(nvarchar,@PositionId) + N',' +
                       N'PositionName=' + @PositionName + N',' +
                       N'OfficeTel=' + @OfficeTel + N',' +
                       N'TelExt=' + @TelExt + N',' +
                       N'Fax=' + @Fax + N',' +
                       N'MobileTel1=' + @MobileTel1 + N',' +
                       N'MobileTel2=' + @MobileTel2 + N',' +
                       N'MobileTel3=' + @MobileTel3 + N',' +
                       N'EMail=' + @EMail + N',' +
                       N'QQ=' + @QQ + N',' +
                       N'IsOrganManager=' + convert(nvarchar,@IsOrganManager) + N',' +
                       N'IsOrganLeader=' + convert(nvarchar,@IsOrganLeader) + N',' +
                       N'BossStaffId=' + convert(nvarchar,@BossStaffId) 

    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -5
    end
    
    return 0
end
go


create procedure InsertTransportLimitedPrice
@PlanType nvarchar(10),
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@DestCountry nvarchar(20),
@DestProvince nvarchar(20),
@DestCity nvarchar(20),
@CarType nvarchar(10),
@MinTunnagesOrPiles numeric(25,9),
@MaxTunnagesOrPiles numeric(25,9),
@StartTime datetime,
@EndTime datetime,
@TransportPrice numeric(25,9),
@TransportCharges numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(
        select 
            * 
        from 
            TransportLimitedPrice 
        where 
            PlanType = @PlanType and 
            StartCountry = @StartCountry and 
            StartProvince = @StartProvince and 
            StartCity = @StartCity and 
            DestCountry = @DestCountry and 
            DestProvince = @DestProvince and 
            DestCity = @DestCity and 
            CarType = @CarType and 
            MinTunnagesOrPiles < @MaxTunnagesOrPiles and 
            MaxTunnagesOrPiles > @MinTunnagesOrPiles and 
            StartTime < @EndTime and 
            EndTime > @StartTime)
    begin
        raiserror (150222,18,1)
        return -1
    end

    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into TransportLimitedPrice 
        (
            Id,
            PlanType,
            StartCountry,
            StartProvince,
            StartCity,
            DestCountry,
            DestProvince,
            DestCity,
            CarType,
            MinTunnagesOrPiles,
            MaxTunnagesOrPiles,
            StartTime,
            EndTime,
            TransportPrice,
            TransportCharges
        )
    values
        (
            @Id,
            @PlanType,
            @StartCountry,
            @StartProvince,
            @StartCity,
            @DestCountry,
            @DestProvince,
            @DestCity,
            @CarType,
            @MinTunnagesOrPiles,
            @MaxTunnagesOrPiles,
            @StartTime,
            @EndTime,
            @TransportPrice,
            @TransportCharges
        )
    
    if @@rowcount = 0
    begin
        raiserror (150220,18,1)
        return -2
    end
    
    /**/
    set @OpName = formatmessage(150221)
    set @OpParams = N'PlanType=' + @PlanType + N',' +
                    N'StartCountry=' + @StartCountry + N',' +
                    N'StartProvince=' + @StartProvince + N',' +
                    N'StartCity=' + @StartCity + N',' +
                    N'DestCountry=' + @DestCountry + N',' +
                    N'DestProvince=' + @DestProvince + N',' +
                    N'DestCity=' + @DestCity + N',' +
                    N'CarType=' + @CarType + N',' +
                    N'MinTunnagesOrPiles=' + convert(nvarchar,@MinTunnagesOrPiles) + N',' +
                    N'MaxTunnagesOrPiles=' + convert(nvarchar,@MaxTunnagesOrPiles) + N',' +
                    N'StartTime=' + convert(nvarchar(10),@StartTime,120) + N',' +
                    N'EndTime=' + convert(nvarchar(10),@EndTime,120) + N',' +
                    N'TransportPrice=' + convert(nvarchar,@TransportPrice) + N',' +
                    N'TransportCharges=' + convert(nvarchar,@TransportCharges)
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure InsertWarehouse
@Name nvarchar(50),
@IsLease bit,
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Id bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	if exists(select 1 from Warehouse where Name = @Name)
	begin
		raiserror (150188,18,1)
        return -1
    end
    
    /**/
    exec GetId @OpStaffId, @Id output 
    
    /**/
    insert into Warehouse (Id, Name, IsLease, Remark) values (@Id, @Name, @IsLease, @Remark)
    
    if @@rowcount=0
    begin
        raiserror (150189,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150190)
    select @OpParams = N'Name=' + @Name + N',' +
                       N'IsLease=' + convert(nvarchar,@IsLease) + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadAccount
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Account where Id = @Id 
        
    if @@rowcount = 0
    begin
        raiserror (150004,18,1) 
        return -1
    end
   
    /**/
    select @OpName = formatmessage(150005)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
   
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Name
 *
*******************************************************************************************/
create procedure LoadAccountByName
@Name nvarchar(20)
with encryption
as
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Account where Name = @Name and IsCancel = 0 
        
    if @@rowcount = 0
    begin
        raiserror (150148,18,1)
        return -1
    end
   
    return 0
end
go


create procedure LoadAccountPermission
@FuncId bigint,
@FuncPermission nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

    set @Sql = 'select ' + @FuncPermission + ' as IsAllow from SysGroupPermission where FuncId = ' + convert(nvarchar, @FuncId) + ' and GroupId in (select GroupId from AccountPermission where AccountId = ' + convert(nvarchar, @OpStaffId) + ')'
    exec (@Sql)
    
    if @@error <> 0
    begin
        raiserror (150112,18,1)
        return -1
    end

	/**/
	select @OpName = formatmessage(150228)
    select @OpParams = N'FuncId=' + convert(nvarchar,@FuncId) + N',' +
                       N'FuncPermission=' + @FuncPermission 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end

    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @AccountId
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadAccountPermissions
@AccountId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from AccountPermission where AccountId = @AccountId 

	/**/
	select @OpName = formatmessage(150013)
    select @OpParams = N'AccountId=' + convert(nvarchar,@AccountId)
     
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end

    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadAccounts
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Account order by Id 
    
    /**/
    select @OpName = formatmessage(150021)
    select @OpParams = N''
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadActiveAccounts
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Account where IsCancel = 0 order by Id 
    
    /**/
    select @OpName = formatmessage(150172)
    select @OpParams = N''
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadAllDispatchBillGoodsByConditions 
@PlanId nvarchar(50),
@GoodsId nvarchar(50),
@BatchNo nvarchar(50),
@Packing nvarchar(50),
@Location nvarchar(50),
@ProductionDate nvarchar(50),
@EnterWarehouseBillId nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = '
        select 
            dbg.*, 
            db.CarNo, 
            db.TrailerNo, 
            db.CreateTime,
            ewb.BillNo as EnterWarehouseBillNo
        from 
            DispatchBillGoods dbg join 
            DispatchBill db on dbg.DispatchBillId = db.Id left join 
            EnterWarehouseBill ewb on dbg.EnterWarehouseBillId = ewb.Id '
            
    set @WhereSql = ''
    
    if @PlanId is not null and @PlanId <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dbg.PlanId = ' + @PlanId + ')'
    end
    
    if @GoodsId is not null and @GoodsId <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dbg.GoodsId = ' + @GoodsId + ')'
    end
    
    if @BatchNo is not null and @BatchNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dbg.BatchNo = ''' + @BatchNo + ''')'
    end

    if @Packing is not null and @Packing <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dbg.Packing = ''' + @Packing + ''')'
    end
    
    if @Location is not null and @Location <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dbg.Location = ''' + @Location + ''')'
    end

    if @ProductionDate is not null and @ProductionDate <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dbg.ProductionDate = ''' + @ProductionDate + ''')'
    end

    if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dbg.EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
    end

    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql
    
    exec(@SelectSql)
    
    /**/
    select @OpName = formatmessage(150309)
    select @OpParams = N'PlanId=' + @PlanId + N',' +
                       N'GoodsId=' + @GoodsId + N',' +
                       N'BatchNo=' + @BatchNo + N',' +
                       N'Packing=' + @Packing + N',' +
                       N'Location=' + @Location + N',' +
                       N'ProductionDate=' + @ProductionDate + N',' +
                       N'EnterWarehouseBillId=' + @EnterWarehouseBillId
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadAllGoodsByConditions 
@TypeId nvarchar(50),
@GoodsNo nvarchar(50),
@GoodsName nvarchar(50),
@SpecModel nvarchar(50),
@GWeight nvarchar(50),
@Grade nvarchar(50),
@Packing nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = 'select * from Goods '
    set @WhereSql = ''
    
    if @TypeId is not null and @TypeId <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(TypeFullPath like (select FullPath + N''%'' from GoodsType where Id = ' + @TypeId + '))'
    end
    
    if @GoodsNo is not null and @GoodsNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(GoodsNo like ''%' + @GoodsNo + '%'')'
    end

    if @GoodsName is not null and @GoodsName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Name like ''%' + @GoodsName + '%'')'
    end

    if @SpecModel is not null and @SpecModel <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(SpecModel like ''%' + @SpecModel + '%'')'
    end

    if @GWeight is not null and @GWeight <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(GWeight like ''%' + @GWeight + '%'')'
    end
    
    if @Grade is not null and @Grade <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Grade like ''%' + @Grade + '%'')'
    end

    if @Packing is not null and @Packing <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Packing = ''' + @Packing + ''')'
    end

    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    
    exec (@SelectSql)
    
    
    /**/
    select @OpName = formatmessage(150177)
    select @OpParams = N'TypeId=' + @TypeId + N',' +
                       N'GoodsNo=' + @GoodsNo + N',' +
                       N'GoodsName=' + @GoodsName + N',' +
                       N'SpecModel=' + @SpecModel + N',' +
                       N'GWeight=' + @GWeight + N',' +
                       N'Grade=' + @Grade + N',' +
                       N'Packing=' + @Packing 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadAllGoodsByGoodsNo 
@GoodsNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Goods where GoodsNo like ('%' + @GoodsNo + '%')
    
    /**/
    select @OpName = formatmessage(150533)
    select @OpParams = N'GoodsNo=' + @GoodsNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
CREATE procedure LoadAllStaffsByOrganId
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OrganFullPath nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	select @OrganFullPath = FullPath from Organization where Id = @Id
	if @@rowcount = 0
	begin
		raiserror (150145,18,1)
        return -1
    end
    
    /**/
    select 
        *,
        (case when FamilyName is null then N'' else FamilyName end + Name) as FullName 
    from 
        Staff 
    where 
        (OrganFullPath like (@OrganFullPath + '%'))
    order by 
        Id 
        
    /**/
    select @OpName = formatmessage(150146)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure LoadAllSubGoodsTypes 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select dd.* from GoodsType dd where dd.FullPath like (select pt.FullPath + '%' from GoodsType pt where pt.Id = @Id)

    /**/
    select @OpName = formatmessage(150149)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 *
 * 
 *
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure LoadAppVersion
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
	set nocount on
	
	/**/
	/*set xact_abort on*/
	
	/**/
	select * from AppVersion 
     
	if @@rowcount = 0
	begin
		raiserror (150105,18,1)
		return -1
	end
	
	/**/
    set @OpName = formatmessage(150106)
    set @OpParams = N''
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadApproveContractsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@ContractNo nvarchar(50),
@OriginalContractNo nvarchar(50),
@DestCountry nvarchar(50),
@DestProvince nvarchar(50),
@DestCity nvarchar(50),
@CarNo nvarchar(50),
@OrganId nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @StaffId bigint
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @StaffId = StaffId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end

    /**/
    set @Sql = 'select * from Contract where ApproverId = ' + convert(nvarchar,@StaffId) + ' and ApproveState = ''' + formatmessage(150283) + ''' and ContractState = ''' + formatmessage(150242) + ''' and PrintState = 1 '

    if @StartTime is not null and @StartTime <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(convert(nvarchar(10),ShipmentTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(convert(nvarchar(10),ShipmentTime,120) <= ''' + @EndTime + ''')'
    end
    
    if @ContractNo is not null and @ContractNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(ContractNo like ''%' + @ContractNo + '%'')'
    end
    
    if @OriginalContractNo is not null and @OriginalContractNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(OriginalContractNo like ''%' + @OriginalContractNo + '%'')'
    end
    
    if @DestCity is not null and @DestCity <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(Id in (select cdp.ContractId from ContractDeliverPlan cdp join DeliverPlan dp on cdp.PlanId = dp.Id where dp.ReceiverCountry = ''' + @DestCountry + ''' and dp.ReceiverProvince = ''' + @DestProvince + ''' and dp.ReceiverCity = ''' + @DestCity + '''))'
    end
    else
    begin
        if @DestProvince is not null and @DestProvince <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Id in (select cdp.ContractId from ContractDeliverPlan cdp join DeliverPlan dp on cdp.PlanId = dp.Id where dp.ReceiverCountry = ''' + @DestCountry + ''' and dp.ReceiverProvince = ''' + @DestProvince + '''))'
        end
        else
        begin
            if @DestCountry is not null and @DestCountry <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(Id in (select cdp.ContractId from ContractDeliverPlan cdp join DeliverPlan dp on cdp.PlanId = dp.Id where dp.ReceiverCountry = ''' + @DestCountry + '''))'
            end
        end
    end

    if @CarNo is not null and @CarNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(CarNo like ''%' + @CarNo + '%'')'
    end

    if @OrganId is not null and @OrganId <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(Id in (select cdp.ContractId from ContractDeliverPlan cdp join DeliverPlan dp on cdp.PlanId = dp.Id where dp.OwnOrganId = ' + @OrganId + '))'
    end
    
    exec(@Sql)
    
    if @@error <> 0
    begin
        raiserror (150674,18,1)
        return -1
    end
    
    
    /**/
    select @OpName = formatmessage(150442)
    select @OpParams = N'StartTime=' + @StartTime + ',' +
                       N'EndTime=' + @EndTime + ',' +
                       N'ContractNo=' + @ContractNo + ',' +
                       N'OriginalContractNo=' + @OriginalContractNo + ',' +
                       N'DestCountry=' + @DestCountry + ',' +
                       N'DestProvince=' + @DestProvince + ',' + 
                       N'DestCity=' + @DestCity + ',' +
                       N'CarNo=' + @CarNo + ',' +
                       N'OrganId=' + @OrganId
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadApproveContractsOwnOrgansByTimespan 
@StartTime nvarchar(10),
@EndTime nvarchar(10),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @StaffId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @StaffId = StaffId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end
    
    /**/
    select 
        * 
    from 
        Organization 
    where 
        Id in 
        (
            select
                OwnOrganId
            from 
                DeliverPlan
            where 
                Id in
                (
                    select 
                        PlanId
                    from 
                        ContractDeliverPlan
                    where 
                        ContractId in
                        (
                            select 
                                Id 
                            from 
                                Contract
                            where 
                                ApproverId = @StaffId and 
                                ApproveState = formatmessage(150283) and 
                                ContractState = formatmessage(150242) and 
                                PrintState = 1 and
                                convert(nvarchar(10),ShipmentTime,120) >= @StartTime and 
                                convert(nvarchar(10),ShipmentTime,120) <= @EndTime
                        )
                )
        )
            
    
    /**/
    select @OpName = formatmessage(150675)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadApproveDeliverPlans 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @AccountType nvarchar(20)
declare @OrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from DeliverPlan where DisposerId in (select StaffId from Account where Id = @OpStaffId) and PlanState = formatmessage(150283)

    
    /**/
    select @OpName = formatmessage(150294)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadApproveFlowNextStepsByFlowTypeAndStepNum 
@FlowType nvarchar(50),
@StepNum int,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    

    /**/
    select * from ApproveFlowStep where StepNum > @StepNum and FlowType = @FlowType order by StepNum
    
   
    /**/
    set @OpName = formatmessage(150531)
    set @OpParams = N'StepNum=' + convert(nvarchar,@StepNum) + N',' +
                    N'FlowType=' + @FlowType 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadApproveFlowStep 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    select * from ApproveFlowStep where Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150137,18,1)
        return -1
    end
    
    /**/
    set @OpName = formatmessage(150138)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadApproveFlowStepConditionsByFlowType 
@FlowType nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select * from ApproveFlowStepCondition where FlowType = @FlowType order by ConditionNum
    
    /**/
    set @OpName = formatmessage(150286)
    set @OpParams = N'FlowType=' + @FlowType 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadApproveFlowStepConditionsByStepId 
@StepId bigint, 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    select * from ApproveFlowStepCondition where StepId = @StepId order by ConditionNum
    
   
    /**/
    set @OpName = formatmessage(150139)
    set @OpParams = N'StepId=' + convert(nvarchar,@StepId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadApproveFlowStepsByFlowType 
@FlowType nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    

    /**/
    select *, N'' as Conditions from ApproveFlowStep where FlowType = @FlowType order by StepNum
    
    
    /**/
    set @OpName = formatmessage(150285)
    set @OpParams = N'FlowType=' + @FlowType 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarByCarNo 
@CarNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select cc.* from CarrierCar cc where cc.CarNo = @CarNo 
    
    /**/
    select @OpName = formatmessage(150233)
    select @OpParams = N'CarNo=' + @CarNo  
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarrier 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Carrier where Id = @Id 
    
    if @@rowcount=0
    begin
        raiserror (150205,18,1)
        return -1
    end
    
    
    /**/
    select @OpName = formatmessage(150206)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadCarrierByCarNo 
@CarNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Carrier where Id in (select CarrierId from CarrierCar where CarNo = @CarNo)
    
    
    /**/
    select @OpName = formatmessage(150311)
    select @OpParams = N'CarNo=' + @CarNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarrierByName 
@Name nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Carrier where Name = @Name 
    
    
    /**/
    select @OpName = formatmessage(150496)
    select @OpParams = N'Name=' + @Name 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarrierCars 
@CarrierId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from CarrierCar where CarrierId = @CarrierId 
    
    /**/
    select @OpName = formatmessage(150197)
    select @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarrierCarsByName 
@CarrierName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        r.* 
    from 
        CarrierCar r join 
        Carrier c on r.CarrierId = c.Id 
    where 
        c.Name = @CarrierName 

    
    /**/
    select @OpName = formatmessage(150197)
    select @OpParams = N'CarrierName=' + @CarrierName
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarrierDrivers 
@CarrierId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from CarrierDriver where CarrierId = @CarrierId 
    
    /**/
    select @OpName = formatmessage(150214)
    select @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarrierSettlementExpression 
@CarrierId bigint,
@PlanType nvarchar(10),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from CarrierSettlementExpression where CarrierId = @CarrierId and PlanType = @PlanType 
    
    
    /**/
    select @OpName = formatmessage(150338)
    select @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                       N'PlanType=' + @PlanType 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarrierSettlementExpressions 
@CarrierId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from CarrierSettlementExpression where CarrierId = @CarrierId 
    
    
    /**/
    select @OpName = formatmessage(150334)
    select @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarrierStatementByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@StartCountry nvarchar(50),
@StartProvince nvarchar(50),
@StartCity nvarchar(50),
@DestCountry nvarchar(50),
@DestProvince nvarchar(50),
@DestCity nvarchar(50),
@CarrierName nvarchar(50),
@CarNo nvarchar(50),
@DeliverBillReceiptReceived nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    set @Sql = '
        select 
	        r1.Id,
            r1.DeliverBillNo,
            r1.DispatchBillId,
            r1.PlanId,
            r1.DeliveryNo,
	        r1.CarrierId,
	        r1.CarrierName,
	        r1.CreateTime,
	        r1.CarNo,
	        r1.StartCity,
	        r1.ReceiverCity,
	        r1.TotalPackages,
	        r1.TotalTunnages,
	        r1.TotalPiles,
	        r1.TotalTenThousands,
            case when dbctp.TransportCharges is null then r1.TransportCharges else dbctp.TransportCharges end as TransportCharges,
            r1.Remark,
            dbctp.Remark as Remark2,
	        r1.DeliverBillReceiptReceived,
            r1.DamageInfo 
        from 
	        (
		        select 
			        db.Id,
                    db.BillNo as DeliverBillNo,
                    db.DispatchBillId,
                    db.PlanId,
                    db.DeliveryNo,
                    db.CarrierId,
                    db.CarrierName,
			        convert(nvarchar(10),db.CreateTime,120) as CreateTime,
			        db.CarNo,
			        dp.StartCountry,
			        dp.StartProvince,
			        dp.StartCity,
			        db.ReceiverCountry,
			        db.ReceiverProvince,
			        db.ReceiverCity,
			        dg.TotalPackages,
			        dg.TotalTunnages,
			        dg.TotalPiles,
			        dg.TotalTenThousands,
                    dbdp.TransportCharges,
                    dbdp.Remark,
			        cast((case when db.ReturnTime is null then 0 else 1 end) as bit) as DeliverBillReceiptReceived,
			        db.OwnOrganId,
                    dp.ReceiveType,
                    db.DamageInfo 
		        from 
			        DeliverBill db join 
			        (
				        select 
					        DeliverBillId,
					        sum(Packages) as TotalPackages,
					        sum(Tunnages) as TotalTunnages,
					        sum(Piles) as TotalPiles,
					        sum(TenThousands) as TotalTenThousands
				        from 
					        DeliverBillGoods 
				        group by 
					        DeliverBillId 
			        ) as dg on db.Id = dg.DeliverBillId join 
			        (
				        select 
					        Id,
					        StartCountry,
					        StartProvince,
					        StartCity,
                            ReceiveType
				        from 
					        DeliverPlan 
			        ) as dp on db.PlanId = dp.Id join 
			        (
				        select 
                            DispatchBillId, 
                            PlanId, 
                            TransportCharges,
                            Remark
                        from 
                            DispatchBillDeliverPlan 
			        ) as dbdp on db.DispatchBillId = dbdp.DispatchBillId and db.PlanId = dbdp.PlanId 
	        ) as r1 left join 
            DeliverBillCarrierTransportPrice dbctp on r1.Id = dbctp.DeliverBillId '
    
    set @Sql = @Sql + ' where (r1.OwnOrganId in (select Id from Organization where FullPath like (select o.FullPath + ''%'' from Account a join Organization o on a.OrganId = o.Id where a.Id = ' + convert(nvarchar,@OpStaffId) + ' and a.AccountType = ''' + formatmessage(150162) + ''' and a.IsCancel = 0))) '
    
    /**/
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.Id not in (select DeliverBillId from CarrierTransportChargesSettlementDetail))'
    end
    
    /**/
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CarrierId in (select Id from Carrier where PaymentType = ''' + formatmessage(150238) + '''))'
    end
    
    /**/
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.ReceiveType <> ''' + formatmessage(150347) + ''')'
    end
    
    /**/
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.DispatchBillId not in (select DispatchBillId from Contract where IsPrestowage = 1))'
    end
    
    /**/
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.DispatchBillId not in (select DispatchBillId from Contract where IsPrestowage = 0 and (ContractState = formatmessage(150241) or ApproveState = formatmessage(150283))))'
    end
    
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CreateTime >= ''' + @StartTime + ''')'
    end
    
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CreateTime <= ''' + @EndTime + ''')'
    end
    
    if @StartCountry is not null and @StartCountry <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.StartCountry = ''' + @StartCountry + ''')'
    end

    if @StartProvince is not null and @StartProvince <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.StartProvince = ''' + @StartProvince + ''')'
    end

    if @StartCity is not null and @StartCity <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.StartCity = ''' + @StartCity + ''')'
    end

    if @DestCountry is not null and @DestCountry <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.ReceiverCountry = ''' + @DestCountry + ''')'
    end

    if @DestProvince is not null and @DestProvince <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.ReceiverProvince = ''' + @DestProvince + ''')'
    end

    if @DestCity is not null and @DestCity <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.ReceiverCity = ''' + @DestCity + ''')'
    end

    if @CarrierName is not null and @CarrierName <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CarrierName = ''' + @CarrierName + ''')'
    end

    if @CarNo is not null and @CarNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CarNo = ''' + @CarNo + ''')'
    end

    if cast(@DeliverBillReceiptReceived as bit) = 1 
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.DeliverBillReceiptReceived = 1)'
    end
    
    
    /**/
    exec(@Sql)
    
    if @@error <> 0
    begin
        raiserror (150494,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150495)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'StartCountry=' + @StartCountry + N',' +
                       N'StartProvince=' + @StartProvince + N',' +
                       N'StartCity=' + @StartCity + N',' +
                       N'DestCountry=' + @DestCountry + N',' +
                       N'DestProvince=' + @DestProvince + N',' +
                       N'DestCity=' + @DestCity + N',' +
                       N'CarrierName=' + @CarrierName + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'DeliverBillReceiptReceived=' + @DeliverBillReceiptReceived 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadCarrierTransportChargesSettlementDetails 
@CarrierTransportChargesSettlementId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        csd.Id,
        csd.CarrierTransportChargesSettlementId,
        csd.DeliverBillId,
        r0.DeliverBillNo,
        r0.CarrierId,
        r0.CarrierName,
        r0.CreateTime,
        r0.CarNo,
        r0.StartCountry,
        r0.StartProvince,
        r0.StartCity,
        r0.ReceiverCountry,
        r0.ReceiverProvince,
        r0.ReceiverCity,
        r0.TotalPackages as Packages,
        r0.TotalTunnages as Tunnages,
        r0.TotalPiles as Piles,
        r0.TotalTenThousands as TenThousands,
        csd.TransportCharges,
        r0.DamageInfo 
    from 
        CarrierTransportChargesSettlementDetail csd join 
        (
            select 
	            db.Id,
                db.BillNo as DeliverBillNo,
	            db.CarrierId,
	            db.CarrierName,
	            convert(nvarchar(10),db.CreateTime,120) as CreateTime,
	            db.CarNo,
	            dp.StartCountry,
	            dp.StartProvince,
	            dp.StartCity,
	            db.ReceiverCountry,
	            db.ReceiverProvince,
	            db.ReceiverCity,
	            dg.TotalPackages,
	            dg.TotalTunnages,
	            dg.TotalPiles,
	            dg.TotalTenThousands,
                db.DamageInfo 
	        from 
	            DeliverBill db join 
	            (
		            select 
			            DeliverBillId,
			            sum(Packages) as TotalPackages,
			            sum(Tunnages) as TotalTunnages,
			            sum(Piles) as TotalPiles,
			            sum(TenThousands) as TotalTenThousands
		            from 
			            DeliverBillGoods 
		            group by 
			            DeliverBillId 
	            ) as dg on db.Id = dg.DeliverBillId join 
	            (
		            select 
			            Id,
			            StartCountry,
			            StartProvince,
			            StartCity
		            from 
			            DeliverPlan 
	            ) as dp on db.PlanId = dp.Id 
        ) as r0 on csd.DeliverBillId = r0.Id 
    where 
        csd.CarrierTransportChargesSettlementId = @CarrierTransportChargesSettlementId
    
    
    /**/
    select @OpName = formatmessage(150504)
    select @OpParams = N'CarrierTransportChargesSettlementId=' + convert(nvarchar,@CarrierTransportChargesSettlementId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarrierTransportChargesSettlementsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@CarrierName nvarchar(50),
@CarNo nvarchar(50),
@DeliverBillNo nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = 'select * from CarrierTransportChargesSettlement '
    set @WhereSql = ''

    if @StartTime is not null and @StartTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),CreateTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),CreateTime,120) <= ''' + @EndTime + ''')'
    end
    
    if @CarrierName is not null and @CarrierName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(CarrierName = ''' + @CarrierName + ''')'
    end
    
    if @CarNo is not null and @CarNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(CarrierId in (select CarrierId from CarrierCar where CarNo = ''' + @CarNo + '''))'
    end

    if @DeliverBillNo is not null and @DeliverBillNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Id in (select distinct csd.CarrierTransportChargesSettlementId from CarrierTransportChargesSettlementDetail csd join DeliverBill db on csd.DeliverBillId = db.Id where db.BillNo = ''' + @DeliverBillNo + '''))'
    end
    
    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    set @SelectSql = @SelectSql + ' order by Id '
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150502,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150503)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'CarrierName=' + @CarrierName + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'DeliverBillNo=' + @DeliverBillNo 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadCarrierTransportPrice 
@CarrierId bigint,
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@DestCountry nvarchar(20),
@DestProvince nvarchar(20),
@DestCity nvarchar(20),
@PlanType nvarchar(10),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        * 
    from 
        CarrierTransportPrice
    where 
        CarrierId = @CarrierId and 
        StartCountry = @StartCountry and 
        StartProvince = @StartProvince and 
        StartCity = @StartCity and 
        DestCountry = @DestCountry and 
        DestProvince = @DestProvince and 
        DestCity = @DestCity and 
        PlanType = @PlanType and 
        convert(nvarchar(10),StartTime,120) <= convert(nvarchar(10),@CreateTime,120) and 
        convert(nvarchar(10),EndTime,120) >= convert(nvarchar(10),@CreateTime,120)


    /**/
    select @OpName = formatmessage(150312)
    select @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                       N'StartCountry=' + @StartCountry + N',' +
                       N'StartProvince=' + @StartProvince + N',' +
                       N'StartCity=' + @StartCity + N',' +
                       N'DestCountry=' + @DestCountry + N',' +
                       N'DestProvince=' + @DestProvince + N',' +
                       N'DestCity=' + @DestCity + N',' +
                       N'PlanType=' + @PlanType + N',' +
                       N'CreateTime=' + convert(nvarchar(10),@CreateTime,120)
                       
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarrierTransportPrices 
@CarrierId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from CarrierTransportPrice where CarrierId = @CarrierId 
    
    
    /**/
    select @OpName = formatmessage(150198)
    select @OpParams = N'CarrierId=' + convert(nvarchar,@CarrierId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarriers 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Carrier 
    
    /**/
    select @OpName = formatmessage(150196)
    select @OpParams = N''
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarriersByConditions 
@Name nvarchar(50),
@CarNo nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = 'select * from Carrier '
    set @WhereSql = ''
    
    if @Name is not null and @Name <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Name like ''%' + @Name + '%'')'
    end

    if @CarNo is not null and @CarNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Id in (select CarrierId from CarrierCar where CarNo like ''%' + @CarNo + '%''))'
    end

    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    
    exec (@SelectSql)
    
    
    /**/
    select @OpName = formatmessage(150626)
    select @OpParams = N'Name=' + @Name + N',' +
                       N'CarNo=' + @CarNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCars 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from CarrierCar 
    
    /**/
    select @OpName = formatmessage(150230)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCarsByCarNo 
@CarNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select distinct * from CarrierCar where CarNo like ('%'+ @CarNo + '%')
    
    /**/
    select @OpName = formatmessage(150233)
    select @OpParams = N'CarNo=' + @CarNo  
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
*******************************************************************************************/
create procedure LoadCity
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from City where Id = @Id
	if @@rowcount = 0
	begin
		raiserror (150044,18,1)
        return -1
    end

    /**/
    select @OpName = formatmessage(150045)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
*******************************************************************************************/
create procedure LoadCitys
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from City order by CountryName,ProvinceName,Name

	/**/
	select @OpName = formatmessage(150043)
    select @OpParams = N'' 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @CountryName
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure LoadCitysByCountry 
@CountryName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from City where CountryName = @CountryName order by Name
    

    /**/
    select @OpName = formatmessage(150173)
    select @OpParams = N'CountryName=' + @CountryName 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @CountryName
 * @ProvinceName
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure LoadCitysByProvince 
@CountryName nvarchar(50),
@ProvinceName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from City where CountryName = @CountryName and ProvinceName = @ProvinceName order by Name
    

    /**/
    select @OpName = formatmessage(150090)
    select @OpParams = N'CountryName=' + @CountryName + N',' +
                       N'ProvinceName=' + @ProvinceName 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadConsigningDeliverPlanDeliverGoodsByConditions 
@ConsignedDeliveryNo nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @ConsignedDeliveryNo2 nvarchar(20)
declare @GoodsId bigint
declare @BatchNo nvarchar(20)
declare @EnterWarehousePackages int
declare @EnterWarehouseTunnages numeric(25,9)
declare @TotalOutWarehousePackages int
declare @TotalOutWarehouseTunnages numeric(25,9)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    create table #LoadConsigningDeliverPlanDeliverGoodsByConditions 
    (
	    Id bigint identity(1,1),
        ConsignedDeliveryNo nvarchar(20),
        GoodsId bigint,
        GoodsName nvarchar(50),
        GoodsNo nvarchar(20),
        Brand nvarchar(20),
        SpecModel nvarchar(50),
        GWeight nvarchar(20),
        Grade nvarchar(10),
        PieceWeight numeric(25,9),
        BatchNo nvarchar(20),
        ProductionDate nvarchar(10),
        Warehouse nvarchar(20),
	    CreateTime nvarchar(10),
        OutWarehouseBillNo nvarchar(20),
        DeliveryNo nvarchar(20),
        ReceiverName nvarchar(50),
        Packages int,
        Tunnages numeric(25,9),
        EnterWarehousePackages int,
        EnterWarehouseTunnages numeric(25,9),
        BalancePackages int,
        BalanceTunnages numeric(25,9)
    )
    
    /**/
    if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
    begin
        insert into #LoadConsigningDeliverPlanDeliverGoodsByConditions 
            (
                ConsignedDeliveryNo,
                GoodsId,
                GoodsName,
                GoodsNo,
                Brand,
                SpecModel,
                GWeight,
                Grade,
                PieceWeight,
                BatchNo,
                ProductionDate,
                Warehouse,
	            CreateTime,
                OutWarehouseBillNo,
                DeliveryNo,
                ReceiverName,
                Packages,
                Tunnages,
                EnterWarehousePackages,
                EnterWarehouseTunnages,
                BalancePackages,
                BalanceTunnages 
            )
        select 
			r0.ConsignedDeliveryNo,
			r0.GoodsId,
			r0.GoodsName,
			r0.GoodsNo,
			r0.Brand,
			r0.SpecModel,
			r0.GWeight,
			r0.Grade,
			r0.PieceWeight,
			r0.BatchNo,
			r0.ProductionDate,
			r0.Warehouse,
			convert(nvarchar(10),r0.CreateTime,120),
			r0.OutWarehouseBillNo,
			r0.DeliveryNo,
			r0.ReceiverName,
			r0.Packages,
			r0.Tunnages,
			r0.EnterWarehousePackages,
			r0.EnterWarehouseTunnages, 
			0,
			0
        from 
			(
				select 
					r1.ConsignedDeliveryNo,
					r1.GoodsId,
					r1.GoodsName,
					r1.GoodsNo,
					r1.Brand,
					r1.SpecModel,
					r1.GWeight,
					r1.Grade,
					r1.PieceWeight,
					r1.BatchNo,
					r1.ProductionDate,
					r1.Warehouse,
					r2.CreateTime,
					r2.OutWarehouseBillNo,
					r2.DeliveryNo,
					r2.ReceiverName,
					r2.Packages,
					r2.Tunnages,
					r1.EnterWarehousePackages,
					r1.EnterWarehouseTunnages
				from 
					(
						select 
							eb.DeliveryNo as ConsignedDeliveryNo,
							eg.GoodsId,
							eg.GoodsName,
							eg.GoodsNo,
							eg.Brand,
							eg.SpecModel,
							eg.GWeight,
							eg.Grade,
							eg.PieceWeight,
							eg.BatchNo,
							eg.ProductionDate,
							eb.Warehouse,
							sum(eg.Packages) as EnterWarehousePackages,
							sum(eg.Tunnages) as EnterWarehouseTunnages
						from 
							EnterWarehouseBillGoods eg join 
							EnterWarehouseBill eb on eg.EnterWarehouseBillId = eb.Id 
						where 
							eb.IsConsigning = 1 and 
							eb.DeliveryNo = @ConsignedDeliveryNo 
						group by 
							eb.DeliveryNo,
							eg.GoodsId,
							eg.GoodsName,
							eg.GoodsNo,
							eg.Brand,
							eg.SpecModel,
							eg.GWeight,
							eg.Grade,
							eg.PieceWeight,
							eg.BatchNo,
							eg.ProductionDate,
							eb.Warehouse
					) as r1 join 
					(
						select 
							ob.ConsignedDeliveryNo,
							og.GoodsId,
							og.GoodsName,
							og.GoodsNo,
							og.Brand,
							og.SpecModel,
							og.GWeight,
							og.Grade,
							og.BatchNo,
							ob.CreateTime,
							ob.BillNo as OutWarehouseBillNo,
							ob.DeliveryNo,
							ob.ReceiverName,
							sum(og.Packages) as Packages,
							sum(og.Tunnages) as Tunnages
						from 
							OutWarehouseBillGoods og join 
							OutWarehouseBill ob on og.OutWarehouseBillId = ob.Id 
						where 
                            ob.ConsignedDeliveryNo = @ConsignedDeliveryNo 
						group by 
							ob.ConsignedDeliveryNo,
							og.GoodsId,
							og.GoodsName,
							og.GoodsNo,
							og.Brand,
							og.SpecModel,
							og.GWeight,
							og.Grade,
							og.BatchNo,
							ob.CreateTime,
							ob.BillNo,
							ob.DeliveryNo,
							ob.ReceiverName 
					) as r2 on r1.ConsignedDeliveryNo = r2.ConsignedDeliveryNo and r1.GoodsId = r2.GoodsId and r1.BatchNo = r2.BatchNo 
				union 
				select 
					r3.ConsignedDeliveryNo,
					r3.GoodsId,
					r3.GoodsName,
					r3.GoodsNo,
					r3.Brand,
					r3.SpecModel,
					r3.GWeight,
					r3.Grade,
					r3.PieceWeight,
					r3.BatchNo,
					r3.ProductionDate,
					r3.Warehouse,
					null,
					null,
					null,
					null,
					null,
					null,
					r3.EnterWarehousePackages,
					r3.EnterWarehouseTunnages
				from 
					(
						select 
							eb.DeliveryNo as ConsignedDeliveryNo,
							eg.GoodsId,
							eg.GoodsName,
							eg.GoodsNo,
							eg.Brand,
							eg.SpecModel,
							eg.GWeight,
							eg.Grade,
							eg.PieceWeight,
							eg.BatchNo,
							eg.ProductionDate,
							eb.Warehouse,
							sum(eg.Packages) as EnterWarehousePackages,
							sum(eg.Tunnages) as EnterWarehouseTunnages
						from 
							EnterWarehouseBillGoods eg join 
							EnterWarehouseBill eb on eg.EnterWarehouseBillId = eb.Id 
						where 
							eb.IsConsigning = 1 and 
                            eb.DeliveryNo = @ConsignedDeliveryNo and 
							not exists
							(
								select 
									* 
								from 
									OutWarehouseBillGoods og join 
									OutWarehouseBill ob on og.OutWarehouseBillId = ob.Id 
								where 
									ob.ConsignedDeliveryNo = eb.DeliveryNo and 
									og.GoodsId = eg.GoodsId and 
									og.BatchNo = eg.BatchNo 
							)
						group by 
							eb.DeliveryNo,
							eg.GoodsId,
							eg.GoodsName,
							eg.GoodsNo,
							eg.Brand,
							eg.SpecModel,
							eg.GWeight,
							eg.Grade,
							eg.PieceWeight,
							eg.BatchNo,
							eg.ProductionDate,
							eb.Warehouse
					) as r3 
			) as r0 
        order by 
            r0.ConsignedDeliveryNo,
            r0.GoodsId,
            r0.CreateTime 
    end
    else
    begin
        insert into #LoadConsigningDeliverPlanDeliverGoodsByConditions 
            (
                ConsignedDeliveryNo,
                GoodsId,
                GoodsName,
                GoodsNo,
                Brand,
                SpecModel,
                GWeight,
                Grade,
                PieceWeight,
                BatchNo,
                ProductionDate,
                Warehouse,
	            CreateTime,
                OutWarehouseBillNo,
                DeliveryNo,
                ReceiverName,
                Packages,
                Tunnages,
                EnterWarehousePackages,
                EnterWarehouseTunnages,
                BalancePackages,
                BalanceTunnages 
            )
        select 
			r0.ConsignedDeliveryNo,
			r0.GoodsId,
			r0.GoodsName,
			r0.GoodsNo,
			r0.Brand,
			r0.SpecModel,
			r0.GWeight,
			r0.Grade,
			r0.PieceWeight,
			r0.BatchNo,
			r0.ProductionDate,
			r0.Warehouse,
			convert(nvarchar(10),r0.CreateTime,120),
			r0.OutWarehouseBillNo,
			r0.DeliveryNo,
			r0.ReceiverName,
			r0.Packages,
			r0.Tunnages,
			r0.EnterWarehousePackages,
			r0.EnterWarehouseTunnages, 
			0,
			0
        from 
			(
				select 
					r1.ConsignedDeliveryNo,
					r1.GoodsId,
					r1.GoodsName,
					r1.GoodsNo,
					r1.Brand,
					r1.SpecModel,
					r1.GWeight,
					r1.Grade,
					r1.PieceWeight,
					r1.BatchNo,
					r1.ProductionDate,
					r1.Warehouse,
					r2.CreateTime,
					r2.OutWarehouseBillNo,
					r2.DeliveryNo,
					r2.ReceiverName,
					r2.Packages,
					r2.Tunnages,
					r1.EnterWarehousePackages,
					r1.EnterWarehouseTunnages
				from 
					(
						select 
							eb.DeliveryNo as ConsignedDeliveryNo,
							eg.GoodsId,
							eg.GoodsName,
							eg.GoodsNo,
							eg.Brand,
							eg.SpecModel,
							eg.GWeight,
							eg.Grade,
							eg.PieceWeight,
							eg.BatchNo,
							eg.ProductionDate,
							eb.Warehouse,
							sum(eg.Packages) as EnterWarehousePackages,
							sum(eg.Tunnages) as EnterWarehouseTunnages
						from 
							EnterWarehouseBillGoods eg join 
							EnterWarehouseBill eb on eg.EnterWarehouseBillId = eb.Id 
						where 
							eb.IsConsigning = 1 and 
							eb.DeliveryNo is not null and 
                            eb.DeliveryNo <> '' 
						group by 
							eb.DeliveryNo,
							eg.GoodsId,
							eg.GoodsName,
							eg.GoodsNo,
							eg.Brand,
							eg.SpecModel,
							eg.GWeight,
							eg.Grade,
							eg.PieceWeight,
							eg.BatchNo,
							eg.ProductionDate,
							eb.Warehouse
					) as r1 join 
					(
						select 
							ob.ConsignedDeliveryNo,
							og.GoodsId,
							og.GoodsName,
							og.GoodsNo,
							og.Brand,
							og.SpecModel,
							og.GWeight,
							og.Grade,
							og.BatchNo,
							ob.CreateTime,
							ob.BillNo as OutWarehouseBillNo,
							ob.DeliveryNo,
							ob.ReceiverName,
							sum(og.Packages) as Packages,
							sum(og.Tunnages) as Tunnages
						from 
							OutWarehouseBillGoods og join 
							OutWarehouseBill ob on og.OutWarehouseBillId = ob.Id 
						where 
                            ob.ConsignedDeliveryNo is not null and 
                            ob.ConsignedDeliveryNo <> '' 
						group by 
							ob.ConsignedDeliveryNo,
							og.GoodsId,
							og.GoodsName,
							og.GoodsNo,
							og.Brand,
							og.SpecModel,
							og.GWeight,
							og.Grade,
							og.BatchNo,
							ob.CreateTime,
							ob.BillNo,
							ob.DeliveryNo,
							ob.ReceiverName 
					) as r2 on r1.ConsignedDeliveryNo = r2.ConsignedDeliveryNo and r1.GoodsId = r2.GoodsId and r1.BatchNo = r2.BatchNo 
				union 
				select 
					r3.ConsignedDeliveryNo,
					r3.GoodsId,
					r3.GoodsName,
					r3.GoodsNo,
					r3.Brand,
					r3.SpecModel,
					r3.GWeight,
					r3.Grade,
					r3.PieceWeight,
					r3.BatchNo,
					r3.ProductionDate,
					r3.Warehouse,
					null,
					null,
					null,
					null,
					null,
					null,
					r3.EnterWarehousePackages,
					r3.EnterWarehouseTunnages
				from 
					(
						select 
							eb.DeliveryNo as ConsignedDeliveryNo,
							eg.GoodsId,
							eg.GoodsName,
							eg.GoodsNo,
							eg.Brand,
							eg.SpecModel,
							eg.GWeight,
							eg.Grade,
							eg.PieceWeight,
							eg.BatchNo,
							eg.ProductionDate,
							eb.Warehouse,
							sum(eg.Packages) as EnterWarehousePackages,
							sum(eg.Tunnages) as EnterWarehouseTunnages
						from 
							EnterWarehouseBillGoods eg join 
							EnterWarehouseBill eb on eg.EnterWarehouseBillId = eb.Id 
						where 
							eb.IsConsigning = 1 and 
                            eb.DeliveryNo is not null and 
                            eb.DeliveryNo <> '' and 
							not exists
							(
								select 
									* 
								from 
									OutWarehouseBillGoods og join 
									OutWarehouseBill ob on og.OutWarehouseBillId = ob.Id 
								where 
									ob.ConsignedDeliveryNo = eb.DeliveryNo and 
									og.GoodsId = eg.GoodsId and 
									og.BatchNo = eg.BatchNo 
							)
						group by 
							eb.DeliveryNo,
							eg.GoodsId,
							eg.GoodsName,
							eg.GoodsNo,
							eg.Brand,
							eg.SpecModel,
							eg.GWeight,
							eg.Grade,
							eg.PieceWeight,
							eg.BatchNo,
							eg.ProductionDate,
							eb.Warehouse
					) as r3 
			) as r0 
        order by 
            r0.ConsignedDeliveryNo,
            r0.GoodsId,
            r0.CreateTime 
    end

    /**/
    declare Cursor1 cursor local for 
        select 
            Id, ConsignedDeliveryNo, GoodsId, BatchNo, EnterWarehousePackages, EnterWarehouseTunnages 
        from 
            #LoadConsigningDeliverPlanDeliverGoodsByConditions 
    
    open Cursor1
    fetch next from Cursor1 into @Id, @ConsignedDeliveryNo2, @GoodsId, @BatchNo, @EnterWarehousePackages, @EnterWarehouseTunnages 
    while @@fetch_status = 0
    begin
        select 
            @TotalOutWarehousePackages = isnull(sum(Packages),0), 
            @TotalOutWarehouseTunnages = isnull(sum(Tunnages),0.0) 
        from 
            #LoadConsigningDeliverPlanDeliverGoodsByConditions 
        where 
            ConsignedDeliveryNo = @ConsignedDeliveryNo2 and 
            GoodsId = @GoodsId and 
            BatchNo = @BatchNo and 
            Id <= @Id 
            
        update #LoadConsigningDeliverPlanDeliverGoodsByConditions set 
            BalancePackages = @EnterWarehousePackages - @TotalOutWarehousePackages,
            BalanceTunnages = @EnterWarehouseTunnages - @TotalOutWarehouseTunnages 
        where 
            Id = @Id 

        fetch next from Cursor1 into @Id, @ConsignedDeliveryNo2, @GoodsId, @BatchNo, @EnterWarehousePackages, @EnterWarehouseTunnages 
    end 
        
    close Cursor1
    deallocate Cursor1 
    
    
    select * from #LoadConsigningDeliverPlanDeliverGoodsByConditions
    
    /**/
    select @OpName = formatmessage(150478)
    select @OpParams = N'ConsignedDeliveryNo=' + @ConsignedDeliveryNo 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadContract 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Contract where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150140,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150141)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadContractApproveComments 
@ContractId bigint,
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from ContractApproveComment where ContractId = @ContractId and PlanId = @PlanId    
    
    /**/
    select @OpName = formatmessage(150615)
    select @OpParams = N'ContractId=' + convert(nvarchar,@ContractId) + N',' +
                       N'PlanId=' + convert(nvarchar,@PlanId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadContractDeliverPlans 
@ContractId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    select 
        r0.*,
        isnull(dbctp.TransportPrice,0.0) as DeliverBillCarrierTransportPrice,
        isnull(dbctp.TransportCharges,0.0) as DeliverBillCarrierTransportCharges,
        case when dbctp.TransportPrice is not null then dbctp.TransportPrice else (case when r0.ApprovedTransportPrice is not null then r0.ApprovedTransportPrice else r0.TransportPrice end) end as FinalTransportPrice,
        case when dbctp.TransportCharges is not null then dbctp.TransportCharges else (case when r0.ApprovedTransportCharges is not null then r0.ApprovedTransportCharges else r0.TransportCharges end) end as FinalTransportCharges
    from 
        (
            select 
                r1.*,
                isnull(ctp.TransportPrice, 0.00) as AgreementTransportPrice,
                case when cr.PaymentType = formatmessage(150238) then isnull(ctp.TransportPrice, 0.00) else (case when tlp1.TransportPrice is null then isnull(tlp2.TransportPrice, 0.00) else tlp1.TransportPrice end) end as LimitedTransportPrice,
                case when cr.PaymentType = formatmessage(150238) then 0.00 else (case when tlp1.TransportCharges is null then isnull(tlp2.TransportCharges, 0.00) else tlp1.TransportCharges end) end as LimitedTransportCharges,
                cast(case when db.ReturnTime is null then 0 else 1 end as bit) as DeliverBillReceiptReceived,
                db.Id as DeliverBillId,
                db.DamageInfo
            from 
                (
                    select 
                        cdp.*, 
                        c.DispatchBillId,
                        c.CarrierId,
                        c.CarType,
                        dp.PlanNo, 
                        dp.PlanType, 
                        dp.CustomerId, 
                        dp.CustomerName,
                        dp.ShipmentNo,
                        dp.DeliveryNo,
                        dp.ReceiverName,
                        dp.ReceiverCountry,
                        dp.ReceiverProvince,
                        dp.ReceiverCity,
                        dp.ReceiverAddress,
                        dp.ReceiveType, 
                        dp.StartCountry, 
                        dp.StartProvince, 
                        dp.StartCity,
                        dp.CreateTime
                    from 
                        ContractDeliverPlan cdp join 
                        Contract c on cdp.ContractId = c.Id join 
                        DeliverPlan dp on cdp.PlanId = dp.Id 
                    where 
                        cdp.ContractId = @ContractId
                ) as r1 
                join Carrier cr on 
                    cr.Id = r1.CarrierId
                left join CarrierTransportPrice ctp on 
                    ctp.CarrierId = r1.CarrierId and 
                    ctp.StartCountry = r1.StartCountry and 
                    ctp.StartProvince = r1.StartProvince and 
                    ctp.StartCity = r1.StartCity and 
                    ctp.DestCountry = r1.ReceiverCountry and 
                    ctp.DestProvince = r1.ReceiverProvince and 
                    ctp.DestCity = r1.ReceiverCity and 
                    ctp.PlanType = r1.PlanType and 
                    convert(nvarchar(10),ctp.StartTime,120) <= convert(nvarchar(10),r1.CreateTime,120) and 
                    convert(nvarchar(10),ctp.EndTime,120) >= convert(nvarchar(10),r1.CreateTime,120)
                left join TransportLimitedPrice tlp1 on 
                    tlp1.PlanType = r1.PlanType and 
                    tlp1.StartCountry = r1.StartCountry and 
                    tlp1.StartProvince = r1.StartProvince and 
                    tlp1.StartCity = r1.StartCity and 
                    tlp1.DestCountry = r1.ReceiverCountry and 
                    tlp1.DestProvince = r1.ReceiverProvince and 
                    tlp1.DestCity = r1.ReceiverCity and 
                    (
                        (tlp1.PlanType <> formatmessage(150257) and tlp1.PlanType <> formatmessage(150619) and r1.Tunnages >= tlp1.MinTunnagesOrPiles and r1.Tunnages < tlp1.MaxTunnagesOrPiles) or
                        ((tlp1.PlanType = formatmessage(150257) or tlp1.PlanType = formatmessage(150619)) and r1.Piles >= tlp1.MinTunnagesOrPiles and r1.Piles < tlp1.MaxTunnagesOrPiles)
                    ) and 
                    (
                        tlp1.CarType is not null and tlp1.CarType <> '' and tlp1.CarType = r1.CarType
                    ) and 
                    convert(nvarchar(10),tlp1.StartTime,120) <= convert(nvarchar(10),r1.CreateTime,120) and 
                    convert(nvarchar(10),tlp1.EndTime,120) >= convert(nvarchar(10),r1.CreateTime,120)
                left join TransportLimitedPrice tlp2 on 
                    tlp2.PlanType = r1.PlanType and 
                    tlp2.StartCountry = r1.StartCountry and 
                    tlp2.StartProvince = r1.StartProvince and 
                    tlp2.StartCity = r1.StartCity and 
                    tlp2.DestCountry = r1.ReceiverCountry and 
                    tlp2.DestProvince = r1.ReceiverProvince and 
                    tlp2.DestCity = r1.ReceiverCity and 
                    (
                        (tlp2.PlanType <> formatmessage(150257) and tlp2.PlanType <> formatmessage(150619) and r1.Tunnages >= tlp2.MinTunnagesOrPiles and r1.Tunnages < tlp2.MaxTunnagesOrPiles) or
                        ((tlp2.PlanType = formatmessage(150257) or tlp2.PlanType = formatmessage(150619)) and r1.Piles >= tlp2.MinTunnagesOrPiles and r1.Piles < tlp2.MaxTunnagesOrPiles)
                    ) and 
                    (
                        tlp2.CarType is null or tlp2.CarType = '' 
                    ) and 
                    convert(nvarchar(10),tlp2.StartTime,120) <= convert(nvarchar(10),r1.CreateTime,120) and 
                    convert(nvarchar(10),tlp2.EndTime,120) >= convert(nvarchar(10),r1.CreateTime,120)
                left join DeliverBill db on 
                    db.DispatchBillId = r1.DispatchBillId and 
                    db.PlanId = r1.PlanId 
        ) as r0 
        left join DeliverBillCarrierTransportPrice dbctp on
            r0.DeliverBillId = dbctp.DeliverBillId
    
    
    /**/
    select @OpName = formatmessage(150144)
    select @OpParams = N'ContractId=' + convert(nvarchar,@ContractId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadContractDispatchBills 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @OwnOrganId = OrganId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end

    /**/
    select 
        * 
    from 
        DispatchBill 
    where 
        BillState = formatmessage(150242) and
        Id not in (select DispatchBillId from ShipmentBill where BillState = formatmessage(150241)) and
        Id not in (select DispatchBillId from DeliverBill where PrintState = 0) and 
        Id not in (select DispatchBillId from Contract where IsPrestowage = 1) and 
        Id in (select DispatchBillId from DispatchBillDeliverPlan where PlanId in (select Id from DeliverPlan where ReceiveType = formatmessage(150348))) and
        CarrierId not in (select Id from Carrier where PaymentType = formatmessage(150238))
        
    
    /**/
    select @OpName = formatmessage(150433)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadContractFinesByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@CreatorId nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = 'select * from Contract '
    set @WhereSql = '(FineAmount > 0)'

    if @StartTime is not null and @StartTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),FineTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),FineTime,120) <= ''' + @EndTime + ''')'
    end

    if @CreatorId is not null and @CreatorId <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(CreatorId in (select Id from Account where AccountType = ''' + formatmessage(150162) + ''' and StaffId = ' + @CreatorId + '))'
    end
    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    set @SelectSql = @SelectSql + ' order by FineTime '
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150515,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150516)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'CreatorId=' + @CreatorId 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadContractPriceOverAmount 
@ContractId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OverAmount numeric(25,9)
declare @MaxOverAmount1 numeric(25,9)/**/
declare @MaxOverAmount2 numeric(25,9)/**/
declare @CarType nvarchar(10)
declare @PlanId bigint
declare @Tunnages numeric(25,9)
declare @Piles numeric(25,9)
declare @TransportPrice numeric(25,9)
declare @TransportCharges numeric(25,9)
declare @PlanType nvarchar(10)
declare @StartCountry nvarchar(20)
declare @StartProvince nvarchar(20)
declare @StartCity nvarchar(20)
declare @DestCountry nvarchar(20)
declare @DestProvince nvarchar(20)
declare @DestCity nvarchar(20)
declare @LimitedTransportPrice numeric(25,9)
declare @LimitedTransportCharges numeric(25,9)
declare @CreateTime datetime
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    set @MaxOverAmount1 = 0
    set @MaxOverAmount2 = 0
    
    if exists(select * from Carrier where PaymentType = formatmessage(150238) and Id in (select CarrierId from Contract where Id = @ContractId))
    begin
        /***************************************************************************************************************************************/
        /*1.*/
        declare Cursor1 cursor local for 
            select PlanId, TransportPrice, TransportCharges from ContractDeliverPlan where ContractId = @ContractId
            
        open Cursor1
        fetch next from Cursor1 into @PlanId, @TransportPrice, @TransportCharges 
        while @@fetch_status = 0
        begin
            /**/
            select 
                @PlanType = PlanType,
                @StartCountry = StartCountry,
                @StartProvince = StartProvince,
                @StartCity = StartCity,
                @DestCountry = ReceiverCountry,
                @DestProvince = ReceiverProvince,
                @DestCity = ReceiverCity,
                @CreateTime = CreateTime
            from 
                DeliverPlan 
            where 
                Id = @PlanId 
        
            if @@rowcount = 0
            begin
                raiserror (150261,18,1)
                return -1
            end

            /**/
            select 
                @LimitedTransportPrice = TransportPrice 
            from 
                CarrierTransportPrice  
            where 
                CarrierId in (select CarrierId from Contract where Id = @ContractId) and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @DestCountry and 
                DestProvince = @DestProvince and 
                DestCity = @DestCity and 
                PlanType = @PlanType and 
                convert(nvarchar(10),@CreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                convert(nvarchar(10),@CreateTime,120) <= convert(nvarchar(10),EndTime,120)
       
            if @@rowcount = 0
            begin
                set @LimitedTransportPrice = 0
            end
        
            /**/
            if @LimitedTransportPrice = 0
            begin
                set @MaxOverAmount2 = @MaxOverAmount2 + @TransportCharges 
            end
            else
            begin
                set @OverAmount = @TransportCharges - @LimitedTransportPrice * (@TransportCharges / @TransportPrice)  
                set @MaxOverAmount2 = @MaxOverAmount2 + @OverAmount 
            end
   
            fetch next from Cursor1 into @PlanId, @TransportPrice, @TransportCharges 
        end 
        
        close Cursor1
        deallocate Cursor1
    end
    else
    begin
        /***************************************************************************************************************************************/
        /*2.*/
        select @CarType = CarType from Contract where Id = @ContractId 
        if @@rowcount = 0
        begin
            raiserror (150140,18,1)
            return -2
        end
    
        /***************************************************************************************************************************************/
        /*3.*/
        
        /*3.1.*/
        select 
            @Tunnages = isnull(sum(Tunnages),0.0), 
            @Piles = isnull(sum(Piles),0.0),
            @TransportCharges = isnull(sum(TransportCharges),0.0)
        from 
            ContractDeliverPlan 
        where 
            ContractId = @ContractId 
        
        /*3.2.*/
        set @LimitedTransportCharges = 0
        
        declare Cursor2 cursor local for 
            select PlanId from ContractDeliverPlan where ContractId = @ContractId
            
        open Cursor2
        fetch next from Cursor2 into @PlanId
        while @@fetch_status = 0
        begin
            /**/
            select 
                @PlanType = PlanType,
                @StartCountry = StartCountry,
                @StartProvince = StartProvince,
                @StartCity = StartCity,
                @DestCountry = ReceiverCountry,
                @DestProvince = ReceiverProvince,
                @DestCity = ReceiverCity,
                @CreateTime = CreateTime
            from 
                DeliverPlan 
            where 
                Id = @PlanId 
        
            if @@rowcount = 0
            begin
                raiserror (150261,18,1)
                return -3
            end

            /**/
            if @PlanType <> formatmessage(150257) and @PlanType <> formatmessage(150619)
            begin
                select 
                    @LimitedTransportCharges = (case when TransportCharges > @LimitedTransportCharges then TransportCharges else @LimitedTransportCharges end)
                from 
                    TransportLimitedPrice  
                where 
                    PlanType = @PlanType and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @Tunnages >= MinTunnagesOrPiles and 
                    @Tunnages < MaxTunnagesOrPiles and 
                    (
                        CarType is null or
                        CarType = '' or 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    ) and 
                    convert(nvarchar(10),@CreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                    convert(nvarchar(10),@CreateTime,120) <= convert(nvarchar(10),EndTime,120)
            end
            else
            begin
                select 
                    @LimitedTransportCharges = (case when TransportCharges > @LimitedTransportCharges then TransportCharges else @LimitedTransportCharges end)
                from 
                    TransportLimitedPrice  
                where 
                    PlanType = @PlanType and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @Piles >= MinTunnagesOrPiles and 
                    @Piles < MaxTunnagesOrPiles and 
                    (
                        CarType is null or
                        CarType = '' or 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    ) and 
                    convert(nvarchar(10),@CreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                    convert(nvarchar(10),@CreateTime,120) <= convert(nvarchar(10),EndTime,120)
            end
   
            fetch next from Cursor2 into @PlanId
        end 
        
        close Cursor2
        deallocate Cursor2
        
        /*3.3.*/
        if @LimitedTransportCharges > 0
        begin
            set @MaxOverAmount1 = @TransportCharges - @LimitedTransportCharges
        end
        
        
        /***************************************************************************************************************************************/
        /*4.*/
        declare Cursor3 cursor local for 
            select PlanId, Tunnages, Piles, TransportPrice, TransportCharges from ContractDeliverPlan where ContractId = @ContractId
            
        open Cursor3
        fetch next from Cursor3 into @PlanId, @Tunnages, @Piles, @TransportPrice, @TransportCharges 
        while @@fetch_status = 0
        begin
            /**/
            select 
                @PlanType = PlanType,
                @StartCountry = StartCountry,
                @StartProvince = StartProvince,
                @StartCity = StartCity,
                @DestCountry = ReceiverCountry,
                @DestProvince = ReceiverProvince,
                @DestCity = ReceiverCity,
                @CreateTime = CreateTime
            from 
                DeliverPlan 
            where 
                Id = @PlanId 
        
            if @@rowcount = 0
            begin
                raiserror (150261,18,1)
                return -4
            end

            /**/
            if @PlanType <> formatmessage(150257) and @PlanType <> formatmessage(150619)
            begin
                select 
                    @LimitedTransportPrice = TransportPrice 
                from 
                    TransportLimitedPrice  
                where 
                    PlanType = @PlanType and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @Tunnages >= MinTunnagesOrPiles and 
                    @Tunnages < MaxTunnagesOrPiles and 
                    (
                        CarType is null or
                        CarType = '' or 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    ) and 
                    convert(nvarchar(10),@CreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                    convert(nvarchar(10),@CreateTime,120) <= convert(nvarchar(10),EndTime,120)
                        
                if @@rowcount = 0
                begin
                    set @LimitedTransportPrice = 0
                end
            end
            else
            begin
                select 
                    @LimitedTransportPrice = TransportPrice 
                from 
                    TransportLimitedPrice  
                where 
                    PlanType = @PlanType and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @Piles >= MinTunnagesOrPiles and 
                    @Piles < MaxTunnagesOrPiles and 
                    (
                        CarType is null or
                        CarType = '' or 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    ) and 
                    convert(nvarchar(10),@CreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                    convert(nvarchar(10),@CreateTime,120) <= convert(nvarchar(10),EndTime,120)
                       
                if @@rowcount = 0
                begin
                    set @LimitedTransportPrice = 0
                end
            end
        
            /**/
            if @LimitedTransportPrice = 0
            begin
                set @MaxOverAmount2 = @MaxOverAmount2 + @TransportCharges 
            end
            else
            begin
                set @OverAmount = @TransportCharges - @LimitedTransportPrice * (@TransportCharges / @TransportPrice)  
                set @MaxOverAmount2 = @MaxOverAmount2 + @OverAmount 
            end
    
            fetch next from Cursor3 into @PlanId, @Tunnages, @Piles, @TransportPrice, @TransportCharges 
        end 
        
        close Cursor3
        deallocate Cursor3
    end

    /**/
    if @MaxOverAmount1 > @MaxOverAmount2
    begin
        select @MaxOverAmount1
    end
    else
    begin
        select @MaxOverAmount2
    end
    

    /**/
    select @OpName = formatmessage(150523)
    select @OpParams = N'ContractId=' + convert(nvarchar,@ContractId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -5
    end
    
    return 0
end
go


create procedure LoadContractPriceOverPercentage 
@ContractId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OverPercentage numeric(25,9)
declare @MaxOverPercentage1 numeric(25,9)/**/
declare @MaxOverPercentage2 numeric(25,9)/**/
declare @CarType nvarchar(10)
declare @PlanId bigint
declare @Tunnages numeric(25,9)
declare @Piles numeric(25,9)
declare @TransportPrice numeric(25,9)
declare @TransportCharges numeric(25,9)
declare @PlanType nvarchar(10)
declare @StartCountry nvarchar(20)
declare @StartProvince nvarchar(20)
declare @StartCity nvarchar(20)
declare @DestCountry nvarchar(20)
declare @DestProvince nvarchar(20)
declare @DestCity nvarchar(20)
declare @LimitedTransportPrice numeric(25,9)
declare @LimitedTransportCharges numeric(25,9)
declare @CreateTime datetime
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    set @MaxOverPercentage1 = 0
    set @MaxOverPercentage2 = 0
    
    if exists(select * from Carrier where PaymentType = formatmessage(150238) and Id in (select CarrierId from Contract where Id = @ContractId))
    begin
        /***************************************************************************************************************************************/
        /*1.*/
        declare Cursor1 cursor local for 
            select PlanId, TransportPrice from ContractDeliverPlan where ContractId = @ContractId
            
        open Cursor1
        fetch next from Cursor1 into @PlanId, @TransportPrice 
        while @@fetch_status = 0
        begin
            /**/
            select 
                @PlanType = PlanType,
                @StartCountry = StartCountry,
                @StartProvince = StartProvince,
                @StartCity = StartCity,
                @DestCountry = ReceiverCountry,
                @DestProvince = ReceiverProvince,
                @DestCity = ReceiverCity,
                @CreateTime = CreateTime
            from 
                DeliverPlan 
            where 
                Id = @PlanId 
        
            if @@rowcount = 0
            begin
                raiserror (150261,18,1)
                return -1
            end

            /**/
            select 
                @LimitedTransportPrice = TransportPrice 
            from 
                CarrierTransportPrice  
            where 
                CarrierId in (select CarrierId from Contract where Id = @ContractId) and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @DestCountry and 
                DestProvince = @DestProvince and 
                DestCity = @DestCity and 
                PlanType = @PlanType and 
                convert(nvarchar(10),@CreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                convert(nvarchar(10),@CreateTime,120) <= convert(nvarchar(10),EndTime,120)
       
            if @@rowcount = 0
            begin
                set @LimitedTransportPrice = 0
            end
        
            /**/
            if @LimitedTransportPrice = 0
            begin
                if @MaxOverPercentage2 < 100 
                begin
                    set @MaxOverPercentage2 = 100
                end
            end
            else
            begin
                set @OverPercentage = ((@TransportPrice - @LimitedTransportPrice) / @LimitedTransportPrice) * 100
                if @OverPercentage > @MaxOverPercentage2 
                begin
                    set @MaxOverPercentage2 = @OverPercentage
                end
            end
   
            fetch next from Cursor1 into @PlanId, @TransportPrice 
        end 
        
        close Cursor1
        deallocate Cursor1
    end
    else
    begin
        /***************************************************************************************************************************************/
        /*2.*/
        select @CarType = CarType from Contract where Id = @ContractId 
        if @@rowcount = 0
        begin
            raiserror (150140,18,1)
            return -2
        end
    
        /***************************************************************************************************************************************/
        /*3.*/
        
        /*3.1.*/
        select 
            @Tunnages = isnull(sum(Tunnages),0.0), 
            @Piles = isnull(sum(Piles),0.0),
            @TransportCharges = isnull(sum(TransportCharges),0.0)
        from 
            ContractDeliverPlan 
        where 
            ContractId = @ContractId 
        
        /*3.2.*/
        set @LimitedTransportCharges = 0
        
        declare Cursor2 cursor local for 
            select PlanId from ContractDeliverPlan where ContractId = @ContractId
            
        open Cursor2
        fetch next from Cursor2 into @PlanId
        while @@fetch_status = 0
        begin
            /**/
            select 
                @PlanType = PlanType,
                @StartCountry = StartCountry,
                @StartProvince = StartProvince,
                @StartCity = StartCity,
                @DestCountry = ReceiverCountry,
                @DestProvince = ReceiverProvince,
                @DestCity = ReceiverCity,
                @CreateTime = CreateTime
            from 
                DeliverPlan 
            where 
                Id = @PlanId 
        
            if @@rowcount = 0
            begin
                raiserror (150261,18,1)
                return -3
            end

            /**/
            if @PlanType <> formatmessage(150257) and @PlanType <> formatmessage(150619)
            begin
                select 
                    @LimitedTransportCharges = (case when TransportCharges > @LimitedTransportCharges then TransportCharges else @LimitedTransportCharges end)
                from 
                    TransportLimitedPrice  
                where 
                    PlanType = @PlanType and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @Tunnages >= MinTunnagesOrPiles and 
                    @Tunnages < MaxTunnagesOrPiles and 
                    (
                        CarType is null or
                        CarType = '' or 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    ) and 
                    convert(nvarchar(10),@CreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                    convert(nvarchar(10),@CreateTime,120) <= convert(nvarchar(10),EndTime,120)
            end
            else
            begin
                select 
                    @LimitedTransportCharges = (case when TransportCharges > @LimitedTransportCharges then TransportCharges else @LimitedTransportCharges end)
                from 
                    TransportLimitedPrice  
                where 
                    PlanType = @PlanType and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @Piles >= MinTunnagesOrPiles and 
                    @Piles < MaxTunnagesOrPiles and 
                    (
                        CarType is null or
                        CarType = '' or 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    ) and 
                    convert(nvarchar(10),@CreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                    convert(nvarchar(10),@CreateTime,120) <= convert(nvarchar(10),EndTime,120)
            end
   
            fetch next from Cursor2 into @PlanId
        end 
        
        close Cursor2
        deallocate Cursor2
        
        /*3.3.*/
        if @LimitedTransportCharges > 0
        begin
            set @MaxOverPercentage1 = ((@TransportCharges - @LimitedTransportCharges) / @LimitedTransportCharges) * 100
        end
        
        
        /***************************************************************************************************************************************/
        /*4.*/
        declare Cursor3 cursor local for 
            select PlanId, Tunnages, Piles, TransportPrice from ContractDeliverPlan where ContractId = @ContractId
            
        open Cursor3
        fetch next from Cursor3 into @PlanId, @Tunnages, @Piles, @TransportPrice 
        while @@fetch_status = 0
        begin
            /**/
            select 
                @PlanType = PlanType,
                @StartCountry = StartCountry,
                @StartProvince = StartProvince,
                @StartCity = StartCity,
                @DestCountry = ReceiverCountry,
                @DestProvince = ReceiverProvince,
                @DestCity = ReceiverCity,
                @CreateTime = CreateTime
            from 
                DeliverPlan 
            where 
                Id = @PlanId 
        
            if @@rowcount = 0
            begin
                raiserror (150261,18,1)
                return -4
            end

            /**/
            if @PlanType <> formatmessage(150257) and @PlanType <> formatmessage(150619)
            begin
                select 
                    @LimitedTransportPrice = TransportPrice 
                from 
                    TransportLimitedPrice  
                where 
                    PlanType = @PlanType and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @Tunnages >= MinTunnagesOrPiles and 
                    @Tunnages < MaxTunnagesOrPiles and 
                    (
                        CarType is null or
                        CarType = '' or 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    ) and 
                    convert(nvarchar(10),@CreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                    convert(nvarchar(10),@CreateTime,120) <= convert(nvarchar(10),EndTime,120)
                        
                if @@rowcount = 0
                begin
                    set @LimitedTransportPrice = 0
                end
            end
            else
            begin
                select 
                    @LimitedTransportPrice = TransportPrice 
                from 
                    TransportLimitedPrice  
                where 
                    PlanType = @PlanType and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @Piles >= MinTunnagesOrPiles and 
                    @Piles < MaxTunnagesOrPiles and 
                    (
                        CarType is null or
                        CarType = '' or 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    ) and 
                    convert(nvarchar(10),@CreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                    convert(nvarchar(10),@CreateTime,120) <= convert(nvarchar(10),EndTime,120)
                       
                if @@rowcount = 0
                begin
                    set @LimitedTransportPrice = 0
                end
            end
        
            /**/
            if @LimitedTransportPrice = 0
            begin
                if @MaxOverPercentage2 < 100 
                begin
                    set @MaxOverPercentage2 = 100
                end
            end
            else
            begin
                set @OverPercentage = ((@TransportPrice - @LimitedTransportPrice) / @LimitedTransportPrice) * 100
                if @OverPercentage > @MaxOverPercentage2
                begin
                    set @MaxOverPercentage2 = @OverPercentage
                end
            end
    
            fetch next from Cursor3 into @PlanId, @Tunnages, @Piles, @TransportPrice 
        end 
        
        close Cursor3
        deallocate Cursor3
    end

    /**/
    if @MaxOverPercentage1 > @MaxOverPercentage2
    begin
        select @MaxOverPercentage1
    end
    else
    begin
        select @MaxOverPercentage2
    end
    

    /**/
    select @OpName = formatmessage(150522)
    select @OpParams = N'ContractId=' + convert(nvarchar,@ContractId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -5
    end
    
    return 0
end
go


create procedure LoadContractReverseDetails 
@ContractId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        crd.*,
        cr.CreatorId,
        cr.CreatorName,
        cr.CreateTime 
    from 
        ContractReverseDetail crd join 
        ContractReverse cr on crd.ReverseId = cr.Id 
    where 
        crd.ContractId = @ContractId 
    
    
    /**/
    select @OpName = formatmessage(150447)
    select @OpParams = N'ContractId=' + convert(nvarchar,@ContractId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadContractReverseDetailsByReverseId 
@ReverseId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        crd.*,
        c.ContractNo,
        c.OriginalContractNo,
        c.GoodsName,
        c.StartPlace,
        c.DestPlace,
        c.ShipmentTime,
        c.CarNo,
        c.TrailerNo,
        c.DriverName,
        c.DriverMobileTel,
        c.TotalTunnages,
        c.TotalPiles,
        c.TotalTransportCharges 
    from 
        ContractReverseDetail crd join 
        Contract c on crd.ContractId = c.Id 
    where 
        crd.ReverseId = @ReverseId and 
		c.IsPrestowage = 1
    
    
    /**/
    select @OpName = formatmessage(150454)
    select @OpParams = N'ReverseId=' + convert(nvarchar,@ReverseId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadContractReversesByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@ContractNo nvarchar(50),
@OriginalContractNo nvarchar(50),
@CreatorId nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = 'select * from ContractReverse '
    set @WhereSql = ''
    
    if @StartTime is not null and @StartTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),CreateTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),CreateTime,120) <= ''' + @EndTime + ''')'
    end

    if @ContractNo is not null and @ContractNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Id in (select ReverseId from ContractReverseDetail where ContractId in (select Id from Contract where IsPrestowage = 1 and ContractNo = ''' + @ContractNo + ''')))'
    end
    
    if @OriginalContractNo is not null and @OriginalContractNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Id in (select ReverseId from ContractReverseDetail where ContractId in (select Id from Contract where IsPrestowage = 1 and OriginalContractNo = ''' + @OriginalContractNo + ''')))'
    end

    if @CreatorId is not null and @CreatorId <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(CreatorId = ' + @CreatorId + ')'
    end
    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    set @SelectSql = @SelectSql + ' order by CreateTime '
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150452,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150453)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'ContractNo=' + @ContractNo + N',' +
                       N'OriginalContractNo=' + @OriginalContractNo + N',' +
                       N'CreatorId=' + @CreatorId 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadContractsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@ContractNo nvarchar(50),
@OriginalContractNo nvarchar(50),
@StartCountry nvarchar(50),
@StartProvince nvarchar(50),
@StartCity nvarchar(50),
@DestCountry nvarchar(50),
@DestProvince nvarchar(50),
@DestCity nvarchar(50),
@CarNo nvarchar(50),
@OrganId nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @Sql2 nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    set @Sql = 'select 
	                c.*, 
	                isnull(r.ApproveCount,0) as ApproveCount
                from 
	                Contract c left join 
	                (
		                select 
			                ContractId, 
			                count(*) as ApproveCount 
		                from 
			                ContractApproveComment 
		                group by 
			                ContractId
	                ) as r on c.Id = r.ContractId'
    
    set @Sql2 = ''
    if @StartTime is not null and @StartTime <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(convert(nvarchar(10),c.ShipmentTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(convert(nvarchar(10),c.ShipmentTime,120) <= ''' + @EndTime + ''')'
    end
    
    if @ContractNo is not null and @ContractNo <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(c.ContractNo = ''' + @ContractNo + ''')'
    end

    if @OriginalContractNo is not null and @OriginalContractNo <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(c.OriginalContractNo = ''' + @OriginalContractNo + ''')'
    end
    
    if @StartCity is not null and @StartCity <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(c.Id in (select cdp.ContractId from ContractDeliverPlan cdp join DeliverPlan dp on cdp.PlanId = dp.Id where dp.StartCountry = ''' + @StartCountry + ''' and dp.StartProvince = ''' + @StartProvince + ''' and dp.StartCity = ''' + @StartCity + '''))'
    end
    else
    begin
        if @StartProvince is not null and @StartProvince <> ''
        begin
            if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
            set @Sql2 = @Sql2 + '(c.Id in (select cdp.ContractId from ContractDeliverPlan cdp join DeliverPlan dp on cdp.PlanId = dp.Id where dp.StartCountry = ''' + @StartCountry + ''' and dp.StartProvince = ''' + @StartProvince + '''))'
        end
        else
        begin
            if @StartCountry is not null and @StartCountry <> ''
            begin
                if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
                set @Sql2 = @Sql2 + '(c.Id in (select cdp.ContractId from ContractDeliverPlan cdp join DeliverPlan dp on cdp.PlanId = dp.Id where dp.StartCountry = ''' + @StartCountry + '''))'
            end
        end
    end

    if @DestCity is not null and @DestCity <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(c.Id in (select cdp.ContractId from ContractDeliverPlan cdp join DeliverPlan dp on cdp.PlanId = dp.Id where dp.ReceiverCountry = ''' + @DestCountry + ''' and dp.ReceiverProvince = ''' + @DestProvince + ''' and dp.ReceiverCity = ''' + @DestCity + '''))'
    end
    else
    begin
        if @DestProvince is not null and @DestProvince <> ''
        begin
            if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
            set @Sql2 = @Sql2 + '(c.Id in (select cdp.ContractId from ContractDeliverPlan cdp join DeliverPlan dp on cdp.PlanId = dp.Id where dp.ReceiverCountry = ''' + @DestCountry + ''' and dp.ReceiverProvince = ''' + @DestProvince + '''))'
        end
        else
        begin
            if @DestCountry is not null and @DestCountry <> ''
            begin
                if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
                set @Sql2 = @Sql2 + '(c.Id in (select cdp.ContractId from ContractDeliverPlan cdp join DeliverPlan dp on cdp.PlanId = dp.Id where dp.ReceiverCountry = ''' + @DestCountry + '''))'
            end
        end
    end
    
    if @CarNo is not null and @CarNo <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(c.CarNo = ''' + @CarNo + ''')'
    end

    if @OrganId is not null and @OrganId <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(c.Id in (select ContractId from ContractDeliverPlan where PlanId in (select Id from DeliverPlan where OwnOrganId in (select Id from Organization where FullPath like (select FullPath + ''%'' from Organization where Id = ' + @OrganId + ')))))'
    end

    if @Sql2 <> '' set @Sql = @Sql + ' where ' + @Sql2
    
    exec(@Sql)
    
    if @@error <> 0
    begin
        raiserror (150676,18,1)
        return -1
    end

    
    /**/
    select @OpName = formatmessage(150677)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' + 
                       N'ContractNo=' + @ContractNo + N',' + 
                       N'OriginalContractNo=' + @OriginalContractNo + N',' + 
                       N'StartCountry=' + @StartCountry + ',' +
                       N'StartProvince=' + @StartProvince + ',' + 
                       N'StartCity=' + @StartCity + ',' +
                       N'DestCountry=' + @DestCountry + ',' +
                       N'DestProvince=' + @DestProvince + ',' + 
                       N'DestCity=' + @DestCity + ',' +
                       N'CarNo=' + @CarNo + N',' + 
                       N'OrganId=' + @OrganId 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
*******************************************************************************************/
create procedure LoadCountry
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Country where Id = @Id
	if @@rowcount = 0
	begin
		raiserror (150029,18,1)
        return -1
    end

    /**/
    select @OpName = formatmessage(150030)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
*******************************************************************************************/
create procedure LoadCountrys
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Country order by Name 

	/**/
	select @OpName = formatmessage(150025)
    select @OpParams = N'' 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure LoadCustomer 
@Id bigint, 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    SELECT a.* FROM Customer a WHERE a.Id = @Id 
   
    if @@rowcount = 0
    begin
        raiserror (150082,18,1)
        return -1
    end
    
    /**/
    set @OpName = formatmessage(150083)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadCustomerApproveDeliverPlans 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @AccountType nvarchar(20)
declare @OrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    select @AccountType = AccountType, @OrganId = OrganId from Account where Id = @OpStaffId 
    if @@rowcount = 0
    begin
        raiserror (150005,18,1)
        return -1
    end
    
    /**/
    if @AccountType = formatmessage(150163)
    begin
        select * from DeliverPlan where CreatorId in (select Id from Account where OrganId = @OrganId) and PlanState = formatmessage(150296)
    end
    else
    begin
        /**/
        select * from DeliverPlan where 1 = 2
    end

    
    /**/
    select @OpName = formatmessage(150272)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadCustomerByName 
@Name nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Customer where Name = @Name 
    
    /**/
    select @OpName = formatmessage(150235)
    select @OpParams = N'Name=' + @Name 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCustomerForceFeePrice 
@CustomerId bigint,
@StartTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    select 
        * 
    from 
        CustomerForceFeePrice 
    where 
        CustomerId = @CustomerId and 
        convert(nvarchar(10),StartTime,120) <= convert(nvarchar(10),@StartTime,120) and 
        convert(nvarchar(10),EndTime,120) >= convert(nvarchar(10),@StartTime,120)
   
   
    /**/
    set @OpName = formatmessage(150668)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'StartTime=' + convert(nvarchar(10),@StartTime,120)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCustomerForceFeePricesByCustomerId 
@CustomerId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    select * from CustomerForceFeePrice where CustomerId = @CustomerId order by StartTime
   
   
    /**/
    set @OpName = formatmessage(150656)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCustomerNamesByName 
@Name nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select Name from Customer where Name like ('%' + @Name + '%') 
    
    /**/
    select @OpName = formatmessage(150235)
    select @OpParams = N'Name=' + @Name 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCustomerReceivers 
@CustomerName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select distinct 
        ReceiverName as Name 
    from 
        DeliverPlan 
    where  
        CustomerName = @CustomerName 

    
    /**/
    select @OpName = formatmessage(150479)
    select @OpParams = N'CustomerName=' + @CustomerName 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCustomerStatementByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@PayerName nvarchar(50),
@ReceiverName nvarchar(50),
@StartCountry nvarchar(50),
@StartProvince nvarchar(50),
@StartCity nvarchar(50),
@DestCountry nvarchar(50),
@DestProvince nvarchar(50),
@DestCity nvarchar(50),
@CarrierName nvarchar(50),
@CarNo nvarchar(50),
@GoodsName nvarchar(50),
@AllowStatementWhenConsignedDeliverPlanNotCompleted nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @Sql2 nvarchar(max)
declare @Sql3 nvarchar(max)
declare @Id bigint
declare @PlanType nvarchar(10)
declare @CarType nvarchar(10)
declare @ShipmentNo nvarchar(20)
declare @CustomerId bigint
declare @IsInstalment bit
declare @DeliverPlanCreateTime nvarchar(10)
declare @ValuationMode nvarchar(20)
declare @GrossWeightRate numeric(25,9)
declare @TotalTunnages numeric(25,9)
declare @TotalPiles numeric(25,9)
declare @DeliverBillCreateTime nvarchar(10)
declare @TransportPrice numeric(25,9)
declare @RiverCrossingCharges numeric(25,9)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /*1.*/
    create table #LoadCustomerStatementByConditions 
    (
	    Id bigint,
        PlanNo nvarchar(20),
        DeliverBillNo nvarchar(20),
        CustomerId bigint,
	    CustomerName nvarchar(50),
	    ShipmentNo nvarchar(20),
        DeliveryNo nvarchar(20),
        CreateTime nvarchar(10),
        ReceiverName nvarchar(50),
        GoodsName nvarchar(2000),
        CarNo nvarchar(20),
        CarType nvarchar(10),
        StartCountry nvarchar(20),
        StartProvince nvarchar(20),
        StartCity nvarchar(20),
        ReceiverCountry nvarchar(20),
        ReceiverProvince nvarchar(20),
        ReceiverCity nvarchar(20),
        ReceiverAddress nvarchar(50),
        KM nvarchar(50),
        TotalPackages int,
        TotalTunnages numeric(25,9),
        TotalPiles numeric(25,9),
        TotalTenThousands numeric(25,9),
        TransportPrice numeric(25,9),
        TransportCharges numeric(25,9),
        RiverCrossingCharges numeric(25,9),
        SettlementExpression nvarchar(100),
        ValuationMode nvarchar(20),
        GrossWeightRate numeric(25,9),
        DeliverBillReceiptReceived bit,
        InvoiceNo nvarchar(20),
        Remark nvarchar(500),
        Remark2 nvarchar(500),
        PlanType nvarchar(10),
        IsInstalment bit,
        DeliverPlanCreateTime nvarchar(10)
    )
    
    
    /*2.*/
    set @Sql = '
        select 
	        r1.Id,
            r1.PlanNo,
            r1.DeliverBillNo,
	        r1.CustomerId,
	        r1.CustomerName,
	        r1.ShipmentNo,
	        r1.DeliveryNo,
	        r1.CreateTime,
	        r1.ReceiverName,
	        r1.GoodsName,
	        r1.CarNo,
            r1.CarType,
	        r1.StartCountry,
	        r1.StartProvince,
	        r1.StartCity,
	        r1.ReceiverCountry,
	        r1.ReceiverProvince,
	        r1.ReceiverCity,
            r1.ReceiverAddress,
	        r1.KM,
	        r1.TotalPackages,
	        r1.TotalTunnages,
	        r1.TotalPiles,
	        r1.TotalTenThousands,
            isnull(dbctp.TransportPrice,0.0) as TransportPrice,
            isnull(dbctp.TransportCharges,0.0) as TransportCharges,
	        c.SettlementExpression,
            c.ValuationMode,
            c.GrossWeightRate,
	        r1.DeliverBillReceiptReceived,
	        r1.InvoiceNo,
            r1.Remark,
            dbctp.Remark as Remark2,
            r1.PlanType,
            r1.IsInstalment,
            r1.DeliverPlanCreateTime 
        from 
	        (
		        select 
			        db.Id,
                    dp.PlanNo,
                    db.BillNo as DeliverBillNo,
			        db.PlanId,
			        dp.PayerId as CustomerId,
			        dp.PayerName as CustomerName,
			        dp.ShipmentNo,
			        dp.DeliveryNo,
			        convert(nvarchar(10),db.CreateTime,120) as CreateTime,
			        db.ReceiverName,
			        gn.GoodsName,
			        db.CarNo,
                    db2.CarType,
			        db.CarrierName,
			        dp.StartCountry,
			        dp.StartProvince,
			        dp.StartCity,
			        db.ReceiverCountry,
			        db.ReceiverProvince,
			        db.ReceiverCity,
                    db.ReceiverAddress,
			        dbdp.KM,
			        dg.TotalPackages,
			        dg.TotalTunnages,
			        dg.TotalPiles,
			        dg.TotalTenThousands,
			        cast((case when db.ReturnTime is null then 0 else 1 end) as bit) as DeliverBillReceiptReceived,
			        i.InvoiceNo,
			        db.OwnOrganId,
                    dp.ReceiveType,
                    dp.ConsignedDeliveryNo,
                    dp.Remark,
                    dp.PlanType,
                    dp.IsInstalment,
                    convert(nvarchar(10),dp.CreateTime,120) as DeliverPlanCreateTime 
		        from 
			        DeliverBill db join 
			        (
				        select 
					        DeliverBillId,
					        sum(Packages) as TotalPackages,
					        sum(Tunnages) as TotalTunnages,
					        sum(Piles) as TotalPiles,
					        sum(TenThousands) as TotalTenThousands
				        from 
					        DeliverBillGoods 
				        group by 
					        DeliverBillId 
			        ) as dg on db.Id = dg.DeliverBillId join 
			        (
				        select 
					        Id,
                            PlanNo,
					        ShipmentNo,
					        DeliveryNo,
					        StartCountry,
					        StartProvince,
					        StartCity,
					        PayerId,
					        PayerName,
                            ReceiveType,
                            ConsignedDeliveryNo,
                            PlanType,
                            Remark,
                            IsInstalment,
                            CreateTime 
				        from 
					        DeliverPlan 
			        ) as dp on db.PlanId = dp.Id join 
			        (
				        select 
					        a.DeliverBillId,
					        b.GoodsName
				        from
					        (
						        select distinct DeliverBillId from DeliverBillGoods 
					        ) as a outer apply
					        (
						        select 
							        GoodsName = stuff(replace(replace(
							        (
								        select distinct
									        GoodsName 
								        from 
									        DeliverBillGoods 
								        where 
									        DeliverBillId = a.DeliverBillId
								        for xml auto
							        ), ''<DeliverBillGoods GoodsName="'', '',''), ''"/>'', ''''), 1, 1, '''')
					        ) as b
			        ) as gn on db.Id = gn.DeliverBillId join 
			        (
				        select 
                            DispatchBillId, 
                            PlanId, 
                            convert(nvarchar,KM) as KM 
                        from 
                            DispatchBillDeliverPlan 
			        ) as dbdp on db.DispatchBillId = dbdp.DispatchBillId and db.PlanId = dbdp.PlanId join
                    (
                        select 
                            Id,
                            CarType
                        from 
                            DispatchBill
                    ) as db2 on db.DispatchBillId = db2.Id left join 
			        CustomerTransportChargesSettlement i on db.CustomerTransportChargesSettlementId = i.Id 
	        ) as r1 join 
	        Customer c on r1.CustomerId = c.Id left join 
            DeliverBillCustomerTransportPrice dbctp on r1.Id = dbctp.DeliverBillId '
    
    set @Sql = @Sql + ' where (r1.OwnOrganId in (select Id from Organization where FullPath like (select o.FullPath + ''%'' from Account a join Organization o on a.OrganId = o.Id where a.Id = ' + convert(nvarchar,@OpStaffId) + ' and a.AccountType = ''' + formatmessage(150162) + ''' and a.IsCancel = 0))) '
    
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.ReceiveType <> ''' + formatmessage(150347) + ''')'
    end
    
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CreateTime >= ''' + @StartTime + ''')'
    end
    
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CreateTime <= ''' + @EndTime + ''')'
    end
    
    if @PayerName is not null and @PayerName <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CustomerName = ''' + @PayerName + ''')'
    end

    if @ReceiverName is not null and @ReceiverName <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.ReceiverName = ''' + @ReceiverName + ''')'
    end

    if @StartCountry is not null and @StartCountry <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.StartCountry = ''' + @StartCountry + ''')'
    end

    if @StartProvince is not null and @StartProvince <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.StartProvince = ''' + @StartProvince + ''')'
    end

    if @StartCity is not null and @StartCity <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.StartCity = ''' + @StartCity + ''')'
    end

    if @DestCountry is not null and @DestCountry <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.ReceiverCountry = ''' + @DestCountry + ''')'
    end

    if @DestProvince is not null and @DestProvince <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.ReceiverProvince = ''' + @DestProvince + ''')'
    end

    if @DestCity is not null and @DestCity <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.ReceiverCity = ''' + @DestCity + ''')'
    end

    if @CarrierName is not null and @CarrierName <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CarrierName = ''' + @CarrierName + ''')'
    end

    if @CarNo is not null and @CarNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CarNo = ''' + @CarNo + ''')'
    end

    if @GoodsName is not null and @GoodsName <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.GoodsName like ''%' + @GoodsName + '%'')'
    end

    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.InvoiceNo is null)'
    end

    /**/
    if cast(@AllowStatementWhenConsignedDeliverPlanNotCompleted as bit) = 0
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(
            isnull(r1.ConsignedDeliveryNo,'''') not in 
	        (
		        select distinct
			        t1.DeliveryNo 
		        from 
			        (	
				        select 
					        p.DeliveryNo,
					        g.GoodsId,
					        g.BatchNo,
                            g.Packing,
                            p.Warehouse,
                            g.Location,
					        g.Packages,
					        g.Piles,
                            g.ProductionDate,
                            g.EnterWarehouseBillId
				        from 
					        DeliverPlanGoods g join 
					        DeliverPlan p on g.PlanId = p.Id 
				        where 
					        p.IsConsigning = 1
                        union 
                        select 
					        b.DeliveryNo,
					        g.GoodsId,
					        g.BatchNo,
                            g.Packing,
                            b.Warehouse,
                            g.Location,
					        g.Packages,
					        0.0 as Piles,
                            g.ProductionDate,
                            g.EnterWarehouseBillId
                        from 
                            EnterWarehouseBillGoods g join 
                            EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id 
                        where 
                            b.IsConsigning = 1
			        ) as t1 join 
			        (
				        select 
					        p.ConsignedDeliveryNo,
					        g.GoodsId,
					        g.BatchNo,
                            g.Packing,
                            b.Warehouse,
                            g.Location,
					        sum(g.Packages) as DeliverPackages,
					        sum(g.Piles) as DeliverPiles,
                            g.ProductionDate,
                            g.EnterWarehouseBillId
				        from 
					        DeliverBillGoods g join 
					        DeliverBill b on g.DeliverBillId = b.Id join 
                            DeliverPlan p on b.PlanId = p.Id 
                        where 
                            p.ConsignedDeliveryNo is not null and 
                            p.ConsignedDeliveryNo <> '''' and '
                            
        set @Sql = @Sql + ' convert(nvarchar(10),b.CreateTime,120) <= ''' + @EndTime + ''''
        
        set @Sql = @Sql + '
				        group by 
					        p.ConsignedDeliveryNo,
					        g.GoodsId,
					        g.BatchNo,
                            g.Packing,
                            b.Warehouse,
                            g.Location,
                            g.ProductionDate,
                            g.EnterWarehouseBillId
			        ) as t2 on t1.DeliveryNo = t2.ConsignedDeliveryNo and t1.GoodsId = t2.GoodsId and isnull(t1.BatchNo,'''') = isnull(t2.BatchNo,'''') and isnull(t1.Packing,'''') = isnull(t2.Packing,'''') and isnull(t1.Warehouse,'''') = isnull(t2.Warehouse,'''') and isnull(t1.Location,'''') = isnull(t2.Location,'''') and isnull(t1.ProductionDate,'''') = isnull(t2.ProductionDate,'''') and isnull(t1.EnterWarehouseBillId,0) = isnull(t2.EnterWarehouseBillId,0) and (t1.Packages <> t2.DeliverPackages or t1.Piles <>
 t2.DeliverPiles) 
	        ))'
    end
    
    /**/
    set @Sql2 = '
        select 
	        r1.Id,
            r1.PlanNo,
            r1.DeliverBillNo,
	        r1.CustomerId,
	        r1.CustomerName,
	        r1.ShipmentNo,
	        r1.DeliveryNo,
	        r1.CreateTime,
	        r1.ReceiverName,
	        r1.GoodsName,
	        r1.CarNo,
            r1.CarType,
	        r1.StartCountry,
	        r1.StartProvince,
	        r1.StartCity,
	        r1.ReceiverCountry,
	        r1.ReceiverProvince,
	        r1.ReceiverCity,
            r1.ReceiverAddress,
	        r1.KM,
	        r1.TotalPackages,
	        r1.TotalTunnages,
	        r1.TotalPiles,
	        r1.TotalTenThousands,
            isnull(dbctp.TransportPrice,0.0) as TransportPrice,
            isnull(dbctp.TransportCharges,0.0) as TransportCharges,
	        c.SettlementExpression,
            c.ValuationMode,
            c.GrossWeightRate,
	        r1.DeliverBillReceiptReceived,
	        r1.InvoiceNo,
            r1.Remark,
            dbctp.Remark as Remark2,
            r1.PlanType,
            r1.IsInstalment,
            r1.DeliverPlanCreateTime 
        from 
            (
	            select 
			        db.Id,
                    dp.PlanNo,
                    db.BillNo as DeliverBillNo,
			        db.PlanId,
			        dp.PayerId as CustomerId,
			        dp.PayerName as CustomerName,
			        dp.ShipmentNo,
			        dp.DeliveryNo,
			        convert(nvarchar(10),db.CreateTime,120) as CreateTime,
			        db.ReceiverName,
			        gn.GoodsName,
			        db.CarNo,
                    db2.CarType,
			        db.CarrierName,
			        dp.StartCountry,
			        dp.StartProvince,
			        dp.StartCity,
			        db.ReceiverCountry,
			        db.ReceiverProvince,
			        db.ReceiverCity,
                    db.ReceiverAddress,
			        dbdp.KM,
			        dg.TotalPackages,
			        dg.TotalTunnages,
			        dg.TotalPiles,
			        dg.TotalTenThousands,
			        cast((case when db.ReturnTime is null then 0 else 1 end) as bit) as DeliverBillReceiptReceived,
			        i.InvoiceNo,
			        db.OwnOrganId,
                    dp.ReceiveType,
                    dp.ConsignedDeliveryNo,
                    dp.Remark,
                    dp.PlanType,
                    dp.IsInstalment,
                    convert(nvarchar(10),dp.CreateTime,120) as DeliverPlanCreateTime 
	            from 
		            DeliverBill db join 
		            (
			            select 
				            DeliverBillId,
				            sum(Packages) as TotalPackages,
				            sum(Tunnages) as TotalTunnages,
				            sum(Piles) as TotalPiles,
				            sum(TenThousands) as TotalTenThousands
			            from 
				            DeliverBillGoods 
			            group by 
				            DeliverBillId 
		            ) as dg on db.Id = dg.DeliverBillId join 
		            (
			            select 
					        Id,
                            PlanNo,
					        ShipmentNo,
					        DeliveryNo,
					        StartCountry,
					        StartProvince,
					        StartCity,
					        PayerId,
					        PayerName,
                            ReceiveType,
                            ConsignedDeliveryNo,
                            PlanType,
                            Remark,
                            IsInstalment,
                            CreateTime 
			            from 
				            DeliverPlan 
		            ) as dp on db.PlanId = dp.Id join 
		            (
			            select 
				            a.DeliverBillId,
				            b.GoodsName
			            from
				            (
					            select distinct DeliverBillId from DeliverBillGoods 
				            ) as a outer apply
				            (
					            select 
						            GoodsName = stuff(replace(replace(
						            (
							            select distinct
								            GoodsName 
							            from 
								            DeliverBillGoods 
							            where 
								            DeliverBillId = a.DeliverBillId
							            for xml auto
						            ), ''<DeliverBillGoods GoodsName="'', '',''), ''"/>'', ''''), 1, 1, '''')
				            ) as b
		            ) as gn on db.Id = gn.DeliverBillId join 
		            (
			            select 
                            DispatchBillId, 
                            PlanId, 
                            convert(nvarchar,KM) as KM 
                        from 
                            DispatchBillDeliverPlan 
		            ) as dbdp on db.DispatchBillId = dbdp.DispatchBillId and db.PlanId = dbdp.PlanId join
                    (
                        select 
                            Id,
                            CarType
                        from 
                            DispatchBill
                    ) as db2 on db.DispatchBillId = db2.Id left join 
		            CustomerTransportChargesSettlement i on db.CustomerTransportChargesSettlementId = i.Id 
            ) as r1 join 
            Customer c on r1.CustomerId = c.Id left join 
            DeliverBillCustomerTransportPrice dbctp on r1.Id = dbctp.DeliverBillId '

    set @Sql2 = @Sql2 + ' where (r1.OwnOrganId in (select Id from Organization where FullPath like (select o.FullPath + ''%'' from Account a join Organization o on a.OrganId = o.Id where a.Id = ' + convert(nvarchar,@OpStaffId) + ' and a.AccountType = ''' + formatmessage(150162) + ''' and a.IsCancel = 0))) '

    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.ReceiveType <> ''' + formatmessage(150347) + ''')'
    end

    if @PayerName is not null and @PayerName <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.CustomerName = ''' + @PayerName + ''')'
    end

    if @ReceiverName is not null and @ReceiverName <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.ReceiverName = ''' + @ReceiverName + ''')'
    end

    if @StartCountry is not null and @StartCountry <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.StartCountry = ''' + @StartCountry + ''')'
    end

    if @StartProvince is not null and @StartProvince <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.StartProvince = ''' + @StartProvince + ''')'
    end

    if @StartCity is not null and @StartCity <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.StartCity = ''' + @StartCity + ''')'
    end

    if @DestCountry is not null and @DestCountry <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.ReceiverCountry = ''' + @DestCountry + ''')'
    end

    if @DestProvince is not null and @DestProvince <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.ReceiverProvince = ''' + @DestProvince + ''')'
    end

    if @DestCity is not null and @DestCity <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.ReceiverCity = ''' + @DestCity + ''')'
    end

    if @CarrierName is not null and @CarrierName <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.CarrierName = ''' + @CarrierName + ''')'
    end

    if @CarNo is not null and @CarNo <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.CarNo = ''' + @CarNo + ''')'
    end

    if @GoodsName is not null and @GoodsName <> ''
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.GoodsName like ''%' + @GoodsName + '%'')'
    end

    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(
            isnull(r1.ConsignedDeliveryNo,'''') in 
            (
	            select 
		            t3.DeliveryNo 
	            from 
		            (
			            select distinct
				            t1.DeliveryNo 
			            from 
				            (	
				                select 
					                p.DeliveryNo,
					                g.GoodsId,
					                g.BatchNo,
                                    g.Packing,
                                    p.Warehouse,
                                    g.Location,
					                g.Packages,
					                g.Piles,
                                    g.ProductionDate,
                                    g.EnterWarehouseBillId
				                from 
					                DeliverPlanGoods g join 
					                DeliverPlan p on g.PlanId = p.Id 
				                where 
					                p.IsConsigning = 1
                                union 
                                select 
					                b.DeliveryNo,
					                g.GoodsId,
					                g.BatchNo,
                                    g.Packing,
                                    b.Warehouse,
                                    g.Location,
					                g.Packages,
					                0.0 as Piles,
                                    g.ProductionDate,
                                    g.EnterWarehouseBillId
                                from 
                                    EnterWarehouseBillGoods g join 
                                    EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id 
                                where 
                                    b.IsConsigning = 1
				            ) as t1 join 
				            (
					            select 
					                p.ConsignedDeliveryNo,
					                g.GoodsId,
					                g.BatchNo,
                                    g.Packing,
                                    b.Warehouse,
                                    g.Location,
					                sum(g.Packages) as DeliverPackages,
					                sum(g.Piles) as DeliverPiles,
                                    g.ProductionDate,
                                    g.EnterWarehouseBillId
					            from 
						            DeliverBillGoods g join 
						            DeliverBill b on g.DeliverBillId = b.Id join 
                                    DeliverPlan p on b.PlanId = p.Id 
                                where 
                                    p.ConsignedDeliveryNo is not null and 
                                    p.ConsignedDeliveryNo <> ''''
					            group by 
					                p.ConsignedDeliveryNo,
					                g.GoodsId,
					                g.BatchNo,
                                    g.Packing,
                                    b.Warehouse,
                                    g.Location,
                                    g.ProductionDate,
                                    g.EnterWarehouseBillId
				            ) as t2 on t1.DeliveryNo = t2.ConsignedDeliveryNo and t1.GoodsId = t2.GoodsId and isnull(t1.BatchNo,'''') = isnull(t2.BatchNo,'''') and isnull(t1.Packing,'''') = isnull(t2.Packing,'''') and isnull(t1.Warehouse,'''') = isnull(t2.Warehouse,'''') and isnull(t1.Location,'''') = isnull(t2.Location,'''') and isnull(t1.ProductionDate,'''') = isnull(t2.ProductionDate,'''') and isnull(t1.EnterWarehouseBillId,0) = isnull(t2.EnterWarehouseBillId,0) and t1.Packages = t2.DeliverPackages and t1.Piles =
 t2.DeliverPiles 
		            ) as t3 left join ' 
                        
        set @Sql2 = @Sql2 + '
                    (
				        select                                           
					        p.ConsignedDeliveryNo,                                          
					        max(b.CreateTime) as DeliverTime                                       
				        from                                           
					        DeliverBill b join                                           
					        DeliverPlan p on b.PlanId = p.Id                                       
				        where                                           
					        p.ConsignedDeliveryNo is not null and                                           
					        p.ConsignedDeliveryNo <> ''''                                      
				        group by                                           
					        p.ConsignedDeliveryNo                               
			        ) as t4 on t3.DeliveryNo = t4.ConsignedDeliveryNo '
                        
        set @Sql2 = @Sql2 + '
	            where 
		            t3.DeliveryNo not in
		            (
			            select distinct
				            t1.DeliveryNo 
			            from 
				            (	
				                select 
					                p.DeliveryNo,
					                g.GoodsId,
					                g.BatchNo,
                                    g.Packing,
                                    p.Warehouse,
                                    g.Location,
					                g.Packages,
					                g.Piles,
                                    g.ProductionDate,
                                    g.EnterWarehouseBillId
				                from 
					                DeliverPlanGoods g join 
					                DeliverPlan p on g.PlanId = p.Id 
				                where 
					                p.IsConsigning = 1
                                union 
                                select 
					                b.DeliveryNo,
					                g.GoodsId,
					                g.BatchNo,
                                    g.Packing,
                                    b.Warehouse,
                                    g.Location,
					                g.Packages,
					                0.0 as Piles,
                                    g.ProductionDate,
                                    g.EnterWarehouseBillId
                                from 
                                    EnterWarehouseBillGoods g join 
                                    EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id 
                                where 
                                    b.IsConsigning = 1
				            ) as t1 join 
				            (
					            select 
					                p.ConsignedDeliveryNo,
					                g.GoodsId,
					                g.BatchNo,
                                    g.Packing,
                                    b.Warehouse,
                                    g.Location,
					                sum(g.Packages) as DeliverPackages,
					                sum(g.Piles) as DeliverPiles,
                                    g.ProductionDate,
                                    g.EnterWarehouseBillId
					            from 
						            DeliverBillGoods g join 
						            DeliverBill b on g.DeliverBillId = b.Id join 
                                    DeliverPlan p on b.PlanId = p.Id 
                                where 
                                    p.ConsignedDeliveryNo is not null and 
                                    p.ConsignedDeliveryNo <> ''''
					            group by 
					                p.ConsignedDeliveryNo,
					                g.GoodsId,
					                g.BatchNo,
                                    g.Packing,
                                    b.Warehouse,
                                    g.Location,
                                    g.ProductionDate,
                                    g.EnterWarehouseBillId
				            ) as t2 on t1.DeliveryNo = t2.ConsignedDeliveryNo and t1.GoodsId = t2.GoodsId and isnull(t1.BatchNo,'''') = isnull(t2.BatchNo,'''') and isnull(t1.Packing,'''') = isnull(t2.Packing,'''') and isnull(t1.Warehouse,'''') = isnull(t2.Warehouse,'''') and isnull(t1.Location,'''') = isnull(t2.Location,'''') and isnull(t1.ProductionDate,'''') = isnull(t2.ProductionDate,'''') and isnull(t1.EnterWarehouseBillId,0) = isnull(t2.EnterWarehouseBillId,0) and (t1.Packages <> t2.DeliverPackages or t1.Piles
 <> t2.DeliverPiles) 
		            ) and '
                        
        set @Sql2 = @Sql2 + '
                    (convert(nvarchar(10),t4.DeliverTime,120) >= ''' + @StartTime + ''') and '
                                
        set @Sql2 = @Sql2 + '
                    (convert(nvarchar(10),t4.DeliverTime,120) <= ''' + @EndTime + ''')'
                                
        set @Sql2 = @Sql2 + '
            ))'
    end
        
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.InvoiceNo is null)'
    end
       
    set @Sql = @Sql + ' union ' + @Sql2
    
    set @Sql3 = '
        insert into #LoadCustomerStatementByConditions
            (
                Id,
                PlanNo,
                DeliverBillNo,
	            CustomerId,
	            CustomerName,
	            ShipmentNo,
	            DeliveryNo,
	            CreateTime,
	            ReceiverName,
	            GoodsName,
	            CarNo,
                CarType,
	            StartCountry,
	            StartProvince,
	            StartCity,
	            ReceiverCountry,
	            ReceiverProvince,
	            ReceiverCity,
                ReceiverAddress,
	            KM,
	            TotalPackages,
	            TotalTunnages,
	            TotalPiles,
	            TotalTenThousands,
                TransportPrice,
                TransportCharges,
                RiverCrossingCharges,
	            SettlementExpression,
                ValuationMode,
                GrossWeightRate,
	            DeliverBillReceiptReceived,
	            InvoiceNo,
                Remark,
                Remark2,
                PlanType,
                IsInstalment,
                DeliverPlanCreateTime 
            )
        select 
	        r0.Id,
            r0.PlanNo,
            r0.DeliverBillNo,
	        r0.CustomerId,
	        r0.CustomerName,
	        r0.ShipmentNo,
	        r0.DeliveryNo,
	        r0.CreateTime,
	        r0.ReceiverName,
	        r0.GoodsName,
	        r0.CarNo,
            r0.CarType,
	        r0.StartCountry,
	        r0.StartProvince,
	        r0.StartCity,
	        r0.ReceiverCountry,
	        r0.ReceiverProvince,
	        r0.ReceiverCity,
            r0.ReceiverAddress,
	        r0.KM,
	        r0.TotalPackages,
	        r0.TotalTunnages,
	        r0.TotalPiles,
	        r0.TotalTenThousands,
            r0.TransportPrice,
            r0.TransportCharges,
            0.0,
	        r0.SettlementExpression,
            r0.ValuationMode,
            r0.GrossWeightRate,
	        r0.DeliverBillReceiptReceived,
	        r0.InvoiceNo,
            r0.Remark,
            r0.Remark2,
            r0.PlanType,
            r0.IsInstalment,
            r0.DeliverPlanCreateTime 
        from 
            ( '
    
    set @Sql3 = @Sql3 + @Sql 
    
    set @Sql3 = @Sql3 + ' ) as r0 '
    
    exec(@Sql3)
    
    if @@error <> 0
    begin
        raiserror (150481,18,1)
        return -1
    end
    
    /*3.*/
    declare Cursor1 cursor local for 
        select 
	        Id,
            CustomerId,
	        ShipmentNo,
            CreateTime,
            CarType,
            StartCountry,
            StartProvince,
            StartCity,
            ReceiverCountry,
            ReceiverProvince,
            ReceiverCity,
            TotalTunnages,
            TotalPiles,
            ValuationMode,
            GrossWeightRate,
            PlanType,
            IsInstalment,
            DeliverPlanCreateTime
        from 
            #LoadCustomerStatementByConditions 
        where 
            TransportPrice = 0
            
    open Cursor1
    fetch next from Cursor1 into 
        @Id, 
        @CustomerId, 
        @ShipmentNo, 
        @DeliverBillCreateTime, 
        @CarType,
        @StartCountry, 
        @StartProvince, 
        @StartCity, 
        @DestCountry, 
        @DestProvince, 
        @DestCity, 
        @TotalTunnages, 
        @TotalPiles, 
        @ValuationMode, 
        @GrossWeightRate, 
        @PlanType, 
        @IsInstalment, 
        @DeliverPlanCreateTime 

    while @@fetch_status = 0
    begin
        set @TransportPrice = 0
        
        /**/
        if @PlanType = formatmessage(150257) or @PlanType = formatmessage(150619)
        begin
            select 
                @TransportPrice = TransportPrice,
                @RiverCrossingCharges = RiverCrossingCharges
            from 
                CustomerTransportPrice 
            where 
                CustomerId = @CustomerId and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @DestCountry and 
                DestProvince = @DestProvince and 
                DestCity = @DestCity and 
                @TotalPiles * @GrossWeightRate >= MinTunnagesOrPiles and 
                @TotalPiles * @GrossWeightRate < MaxTunnagesOrPiles and 
                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                (
                    CarType is not null and 
                    CarType <> '' and 
                    CarType = @CarType
                )
            if @@rowcount = 0
            begin
                select 
                    @TransportPrice = TransportPrice,
                    @RiverCrossingCharges = RiverCrossingCharges
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @TotalPiles * @GrossWeightRate >= MinTunnagesOrPiles and 
                    @TotalPiles * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is null or 
                        CarType = ''
                    )
                if @@rowcount = 0
                begin
                    set @TransportPrice = 0
                    set @RiverCrossingCharges = 0
                end
            end
        end
        else
        begin
            /**/
            if @PlanType = formatmessage(150256) or @PlanType = formatmessage(150518)
            begin
                /**/
                if @ValuationMode = formatmessage(150520)
                begin
                    select 
                        @TransportPrice = TransportPrice,
                        @RiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    if @@rowcount = 0
                    begin
                        select 
                            @TransportPrice = TransportPrice,
                            @RiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and
                            (
                                CarType is null or 
                                CarType = ''
                            )
                        if @@rowcount = 0
                        begin
                            set @TransportPrice = 0
                            set @RiverCrossingCharges = 0
                        end
                    end
                end
                /**/
                else if @ValuationMode = formatmessage(150521)
                begin
                    /**/
                    select 
                        @TotalTunnages = isnull(sum(Tunnages),0.0) 
                    from 
                        DeliverBillGoods 
                    where 
                        DeliverBillId in 
                        (
                            select 
                                Id 
                            from 
                                DeliverBill 
                            where 
                                PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan
                                    where 
                                        ShipmentNo = @ShipmentNo 
                                ) 
                        )
                    
                    if @TotalTunnages is null 
                    begin
                        set @TotalTunnages = 0
                    end
            
                    /**/
                    select 
                        @TransportPrice = TransportPrice,
                        @RiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    if @@rowcount = 0
                    begin
                    
                        select 
                            @TransportPrice = TransportPrice,
                            @RiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is null or
                                CarType = ''
                            )
                        if @@rowcount = 0
                        begin
                            set @TransportPrice = 0
                            set @RiverCrossingCharges = 0
                        end
                    end
                end
                /**/
                else
                begin
                    /**/
                    if @IsInstalment is null or @IsInstalment = 0
                    begin
                        /**/
                        select 
                            @TotalTunnages = isnull(sum(Tunnages),0.0) 
                        from 
                            DeliverBillGoods  
                        where 
                            DeliverBillId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverBill 
                                where 
                                    PlanId in 
                                    (
                                        select 
                                            Id 
                                        from 
                                            DeliverPlan 
                                        where 
                                            PayerId = @CustomerId and
                                            convert(nvarchar(10), CreateTime, 120) = @DeliverPlanCreateTime and 
                                            ReceiverCountry = @DestCountry and 
                                            ReceiverProvince = @DestProvince and 
                                            ReceiverCity = @DestCity
                                    ) 
                            )
                        
                        if @TotalTunnages is null 
                        begin
                            set @TotalTunnages = 0
                        end
            
                        /**/
                        select 
                            @TransportPrice = TransportPrice,
                            @RiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is not null and 
                                CarType <> '' and 
                                CarType = @CarType
                            )
                        if @@rowcount = 0
                        begin
                        
                            select 
                                @TransportPrice = TransportPrice,
                                @RiverCrossingCharges = RiverCrossingCharges
                            from 
                                CustomerTransportPrice 
                            where 
                                CustomerId = @CustomerId and 
                                StartCountry = @StartCountry and 
                                StartProvince = @StartProvince and 
                                StartCity = @StartCity and 
                                DestCountry = @DestCountry and 
                                DestProvince = @DestProvince and 
                                DestCity = @DestCity and 
                                @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                                @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                                (
                                    CarType is null or
                                    CarType = ''
                                )
                            if @@rowcount = 0
                            begin
                                set @TransportPrice = 0
                                set @RiverCrossingCharges = 0
                            end
                        end
                    end
                    /**/
                    else
                    begin
                        /**/
                        select 
                            @TotalTunnages = isnull(sum(Tunnages),0.0) 
                        from 
                            DeliverBillGoods  
                        where 
                            DeliverBillId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverBill 
                                where 
                                    PlanId in 
                                    (
                                        select 
                                            Id 
                                        from 
                                            DeliverPlan 
                                        where 
                                            PayerId = @CustomerId and
                                            convert(nvarchar(10), CreateTime, 120) = @DeliverBillCreateTime and 
                                            ReceiverCountry = @DestCountry and 
                                            ReceiverProvince = @DestProvince and 
                                            ReceiverCity = @DestCity
                                    ) 
                            )
                        
                        if @TotalTunnages is null 
                        begin
                            set @TotalTunnages = 0
                        end
            
                        /*4.3.2.2.*/
                        select 
                            @TransportPrice = TransportPrice,
                            @RiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is not null and 
                                CarType <> '' and 
                                CarType = @CarType
                            )
                        if @@rowcount = 0
                        begin
                        
                            select 
                                @TransportPrice = TransportPrice,
                                @RiverCrossingCharges = RiverCrossingCharges
                            from 
                                CustomerTransportPrice 
                            where 
                                CustomerId = @CustomerId and 
                                StartCountry = @StartCountry and 
                                StartProvince = @StartProvince and 
                                StartCity = @StartCity and 
                                DestCountry = @DestCountry and 
                                DestProvince = @DestProvince and 
                                DestCity = @DestCity and 
                                @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                                @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                                (
                                    CarType is null or
                                    CarType = ''
                                )
                            if @@rowcount = 0
                            begin
                                set @TransportPrice = 0
                                set @RiverCrossingCharges = 0
                            end
                        end
                    end
                end
            end
            /**/
            else
            begin
                select 
                    @TransportPrice = TransportPrice,
                    @RiverCrossingCharges = RiverCrossingCharges
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                    @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is not null and 
                        CarType <> '' and 
                        CarType = @CarType
                    )
                if @@rowcount = 0
                begin
                    select 
                        @TransportPrice = TransportPrice,
                        @RiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is null or
                            CarType = ''
                        )
                    if @@rowcount = 0
                    begin
                        set @TransportPrice = 0
                        set @RiverCrossingCharges = 0
                    end
                end
            end
        end
        
        /**/
        if @TransportPrice is null
        begin
            set @TransportPrice = 0
        end
        
        if @RiverCrossingCharges is null
        begin
            set @RiverCrossingCharges = 0
        end
        
        update #LoadCustomerStatementByConditions set TransportPrice = @TransportPrice, RiverCrossingCharges = @RiverCrossingCharges where Id = @Id 
    
        fetch next from Cursor1 into 
            @Id, 
            @CustomerId, 
            @ShipmentNo, 
            @DeliverBillCreateTime, 
            @CarType,
            @StartCountry, 
            @StartProvince, 
            @StartCity, 
            @DestCountry, 
            @DestProvince, 
            @DestCity, 
            @TotalTunnages, 
            @TotalPiles, 
            @ValuationMode, 
            @GrossWeightRate, 
            @PlanType, 
            @IsInstalment, 
            @DeliverPlanCreateTime 
    end 
        
    close Cursor1
    deallocate Cursor1 
    
    /**/
    select * from #LoadCustomerStatementByConditions
    
    
    /**/
    select @OpName = formatmessage(150480)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'PayerName=' + @PayerName + N',' +
                       N'ReceiverName=' + @ReceiverName + N',' +
                       N'StartCountry=' + @StartCountry + N',' +
                       N'StartProvince=' + @StartProvince + N',' +
                       N'StartCity=' + @StartCity + N',' +
                       N'DestCountry=' + @DestCountry + N',' +
                       N'DestProvince=' + @DestProvince + N',' +
                       N'DestCity=' + @DestCity + N',' +
                       N'CarrierName=' + @CarrierName + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'GoodsName=' + @GoodsName + N',' +
                       N'AllowStatementWhenConsignedDeliverPlanNotCompleted=' + @AllowStatementWhenConsignedDeliverPlanNotCompleted 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadCustomerStorageAndForceFeeSettlementsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@InvoiceNo nvarchar(50),
@CustomerName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = 'select * from CustomerStorageAndForceFeeSettlement '
    set @WhereSql = ''

    if @StartTime is not null and @StartTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),CreateTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),CreateTime,120) <= ''' + @EndTime + ''')'
    end
    
    if @InvoiceNo is not null and @InvoiceNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(InvoiceNo = ''' + @InvoiceNo + ''')'
    end

    if @CustomerName is not null and @CustomerName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(CustomerName = ''' + @CustomerName + ''')'
    end
    
    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    set @SelectSql = @SelectSql + ' order by Id '
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150588,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150589)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'InvoiceNo=' + @InvoiceNo + N',' +
                       N'CustomerName=' + @CustomerName 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadCustomerStorageFeePrice 
@CustomerId bigint,
@StartTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    select 
        * 
    from 
        CustomerStorageFeePrice 
    where 
        CustomerId = @CustomerId and 
        convert(nvarchar(10),StartTime,120) <= convert(nvarchar(10),@StartTime,120) and 
        convert(nvarchar(10),EndTime,120) >= convert(nvarchar(10),@StartTime,120)
   
   
    /**/
    set @OpName = formatmessage(150669)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'StartTime=' + convert(nvarchar(10),@StartTime,120)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCustomerStorageFeePricesByCustomerId 
@CustomerId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    select * from CustomerStorageFeePrice where CustomerId = @CustomerId order by StartTime
   
   
    /**/
    set @OpName = formatmessage(150657)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCustomerTotalOutputDetailsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@CustomerName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @CustomerId bigint
declare @ShipmentNo nvarchar(20)
declare @DeliverBillCreateTime nvarchar(10)
declare @StartCountry nvarchar(20)
declare @StartProvince nvarchar(20)
declare @StartCity nvarchar(20)
declare @DestCountry nvarchar(20)
declare @DestProvince nvarchar(20)
declare @DestCity nvarchar(20)
declare @TotalTunnages numeric(25,9)
declare @TotalPiles numeric(25,9)
declare @ValuationMode nvarchar(20)
declare @GrossWeightRate numeric(25,9)
declare @PlanType nvarchar(10)
declare @IsInstalment bit
declare @DeliverPlanCreateTime nvarchar(10)
declare @CustomerTransportPrice numeric(25,9)
declare @CustomerRiverCrossingCharges numeric(25,9)
declare @CarType nvarchar(10)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    create table #LoadCustomerTotalOutputDetailsByConditions 
    (
	    Id bigint,
	    ShipmentNo nvarchar(20),
        DeliveryNo nvarchar(20),
        ReceiverCountry nvarchar(20),
        ReceiverProvince nvarchar(20),
        ReceiverCity nvarchar(20),
        ReceiverAddress nvarchar(50),
        KM nvarchar(50),
        CarrierBusinessType nvarchar(10),
        TotalPackages int,
        TotalTunnages numeric(25,9),
        TotalPiles numeric(25,9),
        TotalTenThousands numeric(25,9),
        CustomerTransportPrice numeric(25,9),
        CustomerTransportCharges numeric(25,9),
        CustomerRiverCrossingCharges numeric(25,9),
        CustomerSettlementExpression nvarchar(100),
        CarrierTransportCharges numeric(25,9),
        CreateTime nvarchar(10),
        PlanType nvarchar(10),
        CustomerId bigint,
        CustomerName nvarchar(50),
        StartCountry nvarchar(20),
        StartProvince nvarchar(20),
        StartCity nvarchar(20),
        IsInstalment bit,
        DeliverPlanCreateTime nvarchar(10),
        ValuationMode nvarchar(20),
        GrossWeightRate numeric(25,9),
        CarType nvarchar(10)
    )
    
    /**/
    if @CustomerName is null or @CustomerName = ''
    begin
        insert into #LoadCustomerTotalOutputDetailsByConditions 
            (
	            Id,
	            ShipmentNo,
                DeliveryNo,
                ReceiverCountry,
                ReceiverProvince,
                ReceiverCity,
                ReceiverAddress,
                KM,
                CarrierBusinessType,
                TotalPackages,
                TotalTunnages,
                TotalPiles,
                TotalTenThousands,
                CustomerTransportPrice,
                CustomerTransportCharges,
                CustomerRiverCrossingCharges,
                CustomerSettlementExpression,
                CarrierTransportCharges,
                CreateTime,
                PlanType,
                CustomerId,
                CustomerName,
                StartCountry,
                StartProvince,
                StartCity,
                IsInstalment,
                DeliverPlanCreateTime,
                ValuationMode,
                GrossWeightRate,
                CarType
            )
        select 
            r1.Id,
            r1.ShipmentNo,
            r1.DeliveryNo,
            r1.ReceiverCountry,
            r1.ReceiverProvince,
            r1.ReceiverCity,
            r1.ReceiverAddress,
            r1.KM,
            r1.CarrierBusinessType,
            r1.TotalPackages,
            r1.TotalTunnages,
            r1.TotalPiles,
            r1.TotalTenThousands,
            isnull(dbctp.TransportPrice,0.0),
            isnull(dbctp.TransportCharges,0.0),
            0.0,
            cu.SettlementExpression,
            case when dbctp2.TransportCharges is null then r1.CarrierTransportCharges else dbctp2.TransportCharges end,
            r1.CreateTime,
            r1.PlanType,
            r1.CustomerId,
            r1.CustomerName,
            r1.StartCountry,
            r1.StartProvince,
            r1.StartCity,
            r1.IsInstalment,
            r1.DeliverPlanCreateTime,
            cu.ValuationMode,
            cu.GrossWeightRate,
            r1.CarType
        from 
            (
	            select 
		            db.Id,
                    dp.ShipmentNo,
                    dp.DeliveryNo,
		            dp.StartCountry,
		            dp.StartProvince,
		            dp.StartCity,
		            db.ReceiverCountry,
		            db.ReceiverProvince,
		            db.ReceiverCity,
                    db.ReceiverAddress,
		            convert(nvarchar(10),db.CreateTime,120) as CreateTime,
                    dbdp.KM,
                    ca.BusinessType as CarrierBusinessType,
		            dg.TotalPackages,
		            dg.TotalTunnages,
		            dg.TotalPiles,
		            dg.TotalTenThousands,
                    dbdp.TransportCharges as CarrierTransportCharges,
		            dp.PayerId as CustomerId,
                    dp.PayerName as CustomerName,
                    dp.ReceiveType,
			        dp.PlanType,
                    dp.IsInstalment,
                    convert(nvarchar(10),dp.CreateTime,120) as DeliverPlanCreateTime,
                    db2.CarType
	            from 
		            DeliverBill db join 
		            (
			            select 
				            DeliverBillId,
				            isnull(sum(Packages),0) as TotalPackages,
				            isnull(sum(Tunnages),0.0) as TotalTunnages,
				            isnull(sum(Piles),0.0) as TotalPiles,
				            isnull(sum(TenThousands),0.0) as TotalTenThousands
			            from 
				            DeliverBillGoods 
			            group by 
				            DeliverBillId 
		            ) as dg on db.Id = dg.DeliverBillId join 
		            (
			            select 
				            Id,
                            ShipmentNo,
                            DeliveryNo,
				            StartCountry,
				            StartProvince,
				            StartCity,
				            PayerId,
                            PayerName,
                            ReceiveType,
                            PlanType,
                            IsInstalment,
                            CreateTime 
			            from 
				            DeliverPlan 
		            ) as dp on db.PlanId = dp.Id join 
		            (
			            select 
                            DispatchBillId, 
                            PlanId, 
                            convert(nvarchar,KM) as KM,
                            TransportCharges 
                        from 
                            DispatchBillDeliverPlan 
		            ) as dbdp on db.DispatchBillId = dbdp.DispatchBillId and db.PlanId = dbdp.PlanId join
                    (
                        select 
                            Id,
                            CarType
                        from 
                            DispatchBill
                    ) as db2 on db.DispatchBillId = db2.Id join 
                    Carrier ca on db.CarrierId = ca.Id 
            ) as r1 join 
            Customer cu on r1.CustomerId = cu.Id left join 
            DeliverBillCustomerTransportPrice dbctp on r1.Id = dbctp.DeliverBillId left join
            DeliverBillCarrierTransportPrice dbctp2 on r1.Id = dbctp2.DeliverBillId 
        where 
            (r1.ReceiveType <> formatmessage(150347)) and
            (r1.CreateTime >= @StartTime) and 
            (r1.CreateTime <= @EndTime)
    end
    else
    begin
        insert into #LoadCustomerTotalOutputDetailsByConditions 
            (
	            Id,
	            ShipmentNo,
                DeliveryNo,
                ReceiverCountry,
                ReceiverProvince,
                ReceiverCity,
                ReceiverAddress,
                KM,
                CarrierBusinessType,
                TotalPackages,
                TotalTunnages,
                TotalPiles,
                TotalTenThousands,
                CustomerTransportPrice,
                CustomerTransportCharges,
                CustomerRiverCrossingCharges,
                CustomerSettlementExpression,
                CarrierTransportCharges,
                CreateTime,
                PlanType,
                CustomerId,
                CustomerName,
                StartCountry,
                StartProvince,
                StartCity,
                IsInstalment,
                DeliverPlanCreateTime,
                ValuationMode,
                GrossWeightRate,
                CarType
            )
        select 
            r1.Id,
            r1.ShipmentNo,
            r1.DeliveryNo,
            r1.ReceiverCountry,
            r1.ReceiverProvince,
            r1.ReceiverCity,
            r1.ReceiverAddress,
            r1.KM,
            r1.CarrierBusinessType,
            r1.TotalPackages,
            r1.TotalTunnages,
            r1.TotalPiles,
            r1.TotalTenThousands,
            isnull(dbctp.TransportPrice,0.0),
            isnull(dbctp.TransportCharges,0.0),
            0.0,
            cu.SettlementExpression,
            case when dbctp2.TransportCharges is null then r1.CarrierTransportCharges else dbctp2.TransportCharges end,
            r1.CreateTime,
            r1.PlanType,
            r1.CustomerId,
            r1.CustomerName,
            r1.StartCountry,
            r1.StartProvince,
            r1.StartCity,
            r1.IsInstalment,
            r1.DeliverPlanCreateTime,
            cu.ValuationMode,
            cu.GrossWeightRate,
            r1.CarType
        from 
            (
	            select 
		            db.Id,
                    dp.ShipmentNo,
                    dp.DeliveryNo,
		            dp.StartCountry,
		            dp.StartProvince,
		            dp.StartCity,
		            db.ReceiverCountry,
		            db.ReceiverProvince,
		            db.ReceiverCity,
                    db.ReceiverAddress,
		            convert(nvarchar(10),db.CreateTime,120) as CreateTime,
                    dbdp.KM,
                    ca.BusinessType as CarrierBusinessType,
		            dg.TotalPackages,
		            dg.TotalTunnages,
		            dg.TotalPiles,
		            dg.TotalTenThousands,
                    dbdp.TransportCharges as CarrierTransportCharges,
		            dp.PayerId as CustomerId,
                    dp.PayerName as CustomerName,
                    dp.ReceiveType,
			        dp.PlanType,
                    dp.IsInstalment,
                    convert(nvarchar(10),dp.CreateTime,120) as DeliverPlanCreateTime,
                    db2.CarType
	            from 
		            DeliverBill db join 
		            (
			            select 
				            DeliverBillId,
				            isnull(sum(Packages),0) as TotalPackages,
				            isnull(sum(Tunnages),0.0) as TotalTunnages,
				            isnull(sum(Piles),0.0) as TotalPiles,
				            isnull(sum(TenThousands),0.0) as TotalTenThousands
			            from 
				            DeliverBillGoods 
			            group by 
				            DeliverBillId 
		            ) as dg on db.Id = dg.DeliverBillId join 
		            (
			            select 
				            Id,
                            ShipmentNo,
                            DeliveryNo,
				            StartCountry,
				            StartProvince,
				            StartCity,
				            PayerId,
                            PayerName,
                            ReceiveType,
                            PlanType,
                            IsInstalment,
                            CreateTime 
			            from 
				            DeliverPlan 
		            ) as dp on db.PlanId = dp.Id join 
		            (
			            select 
                            DispatchBillId, 
                            PlanId, 
                            convert(nvarchar,KM) as KM,
                            TransportCharges 
                        from 
                            DispatchBillDeliverPlan 
		            ) as dbdp on db.DispatchBillId = dbdp.DispatchBillId and db.PlanId = dbdp.PlanId join
                    (
                        select 
                            Id,
                            CarType
                        from 
                            DispatchBill
                    ) as db2 on db.DispatchBillId = db2.Id join 
                    Carrier ca on db.CarrierId = ca.Id 
            ) as r1 join 
            Customer cu on r1.CustomerId = cu.Id left join 
            DeliverBillCustomerTransportPrice dbctp on r1.Id = dbctp.DeliverBillId left join
            DeliverBillCarrierTransportPrice dbctp2 on r1.Id = dbctp2.DeliverBillId 
        where 
            (r1.ReceiveType <> formatmessage(150347)) and
            (r1.CreateTime >= @StartTime) and 
            (r1.CreateTime <= @EndTime) and 
            (r1.CustomerName = @CustomerName)
    end
    
    /**/
    declare Cursor1 cursor local for 
        select 
	        Id,
            CustomerId,
	        ShipmentNo,
            CreateTime,
            StartCountry,
            StartProvince,
            StartCity,
            ReceiverCountry,
            ReceiverProvince,
            ReceiverCity,
            TotalTunnages,
            TotalPiles,
            ValuationMode,
            GrossWeightRate,
            PlanType,
            IsInstalment,
            DeliverPlanCreateTime,
            CarType
        from 
            #LoadCustomerTotalOutputDetailsByConditions 
        where 
            CustomerTransportPrice = 0
            
    open Cursor1
    fetch next from Cursor1 into 
        @Id, 
        @CustomerId, 
        @ShipmentNo, 
        @DeliverBillCreateTime, 
        @StartCountry, 
        @StartProvince, 
        @StartCity, 
        @DestCountry, 
        @DestProvince, 
        @DestCity, 
        @TotalTunnages, 
        @TotalPiles, 
        @ValuationMode, 
        @GrossWeightRate, 
        @PlanType, 
        @IsInstalment, 
        @DeliverPlanCreateTime,
        @CarType

    while @@fetch_status = 0
    begin
        set @CustomerTransportPrice = 0
        
        /**/
        if @PlanType = formatmessage(150257) or @PlanType = formatmessage(150619)
        begin
            select 
                @CustomerTransportPrice = TransportPrice,
                @CustomerRiverCrossingCharges = RiverCrossingCharges
            from 
                CustomerTransportPrice 
            where 
                CustomerId = @CustomerId and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @DestCountry and 
                DestProvince = @DestProvince and 
                DestCity = @DestCity and 
                @TotalPiles * @GrossWeightRate >= MinTunnagesOrPiles and 
                @TotalPiles * @GrossWeightRate < MaxTunnagesOrPiles and 
                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                (
                    CarType is not null and 
                    CarType <> '' and 
                    CarType = @CarType
                )
            if @@rowcount = 0
            begin
                select 
                    @CustomerTransportPrice = TransportPrice,
                    @CustomerRiverCrossingCharges = RiverCrossingCharges
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @TotalPiles * @GrossWeightRate >= MinTunnagesOrPiles and 
                    @TotalPiles * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is null or
                        CarType = ''
                    )
                if @@rowcount = 0
                begin
                    set @CustomerTransportPrice = 0
                    set @CustomerRiverCrossingCharges = 0
                end
            end
        end
        else
        begin
            /**/
            if @PlanType = formatmessage(150256) or @PlanType = formatmessage(150518)
            begin
                /**/
                if @ValuationMode = formatmessage(150520)
                begin
                    select 
                        @CustomerTransportPrice = TransportPrice,
                        @CustomerRiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    if @@rowcount = 0
                    begin
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @CustomerRiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is null or
                                CarType = ''
                            )
                        if @@rowcount = 0
                        begin
                            set @CustomerTransportPrice = 0
                            set @CustomerRiverCrossingCharges = 0
                        end
                    end
                end
                /**/
                else if @ValuationMode = formatmessage(150521)
                begin
                    /**/
                    select 
                        @TotalTunnages = isnull(sum(Tunnages),0.0) 
                    from 
                        DeliverBillGoods 
                    where 
                        DeliverBillId in 
                        (
                            select 
                                Id 
                            from 
                                DeliverBill 
                            where 
                                PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan
                                    where 
                                        ShipmentNo = @ShipmentNo 
                                ) 
                        )
                    
                    if @TotalTunnages is null 
                    begin
                        set @TotalTunnages = 0
                    end
            
                    /**/
                    select 
                        @CustomerTransportPrice = TransportPrice,
                        @CustomerRiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    if @@rowcount = 0
                    begin
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @CustomerRiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is null or 
                                CarType = ''
                            )
                        if @@rowcount = 0
                        begin
                            set @CustomerTransportPrice = 0
                            set @CustomerRiverCrossingCharges = 0
                        end
                    end
                end
                /**/
                else
                begin
                    /**/
                    if @IsInstalment is null or @IsInstalment = 0
                    begin
                        /**/
                        select 
                            @TotalTunnages = isnull(sum(Tunnages),0.0) 
                        from 
                            DeliverBillGoods  
                        where 
                            DeliverBillId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverBill 
                                where 
                                    PlanId in 
                                    (
                                        select 
                                            Id 
                                        from 
                                            DeliverPlan 
                                        where 
                                            convert(nvarchar(10), CreateTime, 120) = @DeliverPlanCreateTime and 
                                            ReceiverCountry = @DestCountry and 
                                            ReceiverProvince = @DestProvince and 
                                            ReceiverCity = @DestCity
                                    ) 
                            )
                        
                        if @TotalTunnages is null 
                        begin
                            set @TotalTunnages = 0
                        end
            
                        /**/
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @CustomerRiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is not null and 
                                CarType <> '' and 
                                CarType = @CarType
                            )
                        if @@rowcount = 0
                        begin
                            select 
                                @CustomerTransportPrice = TransportPrice,
                                @CustomerRiverCrossingCharges = RiverCrossingCharges
                            from 
                                CustomerTransportPrice 
                            where 
                                CustomerId = @CustomerId and 
                                StartCountry = @StartCountry and 
                                StartProvince = @StartProvince and 
                                StartCity = @StartCity and 
                                DestCountry = @DestCountry and 
                                DestProvince = @DestProvince and 
                                DestCity = @DestCity and 
                                @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                                @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                                (
                                    CarType is null or
                                    CarType = ''
                                )
                            if @@rowcount = 0
                            begin
                                set @CustomerTransportPrice = 0
                                set @CustomerRiverCrossingCharges = 0
                            end
                        end
                    end
                    /**/
                    else
                    begin
                        /**/
                        select 
                            @TotalTunnages = isnull(sum(Tunnages),0.0) 
                        from 
                            DeliverBillGoods  
                        where 
                            DeliverBillId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverBill 
                                where 
                                    PlanId in 
                                    (
                                        select 
                                            Id 
                                        from 
                                            DeliverPlan 
                                        where 
                                            convert(nvarchar(10), CreateTime, 120) = @DeliverBillCreateTime and 
                                            ReceiverCountry = @DestCountry and 
                                            ReceiverProvince = @DestProvince and 
                                            ReceiverCity = @DestCity
                                    ) 
                            )
                        
                        if @TotalTunnages is null 
                        begin
                            set @TotalTunnages = 0
                        end
            
                        /*4.3.2.2.*/
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @CustomerRiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is not null and 
                                CarType <> '' and 
                                CarType = @CarType
                            )
                        if @@rowcount = 0
                        begin
                            select 
                                @CustomerTransportPrice = TransportPrice,
                                @CustomerRiverCrossingCharges = RiverCrossingCharges
                            from 
                                CustomerTransportPrice 
                            where 
                                CustomerId = @CustomerId and 
                                StartCountry = @StartCountry and 
                                StartProvince = @StartProvince and 
                                StartCity = @StartCity and 
                                DestCountry = @DestCountry and 
                                DestProvince = @DestProvince and 
                                DestCity = @DestCity and 
                                @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                                @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                                (
                                    CarType is null or
                                    CarType = ''
                                )
                            if @@rowcount = 0
                            begin
                                set @CustomerTransportPrice = 0
                                set @CustomerRiverCrossingCharges = 0
                            end
                        end
                    end
                end
            end
            /**/
            else
            begin
                select 
                    @CustomerTransportPrice = TransportPrice,
                    @CustomerRiverCrossingCharges = RiverCrossingCharges
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    abs(@TotalTunnages) * @GrossWeightRate >= MinTunnagesOrPiles and 
                    abs(@TotalTunnages) * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is not null and 
                        CarType <> '' and 
                        CarType = @CarType
                    )
                if @@rowcount = 0
                begin
                    select 
                        @CustomerTransportPrice = TransportPrice,
                        @CustomerRiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        abs(@TotalTunnages) * @GrossWeightRate >= MinTunnagesOrPiles and 
                        abs(@TotalTunnages) * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is null or
                            CarType = ''
                        )
                    if @@rowcount = 0
                    begin
                        set @CustomerTransportPrice = 0
                        set @CustomerRiverCrossingCharges = 0
                    end
                end
            end
        end
        
        /**/
        if @CustomerTransportPrice is null
        begin
            set @CustomerTransportPrice = 0
        end
        
        if @CustomerRiverCrossingCharges is null
        begin
            set @CustomerRiverCrossingCharges = 0
        end
        
        update #LoadCustomerTotalOutputDetailsByConditions set 
            CustomerTransportPrice = @CustomerTransportPrice, 
            CustomerRiverCrossingCharges = @CustomerRiverCrossingCharges 
        where 
            Id = @Id 
    
        fetch next from Cursor1 into 
            @Id, 
            @CustomerId, 
            @ShipmentNo, 
            @DeliverBillCreateTime, 
            @StartCountry, 
            @StartProvince, 
            @StartCity, 
            @DestCountry, 
            @DestProvince, 
            @DestCity, 
            @TotalTunnages, 
            @TotalPiles, 
            @ValuationMode, 
            @GrossWeightRate, 
            @PlanType, 
            @IsInstalment, 
            @DeliverPlanCreateTime,
            @CarType
    end 
        
    close Cursor1
    deallocate Cursor1 
    
    /**/
    select * from #LoadCustomerTotalOutputDetailsByConditions
    
    
    /**/
    select @OpName = formatmessage(150505)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'CustomerName=' + @CustomerName 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadCustomerTransportChargesSettlementDetails 
@CustomerTransportChargesSettlementId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        id.Id,
        id.CustomerTransportChargesSettlementId,
        id.DeliverBillId,
        r0.DeliverBillNo,
        r0.CustomerId,
        r0.CustomerName,
        r0.ShipmentNo,
        r0.DeliveryNo,
        r0.CreateTime,
        r0.ReceiverName,
        r0.GoodsName,
        r0.CarNo,
        r0.StartCountry,
        r0.StartProvince,
        r0.StartCity,
        r0.ReceiverCountry,
        r0.ReceiverProvince,
        r0.ReceiverCity,
        r0.ReceiverAddress,
        r0.TotalPackages as Packages,
        r0.TotalTunnages as Tunnages,
        r0.TotalPiles as Piles,
        r0.TotalTenThousands as TenThousands,
        id.TransportPrice,
        id.TransportCharges,
        id.CarpoolFee,
        id.RiverCrossingCharges
    from 
        CustomerTransportChargesSettlementDetail id join 
        (
            select 
	            r1.Id,
                r1.DeliverBillNo,
	            r1.CustomerId,
	            r1.CustomerName,
	            r1.ShipmentNo,
	            r1.DeliveryNo,
	            r1.CreateTime,
	            r1.ReceiverName,
	            r1.GoodsName,
	            r1.CarNo,
	            r1.StartCountry,
	            r1.StartProvince,
	            r1.StartCity,
	            r1.ReceiverCountry,
	            r1.ReceiverProvince,
	            r1.ReceiverCity,
                r1.ReceiverAddress,
	            r1.TotalPackages,
	            r1.TotalTunnages,
	            r1.TotalPiles,
	            r1.TotalTenThousands 
            from 
	            (
		            select 
			            db.Id,
                        db.BillNo as DeliverBillNo,
			            db.PlanId,
			            dp.PayerId as CustomerId,
			            dp.PayerName as CustomerName,
			            dp.ShipmentNo,
			            dp.DeliveryNo,
			            convert(nvarchar(10),db.CreateTime,120) as CreateTime,
			            db.ReceiverName,
			            gn.GoodsName,
			            db.CarNo,
			            db.CarrierName,
			            dp.StartCountry,
			            dp.StartProvince,
			            dp.StartCity,
			            db.ReceiverCountry,
			            db.ReceiverProvince,
			            db.ReceiverCity,
                        db.ReceiverAddress,
			            dg.TotalPackages,
			            dg.TotalTunnages,
			            dg.TotalPiles,
			            dg.TotalTenThousands 
		            from 
			            DeliverBill db join 
			            (
				            select 
					            DeliverBillId,
					            sum(Packages) as TotalPackages,
					            sum(Tunnages) as TotalTunnages,
					            sum(Piles) as TotalPiles,
					            sum(TenThousands) as TotalTenThousands
				            from 
					            DeliverBillGoods 
				            group by 
					            DeliverBillId 
			            ) as dg on db.Id = dg.DeliverBillId join 
			            (
				            select 
					            Id,
					            ShipmentNo,
					            DeliveryNo,
					            StartCountry,
					            StartProvince,
					            StartCity,
					            PayerId,
					            PayerName 
				            from 
					            DeliverPlan 
			            ) as dp on db.PlanId = dp.Id join 
			            (
				            select 
					            a.DeliverBillId,
					            b.GoodsName
				            from
					            (
						            select distinct DeliverBillId from DeliverBillGoods 
					            ) as a outer apply
					            (
						            select 
							            GoodsName = stuff(replace(replace(
							            (
								            select distinct
									            GoodsName 
								            from 
									            DeliverBillGoods 
								            where 
									            DeliverBillId = a.DeliverBillId
								            for xml auto
							            ), '<DeliverBillGoods GoodsName="', ','), '"/>', ''), 1, 1, '')
					        ) as b
			            ) as gn on db.Id = gn.DeliverBillId 
	            ) as r1 
        ) as r0 on id.DeliverBillId = r0.Id 
    where 
        id.CustomerTransportChargesSettlementId = @CustomerTransportChargesSettlementId
    
    
    /**/
    select @OpName = formatmessage(150492)
    select @OpParams = N'CustomerTransportChargesSettlementId=' + convert(nvarchar,@CustomerTransportChargesSettlementId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCustomerTransportChargesSettlementsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@InvoiceNo nvarchar(50),
@DeliverBillNo nvarchar(50),
@CustomerName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = 'select * from CustomerTransportChargesSettlement '
    set @WhereSql = ''

    if @StartTime is not null and @StartTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Id in (select distinct id.CustomerTransportChargesSettlementId from CustomerTransportChargesSettlementDetail id join DeliverBill db on id.DeliverBillId = db.Id where convert(nvarchar(10),db.CreateTime,120) >= ''' + @StartTime + '''))'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Id in (select distinct id.CustomerTransportChargesSettlementId from CustomerTransportChargesSettlementDetail id join DeliverBill db on id.DeliverBillId = db.Id where convert(nvarchar(10),db.CreateTime,120) <= ''' + @EndTime + '''))'
    end
    
    if @InvoiceNo is not null and @InvoiceNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(InvoiceNo = ''' + @InvoiceNo + ''')'
    end

    if @DeliverBillNo is not null and @DeliverBillNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Id in (select distinct id.CustomerTransportChargesSettlementId from CustomerTransportChargesSettlementDetail id join DeliverBill db on id.DeliverBillId = db.Id where db.BillNo = ''' + @DeliverBillNo + '''))'
    end

    if @CustomerName is not null and @CustomerName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(CustomerName = ''' + @CustomerName + ''')'
    end
    
    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    set @SelectSql = @SelectSql + ' order by Id '
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150490,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150491)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'InvoiceNo=' + @InvoiceNo + N',' +
                       N'DeliverBillNo=' + @DeliverBillNo + N',' +
                       N'CustomerName=' + @CustomerName 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadCustomerTransportPriceByPlanId 
@PlanId bigint,
@CarType nvarchar(10),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @PlanType nvarchar(10)
declare @ShipmentNo nvarchar(20)
declare @StartCountry nvarchar(20)
declare @StartProvince nvarchar(20)
declare @StartCity nvarchar(20)
declare @DestCountry nvarchar(20)
declare @DestProvince nvarchar(20)
declare @DestCity nvarchar(20)
declare @CustomerId bigint
declare @IsInstalment bit
declare @CreateTime datetime
declare @ValuationMode nvarchar(20)
declare @GrossWeightRate numeric(25,9)
declare @TotalTunnages numeric(25,9)
declare @TotalPiles numeric(25,9)
declare @CustomerTransportPriceId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /*1.*/
    select 
        @PlanType = PlanType,
        @ShipmentNo = ShipmentNo,
        @StartCountry = StartCountry,
        @StartProvince = StartProvince,
        @StartCity = StartCity,
        @DestCountry = ReceiverCountry,
        @DestProvince = ReceiverProvince,
        @DestCity = ReceiverCity,
        @CustomerId = PayerId,
        @IsInstalment = IsInstalment,
        @CreateTime = CreateTime 
    from 
        DeliverPlan 
    where 
        Id = @PlanId 
        
    if @@rowcount = 0
    begin
        raiserror (150261,18,1)
        return -1
    end

    /*2.*/
    select @ValuationMode = ValuationMode, @GrossWeightRate = GrossWeightRate from Customer where Id = @CustomerId 
    
    if @@rowcount = 0
    begin
        raiserror (150082,18,1)
        return -1
    end
    
    /*3.*/
    if @PlanType = formatmessage(150257) or @PlanType = formatmessage(150619)
    begin
        /*3.1.*/
        select @TotalPiles = isnull(sum(Piles),0.0) from DeliverPlanGoods where PlanId = @PlanId 
        if @TotalPiles is null 
        begin
            set @TotalPiles = 0
        end
        
        /*3.2.*/
        select 
            @CustomerTransportPriceId = Id
        from 
            CustomerTransportPrice 
        where 
            CustomerId = @CustomerId and 
            StartCountry = @StartCountry and 
            StartProvince = @StartProvince and 
            StartCity = @StartCity and 
            DestCountry = @DestCountry and 
            DestProvince = @DestProvince and 
            DestCity = @DestCity and 
            @TotalPiles * @GrossWeightRate >= MinTunnagesOrPiles and 
            @TotalPiles * @GrossWeightRate < MaxTunnagesOrPiles and 
            @CreateTime >= convert(nvarchar(10),StartTime,120) and 
            @CreateTime <= convert(nvarchar(10),EndTime,120) and 
            (
                CarType is not null and CarType <> '' and CarType = @CarType
            )
        if @@rowcount = 0
        begin
            select 
                @CustomerTransportPriceId = Id
            from 
                CustomerTransportPrice 
            where 
                CustomerId = @CustomerId and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @DestCountry and 
                DestProvince = @DestProvince and 
                DestCity = @DestCity and 
                @TotalPiles * @GrossWeightRate >= MinTunnagesOrPiles and 
                @TotalPiles * @GrossWeightRate < MaxTunnagesOrPiles and 
                @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                (
                    CarType is null or CarType = ''
                )
        end
    end
    else
    begin
        /*4.*/
        if @PlanType = formatmessage(150256) or @PlanType = formatmessage(150518)
        begin
            /*4.1.*/
            if @ValuationMode = formatmessage(150520)
            begin
                /*4.1.1.*/
                select @TotalTunnages = isnull(sum(Tunnages),0.0) from DeliverPlanGoods where PlanId = @PlanId 
                if @TotalTunnages is null 
                begin
                    set @TotalTunnages = 0
                end
            
                /*4.1.2.*/
                select 
                    @CustomerTransportPriceId = Id
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                    @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is not null and CarType <> '' and CarType = @CarType
                    )
                if @@rowcount = 0
                begin
                    select 
                        @CustomerTransportPriceId = Id
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is null or CarType = ''
                        )
                end
            end
            /*4.2.*/
            else if @ValuationMode = formatmessage(150521)
            begin
                /*4.1.1.*/
                select 
                    @TotalTunnages = isnull(sum(Tunnages),0.0) 
                from 
                    DeliverPlanGoods 
                where 
                    PlanId in 
                    (
                        select 
                            Id 
                        from 
                            DeliverPlan
                        where 
                            ShipmentNo = @ShipmentNo 
                    )
                    
                if @TotalTunnages is null 
                begin
                    set @TotalTunnages = 0
                end
            
                /*4.1.2.*/
                select 
                    @CustomerTransportPriceId = Id
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                    @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is not null and CarType <> '' and CarType = @CarType
                    )
                if @@rowcount = 0
                begin
                    select 
                        @CustomerTransportPriceId = Id
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is null or CarType = ''
                        )
                end
            end
            /*4.3.*/
            else
            begin
                /*4.3.1.*/
                if @IsInstalment is null or @IsInstalment = 0
                begin
                    /*4.3.1.1.*/
                    select 
                        @TotalTunnages = isnull(sum(Tunnages),0.0) 
                    from 
                        DeliverPlanGoods  
                    where 
                        PlanId in 
                        (
                            select 
                                Id 
                            from 
                                DeliverPlan 
                            where 
                                convert(nvarchar(10), CreateTime, 120) = convert(nvarchar(10), @CreateTime, 120) and 
                                ReceiverCountry = @DestCountry and 
                                ReceiverProvince = @DestProvince and 
                                ReceiverCity = @DestCity
                        )
                        
                    if @TotalTunnages is null 
                    begin
                        set @TotalTunnages = 0
                    end
            
                    /*4.3.1.2.*/
                    select 
                        @CustomerTransportPriceId = Id
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is not null and CarType <> '' and CarType = @CarType
                        )
                    if @@rowcount = 0
                    begin
                        select 
                            @CustomerTransportPriceId = Id
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is null or CarType = ''
                            )
                    end
                end
                /*4.3.2.*/
                else
                begin
                    /*4.3.2.1.*/
                    select 
                        @TotalTunnages = isnull(sum(Tunnages),0.0) 
                    from 
                        DeliverPlanGoods  
                    where 
                        PlanId in 
                        (
                            select 
                                Id 
                            from 
                                DeliverPlan 
                            where 
                                convert(nvarchar(10), CreateTime, 120) = convert(nvarchar(10), getdate(), 120) and 
                                ReceiverCountry = @DestCountry and 
                                ReceiverProvince = @DestProvince and 
                                ReceiverCity = @DestCity
                        )
                        
                    if @TotalTunnages is null 
                    begin
                        set @TotalTunnages = 0
                    end
            
                    /*4.3.2.2.*/
                    select 
                        @CustomerTransportPriceId = Id
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is not null and CarType <> '' and CarType = @CarType
                        )
                    if @@rowcount = 0
                    begin
                        select 
                            @CustomerTransportPriceId = Id
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is null or CarType = ''
                            )
                    end
                end
            end
        end
        /*5.*/
        else
        begin
            /*5.1.*/
            select @TotalTunnages = isnull(sum(Tunnages),0.0) from DeliverPlanGoods where PlanId = @PlanId 
            if @TotalTunnages is null 
            begin
                set @TotalTunnages = 0
            end
            
            /*5.2.*/
            select 
                @CustomerTransportPriceId = Id
            from 
                CustomerTransportPrice 
            where 
                CustomerId = @CustomerId and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @DestCountry and 
                DestProvince = @DestProvince and 
                DestCity = @DestCity and 
                @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                (
                    CarType is not null and CarType <> '' and CarType = @CarType
                )
            if @@rowcount = 0
            begin
                select 
                    @CustomerTransportPriceId = Id
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                    @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @CreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @CreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is null or CarType = ''
                    )
            end
        end
    end
    
    select * from CustomerTransportPrice where Id = @CustomerTransportPriceId
    

    /**/
    select @OpName = formatmessage(150512)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                       N'CarType=' + @CarType
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCustomerTransportPricesByCustomerId 
@CustomerId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    select * from CustomerTransportPrice where CustomerId = @CustomerId order by StartTime
   
   
    /**/
    set @OpName = formatmessage(150136)
    set @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure LoadCustomers 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    SELECT a.* FROM Customer a 
   
   
    /**/
    set @OpName = formatmessage(150136)
    set @OpParams = N'' 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadCustomersByConditions 
@Name nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = 'select * from Customer '
    set @WhereSql = ''
    
    if @Name is not null and @Name <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(Name like ''%' + @Name + '%'')'
    end

    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    
    exec (@SelectSql)
    
    
    /**/
    select @OpName = formatmessage(150627)
    select @OpParams = N'Name=' + @Name 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDeliverBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        db.*,
        dp.PlanType,
        dp.PlanNo,
        dp.ShipmentNo,
        dp.ReceiveType,
        dp.OrderNo,
        dp.Remark,
        isnull(dbg.TotalPackages,0) as TotalPackages,
        isnull(dbg.TotalTunnages,0.0) as TotalTunnages,
        isnull(dbg.TotalPiles,0.0) as TotalPiles,
        isnull(dbg.TotalTenThousands,0.0) as TotalTenThousands,
        isnull(sng.TotalTunnages,0.0) as ShipmentBillTotalTunnages,
        isnull(sng.TotalPiles,0.0) as ShipmentBillTotalPiles
    from 
        DeliverBill db join 
        DeliverPlan dp on db.PlanId = dp.Id left join 
        (
            select 
                DeliverBillId,
                isnull(sum(Packages),0) as TotalPackages,
                isnull(sum(Tunnages),0.0) as TotalTunnages,
                isnull(sum(Piles),0.0) as TotalPiles,
                isnull(sum(TenThousands),0.0) as TotalTenThousands 
            from 
                DeliverBillGoods 
            group by 
                DeliverBillId
        ) as dbg on db.Id = dbg.DeliverBillId left join 
        (
            /**/
            select 
	            dp.ShipmentNo,
	            isnull(sum(dbg.Tunnages),0.0) as TotalTunnages,
	            isnull(sum(dbg.Piles),0.0) as TotalPiles 
            from 
	            DeliverBillGoods dbg join 
	            DeliverBill db on dbg.DeliverBillId = db.Id join 
	            DeliverPlan dp on db.PlanId = dp.Id 
            where 
	            dp.ShipmentNo is not null and 
	            dp.ShipmentNo <> ''	
            group by 
	            dp.ShipmentNo 			
        ) as sng on dp.ShipmentNo = sng.ShipmentNo 
    where 
        db.Id = @Id 
        
    if @@rowcount = 0
    begin
        raiserror (150415,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150416)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadDeliverBillAllGoods 
@DeliverBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        dbg.*,
        db.Warehouse,
        ewb.BillNo as EnterWarehouseBillNo
    from 
        DeliverBillGoods dbg left join 
        DeliverBill db on dbg.DeliverBillId = db.Id left join 
        EnterWarehouseBill ewb on dbg.EnterWarehouseBillId = ewb.Id
    where 
        dbg.DeliverBillId = @DeliverBillId
    
    
    /**/
    select @OpName = formatmessage(150414)
    select @OpParams = N'DeliverBillId=' + convert(nvarchar,@DeliverBillId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDeliverBillByNo 
@DeliverBillNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        db.*,
        db2.CarrierId,
        db2.CarrierName,
        db2.CarNo,
        db2.CarType,
        dp.PlanNo,
        dp.ShipmentNo,
        isnull(dbg.TotalPackages,0) as TotalPackages,
        isnull(dbg.TotalTunnages,0.0) as TotalTunnages,
        isnull(dbg.TotalPiles,0.0) as TotalPiles,
        isnull(dbg.TotalTenThousands,0.0) as TotalTenThousands,
        isnull(sng.TotalTunnages,0.0) as ShipmentBillTotalTunnages,
        isnull(sng.TotalPiles,0.0) as ShipmentBillTotalPiles,
        db3.TransportPrice
    from 
        DeliverBill db join 
        (
            select 
                Id, 
                CarrierId,
                CarrierName,
                CarNo,
                CarType
            from 
                DispatchBill
        ) as db2 on db.DispatchBillId = db2.Id join 
        (
            select 
                DispatchBillId,
                PlanId,
                TransportPrice
            from 
                DispatchBillDeliverPlan
        ) as db3 on db.DispatchBillId = db3.DispatchBillId and db.PlanId = db3.PlanId join 
        DeliverPlan dp on db.PlanId = dp.Id left join 
        (
            select 
                DeliverBillId,
                isnull(sum(Packages),0) as TotalPackages,
                isnull(sum(Tunnages),0.0) as TotalTunnages,
                isnull(sum(Piles),0.0) as TotalPiles,
                isnull(sum(TenThousands),0.0) as TotalTenThousands 
            from 
                DeliverBillGoods 
            group by 
                DeliverBillId
        ) as dbg on db.Id = dbg.DeliverBillId left join 
        (
            /**/
            select 
	            dp.ShipmentNo,
	            isnull(sum(dbg.Tunnages),0.0) as TotalTunnages,
	            isnull(sum(dbg.Piles),0.0) as TotalPiles 
            from 
	            DeliverBillGoods dbg join 
	            DeliverBill db on dbg.DeliverBillId = db.Id join 
	            DeliverPlan dp on db.PlanId = dp.Id 
            where 
	            dp.ShipmentNo is not null and 
	            dp.ShipmentNo <> ''	
            group by 
	            dp.ShipmentNo 			
        ) as sng on dp.ShipmentNo = sng.ShipmentNo 
    where 
        db.BillNo = @DeliverBillNo 
        
    if @@rowcount = 0
    begin
        raiserror (150506,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150507)
    select @OpParams = N'DeliverBillNo=' + @DeliverBillNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadDeliverBillCarrierTransportPriceByDeliverBillId 
@DeliverBillId nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select * from DeliverBillCarrierTransportPrice where DeliverBillId = @DeliverBillId 
        
    
    /**/
    select @OpName = formatmessage(150693)
    select @OpParams = N'DeliverBillId=' + @DeliverBillId 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDeliverBillCarrierTransportPricesByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@DeliverBillNo nvarchar(50),
@CarNo nvarchar(50),
@DeliveryNo nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @Sql1 nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @Sql = 'select 
	                r1.Id,
	                r1.DeliverBillId,
	                r1.DeliverBillNo,
	                r1.DeliveryNo,
	                r1.CarrierId,
	                r1.CarrierName,
	                r1.CarNo,
                    r1.DispatchedTransportPrice,
	                r1.TransportPrice,
                    r1.TransportCharges,
	                r1.Remark,
	                r1.CreatorId,
	                r1.CreatorName,
	                r1.CreateTime 
                from 
	                (
		                select 
			                dbctp.*, 
			                db.BillNo as DeliverBillNo, 
			                db.DeliveryNo, 
                            db.CarNo,
                            db.CarrierId,
                            db.CarrierName,
                            dbdp.TransportPrice as DispatchedTransportPrice
		                from 
			                DeliverBillCarrierTransportPrice dbctp join 
			                DeliverBill db on dbctp.DeliverBillId = db.Id join
                            DispatchBillDeliverPlan dbdp on db.DispatchBillId = dbdp.DispatchBillId and db.PlanId = dbdp.PlanId
	                ) as r1 '
    
    set @Sql1 = ''
    
    if @StartTime is not null and @StartTime <> ''
    begin
        if @Sql1 <> '' set @Sql1 = @Sql1 + ' and '
        set @Sql1 = @Sql1 + '(convert(nvarchar(10),r1.CreateTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @Sql1 <> '' set @Sql1 = @Sql1 + ' and '
        set @Sql1 = @Sql1 + '(convert(nvarchar(10),r1.CreateTime,120) <= ''' + @EndTime + ''')'
    end
    
    if @DeliverBillNo is not null and @DeliverBillNo <> ''
    begin
        if @Sql1 <> '' set @Sql1 = @Sql1 + ' and '
        set @Sql1 = @Sql1 + '(r1.DeliverBillNo = ''' + @DeliverBillNo + ''')'
    end

    if @CarNo is not null and @CarNo <> ''
    begin
        if @Sql1 <> '' set @Sql1 = @Sql1 + ' and '
        set @Sql1 = @Sql1 + '(r1.CarNo = ''' + @CarNo + ''')'
    end
    
    if @DeliveryNo is not null and @DeliveryNo <> ''
    begin
        if @Sql1 <> '' set @Sql1 = @Sql1 + ' and '
        set @Sql1 = @Sql1 + '(r1.DeliveryNo = ''' + @DeliveryNo + ''')'
    end
    
    if @Sql1 <> '' set @Sql = @Sql + ' where ' + @Sql1 
    
    exec(@Sql)
    
    if @@error <> 0
    begin
        raiserror (150698,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150699)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'DeliverBillNo=' + @DeliverBillNo + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'DeliveryNo=' + @DeliveryNo 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadDeliverBillCustomerTransportPriceByDeliverBillId 
@DeliverBillId nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select * from DeliverBillCustomerTransportPrice where DeliverBillId = @DeliverBillId 
        
    
    /**/
    select @OpName = formatmessage(150508)
    select @OpParams = N'DeliverBillId=' + @DeliverBillId 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDeliverBillCustomerTransportPricesByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@DeliverBillNo nvarchar(50),
@CustomerName nvarchar(50),
@DeliveryNo nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @Sql1 nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @Sql = 'select 
	                r1.Id,
	                r1.DeliverBillId,
	                r1.DeliverBillNo,
	                r1.ShipmentNo,
	                r1.DeliveryNo,
	                r1.CustomerId,
	                r1.CustomerName,
	                r1.ReceiverName,
                    case when ctp.TransportPrice is null then isnull(ctp2.TransportPrice,0.0) else ctp.TransportPrice end as AgreementTransportPrice,
	                r1.TransportPrice,
                    r1.TransportCharges,
	                r1.Remark,
	                r1.CreatorId,
	                r1.CreatorName,
	                r1.CreateTime 
                from 
	                (
		                select 
			                dbctp.*, 
			                db.BillNo as DeliverBillNo, 
			                db.DeliveryNo, 
			                dp.PayerId as CustomerId, 
			                dp.PayerName as CustomerName, 
			                db.ReceiverName,
			                db.ReceiverCountry,
			                db.ReceiverProvince,
			                db.ReceiverCity,
			                dp.ShipmentNo, 
			                dp.StartCountry,
			                dp.StartProvince,
			                dp.StartCity, 
			                case when dp.PlanType ='''
                            
    set @Sql = @Sql + formatmessage(150257) + ''' or dp.PlanType =''' +  formatmessage(150619)
    
    set @Sql = @Sql + ''' then (case when dp.ShipmentNo is null or dp.ShipmentNo = '''' then dg.TotalPiles else isnull(sg.TotalPiles,0.0) end) else (case when dp.ShipmentNo is null or dp.ShipmentNo = '''' then dg.TotalTunnages else isnull(sg.TotalTunnages,0.0) end) end as TunnagesOrPiles,
                            dp.CreateTime as DeliverPlanCreateTime,
                            db2.CarType
		                from 
			                DeliverBillCustomerTransportPrice dbctp join 
			                DeliverBill db on dbctp.DeliverBillId = db.Id join
                            (
                                select 
                                    Id, 
                                    CarType 
                                from 
                                    DispatchBill
                            ) as db2 on db.DispatchBillId = db2.Id join 
			                (
				                select 
					                DeliverBillId,
					                isnull(sum(Tunnages),0.0) as TotalTunnages,
					                isnull(sum(Piles),0.0) as TotalPiles 
				                from 
					                DeliverBillGoods 
				                group by 
					                DeliverBillId 
			                ) as dg on db.Id = dg.DeliverBillId join 
			                (
				                select 
					                Id,
					                ShipmentNo,
					                StartCountry,
					                StartProvince,
					                StartCity,
					                PayerId,
					                PayerName,
					                PlanType,
                                    CreateTime
				                from 
					                DeliverPlan 
			                ) as dp on db.PlanId = dp.Id left join 
                            (
                                /**/
				                select 
					                dp.ShipmentNo,
					                isnull(sum(dbg.Tunnages),0.0) as TotalTunnages,
					                isnull(sum(dbg.Piles),0.0) as TotalPiles 
				                from 
					                DeliverBillGoods dbg join 
					                DeliverBill db on dbg.DeliverBillId = db.Id join 
					                DeliverPlan dp on db.PlanId = dp.Id 
				                where 
					                dp.ShipmentNo is not null and 
					                dp.ShipmentNo <> ''''
				                group by 
					                dp.ShipmentNo
			                ) as sg on dp.ShipmentNo = sg.ShipmentNo 
	                ) as r1 join '
    set @Sql = @Sql +  '
                    Customer c on r1.CustomerId = c.Id left join 
                    CustomerTransportPrice ctp on r1.CustomerId = ctp.CustomerId and r1.StartCountry = ctp.StartCountry and r1.StartProvince = ctp.StartProvince and r1.StartCity = ctp.StartCity and r1.ReceiverCountry = ctp.DestCountry and r1.ReceiverProvince = ctp.DestProvince and r1.ReceiverCity = ctp.DestCity and r1.TunnagesOrPiles * c.GrossWeightRate >= ctp.MinTunnagesOrPiles and r1.TunnagesOrPiles * c.GrossWeightRate < ctp.MaxTunnagesOrPiles and convert(nvarchar(10),r1.DeliverPlanCreateTime,120) >=
 convert(nvarchar(10),ctp.StartTime,120) and convert(nvarchar(10),r1.DeliverPlanCreateTime,120) <= convert(nvarchar(10),ctp.EndTime,120) and (ctp.CarType is not null and ctp.CarType <> '''' and ctp.CarType = r1.CarType) left join 
                    CustomerTransportPrice ctp2 on r1.CustomerId = ctp2.CustomerId and r1.StartCountry = ctp2.StartCountry and r1.StartProvince = ctp2.StartProvince and r1.StartCity = ctp2.StartCity and r1.ReceiverCountry = ctp2.DestCountry and r1.ReceiverProvince = ctp2.DestProvince and r1.ReceiverCity = ctp2.DestCity and r1.TunnagesOrPiles * c.GrossWeightRate >= ctp2.MinTunnagesOrPiles and r1.TunnagesOrPiles * c.GrossWeightRate < ctp2.MaxTunnagesOrPiles and
 convert(nvarchar(10),r1.DeliverPlanCreateTime,120) >= convert(nvarchar(10),ctp2.StartTime,120) and convert(nvarchar(10),r1.DeliverPlanCreateTime,120) <= convert(nvarchar(10),ctp2.EndTime,120) and (ctp2.CarType is null or ctp2.CarType = '''') '
    
    set @Sql1 = ''
    
    if @StartTime is not null and @StartTime <> ''
    begin
        if @Sql1 <> '' set @Sql1 = @Sql1 + ' and '
        set @Sql1 = @Sql1 + '(convert(nvarchar(10),r1.CreateTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @Sql1 <> '' set @Sql1 = @Sql1 + ' and '
        set @Sql1 = @Sql1 + '(convert(nvarchar(10),r1.CreateTime,120) <= ''' + @EndTime + ''')'
    end
    
    if @DeliverBillNo is not null and @DeliverBillNo <> ''
    begin
        if @Sql1 <> '' set @Sql1 = @Sql1 + ' and '
        set @Sql1 = @Sql1 + '(r1.DeliverBillNo = ''' + @DeliverBillNo + ''')'
    end

    if @CustomerName is not null and @CustomerName <> ''
    begin
        if @Sql1 <> '' set @Sql1 = @Sql1 + ' and '
        set @Sql1 = @Sql1 + '(r1.CustomerName = ''' + @CustomerName + ''')'
    end
    
    if @DeliveryNo is not null and @DeliveryNo <> ''
    begin
        if @Sql1 <> '' set @Sql1 = @Sql1 + ' and '
        set @Sql1 = @Sql1 + '(r1.DeliveryNo = ''' + @DeliveryNo + ''')'
    end
    
    if @Sql1 <> '' set @Sql = @Sql + ' where ' + @Sql1 
    
    exec(@Sql)
    
    if @@error <> 0
    begin
        raiserror (150513,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150514)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'DeliverBillNo=' + @DeliverBillNo + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'DeliveryNo=' + @DeliveryNo 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadDeliverBillNosByNo 
@DeliverBillNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select BillNo from DeliverBill where BillNo like ('%' + @DeliverBillNo + '%')
    
    /**/
    select @OpName = formatmessage(150535)
    select @OpParams = N'DeliverBillNo=' + @DeliverBillNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDeliverBillReceiptsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@CustomerName nvarchar(50),
@DeliveryNo nvarchar(50),
@CarNo nvarchar(50),
@DestCountry nvarchar(50),
@DestProvince nvarchar(50),
@DestCity nvarchar(50),
@OrganId nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    set @Sql = '
        select 
            db.*,
            isnull(dbg.TotalPackages,0) as TotalPackages,
            isnull(dbg.TotalTunnages,0.0) as TotalTunnages,
            isnull(dbg.TotalPiles,0.0) as TotalPiles,
            isnull(dbg.TotalTenThousands,0.0) as TotalTenThousands 
        from 
            DeliverBill db left join 
            (
                select 
                    DeliverBillId,
                    isnull(sum(Packages),0) as TotalPackages,
                    isnull(sum(Tunnages),0.0) as TotalTunnages,
                    isnull(sum(Piles),0.0) as TotalPiles,
                    isnull(sum(TenThousands),0.0) as TotalTenThousands 
                from 
                    DeliverBillGoods 
                group by 
                    DeliverBillId
            ) as dbg on db.Id = dbg.DeliverBillId 
        where 
            (db.OwnOrganId in (select Id from Organization where FullPath like (select o.FullPath + ''%'' from Account a join Organization o on a.OrganId = o.Id where a.Id = ' + convert(nvarchar,@OpStaffId) + ' and a.AccountType = ''' + formatmessage(150162) + ''' and a.IsCancel = 0))) and
            (db.ReturnTime is not null) '
        
    if @StartTime is not null and @StartTime <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(convert(nvarchar(10),db.ReturnTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(convert(nvarchar(10),db.ReturnTime,120) <= ''' + @EndTime + ''')'
    end
    
    if @CustomerName is not null and @CustomerName <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(db.CustomerName like ''%' + @CustomerName + '%'')'
    end
    
    if @DeliveryNo is not null and @DeliveryNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(db.DeliveryNo like ''%' + @DeliveryNo + '%'')'
    end
    
    if @CarNo is not null and @CarNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(db.CarNo like ''%' + @CarNo + '%'')'
    end

    if @DestCountry is not null and @DestCountry <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(db.ReceiverCountry = ''' + @DestCountry + ''')'
    end
    
    if @DestProvince is not null and @DestProvince <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(db.ReceiverProvince = ''' + @DestProvince + ''')'
    end

    if @DestCity is not null and @DestCity <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(db.ReceiverCity = ''' + @DestCity + ''')'
    end

    if @OrganId is not null and @OrganId <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(db.OwnOrganId = ' + @OrganId + ')'
    end

    exec (@Sql)
    
    if @@error <> 0
    begin
        raiserror (150524,18,1)
        return -1
    end
        
    /**/
    select @OpName = formatmessage(150525)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'DestCountry=' + @DestCountry + N',' +
                       N'DestProvince=' + @DestProvince + N',' +
                       N'DestCity=' + @DestCity + N',' +
                       N'OrganId=' + @OrganId 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadDeliverBillsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@DeliverBillNo nvarchar(50),
@CustomerName nvarchar(50),
@PayerName nvarchar(50),
@StartCountry nvarchar(50),
@StartProvince nvarchar(50),
@StartCity nvarchar(50),
@DestCountry nvarchar(50),
@DestProvince nvarchar(50),
@DestCity nvarchar(50),
@CarNo nvarchar(50),
@DeliveryNo nvarchar(50),
@OrganId nvarchar(50),
@PrintState nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @Sql2 nvarchar(max)
declare @CustomerTransportPrice numeric(25,9)
declare @Id bigint
declare @PlanType nvarchar(10)
declare @ShipmentNo nvarchar(20)
declare @CustomerId bigint
declare @IsInstalment bit
declare @DeliverPlanCreateTime nvarchar(10)
declare @ValuationMode nvarchar(20)
declare @GrossWeightRate numeric(25,9)
declare @TotalTunnages numeric(25,9)
declare @TotalPiles numeric(25,9)
declare @DeliverBillCreateTime nvarchar(10)
declare @StartCountry2 nvarchar(50)
declare @StartProvince2 nvarchar(50)
declare @StartCity2 nvarchar(50)
declare @DestCountry2 nvarchar(50)
declare @DestProvince2 nvarchar(50)
declare @DestCity2 nvarchar(50)
declare @RiverCrossingCharges numeric(25,9)
declare @CarType nvarchar(10)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /*1.*/
    create table #LoadDeliverBillsByConditions 
    (
	    Id bigint,
        ShipmentBillId bigint,
        BillNo nvarchar(20),
        CreateTime nvarchar(10),
        DeliveryNo nvarchar(20),
        CarNo nvarchar(20),
        CarType nvarchar(10),
        TrailerNo nvarchar(10),
        CustomerId bigint,
	    CustomerName nvarchar(50),
        ReceiverName nvarchar(50),
        ReceiverCountry nvarchar(20),
        ReceiverProvince nvarchar(20),
        ReceiverCity nvarchar(20),
        ReceiverAddress nvarchar(50),
        ReceiveType nvarchar(10),
        TotalPackages int,
        TotalTunnages numeric(25,9),
        TotalPiles numeric(25,9),
        TotalTenThousands numeric(25,9),
        ContractId bigint,
        ContractNo nvarchar(20),
        OriginalContractNo nvarchar(20),
        TransportCharges numeric(25,9),/**/
        PlanId bigint,
        PlanType nvarchar(10),
        PlanNo nvarchar(20),
        PayerId bigint,
        PayerName nvarchar(50),
	    ShipmentNo nvarchar(20),
        StartCountry nvarchar(20),
        StartProvince nvarchar(20),
        StartCity nvarchar(20),
        GoodsName nvarchar(2000),
        IsCustomerTransportChargesSettled bit,
        IsCarrierTransportChargesSettled bit,
        IsDeliverBillReceiptReceived bit,
        ReturnTime nvarchar(10),
        Remark nvarchar(200),
        KM nvarchar(50),
        IsInstalment bit,
        DeliverPlanCreateTime nvarchar(10),
        SettlementExpression nvarchar(100),
        ValuationMode nvarchar(20),
        GrossWeightRate numeric(25,9),
        CustomerTransportPrice numeric(25,9),
        CustomerTransportCharges numeric(25,9),
        ReverseAmount numeric(25,9),
        TransportChargesBalance numeric(25,9),
        RiverCrossingCharges numeric(25,9)
    )
    
    /**/
    set @Sql = '
        insert into #LoadDeliverBillsByConditions
            (
	            Id,
                ShipmentBillId,
                BillNo,
                CreateTime,
                DeliveryNo,
                CarNo,
                CarType,
                TrailerNo,
                CustomerId,
	            CustomerName,
                ReceiverName,
                ReceiverCountry,
                ReceiverProvince,
                ReceiverCity,
                ReceiverAddress,
                ReceiveType,
                TotalPackages,
                TotalTunnages,
                TotalPiles,
                TotalTenThousands,
                ContractId,
                ContractNo,
                OriginalContractNo,
                TransportCharges,
                PlanId,
                PlanType,
                PlanNo,
                PayerId,
                PayerName,
	            ShipmentNo,
                StartCountry,
                StartProvince,
                StartCity,
                GoodsName,
                IsCustomerTransportChargesSettled,
                IsCarrierTransportChargesSettled,
                IsDeliverBillReceiptReceived,
                ReturnTime,
                Remark,
                KM,
                IsInstalment,
                DeliverPlanCreateTime,
                SettlementExpression,
                ValuationMode,
                GrossWeightRate,
                CustomerTransportPrice,
                CustomerTransportCharges,
                ReverseAmount,
                TransportChargesBalance,
                RiverCrossingCharges
            )
        select 
            r1.Id,
            r1.ShipmentBillId,
            r1.BillNo,
            r1.CreateTime,
            r1.DeliveryNo,
            r1.CarNo,
            r1.CarType,
            r1.TrailerNo,
            r1.CustomerId,
            r1.CustomerName,
            r1.ReceiverName,
            r1.ReceiverCountry,
            r1.ReceiverProvince,
            r1.ReceiverCity,
            r1.ReceiverAddress,
            r1.ReceiveType,
            r1.TotalPackages,
            r1.TotalTunnages,
            r1.TotalPiles,
            r1.TotalTenThousands,
            r1.ContractId,
            r1.ContractNo,
            r1.OriginalContractNo,
            case when dbctp2.TransportCharges is null then r1.TransportCharges else dbctp2.TransportCharges end as TransportCharges,
            r1.PlanId,
            r1.PlanType,
            r1.PlanNo,
            r1.PayerId,
            r1.PayerName,
            r1.ShipmentNo,
            r1.StartCountry,
            r1.StartProvince,
            r1.StartCity,
            r1.GoodsName,
            r1.IsCustomerTransportChargesSettled,
            r1.IsCarrierTransportChargesSettled,
            r1.IsDeliverBillReceiptReceived,
            r1.ReturnTime,
            r1.Remark,
            r1.KM,
            r1.IsInstalment,
            r1.DeliverPlanCreateTime,
            cu.SettlementExpression,
            cu.ValuationMode,
            cu.GrossWeightRate,
            isnull(dbctp.TransportPrice,0.0) as CustomerTransportPrice,
            isnull(dbctp.TransportCharges,0.0) as CustomerTransportCharges,
            r1.ReverseAmount,
            r1.TransportChargesBalance,
            0
        from 
            (
                select 
                    db.Id,
                    db.ShipmentBillId,
                    db.BillNo,
                    convert(nvarchar(10),db.CreateTime,120) as CreateTime,
                    db.DeliveryNo,
                    db.CarNo,
                    db2.CarType,
                    db.TrailerNo,
                    db.CustomerId,
                    db.CustomerName,
                    db.ReceiverName,
                    db.ReceiverCountry,
                    db.ReceiverProvince,
                    db.ReceiverCity,
                    db.ReceiverAddress,
                    isnull(dbg.TotalPackages,0) as TotalPackages,
                    isnull(dbg.TotalTunnages,0.0) as TotalTunnages,
                    isnull(dbg.TotalPiles,0.0) as TotalPiles,
                    isnull(dbg.TotalTenThousands,0.0) as TotalTenThousands,
                    ct.Id as ContractId,
                    ct.ContractNo,
                    ct.OriginalContractNo,
                    isnull(dbdp.TransportCharges,0.0) as TransportCharges,
                    db.PlanId,
                    dp.PlanType,
                    dp.PlanNo,
                    dp.PayerId,
                    dp.PayerName,
                    dp.ShipmentNo,
                    dp.ReceiveType,
                    dp.StartCountry,
                    dp.StartProvince,
                    dp.StartCity,
                    gn.GoodsName,
                    cast((case when db.CustomerTransportChargesSettlementId > 0 then 1 else 0 end) as bit) as IsCustomerTransportChargesSettled,
                    cast((case when ctcsd.CarrierTransportChargesSettlementId > 0 then 1 else 0 end) as bit) as IsCarrierTransportChargesSettled,
                    cast((case when db.ReturnTime is null then 0 else 1 end) as bit) as IsDeliverBillReceiptReceived,
                    convert(nvarchar(10),db.ReturnTime,120) as ReturnTime,
                    isnull(dp.Remark,'''') + isnull(dbdp.Remark,'''') as Remark,
                    dbdp.KM,
                    dp.IsInstalment,
                    convert(nvarchar(10),dp.CreateTime,120) as DeliverPlanCreateTime,
                    db.PrintState,
                    dp.OwnOrganId,
                    isnull(ra2.ReverseAmount,0.0) as ReverseAmount,
                    isnull(tcb.TransportChargesBalance,0.0) as TransportChargesBalance
                from 
                    DeliverBill db join
	                (
		                select 
			                a.DeliverBillId,
			                b.GoodsName
		                from
			                (
				                select distinct DeliverBillId from DeliverBillGoods 
			                ) as a outer apply
			                (
				                select 
					                GoodsName = stuff(replace(replace(
					                (
						                select distinct GoodsName from DeliverBillGoods where DeliverBillId = a.DeliverBillId for xml auto
					                ), ''<DeliverBillGoods GoodsName="'', '',''), ''"/>'', ''''), 1, 1, '''')
			                ) as b
	                ) as gn on db.Id = gn.DeliverBillId join 
	                (
		                select 
			                Id,
                            PlanNo,
                            PlanType,
			                PayerId,
			                PayerName,
			                ShipmentNo,
                            ReceiveType,
			                StartCountry,
			                StartProvince,
			                StartCity,
                            Remark,
                            IsInstalment,
                            CreateTime,
                            OwnOrganId
		                from 
			                DeliverPlan 
	                ) as dp on db.PlanId = dp.Id join 
                    (
                        select 
                            DeliverBillId,
                            sum(Packages) as TotalPackages,
                            sum(Tunnages) as TotalTunnages,
                            sum(Piles) as TotalPiles,
                            sum(TenThousands) as TotalTenThousands
                        from 
                            DeliverBillGoods 
                        group by 
                            DeliverBillId
                    ) as dbg on db.Id = dbg.DeliverBillId join 
	                (
		                select 
                            DispatchBillId, 
                            PlanId, 
                            convert(nvarchar,KM) as KM,
                            TransportCharges,
                            Remark
                        from 
                            DispatchBillDeliverPlan 
	                ) as dbdp on db.DispatchBillId = dbdp.DispatchBillId and db.PlanId = dbdp.PlanId join
                    (
                        select 
                            Id,
                            CarType
                        from 
                            DispatchBill
                    ) as db2 on db.DispatchBillId = db2.Id left join 
                    (
                        select 
                            Id,
                            DispatchBillId,
                            ContractNo,
                            OriginalContractNo
                        from 
                            Contract
                        where 
                            IsPrestowage = 1
                    ) as ct on db.DispatchBillId = ct.DispatchBillId left join 
                    CarrierTransportChargesSettlementDetail ctcsd on db.Id = ctcsd.DeliverBillId left join
                    (
                        select 
	                        dbdp2.PlanId,
	                        ra.DispatchBillId,
	                        round((case when ra.TotalTransportCharges <> 0 then isnull(dbdp2.TransportCharges,0.0) / ra.TotalTransportCharges else 0.0 end) * ra.ReverseAmount,2) as ReverseAmount
                        from 
	                        DispatchBillDeliverPlan dbdp2 join 
	                        (
		                        select 
			                        ct.DispatchBillId,
			                        ct.TotalTransportCharges,
			                        isnull(crd.TotalReverseAmount,0.0) as ReverseAmount
		                        from 
			                        Contract ct left join 
			                        (
				                        select 
					                        ContractId, 
					                        sum(ReverseAmount) as TotalReverseAmount 
				                        from 
					                        ContractReverseDetail 
				                        group by 
					                        ContractId
			                        ) as crd on ct.Id = crd.ContractId
                                where 
                                    ct.IsPrestowage = 1
	                        ) as ra on dbdp2.DispatchBillId = ra.DispatchBillId
                    ) as ra2 on db.DispatchBillId = ra2.DispatchBillId and db.PlanId = ra2.PlanId left join
                    (
                        select
	                        c.DispatchBillId,
	                        c.PlanId,
	                        case when c.TransportCharges - d.TransportCharges <= 0 then 0.0 else c.TransportCharges - d.TransportCharges end as TransportChargesBalance
                        from 
	                        (
		                        select 
			                        ct.DispatchBillId,
			                        cdp.PlanId,
			                        cdp.TransportCharges
		                        from 
			                        ContractDeliverPlan cdp join 
			                        Contract ct on cdp.ContractId = ct.Id
                                where 
                                    ct.IsPrestowage = 1
	                        ) as c join
	                        (
		                        select 
			                        DispatchBillId,
			                        PlanId,
			                        TransportCharges
		                        from 
			                        DispatchBillDeliverPlan
	                        ) as d on c.DispatchBillId = d.DispatchBillId and c.PlanId = d.PlanId
                    ) as tcb on db.DispatchBillId = tcb.DispatchBillId and db.PlanId = tcb.PlanId
            ) as r1 join 
            Customer cu on r1.PayerId = cu.Id left join 
            DeliverBillCustomerTransportPrice dbctp on r1.Id = dbctp.DeliverBillId left join 
            DeliverBillCarrierTransportPrice dbctp2 on r1.Id = dbctp2.DeliverBillId '
            
    
    set @Sql2 = ''
    if @PrintState is not null and @PrintState <> ''
    begin
        set @Sql2 = '(r1.PrintState = ' + @PrintState + ')'
    end
    
    if @StartTime is not null and @StartTime <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.CreateTime >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.CreateTime <= ''' + @EndTime + ''')'
    end

    if @DeliverBillNo is not null and @DeliverBillNo <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.BillNo like ''%' + @DeliverBillNo + '%'')'
    end

    if @CustomerName is not null and @CustomerName <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.CustomerName like ''%' + @CustomerName + '%'')'
    end
    
    if @PayerName is not null and @PayerName <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.PayerName like ''%' + @PayerName + '%'')'
    end

    if @StartCountry is not null and @StartCountry <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.StartCountry = ''' + @StartCountry + ''')' 
    end
    
    if @StartProvince is not null and @StartProvince <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.StartProvince = ''' + @StartProvince + ''')' 
    end
    
    if @StartCity is not null and @StartCity <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.StartCity = ''' + @StartCity + ''')' 
    end
    
    if @DestCountry is not null and @DestCountry <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.ReceiverCountry = ''' + @DestCountry + ''')' 
    end
    
    if @DestProvince is not null and @DestProvince <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.ReceiverProvince = ''' + @DestProvince + ''')' 
    end
    
    if @DestCity is not null and @DestCity <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.ReceiverCity = ''' + @DestCity + ''')' 
    end

    if @CarNo is not null and @CarNo <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.CarNo like ''%' + @CarNo + '%'')'
    end
    
    if @DeliveryNo is not null and @DeliveryNo <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.DeliveryNo like ''%' + @DeliveryNo + '%'')'
    end

    if @OrganId is not null and @OrganId <> ''
    begin
        if @Sql2 <> '' set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.OwnOrganId = ' + @OrganId + ')'
    end
    
    if @Sql2 <> '' set @Sql = @Sql + ' where ' + @Sql2

    exec (@Sql)
    
    if @@error <> 0
    begin
        raiserror (150539,18,1)
        return -1
    end
    
    
    /*3.*/
    declare Cursor1 cursor local for 
        select 
	        Id,
            PayerId,
	        ShipmentNo,
            CreateTime,
            StartCountry,
            StartProvince,
            StartCity,
            ReceiverCountry,
            ReceiverProvince,
            ReceiverCity,
            TotalTunnages,
            TotalPiles,
            ValuationMode,
            GrossWeightRate,
            PlanType,
            IsInstalment,
            DeliverPlanCreateTime,
            CarType
        from 
            #LoadDeliverBillsByConditions 
        where 
            CustomerTransportPrice = 0 and 
            ReceiveType <> formatmessage(150347)
            
    open Cursor1
    fetch next from Cursor1 into 
        @Id, 
        @CustomerId, 
        @ShipmentNo, 
        @DeliverBillCreateTime, 
        @StartCountry2, 
        @StartProvince2, 
        @StartCity2, 
        @DestCountry2, 
        @DestProvince2, 
        @DestCity2, 
        @TotalTunnages, 
        @TotalPiles, 
        @ValuationMode, 
        @GrossWeightRate, 
        @PlanType, 
        @IsInstalment, 
        @DeliverPlanCreateTime,
        @CarType

    while @@fetch_status = 0
    begin
        set @CustomerTransportPrice = 0
        
        /**/
        if @PlanType = formatmessage(150257) or @PlanType = formatmessage(150619)
        begin
            select 
                @CustomerTransportPrice = TransportPrice,
                @RiverCrossingCharges = RiverCrossingCharges
            from 
                CustomerTransportPrice 
            where 
                CustomerId = @CustomerId and 
                StartCountry = @StartCountry2 and 
                StartProvince = @StartProvince2 and 
                StartCity = @StartCity2 and 
                DestCountry = @DestCountry2 and 
                DestProvince = @DestProvince2 and 
                DestCity = @DestCity2 and 
                @TotalPiles * @GrossWeightRate >= MinTunnagesOrPiles and 
                @TotalPiles * @GrossWeightRate < MaxTunnagesOrPiles and 
                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                (
                    CarType is not null and 
                    CarType <> '' and 
                    CarType = @CarType
                )
            if @@rowcount = 0
            begin
                select 
                    @CustomerTransportPrice = TransportPrice,
                    @RiverCrossingCharges = RiverCrossingCharges
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry2 and 
                    StartProvince = @StartProvince2 and 
                    StartCity = @StartCity2 and 
                    DestCountry = @DestCountry2 and 
                    DestProvince = @DestProvince2 and 
                    DestCity = @DestCity2 and 
                    @TotalPiles * @GrossWeightRate >= MinTunnagesOrPiles and 
                    @TotalPiles * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is null or
                        CarType = ''
                    )
                if @@rowcount = 0
                begin
                    set @CustomerTransportPrice = 0
                    set @RiverCrossingCharges = 0
                end
            end
        end
        else
        begin
            /**/
            if @PlanType = formatmessage(150256) or @PlanType = formatmessage(150518)
            begin
                /**/
                if @ValuationMode = formatmessage(150520)
                begin
                    select 
                        @CustomerTransportPrice = TransportPrice,
                        @RiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry2 and 
                        StartProvince = @StartProvince2 and 
                        StartCity = @StartCity2 and 
                        DestCountry = @DestCountry2 and 
                        DestProvince = @DestProvince2 and 
                        DestCity = @DestCity2 and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    if @@rowcount = 0
                    begin
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @RiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry2 and 
                            StartProvince = @StartProvince2 and 
                            StartCity = @StartCity2 and 
                            DestCountry = @DestCountry2 and 
                            DestProvince = @DestProvince2 and 
                            DestCity = @DestCity2 and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is null or
                                CarType = ''
                            )
                        if @@rowcount = 0
                        begin
                            set @CustomerTransportPrice = 0
                            set @RiverCrossingCharges = 0
                        end
                    end
                end
                /**/
                else if @ValuationMode = formatmessage(150521)
                begin
                    /**/
                    select 
                        @TotalTunnages = isnull(sum(Tunnages),0.0) 
                    from 
                        DeliverBillGoods 
                    where 
                        DeliverBillId in 
                        (
                            select 
                                Id 
                            from 
                                DeliverBill 
                            where 
                                PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan
                                    where 
                                        ShipmentNo = @ShipmentNo 
                                ) 
                        )
                    
                    if @TotalTunnages is null 
                    begin
                        set @TotalTunnages = 0
                    end
            
                    /**/
                    select 
                        @CustomerTransportPrice = TransportPrice,
                        @RiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry2 and 
                        StartProvince = @StartProvince2 and 
                        StartCity = @StartCity2 and 
                        DestCountry = @DestCountry2 and 
                        DestProvince = @DestProvince2 and 
                        DestCity = @DestCity2 and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    if @@rowcount = 0
                    begin
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @RiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry2 and 
                            StartProvince = @StartProvince2 and 
                            StartCity = @StartCity2 and 
                            DestCountry = @DestCountry2 and 
                            DestProvince = @DestProvince2 and 
                            DestCity = @DestCity2 and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is null or
                                CarType = ''
                            )
                        if @@rowcount = 0
                        begin
                            set @CustomerTransportPrice = 0
                            set @RiverCrossingCharges = 0
                        end
                    end
                end
                /**/
                else
                begin
                    /**/
                    if @IsInstalment is null or @IsInstalment = 0
                    begin
                        /**/
                        select 
                            @TotalTunnages = isnull(sum(Tunnages),0.0) 
                        from 
                            DeliverBillGoods  
                        where 
                            DeliverBillId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverBill 
                                where 
                                    PlanId in 
                                    (
                                        select 
                                            Id 
                                        from 
                                            DeliverPlan 
                                        where 
                                            convert(nvarchar(10), CreateTime, 120) = @DeliverPlanCreateTime and 
                                            ReceiverCountry = @DestCountry2 and 
                                            ReceiverProvince = @DestProvince2 and 
                                            ReceiverCity = @DestCity2
                                    ) 
                            )
                        
                        if @TotalTunnages is null 
                        begin
                            set @TotalTunnages = 0
                        end
            
                        /**/
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @RiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry2 and 
                            StartProvince = @StartProvince2 and 
                            StartCity = @StartCity2 and 
                            DestCountry = @DestCountry2 and 
                            DestProvince = @DestProvince2 and 
                            DestCity = @DestCity2 and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is not null and 
                                CarType <> '' and 
                                CarType = @CarType
                            )
                        if @@rowcount = 0
                        begin
                            select 
                                @CustomerTransportPrice = TransportPrice,
                                @RiverCrossingCharges = RiverCrossingCharges
                            from 
                                CustomerTransportPrice 
                            where 
                                CustomerId = @CustomerId and 
                                StartCountry = @StartCountry2 and 
                                StartProvince = @StartProvince2 and 
                                StartCity = @StartCity2 and 
                                DestCountry = @DestCountry2 and 
                                DestProvince = @DestProvince2 and 
                                DestCity = @DestCity2 and 
                                @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                                @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                                (
                                    CarType is null or
                                    CarType = ''
                                )
                            if @@rowcount = 0
                            begin
                                set @CustomerTransportPrice = 0
                                set @RiverCrossingCharges = 0
                            end
                        end
                    end
                    /**/
                    else
                    begin
                        /**/
                        select 
                            @TotalTunnages = isnull(sum(Tunnages),0.0) 
                        from 
                            DeliverBillGoods  
                        where 
                            DeliverBillId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverBill 
                                where 
                                    PlanId in 
                                    (
                                        select 
                                            Id 
                                        from 
                                            DeliverPlan 
                                        where 
                                            convert(nvarchar(10), CreateTime, 120) = @DeliverBillCreateTime and 
                                            ReceiverCountry = @DestCountry2 and 
                                            ReceiverProvince = @DestProvince2 and 
                                            ReceiverCity = @DestCity2
                                    ) 
                            )
                        
                        if @TotalTunnages is null 
                        begin
                            set @TotalTunnages = 0
                        end
            
                        /*4.3.2.2.*/
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @RiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry2 and 
                            StartProvince = @StartProvince2 and 
                            StartCity = @StartCity2 and 
                            DestCountry = @DestCountry2 and 
                            DestProvince = @DestProvince2 and 
                            DestCity = @DestCity2 and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is not null and 
                                CarType <> '' and 
                                CarType = @CarType
                            )
                        if @@rowcount = 0
                        begin
                            select 
                                @CustomerTransportPrice = TransportPrice,
                                @RiverCrossingCharges = RiverCrossingCharges
                            from 
                                CustomerTransportPrice 
                            where 
                                CustomerId = @CustomerId and 
                                StartCountry = @StartCountry2 and 
                                StartProvince = @StartProvince2 and 
                                StartCity = @StartCity2 and 
                                DestCountry = @DestCountry2 and 
                                DestProvince = @DestProvince2 and 
                                DestCity = @DestCity2 and 
                                @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                                @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                                (
                                    CarType is null or
                                    CarType = ''
                                )
                            if @@rowcount = 0
                            begin
                                set @CustomerTransportPrice = 0
                                set @RiverCrossingCharges = 0
                            end
                        end
                    end
                end
            end
            /**/
            else
            begin
                select 
                    @CustomerTransportPrice = TransportPrice,
                    @RiverCrossingCharges = RiverCrossingCharges
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry2 and 
                    StartProvince = @StartProvince2 and 
                    StartCity = @StartCity2 and 
                    DestCountry = @DestCountry2 and 
                    DestProvince = @DestProvince2 and 
                    DestCity = @DestCity2 and 
                    @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                    @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is not null and 
                        CarType <> '' and 
                        CarType = @CarType
                    )
                if @@rowcount = 0
                begin
                    select 
                        @CustomerTransportPrice = TransportPrice,
                        @RiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry2 and 
                        StartProvince = @StartProvince2 and 
                        StartCity = @StartCity2 and 
                        DestCountry = @DestCountry2 and 
                        DestProvince = @DestProvince2 and 
                        DestCity = @DestCity2 and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is null or
                            CarType = ''
                        )
                    if @@rowcount = 0
                    begin
                        set @CustomerTransportPrice = 0
                        set @RiverCrossingCharges = 0
                    end
                end
            end
        end
        
        /**/
        if @CustomerTransportPrice is null
        begin
            set @CustomerTransportPrice = 0
        end
        
        if @RiverCrossingCharges is null
        begin
            set @RiverCrossingCharges = 0
        end
        
        update #LoadDeliverBillsByConditions set 
            CustomerTransportPrice = @CustomerTransportPrice, 
            RiverCrossingCharges = @RiverCrossingCharges 
        where 
            Id = @Id 
    
        fetch next from Cursor1 into 
            @Id, 
            @CustomerId, 
            @ShipmentNo, 
            @DeliverBillCreateTime, 
            @StartCountry2, 
            @StartProvince2, 
            @StartCity2, 
            @DestCountry2, 
            @DestProvince2, 
            @DestCity2, 
            @TotalTunnages, 
            @TotalPiles, 
            @ValuationMode, 
            @GrossWeightRate, 
            @PlanType, 
            @IsInstalment, 
            @DeliverPlanCreateTime,
            @CarType
    end 
        
    close Cursor1
    deallocate Cursor1 
    
    /**/
    select 
        Id,
        ShipmentBillId,
        BillNo,
        cast(CreateTime as datetime) as CreateTime,
        DeliveryNo,
        CarNo,
        TrailerNo,
        CarType,
        CustomerId,
	    CustomerName,
        ReceiverName,
        ReceiverCountry,
        ReceiverProvince,
        ReceiverCity,
        ReceiverAddress,
        ReceiveType,
        TotalPackages,
        TotalTunnages,
        TotalPiles,
        TotalTenThousands,
        ContractId,
        ContractNo,
        OriginalContractNo,
        TransportCharges,
        PlanId,
        PlanType,
        PlanNo,
        PayerId,
        PayerName,
	    ShipmentNo,
        StartCountry,
        StartProvince,
        StartCity,
        GoodsName,
        IsCustomerTransportChargesSettled,
        IsCarrierTransportChargesSettled,
        IsDeliverBillReceiptReceived,
        cast(ReturnTime as datetime) as ReturnTime,
        Remark,
        KM,
        IsInstalment,
        DeliverPlanCreateTime,
        SettlementExpression,
        ValuationMode,
        GrossWeightRate,
        CustomerTransportPrice,
        CustomerTransportCharges,
        ReverseAmount,
        TransportChargesBalance,
        RiverCrossingCharges
    from 
        #LoadDeliverBillsByConditions
    order by 
        CreateTime
    
    
    /**/
    select @OpName = formatmessage(150540)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'DeliverBillNo=' + @DeliverBillNo + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'PayerName=' + @PayerName + N',' +
                       N'StartCountry=' + @StartCountry + N',' +
                       N'StartProvince=' + @StartProvince + N',' +
                       N'StartCity=' + @StartCity + N',' +
                       N'DestCountry=' + @DestCountry + N',' +
                       N'DestProvince=' + @DestProvince + N',' +
                       N'DestCity=' + @DestCity + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'OrganId=' + @OrganId + N',' +
                       N'PrintState=' + @PrintState
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadDeliverBillsByPlanId 
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select * from DeliverBill where PlanId = @PlanId 
    
    /**/
    select @OpName = formatmessage(150689)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDeliverBillsOwnOrgansByTimespan 
@StartTime nvarchar(10),
@EndTime nvarchar(10),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        * 
    from 
        Organization 
    where 
        Id in 
        (
            select 
                OwnOrganId 
            from 
                DeliverPlan 
            where 
                Id in 
                (
                    select 
                        PlanId 
                    from 
                        DeliverBill
                    where 
                        convert(nvarchar(10),CreateTime,120) >= @StartTime and 
                        convert(nvarchar(10),CreateTime,120) <= @EndTime 
                )
        )
            
    
    /**/
    select @OpName = formatmessage(150682)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDeliverBillsPayersByTimespan 
@StartTime nvarchar(10),
@EndTime nvarchar(10),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        * 
    from 
        Customer 
    where 
        Id in 
        (
            select 
                PayerId 
            from 
                DeliverPlan 
            where 
                Id in 
                (
                    select 
                        PlanId 
                    from 
                        DeliverBill
                    where 
                        convert(nvarchar(10),CreateTime,120) >= @StartTime and 
                        convert(nvarchar(10),CreateTime,120) <= @EndTime 
                )
        )
            
    
    /**/
    select @OpName = formatmessage(150683)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDeliverPlan 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from DeliverPlan where Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150261,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150262)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadDeliverPlanAllGoods 
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        dpg.*, 
        dp.Warehouse,
        ewb.BillNo as EnterWarehouseBillNo
    from 
        DeliverPlanGoods dpg join 
        DeliverPlan dp on dpg.PlanId = dp.Id left join 
        EnterWarehouseBill ewb on dpg.EnterWarehouseBillId = ewb.Id
    where 
        dpg.PlanId = @PlanId 
    
    /**/
    select @OpName = formatmessage(150263)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDeliverPlanGoodsBalancesByConditions 
@CustomerId nvarchar(50),
@GoodsId nvarchar(50),
@BatchNo nvarchar(50),
@Packing nvarchar(50),
@Warehouse nvarchar(50),
@Location nvarchar(50),
@ProductionDate nvarchar(50),
@EnterWarehouseBillId nvarchar(50),
@DeliveryNo nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    if @DeliveryNo is null or @DeliveryNo = ''
    begin
        set @Sql = '
            select 
                r.PlanId,
                r.GoodsId,
                r.GoodsNo,
                r.GoodsName,
                r.Brand,
                r.SpecModel,
                r.GWeight,
                r.Grade,
                r.BatchNo,
                r.Packing,
                r.Warehouse,
                r.Location,
                case when p.PlanState = formatmessage(150242) then r.PlanPackages - r.DeliverPackages else r.DispatchPackages + r.ShipmentPackages end as Packages,
                case when (case when p.PlanState = formatmessage(150242) then r.PlanPackages - r.DeliverPackages else r.DispatchPackages + r.ShipmentPackages end) <> 0 then (case when p.PlanState = formatmessage(150242) then r.PlanTunnages - r.DeliverTunnages else r.DispatchTunnages + r.ShipmentTunnages end) / (case when p.PlanState = formatmessage(150242) then r.PlanPackages - r.DeliverPackages else r.DispatchPackages + r.ShipmentPackages end) else null end as PieceWeight,
                case when p.PlanState = formatmessage(150242) then r.PlanTunnages - r.DeliverTunnages else r.DispatchTunnages + r.ShipmentTunnages end as Tunnages,
                case when p.PlanState = formatmessage(150242) then r.PlanPiles - r.DeliverPiles else r.DispatchPiles + r.ShipmentPiles end as Piles,
                case when p.PlanState = formatmessage(150242) then r.PlanTenThousands - r.DeliverTenThousands else r.DispatchTenThousands + r.ShipmentTenThousands end as TenThousands,
                r.ProductionDate,
                r.EnterWarehouseBillId
            from 
                (
                    select 
                        r0.PlanId,
                        r0.GoodsId,
                        r0.GoodsNo,
                        r0.GoodsName,
                        r0.Brand,
                        r0.SpecModel,
                        r0.GWeight,
                        r0.Grade,
                        r0.BatchNo,
                        r0.Packing,
                        r0.Warehouse,
                        r0.Location,
                        r0.Packages as PlanPackages,
                        isnull(r1.Packages, 0) as DispatchPackages,
                        isnull(r2.Packages, 0) as ShipmentPackages,
                        isnull(r3.Packages, 0) as DeliverPackages,
                        r0.Tunnages as PlanTunnages,
                        isnull(r1.Tunnages, 0.0) as DispatchTunnages,
                        isnull(r2.Tunnages, 0.0) as ShipmentTunnages,
                        isnull(r3.Tunnages, 0.0) as DeliverTunnages, 
                        r0.Piles as PlanPiles,
                        isnull(r1.Piles, 0.0) as DispatchPiles,
                        isnull(r2.Piles, 0.0) as ShipmentPiles,
                        isnull(r3.Piles, 0.0) as DeliverPiles, 
                        r0.TenThousands as PlanTenThousands,
                        isnull(r1.TenThousands, 0.0) as DispatchTenThousands,
                        isnull(r2.TenThousands, 0.0) as ShipmentTenThousands,
                        isnull(r3.TenThousands, 0.0) as DeliverTenThousands, 
                        r0.ProductionDate,
                        r0.EnterWarehouseBillId 
                    from 
                        (
                            select 
                                g.PlanId,
                                g.GoodsId,
                                g.GoodsNo,
                                g.GoodsName,
                                g.Brand,
                                g.SpecModel,
                                g.GWeight,
                                g.Grade,
                                g.BatchNo,
                                g.Packing,
                                p.Warehouse,
                                g.Location,
                                isnull(sum(g.Packages), 0) as Packages,
                                isnull(sum(g.Tunnages), 0.0) as Tunnages,
                                isnull(sum(g.Piles), 0.0) as Piles,
                                isnull(sum(g.TenThousands), 0.0) as TenThousands,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                            from 
                                DeliverPlanGoods g join 
                                DeliverPlan p on g.PlanId = p.Id 
                            where 
                                g.PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan 
                                    where 
                                        (
                                            ConsignedDeliveryNo is null or 
                                            ConsignedDeliveryNo = ''''
                                        ) and 
                                        (
                                            PlanState = formatmessage(150242) or
                                            PlanState = formatmessage(150243)
                                        ) '
        
        if @CustomerId is not null and @CustomerId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(CustomerId = ' + @CustomerId + ')'
        end
        
        if @Warehouse is not null and @Warehouse <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Warehouse = ''' + @Warehouse + ''')'
        end
                                        
        set @Sql = @Sql + ')'
                                 
        if @GoodsId is not null and @GoodsId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.GoodsId = ' + @GoodsId + ')'
        end
        
        if @BatchNo is not null and @BatchNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.BatchNo = ''' + @BatchNo + ''')'
        end
                                
        if @Packing is not null and @Packing <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Packing = ''' + @Packing + ''')'
        end
        
        if @Location is not null and @Location <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Location = ''' + @Location + ''')'
        end
        
        if @ProductionDate is not null and @ProductionDate <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.ProductionDate = ''' + @ProductionDate + ''')'
        end
        
        if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
        end
        
        set @Sql = @Sql + '
                            group by 
                                g.PlanId,
                                g.GoodsId,
                                g.GoodsNo,
                                g.GoodsName,
                                g.Brand,
                                g.SpecModel,
                                g.GWeight,
                                g.Grade,
                                g.BatchNo,
                                g.Packing,
                                p.Warehouse,
                                g.Location,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                        ) as r0 left join 
                        (
                            select 
                                PlanId,
                                GoodsId,
                                BatchNo,
                                Packing,
                                Location,
                                isnull(sum(Packages), 0) as Packages,
                                isnull(sum(Tunnages), 0.0) as Tunnages,
                                isnull(sum(Piles), 0.0) as Piles,
                                isnull(sum(TenThousands), 0.0) as TenThousands,
                                ProductionDate,
                                EnterWarehouseBillId
                            from 
                                DispatchBillGoods 
                            where 
                                PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan 
                                    where 
                                        (
                                            ConsignedDeliveryNo is null or 
                                            ConsignedDeliveryNo = ''''
                                        ) and 
                                        (
                                            PlanState = formatmessage(150242) or
                                            PlanState = formatmessage(150243)
                                        ) '
                                        
        if @CustomerId is not null and @CustomerId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(CustomerId = ' + @CustomerId + ')'
        end
        
        if @Warehouse is not null and @Warehouse <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Warehouse = ''' + @Warehouse + ''')'
        end
                                        
        set @Sql = @Sql + '
                                ) and 
                                DispatchBillId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DispatchBill 
                                    where 
                                        BillState = formatmessage(150241)
                                ) '
                                
        if @GoodsId is not null and @GoodsId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(GoodsId = ' + @GoodsId + ')'
        end
        
        if @BatchNo is not null and @BatchNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(BatchNo = ''' + @BatchNo + ''')'
        end
                                
        if @Packing is not null and @Packing <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Packing = ''' + @Packing + ''')'
        end
        
        if @Location is not null and @Location <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Location = ''' + @Location + ''')'
        end
        
        if @ProductionDate is not null and @ProductionDate <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(ProductionDate = ''' + @ProductionDate + ''')'
        end
        
        if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
        end

        set @Sql = @Sql + '
                            group by 
                                PlanId,
                                GoodsId,
                                BatchNo,
                                Packing,
                                Location,
                                ProductionDate,
                                EnterWarehouseBillId
                        ) as r1 on r0.PlanId = r1.PlanId and r0.GoodsId = r1.GoodsId and r0.BatchNo = r1.BatchNo and r0.Packing = r1.Packing and r0.Location = r1.Location and r0.ProductionDate = r1.ProductionDate and r0.EnterWarehouseBillId = r1.EnterWarehouseBillId left join 
                        (
                            select 
                                b.PlanId,
                                g.GoodsId,
                                g.BatchNo,
                                g.Packing,
                                g.Location,
                                isnull(sum(g.Packages), 0) as Packages,
                                isnull(sum(g.Tunnages), 0.0) as Tunnages,
                                isnull(sum(g.Piles), 0.0) as Piles,
                                isnull(sum(g.TenThousands), 0.0) as TenThousands,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                            from 
                                ShipmentBillGoods g join 
                                ShipmentBill b on g.ShipmentBillId = b.Id 
                            where 
                                b.PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan 
                                    where 
                                        (
                                            ConsignedDeliveryNo is null or 
                                            ConsignedDeliveryNo = ''''
                                        ) and 
                                        (
                                            PlanState = formatmessage(150242) or
                                            PlanState = formatmessage(150243)
                                        )'
                                        
        if @CustomerId is not null and @CustomerId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(CustomerId = ' + @CustomerId + ')'
        end
        
        if @Warehouse is not null and @Warehouse <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Warehouse = ''' + @Warehouse + ''')'
        end
                                        
        set @Sql = @Sql + '
                                ) and 
                                b.PrintState <> 1 '
                                
        if @GoodsId is not null and @GoodsId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.GoodsId = ' + @GoodsId + ')'
        end
        
        if @BatchNo is not null and @BatchNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.BatchNo = ''' + @BatchNo + ''')'
        end
                                
        if @Packing is not null and @Packing <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Packing = ''' + @Packing + ''')'
        end
        
        if @Location is not null and @Location <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Location = ''' + @Location + ''')'
        end
        
        if @ProductionDate is not null and @ProductionDate <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.ProductionDate = ''' + @ProductionDate + ''')'
        end
        
        if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
        end

        set @Sql = @Sql + '
                            group by 
                                b.PlanId,
                                g.GoodsId,
                                g.BatchNo,
                                g.Packing,
                                g.Location,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                        ) as r2 on r0.PlanId = r2.PlanId and r0.GoodsId = r2.GoodsId and r0.BatchNo = r2.BatchNo and r0.Packing = r2.Packing and r0.Location = r2.Location and r0.ProductionDate = r2.ProductionDate and r0.EnterWarehouseBillId = r2.EnterWarehouseBillId left join 
                        (
                            select 
                                b.PlanId,
                                g.GoodsId,
                                g.BatchNo,
                                g.Packing,
                                g.Location,
                                isnull(sum(g.Packages), 0) as Packages,
                                isnull(sum(g.Tunnages), 0.0) as Tunnages,
                                isnull(sum(g.Piles), 0.0) as Piles,
                                isnull(sum(g.TenThousands), 0.0) as TenThousands,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                            from 
                                ShipmentBillGoods g join 
                                ShipmentBill b on g.ShipmentBillId = b.Id 
                            where 
                                b.PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan 
                                    where 
                                        (
                                            ConsignedDeliveryNo is null or 
                                            ConsignedDeliveryNo = ''''
                                        ) and 
                                        (
                                            PlanState = formatmessage(150242) or
                                            PlanState = formatmessage(150243)
                                        )'
                                        
        if @CustomerId is not null and @CustomerId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(CustomerId = ' + @CustomerId + ')'
        end
        
        if @Warehouse is not null and @Warehouse <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Warehouse = ''' + @Warehouse + ''')'
        end
                                        
        set @Sql = @Sql + '
                                ) and 
                                b.PrintState = 1 '
                                
        if @GoodsId is not null and @GoodsId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.GoodsId = ' + @GoodsId + ')'
        end
        
        if @BatchNo is not null and @BatchNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.BatchNo = ''' + @BatchNo + ''')'
        end
                                
        if @Packing is not null and @Packing <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Packing = ''' + @Packing + ''')'
        end
        
        if @Location is not null and @Location <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Location = ''' + @Location + ''')'
        end
        
        if @ProductionDate is not null and @ProductionDate <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.ProductionDate = ''' + @ProductionDate + ''')'
        end
        
        if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
        end

        set @Sql = @Sql + '
                            group by 
                                b.PlanId,
                                g.GoodsId,
                                g.BatchNo,
                                g.Packing,
                                g.Location,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                        ) as r3 on r0.PlanId = r3.PlanId and r0.GoodsId = r3.GoodsId and r0.BatchNo = r3.BatchNo and r0.Packing = r3.Packing and r0.Location = r3.Location and r0.ProductionDate = r3.ProductionDate and r0.EnterWarehouseBillId = r3.EnterWarehouseBillId 
                ) as r join DeliverPlan p on r.PlanId = p.Id 
            where 
                (case when p.PlanState = formatmessage(150242) then r.PlanPackages - r.DeliverPackages else r.DispatchPackages + r.ShipmentPackages end) > 0 or
                (case when p.PlanState = formatmessage(150242) then r.PlanTunnages - r.DeliverTunnages else r.DispatchTunnages + r.ShipmentTunnages end) > 0 or
                (case when p.PlanState = formatmessage(150242) then r.PlanPiles - r.DeliverPiles else r.DispatchPiles + r.ShipmentPiles end) > 0 '
    end
    else
    begin
        set @Sql = '
            select 
                r.PlanId,
                r.GoodsId,
                r.GoodsNo,
                r.GoodsName,
                r.Brand,
                r.SpecModel,
                r.GWeight,
                r.Grade,
                r.BatchNo,
                r.Packing,
                r.Warehouse,
                r.Location,
                case when p.PlanState = formatmessage(150242) then r.PlanPackages - r.DeliverPackages else r.DispatchPackages + r.ShipmentPackages end as Packages,
                case when (case when p.PlanState = formatmessage(150242) then r.PlanPackages - r.DeliverPackages else r.DispatchPackages + r.ShipmentPackages end) <> 0 then (case when p.PlanState = formatmessage(150242) then r.PlanTunnages - r.DeliverTunnages else r.DispatchTunnages + r.ShipmentTunnages end) / (case when p.PlanState = formatmessage(150242) then r.PlanPackages - r.DeliverPackages else r.DispatchPackages + r.ShipmentPackages end) else null end as PieceWeight,
                case when p.PlanState = formatmessage(150242) then r.PlanTunnages - r.DeliverTunnages else r.DispatchTunnages + r.ShipmentTunnages end as Tunnages,
                case when p.PlanState = formatmessage(150242) then r.PlanPiles - r.DeliverPiles else r.DispatchPiles + r.ShipmentPiles end as Piles,
                case when p.PlanState = formatmessage(150242) then r.PlanTenThousands - r.DeliverTenThousands else r.DispatchTenThousands + r.ShipmentTenThousands end as TenThousands,
                r.ProductionDate,
                r.EnterWarehouseBillId
            from 
                (
                    select 
                        r0.PlanId,
                        r0.GoodsId,
                        r0.GoodsNo,
                        r0.GoodsName,
                        r0.Brand,
                        r0.SpecModel,
                        r0.GWeight,
                        r0.Grade,
                        r0.BatchNo,
                        r0.Packing,
                        r0.Warehouse,
                        r0.Location,
                        r0.Packages as PlanPackages,
                        isnull(r1.Packages, 0) as DispatchPackages,
                        isnull(r2.Packages, 0) as ShipmentPackages,
                        isnull(r3.Packages, 0) as DeliverPackages,
                        r0.Tunnages as PlanTunnages,
                        isnull(r1.Tunnages, 0.0) as DispatchTunnages,
                        isnull(r2.Tunnages, 0.0) as ShipmentTunnages,
                        isnull(r3.Tunnages, 0.0) as DeliverTunnages, 
                        r0.Piles as PlanPiles,
                        isnull(r1.Piles, 0.0) as DispatchPiles,
                        isnull(r2.Piles, 0.0) as ShipmentPiles,
                        isnull(r3.Piles, 0.0) as DeliverPiles, 
                        r0.TenThousands as PlanTenThousands,
                        isnull(r1.TenThousands, 0.0) as DispatchTenThousands,
                        isnull(r2.TenThousands, 0.0) as ShipmentTenThousands,
                        isnull(r3.TenThousands, 0.0) as DeliverTenThousands, 
                        r0.ProductionDate,
                        r0.EnterWarehouseBillId
                    from 
                        (
                            select 
                                g.PlanId,
                                g.GoodsId,
                                g.GoodsNo,
                                g.GoodsName,
                                g.Brand,
                                g.SpecModel,
                                g.GWeight,
                                g.Grade,
                                g.BatchNo,
                                g.Packing,
                                p.Warehouse,
                                g.Location,
                                isnull(sum(g.Packages), 0) as Packages,
                                isnull(sum(g.Tunnages), 0.0) as Tunnages,
                                isnull(sum(g.Piles), 0.0) as Piles,
                                isnull(sum(g.TenThousands), 0.0) as TenThousands,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                            from 
                                DeliverPlanGoods g join 
                                DeliverPlan p on g.PlanId = p.Id
                            where 
                                g.PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan 
                                    where 
                                        (
                                            PlanState = formatmessage(150242) or
                                            PlanState = formatmessage(150243)
                                        ) '
                                        
        if @DeliveryNo is not null and @DeliveryNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(ConsignedDeliveryNo = ''' + @DeliveryNo + ''')'
        end
        
        if @CustomerId is not null and @CustomerId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(CustomerId = ' + @CustomerId + ')'
        end
        
        if @Warehouse is not null and @Warehouse <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Warehouse = ''' + @Warehouse + ''')'
        end
                                        
        set @Sql = @Sql + ')'
                                 
        if @GoodsId is not null and @GoodsId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.GoodsId = ' + @GoodsId + ')'
        end
        
        if @BatchNo is not null and @BatchNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.BatchNo = ''' + @BatchNo + ''')'
        end
                                
        if @Packing is not null and @Packing <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Packing = ''' + @Packing + ''')'
        end
        
        if @Location is not null and @Location <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Location = ''' + @Location + ''')'
        end
        
        if @ProductionDate is not null and @ProductionDate <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.ProductionDate = ''' + @ProductionDate + ''')'
        end
        
        if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
        end
        
        set @Sql = @Sql + '
                            group by 
                                g.PlanId,
                                g.GoodsId,
                                g.GoodsNo,
                                g.GoodsName,
                                g.Brand,
                                g.SpecModel,
                                g.GWeight,
                                g.Grade,
                                g.BatchNo,
                                g.Packing,
                                p.Warehouse,
                                g.Location,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                        ) as r0 left join 
                        (
                            select 
                                PlanId,
                                GoodsId,
                                BatchNo,
                                Packing,
                                Location,
                                isnull(sum(Packages), 0) as Packages,
                                isnull(sum(Tunnages), 0.0) as Tunnages,
                                isnull(sum(Piles), 0.0) as Piles,
                                isnull(sum(TenThousands), 0.0) as TenThousands,
                                ProductionDate,
                                EnterWarehouseBillId
                            from 
                                DispatchBillGoods 
                            where 
                                PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan 
                                    where 
                                        (
                                            PlanState = formatmessage(150242) or
                                            PlanState = formatmessage(150243)
                                        ) '
                                        
        if @DeliveryNo is not null and @DeliveryNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(ConsignedDeliveryNo = ''' + @DeliveryNo + ''')'
        end
                                        
        if @CustomerId is not null and @CustomerId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(CustomerId = ' + @CustomerId + ')'
        end
        
        if @Warehouse is not null and @Warehouse <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Warehouse = ''' + @Warehouse + ''')'
        end
                                        
        set @Sql = @Sql + '
                                ) and 
                                DispatchBillId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DispatchBill 
                                    where 
                                        BillState = formatmessage(150241)
                                ) '
                                
        if @GoodsId is not null and @GoodsId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(GoodsId = ' + @GoodsId + ')'
        end
        
        if @BatchNo is not null and @BatchNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(BatchNo = ''' + @BatchNo + ''')'
        end
                                
        if @Packing is not null and @Packing <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Packing = ''' + @Packing + ''')'
        end
        
        if @Location is not null and @Location <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Location = ''' + @Location + ''')'
        end
        
        if @ProductionDate is not null and @ProductionDate <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(ProductionDate = ''' + @ProductionDate + ''')'
        end

        if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
        end

        set @Sql = @Sql + '
                            group by 
                                PlanId,
                                GoodsId,
                                BatchNo,
                                Packing,
                                Location,
                                ProductionDate,
                                EnterWarehouseBillId
                        ) as r1 on r0.PlanId = r1.PlanId and r0.GoodsId = r1.GoodsId and r0.BatchNo = r1.BatchNo and r0.Packing = r1.Packing and r0.Location = r1.Location and r0.ProductionDate = r1.ProductionDate and r0.EnterWarehouseBillId = r1.EnterWarehouseBillId left join 
                        (
                            select 
                                b.PlanId,
                                g.GoodsId,
                                g.BatchNo,
                                g.Packing,
                                g.Location,
                                isnull(sum(g.Packages), 0) as Packages,
                                isnull(sum(g.Tunnages), 0.0) as Tunnages,
                                isnull(sum(g.Piles), 0.0) as Piles,
                                isnull(sum(g.TenThousands), 0.0) as TenThousands,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                            from 
                                ShipmentBillGoods g join 
                                ShipmentBill b on g.ShipmentBillId = b.Id 
                            where 
                                b.PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan 
                                    where 
                                        (
                                            PlanState = formatmessage(150242) or
                                            PlanState = formatmessage(150243)
                                        )'
                                        
        if @DeliveryNo is not null and @DeliveryNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(ConsignedDeliveryNo = ''' + @DeliveryNo + ''')'
        end
        
        if @CustomerId is not null and @CustomerId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(CustomerId = ' + @CustomerId + ')'
        end
        
        if @Warehouse is not null and @Warehouse <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Warehouse = ''' + @Warehouse + ''')'
        end
                                        
        set @Sql = @Sql + '
                                ) and 
                                b.PrintState <> 1 '
                                
        if @GoodsId is not null and @GoodsId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.GoodsId = ' + @GoodsId + ')'
        end
        
        if @BatchNo is not null and @BatchNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.BatchNo = ''' + @BatchNo + ''')'
        end
                                
        if @Packing is not null and @Packing <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Packing = ''' + @Packing + ''')'
        end
        
        if @Location is not null and @Location <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Location = ''' + @Location + ''')'
        end
        
        if @ProductionDate is not null and @ProductionDate <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.ProductionDate = ''' + @ProductionDate + ''')'
        end
        
        if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
        end

        set @Sql = @Sql + '
                            group by 
                                b.PlanId,
                                g.GoodsId,
                                g.BatchNo,
                                g.Packing,
                                g.Location,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                        ) as r2 on r0.PlanId = r2.PlanId and r0.GoodsId = r2.GoodsId and r0.BatchNo = r2.BatchNo and r0.Packing = r2.Packing and r0.Location = r2.Location and r0.ProductionDate = r2.ProductionDate and r0.EnterWarehouseBillId = r2.EnterWarehouseBillId left join 
                        (
                            select 
                                b.PlanId,
                                g.GoodsId,
                                g.BatchNo,
                                g.Packing,
                                g.Location,
                                isnull(sum(g.Packages), 0) as Packages,
                                isnull(sum(g.Tunnages), 0.0) as Tunnages,
                                isnull(sum(g.Piles), 0.0) as Piles,
                                isnull(sum(g.TenThousands), 0.0) as TenThousands,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                            from 
                                ShipmentBillGoods g join 
                                ShipmentBill b on g.ShipmentBillId = b.Id 
                            where 
                                b.PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan 
                                    where 
                                        (
                                            PlanState = formatmessage(150242) or
                                            PlanState = formatmessage(150243)
                                        )'
                                        
        if @DeliveryNo is not null and @DeliveryNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(ConsignedDeliveryNo = ''' + @DeliveryNo + ''')'
        end
        
        if @CustomerId is not null and @CustomerId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(CustomerId = ' + @CustomerId + ')'
        end
        
        if @Warehouse is not null and @Warehouse <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(Warehouse = ''' + @Warehouse + ''')'
        end
                                        
        set @Sql = @Sql + '
                                ) and 
                                b.PrintState = 1 '
                                
        if @GoodsId is not null and @GoodsId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.GoodsId = ' + @GoodsId + ')'
        end
        
        if @BatchNo is not null and @BatchNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.BatchNo = ''' + @BatchNo + ''')'
        end
                                
        if @Packing is not null and @Packing <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Packing = ''' + @Packing + ''')'
        end
        
        if @Location is not null and @Location <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.Location = ''' + @Location + ''')'
        end
        
        if @ProductionDate is not null and @ProductionDate <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.ProductionDate = ''' + @ProductionDate + ''')'
        end
        
        if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(g.EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
        end

        set @Sql = @Sql + '
                            group by 
                                b.PlanId,
                                g.GoodsId,
                                g.BatchNo,
                                g.Packing,
                                g.Location,
                                g.ProductionDate,
                                g.EnterWarehouseBillId
                        ) as r3 on r0.PlanId = r3.PlanId and r0.GoodsId = r3.GoodsId and r0.BatchNo = r3.BatchNo and r0.Packing = r3.Packing and r0.Location = r3.Location and r0.ProductionDate = r3.ProductionDate and r0.EnterWarehouseBillId = r3.EnterWarehouseBillId 
                ) as r join DeliverPlan p on r.PlanId = p.Id 
            where 
                (case when p.PlanState = formatmessage(150242) then r.PlanPackages - r.DeliverPackages else r.DispatchPackages + r.ShipmentPackages end) > 0 or
                (case when p.PlanState = formatmessage(150242) then r.PlanTunnages - r.DeliverTunnages else r.DispatchTunnages + r.ShipmentTunnages end) > 0 or
                (case when p.PlanState = formatmessage(150242) then r.PlanPiles - r.DeliverPiles else r.DispatchPiles + r.ShipmentPiles end) > 0 '
    end
    
    exec (@Sql)

        
    /**/
    select @OpName = formatmessage(150267)
    select @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                       N'BatchNo=' + @BatchNo + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'Packing=' + @Packing + N',' +
                       N'ProductionDate=' + @ProductionDate 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDeliverPlansByConditions 
@StartTime nvarchar(10),
@EndTime nvarchar(10),
@CustomerName nvarchar(50),
@ShipmentNo nvarchar(20),
@DeliveryNo nvarchar(20),
@DeliverType nvarchar(10),
@ReceiverName nvarchar(50),
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@DestCountry nvarchar(20),
@DestProvince nvarchar(20),
@DestCity nvarchar(20),
@CarNo nvarchar(20),
@GoodsNo nvarchar(20),
@PlanNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    set @SelectSql = '
        select 
	        dp.*,
	        cast((case when isnull(t1.ReversedCount,0) > 0 then 1 else 0 end) as bit) as IsContractReversed,
	        cast((case when isnull(t2.SettledCount,0) > 0 then 1 else 0 end) as bit) as IsCustomerTransportChargesSettled,
	        cast((case when isnull(t3.SettledCount,0) > 0 then 1 else 0 end) as bit) as IsCarrierTransportChargesSettled
        from 
	        DeliverPlan dp left join 
	        (
		        select 
					cdp.PlanId,
			        count(*) as ReversedCount
		        from 
					(
						select 
							distinct ContractId, PlanId
						from 
							ContractDeliverPlan
					) as cdp join 
			        ContractReverseDetail crd on cdp.ContractId = crd.ContractId
				group by
					cdp.PlanId
	        ) as t1 on dp.Id = t1.PlanId left join 
	        (
		        select 
					db.PlanId,
			        count(*) as SettledCount
		        from 
					(
						select 
							distinct Id, PlanId
						from 
							DeliverBill
					) as db join
			        CustomerTransportChargesSettlementDetail ctcsd on db.Id = ctcsd.DeliverBillId
				group by 
					db.PlanId
	        ) as t2 on dp.Id = t2.PlanId left join
	        (
		        select 
					db.PlanId,
			        count(*) as SettledCount
		        from 
					(
						select 
							distinct Id, PlanId
						from 
							DeliverBill
					) as db join
			        CarrierTransportChargesSettlementDetail ctcsd on db.Id = ctcsd.DeliverBillId
				group by 
					db.PlanId
	        ) as t3 on dp.Id = t3.PlanId '
            
    set @WhereSql = '(dp.PlanState <> ''' + formatmessage(150241) + ''')'

    if @StartTime is not null and @StartTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),dp.CreateTime,120) >= ''' + @StartTime + ''')'
    end

    if @EndTime is not null and @EndTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),dp.CreateTime,120) <= ''' + @EndTime + ''')'
    end
    
    if @CustomerName is not null and @CustomerName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.CustomerName like ''%' + @CustomerName + '%'')' 
    end
    
    if @ShipmentNo is not null and @ShipmentNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ShipmentNo like ''%' + @ShipmentNo + '%'')' 
    end
    
    if @DeliveryNo is not null and @DeliveryNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.DeliveryNo like ''%' + @DeliveryNo + '%'')' 
    end
    
    if @DeliverType is not null and @DeliverType <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.DeliverType = ''' + @DeliverType + ''')' 
    end
    
    if @ReceiverName is not null and @ReceiverName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ReceiverName like ''%' + @ReceiverName + '%'')' 
    end
    
    if @StartCountry is not null and @StartCountry <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.StartCountry = ''' + @StartCountry + ''')' 
    end
    
    if @StartProvince is not null and @StartProvince <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.StartProvince = ''' + @StartProvince + ''')' 
    end
    
    if @StartCity is not null and @StartCity <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.StartCity = ''' + @StartCity + ''')' 
    end
    
    if @DestCountry is not null and @DestCountry <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ReceiverCountry = ''' + @DestCountry + ''')' 
    end
    
    if @DestProvince is not null and @DestProvince <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ReceiverProvince = ''' + @DestProvince + ''')' 
    end
    
    if @DestCity is not null and @DestCity <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ReceiverCity = ''' + @DestCity + ''')' 
    end
    
    if @CarNo is not null and @CarNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.CarNo = ''' + @CarNo + ''' or dp.Id in (select PlanId from DispatchBillDeliverPlan where DispatchBillId in (select Id from DispatchBill where CarNo = ''' + @CarNo + ''')))' 
    end
    
    if @GoodsNo is not null and @GoodsNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.Id in (select PlanId from DeliverPlanGoods where GoodsNo like ''%' + @GoodsNo + '%''))' 
    end
    
    if @PlanNo is not null and @PlanNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.PlanNo = ''' + @PlanNo + ''')' 
    end

    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    set @SelectSql = @SelectSql + ' order by dp.CreateTime desc '
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150300,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150301)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'ShipmentNo=' + @ShipmentNo + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'DeliverType=' + @DeliverType + N',' +
                       N'ReceiverName=' + @ReceiverName + N',' +
                       N'StartCountry=' + @StartCountry + N',' +
                       N'StartProvince=' + @StartProvince + N',' +
                       N'StartCity=' + @StartCity + N',' +
                       N'DestCountry=' + @DestCountry + N',' +
                       N'DestProvince=' + @DestProvince + N',' +
                       N'DestCity=' + @DestCity + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'GoodsNo=' + @GoodsNo + N',' +
                       N'PlanNo=' + @PlanNo 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadDispatchBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        db.*, 
        c.BusinessType,
        c.PaymentType,
        isnull(cc.CarryingCapacity,0) as CarryingCapacity 
    from 
        DispatchBill db left join 
        Carrier c on db.CarrierId = c.Id left join 
        CarrierCar cc on db.CarrierId = cc.CarrierId and db.CarNo = cc.CarNo 
    where 
        db.Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150319,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150361)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadDispatchBillAllGoods 
@DispatchBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        dbg.*,
        dp.Warehouse,
        ewb.BillNo as EnterWarehouseBillNo
    from 
        DispatchBillGoods dbg left join 
        DeliverPlan dp on dbg.PlanId = dp.Id left join 
        EnterWarehouseBill ewb on dbg.EnterWarehouseBillId = ewb.Id
    where 
        dbg.DispatchBillId = @DispatchBillId
    
    
    /**/
    select @OpName = formatmessage(150343)
    select @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchBillAllGoodsByCarNo 
@CarNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        dbg.*,
        dp.Warehouse,
        ewb.BillNo as EnterWarehouseBillNo
    from 
        DispatchBillGoods dbg left join 
        DeliverPlan dp on dbg.PlanId = dp.Id left join 
        EnterWarehouseBill ewb on dbg.EnterWarehouseBillId = ewb.Id
    where 
        dbg.DispatchBillId in 
        (
            select 
                Id 
            from 
                DispatchBill 
            where 
                CarNo = @CarNo and 
                BillState = formatmessage(150241)
        ) 
        
    
    /**/
    select @OpName = formatmessage(150346)
    select @OpParams = N'CarNo=' + @CarNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchBillAllGoodsByCarNoAndPlanId 
@CarNo nvarchar(20),
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        dbg.*,
        dp.Warehouse,
        ewb.BillNo as EnterWarehouseBillNo
    from 
        DispatchBillGoods dbg left join 
        DeliverPlan dp on dbg.PlanId = dp.Id left join 
        EnterWarehouseBill ewb on dbg.EnterWarehouseBillId = ewb.Id
    where 
        dbg.DispatchBillId in 
        (
            select 
                Id 
            from 
                DispatchBill 
            where 
                CarNo = @CarNo and 
                BillState = formatmessage(150241)
        ) and 
        dbg.PlanId = @PlanId 
        
    
    /**/
    select @OpName = formatmessage(150345)
    select @OpParams = N'CarNo=' + @CarNo + N',' +
                       N'PlanId=' + convert(nvarchar,@PlanId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchBillAllGoodsByContractIdAndPlanId 
@ContractId bigint,
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        dbg.*,
        dp.Warehouse,
        ewb.BillNo as EnterWarehouseBillNo
    from 
        DispatchBillGoods dbg left join 
        DeliverPlan dp on dbg.PlanId = dp.Id left join 
        EnterWarehouseBill ewb on dbg.EnterWarehouseBillId = ewb.Id
    where 
        dbg.DispatchBillId in 
        (
            select 
                DispatchBillId 
            from 
                Contract 
            where 
                Id = @ContractId and 
				IsPrestowage = 1
        ) and 
        dbg.PlanId = @PlanId 
        
    
    /**/
    select @OpName = formatmessage(150542)
    select @OpParams = N'ContractId=' + convert(nvarchar,@ContractId) + N',' +
                       N'PlanId=' + convert(nvarchar,@PlanId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchBillAllGoodsByPlanId 
@DispatchBillId bigint,
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        dbg.*,
        dp.Warehouse,
        ewb.BillNo as EnterWarehouseBillNo
    from 
        DispatchBillGoods dbg left join 
        DeliverPlan dp on dbg.PlanId = dp.Id left join 
        EnterWarehouseBill ewb on dbg.EnterWarehouseBillId = ewb.Id
    where 
        dbg.DispatchBillId = @DispatchBillId and 
        dbg.PlanId = @PlanId     
    
    /**/
    select @OpName = formatmessage(150344)
    select @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) + N',' +
                       N'PlanId=' + convert(nvarchar,@PlanId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchBillDeliverPlan 
@DispatchBillId bigint,
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        dbdp.*,
        dp.PlanNo,
        dp.PlanType,
        dp.CustomerId,
        dp.CustomerName,
        dp.ShipmentNo,
        dp.DeliveryNo,
        dp.ReceiverName,
        dp.ReceiverCountry,
        dp.ReceiverProvince,
        dp.ReceiverCity  
    from 
        DispatchBillDeliverPlan dbdp join 
        DeliverPlan dp on dbdp.PlanId = dp.Id 
    where 
        dbdp.DispatchBillId = @DispatchBillId and 
        dbdp.PlanId = @PlanId 
    
    
    /**/
    select @OpName = formatmessage(150358)
    select @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) + N',' +
                       N'PlanId=' + convert(nvarchar,@PlanId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchBillDeliverPlans 
@DispatchBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        dbdp.*,
        dp.PlanNo,
        dp.PlanType,
        dp.CustomerId,
        dp.CustomerName,
        dp.ShipmentNo,
        dp.DeliveryNo,
        dp.ReceiverName,
        dp.ReceiverCountry,
        dp.ReceiverProvince,
        dp.ReceiverCity,
        dp.ReceiverAddress, 
        dp.ReceiveType,
        dp.StartCountry, 
        dp.StartProvince, 
        dp.StartCity 
    from 
        DispatchBillDeliverPlan dbdp join 
        DeliverPlan dp on dbdp.PlanId = dp.Id 
    where 
        dbdp.DispatchBillId = @DispatchBillId 
    
    
    /**/
    select @OpName = formatmessage(150342)
    select @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchBillDeliverPlansByCarNo 
@CarNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        dbdp.*,
        dp.PlanNo,
        dp.PlanType,
        dp.CustomerId,
        dp.CustomerName,
        dp.ShipmentNo,
        dp.DeliveryNo,
        dp.ReceiverName,
        dp.ReceiverCountry,
        dp.ReceiverProvince,
        dp.ReceiverCity,
        dp.ReceiveType
    from 
        DispatchBillDeliverPlan dbdp join 
        DeliverPlan dp on dbdp.PlanId = dp.Id 
    where 
        dbdp.DispatchBillId in (select Id from DispatchBill where CarNo = @CarNo and BillState = formatmessage(150241))
    
    
    /**/
    select @OpName = formatmessage(150310)
    select @OpParams = N'CarNo=' + @CarNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchCanPlanAllGoods 
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        dpg.GoodsId, 
        dpg.GoodsName, 
        dpg.TypeId, 
        dpg.TypeName, 
        dpg.TypeFullPath, 
        dpg.TypeFullName, 
        dpg.GoodsNo, 
        dpg.SpecModel, 
        dpg.BatchNo, 
        dp.Warehouse,
        dpg.Location,
        dpg.Piles - isnull(dbg.DispatchedPiles,0.0) as Piles, 
        dpg.TenThousands - isnull(dbg.DispatchedTenThousands,0.0) as TenThousands,
        dpg.ProductionDate,
        dpg.EnterWarehouseBillId,
        ewb.BillNo as EnterWarehouseBillNo
    from 
        DeliverPlanGoods dpg left join 
        DeliverPlan dp on dpg.PlanId = dp.Id left join 
        (
            select 
                GoodsId, 
                BatchNo, 
                Location,
                isnull(sum(Piles), 0.0) as DispatchedPiles, 
                isnull(sum(TenThousands), 0.0) as DispatchedTenThousands,
                ProductionDate,
                EnterWarehouseBillId
            from 
	            DispatchBillGoods 
            where 
                PlanId = @PlanId 
            group by 
	            GoodsId,
                BatchNo,
                Location,
                ProductionDate,
                EnterWarehouseBillId
        ) as dbg on dpg.GoodsId = dbg.GoodsId and dpg.BatchNo = dbg.BatchNo and dpg.Location = dbg.Location and dpg.ProductionDate = dbg.ProductionDate and dpg.EnterWarehouseBillId = dbg.EnterWarehouseBillId left join 
        EnterWarehouseBill ewb on dpg.EnterWarehouseBillId = ewb.Id
    where 
       dpg.PlanId = @PlanId and 
       dpg.Piles - isnull(dbg.DispatchedPiles,0.0) > 0

    
    /**/
    select @OpName = formatmessage(150621)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchDeliverPlanAllGoods 
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        dpg.Id,
        dpg.GoodsId, 
        dpg.GoodsName, 
        dpg.TypeId, 
        dpg.TypeName, 
        dpg.TypeFullPath, 
        dpg.TypeFullName, 
        dpg.GoodsNo, 
        dpg.Brand, 
        dpg.SpecModel, 
        dpg.GWeight, 
        dpg.Grade, 
        dpg.PieceWeight, 
        dpg.Packing, 
        dpg.BatchNo, 
        dpg.Packages - isnull(dbg.DispatchedPackages,0) as Packages, 
        dpg.Tunnages - isnull(dbg.DispatchedTunnages,0.0) as Tunnages,
        dpg.Piles - isnull(dbg.DispatchedPiles,0.0) as Piles,
        dpg.TenThousands - isnull(dbg.DispatchedTenThousands,0.0) as TenThousands 
    from 
        (
            select 
                * 
            from 
                DeliverPlanGoods 
            where 
                PlanId = @PlanId 
        ) as dpg left join 
        (
            select 
                GoodsId, 
                BatchNo, 
                isnull(sum(Packages),0) as DispatchedPackages, 
                isnull(sum(Tunnages),0.0) as DispatchedTunnages,
                isnull(sum(Piles),0.0) as DispatchedPiles,
                isnull(sum(TenThousands),0.0) as DispatchedTenThousands
            from 
	            DispatchBillGoods 
            where 
                PlanId = @PlanId 
            group by 
	            GoodsId,
                BatchNo 
        ) as dbg on dpg.GoodsId = dbg.GoodsId and dpg.BatchNo = dbg.BatchNo 
    where 
        (
            dpg.Packages - isnull(dbg.DispatchedPackages,0) <> 0 or 
            dpg.Piles - isnull(dbg.DispatchedPiles,0.0) <> 0
        )
    
    
    /**/
    select @OpName = formatmessage(150355)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchDeliverPlans 
@OrganId nvarchar(50),
@CustomerName nvarchar(50),
@ShipmentNo nvarchar(20),
@DeliveryNo nvarchar(20),
@ReceiverName nvarchar(50),
@DestCountry nvarchar(20),
@DestProvince nvarchar(20),
@DestCity nvarchar(20),
@Warehouse nvarchar(20),
@ArrivalTime nvarchar(10),
@CarNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    set @SelectSql = '
        select 
            dp.*,
            dpg.TotalTunnages, 
            dpg.TotalPiles, 
            dpg.TotalTunnages - isnull(dbpg.DispatchTunnages, 0) as BalanceTunnages, 
            dpg.TotalPiles - isnull(dbpg.DispatchPiles, 0.0) as BalancePiles 
        from 
            DeliverPlan dp join 
            (
                select 
                    PlanId, 
                    isnull(sum(Tunnages), 0.0) as TotalTunnages, 
                    isnull(sum(Piles), 0.0) as TotalPiles 
                from 
                    DeliverPlanGoods 
                group by 
                    PlanId
            ) as dpg on dp.Id = dpg.PlanId left join 
            (
                select 
                    PlanId, 
                    isnull(sum(Tunnages), 0) as DispatchTunnages, 
                    isnull(sum(Piles), 0.0) as DispatchPiles 
                from 
                    DispatchBillGoods 
                group by 
                    PlanId
            ) as dbpg on dp.Id = dbpg.PlanId '
            
    set @WhereSql = '(dp.PlanState = ''' + formatmessage(150242) + ''') and (dp.DeliverType = ''' + formatmessage(150305) + ''') and
            (
                dp.Id in 
                (
                    select 
                        dpg2.PlanId 
                    from 
                        DeliverPlanGoods dpg2 left join 
                        (
                            select 
                                PlanId,
                                GoodsId,
                                BatchNo,
                                Packing,
                                Location,
                                ProductionDate,
                                EnterWarehouseBillId,
                                isnull(sum(Packages), 0) as DispatchPackages,
                                isnull(sum(Tunnages), 0) as DispatchTunnages,
                                isnull(sum(Piles), 0.0) as DispatchPiles 
                            from 
                                DispatchBillGoods 
                            group by 
                                PlanId,
                                GoodsId,
                                BatchNo,
                                Packing,
                                Location,
                                ProductionDate,
                                EnterWarehouseBillId
                        ) as dbpg2 on dpg2.PlanId = dbpg2.PlanId and dpg2.GoodsId = dbpg2.GoodsId and dpg2.BatchNo = dbpg2.BatchNo and dpg2.Packing = dbpg2.Packing and dpg2.Location = dbpg2.Location and dpg2.ProductionDate = dbpg2.ProductionDate and dpg2.EnterWarehouseBillId = dbpg2.EnterWarehouseBillId 
                    where 
                        dpg2.Packages - isnull(dbpg2.DispatchPackages, 0) <> 0 or 
                        dpg2.Tunnages - isnull(dbpg2.DispatchTunnages, 0) <> 0 or 
                        dpg2.Piles - isnull(dbpg2.DispatchPiles, 0.0) <> 0 
                    group by 
                        dpg2.PlanId
                )
            ) '

    if @OrganId <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.OwnOrganId = ' + @OrganId + ')' 
    end
    
    if @CustomerName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.CustomerName like ''%' + @CustomerName + '%'')' 
    end
    
    if @ShipmentNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ShipmentNo like ''%' + @ShipmentNo + '%'')' 
    end
    
    if @DeliveryNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.DeliveryNo like ''%' + @DeliveryNo + '%'')' 
    end
    
    if @ReceiverName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ReceiverName like ''%' + @ReceiverName + '%'')' 
    end
    
    if @DestCountry <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ReceiverCountry = ''' + @DestCountry + ''')' 
    end
    
    if @DestProvince <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ReceiverProvince = ''' + @DestProvince + ''')' 
    end
    
    if @DestCity <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ReceiverCity = ''' + @DestCity + ''')' 
    end
    
    if @Warehouse <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.Warehouse = ''' + @Warehouse + '''))' 
    end
    
    if @ArrivalTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ArrivalTime = ''' + @ArrivalTime + ''')'
    end
    
    if @CarNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(dp.ReceiveType = ''' + formatmessage(150347) + ''' and dp.CarNo = ''' + @CarNo + ''')'
    end
    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    set @SelectSql = @SelectSql + ' order by dp.CreateTime '
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150307,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150308)
    select @OpParams = N'OrganId=' + @OrganId + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'ShipmentNo=' + @ShipmentNo + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'ReceiverName=' + @ReceiverName + N',' +
                       N'DestCountry=' + @DestCountry + N',' +
                       N'DestProvince=' + @DestProvince + N',' +
                       N'DestCity=' + @DestCity + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'ArrivalTime=' + @ArrivalTime + N',' +
                       N'CarNo=' + @CarNo 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadDispatchDeliverPlansByCustomerIdAndWarehouse 
@CustomerId bigint,
@Warehouse nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @ret int
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        *
    from 
        DeliverPlan 
    where 
        PlanState = formatmessage(150242) and
        DeliverType = formatmessage(150305) and
        Id in 
        (
            select 
                dpg.PlanId 
            from 
                DeliverPlanGoods dpg left join 
                (
                    select 
                        PlanId, 
                        GoodsId, 
                        isnull(sum(Packages), 0) as DispatchPackages, 
                        isnull(sum(Piles), 0.0) as DispatchPiles 
                    from 
                        DispatchBillGoods 
                    group by 
                        PlanId, 
                        GoodsId
                ) as dbg on dpg.PlanId = dbg.PlanId and dpg.GoodsId = dbg.GoodsId 
            where 
                dpg.Packages - isnull(dbg.DispatchPackages, 0) > 0 or 
                dpg.Piles - isnull(dbg.DispatchPiles, 0.0) > 0 
            group by 
                dpg.PlanId
        ) and 
        CustomerId = @CustomerId and 
        Warehouse = @Warehouse
        
    
    /**/
    select @OpName = formatmessage(150528)
    select @OpParams = N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'Warehouse=' + @Warehouse 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchPaperPlanAllGoods 
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        dpg.GoodsId, 
        dpg.GoodsName, 
        dpg.TypeId, 
        dpg.TypeName, 
        dpg.TypeFullPath, 
        dpg.TypeFullName, 
        dpg.GoodsNo, 
        dpg.Brand, 
        dpg.SpecModel, 
        dpg.GWeight, 
        dpg.Grade, 
        dpg.PieceWeight, 
        dpg.Packing, 
        dpg.BatchNo, 
        dp.Warehouse,
        dpg.Location,
        dpg.Packages - isnull(dbg.DispatchedPackages,0) as Packages, 
        dpg.Tunnages - isnull(dbg.DispatchedTunnages,0.0) as Tunnages,
        dpg.ProductionDate,
        dpg.EnterWarehouseBillId,
        ewb.BillNo as EnterWarehouseBillNo
    from 
        DeliverPlanGoods dpg left join 
        DeliverPlan dp on dpg.PlanId = dp.Id left join 
        (
            select 
                GoodsId, 
                BatchNo, 
                Packing,
                Location,
                isnull(sum(Packages), 0) as DispatchedPackages, 
                isnull(sum(Tunnages), 0.0) as DispatchedTunnages,
                ProductionDate,
                EnterWarehouseBillId
            from 
	            DispatchBillGoods 
            where 
                PlanId = @PlanId 
            group by 
	            GoodsId,
                BatchNo,
                Packing,
                Location,
                ProductionDate,
                EnterWarehouseBillId
        ) as dbg on dpg.GoodsId = dbg.GoodsId and dpg.BatchNo = dbg.BatchNo and dpg.Packing = dbg.Packing and dpg.Location = dbg.Location and dpg.ProductionDate = dbg.ProductionDate and dpg.EnterWarehouseBillId = dbg.EnterWarehouseBillId left join 
        EnterWarehouseBill ewb on dpg.EnterWarehouseBillId = ewb.Id
    where 
       dpg.PlanId = @PlanId and 
       dpg.Packages - isnull(dbg.DispatchedPackages,0) > 0

    
    /**/
    select @OpName = formatmessage(150313)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDispatchedDeliverPlanAllGoods 
@DispatchBillId bigint,
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        r1.GoodsId,
        r1.GoodsName,
        r1.TypeId,
        r1.TypeName,
        r1.TypeFullPath,
        r1.TypeFullName,
        r1.GoodsNo,
        r1.Brand,
        r1.SpecModel,
        r1.GWeight,
        r1.Grade,
        r1.PieceWeight,
        r1.Packing,
        r1.BatchNo,
        r1.Warehouse,
        r1.Location,
        r1.Packages + isnull(r2.Packages,0) as Packages, 
        r1.Tunnages + isnull(r2.Tunnages,0.0) as Tunnages, 
        r1.Piles + isnull(r2.Piles,0.0) as Piles, 
        r1.TenThousands + isnull(r2.TenThousands,0.0) as TenThousands, 
        r1.Packages as ActualPackages,
        r1.Tunnages as ActualTunnages,
        r1.Piles as ActualPiles,
        r1.TenThousands as ActualTenThousands,
        r1.ProductionDate,
        r1.EnterWarehouseBillId,
        r1.EnterWarehouseBillNo
    from 
        (
            select 
                g.*,
                p.Warehouse,
                e.BillNo as EnterWarehouseBillNo
            from 
                DispatchBillGoods g left join 
                DeliverPlan p on g.PlanId = p.Id left join 
                EnterWarehouseBill e on g.EnterWarehouseBillId = e.Id
            where 
                g.DispatchBillId = @DispatchBillId and 
                g.PlanId = @PlanId 
        ) as r1 left join 
        (
            select 
                dpg.GoodsId, 
                dpg.BatchNo, 
                dpg.Packing,
                dpg.Location,
                dpg.Packages - isnull(dbg.DispatchedPackages,0) as Packages, 
                dpg.Tunnages - isnull(dbg.DispatchedTunnages,0.0) as Tunnages,
                dpg.Piles - isnull(dbg.DispatchedPiles,0.0) as Piles,
                dpg.TenThousands - isnull(dbg.DispatchedTenThousands,0.0) as TenThousands,
                dpg.ProductionDate,
                dpg.EnterWarehouseBillId
            from 
                (
                    select 
                        *
                    from 
                        DeliverPlanGoods
                    where 
                        PlanId = @PlanId
                ) as dpg left join 
                (
                    select 
                        GoodsId, 
                        BatchNo, 
                        Packing,
                        Location,
                        isnull(sum(Packages),0) as DispatchedPackages, 
                        isnull(sum(Tunnages),0.0) as DispatchedTunnages,
                        isnull(sum(Piles),0.0) as DispatchedPiles,
                        isnull(sum(TenThousands),0.0) as DispatchedTenThousands,
                        ProductionDate,
                        EnterWarehouseBillId
                    from 
	                    DispatchBillGoods 
                    where 
                        PlanId = @PlanId 
                    group by 
                        GoodsId, 
                        BatchNo, 
                        Packing,
                        Location,
                        ProductionDate,
                        EnterWarehouseBillId
                ) as dbg on dpg.GoodsId = dbg.GoodsId and dpg.BatchNo = dbg.BatchNo and dpg.Packing = dbg.Packing and dpg.Location = dbg.Location and dpg.ProductionDate = dbg.ProductionDate and dpg.EnterWarehouseBillId = dbg.EnterWarehouseBillId
            where 
                (
                    dpg.Packages - isnull(dbg.DispatchedPackages,0) > 0 or 
                    dpg.Piles - isnull(dbg.DispatchedPiles,0.0) > 0
                )
        ) as r2 on r1.GoodsId = r2.GoodsId and r1.BatchNo = r2.BatchNo 
    union 
    select 
        dpg.GoodsId,
        dpg.GoodsName,
        dpg.TypeId,
        dpg.TypeName,
        dpg.TypeFullPath,
        dpg.TypeFullName,
        dpg.GoodsNo,
        dpg.Brand,
        dpg.SpecModel,
        dpg.GWeight,
        dpg.Grade,
        dpg.PieceWeight,
        dpg.Packing,
        dpg.BatchNo,
        dpg.Warehouse,
        dpg.Location,
        dpg.Packages - isnull(dbg.DispatchedPackages,0) as Packages, 
        dpg.Tunnages - isnull(dbg.DispatchedTunnages,0.0) as Tunnages,
        dpg.Piles - isnull(dbg.DispatchedPiles,0.0) as Piles,
        dpg.TenThousands - isnull(dbg.DispatchedTenThousands,0.0) as TenThousands,
        0 as ActualPackages,
        0.0 as ActualTunnages,
        0.0 as ActualPiles,
        0.0 as ActualTenThousands,
        dpg.ProductionDate,
        dpg.EnterWarehouseBillId,
        dpg.EnterWarehouseBillNo
    from 
        (
            select 
                g.*,
                p.Warehouse,
                e.BillNo as EnterWarehouseBillNo
            from 
                DeliverPlanGoods g left join 
                DeliverPlan p on g.PlanId = p.Id left join 
                EnterWarehouseBill e on g.EnterWarehouseBillId = e.Id
            where 
                g.PlanId = @PlanId
        ) as dpg left join 
        (
            select 
                GoodsId, 
                BatchNo, 
                Packing,
                Location,
                isnull(sum(Packages),0) as DispatchedPackages, 
                isnull(sum(Tunnages),0.0) as DispatchedTunnages,
                isnull(sum(Piles),0.0) as DispatchedPiles,
                isnull(sum(TenThousands),0.0) as DispatchedTenThousands,
                ProductionDate,
                EnterWarehouseBillId
            from 
	            DispatchBillGoods 
            where 
                PlanId = @PlanId 
            group by 
                GoodsId, 
                BatchNo, 
                Packing,
                Location,
                ProductionDate,
                EnterWarehouseBillId
        ) as dbg on dpg.GoodsId = dbg.GoodsId and dpg.BatchNo = dbg.BatchNo and dpg.Packing = dbg.Packing and dpg.Location = dbg.Location and dpg.ProductionDate = dbg.ProductionDate and dpg.EnterWarehouseBillId = dbg.EnterWarehouseBillId
    where 
        (
            dpg.Packages - isnull(dbg.DispatchedPackages,0) > 0 or 
            dpg.Piles - isnull(dbg.DispatchedPiles,0.0) > 0
        ) and 
        not exists
        (
            select 
                r3.* 
            from 
                DispatchBillGoods r3
            where 
                r3.DispatchBillId = @DispatchBillId and 
                r3.PlanId = @PlanId and 
                r3.GoodsId = dpg.GoodsId and 
                r3.BatchNo = dpg.BatchNo and 
                r3.Packing = dpg.Packing and 
                r3.Location = dpg.Location and 
                r3.ProductionDate = dpg.ProductionDate and 
                r3.EnterWarehouseBillId = dpg.EnterWarehouseBillId
        )
        
    
    /**/
    select @OpName = formatmessage(150357)
    select @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) + N',' +
                       N'PlanId=' + convert(nvarchar,@PlanId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDriver 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from CarrierDriver where Id = @Id 
    
    /**/
    select @OpName = formatmessage(150231)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadDriversByCarNo 
@CarNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from CarrierDriver where CarNo like ('%' + @CarNo + '%')
    
    /**/
    select @OpName = formatmessage(150214)
    select @OpParams = N'CarNo=' + @CarNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadEnterOutBalanceSummariesByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@CustomerName nvarchar(50),
@DeliveryNo nvarchar(50),
@EnterWarehouseBillNo nvarchar(50),
@GoodsNo nvarchar(50),
@BatchNo nvarchar(50),
@Warehouse nvarchar(50),
@IsConsigning nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql1 nvarchar(max)
declare @WhereSql1 nvarchar(max)
declare @SelectSql2 nvarchar(max)
declare @WhereSql2 nvarchar(max)
declare @SelectSql3 nvarchar(max)
declare @WhereSql3 nvarchar(max)
declare @SelectSql4 nvarchar(max)
declare @WhereSql4 nvarchar(max)
declare @SelectSql5 nvarchar(max)
declare @WhereSql5 nvarchar(max)
declare @SelectSql6 nvarchar(max)
declare @WhereSql6 nvarchar(max)
declare @SelectSql7 nvarchar(max)
declare @WhereSql7 nvarchar(max)
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @StartTime = convert(nvarchar(10),cast(@StartTime as datetime),120)
    set @EndTime = convert(nvarchar(10),cast(@EndTime as datetime),120)

    /**/
    if convert(nvarchar(10),cast(@EndTime as datetime),120) > convert(nvarchar(10),getdate(),120)
    begin
	    set @EndTime = convert(nvarchar(10),getdate(),120)
    end
    
    if cast(@IsConsigning as bit) = 0
    begin
        /**/
        begin
            set @SelectSql1 = '
                select 
                    CustomerId, 
                    CustomerName, 
                    GoodsId, 
                    GoodsNo, 
                    GoodsName, 
                    Brand, 
                    SpecModel, 
                    GWeight, 
                    Grade, 
                    BatchNo, 
                    Warehouse, 
                    Location, 
                    min(ProductionDate) as ProductionDate 
                from 
                    Stock '
        
            set @WhereSql1 = '(isnull(DeliveryNo,'''') not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(GoodsNo = ''' + @GoodsNo + ''')'
            end
        
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql1 <> '' set @SelectSql1 = @SelectSql1 + ' where ' + @WhereSql1 
            set @SelectSql1 = @SelectSql1 + ' group by CustomerId, CustomerName, GoodsId, GoodsNo, GoodsName, Brand, SpecModel,	GWeight, Grade, BatchNo, Warehouse, Location '
        end
    
        /**/
        begin
            set @SelectSql2 = '
                select 
                    s.CustomerId, 
                    s.CustomerName,	
                    s.GoodsId, 
                    s.GoodsNo, 
                    s.GoodsName, 
                    s.Brand, 
                    s.SpecModel, 
                    s.GWeight,	
                    s.Grade,
                    s.BatchNo,
                    s.Warehouse,
                    s.Location,
                    isnull(sum(sd.Packages),0) as Packages, 
                    isnull(sum(sd.Tunnages),0.0) as Tunnages,
                    isnull(sum(sd.Piles),0.0) as Piles,
                    isnull(sum(sd.TenThousands),0.0) as TenThousands
                from 
                    StockDaily sd join 
                    Stock s on sd.StockId = s.Id '
        
            set @WhereSql2 = '(isnull(s.DeliveryNo,'''') not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(convert(nvarchar(10),sd.CreateTime,120) = convert(nvarchar(10),dateadd(day,-1,cast(''' + @StartTime + ''' as datetime)),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql2 <> '' set @SelectSql2 = @SelectSql2 + ' where ' + @WhereSql2 
            set @SelectSql2 = @SelectSql2 + ' group by s.CustomerId, s.CustomerName, s.GoodsId, s.GoodsNo, s.GoodsName, s.Brand, s.SpecModel, s.GWeight, s.Grade, s.BatchNo, s.Warehouse, s.Location '
        end 
    
        /**/
        begin
            set @SelectSql3 = '
                select 
                    b.CustomerId,
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.Location,
                    isnull(sum(g.Packages),0) as Packages, 
                    isnull(sum(g.Tunnages),0.0) as Tunnages,
                    isnull(sum(g.Piles),0.0) as Piles,
                    isnull(sum(g.TenThousands),0.0) as TenThousands
                from 
                    EnterWarehouseBillGoods g join 
                    EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id '
        
            set @WhereSql3 = '(isnull(b.DeliveryNo,'''') not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.BillNo like ''%' + @EnterWarehouseBillNo + '%'')'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql3 <> '' set @SelectSql3 = @SelectSql3 + ' where ' + @WhereSql3 
            set @SelectSql3 = @SelectSql3 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.Location '
            
            /**/
            set @SelectSql3 = @SelectSql3 + ' union all '
            set @SelectSql3 = @SelectSql3 + '
                select 
                    b.CustomerId,
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.NewLocation as Location,
                    isnull(sum(g.NewPackages),0) as Packages, 
                    isnull(sum(g.NewTunnages),0.0) as Tunnages,
                    isnull(sum(g.NewPiles),0.0) as Piles,
                    isnull(sum(g.NewTenThousands),0.0) as TenThousands
                from 
                    MoveWarehouseBillGoods g join 
                    MoveWarehouseBill b on g.MoveWarehouseBillId = b.Id '
            
            set @WhereSql3 = '(isnull(g.DeliveryNo,'''') not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql3 <> '' set @SelectSql3 = @SelectSql3 + ' where ' + @WhereSql3 
            set @SelectSql3 = @SelectSql3 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.NewLocation '
            
            /**/
            set @SelectSql3 = '
				select
					r.CustomerId,                      
					r.CustomerName,                       
					r.GoodsId,                       
					r.GoodsNo,                       
					r.GoodsName,                       
					r.Brand,                       
					r.SpecModel,                       
					r.GWeight,                       
					r.Grade,                       
					r.BatchNo,                      
					r.Warehouse,                      
					r.Location,                      
					isnull(sum(r.Packages),0) as Packages,                       
					isnull(sum(r.Tunnages),0.0) as Tunnages,                      
					isnull(sum(r.Piles),0.0) as Piles,                      
					isnull(sum(r.TenThousands),0.0) as TenThousands                  
				from 
					( ' + @SelectSql3 + ') as r 
				group by 
					r.CustomerId,                      
					r.CustomerName,                       
					r.GoodsId,                       
					r.GoodsNo,                       
					r.GoodsName,                       
					r.Brand,                       
					r.SpecModel,                       
					r.GWeight,                       
					r.Grade,                       
					r.BatchNo,                      
					r.Warehouse,                      
					r.Location'
        end
    
        /**/
        begin
            set @SelectSql4 = '
                select 
                    b.CustomerId, 
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.Location,
                    isnull(sum(g.Packages),0) as Packages,	
                    isnull(sum(g.Tunnages),0.0) as Tunnages,
                    isnull(sum(g.Piles),0.0) as Piles,
                    isnull(sum(g.TenThousands),0.0) as TenThousands
                from 
                    OutWarehouseBillGoods g join 
                    OutWarehouseBill b on g.OutWarehouseBillId = b.Id '
        
            set @WhereSql4 = '(isnull(g.DeliveryNo,'''') not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql4 <> '' set @SelectSql4 = @SelectSql4 + ' where ' + @WhereSql4 
            set @SelectSql4 = @SelectSql4 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.Location '
            
            /**/
            set @SelectSql4 = @SelectSql4 + ' union all '
            set @SelectSql4 = @SelectSql4 + '
                select 
                    b.CustomerId, 
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.Location,
                    isnull(sum(g.NewPackages),0) as Packages,	
                    isnull(sum(g.NewTunnages),0.0) as Tunnages,
                    isnull(sum(g.NewPiles),0.0) as Piles,
                    isnull(sum(g.NewTenThousands),0.0) as TenThousands
                from 
                    MoveWarehouseBillGoods g join 
                    MoveWarehouseBill b on g.MoveWarehouseBillId = b.Id '
            
            set @WhereSql4 = '(isnull(g.DeliveryNo,'''') not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql4 <> '' set @SelectSql4 = @SelectSql4 + ' where ' + @WhereSql4 
            set @SelectSql4 = @SelectSql4 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.Location '
            
            /**/
            set @SelectSql4 = '
				select
					r.CustomerId,                      
					r.CustomerName,                       
					r.GoodsId,                       
					r.GoodsNo,                       
					r.GoodsName,                       
					r.Brand,                       
					r.SpecModel,                       
					r.GWeight,                       
					r.Grade,                       
					r.BatchNo,                      
					r.Warehouse,                      
					r.Location,                      
					isnull(sum(r.Packages),0) as Packages,                       
					isnull(sum(r.Tunnages),0.0) as Tunnages,                      
					isnull(sum(r.Piles),0.0) as Piles,                      
					isnull(sum(r.TenThousands),0.0) as TenThousands                  
				from 
					( ' + @SelectSql4 + ') as r 
				group by 
					r.CustomerId,                      
					r.CustomerName,                       
					r.GoodsId,                       
					r.GoodsNo,                       
					r.GoodsName,                       
					r.Brand,                       
					r.SpecModel,                       
					r.GWeight,                       
					r.Grade,                       
					r.BatchNo,                      
					r.Warehouse,                      
					r.Location'
        end
    
        /**/
        if convert(nvarchar(10),cast(@EndTime as datetime),120) < convert(nvarchar(10),getdate(),120)
        begin
            set @SelectSql5 = '
                select 
                    s.CustomerId, 
                    s.CustomerName, 
                    s.GoodsId, 
                    s.GoodsNo, 
                    s.GoodsName, 
                    s.Brand, 
                    s.SpecModel, 
                    s.GWeight, 
                    s.Grade, 
                    s.BatchNo,
                    s.Warehouse,
                    s.Location,
                    isnull(sum(sd.Packages),0) as Packages, 
                    isnull(sum(sd.Tunnages),0.0) as Tunnages,
                    isnull(sum(sd.Piles),0.0) as Piles,
                    isnull(sum(sd.TenThousands),0.0) as TenThousands
                from 
                    StockDaily sd join 
                    Stock s on sd.StockId = s.Id '
        
            set @WhereSql5 = '(isnull(s.DeliveryNo,'''') not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(convert(nvarchar(10),sd.CreateTime,120) = convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql5 <> '' set @SelectSql5 = @SelectSql5 + ' where ' + @WhereSql5 
            set @SelectSql5 = @SelectSql5 + ' group by s.CustomerId, s.CustomerName, s.GoodsId, s.GoodsNo, s.GoodsName, s.Brand, s.SpecModel, s.GWeight, s.Grade, s.BatchNo, s.Warehouse, s.Location '
        end
        else
        begin
            set @SelectSql5 = '
                select 
                    s.CustomerId, 
                    s.CustomerName, 
                    s.GoodsId, 
                    s.GoodsNo, 
                    s.GoodsName, 
                    s.Brand, 
                    s.SpecModel, 
                    s.GWeight, 
                    s.Grade, 
                    s.BatchNo,
                    s.Warehouse,
                    s.Location,
                    isnull(sum(s.Packages),0) as Packages, 
                    isnull(sum(s.Tunnages),0.0) as Tunnages,
                    isnull(sum(s.Piles),0.0) as Piles,
                    isnull(sum(s.TenThousands),0.0) as TenThousands
                from 
                    Stock s '
        
            set @WhereSql5 = '(isnull(s.DeliveryNo,'''') not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql5 <> '' set @SelectSql5 = @SelectSql5 + ' where ' + @WhereSql5 
            set @SelectSql5 = @SelectSql5 + ' group by s.CustomerId, s.CustomerName, s.GoodsId, s.GoodsNo, s.GoodsName, s.Brand, s.SpecModel, s.GWeight, s.Grade, s.BatchNo, s.Warehouse, s.Location '
        end
    
        /**/
        begin
            set @SelectSql6 = '
                select 
                    b.CustomerId,	
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.Location,
                    isnull(sum(g.Packages),0) as Packages, 
                    isnull(sum(g.Tunnages),0.0) as Tunnages,
                    isnull(sum(g.Piles),0.0) as Piles,
                    isnull(sum(g.TenThousands),0.0) as TenThousands
                from 
                    EnterWarehouseBillGoods g join 
                    EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id '
        
            set @WhereSql6 = '(isnull(b.DeliveryNo,'''') not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) and (b.EnterType = ''' + formatmessage(150276) + ''')'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(b.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(b.BillNo like ''%' + @EnterWarehouseBillNo + '%'')'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql6 <> '' set @SelectSql6 = @SelectSql6 + ' where ' + @WhereSql6 
            set @SelectSql6 = @SelectSql6 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.Location '
        end
    
        /**/
        begin
            set @SelectSql7 = '
                select 
                    b.CustomerId, 
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.Location,
                    isnull(sum(g.Packages),0) as Packages,	
                    isnull(sum(g.Tunnages),0.0) as Tunnages,
                    isnull(sum(g.Piles),0.0) as Piles,
                    isnull(sum(g.TenThousands),0.0) as TenThousands
                from 
                    OutWarehouseBillGoods g join 
                    OutWarehouseBill b on g.OutWarehouseBillId = b.Id '
        
            set @WhereSql7 = '(isnull(g.DeliveryNo,'''') not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) and (b.OutType = ''' + formatmessage(150306) + ''')'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(g.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(g.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end

            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql7 <> '' set @SelectSql7 = @SelectSql7 + ' where ' + @WhereSql7 
            set @SelectSql7 = @SelectSql7 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.Location '
        end
    end
    else
    begin
        /**/
        begin
            set @SelectSql1 = '
                select 
                    CustomerId, 
                    CustomerName, 
                    GoodsId, 
                    GoodsNo, 
                    GoodsName, 
                    Brand, 
                    SpecModel, 
                    GWeight, 
                    Grade, 
                    BatchNo,
                    Warehouse,
                    Location,
                    min(ProductionDate) as ProductionDate 
                from 
                    Stock '
        
            set @WhereSql1 = '(isnull(DeliveryNo,'''') in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql1 <> '' set @WhereSql1 = @WhereSql1 + ' and '
                set @WhereSql1 = @WhereSql1 + '(Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql1 <> '' set @SelectSql1 = @SelectSql1 + ' where ' + @WhereSql1 
            set @SelectSql1 = @SelectSql1 + ' group by CustomerId, CustomerName, GoodsId, GoodsNo, GoodsName, Brand, SpecModel,	GWeight, Grade, BatchNo, Warehouse, Location '
        end
    
        /**/
        begin
            set @SelectSql2 = '
                select 
                    s.CustomerId, 
                    s.CustomerName,	
                    s.GoodsId, 
                    s.GoodsNo, 
                    s.GoodsName, 
                    s.Brand, 
                    s.SpecModel, 
                    s.GWeight,	
                    s.Grade, 
                    s.BatchNo,
                    s.Warehouse,
                    s.Location,
                    isnull(sum(sd.Packages),0) as Packages, 
                    isnull(sum(sd.Tunnages),0.0) as Tunnages,
                    isnull(sum(sd.Piles),0.0) as Piles,
                    isnull(sum(sd.TenThousands),0.0) as TenThousands
                from 
                    StockDaily sd join 
                    Stock s on sd.StockId = s.Id '
        
            set @WhereSql2 = '(isnull(s.DeliveryNo,'''') in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(convert(nvarchar(10),sd.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql2 <> '' set @WhereSql2 = @WhereSql2 + ' and '
                set @WhereSql2 = @WhereSql2 + '(s.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql2 <> '' set @SelectSql2 = @SelectSql2 + ' where ' + @WhereSql2 
            set @SelectSql2 = @SelectSql2 + ' group by s.CustomerId, s.CustomerName, s.GoodsId, s.GoodsNo, s.GoodsName, s.Brand, s.SpecModel, s.GWeight, s.Grade, s.BatchNo, s.Warehouse, s.Location '
        end 
    
        /**/
        begin
            set @SelectSql3 = '
                select 
                    b.CustomerId,	
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.Location,
                    isnull(sum(g.Packages),0) as Packages, 
                    isnull(sum(g.Tunnages),0.0) as Tunnages,
                    isnull(sum(g.Piles),0.0) as Piles,
                    isnull(sum(g.TenThousands),0.0) as TenThousands
                from 
                    EnterWarehouseBillGoods g join 
                    EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id '
        
            set @WhereSql3 = '(isnull(b.DeliveryNo,'''') in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.BillNo like ''%' + @EnterWarehouseBillNo + '%'')'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql3 <> '' set @SelectSql3 = @SelectSql3 + ' where ' + @WhereSql3 
            set @SelectSql3 = @SelectSql3 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.Location '
            
            /**/
            set @SelectSql3 = @SelectSql3 + ' union all '
            set @SelectSql3 = @SelectSql3 + '
                select 
                    b.CustomerId,	
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.NewLocation as Location,
                    isnull(sum(g.NewPackages),0) as Packages, 
                    isnull(sum(g.NewTunnages),0.0) as Tunnages,
                    isnull(sum(g.NewPiles),0.0) as Piles,
                    isnull(sum(g.NewTenThousands),0.0) as TenThousands
                from 
                    MoveWarehouseBillGoods g join 
                    EnterWarehouseBill b on g.MoveWarehouseBillId = b.Id '
            
            set @WhereSql3 = '(isnull(g.DeliveryNo,'''') in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql3 <> '' set @WhereSql3 = @WhereSql3 + ' and '
                set @WhereSql3 = @WhereSql3 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql3 <> '' set @SelectSql3 = @SelectSql3 + ' where ' + @WhereSql3 
            set @SelectSql3 = @SelectSql3 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.NewLocation '
            
            /**/
            set @SelectSql3 = '
				select
					r.CustomerId,                      
					r.CustomerName,                       
					r.GoodsId,                       
					r.GoodsNo,                       
					r.GoodsName,                       
					r.Brand,                       
					r.SpecModel,                       
					r.GWeight,                       
					r.Grade,                       
					r.BatchNo,                      
					r.Warehouse,                      
					r.Location,                      
					isnull(sum(r.Packages),0) as Packages,                       
					isnull(sum(r.Tunnages),0.0) as Tunnages,                      
					isnull(sum(r.Piles),0.0) as Piles,                      
					isnull(sum(r.TenThousands),0.0) as TenThousands                  
				from 
					( ' + @SelectSql3 + ') as r 
				group by 
					r.CustomerId,                      
					r.CustomerName,                       
					r.GoodsId,                       
					r.GoodsNo,                       
					r.GoodsName,                       
					r.Brand,                       
					r.SpecModel,                       
					r.GWeight,                       
					r.Grade,                       
					r.BatchNo,                      
					r.Warehouse,                      
					r.Location'
        end
    
        /**/
        begin
            set @SelectSql4 = '
                select 
                    b.CustomerId, 
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.Location,
                    isnull(sum(g.Packages),0) as Packages,	
                    isnull(sum(g.Tunnages),0.0) as Tunnages,
                    isnull(sum(g.Piles),0.0) as Piles,
                    isnull(sum(g.TenThousands),0.0) as TenThousands
                from 
                    OutWarehouseBillGoods g join 
                    OutWarehouseBill b on g.OutWarehouseBillId = b.Id '
        
            set @WhereSql4 = '(isnull(g.DeliveryNo,'''') in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql4 <> '' set @SelectSql4 = @SelectSql4 + ' where ' + @WhereSql4 
            set @SelectSql4 = @SelectSql4 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.Location '
            
            /**/
            set @SelectSql4 = @SelectSql4 + ' union all '
            set @SelectSql4 = @SelectSql4 + '
                select 
                    b.CustomerId, 
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.Location,
                    isnull(sum(g.NewPackages),0) as Packages,	
                    isnull(sum(g.NewTunnages),0.0) as Tunnages,
                    isnull(sum(g.NewPiles),0.0) as Piles,
                    isnull(sum(g.NewTenThousands),0.0) as TenThousands
                from 
                    MoveWarehouseBillGoods g join 
                    EnterWarehouseBill b on g.MoveWarehouseBillId = b.Id '
            
            set @WhereSql4 = '(isnull(g.DeliveryNo,'''') in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql4 <> '' set @WhereSql4 = @WhereSql4 + ' and '
                set @WhereSql4 = @WhereSql4 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql4 <> '' set @SelectSql4 = @SelectSql4 + ' where ' + @WhereSql4 
            set @SelectSql4 = @SelectSql4 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.Location '
            
            /**/
            set @SelectSql4 = '
				select
					r.CustomerId,                      
					r.CustomerName,                       
					r.GoodsId,                       
					r.GoodsNo,                       
					r.GoodsName,                       
					r.Brand,                       
					r.SpecModel,                       
					r.GWeight,                       
					r.Grade,                       
					r.BatchNo,                      
					r.Warehouse,                      
					r.Location,                      
					isnull(sum(r.Packages),0) as Packages,                       
					isnull(sum(r.Tunnages),0.0) as Tunnages,                      
					isnull(sum(r.Piles),0.0) as Piles,                      
					isnull(sum(r.TenThousands),0.0) as TenThousands                  
				from 
					( ' + @SelectSql4 + ') as r 
				group by 
					r.CustomerId,                      
					r.CustomerName,                       
					r.GoodsId,                       
					r.GoodsNo,                       
					r.GoodsName,                       
					r.Brand,                       
					r.SpecModel,                       
					r.GWeight,                       
					r.Grade,                       
					r.BatchNo,                      
					r.Warehouse,                      
					r.Location'
        end
    
        /**/
        if convert(nvarchar(10),cast(@EndTime as datetime),120) < convert(nvarchar(10),getdate(),120)
        begin
            set @SelectSql5 = '
                select 
                    s.CustomerId, 
                    s.CustomerName, 
                    s.GoodsId, 
                    s.GoodsNo, 
                    s.GoodsName, 
                    s.Brand, 
                    s.SpecModel, 
                    s.GWeight, 
                    s.Grade, 
                    s.BatchNo,
                    s.Warehouse,
                    s.Location,
                    isnull(sum(sd.Packages),0) as Packages, 
                    isnull(sum(sd.Tunnages),0.0) as Tunnages,
                    isnull(sum(sd.Piles),0.0) as Piles,
                    isnull(sum(sd.TenThousands),0.0) as TenThousands
                from 
                    StockDaily sd join 
                    Stock s on sd.StockId = s.Id '
        
            set @WhereSql5 = '(isnull(s.DeliveryNo,'''') in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(convert(nvarchar(10),sd.CreateTime,120) = convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql5 <> '' set @SelectSql5 = @SelectSql5 + ' where ' + @WhereSql5 
            set @SelectSql5 = @SelectSql5 + ' group by s.CustomerId, s.CustomerName, s.GoodsId, s.GoodsNo, s.GoodsName, s.Brand, s.SpecModel, s.GWeight, s.Grade, s.BatchNo, s.Warehouse, s.Location '
        end
        else
        begin
            set @SelectSql5 = '
                select 
                    s.CustomerId, 
                    s.CustomerName, 
                    s.GoodsId, 
                    s.GoodsNo, 
                    s.GoodsName, 
                    s.Brand, 
                    s.SpecModel, 
                    s.GWeight, 
                    s.Grade, 
                    s.BatchNo,
                    s.Warehouse,
                    s.Location,
                    isnull(sum(s.Packages),0) as Packages, 
                    isnull(sum(s.Tunnages),0.0) as Tunnages,
                    isnull(sum(s.Piles),0.0) as Piles,
                    isnull(sum(s.TenThousands),0.0) as TenThousands
                from 
                    Stock s '
        
            set @WhereSql5 = '(isnull(s.DeliveryNo,'''') in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql5 <> '' set @WhereSql5 = @WhereSql5 + ' and '
                set @WhereSql5 = @WhereSql5 + '(s.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql5 <> '' set @SelectSql5 = @SelectSql5 + ' where ' + @WhereSql5 
            set @SelectSql5 = @SelectSql5 + ' group by s.CustomerId, s.CustomerName, s.GoodsId, s.GoodsNo, s.GoodsName, s.Brand, s.SpecModel, s.GWeight, s.Grade, s.BatchNo, s.Warehouse, s.Location '
        end
    
        /**/
        begin
            set @SelectSql6 = '
                select 
                    b.CustomerId,	
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.Location,
                    isnull(sum(g.Packages),0) as Packages, 
                    isnull(sum(g.Tunnages),0.0) as Tunnages,
                    isnull(sum(g.Piles),0.0) as Piles,
                    isnull(sum(g.TenThousands),0.0) as TenThousands
                from 
                    EnterWarehouseBillGoods g join 
                    EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id '
        
            set @WhereSql6 = '(isnull(b.DeliveryNo,'''') in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) and (b.EnterType = ''' + formatmessage(150276) + ''')'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(b.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(b.BillNo like ''%' + @EnterWarehouseBillNo + '%'')'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql6 <> '' set @WhereSql6 = @WhereSql6 + ' and '
                set @WhereSql6 = @WhereSql6 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql6 <> '' set @SelectSql6 = @SelectSql6 + ' where ' + @WhereSql6 
            set @SelectSql6 = @SelectSql6 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.Location '
        end
    
        /**/
        begin
            set @SelectSql7 = '
                select 
                    b.CustomerId, 
                    b.CustomerName,	
                    g.GoodsId, 
                    g.GoodsNo, 
                    g.GoodsName, 
                    g.Brand, 
                    g.SpecModel, 
                    g.GWeight, 
                    g.Grade, 
                    g.BatchNo,
                    b.Warehouse,
                    g.Location,
                    isnull(sum(g.Packages),0) as Packages,	
                    isnull(sum(g.Tunnages),0.0) as Tunnages,
                    isnull(sum(g.Piles),0.0) as Piles,
                    isnull(sum(g.TenThousands),0.0) as TenThousands
                from 
                    OutWarehouseBillGoods g join 
                    OutWarehouseBill b on g.OutWarehouseBillId = b.Id '
        
            set @WhereSql7 = '(isnull(g.DeliveryNo,'''') in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) and (b.OutType = ''' + formatmessage(150306) + ''')'
        
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
        
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
        
            if @CustomerName is not null and @CustomerName <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(b.CustomerName like ''%' + @CustomerName + '%'')'
            end
        
            if @DeliveryNo is not null and @DeliveryNo <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(g.DeliveryNo like ''%' + @DeliveryNo + '%'')'
            end
        
            if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(g.EnterWarehouseBillId in (select Id from EnterWarehouseBill where BillNo like ''%' + @EnterWarehouseBillNo + '%''))'
            end
        
            if @GoodsNo is not null and @GoodsNo <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(g.GoodsNo = ''' + @GoodsNo + ''')'
            end
            
            if @BatchNo is not null and @BatchNo <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(g.BatchNo like ''%' + @BatchNo + '%'')'
            end
        
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql7 <> '' set @WhereSql7 = @WhereSql7 + ' and '
                set @WhereSql7 = @WhereSql7 + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
        
            if @WhereSql7 <> '' set @SelectSql7 = @SelectSql7 + ' where ' + @WhereSql7 
            set @SelectSql7 = @SelectSql7 + ' group by b.CustomerId, b.CustomerName, g.GoodsId,	g.GoodsNo, g.GoodsName,	g.Brand, g.SpecModel, g.GWeight, g.Grade, g.BatchNo, b.Warehouse, g.Location '
        end
    end
    
    /**/
    set @SelectSql = 
        'select 
            r0.CustomerId,
            r0.CustomerName,
            r0.GoodsId,
            r0.GoodsNo,
            r0.GoodsName,
            r0.Brand,
            r0.SpecModel,
            r0.GWeight,
            r0.Grade,
            r0.BatchNo,
            r0.Warehouse,
            r0.Location,
            r0.ProductionDate,
            isnull(r1.Packages,0) as StartPackages,
            isnull(r1.Tunnages,0.0) as StartTunnages,
            isnull(r1.Piles,0.0) as StartPiles,
            isnull(r1.TenThousands,0.0) as StartTenThousands,
            isnull(r2.Packages,0) as TotalEnterWarehousePackages,
            isnull(r2.Tunnages,0.0) as TotalEnterWarehouseTunnages,
            isnull(r2.Piles,0.0) as TotalEnterWarehousePiles,
            isnull(r2.TenThousands,0.0) as TotalEnterWarehouseTenThousands,
            isnull(r3.Packages,0) as TotalOutWarehousePackages,
            isnull(r3.Tunnages,0.0) as TotalOutWarehouseTunnages,
            isnull(r3.Piles,0.0) as TotalOutWarehousePiles,
            isnull(r3.TenThousands,0.0) as TotalOutWarehouseTenThousands,
            isnull(r4.Packages,0) as EndPackages,
            isnull(r4.Tunnages,0.0) as EndTunnages, 
            isnull(r4.Piles,0.0) as EndPiles, 
            isnull(r4.TenThousands,0.0) as EndTenThousands, 
            isnull(r5.Packages,0) as TotalAllocateEnterWarehousePackages,
            isnull(r5.Tunnages,0.0) as TotalAllocateEnterWarehouseTunnages,
            isnull(r5.Piles,0.0) as TotalAllocateEnterWarehousePiles,
            isnull(r5.TenThousands,0.0) as TotalAllocateEnterWarehouseTenThousands,
            isnull(r6.Packages,0) as TotalAllocateOutWarehousePackages,
            isnull(r6.Tunnages,0.0) as TotalAllocateOutWarehouseTunnages,
            isnull(r6.Piles,0.0) as TotalAllocateOutWarehousePiles,
            isnull(r6.TenThousands,0.0) as TotalAllocateOutWarehouseTenThousands
        from '
        
    set @SelectSql = @SelectSql + '(' + @SelectSql1 + ') as r0 left join '
        
    set @SelectSql = @SelectSql + '(' + @SelectSql2 + ') as r1 on r0.CustomerId = r1.CustomerId and r0.GoodsId = r1.GoodsId and r0.GWeight = r1.GWeight and r0.Grade = r1.Grade and r0.BatchNo = r1.BatchNo and r0.Warehouse = r1.Warehouse and r0.Location = r1.Location left join '
        
    set @SelectSql = @SelectSql + '(' + @SelectSql3 + ') as r2 on r0.CustomerId = r2.CustomerId and r0.GoodsId = r2.GoodsId and r0.GWeight = r2.GWeight and r0.Grade = r2.Grade and r0.BatchNo = r2.BatchNo and r0.Warehouse = r2.Warehouse and r0.Location = r2.Location left join '
        
    set @SelectSql = @SelectSql + '(' + @SelectSql4 + ') as r3 on r0.CustomerId = r3.CustomerId and r0.GoodsId = r3.GoodsId and r0.GWeight = r3.GWeight and r0.Grade = r3.Grade and r0.BatchNo = r3.BatchNo and r0.Warehouse = r3.Warehouse and r0.Location = r3.Location left join '

    set @SelectSql = @SelectSql + '(' + @SelectSql5 + ') as r4 on r0.CustomerId = r4.CustomerId and r0.GoodsId = r4.GoodsId and r0.GWeight = r4.GWeight and r0.Grade = r4.Grade and r0.BatchNo = r4.BatchNo and r0.Warehouse = r4.Warehouse and r0.Location = r4.Location left join '

    set @SelectSql = @SelectSql + '(' + @SelectSql6 + ') as r5 on r0.CustomerId = r5.CustomerId and r0.GoodsId = r5.GoodsId and r0.GWeight = r5.GWeight and r0.Grade = r5.Grade and r0.BatchNo = r5.BatchNo and r0.Warehouse = r5.Warehouse and r0.Location = r5.Location left join '

    set @SelectSql = @SelectSql + '(' + @SelectSql7 + ') as r6 on r0.CustomerId = r6.CustomerId and r0.GoodsId = r6.GoodsId and r0.GWeight = r6.GWeight and r0.Grade = r6.Grade and r0.BatchNo = r6.BatchNo and r0.Warehouse = r6.Warehouse and r0.Location = r6.Location '
    
    set @SelectSql = @SelectSql + '
        where 
            isnull(r1.Packages,0) <> 0 or 
            isnull(r1.Tunnages,0.0) <> 0 or 
            isnull(r1.Piles,0.0) <> 0 or 
            isnull(r1.TenThousands,0.0) <> 0 or 
            isnull(r2.Packages,0) <> 0 or 
            isnull(r2.Tunnages,0.0) <> 0 or 
            isnull(r2.Piles,0.0) <> 0 or 
            isnull(r2.TenThousands,0.0) <> 0 or 
            isnull(r3.Packages,0) <> 0 or 
            isnull(r3.Tunnages,0.0) <> 0 or 
            isnull(r3.Piles,0.0) <> 0 or 
            isnull(r3.TenThousands,0.0) <> 0 or 
            isnull(r4.Packages,0) <> 0 or 
            isnull(r4.Tunnages,0.0) <> 0 or 
            isnull(r4.Piles,0.0) <> 0 or 
            isnull(r4.TenThousands,0.0) <> 0 or 
            isnull(r5.Packages,0) <> 0 or 
            isnull(r5.Tunnages,0.0) <> 0 or 
            isnull(r5.Piles,0.0) <> 0 or 
            isnull(r5.TenThousands,0.0) <> 0 or 
            isnull(r6.Packages,0) <> 0 or 
            isnull(r6.Tunnages,0.0) <> 0 or 
            isnull(r6.Piles,0.0) <> 0 or 
            isnull(r6.TenThousands,0.0) <> 0'
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150471,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150472)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'EnterWarehouseBillNo=' + @EnterWarehouseBillNo + N',' +
                       N'GoodsNo=' + @GoodsNo + N',' +
                       N'BatchNo=' + @BatchNo + N',' +
                       N'Warehouse=' + @Warehouse 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadEnterWarehouseBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        e.*, 
        isnull(sp.StorageFeePrice,0.0) as StorageFeePrice, 
        isnull(fp.UnloadingForceFeePrice,0.0) as UnloadingForceFeePrice
    from 
        EnterWarehouseBill e left join 
        CustomerForceFeePrice fp on e.CustomerId = fp.CustomerId and convert(nvarchar(10),e.CreateTime,120) >= convert(nvarchar(10),fp.StartTime,120) and convert(nvarchar(10),e.CreateTime,120) <= convert(nvarchar(10),fp.EndTime,120) left join 
        CustomerStorageFeePrice sp on e.CustomerId = sp.CustomerId and convert(nvarchar(10),e.CreateTime,120) >= convert(nvarchar(10),sp.StartTime,120) and convert(nvarchar(10),e.CreateTime,120) <= convert(nvarchar(10),sp.EndTime,120)
    where 
        e.Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150281,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150402)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadEnterWarehouseBillAllGoods 
@EnterWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        g.*,
        b.CustomerId,
        b.CustomerName,
        b.DeliveryNo,
        b.Warehouse,
        b.CreateTime 
    from 
        EnterWarehouseBillGoods g left join 
        EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id
    where 
        g.EnterWarehouseBillId = @EnterWarehouseBillId 
    
    /**/
    select @OpName = formatmessage(150403)
    select @OpParams = N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadEnterWarehouseBillByPlanId 
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from EnterWarehouseBill where PlanId = @PlanId 
    
    
    /**/
    select @OpName = formatmessage(150655)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadEnterWarehouseBillGoodsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@CustomerName nvarchar(50),
@DeliveryNo nvarchar(50),
@EnterWarehouseBillNo nvarchar(50),
@GoodsNo nvarchar(50),
@GoodsName nvarchar(50),
@SpecModel nvarchar(100),
@BatchNo nvarchar(50),
@EnterType nvarchar(50),
@Warehouse nvarchar(50),
@IsConsigning nvarchar(50),
@HasDrayage nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = 'select g.*, b.BillNo as EnterWarehouseBillNo, b.CustomerId, b.CustomerName, b.DeliveryNo, b.EnterType, b.Warehouse, b.CreateTime from EnterWarehouseBillGoods g join EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id '
    set @WhereSql = ''

    if @StartTime is not null and @StartTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),b.CreateTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),b.CreateTime,120) <= ''' + @EndTime + ''')'
    end

    if @CustomerName is not null and @CustomerName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.CustomerName like ''%' + @CustomerName + '%'')'
    end
    
    if @DeliveryNo is not null and @DeliveryNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.DeliveryNo like ''%' + @DeliveryNo + '%'')'
    end
    
    if @EnterWarehouseBillNo is not null and @EnterWarehouseBillNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.BillNo like ''%' + @EnterWarehouseBillNo + '%'')'
    end
    
    if @GoodsNo is not null and @GoodsNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(g.GoodsNo like ''%' + @GoodsNo + '%'')'
    end

    if @GoodsName is not null and @GoodsName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(g.GoodsName like ''%' + @GoodsName + '%'')'
    end

    if @SpecModel is not null and @SpecModel <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(g.SpecModel like ''%' + @SpecModel + '%'')'
    end

    if @BatchNo is not null and @BatchNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(g.BatchNo like ''%' + @BatchNo + '%'')'
    end

    if @EnterType is not null and @EnterType <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.EnterType = ''' + @EnterType + ''')'
    end

    if @Warehouse is not null and @Warehouse <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.Warehouse = ''' + @Warehouse + ''')'
    end
    
    if @IsConsigning is not null and @IsConsigning <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.IsConsigning = ' + convert(nvarchar, cast(@IsConsigning as bit)) + ')'
    end
    
    if @HasDrayage is not null and @HasDrayage <> ''
    begin
        if cast(@HasDrayage as bit) = 1 
        begin
            if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
            set @WhereSql = @WhereSql + '(b.HasDrayage = 1)'
        end
        else
        begin
            if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
            set @WhereSql = @WhereSql + '(b.HasDrayage = 0)'
        end
    end
    
    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    set @SelectSql = @SelectSql + ' order by b.CreateTime '
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150459,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150460)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'EnterWarehouseBillNo=' + @EnterWarehouseBillNo + N',' +
                       N'GoodsNo=' + @GoodsNo + N',' +
                       N'GoodsName=' + @GoodsName + N',' +
                       N'SpecModel=' + @SpecModel + N',' +
                       N'BatchNo=' + @BatchNo + N',' +
                       N'EnterType=' + @EnterType + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'IsConsigning=' + @IsConsigning + N',' +
                       N'HasDrayage=' + @HasDrayage
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadFineContractsByConditions 
@ContractNo nvarchar(50),
@OriginalContractNo nvarchar(50),
@CreatorId nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    set @Sql = '
        select 
            c.*,
            isnull(cdp.TotalTransportCharges, 0.0) as TotalOriginalTransportCharges,
            isnull(cdp.TotalApprovedTransportCharges, 0.0) as TotalApprovedTransportCharges
        from 
            Contract c left join 
            (
                select 
                    ContractId,
                    isnull(sum(TransportCharges), 0.0) as TotalTransportCharges,
                    isnull(sum(ApprovedTransportCharges), 0.0) as TotalApprovedTransportCharges
                from 
                    ContractDeliverPlan 
                group by 
                    ContractId 
            ) as cdp on c.Id = cdp.ContractId 
        where '
            
    set @Sql = @Sql + '(c.ContractState = ''' + formatmessage(150242) + ''') and '
    set @Sql = @Sql + '(c.PrintState = 1) and '
    set @Sql = @Sql + '(c.ApproveState = ''' + formatmessage(150439) + ''') and '
    set @Sql = @Sql + '(c.Id in (select ContractId from ContractDeliverPlan where abs(TransportCharges) > abs(ApprovedTransportCharges))) and '
    set @Sql = @Sql + '(c.FineAmount is null or c.FineAmount = 0) '
            
    if @ContractNo is not null and @ContractNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(c.ContractNo = ''' + @ContractNo + ''')'
    end
        
    if @OriginalContractNo is not null and @OriginalContractNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(c.OriginalContractNo = ''' + @OriginalContractNo + ''')'
    end
    
    if @CreatorId is not null and @CreatorId <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(c.CreatorId in (select Id from Account where AccountType = ''' + formatmessage(150162) + ''' and StaffId = ' + @CreatorId + '))'
    end

    exec(@Sql)
    
    
    /**/
    select @OpName = formatmessage(150456)
    select @OpParams = N'ContractNo=' + @ContractNo + N',' +
                       N'OriginalContractNo=' + @OriginalContractNo + N',' +
                       N'CreatorId=' + @CreatorId
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadForeignDeliverPlans 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @CountryName nvarchar(20)
declare @ProvinceName nvarchar(20)
declare @CityName nvarchar(20)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @CountryName = CountryName, @ProvinceName = ProvinceName, @CityName = CityName from Organization where Id in (select OrganId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0)
    if @@rowcount = 0
    begin
        raiserror (150304,18,1)
        return -1
    end
    
    /**/
    select 
        dp.Id,
        dp.PlanNo,
        dp.CustomerName,
        dp.ShipmentNo,
        dp.DeliveryNo,
        dp.ReceiverName,
        dp.ArrivalTime,
        dp.PlanType,
        dp.CreateTime, 
        dp.StartCity, 
        dpg.TotalTunnages, 
        dpg.TotalPiles,
        case when d.CarNo is not null and d.CarNo <> '' then d.CarNo else dp.CarNo end as CarNo,
        case when d.DriverName is not null and d.DriverName <> '' then d.DriverName else dp.DriverName end as DriverName,
        case when d.DriverMobileTel is not null and d.DriverMobileTel <> '' then d.DriverMobileTel else dp.DriverMobileTel end as DriverMobileTel 
    from 
        DeliverPlan dp join 
        (
            select 
                PlanId, 
                isnull(sum(Tunnages), 0.0) as TotalTunnages, 
                isnull(sum(Piles), 0.0) as TotalPiles 
            from 
                DeliverPlanGoods 
            group by 
                PlanId
        ) as dpg on dp.Id = dpg.PlanId left join 
        (
            select 
                p.PlanId,
                b.CarNo,
                b.DriverName,
                b.DriverMobileTel 
            from 
                DispatchBillDeliverPlan p join 
                DispatchBill b on p.DispatchBillId = b.Id join 
                (
                    select 
                        p1.PlanId,
                        max(b1.CreateTime) as DispatchTime
                    from 
                        DispatchBillDeliverPlan p1 join 
                        DispatchBill b1 on p1.DispatchBillId = b1.Id 
                    group by 
                        p1.PlanId 
                ) as r on p.PlanId = r.PlanId and b.CreateTime = r.DispatchTime 
        ) as d on dp.Id = d.PlanId 
    where 
        dp.PlanState = formatmessage(150242) and
        dp.DeliverType = formatmessage(150305) and
        dp.ReceiverCountry = @CountryName and 
        dp.ReceiverProvince = @ProvinceName and 
        dp.ReceiverCity = @CityName 
    order by 
        dp.CreateTime desc

    if @@error <> 0
    begin
        raiserror (150302,18,1)
        return -2
    end
    
    /**/
    select @OpName = formatmessage(150303)
    select @OpParams = N'' 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @FuncPermission
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadFunctionPermission
@Id bigint,
@FuncPermission nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

    set @Sql = 'select ' + @FuncPermission + ' from SysFunction where Id = ' + convert(nvarchar, @Id) 
    exec (@Sql)
    
    if @@error <> 0
    begin
        raiserror (150112,18,1)
        return -1
    end

	/**/
	select @OpName = formatmessage(150113)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'FuncPermission=' + @FuncPermission 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end

    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @OpStaffId
 * @OpStaffName
 *
 * 
 * 
*******************************************************************************************/
create procedure LoadFunctions
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from SysFunction

	/**/
	select @OpName = formatmessage(150006)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end

    return 0
end
go


create procedure LoadGenerateBusinessCarriersByTimespan 
@StartTime nvarchar(10),
@EndTime nvarchar(10),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        * 
    from 
        Carrier 
    where 
        Id in 
        (
            select distinct 
                CarrierId 
            from 
                DeliverBill 
            where 
                convert(nvarchar(10),CreateTime,120) >= @StartTime and 
                convert(nvarchar(10),CreateTime,120) <= @EndTime 
        ) 
        
    
    /**/
    select @OpName = formatmessage(150493)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadGenerateBusinessPayersByTimespan 
@StartTime nvarchar(10),
@EndTime nvarchar(10),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @Sql2 nvarchar(max)
declare @Sql3 nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    set @Sql = '
        select distinct
	        r1.CustomerId
        from 
	        (
		        select 
			        db.Id,
			        dp.PayerId as CustomerId,
			        convert(nvarchar(10),db.CreateTime,120) as CreateTime,
			        i.InvoiceNo,
			        db.OwnOrganId,
                    dp.ReceiveType 
		        from 
			        DeliverBill db join 
			        (
				        select 
					        Id,
					        PayerId,
                            ReceiveType 
				        from 
					        DeliverPlan 
			        ) as dp on db.PlanId = dp.Id left join 
			        CustomerTransportChargesSettlement i on db.CustomerTransportChargesSettlementId = i.Id 
	        ) as r1 '
    
    set @Sql = @Sql + ' where (r1.OwnOrganId in (select Id from Organization where FullPath like (select o.FullPath + ''%'' from Account a join Organization o on a.OrganId = o.Id where a.Id = ' + convert(nvarchar,@OpStaffId) + ' and a.AccountType = ''' + formatmessage(150162) + ''' and a.IsCancel = 0))) '
    
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.ReceiveType <> ''' + formatmessage(150347) + ''')'
    end
    
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CreateTime >= ''' + @StartTime + ''')'
    end
    
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.CreateTime <= ''' + @EndTime + ''')'
    end
    
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(r1.InvoiceNo is null)'
    end

    /**/
    set @Sql2 = '
        select distinct
	        r1.CustomerId
        from 
            (
	            select 
			        db.Id,
			        dp.PayerId as CustomerId,
			        i.InvoiceNo,
			        db.OwnOrganId,
                    dp.ReceiveType,
                    dp.ConsignedDeliveryNo
	            from 
		            DeliverBill db join 
		            (
			            select 
					        Id,
					        PayerId,
                            ReceiveType,
                            ConsignedDeliveryNo
			            from 
				            DeliverPlan 
		            ) as dp on db.PlanId = dp.Id left join 
		            CustomerTransportChargesSettlement i on db.CustomerTransportChargesSettlementId = i.Id 
            ) as r1 '

    set @Sql2 = @Sql2 + ' where (r1.OwnOrganId in (select Id from Organization where FullPath like (select o.FullPath + ''%'' from Account a join Organization o on a.OrganId = o.Id where a.Id = ' + convert(nvarchar,@OpStaffId) + ' and a.AccountType = ''' + formatmessage(150162) + ''' and a.IsCancel = 0))) '

    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.ReceiveType <> ''' + formatmessage(150347) + ''')'
    end

    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(
            isnull(r1.ConsignedDeliveryNo,'''') in 
            (
	            select 
		            t3.DeliveryNo 
	            from 
		            (
			            select distinct
				            t1.DeliveryNo 
			            from 
				            (	
					            select 
						            p.DeliveryNo,
						            g.GoodsId,
						            g.BatchNo,
						            g.Packages,
						            g.Piles
					            from 
						            DeliverPlanGoods g join 
						            DeliverPlan p on g.PlanId = p.Id 
					            where 
						            p.IsConsigning = 1
				            ) as t1 join 
				            (
					            select 
						            p.ConsignedDeliveryNo,
						            g.GoodsId,
						            g.BatchNo,
						            sum(g.Packages) as DeliverPackages,
						            sum(g.Piles) as DeliverPiles 
					            from 
						            DeliverBillGoods g join 
						            DeliverBill b on g.DeliverBillId = b.Id join 
                                    DeliverPlan p on b.PlanId = p.Id 
                                where 
                                    p.ConsignedDeliveryNo is not null and 
                                    p.ConsignedDeliveryNo <> ''''
					            group by 
						            p.ConsignedDeliveryNo, 
						            g.GoodsId,
						            g.BatchNo 
				            ) as t2 on t1.DeliveryNo = t2.ConsignedDeliveryNo and t1.GoodsId = t2.GoodsId and t1.BatchNo = t2.BatchNo and t1.Packages = t2.DeliverPackages and t1.Piles = t2.DeliverPiles 
		            ) as t3 left join ' 
                        
        set @Sql2 = @Sql2 + '
                    (
				        select                                           
					        p.ConsignedDeliveryNo,                                          
					        max(b.CreateTime) as DeliverTime                                       
				        from                                           
					        DeliverBill b join                                           
					        DeliverPlan p on b.PlanId = p.Id                                       
				        where                                           
					        p.ConsignedDeliveryNo is not null and                                           
					        p.ConsignedDeliveryNo <> ''''                                      
				        group by                                           
					        p.ConsignedDeliveryNo                               
			        ) as t4 on t3.DeliveryNo = t4.ConsignedDeliveryNo '
                        
        set @Sql2 = @Sql2 + '
	            where 
		            t3.DeliveryNo not in
		            (
			            select distinct
				            t1.DeliveryNo 
			            from 
				            (	
					            select 
						            p.DeliveryNo,
						            g.GoodsId,
						            g.BatchNo,
						            g.Packages,
						            g.Piles
					            from 
						            DeliverPlanGoods g join 
						            DeliverPlan p on g.PlanId = p.Id 
					            where 
						            p.IsConsigning = 1
				            ) as t1 join 
				            (
					            select 
						            p.ConsignedDeliveryNo,
						            g.GoodsId,
						            g.BatchNo,
						            sum(g.Packages) as DeliverPackages,
						            sum(g.Piles) as DeliverPiles 
					            from 
						            DeliverBillGoods g join 
						            DeliverBill b on g.DeliverBillId = b.Id join 
                                    DeliverPlan p on b.PlanId = p.Id 
                                where 
                                    p.ConsignedDeliveryNo is not null and 
                                    p.ConsignedDeliveryNo <> ''''
					            group by 
						            p.ConsignedDeliveryNo, 
						            g.GoodsId,
						            g.BatchNo 
				            ) as t2 on t1.DeliveryNo = t2.ConsignedDeliveryNo and t1.GoodsId = t2.GoodsId and t1.BatchNo = t2.BatchNo and (t1.Packages <> t2.DeliverPackages or t1.Piles <> t2.DeliverPiles) 
		            ) and '
                        
        set @Sql2 = @Sql2 + '
                    (convert(nvarchar(10),t4.DeliverTime,120) >= ''' + @StartTime + ''') and '
                                
        set @Sql2 = @Sql2 + '
                    (convert(nvarchar(10),t4.DeliverTime,120) <= ''' + @EndTime + ''')'
                                
        set @Sql2 = @Sql2 + '
            ))'
    end
        
    begin
        set @Sql2 = @Sql2 + ' and '
        set @Sql2 = @Sql2 + '(r1.InvoiceNo is null)'
    end
       
    set @Sql = @Sql + ' union ' + @Sql2
    
    set @Sql3 = 'select * from Customer where Id in ('
    
    set @Sql3 = @Sql3 + @Sql 
    
    set @Sql3 = @Sql3 + ')'
    
    exec(@Sql3)
    
    if @@error <> 0
    begin
        raiserror (150587,18,1)
        return -1
    end
            
    
    /**/
    select @OpName = formatmessage(150482)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadGenerateStorageAndForceFeeCustomersByTimespan 
@StartTime nvarchar(10),
@EndTime nvarchar(10),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        * 
    from 
        Customer 
    where 
        Id in 
        (
            select 
                distinct CustomerId 
            from 
                EnterWarehouseBill 
            where 
                ForceFee > 0 and 
                convert(nvarchar(10),CreateTime,120) >= @StartTime and 
                convert(nvarchar(10),CreateTime,120) <= @EndTime 
            union
            select 
                distinct CustomerId 
            from 
                OutWarehouseBill 
            where 
                ForceFee > 0 and 
                convert(nvarchar(10),CreateTime,120) >= @StartTime and 
                convert(nvarchar(10),CreateTime,120) <= @EndTime 
            union 
            select 
                distinct CustomerId
            from 
                Stock 
            where 
                Id in 
                (
                    select 
                        StockId 
                    from 
                        StockDaily 
                    where 
                        (Tunnages > 0 or Piles > 0) and 
                        convert(nvarchar(10),CreateTime,120) >= @StartTime and 
                        convert(nvarchar(10),CreateTime,120) <= @EndTime 
                )
        ) and 
        Id not in 
        (
            select 
                distinct CustomerId 
            from 
                CustomerStorageAndForceFeeSettlement
            where 
                convert(nvarchar(10),StartTime,120) < convert(nvarchar(10),@EndTime,120) and 
                convert(nvarchar(10),EndTime,120) > convert(nvarchar(10),@StartTime,120)
        ) and 
        OwnOrganId in 
        (
            select 
                Id 
            from 
                Organization 
            where 
                FullPath like 
                (
                    select 
                        o.FullPath + '%' 
                    from 
                        Account a join 
                        Organization o on a.OrganId = o.Id 
                    where 
                        a.Id = @OpStaffId and 
                        a.AccountType = formatmessage(150162) and
                        a.IsCancel = 0
                )
        ) 
        
    
    /**/
    select @OpName = formatmessage(150583)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadGoods 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Goods where Id = @Id 
    
    /**/
    select @OpName = formatmessage(150181)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadGoodsByGoodsNo 
@GoodsNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Goods where GoodsNo = @GoodsNo 
    
    /**/
    select @OpName = formatmessage(150234)
    select @OpParams = N'GoodsNo=' + @GoodsNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadGoodsStocksByConditions 
@CustomerId nvarchar(50),
@GoodsId nvarchar(50),
@BatchNo nvarchar(50),
@Packing nvarchar(50),
@Warehouse nvarchar(50),
@Location nvarchar(50),
@ProductionDate nvarchar(50),
@EnterWarehouseBillId nvarchar(50),
@DeliveryNo nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    if @DeliveryNo is null or @DeliveryNo = ''
    begin
        set @Sql = '
            select 
                s.GoodsId, 
                s.GoodsNo, 
                s.GoodsName, 
                s.Brand, 
                s.SpecModel, 
                s.GWeight, 
                s.Grade, 
                s.BatchNo, 
                s.Packing,
                s.Warehouse,
                s.Location,
                isnull(sum(s.Packages), 0) as Packages,
                case when isnull(sum(s.Packages), 0) <> 0 then isnull(sum(s.Tunnages), 0.0) / isnull(sum(s.Packages), 0) else null end as PieceWeight,
                isnull(sum(s.Tunnages), 0.0) as Tunnages,
                isnull(sum(s.Piles), 0.0) as Piles,
                isnull(sum(s.TenThousands), 0.0) as TenThousands,
                s.ProductionDate,
                s.EnterWarehouseBillId,
                ewb.BillNo as EnterWarehouseBillNo
            from 
                Stock s left join 
                EnterWarehouseBill ewb on s.EnterWarehouseBillId = ewb.Id
            where 
                (s.Packages > 0 or s.Tunnages > 0 or s.Piles > 0) and 
                (s.DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'

        if @CustomerId is not null and @CustomerId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.CustomerId = ' + @CustomerId + ')'
        end
        
        if @Warehouse is not null and @Warehouse <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.Warehouse = ''' + @Warehouse + ''')'
        end
        
        if @GoodsId is not null and @GoodsId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.GoodsId = ' + @GoodsId + ')'
        end
        
        if @BatchNo is not null and @BatchNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.BatchNo = ''' + @BatchNo + ''')'
        end
        
        if @Packing is not null and @Packing <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.Packing = ''' + @Packing + ''')'
        end
        
        if @Location is not null and @Location <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.Location = ''' + @Location + ''')'
        end
        
        if @ProductionDate is not null and @ProductionDate <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.ProductionDate = ''' + @ProductionDate + ''')'
        end
        
        if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
        end
        
        set @Sql = @Sql + '
            group by 
                s.GoodsId, 
                s.GoodsNo, 
                s.GoodsName, 
                s.Brand, 
                s.SpecModel, 
                s.GWeight, 
                s.Grade, 
                s.BatchNo, 
                s.Packing,
                s.Warehouse,
                s.Location,
                s.ProductionDate,
                s.EnterWarehouseBillId,
                ewb.BillNo '
    end
    else
    begin
        set @Sql = '
            select 
                s.GoodsId, 
                s.GoodsNo, 
                s.GoodsName, 
                s.Brand, 
                s.SpecModel, 
                s.GWeight, 
                s.Grade, 
                s.BatchNo, 
                s.Packing,
                s.Warehouse,
                s.Location,
                isnull(sum(s.Packages), 0) as Packages,
                case when isnull(sum(s.Packages), 0) <> 0 then isnull(sum(s.Tunnages), 0.0) / isnull(sum(s.Packages), 0) else null end as PieceWeight,
                isnull(sum(s.Tunnages), 0.0) as Tunnages,
                isnull(sum(s.Piles), 0.0) as Piles,
                isnull(sum(s.TenThousands), 0.0) as TenThousands,
                s.ProductionDate,
                s.EnterWarehouseBillId,
                ewb.BillNo as EnterWarehouseBillNo
            from 
                Stock s left join 
                EnterWarehouseBill ewb on s.EnterWarehouseBillId = ewb.Id
            where 
                (s.Packages > 0 or s.Tunnages > 0 or s.Piles > 0)'
        
        if @DeliveryNo is not null and @DeliveryNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.DeliveryNo = ''' + @DeliveryNo + ''')'
        end    

        if @Warehouse is not null and @Warehouse <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.Warehouse = ''' + @Warehouse + ''')'
        end
        
        if @GoodsId is not null and @GoodsId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.GoodsId = ' + @GoodsId + ')'
        end
        
        if @BatchNo is not null and @BatchNo <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.BatchNo = ''' + @BatchNo + ''')'
        end
        
        if @Packing is not null and @Packing <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.Packing = ''' + @Packing + ''')'
        end
        
        if @Location is not null and @Location <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.Location = ''' + @Location + ''')'
        end
        
        if @ProductionDate is not null and @ProductionDate <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.ProductionDate = ''' + @ProductionDate + ''')'
        end
        
        if @EnterWarehouseBillId is not null and @EnterWarehouseBillId <> ''
        begin
            set @Sql = @Sql + ' and '
            set @Sql = @Sql + '(s.EnterWarehouseBillId = ' + @EnterWarehouseBillId + ')'
        end
        
        set @Sql = @Sql + '
            group by 
                s.GoodsId, 
                s.GoodsNo, 
                s.GoodsName, 
                s.Brand, 
                s.SpecModel, 
                s.GWeight, 
                s.Grade, 
                s.BatchNo, 
                s.Packing,
                s.Warehouse,
                s.Location,
                s.ProductionDate,
                s.EnterWarehouseBillId,
                ewb.BillNo '
    end
    
    exec (@Sql)
   
    /**/
    set @OpName = formatmessage(150259)
    set @OpParams = N'CustomerId=' + @CustomerId + N',' +
                    N'GoodsId=' + @GoodsId + N',' + 
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'Warehouse=' + @Warehouse + N',' +
                    N'Location=' + @Location + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'EnterWarehouseBillId=' + @EnterWarehouseBillId + N',' +
                    N'DeliveryNo=' + @DeliveryNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure LoadGoodsType 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from GoodsType where Id = @Id
    
    if @@rowcount = 0
    begin
        raiserror (150092,18,1)
        return -1
    end
    

    /**/
    select @OpName = formatmessage(150093)
    select @OpParams = N'Id=' + convert(nvarchar, @Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure LoadGoodsTypes 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from GoodsType 

    /**/
    select @OpName = formatmessage(150091)
    select @OpParams = N'' 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @GroupId
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadGroupPermissions
@GroupId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select g.*, f.Name as FuncName from SysGroupPermission g left join SysFunction f on g.FuncId = f.Id where g.GroupId = @GroupId order by g.FuncId 

	/**/
	select @OpName = formatmessage(150111)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end

    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @StaffId
 * @StartDate
 * @EndDate
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadLoginLogs
@StaffId bigint,
@StartDate datetime,
@EndDate datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

    select 
        *,
        datediff(minute, LoginTime, isnull(LogoutTime,getdate())) as TimeSpan 
    from 
        LoginLog 
    where 
        StaffId = @StaffId and 
        LoginTime between @StartDate and @EndDate 
    order by 
        LoginTime 
    
    /**/
    select @OpName = formatmessage(150019)
    select @OpParams = N'StaffId=' + convert(nvarchar,@StaffId) + N',' +
                       N'StartDate=' + convert(nvarchar,@StartDate,120) + N',' +
                       N'EndDate=' + convert(nvarchar,@EndDate,120)
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end

    return 0
end
go


create procedure LoadMoveWarehouseBillGoodsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@CustomerName nvarchar(50),
@MoveWarehouseBillNo nvarchar(50),
@GoodsNo nvarchar(50),
@Warehouse nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = '
        select 
            g.*, 
            b.BillNo as MoveWarehouseBillNo, 
            b.CustomerId, 
            b.CustomerName, 
            b.Warehouse, 
            b.ConsignedDeliveryNo, 
            b.CreateTime,
            e.BillNo as EnterWarehouseBillNo 
        from 
            MoveWarehouseBillGoods g join 
            MoveWarehouseBill b on g.MoveWarehouseBillId = b.Id left join 
            EnterWarehouseBill e on g.EnterWarehouseBillId = e.Id '
            
    set @WhereSql = ''

    if @StartTime is not null and @StartTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),b.CreateTime,120) >= ''' + @StartTime + ''')'
    end

    if @EndTime is not null and @EndTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),b.CreateTime,120) <= ''' + @EndTime + ''')'
    end

    if @CustomerName is not null and @CustomerName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.CustomerName like ''%' + @CustomerName + '%'')'
    end
    
    if @MoveWarehouseBillNo is not null and @MoveWarehouseBillNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.BillNo like ''%' + @MoveWarehouseBillNo + '%'')'
    end
    
    if @GoodsNo is not null and @GoodsNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(g.GoodsNo like ''%' + @GoodsNo + '%'')'
    end

    if @Warehouse is not null and @Warehouse <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.Warehouse = ''' + @Warehouse + ''')'
    end
    
    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    set @SelectSql = @SelectSql + ' order by b.CreateTime '
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150469,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150470)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'MoveWarehouseBillNo=' + @MoveWarehouseBillNo + N',' +
                       N'GoodsNo=' + @GoodsNo + N',' +
                       N'Warehouse=' + @Warehouse 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @StaffId
 * @StartDate
 * @EndDate
 * @OpStaffId
 * @OpStaffName
 * @PageSize
 * @StartIndex
 *
*******************************************************************************************/
create procedure LoadOpLogs
@StaffId bigint,
@StartDate datetime,
@EndDate datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

    select 
        * 
    from 
        OpLog 
    where 
        (StaffId = @StaffId) and 
        (OpTime between @StartDate and @EndDate)
    order by 
        OpTime 

    /**/
    select @OpName = formatmessage(150018)
    select @OpParams = N'StaffId=' + convert(nvarchar,@StaffId) + N',' +
                       N'StartDate=' + convert(nvarchar,@StartDate,120) + N',' +
                       N'EndDate=' + convert(nvarchar,@EndDate,120)
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end

    return 0
end
go


create procedure LoadOrganTotalOutputDetailsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@OrganId nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @CustomerId bigint
declare @ShipmentNo nvarchar(20)
declare @DeliverBillCreateTime nvarchar(10)
declare @StartCountry nvarchar(20)
declare @StartProvince nvarchar(20)
declare @StartCity nvarchar(20)
declare @DestCountry nvarchar(20)
declare @DestProvince nvarchar(20)
declare @DestCity nvarchar(20)
declare @TotalTunnages numeric(25,9)
declare @TotalPiles numeric(25,9)
declare @ValuationMode nvarchar(20)
declare @GrossWeightRate numeric(25,9)
declare @PlanType nvarchar(10)
declare @IsInstalment bit
declare @DeliverPlanCreateTime nvarchar(10)
declare @CustomerTransportPrice numeric(25,9)
declare @CustomerRiverCrossingCharges numeric(25,9)
declare @CarType nvarchar(10)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    create table #LoadOrganTotalOutputDetailsByConditions 
    (
	    Id bigint,
	    ShipmentNo nvarchar(20),
        DeliveryNo nvarchar(20),
        ReceiverCountry nvarchar(20),
        ReceiverProvince nvarchar(20),
        ReceiverCity nvarchar(20),
        ReceiverAddress nvarchar(50),
        KM nvarchar(50),
        CarrierBusinessType nvarchar(10),
        TotalPackages int,
        TotalTunnages numeric(25,9),
        TotalPiles numeric(25,9),
        TotalTenThousands numeric(25,9),
        CustomerTransportPrice numeric(25,9),
        CustomerTransportCharges numeric(25,9),
        CustomerRiverCrossingCharges numeric(25,9),
        CustomerSettlementExpression nvarchar(100),
        CarrierTransportCharges numeric(25,9),
        OwnOrganId bigint,
        OwnOrganName nvarchar(50),
        CreateTime nvarchar(10),
        PlanType nvarchar(10),
        CustomerId bigint,
        StartCountry nvarchar(20),
        StartProvince nvarchar(20),
        StartCity nvarchar(20),
        IsInstalment bit,
        DeliverPlanCreateTime nvarchar(10),
        ValuationMode nvarchar(20),
        GrossWeightRate numeric(25,9),
        CarType nvarchar(10)
    )
    
    /**/
    if @OrganId is null or @OrganId = ''
    begin
        insert into #LoadOrganTotalOutputDetailsByConditions 
            (
	            Id,
	            ShipmentNo,
                DeliveryNo,
                ReceiverCountry,
                ReceiverProvince,
                ReceiverCity,
                ReceiverAddress,
                KM,
                CarrierBusinessType,
                TotalPackages,
                TotalTunnages,
                TotalPiles,
                TotalTenThousands,
                CustomerTransportPrice,
                CustomerTransportCharges,
                CustomerRiverCrossingCharges,
                CustomerSettlementExpression,
                CarrierTransportCharges,
                OwnOrganId,
                OwnOrganName,
                CreateTime,
                PlanType,
                CustomerId,
                StartCountry,
                StartProvince,
                StartCity,
                IsInstalment,
                DeliverPlanCreateTime,
                ValuationMode,
                GrossWeightRate,
                CarType
            )
        select 
            r1.Id,
            r1.ShipmentNo,
            r1.DeliveryNo,
            r1.ReceiverCountry,
            r1.ReceiverProvince,
            r1.ReceiverCity,
            r1.ReceiverAddress,
            r1.KM,
            r1.CarrierBusinessType,
            r1.TotalPackages,
            r1.TotalTunnages,
            r1.TotalPiles,
            r1.TotalTenThousands,
            isnull(dbctp.TransportPrice,0.0),
            isnull(dbctp.TransportCharges,0.0),
            0.0,
            cu.SettlementExpression,
            case when dbctp2.TransportCharges is null then r1.CarrierTransportCharges else dbctp2.TransportCharges end,
            r1.OwnOrganId,
            r1.OwnOrganName,
            r1.CreateTime,
            r1.PlanType,
            r1.CustomerId,
            r1.StartCountry,
            r1.StartProvince,
            r1.StartCity,
            r1.IsInstalment,
            r1.DeliverPlanCreateTime,
            cu.ValuationMode,
            cu.GrossWeightRate,
            r1.CarType
        from 
            (
	            select 
		            db.Id,
                    dp.ShipmentNo,
                    dp.DeliveryNo,
		            dp.StartCountry,
		            dp.StartProvince,
		            dp.StartCity,
		            db.ReceiverCountry,
		            db.ReceiverProvince,
		            db.ReceiverCity,
                    db.ReceiverAddress,
		            convert(nvarchar(10),db.CreateTime,120) as CreateTime,
                    dbdp.KM,
                    ca.BusinessType as CarrierBusinessType,
		            dg.TotalPackages,
		            dg.TotalTunnages,
		            dg.TotalPiles,
		            dg.TotalTenThousands,
                    dbdp.TransportCharges as CarrierTransportCharges,
                    dp.OwnOrganId,
                    dp.OwnOrganName,
		            dp.PayerId as CustomerId,
                    dp.ReceiveType,
			        dp.PlanType,
                    dp.IsInstalment,
                    convert(nvarchar(10),dp.CreateTime,120) as DeliverPlanCreateTime,
                    db2.CarType
	            from 
		            DeliverBill db join 
		            (
			            select 
				            DeliverBillId,
				            isnull(sum(Packages),0) as TotalPackages,
				            isnull(sum(Tunnages),0.0) as TotalTunnages,
				            isnull(sum(Piles),0.0) as TotalPiles,
				            isnull(sum(TenThousands),0.0) as TotalTenThousands
			            from 
				            DeliverBillGoods 
			            group by 
				            DeliverBillId 
		            ) as dg on db.Id = dg.DeliverBillId join 
		            (
			            select 
				            Id,
                            ShipmentNo,
                            DeliveryNo,
				            StartCountry,
				            StartProvince,
				            StartCity,
                            OwnOrganId,
                            OwnOrganName,
				            PayerId,
                            ReceiveType,
                            PlanType,
                            IsInstalment,
                            CreateTime 
			            from 
				            DeliverPlan 
		            ) as dp on db.PlanId = dp.Id join 
		            (
			            select 
                            DispatchBillId, 
                            PlanId, 
                            convert(nvarchar,KM) as KM,
                            TransportCharges 
                        from 
                            DispatchBillDeliverPlan 
		            ) as dbdp on db.DispatchBillId = dbdp.DispatchBillId and db.PlanId = dbdp.PlanId join
                    (
                        select 
                            Id,
                            CarType
                        from 
                            DispatchBill
                    ) as db2 on db.DispatchBillId = db2.Id join 
                    Carrier ca on db.CarrierId = ca.Id 
            ) as r1 join 
            Customer cu on r1.CustomerId = cu.Id left join 
            DeliverBillCustomerTransportPrice dbctp on r1.Id = dbctp.DeliverBillId left join
            DeliverBillCarrierTransportPrice dbctp2 on r1.Id = dbctp2.DeliverBillId 
        where 
            (r1.ReceiveType <> formatmessage(150347)) and
            (r1.CreateTime >= @StartTime) and 
            (r1.CreateTime <= @EndTime)
    end
    else
    begin
        insert into #LoadOrganTotalOutputDetailsByConditions 
            (
	            Id,
	            ShipmentNo,
                DeliveryNo,
                ReceiverCountry,
                ReceiverProvince,
                ReceiverCity,
                ReceiverAddress,
                KM,
                CarrierBusinessType,
                TotalPackages,
                TotalTunnages,
                TotalPiles,
                TotalTenThousands,
                CustomerTransportPrice,
                CustomerTransportCharges,
                CustomerRiverCrossingCharges,
                CustomerSettlementExpression,
                CarrierTransportCharges,
                OwnOrganId,
                OwnOrganName,
                CreateTime,
                PlanType,
                CustomerId,
                StartCountry,
                StartProvince,
                StartCity,
                IsInstalment,
                DeliverPlanCreateTime,
                ValuationMode,
                GrossWeightRate,
                CarType
            )
        select 
            r1.Id,
            r1.ShipmentNo,
            r1.DeliveryNo,
            r1.ReceiverCountry,
            r1.ReceiverProvince,
            r1.ReceiverCity,
            r1.ReceiverAddress,
            r1.KM,
            r1.CarrierBusinessType,
            r1.TotalPackages,
            r1.TotalTunnages,
            r1.TotalPiles,
            r1.TotalTenThousands,
            isnull(dbctp.TransportPrice,0.0),
            isnull(dbctp.TransportCharges,0.0),
            0.0,
            cu.SettlementExpression,
            case when dbctp2.TransportCharges is null then r1.CarrierTransportCharges else dbctp2.TransportCharges end,
            r1.OwnOrganId,
            r1.OwnOrganName,
            r1.CreateTime,
            r1.PlanType,
            r1.CustomerId,
            r1.StartCountry,
            r1.StartProvince,
            r1.StartCity,
            r1.IsInstalment,
            r1.DeliverPlanCreateTime,
            cu.ValuationMode,
            cu.GrossWeightRate,
            r1.CarType
        from 
            (
	            select 
		            db.Id,
                    dp.ShipmentNo,
                    dp.DeliveryNo,
		            dp.StartCountry,
		            dp.StartProvince,
		            dp.StartCity,
		            db.ReceiverCountry,
		            db.ReceiverProvince,
		            db.ReceiverCity,
                    db.ReceiverAddress,
		            convert(nvarchar(10),db.CreateTime,120) as CreateTime,
                    dbdp.KM,
                    ca.BusinessType as CarrierBusinessType,
		            dg.TotalPackages,
		            dg.TotalTunnages,
		            dg.TotalPiles,
		            dg.TotalTenThousands,
                    dbdp.TransportCharges as CarrierTransportCharges,
                    dp.OwnOrganId,
                    dp.OwnOrganName,
		            dp.PayerId as CustomerId,
                    dp.ReceiveType,
			        dp.PlanType,
                    dp.IsInstalment,
                    convert(nvarchar(10),dp.CreateTime,120) as DeliverPlanCreateTime,
                    db2.CarType
	            from 
		            DeliverBill db join 
		            (
			            select 
				            DeliverBillId,
				            isnull(sum(Packages),0) as TotalPackages,
				            isnull(sum(Tunnages),0.0) as TotalTunnages,
				            isnull(sum(Piles),0.0) as TotalPiles,
				            isnull(sum(TenThousands),0.0) as TotalTenThousands
			            from 
				            DeliverBillGoods 
			            group by 
				            DeliverBillId 
		            ) as dg on db.Id = dg.DeliverBillId join 
		            (
			            select 
				            Id,
                            ShipmentNo,
                            DeliveryNo,
				            StartCountry,
				            StartProvince,
				            StartCity,
                            OwnOrganId,
                            OwnOrganName,
				            PayerId,
                            ReceiveType,
                            PlanType,
                            IsInstalment,
                            CreateTime 
			            from 
				            DeliverPlan 
		            ) as dp on db.PlanId = dp.Id join 
		            (
			            select 
                            DispatchBillId, 
                            PlanId, 
                            convert(nvarchar,KM) as KM,
                            TransportCharges 
                        from 
                            DispatchBillDeliverPlan 
		            ) as dbdp on db.DispatchBillId = dbdp.DispatchBillId and db.PlanId = dbdp.PlanId join
                    (
                        select
                            Id,
                            CarType
                        from 
                            DispatchBill
                    ) as db2 on db.DispatchBillId = db2.Id join 
                    Carrier ca on db.CarrierId = ca.Id 
            ) as r1 join 
            Customer cu on r1.CustomerId = cu.Id left join 
            DeliverBillCustomerTransportPrice dbctp on r1.Id = dbctp.DeliverBillId left join
            DeliverBillCarrierTransportPrice dbctp2 on r1.Id = dbctp2.DeliverBillId 
        where 
            (r1.ReceiveType <> formatmessage(150347)) and
            (r1.CreateTime >= @StartTime) and 
            (r1.CreateTime <= @EndTime) and 
            (r1.OwnOrganId in (select Id from Organization where FullPath like (select FullPath + '%' from Organization where Id = cast(@OrganId as bigint))))
    end
    
    /**/
    declare Cursor1 cursor local for 
        select 
	        Id,
            CustomerId,
	        ShipmentNo,
            CreateTime,
            StartCountry,
            StartProvince,
            StartCity,
            ReceiverCountry,
            ReceiverProvince,
            ReceiverCity,
            TotalTunnages,
            TotalPiles,
            ValuationMode,
            GrossWeightRate,
            PlanType,
            IsInstalment,
            DeliverPlanCreateTime,
            CarType
        from 
            #LoadOrganTotalOutputDetailsByConditions 
        where 
            CustomerTransportPrice = 0
            
    open Cursor1
    fetch next from Cursor1 into 
        @Id, 
        @CustomerId, 
        @ShipmentNo, 
        @DeliverBillCreateTime, 
        @StartCountry, 
        @StartProvince, 
        @StartCity, 
        @DestCountry, 
        @DestProvince, 
        @DestCity, 
        @TotalTunnages, 
        @TotalPiles, 
        @ValuationMode, 
        @GrossWeightRate, 
        @PlanType, 
        @IsInstalment, 
        @DeliverPlanCreateTime,
        @CarType

    while @@fetch_status = 0
    begin
        set @CustomerTransportPrice = 0
        
        /**/
        if @PlanType = formatmessage(150257) or @PlanType = formatmessage(150619)
        begin
            select 
                @CustomerTransportPrice = TransportPrice,
                @CustomerRiverCrossingCharges = RiverCrossingCharges
            from 
                CustomerTransportPrice 
            where 
                CustomerId = @CustomerId and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @DestCountry and 
                DestProvince = @DestProvince and 
                DestCity = @DestCity and 
                @TotalPiles * @GrossWeightRate >= MinTunnagesOrPiles and 
                @TotalPiles * @GrossWeightRate < MaxTunnagesOrPiles and 
                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                (
                    CarType is not null and 
                    CarType <> '' and 
                    CarType = @CarType
                )
            if @@rowcount = 0
            begin
                select 
                    @CustomerTransportPrice = TransportPrice,
                    @CustomerRiverCrossingCharges = RiverCrossingCharges
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    @TotalPiles * @GrossWeightRate >= MinTunnagesOrPiles and 
                    @TotalPiles * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is null or 
                        CarType = ''
                    )
                if @@rowcount = 0
                begin
                    set @CustomerTransportPrice = 0
                    set @CustomerRiverCrossingCharges = 0
                end
            end
        end
        else
        begin
            /**/
            if @PlanType = formatmessage(150256) or @PlanType = formatmessage(150518)
            begin
                /**/
                if @ValuationMode = formatmessage(150520)
                begin
                    select 
                        @CustomerTransportPrice = TransportPrice,
                        @CustomerRiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    if @@rowcount = 0
                    begin
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @CustomerRiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is null or 
                                CarType = ''
                            )
                        if @@rowcount = 0
                        begin
                            set @CustomerTransportPrice = 0
                            set @CustomerRiverCrossingCharges = 0
                        end
                    end
                end
                /**/
                else if @ValuationMode = formatmessage(150521)
                begin
                    /**/
                    select 
                        @TotalTunnages = isnull(sum(Tunnages),0.0) 
                    from 
                        DeliverBillGoods 
                    where 
                        DeliverBillId in 
                        (
                            select 
                                Id 
                            from 
                                DeliverBill 
                            where 
                                PlanId in 
                                (
                                    select 
                                        Id 
                                    from 
                                        DeliverPlan
                                    where 
                                        ShipmentNo = @ShipmentNo 
                                ) 
                        )
                    
                    if @TotalTunnages is null 
                    begin
                        set @TotalTunnages = 0
                    end
            
                    /**/
                    select 
                        @CustomerTransportPrice = TransportPrice,
                        @CustomerRiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                        @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is not null and 
                            CarType <> '' and 
                            CarType = @CarType
                        )
                    if @@rowcount = 0
                    begin
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @CustomerRiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is null or 
                                CarType = ''
                            )
                        if @@rowcount = 0
                        begin
                            set @CustomerTransportPrice = 0
                            set @CustomerRiverCrossingCharges = 0
                        end
                    end
                end
                /**/
                else
                begin
                    /**/
                    if @IsInstalment is null or @IsInstalment = 0
                    begin
                        /**/
                        select 
                            @TotalTunnages = isnull(sum(Tunnages),0.0) 
                        from 
                            DeliverBillGoods  
                        where 
                            DeliverBillId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverBill 
                                where 
                                    PlanId in 
                                    (
                                        select 
                                            Id 
                                        from 
                                            DeliverPlan 
                                        where 
                                            convert(nvarchar(10), CreateTime, 120) = @DeliverPlanCreateTime and 
                                            ReceiverCountry = @DestCountry and 
                                            ReceiverProvince = @DestProvince and 
                                            ReceiverCity = @DestCity
                                    ) 
                            )
                        
                        if @TotalTunnages is null 
                        begin
                            set @TotalTunnages = 0
                        end
            
                        /**/
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @CustomerRiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is not null and 
                                CarType <> '' and 
                                CarType = @CarType
                            )
                        if @@rowcount = 0
                        begin
                            select 
                                @CustomerTransportPrice = TransportPrice,
                                @CustomerRiverCrossingCharges = RiverCrossingCharges
                            from 
                                CustomerTransportPrice 
                            where 
                                CustomerId = @CustomerId and 
                                StartCountry = @StartCountry and 
                                StartProvince = @StartProvince and 
                                StartCity = @StartCity and 
                                DestCountry = @DestCountry and 
                                DestProvince = @DestProvince and 
                                DestCity = @DestCity and 
                                @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                                @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                                (
                                    CarType is null or
                                    CarType = ''
                                )
                            if @@rowcount = 0
                            begin
                                set @CustomerTransportPrice = 0
                                set @CustomerTransportPrice = 0
                            end
                        end
                    end
                    /**/
                    else
                    begin
                        /**/
                        select 
                            @TotalTunnages = isnull(sum(Tunnages),0.0) 
                        from 
                            DeliverBillGoods  
                        where 
                            DeliverBillId in 
                            (
                                select 
                                    Id 
                                from 
                                    DeliverBill 
                                where 
                                    PlanId in 
                                    (
                                        select 
                                            Id 
                                        from 
                                            DeliverPlan 
                                        where 
                                            convert(nvarchar(10), CreateTime, 120) = @DeliverBillCreateTime and 
                                            ReceiverCountry = @DestCountry and 
                                            ReceiverProvince = @DestProvince and 
                                            ReceiverCity = @DestCity
                                    ) 
                            )
                        
                        if @TotalTunnages is null 
                        begin
                            set @TotalTunnages = 0
                        end
            
                        /*4.3.2.2.*/
                        select 
                            @CustomerTransportPrice = TransportPrice,
                            @CustomerRiverCrossingCharges = RiverCrossingCharges
                        from 
                            CustomerTransportPrice 
                        where 
                            CustomerId = @CustomerId and 
                            StartCountry = @StartCountry and 
                            StartProvince = @StartProvince and 
                            StartCity = @StartCity and 
                            DestCountry = @DestCountry and 
                            DestProvince = @DestProvince and 
                            DestCity = @DestCity and 
                            @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                            @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                            @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                            @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                            (
                                CarType is not null and 
                                CarType <> '' and 
                                CarType = @CarType
                            )
                        if @@rowcount = 0
                        begin
                            select 
                                @CustomerTransportPrice = TransportPrice,
                                @CustomerRiverCrossingCharges = RiverCrossingCharges
                            from 
                                CustomerTransportPrice 
                            where 
                                CustomerId = @CustomerId and 
                                StartCountry = @StartCountry and 
                                StartProvince = @StartProvince and 
                                StartCity = @StartCity and 
                                DestCountry = @DestCountry and 
                                DestProvince = @DestProvince and 
                                DestCity = @DestCity and 
                                @TotalTunnages * @GrossWeightRate >= MinTunnagesOrPiles and 
                                @TotalTunnages * @GrossWeightRate < MaxTunnagesOrPiles and 
                                @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                                @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                                (
                                    CarType is null or 
                                    CarType = ''
                                )
                            if @@rowcount = 0
                            begin
                                set @CustomerTransportPrice = 0
                                set @CustomerRiverCrossingCharges = 0
                            end
                        end
                    end
                end
            end
            /**/
            else
            begin
                select 
                    @CustomerTransportPrice = TransportPrice,
                    @CustomerRiverCrossingCharges = RiverCrossingCharges
                from 
                    CustomerTransportPrice 
                where 
                    CustomerId = @CustomerId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @DestCountry and 
                    DestProvince = @DestProvince and 
                    DestCity = @DestCity and 
                    abs(@TotalTunnages) * @GrossWeightRate >= MinTunnagesOrPiles and 
                    abs(@TotalTunnages) * @GrossWeightRate < MaxTunnagesOrPiles and 
                    @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                    @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                    (
                        CarType is not null and 
                        CarType <> '' and 
                        CarType = @CarType
                    )
                if @@rowcount = 0
                begin
                    select 
                        @CustomerTransportPrice = TransportPrice,
                        @CustomerRiverCrossingCharges = RiverCrossingCharges
                    from 
                        CustomerTransportPrice 
                    where 
                        CustomerId = @CustomerId and 
                        StartCountry = @StartCountry and 
                        StartProvince = @StartProvince and 
                        StartCity = @StartCity and 
                        DestCountry = @DestCountry and 
                        DestProvince = @DestProvince and 
                        DestCity = @DestCity and 
                        abs(@TotalTunnages) * @GrossWeightRate >= MinTunnagesOrPiles and 
                        abs(@TotalTunnages) * @GrossWeightRate < MaxTunnagesOrPiles and 
                        @DeliverPlanCreateTime >= convert(nvarchar(10),StartTime,120) and 
                        @DeliverPlanCreateTime <= convert(nvarchar(10),EndTime,120) and 
                        (
                            CarType is null or
                            CarType = ''
                        )
                    if @@rowcount = 0
                    begin
                        set @CustomerTransportPrice = 0
                        set @CustomerRiverCrossingCharges = 0
                    end
                end
            end
        end
        
        /**/
        if @CustomerTransportPrice is null
        begin
            set @CustomerTransportPrice = 0
        end
        
        if @CustomerRiverCrossingCharges is null
        begin
            set @CustomerRiverCrossingCharges = 0
        end
        
        update #LoadOrganTotalOutputDetailsByConditions set 
            CustomerTransportPrice = @CustomerTransportPrice, 
            CustomerRiverCrossingCharges = @CustomerRiverCrossingCharges 
        where 
            Id = @Id 
    
        fetch next from Cursor1 into 
            @Id, 
            @CustomerId, 
            @ShipmentNo, 
            @DeliverBillCreateTime, 
            @StartCountry, 
            @StartProvince, 
            @StartCity, 
            @DestCountry, 
            @DestProvince, 
            @DestCity, 
            @TotalTunnages, 
            @TotalPiles, 
            @ValuationMode, 
            @GrossWeightRate, 
            @PlanType, 
            @IsInstalment, 
            @DeliverPlanCreateTime,
            @CarType
    end 
        
    close Cursor1
    deallocate Cursor1 
    
    /**/
    select * from #LoadOrganTotalOutputDetailsByConditions
    
    
    /**/
    select @OpName = formatmessage(150505)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'OrganId=' + @OrganId 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 *******************************************************************************************/
create procedure LoadOrganization 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
		a.*,
		b.Id as ManagerId, 
        (case when b.FamilyName is null then N'' else b.FamilyName end + b.Name) as ManagerName 
	from 
		Organization a left outer join Staff b on b.OrganId = a.Id and b.IsOrganLeader = 1 
	where 
		a.Id = @Id
    
    if @@rowcount = 0
    begin
        raiserror (150055,18,1)
        return -1
    end

    /**/
    select @OpName = formatmessage(150056)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadOrganizations
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

    select 
		a.*,
		b.Id as ManagerId, 
        (case when b.FamilyName is null then N'' else b.FamilyName end + b.Name) as ManagerName,
        c.Name as ParentName 
	from 
		Organization a left join 
        Staff b on b.OrganId = a.Id and b.IsOrganLeader = 1 left join 
        Organization c on a.ParentId = c.Id 
    

	/**/
	select @OpName = formatmessage(150020)
    select @OpParams = N''
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadOutWarehouseBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        o.*, 
        c.LoadingForceFeePrice,
        p.PlanNo 
    from 
        OutWarehouseBill o left join 
        CustomerForceFeePrice c on o.CustomerId = c.CustomerId and convert(nvarchar(10),o.CreateTime,120) >= convert(nvarchar(10),c.StartTime,120) and convert(nvarchar(10),o.CreateTime,120) <= convert(nvarchar(10),c.EndTime,120) left join 
        DeliverPlan p on o.PlanId = p.Id 
    where 
        o.Id = @Id 
        
    if @@rowcount = 0
    begin
        raiserror (150395,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150396)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadOutWarehouseBillAllGoods 
@OutWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        g.*, 
        b.BillNo as EnterWarehouseBillNo 
    from 
        OutWarehouseBillGoods g left join EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id 
    where 
        g.OutWarehouseBillId = @OutWarehouseBillId 
    
    /**/
    select @OpName = formatmessage(150397)
    select @OpParams = N'OutWarehouseBillId=' + convert(nvarchar,@OutWarehouseBillId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadOutWarehouseBillByShipmentBillId 
@ShipmentBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from OutWarehouseBill where ShipmentBillId = @ShipmentBillId
        
   
    /**/
    select @OpName = formatmessage(150566)
    select @OpParams = N'ShipmentBillId=' + convert(nvarchar,@ShipmentBillId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadOutWarehouseBillGoodsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@CustomerName nvarchar(50),
@DeliveryNo nvarchar(50),
@OutWarehouseBillNo nvarchar(50),
@GoodsNo nvarchar(50),
@BatchNo nvarchar(50),
@CarNo nvarchar(50),
@ReceiverName nvarchar(100),
@OutType nvarchar(50),
@Warehouse nvarchar(50),
@ReceiveType nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = '
        select 
            g.*, 
            b.BillNo as OutWarehouseBillNo, 
            b.CarNo,
            b.CustomerId, 
            b.CustomerName, 
            b.DeliveryNo, 
            b.ReceiverName,
            b.ReceiverCountry,
            b.ReceiverProvince,
            b.ReceiverCity,
            b.ReceiverAddress,
            b.Warehouse, 
            b.CreateTime,
            e.BillNo as EnterWarehouseBillNo 
        from 
            OutWarehouseBillGoods g join 
            OutWarehouseBill b on g.OutWarehouseBillId = b.Id left join 
            EnterWarehouseBill e on g.EnterWarehouseBillId = e.Id '
            
    set @WhereSql = ''

    if @StartTime is not null and @StartTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),b.CreateTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(convert(nvarchar(10),b.CreateTime,120) <= ''' + @EndTime + ''')'
    end

    if @CustomerName is not null and @CustomerName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.CustomerName like ''%' + @CustomerName + '%'')'
    end
    
    if @DeliveryNo is not null and @DeliveryNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.DeliveryNo like ''%' + @DeliveryNo + '%'')'
    end
    
    if @OutWarehouseBillNo is not null and @OutWarehouseBillNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.BillNo like ''%' + @OutWarehouseBillNo + '%'')'
    end
    
    if @GoodsNo is not null and @GoodsNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(g.GoodsNo like ''%' + @GoodsNo + '%'')'
    end
    
    if @BatchNo is not null and @BatchNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(g.BatchNo like ''%' + @BatchNo + '%'')'
    end

    if @CarNo is not null and @CarNo <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.CarNo like ''%' + @CarNo + '%'')'
    end

    if @ReceiverName is not null and @ReceiverName <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.ReceiverName like ''%' + @ReceiverName + '%'')'
    end

    if @OutType is not null and @OutType <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.OutType = ''' + @OutType + ''')'
    end

    if @Warehouse is not null and @Warehouse <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.Warehouse = ''' + @Warehouse + ''')'
    end
    
    if @ReceiveType is not null and @ReceiveType <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(b.ReceiveType = ''' + @ReceiveType + ''')'
    end
    
    
    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    set @SelectSql = @SelectSql + ' order by b.CreateTime '
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150461,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150462)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'OutWarehouseBillNo=' + @OutWarehouseBillNo + N',' +
                       N'GoodsNo=' + @GoodsNo + N',' +
                       N'BatchNo=' + @BatchNo + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'ReceiverName=' + @ReceiverName + N',' +
                       N'OutType=' + @OutType + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'ReceiveType=' + @ReceiveType 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadOutWarehouseBillsByPlanId 
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select * from OutWarehouseBill where PlanId = @PlanId 
    
    /**/
    select @OpName = formatmessage(150690)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadPendingCount 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @AccountType nvarchar(20)
declare @OrganId bigint
declare @StaffId bigint
declare @OrganFullPath nvarchar(500)
declare @SubmitDeliverPlansCount int
declare @CustomerApprovePaperPlansCount int
declare @ApproveDeliverPlansCount int
declare @DispatchDeliverPlansCount int
declare @SubmitDispatchBillsCount int
declare @DispatchBillsForPrintDispatchedShipmentBillCount int
declare @PrintAllocateShipmentBillsCount int
declare @SubmitShipmentBillsCount int
declare @PrintDeliverBillsCount int
declare @ReceiptDeliverBillsCount int
declare @NewContractsCount int
declare @SubmitContractsCount int
declare @PrintContractsCount int
declare @ApproveContractsCount int
declare @ReverseContractsCount int
declare @FineContractsCount int
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    select @AccountType = AccountType, @OrganId = OrganId, @StaffId = StaffId from Account where Id = @OpStaffId and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150005,18,1)
        return -1
    end
    
    select @OrganFullPath = FullPath from Organization where Id = @OrganId
    if @@rowcount = 0
    begin
        raiserror (150145,18,1)
        return -2
    end

    /*1.*/
    select 
        @SubmitDeliverPlansCount = count(*) 
    from 
        DeliverPlan 
    where 
        CreatorId = @OpStaffId and 
        PlanState = formatmessage(150241)
    
    
    /*2.*/
    if @AccountType = formatmessage(150163)
    begin
        select @CustomerApprovePaperPlansCount = count(*) from DeliverPlan where CreatorId in (select Id from Account where OrganId = @OrganId) and PlanState = formatmessage(150296)
    end
    else
    begin
        select @CustomerApprovePaperPlansCount = 0 
    end
    
    /*3.*/
    select @ApproveDeliverPlansCount = count(*) from DeliverPlan where DisposerId in (select StaffId from Account where Id = @OpStaffId) and PlanState = formatmessage(150283)

    /*4.*/
    select 
        @DispatchDeliverPlansCount = count(*)
    from 
        DeliverPlan
    where 
        (PlanState = formatmessage(150242)) and
        (DeliverType = formatmessage(150305)) and
        (
            Id in 
            (
                select 
                    dpg2.PlanId 
                from 
                    DeliverPlanGoods dpg2 left join 
                    (
                        select 
                            PlanId,
                            GoodsId,
                            BatchNo,
                            Packing,
                            Location,
                            ProductionDate,
                            EnterWarehouseBillId,
                            isnull(sum(Packages), 0) as DispatchPackages,
                            isnull(sum(Tunnages), 0) as DispatchTunnages,
                            isnull(sum(Piles), 0.0) as DispatchPiles 
                        from 
                            DispatchBillGoods 
                        where 
							PlanId in (select Id from DeliverPlan where PlanState=N'')
                        group by 
                            PlanId,
                            GoodsId,
                            BatchNo,
                            Packing,
                            Location,
                            ProductionDate,
                            EnterWarehouseBillId
                    ) as dbpg2 on dpg2.PlanId = dbpg2.PlanId and dpg2.GoodsId = dbpg2.GoodsId and dpg2.BatchNo = dbpg2.BatchNo and dpg2.Packing = dbpg2.Packing and dpg2.Location = dbpg2.Location and dpg2.ProductionDate = dbpg2.ProductionDate and dpg2.EnterWarehouseBillId = dbpg2.EnterWarehouseBillId 
                where 
                    dpg2.Packages - isnull(dbpg2.DispatchPackages, 0) <> 0 or 
                    dpg2.Tunnages - isnull(dbpg2.DispatchTunnages, 0) <> 0 or 
                    dpg2.Piles - isnull(dbpg2.DispatchPiles, 0.0) <> 0 
                group by 
                    dpg2.PlanId
            )
        )
    
    /*5.*/
    if @AccountType = formatmessage(150162)
    begin
        select 
            @SubmitDispatchBillsCount = count(*) 
        from 
            DispatchBill 
        where 
            CreatorId in (select Id from Account where AccountType=formatmessage(150162) and StaffId in (select StaffId from Staff where OrganFullPath like @OrganFullPath + '%')) and 
            BillState = formatmessage(150241)
    end
    else
    begin
        select @SubmitDispatchBillsCount = 0
    end
    
    /*6.*/
    if @AccountType = formatmessage(150162)
    begin
        select 
            @DispatchBillsForPrintDispatchedShipmentBillCount = count(*)
        from 
            ShipmentBill
        where 
            OwnOrganId = @OrganId and 
            OutType = formatmessage(150305) and
            BillState = formatmessage(150241) and
            PrintState = 0 
    end
    else
    begin
        select @DispatchBillsForPrintDispatchedShipmentBillCount  = 0
    end
    
    /*7.*/
    if @AccountType = formatmessage(150162)
    begin
        select 
            @PrintAllocateShipmentBillsCount = count(*)
        from 
            ShipmentBill
        where 
            OwnOrganId = @OrganId and 
            OutType = formatmessage(150306) and
            BillState = formatmessage(150241) and
            PrintState = 0 
    end
    else
    begin
        select @PrintAllocateShipmentBillsCount = 0
    end
    
    /*8.*/
    if @AccountType = formatmessage(150162)
    begin
        select 
            @SubmitShipmentBillsCount = count(*)
        from 
            ShipmentBill 
        where 
            OwnOrganId = @OrganId and 
            BillState = formatmessage(150241) and
            PrintState = 1 
    end
    else
    begin
        select @SubmitShipmentBillsCount = 0
    end

    /*9.*/
    if @AccountType = formatmessage(150162)
    begin
        select 
            @PrintDeliverBillsCount = count(*)
        from 
            DeliverBill 
        where 
            OwnOrganId = @OrganId and 
            DispatchBillId not in (select distinct DispatchBillId from ShipmentBill where BillState = formatmessage(150241)) and
            PrintState = 0 
    end
    else
    begin
        select @PrintDeliverBillsCount = 0
    end
    
    /*10.*/
    select 
        @ReceiptDeliverBillsCount = count(*)
    from 
        DeliverBill 
    where 
        PlanId in (select Id from DeliverPlan where ReceiveType = formatmessage(150348)) and
        PrintState = 1 and 
        ReturnTime is null
    
    /*11.*/
    if @AccountType = formatmessage(150162)
    begin
        select 
            @NewContractsCount = count(*) 
        from 
            DispatchBill 
        where 
            BillState = formatmessage(150242) and
            Id not in (select DispatchBillId from ShipmentBill where BillState = formatmessage(150241)) and
            Id not in (select DispatchBillId from DeliverBill where PrintState = 0) and 
            Id not in (select DispatchBillId from Contract where IsPrestowage = 1) and 
            Id in (select DispatchBillId from DispatchBillDeliverPlan where PlanId in (select Id from DeliverPlan where ReceiveType = formatmessage(150348))) and
            CarrierId not in (select Id from Carrier where PaymentType = formatmessage(150238))
    end
    else
    begin
        select @NewContractsCount = 0
    end
    
    /*12.*/
    if @AccountType = formatmessage(150162)
    begin
        select 
            @SubmitContractsCount = count(*) 
        from 
            Contract 
        where 
            CreatorId = @OpStaffId and 
            ContractState = formatmessage(150241) and 
			IsPrestowage = 1
    end
    else
    begin
        select @SubmitContractsCount = 0
    end

    /*13.*/
    if @AccountType = formatmessage(150162)
    begin
        select 
            @PrintContractsCount = count(*) 
        from 
            Contract 
        where 
            CreatorId = @OpStaffId and 
            ContractState = formatmessage(150242) and
            PrintState = 0 and 
			IsPrestowage = 1
    end
    else
    begin
        select @PrintContractsCount = 0
    end
    
    /*14.*/
    if @AccountType = formatmessage(150162)
    begin
        select 
            @ApproveContractsCount = count(*) 
        from 
            Contract 
        where 
            ApproverId = @StaffId and 
            ApproveState = formatmessage(150283) and
            ContractState = formatmessage(150242) and
            PrintState = 1
    end
    else
    begin
        select @ApproveContractsCount = 0
    end
    
    /*15.*/
    select 
        @ReverseContractsCount = count(*)
    from 
        (
            select 
                c.TotalTransportCharges, 
                isnull(r.ReverseAmount, 0.00) as ReverseAmount 
            from 
                Contract c left join 
                (
                    select 
                        ContractId, 
                        isnull(sum(ReverseAmount), 0.00) as ReverseAmount 
                    from 
                        ContractReverseDetail 
                    group by 
                        ContractId 
                ) as r on c.Id = r.ContractId 
            where 
                (c.ApproveState is null or c.ApproveState = formatmessage(150439)) and
                (c.ContractState = formatmessage(150242)) and
                (c.PrintState = 1) and 
				(c.IsPrestowage = 1)
        ) as r0 
    where 
        (abs(r0.ReverseAmount) < abs(r0.TotalTransportCharges)) 
    
    /*16.*/
    select 
        @FineContractsCount = count(*)
    from 
        Contract 
    where 
        (ContractState = formatmessage(150242)) and
        (PrintState = 1) and 
        (ApproveState = formatmessage(150439)) and
        (Id in (select ContractId from ContractDeliverPlan where abs(TransportCharges) > abs(ApprovedTransportCharges))) and 
        (FineAmount is null or FineAmount = 0)
    
    /**/
    select 
        @SubmitDeliverPlansCount as SubmitDeliverPlansCount,
        @CustomerApprovePaperPlansCount as CustomerApprovePaperPlansCount,
        @ApproveDeliverPlansCount as ApproveDeliverPlansCount,
        @DispatchDeliverPlansCount as DispatchDeliverPlansCount,
        @SubmitDispatchBillsCount as SubmitDispatchBillsCount,
        @DispatchBillsForPrintDispatchedShipmentBillCount as DispatchBillsForPrintDispatchedShipmentBillCount,
        @PrintAllocateShipmentBillsCount as PrintAllocateShipmentBillsCount,
        @SubmitShipmentBillsCount as SubmitShipmentBillsCount,
        @PrintDeliverBillsCount as PrintDeliverBillsCount,
        @ReceiptDeliverBillsCount as ReceiptDeliverBillsCount,
        @NewContractsCount as NewContractsCount,
        @SubmitContractsCount as SubmitContractsCount,
        @PrintContractsCount as PrintContractsCount,
        @ApproveContractsCount as ApproveContractsCount,
        @ReverseContractsCount as ReverseContractsCount,
        @FineContractsCount as FineContractsCount
        
    
    /**/
    select @OpName = formatmessage(150625)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadPermissionGroup
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from SysGroup where Id = @Id
    
    if @@rowcount = 0
    begin
        raiserror (150103,18,1)
        return -1
    end

	/**/
	select @OpName = formatmessage(150104)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end

    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadPermissionGroups
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from SysGroup order by Id

	/**/
	select @OpName = formatmessage(150007)
    select @OpParams = N'' 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end

    return 0
end
go



/********************************************************************************************
 * 
 *
*******************************************************************************************/
create procedure LoadPosition
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Position where Id = @Id
    
	if @@rowcount = 0
	begin
		raiserror (150023,18,1)
        return -1
    end

    /**/
    select @OpName = formatmessage(150024)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadPositions
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Position

	/**/
	select @OpName = formatmessage(150022)
    select @OpParams = N''
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadPrintAllocateShipmentBills 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @OwnOrganId = OrganId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end

    /**/
    select 
        sb.*,
        dp.PlanNo,
        isnull(sbg.TotalPackages,0) as TotalPackages,
        isnull(sbg.TotalTunnages,0.0) as TotalTunnages 
    from 
        ShipmentBill sb join 
        DeliverPlan dp on sb.PlanId = dp.Id left join 
        (
            select 
                ShipmentBillId,
                isnull(sum(Packages),0) as TotalPackages,
                isnull(sum(Tunnages),0.0) as TotalTunnages
            from 
                ShipmentBillGoods 
            group by 
                ShipmentBillId
        ) as sbg on sb.Id = sbg.ShipmentBillId 
    where 
        sb.OwnOrganId = @OwnOrganId and 
        sb.OutType = formatmessage(150306) and
        sb.BillState = formatmessage(150241) and
        sb.PrintState = 0 
        
    
    /**/
    select @OpName = formatmessage(150374)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadPrintContracts 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OrganId bigint
declare @StaffId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @OrganId = OrganId, @StaffId = StaffId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end

    /**/
    select 
        * 
    from 
        Contract 
    where 
        CreatorId = @OpStaffId and 
        ContractState = formatmessage(150242) and
        PrintState = 0 and 
		IsPrestowage = 1
    
    
    /**/
    select @OpName = formatmessage(150437)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadPrintDeliverBills 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @OwnOrganId = OrganId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end

    /**/
    select 
        db.*,
        dp.PlanType,
        dp.ReceiveType,
        dp.OrderNo,
        dp.Remark,
        isnull(dbg.TotalPackages,0) as TotalPackages,
        isnull(dbg.TotalTunnages,0.0) as TotalTunnages,
        isnull(dbg.TotalPiles,0.0) as TotalPiles,
        isnull(dbg.TotalTenThousands,0.0) as TotalTenThousands
    from 
        DeliverBill db join 
        DeliverPlan dp on db.PlanId = dp.Id left join 
        (
            select 
                DeliverBillId,
                isnull(sum(Packages),0) as TotalPackages,
                isnull(sum(Tunnages),0.0) as TotalTunnages,
                isnull(sum(Piles),0.0) as TotalPiles,
                isnull(sum(TenThousands),0.0) as TotalTenThousands
            from 
                DeliverBillGoods 
            group by 
                DeliverBillId
        ) as dbg on db.Id = dbg.DeliverBillId 
    where 
        db.DispatchBillId not in (select distinct DispatchBillId from ShipmentBill where BillState = formatmessage(150241)) and
        db.OwnOrganId = @OwnOrganId and 
        db.PrintState = 0 
        
    
    /**/
    select @OpName = formatmessage(150413)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadPrintDispatchedShipmentBills 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @OwnOrganId = OrganId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end

    /**/
    select 
        sb.*,
        dp.PlanNo,
        dp.ShipmentNo,
        db.DispatchBillNo,
        db.DriverName,
        db.DriverMobileTel,
        isnull(sbg.TotalPackages,0) as TotalPackages,
        isnull(sbg.TotalTunnages,0.0) as TotalTunnages,
        isnull(sbg.TotalPiles,0.0) as TotalPiles,
        isnull(sbg.TotalTenThousands,0.0) as TotalTenThousands
    from 
        ShipmentBill sb join 
        DeliverPlan dp on sb.PlanId = dp.Id join 
        DispatchBill db on sb.DispatchBillId = db.Id left join
        (
            select 
                ShipmentBillId,
                isnull(sum(Packages),0) as TotalPackages,
                isnull(sum(Tunnages),0.0) as TotalTunnages,
                isnull(sum(Piles),0.0) as TotalPiles,
                isnull(sum(TenThousands),0.0) as TotalTenThousands
            from 
                ShipmentBillGoods 
            group by 
                ShipmentBillId
        ) as sbg on sb.Id = sbg.ShipmentBillId 
    where 
        sb.OwnOrganId = @OwnOrganId and 
        sb.OutType = formatmessage(150305) and
        sb.BillState = formatmessage(150241) and
        sb.PrintState = 0 
        
    
    /**/
    select @OpName = formatmessage(150374)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
*******************************************************************************************/
create procedure LoadProvince
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Province where Id = @Id
	if @@rowcount = 0
	begin
		raiserror (150035,18,1)
        return -1
    end

    /**/
    select @OpName = formatmessage(150036)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
*******************************************************************************************/
create procedure LoadProvinces
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Province order by CountryName,Name

	/**/
	select @OpName = formatmessage(150034)
    select @OpParams = N'' 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @CountryName
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure LoadProvincesByCountry 
@CountryName nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Province where CountryName = @CountryName order by Name 
    

    /**/
    select @OpName = formatmessage(150089)
    select @OpParams = N'CountryName=' + @CountryName  
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadReceiptDeliverBillsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@CustomerName nvarchar(50),
@CarNo nvarchar(50),
@DeliveryNo nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    set @Sql = N'
        select 
            db.*,
            isnull(dbg.TotalPackages,0) as TotalPackages,
            isnull(dbg.TotalTunnages,0.0) as TotalTunnages,
            isnull(dbg.TotalPiles,0.0) as TotalPiles,
            isnull(dbg.TotalTenThousands,0.0) as TotalTenThousands 
        from 
            DeliverBill db left join 
            (
                select 
                    DeliverBillId,
                    isnull(sum(Packages),0) as TotalPackages,
                    isnull(sum(Tunnages),0.0) as TotalTunnages,
                    isnull(sum(Piles),0.0) as TotalPiles,
                    isnull(sum(TenThousands),0.0) as TotalTenThousands 
                from 
                    DeliverBillGoods 
                group by 
                    DeliverBillId
            ) as dbg on db.Id = dbg.DeliverBillId 
        where 
            db.PlanId in (select Id from DeliverPlan where ReceiveType = ''' + formatmessage(150348) + ''') and
            db.PrintState = 1 and 
            db.ReturnTime is null'
        
    if @StartTime is not null and @StartTime <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + 'convert(nvarchar(10),db.CreateTime,120) >= ''' + @StartTime + ''''
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + 'convert(nvarchar(10),db.CreateTime,120) <= ''' + @EndTime + ''''
    end
    
    if @CustomerName is not null and @CustomerName <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + 'db.CustomerName = ''' + @CustomerName + ''''
    end
    
    if @CarNo is not null and @CarNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + 'db.CarNo = ''' + @CarNo + ''''
    end

    if @DeliveryNo is not null and @DeliveryNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + 'db.DeliveryNo = ''' + @DeliveryNo + ''''
    end

    exec (@Sql)
    
    if @@error <> 0
    begin
        raiserror (150628,18,1)
        return -1
    end

    
    /**/
    select @OpName = formatmessage(150430)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'DeliveryNo=' + @DeliveryNo
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadReceiver 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Receiver where Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150597,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150598)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadReceiverByName 
@Name nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Receiver where Name = @Name
    
    /**/
    select @OpName = formatmessage(150232)
    select @OpParams = N'Name=' + @Name 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadReceiverDistance 
@ReceiverName nvarchar(50),
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select 
        * 
    from 
        ReceiverDistance 
    where 
        ReceiverName = @ReceiverName and 
        StartCountry = @StartCountry and 
        StartProvince = @StartProvince and 
        StartCity = @StartCity 
        
    /**/
    select @OpName = formatmessage(150333)
    select @OpParams = N'ReceiverName=' + @ReceiverName + N',' +
                       N'StartCountry=' + @StartCountry + N',' +
                       N'StartProvince=' + @StartProvince + N',' +
                       N'StartCity=' + @StartCity 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadReceiverDistances 
@ReceiverId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select rd.* from ReceiverDistance rd join Receiver r on rd.ReceiverName = r.Name where r.Id = @ReceiverId 
    
    
    /**/
    select @OpName = formatmessage(150592)
    select @OpParams = N'ReceiverId=' + convert(nvarchar,@ReceiverId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadReceiverNamesByName 
@Name nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select Name from Receiver where Name like ('%' + @Name + '%')
    
    /**/
    select @OpName = formatmessage(150534)
    select @OpParams = N'Name=' + @Name 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadReceivers 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Receiver 
    
    /**/
    select @OpName = formatmessage(150229)
    select @OpParams = N''
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadReverseContractsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@ContractNo nvarchar(50),
@OriginalContractNo nvarchar(50),
@CarrierName nvarchar(50),
@CarNo nvarchar(50),
@OrganId nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @ContractId bigint
declare @DispatchBillId bigint
declare @PlanId bigint
declare @TransportCharges numeric(25,9)
declare @ApprovedTransportCharges numeric(25,9)
declare @DeliverBillCarrierTransportCharges numeric(25,9)
declare @TotalTransportCharges numeric(25,9)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    create table #LoadReverseContractsByConditions 
    (
	    Id bigint,
        DispatchBillId bigint,
        ContractNo nvarchar(20),
        OriginalContractNo nvarchar(20),
        GoodsName nvarchar(500),
        StartPlace nvarchar(20),
        DestPlace nvarchar(200),
        ShipmentTime datetime,
        CarNo nvarchar(20),
        TrailerNo nvarchar(10),
        DriverName nvarchar(20),
        DriverMobileTel nvarchar(20),
        TotalTunnages numeric(25,9),
        TotalPiles numeric(25,9),
        TotalTransportCharges numeric(25,9),
        PrepayTransportCharges numeric(25,9),
        ResidualTransportCharges numeric(25,9),
        ReverseAmount numeric(25,9)
    )
    
    /**/
    set @Sql = '
        insert into #LoadReverseContractsByConditions 
            (
	            Id,
                DispatchBillId,
                ContractNo,
                OriginalContractNo,
                GoodsName,
                StartPlace,
                DestPlace,
                ShipmentTime,
                CarNo,
                TrailerNo,
                DriverName,
                DriverMobileTel,
                TotalTunnages,
                TotalPiles,
                TotalTransportCharges,
                PrepayTransportCharges,
                ResidualTransportCharges,
                ReverseAmount
            )
        select 
            r0.Id,
            r0.DispatchBillId,
            r0.ContractNo,
            r0.OriginalContractNo,
            r0.GoodsName,
            r0.StartPlace,
            r0.DestPlace,
            r0.ShipmentTime,
            r0.CarNo,
            r0.TrailerNo,
            r0.DriverName,
            r0.DriverMobileTel,
            r0.TotalTunnages,
            r0.TotalPiles,
            r0.TotalTransportCharges,
            r0.PrepayTransportCharges,
            r0.ResidualTransportCharges,
            r0.ReverseAmount
        from 
            (
                select 
                    c.*, 
                    isnull(r.ReverseAmount, 0.00) as ReverseAmount 
                from 
                    Contract c left join 
                    (
                        select 
                            ContractId, 
                            isnull(sum(ReverseAmount), 0.00) as ReverseAmount 
                        from 
                            ContractReverseDetail 
                        group by 
                            ContractId 
                    ) as r on c.Id = r.ContractId 
                where 
                    (c.ApproveState is null or c.ApproveState = ''' + formatmessage(150439) + ''') and c.ContractState = ''' + formatmessage(150242) + ''' and c.PrintState = 1 and c.IsPrestowage = 1) as r0 where (abs(r0.ReverseAmount) < abs(r0.TotalTransportCharges)) '
    
    if @StartTime is not null and @StartTime <> ''
    begin
        set @Sql = @Sql + ' and (convert(nvarchar(10),r0.ShipmentTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        set @Sql = @Sql + ' and (convert(nvarchar(10),r0.ShipmentTime,120) <= ''' + @EndTime + ''')'
    end
    
    if @ContractNo is not null and @ContractNo <> ''
    begin
        set @Sql = @Sql + ' and (r0.ContractNo = ''' + @ContractNo + ''')'
    end

    if @OriginalContractNo is not null and @OriginalContractNo <> ''
    begin
        set @Sql = @Sql + ' and (r0.OriginalContractNo = ''' + @OriginalContractNo + ''')'
    end
    
    if @CarrierName is not null and @CarrierName <> ''
    begin
        set @Sql = @Sql + ' and (r0.CarrierName like ''%' + @CarrierName + '%'')'
    end
    
    if @CarNo is not null and @CarNo <> ''
    begin
        set @Sql = @Sql + ' and (r0.CarNo = ''' + @CarNo + ''')'
    end

    if @OrganId is not null and @OrganId <> ''
    begin
        set @Sql = @Sql + ' and (r0.Id in (select ContractId from ContractDeliverPlan where PlanId in (select Id from DeliverPlan where OwnOrganId in (select Id from Organization where FullPath like (select FullPath + ''%'' from Organization where Id = ' + @OrganId + ')))))'
    end

    exec(@Sql)
    
    if @@error <> 0
    begin
        raiserror (150517,18,1)
        return -1
    end

    /**/
    declare Cursor1 cursor local for 
        select Id, DispatchBillId from #LoadReverseContractsByConditions 
            
    open Cursor1
    fetch next from Cursor1 into @ContractId, @DispatchBillId
    while @@fetch_status = 0
    begin
        if exists(select 1 from ContractDeliverPlan where ContractId = @ContractId)
        begin
            set @TotalTransportCharges = 0
    
            /**/
            declare Cursor2 cursor local for
                select PlanId, TransportCharges, ApprovedTransportCharges from ContractDeliverPlan where ContractId = @ContractId
            
            open Cursor2
            fetch next from Cursor2 into @PlanId, @TransportCharges, @ApprovedTransportCharges
            while @@fetch_status = 0
            begin
                select 
                    @DeliverBillCarrierTransportCharges = TransportCharges 
                from 
                    DeliverBillCarrierTransportPrice 
                where 
                    DeliverBillId in (select Id from DeliverBill where DispatchBillId = @DispatchBillId and PlanId = @PlanId)
                
                if @@rowcount = 0
                begin
                    set @DeliverBillCarrierTransportCharges = null
                end
            
                if @DeliverBillCarrierTransportCharges is not null
                begin
                    set @TotalTransportCharges = @TotalTransportCharges + @DeliverBillCarrierTransportCharges
                end
                else
                begin
                    if @ApprovedTransportCharges is not null
                    begin
                        set @TotalTransportCharges = @TotalTransportCharges + @ApprovedTransportCharges
                    end
                    else
                    begin
                        set @TotalTransportCharges = @TotalTransportCharges + @TransportCharges
                    end
                end
            
                fetch next from Cursor2 into @PlanId, @TransportCharges, @ApprovedTransportCharges
            end
        
            close Cursor2
            deallocate Cursor2
    
            /**/
            update #LoadReverseContractsByConditions set 
                TotalTransportCharges = @TotalTransportCharges,
                ResidualTransportCharges = @TotalTransportCharges - PrepayTransportCharges
            where 
                Id = @ContractId
        end

        fetch next from Cursor1 into @ContractId, @DispatchBillId
    end
    
    close Cursor1
    deallocate Cursor1 
    
    
    /**/
    select * from #LoadReverseContractsByConditions
    
    
    /**/
    select @OpName = formatmessage(150446)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' + 
                       N'ContractNo=' + @ContractNo + N',' + 
                       N'OriginalContractNo=' + @OriginalContractNo + N',' + 
                       N'CarrierName=' + @CarrierName + N',' + 
                       N'CarNo=' + @CarNo + N',' + 
                       N'OrganId=' + @OrganId 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadReverseContractsByContractIds 
@ContractIds nvarchar(max),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    set @Sql = '
        select 
            r0.* 
        from 
            (
                select 
                    c.*, 
                    isnull(r.ReverseAmount, 0.00) as ReverseAmount 
                from 
                    Contract c left join 
                    (
                        select 
                            ContractId, 
                            isnull(sum(ReverseAmount), 0.00) as ReverseAmount 
                        from 
                            ContractReverseDetail 
                        group by 
                            ContractId 
                    ) as r on c.Id = r.ContractId 
                where 
                    (c.ApproveState is null or c.ApproveState = ''' + formatmessage(150439) + ''') and c.ContractState = ''' + formatmessage(150242) + ''' and c.PrintState = 1 and c.IsPrestowage = 1) as r0 where (abs(r0.ReverseAmount) < abs(r0.TotalTransportCharges)) '
    
    if @ContractIds is not null and @ContractIds <> ''
    begin
        set @Sql = @Sql + ' and (r0.Id in (' + @ContractIds + '))'
    end

    exec(@Sql)
    
    if @@error <> 0
    begin
        raiserror (150678,18,1)
        return -1
    end

    
    /**/
    select @OpName = formatmessage(150679)
    select @OpParams = N'ContractIds=' + @ContractIds 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadShipmentBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        sb.*,
        dp.PlanNo,
        dp.PlanType,
        dp.OrderNo,
        dp.PayerId,
        dp.PayerName,
        dp.Remark,
        isnull(sbg.TotalPackages,0) as TotalPackages,
        isnull(sbg.TotalTunnages,0.0) as TotalTunnages,
        isnull(sbg.TotalPiles,0.0) as TotalPiles,
        isnull(sbg.TotalTenThousands,0.0) as TotalTenThousands
    from 
        ShipmentBill sb join 
        DeliverPlan dp on sb.PlanId = dp.Id left join 
        (
            select 
                ShipmentBillId,
                isnull(sum(Packages),0) as TotalPackages,
                isnull(sum(Tunnages),0.0) as TotalTunnages,
                isnull(sum(Piles),0.0) as TotalPiles,
                isnull(sum(TenThousands),0.0) as TotalTenThousands
            from 
                ShipmentBillGoods 
            group by 
                ShipmentBillId
        ) as sbg on sb.Id = sbg.ShipmentBillId 
    where 
        sb.Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150380,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150376)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadShipmentBillAllGoods 
@ShipmentBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select 
        sbg.*,
        sb.Warehouse,
        ewb.BillNo as EnterWarehouseBillNo
    from 
        ShipmentBillGoods sbg left join 
        ShipmentBill sb on sbg.ShipmentBillId = sb.Id left join 
        EnterWarehouseBill ewb on sbg.EnterWarehouseBillId = ewb.Id
    where 
        sbg.ShipmentBillId = @ShipmentBillId
    
    
    /**/
    select @OpName = formatmessage(150375)
    select @OpParams = N'ShipmentBillId=' + convert(nvarchar,@ShipmentBillId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadShipmentBillsByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@ShipmentBillNo nvarchar(50),
@CustomerName nvarchar(50),
@CarNo nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    set @Sql = '
        select 
            sb.*,
            dp.PlanType,
            isnull(sbg.TotalPackages,0) as TotalPackages,
            isnull(sbg.TotalTunnages,0.0) as TotalTunnages,
            isnull(sbg.TotalPiles,0.0) as TotalPiles,
            isnull(sbg.TotalTenThousands,0.0) as TotalTenThousands
        from 
            ShipmentBill sb join 
            DeliverPlan dp on sb.PlanId = dp.Id left join 
            (
                select 
                    ShipmentBillId,
                    isnull(sum(Packages),0) as TotalPackages,
                    isnull(sum(Tunnages),0.0) as TotalTunnages,
                    isnull(sum(Piles),0.0) as TotalPiles,
                    isnull(sum(TenThousands),0.0) as TotalTenThousands
                from 
                    ShipmentBillGoods 
                group by 
                    ShipmentBillId
            ) as sbg on sb.Id = sbg.ShipmentBillId 
        where BillState = ''' + formatmessage(150242) + ''''

    if @StartTime is not null and @StartTime <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(convert(nvarchar(10),sb.CreateTime,120) >= ''' + @StartTime + ''')'
    end
    
    if @EndTime is not null and @EndTime <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(convert(nvarchar(10),sb.CreateTime,120) <= ''' + @EndTime + ''')'
    end

    if @ShipmentBillNo is not null and @ShipmentBillNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(sb.BillNo like ''%' + @ShipmentBillNo + '%'')'
    end

    if @CustomerName is not null and @CustomerName <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(sb.CustomerName like ''%' + @CustomerName + '%'')'
    end

    if @CarNo is not null and @CarNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(sb.CarNo like ''%' + @CarNo + '%'')'
    end
        
    exec (@Sql)
    
    if @@error <> 0
    begin
        raiserror (150537,18,1)
        return -1
    end
    
    
    /**/
    select @OpName = formatmessage(150538)
    select @OpParams = N'StartTime=' + @StartTime + N',' +
                       N'EndTime=' + @EndTime + N',' +
                       N'ShipmentBillNo=' + @ShipmentBillNo + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'CarNo=' + @CarNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadShipmentBillsByPlanId 
@PlanId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    select * from ShipmentBill where PlanId = @PlanId 
    
    /**/
    select @OpName = formatmessage(150688)
    select @OpParams = N'PlanId=' + convert(nvarchar,@PlanId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadStaff
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select 
        s.*,
        (case when s.FamilyName is null then N'' else s.FamilyName end + s.Name) as FullName, 
        (case when s1.FamilyName is null then N'' else s1.FamilyName end + s1.Name) as BossStaffName, 
        o.FullName as OrganFullName 
    from 
        Staff s left join 
        Staff s1 on s.BossStaffId = s1.Id left join 
        Organization o on s.OrganId = o.Id 
    where 
        s.Id = @Id 

    if @@rowcount = 0
    begin
        raiserror (150080,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150021)
    select @OpParams = N'Id=' + convert(nvarchar, @Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadStaffAccounts
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select * from Account where AccountType = formatmessage(150162) order by Id
    
    /**/
    select @OpName = formatmessage(150455)
    select @OpParams = N''
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure LoadStaffs
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	select 
        s.*,
        (case when s.FamilyName is null then N'' else s.FamilyName end + s.Name) as FullName, 
        (case when s1.FamilyName is null then N'' else s1.FamilyName end + s1.Name) as BossStaffName,
        o.FullName as OrganFullName 
    from 
        Staff s left join 
        Staff s1 on s.BossStaffId = s1.Id left join 
        Organization o on s.OrganId = o.Id 
    order by 
        s.Id 
    
    /**/
    select @OpName = formatmessage(150110)
    select @OpParams = N''
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadStaffsByOrganId 
@Id bigint,
@opStaffId bigint,
@opStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
     
    SELECT 
        *,
        (case when FamilyName is null then N'' else FamilyName end + Name) as FullName 
    from 
        Staff 
    where 
        OrganId = @Id 
    order by
        Id
        
    /**/
    set @OpName = formatmessage(150147)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end 
    return 0
end
go


create procedure LoadStaffsExcludeSelfAndSubordinates 
@StaffId bigint,
@opStaffId bigint,
@opStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
     
    SELECT 
        *,
        (case when FamilyName is null then N'' else FamilyName end + Name) as FullName 
    from 
        Staff 
    where 
        (Id <> @StaffId) and 
        (Id not in (select StaffId from Boss where BossId = @StaffId)) 
    order by
        Id
        
    /**/
    set @OpName = formatmessage(150102)
    set @OpParams = N'StaffId=' + convert(nvarchar,@StaffId) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end 
    return 0
end
go


create procedure LoadStatStorageAndForceFeeByConditions 
@StartTime nvarchar(50),
@EndTime nvarchar(50),
@CustomerName nvarchar(50),
@Warehouse nvarchar(50),
@IsConsigning nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OldStartTime nvarchar(50)
declare @OldEndTime nvarchar(50)
declare @Sql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @Id bigint
declare @Name nvarchar(50)
declare @ParmDefinition nvarchar(500)
declare @TotalEnterWarehouseTunnages numeric(25,9)
declare @TotalEnterWarehousePiles numeric(25,9)
declare @TotalEnterWarehouseForceFee numeric(25,9)
declare @TotalOutWarehouseTunnages numeric(25,9)
declare @TotalOutWarehousePiles numeric(25,9)
declare @TotalOutWarehouseForceFee numeric(25,9)
declare @TotalStockTunnages numeric(25,9)
declare @TotalStockPiles numeric(25,9)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    set @OldStartTime = @StartTime
    set @OldEndTime = @EndTime

    /**/
    create table #LoadStatStorageAndForceFeeByConditions 
    (
	    Id bigint identity(1,1),
        CustomerId bigint,
        CustomerName nvarchar(50),
	    CreateTime nvarchar(50),
	    TotalDeliverEnterWarehouseTunnages numeric(25,9), 
	    TotalDeliverEnterWarehousePiles numeric(25,9), 
	    UnloadingForceFeePrice numeric(25,9), 
	    DeliverEnterWarehouseForceFee numeric(25,9), 
	    TotalAllocateEnterWarehouseTunnages numeric(25,9), 
	    TotalDeliverOutWarehouseTunnages numeric(25,9), 
	    TotalDeliverOutWarehousePiles numeric(25,9), 
	    LoadingForceFeePrice numeric(25,9), 
	    DeliverOutWarehouseForceFee numeric(25,9), 
	    TotalAllocateOutWarehouseTunnages numeric(25,9), 
	    AllocateOutWarehouseForceFee numeric(25,9), 
	    BalanceTunnages numeric(25,9),
	    BalancePiles numeric(25,9),
	    StorageFeePrice numeric(25,9),
	    StorageFee numeric(25,9)
    )
    
    /**/
    create table #LoadStatStorageAndForceFeeByConditions2 
    (
	    Id bigint identity(1,1),
	    CreateTime nvarchar(50),
	    TotalDeliverEnterWarehouseTunnages numeric(25,9), 
	    TotalDeliverEnterWarehousePiles numeric(25,9), 
	    UnloadingForceFeePrice numeric(25,9), 
	    DeliverEnterWarehouseForceFee numeric(25,9), 
	    TotalAllocateEnterWarehouseTunnages numeric(25,9), 
	    TotalDeliverOutWarehouseTunnages numeric(25,9), 
	    TotalDeliverOutWarehousePiles numeric(25,9), 
	    LoadingForceFeePrice numeric(25,9), 
	    DeliverOutWarehouseForceFee numeric(25,9), 
	    TotalAllocateOutWarehouseTunnages numeric(25,9), 
	    AllocateOutWarehouseForceFee numeric(25,9), 
	    BalanceTunnages numeric(25,9),
	    BalancePiles numeric(25,9),
	    StorageFeePrice numeric(25,9),
	    StorageFee numeric(25,9)
    )

    /**/
    declare Cursor1 cursor local for 
        select 
            Id, Name 
        from 
            Customer 
        where 
            Id in 
            (
                select 
                    distinct CustomerId 
                from 
                    EnterWarehouseBill 
                where 
                    ForceFee > 0 and 
                    convert(nvarchar(10),CreateTime,120) >= @OldStartTime and 
                    convert(nvarchar(10),CreateTime,120) <= @OldEndTime 
                union
                select 
                    distinct CustomerId 
                from 
                    OutWarehouseBill 
                where 
                    ForceFee > 0 and 
                    convert(nvarchar(10),CreateTime,120) >= @OldStartTime and 
                    convert(nvarchar(10),CreateTime,120) <= @OldEndTime 
                union 
                select 
                    distinct CustomerId
                from 
                    Stock 
                where 
                    Id in 
                    (
                        select 
                            StockId 
                        from 
                            StockDaily 
                        where 
                            convert(nvarchar(10),CreateTime,120) >= @OldStartTime and 
                            convert(nvarchar(10),CreateTime,120) <= @OldEndTime 
                    )
            ) and 
            Id not in 
            (
                select 
                    distinct CustomerId 
                from 
                    CustomerStorageAndForceFeeSettlement
                where 
                    convert(nvarchar(10),StartTime,120) < convert(nvarchar(10),@OldEndTime,120) and 
                    convert(nvarchar(10),EndTime,120) > convert(nvarchar(10),@OldStartTime,120)
            ) and 
            OwnOrganId in 
            (
                select 
                    Id 
                from 
                    Organization 
                where 
                    FullPath like 
                    (
                        select 
                            o.FullPath + '%' 
                        from 
                            Account a join 
                            Organization o on a.OrganId = o.Id 
                        where 
                            a.Id = @OpStaffId and 
                            a.AccountType = formatmessage(150162) and
                            a.IsCancel = 0
                    )
            ) and 
            (
                (@CustomerName is null) or 
                (@CustomerName = '') or 
                (@CustomerName is not null and @CustomerName <> '' and Name = @CustomerName)
            )
            
            
    open Cursor1
    fetch next from Cursor1 into @Id, @Name 
    while @@fetch_status = 0
    begin
        /**/
        set @StartTime = convert(nvarchar(10),cast(@OldStartTime as datetime),120)
        set @EndTime = convert(nvarchar(10),cast(@OldEndTime as datetime),120)

        /**/
        if convert(nvarchar(10),cast(@EndTime as datetime),120) > convert(nvarchar(10),getdate(),120)
        begin
	        set @EndTime = convert(nvarchar(10),getdate(),120)
        end
        
        /**/
        if cast(@IsConsigning as bit) = 0
        begin
            /**/
            set @Sql = '
                select 
                    @TotalEnterWarehouseTunnages = isnull(sum(g.TotalTunnages),0.0), 
                    @TotalEnterWarehousePiles = isnull(sum(g.TotalPiles),0.0), 
                    @TotalEnterWarehouseForceFee = isnull(sum(b.ForceFee),0.0) 
                from 
                    EnterWarehouseBill b join
                    (
                        select 
                            EnterWarehouseBillId,
                            isnull(sum(Tunnages),0.0) as TotalTunnages, 
                            isnull(sum(Piles),0.0) as TotalPiles 
                        from 
                            EnterWarehouseBillGoods 
                        group by 
                            EnterWarehouseBillId
                    ) as g on g.EnterWarehouseBillId = b.Id
                where 
                    (b.DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) '
            
            if @StartTime is not null and @StartTime <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
            
            if @EndTime is not null and @EndTime <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
    
            if @Name is not null and @Name <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(b.CustomerName = ''' + @Name + ''')'
            end
    
            if @Warehouse is not null and @Warehouse <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
                
            set @ParmDefinition = N'@TotalEnterWarehouseTunnages numeric(25,9) output, @TotalEnterWarehousePiles numeric(25,9) output, @TotalEnterWarehouseForceFee numeric(25,9) output'
            exec sp_executesql @Sql, @ParmDefinition, @TotalEnterWarehouseTunnages = @TotalEnterWarehouseTunnages output, @TotalEnterWarehousePiles = @TotalEnterWarehousePiles output, @TotalEnterWarehouseForceFee = @TotalEnterWarehouseForceFee output
                
            /**/
            set @Sql = '
                select 
                    @TotalOutWarehouseTunnages = isnull(sum(g.TotalTunnages),0.0), 
                    @TotalOutWarehousePiles = isnull(sum(g.TotalPiles),0.0), 
                    @TotalOutWarehouseForceFee = isnull(sum(b.ForceFee),0.0) 
                from 
                    OutWarehouseBill b join 
                    (
                        select 
                            OutWarehouseBillId,
                            isnull(sum(Tunnages),0.0) as TotalTunnages, 
                            isnull(sum(Piles),0.0) as TotalPiles
                        from 
                            OutWarehouseBillGoods 
                        where 
                            (DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))
                        group by 
                            OutWarehouseBillId
                    ) as g on g.OutWarehouseBillId = b.Id '

            set @WhereSql = ''
            
            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
                set @WhereSql = @WhereSql + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
            
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
                set @WhereSql = @WhereSql + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
    
            if @Name is not null and @Name <> ''
            begin
                if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
                set @WhereSql = @WhereSql + '(b.CustomerName = ''' + @Name + ''')'
            end
    
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
                set @WhereSql = @WhereSql + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
            
            if @WhereSql <> '' set @Sql = @Sql + ' where ' + @WhereSql

            set @ParmDefinition = N'@TotalOutWarehouseTunnages numeric(25,9) output, @TotalOutWarehousePiles numeric(25,9) output, @TotalOutWarehouseForceFee numeric(25,9) output'
            exec sp_executesql @Sql, @ParmDefinition, @TotalOutWarehouseTunnages = @TotalOutWarehouseTunnages output, @TotalOutWarehousePiles = @TotalOutWarehousePiles output, @TotalOutWarehouseForceFee = @TotalOutWarehouseForceFee output

            /**/
            set @Sql = '
                select 
                    @TotalStockTunnages = isnull(sum(sd.Tunnages),0.0),
                    @TotalStockPiles = isnull(sum(sd.Piles),0.0)
                from 
                    StockDaily sd join 
                    Stock s on sd.StockId = s.Id 
                where 
                    (s.DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) '
    
            if @StartTime is not null and @StartTime <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(convert(nvarchar(10),sd.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end

            if @EndTime is not null and @EndTime <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(convert(nvarchar(10),sd.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
    
            if @Name is not null and @Name <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(s.CustomerName = ''' + @Name + ''')'
            end
    
            if @Warehouse is not null and @Warehouse <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(s.Warehouse = ''' + @Warehouse + ''')'
            end

            set @ParmDefinition = N'@TotalStockTunnages numeric(25,9) output, @TotalStockPiles numeric(25,9) output'
            exec sp_executesql @Sql, @ParmDefinition, @TotalStockTunnages = @TotalStockTunnages output, @TotalStockPiles = @TotalStockPiles output
            
            if @TotalEnterWarehouseTunnages = 0 and @TotalEnterWarehousePiles = 0 and @TotalEnterWarehouseForceFee = 0 and @TotalOutWarehouseTunnages = 0 and @TotalOutWarehousePiles = 0 and @TotalOutWarehouseForceFee = 0 and @TotalStockTunnages = 0 and @TotalStockPiles = 0
            begin
                fetch next from Cursor1 into @Id, @Name 
                continue
            end
            
        
            /**/
            set @Sql = '
                insert into #LoadStatStorageAndForceFeeByConditions2 
                    (
                        CreateTime, 
                        TotalDeliverEnterWarehouseTunnages, 
                        TotalDeliverEnterWarehousePiles, 
                        UnloadingForceFeePrice, 
                        DeliverEnterWarehouseForceFee, 
                        TotalAllocateEnterWarehouseTunnages, 
                        TotalDeliverOutWarehouseTunnages, 
                        TotalDeliverOutWarehousePiles, 
                        LoadingForceFeePrice, 
                        DeliverOutWarehouseForceFee, 
                        TotalAllocateOutWarehouseTunnages, 
                        AllocateOutWarehouseForceFee, 
                        BalanceTunnages, 
                        BalancePiles, 
                        StorageFeePrice, 
                        StorageFee
                    ) 
                select 
                    d.CreateTime, 
                    0.0, 
                    0.0,
                    0.00, 
                    0.00, 
                    0.0, 
                    0.0, 
                    0.0,
                    0.00, 
                    0.00, 
                    0.0, 
                    0.00,
                    isnull(b.BalanceTunnages,0.0), 
                    isnull(b.BalancePiles,0.0), 
                    0.00, 
                    0.00 
                from ( ' 
        
            /**/
            set @Sql = @Sql + 'select ''' + formatmessage(150473) + ''' as CreateTime) as d left join ( '
        
            /**/
            set @Sql = @Sql + 'select ''' + formatmessage(150473) + ''' as CreateTime,
                                   sum(sd.Tunnages) as BalanceTunnages, 
                                   sum(sd.Piles) as BalancePiles 
                               from 
                                   StockDaily sd join 
                                   Stock s on sd.StockId = s.Id 
                               where 
                                   (s.DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) '
    
            if @StartTime is not null and @StartTime <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(convert(nvarchar(10),sd.CreateTime,120) = convert(nvarchar(10),dateadd(day,-1,cast(''' + @StartTime + ''' as datetime)),120))'
            end
    
            if @Name is not null and @Name <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(s.CustomerName = ''' + @Name + ''')'
            end
    
            if @Warehouse is not null and @Warehouse <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(s.Warehouse = ''' + @Warehouse + ''')'
            end
    
            set @Sql = @Sql + ') as b on d.CreateTime = b.CreateTime'
        
            exec (@Sql)
            if @@error <> 0
            begin
                raiserror (150474,18,1)
                return -1
            end

            /**/
            while convert(nvarchar(10),cast(@StartTime as datetime),120) <= convert(nvarchar(10),cast(@EndTime as datetime),120)
            begin
                set @Sql = '
                    insert into #LoadStatStorageAndForceFeeByConditions2 
                        (
                            CreateTime, 
                            TotalDeliverEnterWarehouseTunnages, 
                            TotalDeliverEnterWarehousePiles, 
                            UnloadingForceFeePrice, 
                            DeliverEnterWarehouseForceFee, 
                            TotalAllocateEnterWarehouseTunnages, 
                            TotalDeliverOutWarehouseTunnages, 
                            TotalDeliverOutWarehousePiles, 
                            LoadingForceFeePrice, 
                            DeliverOutWarehouseForceFee, 
                            TotalAllocateOutWarehouseTunnages, 
                            AllocateOutWarehouseForceFee, 
                            BalanceTunnages, 
                            BalancePiles, 
                            StorageFeePrice, 
                            StorageFee
                        ) 
                    select 
                        d.CreateTime, 
                        isnull(de.TotalDeliverEnterWarehouseTunnages,0.0), 
                        isnull(de.TotalDeliverEnterWarehousePiles,0.0), 
                        d.UnloadingForceFeePrice, 
                        isnull(de.DeliverEnterWarehouseForceFee,0.00), 
                        isnull(ae.TotalAllocateEnterWarehouseTunnages,0.0), 
                        isnull(do.TotalDeliverOutWarehouseTunnages,0.0), 
                        isnull(do.TotalDeliverOutWarehousePiles,0.0), 
                        d.LoadingForceFeePrice, 
                        isnull(do.DeliverOutWarehouseForceFee,0.00), 
                        isnull(ao.TotalAllocateOutWarehouseTunnages,0.0), 
                        isnull(ao.AllocateOutWarehouseForceFee,0.00), 
                        isnull(b.BalanceTunnages,0.0), 
                        isnull(b.BalancePiles,0.0), 
                        d.StorageFeePrice, 
                        (case when isnull(b.BalanceTunnages,0.0) > 0 then isnull(b.BalanceTunnages,0.0) else isnull(b.BalancePiles,0.0) end) * d.StorageFeePrice 
                    from ( '
            
                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime, 
                                       isnull(fp.UnloadingForceFeePrice,0.0) as UnloadingForceFeePrice, 
                                       isnull(fp.LoadingForceFeePrice,0.0) as LoadingForceFeePrice, 
                                       isnull(sp.StorageFeePrice,0.0) as StorageFeePrice
                                   from 
                                       Customer c left join 
                                       CustomerForceFeePrice fp on c.Id = fp.CustomerId and ''' + convert(nvarchar(10),@StartTime,120) + ''' >= convert(nvarchar(10),fp.StartTime,120) and ''' + convert(nvarchar(10),@StartTime,120) + ''' <= convert(nvarchar(10),fp.EndTime,120) left join 
                                       CustomerStorageFeePrice sp on c.Id = sp.CustomerId and ''' + convert(nvarchar(10),@StartTime,120) + ''' >= convert(nvarchar(10),sp.StartTime,120) and ''' + convert(nvarchar(10),@StartTime,120) + ''' <= convert(nvarchar(10),sp.EndTime,120)'
            
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' where '
                    set @Sql = @Sql + '(c.Name = ''' + @Name + ''')'
                end
            
                set @Sql = @Sql + ') as d left join ( '
            
                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime, 
                                       sum(g.TotalTunnages) as TotalDeliverEnterWarehouseTunnages, 
                                       sum(g.TotalPiles) as TotalDeliverEnterWarehousePiles, 
                                       sum(b.ForceFee) as DeliverEnterWarehouseForceFee 
                                   from 
                                       EnterWarehouseBill b join 
                                       (
                                           select 
                                               EnterWarehouseBillId,
                                               sum(Tunnages) as TotalTunnages, 
                                               sum(Piles) as TotalPiles
                                           from 
                                               EnterWarehouseBillGoods
                                           group by 
                                               EnterWarehouseBillId
                                       ) as g on g.EnterWarehouseBillId = b.Id 
                                   where 
                                       (b.DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) and 
                                       (b.EnterType = ''' + formatmessage(150275) + ''') '
            
                if @StartTime is not null and @StartTime <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
                end
    
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.Warehouse = ''' + @Warehouse + ''')'
                end
            
                set @Sql = @Sql + ') as de on d.CreateTime = de.CreateTime left join ( '
            
                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime, 
                                       sum(g.Tunnages) as TotalAllocateEnterWarehouseTunnages 
                                   from 
                                       EnterWarehouseBillGoods g join 
                                       EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id 
                                   where 
                                       (b.DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) and 
                                       (b.EnterType = ''' + formatmessage(150276) + ''') '
            
                if @StartTime is not null and @StartTime <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
                end
    
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.Warehouse = ''' + @Warehouse + ''')'
                end
            
                set @Sql = @Sql + ') as ae on d.CreateTime = ae.CreateTime left join ( '

                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime, 
                                       sum(g.TotalTunnages) as TotalDeliverOutWarehouseTunnages, 
                                       sum(g.TotalPiles) as TotalDeliverOutWarehousePiles, 
                                       sum(b.ForceFee) as DeliverOutWarehouseForceFee 
                                   from 
                                       OutWarehouseBill b join 
                                       (
                                           select 
                                               OutWarehouseBillId,
                                               sum(Tunnages) as TotalTunnages, 
                                               sum(Piles) as TotalPiles
                                           from 
                                               OutWarehouseBillGoods 
                                           where 
                                               (DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))
                                           group by 
                                               OutWarehouseBillId
                                       ) as g on g.OutWarehouseBillId = b.Id
                                   where 
                                       (b.OutType = ''' + formatmessage(150305) + ''' or (b.OutType = ''' + formatmessage(150630) + ''' and b.ForceFee > 0)) '

                if @StartTime is not null and @StartTime <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
                end
    
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.Warehouse = ''' + @Warehouse + ''')'
                end

                set @Sql = @Sql + ') as do on d.CreateTime = do.CreateTime left join ( '

                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime,	
                                       sum(g.Tunnages) as TotalAllocateOutWarehouseTunnages,
                                       sum(b.ForceFee) as AllocateOutWarehouseForceFee 
                                   from 
                                       OutWarehouseBillGoods g join 
                                       OutWarehouseBill b on g.OutWarehouseBillId = b.Id 
                                   where 
                                       (g.DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) and 
                                       (b.OutType = ''' + formatmessage(150306) + ''') '

                if @StartTime is not null and @StartTime <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
                end
    
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.Warehouse = ''' + @Warehouse + ''')'
                end

                set @Sql = @Sql + ') as ao on d.CreateTime = ao.CreateTime left join ( '
            
                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime, 
                                       sum(sd.Tunnages) as BalanceTunnages,
                                       sum(sd.Piles) as BalancePiles
                                   from 
                                       StockDaily sd join 
                                       Stock s on sd.StockId = s.Id 
                                   where 
                                       (s.DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) '
            
                if @StartTime is not null and @StartTime <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(convert(nvarchar(10),sd.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
                end
    
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(s.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(s.Warehouse = ''' + @Warehouse + ''')'
                end

                set @Sql = @Sql + ') as b on d.CreateTime = b.CreateTime '

                exec(@Sql)
                if @@error <> 0
                begin
                    raiserror (150475,18,1)
                    return -2
                end

	            set @StartTime = convert(nvarchar(10),dateadd(day,1,cast(@StartTime as datetime)),120)
            end
        
            /**/
            if convert(nvarchar(10),cast(@EndTime as datetime),120) = convert(nvarchar(10),getdate(),120)
            begin
                set @Sql = '
                    update #LoadStatStorageAndForceFeeByConditions2 set 
                        BalanceTunnages = s.BalanceTunnages, 
                        BalancePiles = s.BalancePiles, 
                        StorageFee = s.StorageFee 
                    from 
                        #LoadStatStorageAndForceFeeByConditions2 t join ( '
                set @Sql = @Sql + 'select ''' + @EndTime + ''' as CreateTime, 
                                       sum(s.Tunnages) as BalanceTunnages, 
                                       sum(s.Piles) as BalancePiles, 
                                       sum((case when s.Tunnages > 0 then s.Tunnages else s.Piles end) * isnull(c.StorageFeePrice,0.0)) as StorageFee 
                                   from 
                                       Stock s left join 
                                       CustomerStorageFeePrice c on s.CustomerId = c.CustomerId and ''' + convert(nvarchar(10),@EndTime,120) + ''' >= convert(nvarchar(10),c.StartTime,120) and ''' + convert(nvarchar(10),@EndTime,120) + ''' <= convert(nvarchar(10),c.EndTime,120)
                                   where 
                                       (s.DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) '
            
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(s.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(s.Warehouse = ''' + @Warehouse + ''')'
                end

                set @Sql = @Sql + ') as s on t.CreateTime = s.CreateTime '
            
                exec(@Sql)
                if @@error <> 0
                begin
                    raiserror (150476,18,1)
                    return -3
                end
            end
        end
        else
        begin
            /**/
            set @Sql = '
                select 
                    @TotalEnterWarehouseTunnages = isnull(sum(g.TotalTunnages),0.0), 
                    @TotalEnterWarehousePiles = isnull(sum(g.TotalPiles),0.0), 
                    @TotalEnterWarehouseForceFee = isnull(sum(b.ForceFee),0.0) 
                from 
                    EnterWarehouseBill b join
                    (
                        select 
                            EnterWarehouseBillId,
                            isnull(sum(Tunnages),0.0) as TotalTunnages, 
                            isnull(sum(Piles),0.0) as TotalPiles 
                        from 
                            EnterWarehouseBillGoods 
                        group by 
                            EnterWarehouseBillId
                    ) as g on g.EnterWarehouseBillId = b.Id
                where 
                    (b.DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) '
            
            if @StartTime is not null and @StartTime <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
            
            if @EndTime is not null and @EndTime <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
    
            if @Name is not null and @Name <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(b.CustomerName = ''' + @Name + ''')'
            end
    
            if @Warehouse is not null and @Warehouse <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(b.Warehouse = ''' + @Warehouse + ''')'
            end
                
            set @ParmDefinition = N'@TotalEnterWarehouseTunnages numeric(25,9) output, @TotalEnterWarehousePiles numeric(25,9) output, @TotalEnterWarehouseForceFee numeric(25,9) output'
            exec sp_executesql @Sql, @ParmDefinition, @TotalEnterWarehouseTunnages = @TotalEnterWarehouseTunnages output, @TotalEnterWarehousePiles = @TotalEnterWarehousePiles output, @TotalEnterWarehouseForceFee = @TotalEnterWarehouseForceFee output
                
            /**/
            set @Sql = '
                select 
                    @TotalOutWarehouseTunnages = isnull(sum(g.TotalTunnages),0.0), 
                    @TotalOutWarehousePiles = isnull(sum(g.TotalPiles),0.0), 
                    @TotalOutWarehouseForceFee = isnull(sum(b.ForceFee),0.0) 
                from 
                    OutWarehouseBill b join 
                    (
                        select 
                            OutWarehouseBillId,
                            isnull(sum(Tunnages),0.0) as TotalTunnages, 
                            isnull(sum(Piles),0.0) as TotalPiles
                        from 
                            OutWarehouseBillGoods 
                        where 
                            (DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))
                        group by 
                            OutWarehouseBillId
                    ) as g on g.OutWarehouseBillId = b.Id '

            set @WhereSql = ''

            if @StartTime is not null and @StartTime <> ''
            begin
                if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
                set @WhereSql = @WhereSql + '(convert(nvarchar(10),b.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end
            
            if @EndTime is not null and @EndTime <> ''
            begin
                if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
                set @WhereSql = @WhereSql + '(convert(nvarchar(10),b.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
    
            if @Name is not null and @Name <> ''
            begin
                if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
                set @WhereSql = @WhereSql + '(b.CustomerName = ''' + @Name + ''')'
            end
    
            if @Warehouse is not null and @Warehouse <> ''
            begin
                if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
                set @WhereSql = @WhereSql + '(b.Warehouse = ''' + @Warehouse + ''')'
            end

            set @ParmDefinition = N'@TotalOutWarehouseTunnages numeric(25,9) output, @TotalOutWarehousePiles numeric(25,9) output, @TotalOutWarehouseForceFee numeric(25,9) output'
            exec sp_executesql @Sql, @ParmDefinition, @TotalOutWarehouseTunnages = @TotalOutWarehouseTunnages output, @TotalOutWarehousePiles = @TotalOutWarehousePiles output, @TotalOutWarehouseForceFee = @TotalOutWarehouseForceFee output

            /**/
            set @Sql = '
                select 
                    @TotalStockTunnages = isnull(sum(sd.Tunnages),0.0),
                    @TotalStockPiles = isnull(sum(sd.Piles),0.0),
                from 
                    StockDaily sd join 
                    Stock s on sd.StockId = s.Id 
                where 
                    (s.DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) '
    
            if @StartTime is not null and @StartTime <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(convert(nvarchar(10),sd.CreateTime,120) >= convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
            end

            if @EndTime is not null and @EndTime <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(convert(nvarchar(10),sd.CreateTime,120) <= convert(nvarchar(10),cast(''' + @EndTime + ''' as datetime),120))'
            end
    
            if @Name is not null and @Name <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(s.CustomerName = ''' + @Name + ''')'
            end
    
            if @Warehouse is not null and @Warehouse <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(s.Warehouse = ''' + @Warehouse + ''')'
            end

            set @ParmDefinition = N'@TotalStockTunnages numeric(25,9) output, @TotalStockPiles numeric(25,9) output'
            exec sp_executesql @Sql, @ParmDefinition, @TotalStockTunnages = @TotalStockTunnages output, @TotalStockPiles = @TotalStockPiles output
            
            if @TotalEnterWarehouseTunnages = 0 and @TotalEnterWarehousePiles = 0 and @TotalEnterWarehouseForceFee = 0 and @TotalOutWarehouseTunnages = 0 and @TotalOutWarehousePiles = 0 and @TotalOutWarehouseForceFee = 0 and @TotalStockTunnages = 0 and @TotalStockPiles = 0
            begin
                fetch next from Cursor1 into @Id, @Name 
                continue
            end
            
        
            /**/
            set @Sql = '
                insert into #LoadStatStorageAndForceFeeByConditions2 
                    (
                        CreateTime, 
                        TotalDeliverEnterWarehouseTunnages, 
                        TotalDeliverEnterWarehousePiles, 
                        UnloadingForceFeePrice, 
                        DeliverEnterWarehouseForceFee, 
                        TotalAllocateEnterWarehouseTunnages, 
                        TotalDeliverOutWarehouseTunnages, 
                        TotalDeliverOutWarehousePiles, 
                        LoadingForceFeePrice, 
                        DeliverOutWarehouseForceFee, 
                        TotalAllocateOutWarehouseTunnages, 
                        AllocateOutWarehouseForceFee, 
                        BalanceTunnages, 
                        BalancePiles, 
                        StorageFeePrice, 
                        StorageFee
                    ) 
                select 
                    d.CreateTime, 
                    0.0, 
                    0.0,
                    0.00, 
                    0.00, 
                    0.0, 
                    0.0, 
                    0.0,
                    0.00, 
                    0.00, 
                    0.0, 
                    0.00,
                    isnull(b.BalanceTunnages,0.0), 
                    isnull(b.BalancePiles,0.0), 
                    0.00, 
                    0.00 
                from ( ' 
        
            /**/
            set @Sql = @Sql + 'select ''' + formatmessage(150473) + ''' as CreateTime) as d left join ( '
        
            /**/
            set @Sql = @Sql + 'select ''' + formatmessage(150473) + ''' as CreateTime,
                                   sum(sd.Tunnages) as BalanceTunnages,
                                   sum(sd.Piles) as BalancePiles
                               from 
                                   StockDaily sd join 
                                   Stock s on sd.StockId = s.Id 
                               where 
                                   (s.DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) '
    
            if @StartTime is not null and @StartTime <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(convert(nvarchar(10),sd.CreateTime,120) = convert(nvarchar(10),dateadd(day,-1,cast(''' + @StartTime + ''' as datetime)),120))'
            end
    
            if @Name is not null and @Name <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(s.CustomerName = ''' + @Name + ''')'
            end
    
            if @Warehouse is not null and @Warehouse <> ''
            begin
                set @Sql = @Sql + ' and '
                set @Sql = @Sql + '(s.Warehouse = ''' + @Warehouse + ''')'
            end
    
            set @Sql = @Sql + ') as b on d.CreateTime = b.CreateTime'
        
            exec (@Sql)
            if @@error <> 0
            begin
                raiserror (150474,18,1)
                return -4
            end

            /**/
            while convert(nvarchar(10),cast(@StartTime as datetime),120) <= convert(nvarchar(10),cast(@EndTime as datetime),120)
            begin
                set @Sql = '
                    insert into #LoadStatStorageAndForceFeeByConditions2 
                        (
                            CreateTime, 
                            TotalDeliverEnterWarehouseTunnages, 
                            TotalDeliverEnterWarehousePiles, 
                            UnloadingForceFeePrice, 
                            DeliverEnterWarehouseForceFee, 
                            TotalAllocateEnterWarehouseTunnages, 
                            TotalDeliverOutWarehouseTunnages, 
                            TotalDeliverOutWarehousePiles, 
                            LoadingForceFeePrice, 
                            DeliverOutWarehouseForceFee, 
                            TotalAllocateOutWarehouseTunnages, 
                            AllocateOutWarehouseForceFee, 
                            BalanceTunnages, 
                            BalancePiles, 
                            StorageFeePrice, 
                            StorageFee
                        ) 
                    select 
                        d.CreateTime, 
                        isnull(de.TotalDeliverEnterWarehouseTunnages,0.0), 
                        isnull(de.TotalDeliverEnterWarehousePiles,0.0), 
                        d.UnloadingForceFeePrice, 
                        isnull(de.DeliverEnterWarehouseForceFee,0.00), 
                        isnull(ae.TotalAllocateEnterWarehouseTunnages,0.0), 
                        isnull(do.TotalDeliverOutWarehouseTunnages,0.0), 
                        isnull(do.TotalDeliverOutWarehousePiles,0.0), 
                        d.LoadingForceFeePrice, 
                        isnull(do.DeliverOutWarehouseForceFee,0.00), 
                        isnull(ao.TotalAllocateOutWarehouseTunnages,0.0), 
                        isnull(ao.AllocateOutWarehouseForceFee,0.00), 
                        isnull(b.BalanceTunnages,0.0), 
                        isnull(b.BalancePiles,0.0), 
                        d.StorageFeePrice, 
                        (case when isnull(b.BalanceTunnages,0.0) > 0 then isnull(b.BalanceTunnages,0.0) else isnull(b.BalancePiles,0.0) end) * d.StorageFeePrice 
                    from ( '
            
                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime, 
                                       isnull(fp.UnloadingForceFeePrice,0.0) as UnloadingForceFeePrice, 
                                       isnull(fp.LoadingForceFeePrice,0.0) as LoadingForceFeePrice, 
                                       isnull(sp.StorageFeePrice,0.0) as StorageFeePrice
                                   from 
                                       Customer c left join 
                                       CustomerForceFeePrice fp on c.Id = fp.CustomerId and ''' + convert(nvarchar(10),@StartTime,120) + ''' >= convert(nvarchar(10),fp.StartTime,120) and ''' + convert(nvarchar(10),@StartTime,120) + ''' <= convert(nvarchar(10),fp.EndTime,120) left join 
                                       CustomerStorageFeePrice sp on c.Id = sp.CustomerId and ''' + convert(nvarchar(10),@StartTime,120) + ''' >= convert(nvarchar(10),sp.StartTime,120) and ''' + convert(nvarchar(10),@StartTime,120) + ''' <= convert(nvarchar(10),sp.EndTime,120)'
            
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' where '
                    set @Sql = @Sql + '(c.Name = ''' + @Name + ''')'
                end
            
                set @Sql = @Sql + ') as d left join ( '
            
                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime, 
                                       sum(g.TotalTunnages) as TotalDeliverEnterWarehouseTunnages, 
                                       sum(g.TotalPiles) as TotalDeliverEnterWarehousePiles, 
                                       sum(b.ForceFee) as DeliverEnterWarehouseForceFee 
                                   from 
                                       EnterWarehouseBill b join 
                                       (
                                           select 
                                               EnterWarehouseBillId,
                                               sum(Tunnages) as TotalTunnages, 
                                               sum(Piles) as TotalPiles
                                           from 
                                               EnterWarehouseBillGoods
                                           group by 
                                               EnterWarehouseBillId
                                       ) as g on g.EnterWarehouseBillId = b.Id 
                                   where 
                                       (b.DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) and 
                                       (b.EnterType = ''' + formatmessage(150275) + ''') '
            
                if @StartTime is not null and @StartTime <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
                end
    
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.Warehouse = ''' + @Warehouse + ''')'
                end
            
                set @Sql = @Sql + ') as de on d.CreateTime = de.CreateTime left join ( '
            
                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime, 
                                       sum(g.Tunnages) as TotalAllocateEnterWarehouseTunnages
                                   from 
                                       EnterWarehouseBillGoods g join 
                                       EnterWarehouseBill b on g.EnterWarehouseBillId = b.Id 
                                   where 
                                       (b.DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) and 
                                       (b.EnterType = ''' + formatmessage(150276) + ''') '
            
                if @StartTime is not null and @StartTime <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
                end
    
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.Warehouse = ''' + @Warehouse + ''')'
                end
            
                set @Sql = @Sql + ') as ae on d.CreateTime = ae.CreateTime left join ( '

                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime, 
                                       sum(g.TotalTunnages) as TotalDeliverOutWarehouseTunnages, 
                                       sum(g.TotalPiles) as TotalDeliverOutWarehousePiles, 
                                       sum(b.ForceFee) as DeliverOutWarehouseForceFee 
                                   from 
                                       OutWarehouseBill b join 
                                       (
                                           select 
                                               OutWarehouseBillId,
                                               sum(Tunnages) as TotalTunnages, 
                                               sum(Piles) as TotalPiles
                                           from 
                                               OutWarehouseBillGoods 
                                           where 
                                               (DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))
                                           group by 
                                               OutWarehouseBillId
                                       ) as g on g.OutWarehouseBillId = b.Id
                                   where 
                                       (b.OutType = ''' + formatmessage(150305) + ''' or (b.OutType = ''' + formatmessage(150630) + ''' and b.ForceFee > 0)) '

                if @StartTime is not null and @StartTime <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
                end
    
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.Warehouse = ''' + @Warehouse + ''')'
                end

                set @Sql = @Sql + ') as do on d.CreateTime = do.CreateTime left join ( '

                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime,	
                                       sum(g.Tunnages) as TotalAllocateOutWarehouseTunnages,
                                       sum(b.ForceFee) as AllocateOutWarehouseForceFee 
                                   from 
                                       OutWarehouseBillGoods g join 
                                       OutWarehouseBill b on g.OutWarehouseBillId = b.Id 
                                   where 
                                       (g.DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) and 
                                       (b.OutType = ''' + formatmessage(150306) + ''') '

                if @StartTime is not null and @StartTime <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(convert(nvarchar(10),b.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
                end
    
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(b.Warehouse = ''' + @Warehouse + ''')'
                end

                set @Sql = @Sql + ') as ao on d.CreateTime = ao.CreateTime left join ( '
            
                /**/
                set @Sql = @Sql + 'select ''' + @StartTime + ''' as CreateTime, 
                                       sum(sd.Tunnages) as BalanceTunnages,
                                       sum(sd.Piles) as BalancePiles
                                   from 
                                       StockDaily sd join 
                                       Stock s on sd.StockId = s.Id 
                                   where 
                                       (s.DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) '
            
                if @StartTime is not null and @StartTime <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(convert(nvarchar(10),sd.CreateTime,120) = convert(nvarchar(10),cast(''' + @StartTime + ''' as datetime),120))'
                end
    
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(s.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(s.Warehouse = ''' + @Warehouse + ''')'
                end

                set @Sql = @Sql + ') as b on d.CreateTime = b.CreateTime '

                exec(@Sql)
                if @@error <> 0
                begin
                    raiserror (150475,18,1)
                    return -5
                end

	            set @StartTime = convert(nvarchar(10),dateadd(day,1,cast(@StartTime as datetime)),120)
            end
        
            /**/
            if convert(nvarchar(10),cast(@EndTime as datetime),120) = convert(nvarchar(10),getdate(),120)
            begin
                set @Sql = '
                    update #LoadStatStorageAndForceFeeByConditions2 set 
                        BalanceTunnages = s.BalanceTunnages, 
                        BalancePiles = s.BalancePiles, 
                        StorageFee = s.StorageFee 
                    from 
                        #LoadStatStorageAndForceFeeByConditions2 t join ( '
                set @Sql = @Sql + 'select ''' + @EndTime + ''' as CreateTime, 
                                       sum(s.Tunnages) as BalanceTunnages, 
                                       sum(s.Piles) as BalancePiles, 
                                       sum((case when s.Tunnages > 0 then s.Tunnages else s.Piles end) * isnull(c.StorageFeePrice,0.0)) as StorageFee 
                                   from 
                                       Stock s left join 
                                       CustomerStorageFeePrice c on s.CustomerId = c.CustomerId and ''' + convert(nvarchar(10),@EndTime,120) + ''' >= convert(nvarchar(10),c.StartTime,120) and ''' + convert(nvarchar(10),@EndTime,120) + ''' <= convert(nvarchar(10),c.EndTime,120)
                                   where 
                                       (s.DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1)) '
            
                if @Name is not null and @Name <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(s.CustomerName = ''' + @Name + ''')'
                end
    
                if @Warehouse is not null and @Warehouse <> ''
                begin
                    set @Sql = @Sql + ' and '
                    set @Sql = @Sql + '(s.Warehouse = ''' + @Warehouse + ''')'
                end

                set @Sql = @Sql + ') as s on t.CreateTime = s.CreateTime '
            
                exec(@Sql)
                if @@error <> 0
                begin
                    raiserror (150476,18,1)
                    return -6
                end
            end
        end
        
        /**/
        insert into #LoadStatStorageAndForceFeeByConditions 
            (
                CustomerId,
                CustomerName,
                CreateTime, 
                TotalDeliverEnterWarehouseTunnages, 
                TotalDeliverEnterWarehousePiles, 
                UnloadingForceFeePrice, 
                DeliverEnterWarehouseForceFee, 
                TotalAllocateEnterWarehouseTunnages, 
                TotalDeliverOutWarehouseTunnages, 
                TotalDeliverOutWarehousePiles, 
                LoadingForceFeePrice, 
                DeliverOutWarehouseForceFee, 
                TotalAllocateOutWarehouseTunnages, 
                AllocateOutWarehouseForceFee, 
                BalanceTunnages, 
                BalancePiles, 
                StorageFeePrice, 
                StorageFee
            )
        select 
            @Id,
            @Name,
            CreateTime, 
            TotalDeliverEnterWarehouseTunnages, 
            TotalDeliverEnterWarehousePiles, 
            UnloadingForceFeePrice, 
            UnloadingForceFeePrice * (case when TotalDeliverEnterWarehouseTunnages > 0 then TotalDeliverEnterWarehouseTunnages else TotalDeliverEnterWarehousePiles end), /*DeliverEnterWarehouseForceFee, */
            TotalAllocateEnterWarehouseTunnages, 
            TotalDeliverOutWarehouseTunnages, 
            TotalDeliverOutWarehousePiles, 
            LoadingForceFeePrice, 
            LoadingForceFeePrice * (case when TotalDeliverOutWarehouseTunnages > 0 then TotalDeliverOutWarehouseTunnages else TotalDeliverOutWarehousePiles end), /*DeliverOutWarehouseForceFee, */
            TotalAllocateOutWarehouseTunnages, 
            LoadingForceFeePrice * TotalAllocateOutWarehouseTunnages, /*AllocateOutWarehouseForceFee, */
            BalanceTunnages, 
            BalancePiles, 
            StorageFeePrice, 
            StorageFee
        from 
            #LoadStatStorageAndForceFeeByConditions2
    
        /**/
        delete from #LoadStatStorageAndForceFeeByConditions2
        
        fetch next from Cursor1 into @Id, @Name 
    end 
        
    close Cursor1
    deallocate Cursor1 
    
    
    /**/
    select * from #LoadStatStorageAndForceFeeByConditions 
    
    
    /**/
    select @OpName = formatmessage(150477)
    select @OpParams = N'StartTime=' + @OldStartTime + N',' +
                       N'EndTime=' + @OldEndTime + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'Warehouse=' + @Warehouse 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -7
    end
    
    return 0
end
go


create procedure LoadStockEndDifferencesByConditions 
@CustomerName nvarchar(50),
@GoodsId nvarchar(50),
@Warehouse nvarchar(50),
@IsConsigning nvarchar(50),
@ConsignedDeliveryNo nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    set @Sql = '
        select 
            s.*, 
            e.BillNo as EnterWarehouseBillNo 
        from 
            Stock s left join 
            EnterWarehouseBill e on s.EnterWarehouseBillId = e.Id 
        where 
            (s.Packages = 0) and 
            (s.Tunnages < 0)'
            
    if @CustomerName is not null and @CustomerName <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(s.CustomerName=''' + @CustomerName + ''')'
    end
    
    if @GoodsId is not null and @GoodsId <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(s.GoodsId=' + @GoodsId + ')'
    end
    
    if @Warehouse is not null and @Warehouse <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(s.Warehouse=''' + @Warehouse + ''')'
    end
       
    if cast(@IsConsigning as bit) = 0
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(s.DeliveryNo not in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
    end
    else
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(s.DeliveryNo in (select DeliveryNo from DeliverPlan where IsConsigning = 1 union select DeliveryNo from EnterWarehouseBill where IsConsigning = 1))'
    end
    
    if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(s.DeliveryNo=''' + @ConsignedDeliveryNo + ''')'
    end
    
            
    exec (@Sql)

    if @@error <> 0
    begin
        raiserror (150617,18,1)
        return -1
    end
   
    /**/
    set @OpName = formatmessage(150618)
    set @OpParams = N'CustomerName=' + @CustomerName + N',' +
                    N'GoodsId=' + @GoodsId + N',' +
                    N'Warehouse=' + @Warehouse + N',' +
                    N'IsConsigning=' + @IsConsigning + N',' +
                    N'ConsignedDeliveryNo=' + @ConsignedDeliveryNo
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadStocksByEnterWarehouseBillId 
@EnterWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Stock where EnterWarehouseBillId = @EnterWarehouseBillId
   
    /**/
    set @OpName = formatmessage(150686)
    set @OpParams = N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadStocktakingByConditions 
@Warehouse nvarchar(50),
@Location nvarchar(50),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    set @Sql = '
        select 
            CustomerId,
            CustomerName,
            GoodsId, 
            GoodsNo, 
            GoodsName, 
            SpecModel, 
            GWeight, 
            Grade, 
            Location,
            Warehouse,
            isnull(sum(Packages), 0) as Packages,
            isnull(sum(Tunnages), 0.0) as Tunnages,
            isnull(sum(Piles), 0.0) as Piles,
            isnull(sum(TenThousands), 0.0) as TenThousands
        from 
            Stock 
        where 
            (Packages > 0 or Piles > 0) '
            
    if @Warehouse is not null and @Warehouse <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(Warehouse=''' + @Warehouse + ''')'
    end
       
    if @Location is not null and @Location <> ''
    begin
        set @Sql = @Sql + ' and '
        set @Sql = @Sql + '(Location=''' + @Location + ''')'
    end
            
    set @Sql = @Sql + '
        group by 
            CustomerId,
            CustomerName,
            GoodsId, 
            GoodsNo, 
            GoodsName, 
            SpecModel, 
            GWeight, 
            Grade, 
            Location,
            Warehouse '
   
    exec (@Sql)

    if @@error <> 0
    begin
        raiserror (150536,18,1)
        return -1
    end
   
    /**/
    set @OpName = formatmessage(150463)
    set @OpParams = N'Warehouse=' + @Warehouse + N',' +
                    N'Location=' + @Location 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @TypeId
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure LoadSubGoodsTypes 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from GoodsType where ParentId = @Id 

    /**/
    select @OpName = formatmessage(150107)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadSubmitContracts 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OrganId bigint
declare @StaffId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @OrganId = OrganId, @StaffId = StaffId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end

    /**/
    select 
        * 
    from 
        Contract 
    where 
        CreatorId = @OpStaffId and 
        ContractState = formatmessage(150241) and 
		IsPrestowage = 1
    
    
    /**/
    select @OpName = formatmessage(150435)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadSubmitDeliverPlans 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @AccountType nvarchar(20)
declare @OrganId bigint
declare @StaffId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @AccountType = AccountType, @OrganId = OrganId, @StaffId = StaffId from Account where Id = @OpStaffId and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150005,18,1)
        return -1
    end
    
    /**/
    select 
        dp.*, 
        r2.ApproverId as LastApproverId,
        r2.ApproverName as LastApproverName,
        case when r2.IsAgreed is null then N'' when r2.IsAgreed = 1 then formatmessage(150297) else formatmessage(150298) end as LastIsAgreed,
        r2.ApproveComment as LastApproveComment,
        r2.ApproveTime as LastApproveTime 
    from 
        DeliverPlan dp left join 
        (
            select 
                dpac.PlanId,
                dpac.ApproverId,
                dpac.ApproverName,
                dpac.IsAgreed,
                dpac.ApproveComment,
                dpac.ApproveTime  
            from 
                DeliverPlanApproveComment dpac join 
                (
                    select PlanId, max(ApproveTime) as MaxApproveTime from DeliverPlanApproveComment group by PlanId 
                ) as r1 on dpac.PlanId = r1.PlanId and dpac.ApproveTime = r1.MaxApproveTime 
        ) as r2 on dp.Id = r2.PlanId 
    where 
        dp.CreatorId = @OpStaffId and 
        dp.PlanState = formatmessage(150241)
    
    
    /**/
    select @OpName = formatmessage(150260)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadSubmitDispatchBillByCarNo 
@CarNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @OwnOrganId = OrganId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end

    /**/
    select 
        db.*,
        isnull(cc.CarryingCapacity,0) as CarryingCapacity 
    from 
        DispatchBill db left join 
        CarrierCar cc on db.CarrierId = cc.CarrierId and db.CarNo = cc.CarNo 
    where 
        db.CarNo = @CarNo and 
        db.OwnOrganId = @OwnOrganId and 
        db.BillState = formatmessage(150241)
        
    
    /**/
    select @OpName = formatmessage(150326)
    select @OpParams = N'CarNo=' + @CarNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure LoadSubmitDispatchBills 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OrganId bigint
declare @StaffId bigint
declare @OrganFullPath nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @OrganId = OrganId, @StaffId = StaffId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end
    
    select @OrganFullPath = FullPath from Organization where Id = @OrganId
    if @@rowcount = 0
    begin
        raiserror (150145,18,1)
        return -2
    end
    

    /**/
    select 
        db.*, 
        isnull(cc.CarryingCapacity,0) as CarryingCapacity 
    from 
        DispatchBill db left join 
        CarrierCar cc on db.CarrierId = cc.CarrierId and db.CarNo = cc.CarNo 
    where 
        db.CreatorId in (select Id from Account where AccountType=formatmessage(150162) and StaffId in (select StaffId from Staff where OrganFullPath like @OrganFullPath + '%')) and 
        db.BillState = formatmessage(150241)
    
    
    /**/
    select @OpName = formatmessage(150327)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadSubmitShipmentBills 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @OwnOrganId = OrganId from Account where Id = @OpStaffId and AccountType = formatmessage(150162) and IsCancel = 0
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end

    /**/
    select 
        sb.*,
        dp.PlanNo,
        isnull(sbg.TotalPackages,0) as TotalPackages,
        isnull(sbg.TotalTunnages,0.0) as TotalTunnages,
        isnull(sbg.TotalPiles,0.0) as TotalPiles,
        isnull(sbg.TotalTenThousands,0.0) as TotalTenThousands
    from 
        ShipmentBill sb join 
        DeliverPlan dp on sb.PlanId = dp.Id left join 
        (
            select 
                ShipmentBillId,
                isnull(sum(Packages),0) as TotalPackages,
                isnull(sum(Tunnages),0.0) as TotalTunnages,
                isnull(sum(Piles),0.0) as TotalPiles,
                isnull(sum(TenThousands),0.0) as TotalTenThousands
            from 
                ShipmentBillGoods 
            group by 
                ShipmentBillId
        ) as sbg on sb.Id = sbg.ShipmentBillId 
    where 
        sb.OwnOrganId = @OwnOrganId and 
        sb.BillState = formatmessage(150241) and
        sb.PrintState = 1 
        
    
    /**/
    select @OpName = formatmessage(150377)
    select @OpParams = N'' 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadTransportLimitedPrice 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from TransportLimitedPrice where Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150223,18,1)
        return -1
    end
    
    
    /**/
    select @OpName = formatmessage(150224)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadTransportLimitedPricesByConditions 
@PlanType nvarchar(10),
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@DestCountry nvarchar(20),
@DestProvince nvarchar(20),
@DestCity nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @SelectSql nvarchar(max)
declare @WhereSql nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    set @SelectSql = 'select * from TransportLimitedPrice'
            
    set @WhereSql = ''

    if @PlanType is not null and @PlanType <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(PlanType = ''' + @PlanType + ''')' 
    end
    
    if @StartCountry is not null and @StartCountry <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(StartCountry = ''' + @StartCountry + ''')' 
    end
    
    if @StartProvince is not null and @StartProvince <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(StartProvince = ''' + @StartProvince + ''')' 
    end
    
    if @StartCity is not null and @StartCity <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(StartCity = ''' + @StartCity + ''')' 
    end
    
    if @DestCountry is not null and @DestCountry <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(DestCountry = ''' + @DestCountry + ''')' 
    end
    
    if @DestProvince is not null and @DestProvince <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(DestProvince = ''' + @DestProvince + ''')' 
    end
    
    if @DestCity is not null and @DestCity <> ''
    begin
        if @WhereSql <> '' set @WhereSql = @WhereSql + ' and '
        set @WhereSql = @WhereSql + '(DestCity = ''' + @DestCity + ''')' 
    end
    
    if @WhereSql <> '' set @SelectSql = @SelectSql + ' where ' + @WhereSql 
    
    exec(@SelectSql)
    
    if @@error <> 0
    begin
        raiserror (150613,18,1)
        return -1
    end
    
    
    /**/
    select @OpName = formatmessage(150219)
    select @OpParams = N'PlanType=' + @PlanType + N',' +
                       N'StartCountry=' + @StartCountry + N',' +
                       N'StartProvince=' + @StartProvince + N',' +
                       N'StartCity=' + @StartCity + N',' +
                       N'DestCountry=' + @DestCountry + N',' +
                       N'DestProvince=' + @DestProvince + N',' +
                       N'DestCity=' + @DestCity 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadWarehouse 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Warehouse where Id = @Id 
    
    if @@rowcount=0
    begin
        raiserror (150191,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150192)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure LoadWarehouses 
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    select * from Warehouse 
    
    /**/
    select @OpName = formatmessage(150187)
    select @OpParams = N''
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -1
    end
    
    return 0
end
go


create procedure MergeDispatchBills
@Ids nvarchar(2000),
@NewId bigint output, /**/
@ShipmentBillMerged bit output,/**/
@DeliverBillMerged bit output,/**/
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Sql nvarchar(max)
declare @NewDispatchBillNo nvarchar(20)
declare @OldId bigint
declare @OldTotalPackages int
declare @OldTotalTunnages numeric(25,9)
declare @OldTotalPiles numeric(25,9)
declare @OldTotalTenThousands numeric(25,9)
declare @OldTotalTransportCharges numeric(25,9)
declare @OldPlanId bigint
declare @OldPackages int
declare @OldTunnages numeric(25,9)
declare @OldPiles numeric(25,9)
declare @OldTenThousands numeric(25,9)
declare @OldTransportChargeExpression nvarchar(100)
declare @OldTransportPriceExpression nvarchar(100)
declare @OldKM int 
declare @OldTransportPrice numeric(25,9)
declare @OldTransportCharges numeric(25,9)
declare @DispatchBillDeliverPlanId bigint
declare @OldGoodsId bigint
declare @OldGoodsName nvarchar(50)
declare @OldTypeId bigint
declare @OldTypeName nvarchar(50)
declare @OldTypeFullPath nvarchar(500)
declare @OldTypeFullName nvarchar(500)
declare @OldGoodsNo nvarchar(20)
declare @OldBrand nvarchar(20)
declare @OldSpecModel nvarchar(50)
declare @OldGWeight nvarchar(20)
declare @OldGrade nvarchar(10)
declare @OldPieceWeight numeric(25,9)
declare @OldPacking nvarchar(10)
declare @OldBatchNo nvarchar(20)
declare @OldLocation nvarchar(10)
declare @OldProductionDate nvarchar(10)
declare @OldEnterWarehouseBillId bigint
declare @DispatchBillGoodsId bigint
declare @ShipmentBillId bigint
declare @ShipmentBillNo nvarchar(20)
declare @OldShipmentBillId bigint
declare @ShipmentBillGoodsId bigint
declare @OldShipmentBillGoodsId bigint
declare @OutWarehouseBillId bigint
declare @OldOutWarehouseBillId bigint
declare @OldOldForceFee numeric(25,9)
declare @OldOutWarehouseBillGoodsId bigint
declare @OldDeliveryNo nvarchar(20)
declare @OutWarehouseBillGoodsId bigint
declare @OldStockOutWarehouseDetailId bigint
declare @StockOutWarehouseDetailId bigint
declare @DeliverBillId bigint
declare @OldDeliverBillId bigint
declare @OldDeliverBillGoodsId bigint
declare @DeliverBillGoodsId bigint
declare @OldRemark nvarchar(100)
declare @OldForceFee numeric(25,9)
declare @OldStockId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    set @NewId = 0
    set @ShipmentBillMerged = 0
    set @DeliverBillMerged = 0
    
    /************************************************************************************************************************************************/
    /*1.*/
    create table #MergeDispatchBillIds
    (
        Id bigint
    )
    
    set @Sql = 'insert into #MergeDispatchBillIds (Id) select Id=' + replace(@Ids,',',' union all select ') 
    exec (@Sql)
    
    /************************************************************************************************************************************************/
    /*2.*/
    exec GetId @OpStaffId, @NewId output 
    
    exec GetNo N'DispatchBill', @NewDispatchBillNo output
    set @NewDispatchBillNo = N'D' + @NewDispatchBillNo 
    
    insert into DispatchBill 
        (
            Id, 
            DispatchBillNo,
            CarNo,
            TrailerNo,
            CarType,
            DriverName,
            DriverLicenseNo,
            DriverMobileTel,
            DriverHomeTel,
            CarrierId,
            CarrierName,
            TotalPackages,
            TotalTunnages,
            TotalPiles,
            TotalTenThousands,
            TotalTransportCharges,
            CreatorId,
            CreatorName,
            CreateOrganId,
            CreateOrganName,
            CreateTime,
            OwnOrganId,
            OwnOrganName,
            BillState
        ) 
    select 
        @NewId,
        @NewDispatchBillNo,
        CarNo,
        TrailerNo,
        CarType,
        DriverName,
        DriverLicenseNo,
        DriverMobileTel,
        DriverHomeTel,
        CarrierId,
        CarrierName,
        0,
        0,
        0,
        0,
        0,
        CreatorId,
        CreatorName,
        CreateOrganId,
        CreateOrganName,
        CreateTime,
        OwnOrganId,
        OwnOrganName,
        BillState
    from 
        DispatchBill 
    where 
        Id in 
        (
            select top(1) Id from #MergeDispatchBillIds
        )
    if @@rowcount = 0
    begin
        raiserror (150314,18,1)
        return -1
    end
    
    /************************************************************************************************************************************************/
    /*3.*/
    declare Cursor1 cursor local for 
        select 
            Id, 
            TotalPackages, 
            TotalTunnages, 
            TotalPiles, 
            TotalTenThousands, 
            TotalTransportCharges 
        from 
            DispatchBill 
        where 
            Id in (select Id from #MergeDispatchBillIds)
            
    open Cursor1
    fetch next from Cursor1 into 
        @OldId, 
        @OldTotalPackages, 
        @OldTotalTunnages, 
        @OldTotalPiles, 
        @OldTotalTenThousands,
        @OldTotalTransportCharges
    
    while @@fetch_status = 0
    begin
        /*3.1.*/
        update DispatchBill set 
            TotalPackages = TotalPackages + @OldTotalPackages,
            TotalTunnages = TotalTunnages + @OldTotalTunnages,
            TotalPiles = TotalPiles + @OldTotalPiles,
            TotalTenThousands = TotalTenThousands + @OldTotalTenThousands,
            TotalTransportCharges = TotalTransportCharges + @OldTotalTransportCharges
        where 
            Id = @NewId
        if @@rowcount = 0
        begin
            raiserror (150315,18,1)
            return -2
        end
        
        /*3.2.*/
        declare Cursor2 cursor local for
            select 
                PlanId,
                Packages,
                Tunnages,
                Piles,
                TenThousands,
                TransportChargeExpression,
                TransportPriceExpression,
                KM,
                TransportPrice,
                TransportCharges
            from 
                DispatchBillDeliverPlan 
            where 
                DispatchBillId = @OldId
        
        open Cursor2
        fetch next from Cursor2 into 
            @OldPlanId,
            @OldPackages,
            @OldTunnages,
            @OldPiles,
            @OldTenThousands,
            @OldTransportChargeExpression,
            @OldTransportPriceExpression,
            @OldKM,
            @OldTransportPrice,
            @OldTransportCharges
        
        while @@fetch_status = 0
        begin
            /*3.2.1.*/
            if not exists(select * from DispatchBillDeliverPlan where DispatchBillId = @NewId and PlanId = @OldPlanId)
            begin
                /**/
                exec GetId @OpStaffId, @DispatchBillDeliverPlanId output 
                insert into DispatchBillDeliverPlan 
                    (
                        Id,
                        DispatchBillId,
                        PlanId,
                        Packages,
                        Tunnages,
                        Piles,
                        TenThousands,
                        TransportChargeExpression,
                        TransportPriceExpression,
                        KM,
                        TransportPrice,
                        TransportCharges
                    )
                values
                    (
                        @DispatchBillDeliverPlanId,
                        @NewId,
                        @OldPlanId,
                        @OldPackages,
                        @OldTunnages,
                        @OldPiles,
                        @OldTenThousands,
                        @OldTransportChargeExpression,
                        @OldTransportPriceExpression,
                        @OldKM,
                        @OldTransportPrice,
                        @OldTransportCharges
                    )
                if @@rowcount = 0
                begin
                    raiserror (150317,18,1)
                    return -3
                end
                
                /**/
                declare Cursor3 cursor local for
                    select
                        GoodsId,
                        GoodsName,
                        TypeId,
                        TypeName,
                        TypeFullPath,
                        TypeFullName,
                        GoodsNo,
                        Brand,
                        SpecModel,
                        GWeight,
                        Grade,
                        PieceWeight,
                        Packing,
                        BatchNo,
                        Location,
                        Packages,
                        Tunnages,
                        Piles,
                        TenThousands,
                        ProductionDate,
                        EnterWarehouseBillId
                    from 
                        DispatchBillGoods 
                    where 
                        DispatchBillId = @OldId and 
                        PlanId = @OldPlanId
                        
                open Cursor3
                fetch next from Cursor3 into 
                    @OldGoodsId,
                    @OldGoodsName,
                    @OldTypeId,
                    @OldTypeName,
                    @OldTypeFullPath,
                    @OldTypeFullName,
                    @OldGoodsNo,
                    @OldBrand,
                    @OldSpecModel,
                    @OldGWeight,
                    @OldGrade,
                    @OldPieceWeight,
                    @OldPacking,
                    @OldBatchNo,
                    @OldLocation,
                    @OldPackages,
                    @OldTunnages,
                    @OldPiles,
                    @OldTenThousands,
                    @OldProductionDate,
                    @OldEnterWarehouseBillId
                        
                while @@fetch_status = 0
                begin
                    exec GetId @OpStaffId, @DispatchBillGoodsId output 
                    insert into DispatchBillGoods 
                        (
                            Id,
                            DispatchBillId,
                            PlanId,
                            GoodsId,
                            GoodsName,
                            TypeId,
                            TypeName,
                            TypeFullPath,
                            TypeFullName,
                            GoodsNo,
                            Brand,
                            SpecModel,
                            GWeight,
                            Grade,
                            PieceWeight,
                            Packing,
                            BatchNo,
                            Location,
                            Packages,
                            Tunnages,
                            Piles,
                            TenThousands,
                            ProductionDate,
                            EnterWarehouseBillId 
                        )
                    values
                        (
                            @DispatchBillGoodsId,
                            @NewId,
                            @OldPlanId,
                            @OldGoodsId,
                            @OldGoodsName,
                            @OldTypeId,
                            @OldTypeName,
                            @OldTypeFullPath,
                            @OldTypeFullName,
                            @OldGoodsNo,
                            @OldBrand,
                            @OldSpecModel,
                            @OldGWeight,
                            @OldGrade,
                            @OldPieceWeight,
                            @OldPacking,
                            @OldBatchNo,
                            @OldLocation,
                            @OldPackages,
                            @OldTunnages,
                            @OldPiles,
                            @OldTenThousands,
                            @OldProductionDate,
                            @OldEnterWarehouseBillId 
                        )
                    if @@rowcount = 0
                    begin
                        raiserror (150322,18,1)
                        return -4
                    end
                    
                    fetch next from Cursor3 into 
                        @OldGoodsId,
                        @OldGoodsName,
                        @OldTypeId,
                        @OldTypeName,
                        @OldTypeFullPath,
                        @OldTypeFullName,
                        @OldGoodsNo,
                        @OldBrand,
                        @OldSpecModel,
                        @OldGWeight,
                        @OldGrade,
                        @OldPieceWeight,
                        @OldPacking,
                        @OldBatchNo,
                        @OldLocation,
                        @OldPackages,
                        @OldTunnages,
                        @OldPiles,
                        @OldTenThousands,
                        @OldProductionDate,
                        @OldEnterWarehouseBillId
                end
                        
                close Cursor3
                deallocate Cursor3
                
                /**/
                if exists(select * from ShipmentBill where DispatchBillId = @OldId and PlanId = @OldPlanId)
                begin
                    update ShipmentBill set DispatchBillId = @NewId where DispatchBillId = @OldId and PlanId = @OldPlanId
                    if @@rowcount = 0
                    begin
                        raiserror (150543,18,1)
                        return -5
                    end
                end
                
                /**/
                if exists(select * from DeliverBill where DispatchBillId = @OldId and PlanId = @OldPlanId)
                begin
                    update DeliverBill set DispatchBillId = @NewId where DispatchBillId = @OldId and PlanId = @OldPlanId
                    if @@rowcount = 0
                    begin
                        raiserror (150544,18,1)
                        return -6
                    end
                end
            end
            else
            /*3.2.2.*/
            begin
                /**/
                update DispatchBillDeliverPlan set 
                    Packages = Packages + @OldPackages,
                    Tunnages = Tunnages + @OldTunnages,
                    Piles = Piles + @OldPiles,
                    TenThousands = TenThousands + @OldTenThousands,
                    TransportCharges = TransportCharges + @OldTransportCharges
                where 
                    DispatchBillId = @NewId and 
                    PlanId = @OldPlanId
                if @@rowcount = 0
                begin
                    raiserror (150359,18,1)
                    return -7
                end
                
                /**/
                declare Cursor4 cursor local for
                    select
                        GoodsId,
                        GoodsName,
                        TypeId,
                        TypeName,
                        TypeFullPath,
                        TypeFullName,
                        GoodsNo,
                        Brand,
                        SpecModel,
                        GWeight,
                        Grade,
                        PieceWeight,
                        Packing,
                        BatchNo,
                        Location,
                        Packages,
                        Tunnages,
                        Piles,
                        TenThousands,
                        ProductionDate,
                        EnterWarehouseBillId
                    from 
                        DispatchBillGoods 
                    where 
                        DispatchBillId = @OldId and 
                        PlanId = @OldPlanId
                        
                open Cursor4
                fetch next from Cursor4 into 
                    @OldGoodsId,
                    @OldGoodsName,
                    @OldTypeId,
                    @OldTypeName,
                    @OldTypeFullPath,
                    @OldTypeFullName,
                    @OldGoodsNo,
                    @OldBrand,
                    @OldSpecModel,
                    @OldGWeight,
                    @OldGrade,
                    @OldPieceWeight,
                    @OldPacking,
                    @OldBatchNo,
                    @OldLocation,
                    @OldPackages,
                    @OldTunnages,
                    @OldPiles,
                    @OldTenThousands,
                    @OldProductionDate,
                    @OldEnterWarehouseBillId
                        
                while @@fetch_status = 0
                begin
                    if exists
                        (
                            select 
                                * 
                            from 
                                DispatchBillGoods 
                            where 
                                DispatchBillId = @NewId and 
                                PlanId = @OldPlanId and 
                                GoodsId = @OldGoodsId and 
                                Packing = @OldPacking and 
                                BatchNo = @OldBatchNo and 
                                Location = @OldLocation and 
                                ProductionDate = @OldProductionDate and 
                                EnterWarehouseBillId = @OldEnterWarehouseBillId
                        )
                    begin
                        update DispatchBillGoods set 
                            Packages = Packages + @OldPackages,
                            Tunnages = Tunnages + @OldTunnages,
                            Piles = Piles + @OldPiles,
                            TenThousands = TenThousands + @OldTenThousands
                        where 
                            DispatchBillId = @NewId and 
                            PlanId = @OldPlanId and 
                            GoodsId = @OldGoodsId and 
                            Packing = @OldPacking and 
                            BatchNo = @OldBatchNo and 
                            Location = @OldLocation and 
                            ProductionDate = @OldProductionDate and 
                            EnterWarehouseBillId = @OldEnterWarehouseBillId
                        if @@rowcount = 0
                        begin
                            raiserror (150381,18,1)
                            return -8
                        end
                    end
                    else
                    begin
                        exec GetId @OpStaffId, @DispatchBillGoodsId output 
                        insert into DispatchBillGoods 
                            (
                                Id,
                                DispatchBillId,
                                PlanId,
                                GoodsId,
                                GoodsName,
                                TypeId,
                                TypeName,
                                TypeFullPath,
                                TypeFullName,
                                GoodsNo,
                                Brand,
                                SpecModel,
                                GWeight,
                                Grade,
                                PieceWeight,
                                Packing,
                                BatchNo,
                                Location,
                                Packages,
                                Tunnages,
                                Piles,
                                TenThousands,
                                ProductionDate,
                                EnterWarehouseBillId 
                            )
                        values
                            (
                                @DispatchBillGoodsId,
                                @NewId,
                                @OldPlanId,
                                @OldGoodsId,
                                @OldGoodsName,
                                @OldTypeId,
                                @OldTypeName,
                                @OldTypeFullPath,
                                @OldTypeFullName,
                                @OldGoodsNo,
                                @OldBrand,
                                @OldSpecModel,
                                @OldGWeight,
                                @OldGrade,
                                @OldPieceWeight,
                                @OldPacking,
                                @OldBatchNo,
                                @OldLocation,
                                @OldPackages,
                                @OldTunnages,
                                @OldPiles,
                                @OldTenThousands,
                                @OldProductionDate,
                                @OldEnterWarehouseBillId 
                            )
                        if @@rowcount = 0
                        begin
                            raiserror (150322,18,1)
                            return -9
                        end
                    end
                    
                    fetch next from Cursor4 into 
                        @OldGoodsId,
                        @OldGoodsName,
                        @OldTypeId,
                        @OldTypeName,
                        @OldTypeFullPath,
                        @OldTypeFullName,
                        @OldGoodsNo,
                        @OldBrand,
                        @OldSpecModel,
                        @OldGWeight,
                        @OldGrade,
                        @OldPieceWeight,
                        @OldPacking,
                        @OldBatchNo,
                        @OldLocation,
                        @OldPackages,
                        @OldTunnages,
                        @OldPiles,
                        @OldTenThousands,
                        @OldProductionDate,
                        @OldEnterWarehouseBillId
                end
                        
                close Cursor4
                deallocate Cursor4
                
                /**/
                set @ShipmentBillId = 0
                if exists(select * from ShipmentBill where DispatchBillId = @OldId and PlanId = @OldPlanId)
                begin
                    /**/
                    select @ShipmentBillId = Id from ShipmentBill where DispatchBillId = @NewId and PlanId = @OldPlanId
                    if @@rowcount = 0
                    begin
                        raiserror (150632,18,1)
                        return -10
                    end
                    
                    /**/
                    select @OldShipmentBillId = Id from ShipmentBill where DispatchBillId = @OldId and PlanId = @OldPlanId
                    if @@rowcount = 0
                    begin
                        raiserror (150633,18,1)
                        return -11
                    end
                    
                    /**/
                    delete from ShipmentBill where DispatchBillId = @OldId and PlanId = @OldPlanId
                    if @@rowcount = 0
                    begin
                        raiserror (150634,18,1)
                        return -12
                    end
                    
                    /**/
                    declare Cursor5 cursor local for
                        select
                            Id,
                            GoodsId,
                            GoodsName,
                            TypeId,
                            TypeName,
                            TypeFullPath,
                            TypeFullName,
                            GoodsNo,
                            Brand,
                            SpecModel,
                            GWeight,
                            Grade,
                            PieceWeight,
                            Packing,
                            BatchNo,
                            Location,
                            Packages,
                            Tunnages,
                            Piles,
                            TenThousands,
                            ProductionDate,
                            EnterWarehouseBillId
                        from 
                            ShipmentBillGoods 
                        where 
                            ShipmentBillId = @OldShipmentBillId 
                        
                    open Cursor5
                    fetch next from Cursor5 into 
                        @OldShipmentBillGoodsId,
                        @OldGoodsId,
                        @OldGoodsName,
                        @OldTypeId,
                        @OldTypeName,
                        @OldTypeFullPath,
                        @OldTypeFullName,
                        @OldGoodsNo,
                        @OldBrand,
                        @OldSpecModel,
                        @OldGWeight,
                        @OldGrade,
                        @OldPieceWeight,
                        @OldPacking,
                        @OldBatchNo,
                        @OldLocation,
                        @OldPackages,
                        @OldTunnages,
                        @OldPiles,
                        @OldTenThousands,
                        @OldProductionDate,
                        @OldEnterWarehouseBillId
                        
                    while @@fetch_status = 0
                    begin
                        if exists
                            (
                                select 
                                    * 
                                from 
                                    ShipmentBillGoods 
                                where 
                                    ShipmentBillId = @ShipmentBillId and 
                                    GoodsId = @OldGoodsId and 
                                    Packing = @OldPacking and 
                                    BatchNo = @OldBatchNo and 
                                    Location = @OldLocation and 
                                    ProductionDate = @OldProductionDate and 
                                    EnterWarehouseBillId = @OldEnterWarehouseBillId
                            )
                        begin
                            update ShipmentBillGoods set 
                                Packages = Packages + @OldPackages,
                                Tunnages = Tunnages + @OldTunnages,
                                Piles = Piles + @OldPiles,
                                TenThousands = TenThousands + @OldTenThousands
                            where 
                                ShipmentBillId = @ShipmentBillId and 
                                GoodsId = @OldGoodsId and 
                                Packing = @OldPacking and 
                                BatchNo = @OldBatchNo and 
                                Location = @OldLocation and 
                                ProductionDate = @OldProductionDate and 
                                EnterWarehouseBillId = @OldEnterWarehouseBillId
                            if @@rowcount = 0
                            begin
                                raiserror (150379,18,1)
                                return -13
                            end
                        end
                        else
                        begin
                            exec GetId @OpStaffId, @ShipmentBillGoodsId output 
                            insert into ShipmentBillGoods 
                                (
                                    Id,
                                    ShipmentBillId,
                                    GoodsId,
                                    GoodsName,
                                    TypeId,
                                    TypeName,
                                    TypeFullPath,
                                    TypeFullName,
                                    GoodsNo,
                                    Brand,
                                    SpecModel,
                                    GWeight,
                                    Grade,
                                    PieceWeight,
                                    Packing,
                                    BatchNo,
                                    Location,
                                    Packages,
                                    Tunnages,
                                    Piles,
                                    TenThousands,
                                    ProductionDate,
                                    EnterWarehouseBillId 
                                )
                            values
                                (
                                    @ShipmentBillGoodsId,
                                    @ShipmentBillId,
                                    @OldGoodsId,
                                    @OldGoodsName,
                                    @OldTypeId,
                                    @OldTypeName,
                                    @OldTypeFullPath,
                                    @OldTypeFullName,
                                    @OldGoodsNo,
                                    @OldBrand,
                                    @OldSpecModel,
                                    @OldGWeight,
                                    @OldGrade,
                                    @OldPieceWeight,
                                    @OldPacking,
                                    @OldBatchNo,
                                    @OldLocation,
                                    @OldPackages,
                                    @OldTunnages,
                                    @OldPiles,
                                    @OldTenThousands,
                                    @OldProductionDate,
                                    @OldEnterWarehouseBillId 
                                )
                            if @@rowcount = 0
                            begin
                                raiserror (150369,18,1)
                                return -14
                            end
                        end
                        
                        delete from ShipmentBillGoods where Id = @OldShipmentBillGoodsId
                        if @@rowcount = 0
                        begin
                            raiserror (150382,18,1)
                            return -15
                        end
                    
                        fetch next from Cursor5 into 
                            @OldShipmentBillGoodsId,
                            @OldGoodsId,
                            @OldGoodsName,
                            @OldTypeId,
                            @OldTypeName,
                            @OldTypeFullPath,
                            @OldTypeFullName,
                            @OldGoodsNo,
                            @OldBrand,
                            @OldSpecModel,
                            @OldGWeight,
                            @OldGrade,
                            @OldPieceWeight,
                            @OldPacking,
                            @OldBatchNo,
                            @OldLocation,
                            @OldPackages,
                            @OldTunnages,
                            @OldPiles,
                            @OldTenThousands,
                            @OldProductionDate,
                            @OldEnterWarehouseBillId
                    end
                        
                    close Cursor5
                    deallocate Cursor5
                
                    /**/
                    set @ShipmentBillMerged = 1
                    
                    /**/
                    select @OutWarehouseBillId = Id from OutWarehouseBill where ShipmentBillId = @ShipmentBillId and PlanId = @OldPlanId
                    if @@rowcount = 0
                    begin
                        raiserror (150635,18,1)
                        return -16
                    end
                    
                    /**/
                    select @OldOutWarehouseBillId = Id, @OldForceFee = ForceFee from OutWarehouseBill where ShipmentBillId = @OldShipmentBillId and PlanId = @OldPlanId
                    if @@rowcount = 0
                    begin
                        raiserror (150636,18,1)
                        return -17
                    end
                    
                    /**/
                    update OutWarehouseBill set ForceFee = ForceFee + @OldForceFee where Id = @OutWarehouseBillId
                    if @@rowcount = 0
                    begin
                        raiserror (150398,18,1)
                        return -18
                    end
                    
                    /**/
                    delete from OutWarehouseBill where Id = @OldOutWarehouseBillId
                    if @@rowcount = 0
                    begin
                        raiserror (150555,18,1)
                        return -19
                    end
                    
                    /**/
                    declare Cursor6 cursor local for
                        select
                            Id,
                            GoodsId,
                            GoodsName,
                            TypeId,
                            TypeName,
                            TypeFullPath,
                            TypeFullName,
                            GoodsNo,
                            Brand,
                            SpecModel,
                            GWeight,
                            Grade,
                            PieceWeight,
                            Packing,
                            BatchNo,
                            Location,
                            Packages,
                            Tunnages,
                            Piles,
                            TenThousands,
                            ProductionDate,
                            EnterWarehouseBillId,
                            DeliveryNo
                        from 
                            OutWarehouseBillGoods 
                        where 
                            OutWarehouseBillId = @OldOutWarehouseBillId 
                        
                    open Cursor6
                    fetch next from Cursor6 into 
                        @OldOutWarehouseBillGoodsId,
                        @OldGoodsId,
                        @OldGoodsName,
                        @OldTypeId,
                        @OldTypeName,
                        @OldTypeFullPath,
                        @OldTypeFullName,
                        @OldGoodsNo,
                        @OldBrand,
                        @OldSpecModel,
                        @OldGWeight,
                        @OldGrade,
                        @OldPieceWeight,
                        @OldPacking,
                        @OldBatchNo,
                        @OldLocation,
                        @OldPackages,
                        @OldTunnages,
                        @OldPiles,
                        @OldTenThousands,
                        @OldProductionDate,
                        @OldEnterWarehouseBillId,
                        @OldDeliveryNo
                        
                    while @@fetch_status = 0
                    begin
                        if exists
                            (
                                select 
                                    * 
                                from 
                                    OutWarehouseBillGoods 
                                where 
                                    OutWarehouseBillId = @OutWarehouseBillId and 
                                    GoodsId = @OldGoodsId and 
                                    Packing = @OldPacking and 
                                    BatchNo = @OldBatchNo and 
                                    Location = @OldLocation and 
                                    ProductionDate = @OldProductionDate and 
                                    EnterWarehouseBillId = @OldEnterWarehouseBillId
                            )
                        begin
                            update OutWarehouseBillGoods set 
                                Packages = Packages + @OldPackages,
                                Tunnages = Tunnages + @OldTunnages,
                                Piles = Piles + @OldPiles,
                                TenThousands = TenThousands + @OldTenThousands
                            where 
                                OutWarehouseBillId = @OutWarehouseBillId and 
                                GoodsId = @OldGoodsId and 
                                Packing = @OldPacking and 
                                BatchNo = @OldBatchNo and 
                                Location = @OldLocation and 
                                ProductionDate = @OldProductionDate and 
                                EnterWarehouseBillId = @OldEnterWarehouseBillId
                            if @@rowcount = 0
                            begin
                                raiserror (150400,18,1)
                                return -20
                            end
                        end
                        else
                        begin
                            exec GetId @OpStaffId, @OutWarehouseBillGoodsId output 
                            insert into OutWarehouseBillGoods 
                                (
                                    Id,
                                    OutWarehouseBillId,
                                    GoodsId,
                                    GoodsName,
                                    TypeId,
                                    TypeName,
                                    TypeFullPath,
                                    TypeFullName,
                                    GoodsNo,
                                    Brand,
                                    SpecModel,
                                    GWeight,
                                    Grade,
                                    PieceWeight,
                                    Packing,
                                    BatchNo,
                                    Location,
                                    Packages,
                                    Tunnages,
                                    Piles,
                                    TenThousands,
                                    ProductionDate,
                                    EnterWarehouseBillId,
                                    DeliveryNo 
                                )
                            values
                                (
                                    @OutWarehouseBillGoodsId,
                                    @OutWarehouseBillId,
                                    @OldGoodsId,
                                    @OldGoodsName,
                                    @OldTypeId,
                                    @OldTypeName,
                                    @OldTypeFullPath,
                                    @OldTypeFullName,
                                    @OldGoodsNo,
                                    @OldBrand,
                                    @OldSpecModel,
                                    @OldGWeight,
                                    @OldGrade,
                                    @OldPieceWeight,
                                    @OldPacking,
                                    @OldBatchNo,
                                    @OldLocation,
                                    @OldPackages,
                                    @OldTunnages,
                                    @OldPiles,
                                    @OldTenThousands,
                                    @OldProductionDate,
                                    @OldEnterWarehouseBillId,
                                    @OldDeliveryNo
                                )
                            if @@rowcount = 0
                            begin
                                raiserror (150393,18,1)
                                return -21
                            end
                        end
                        
                        delete from OutWarehouseBillGoods where Id = @OldOutWarehouseBillGoodsId
                        if @@rowcount = 0
                        begin
                            raiserror (150554,18,1)
                            return -22
                        end
                    
                        fetch next from Cursor6 into 
                            @OldOutWarehouseBillGoodsId,
                            @OldGoodsId,
                            @OldGoodsName,
                            @OldTypeId,
                            @OldTypeName,
                            @OldTypeFullPath,
                            @OldTypeFullName,
                            @OldGoodsNo,
                            @OldBrand,
                            @OldSpecModel,
                            @OldGWeight,
                            @OldGrade,
                            @OldPieceWeight,
                            @OldPacking,
                            @OldBatchNo,
                            @OldLocation,
                            @OldPackages,
                            @OldTunnages,
                            @OldPiles,
                            @OldTenThousands,
                            @OldProductionDate,
                            @OldEnterWarehouseBillId,
                            @OldDeliveryNo
                    end
                        
                    close Cursor6
                    deallocate Cursor6
                    
                    /**/
                    declare Cursor7 cursor local for
                        select
                            Id,
                            StockId,
                            Packages,
                            Tunnages,
                            Piles,
                            TenThousands
                        from 
                            StockOutWarehouseDetail 
                        where 
                            OutWarehouseBillId = @OldOutWarehouseBillId 
                        
                    open Cursor7
                    fetch next from Cursor7 into 
                        @OldStockOutWarehouseDetailId,
                        @OldStockId,
                        @OldPackages,
                        @OldTunnages,
                        @OldPiles,
                        @OldTenThousands
                        
                    while @@fetch_status = 0
                    begin
                        if exists
                            (
                                select 
                                    * 
                                from 
                                    StockOutWarehouseDetail 
                                where 
                                    OutWarehouseBillId = @OutWarehouseBillId and 
                                    StockId = @OldStockId
                            )
                        begin
                            update StockOutWarehouseDetail set 
                                Packages = Packages + @OldPackages,
                                Tunnages = Tunnages + @OldTunnages,
                                Piles = Piles + @OldPiles,
                                TenThousands = TenThousands + @OldTenThousands
                            where 
                                OutWarehouseBillId = @OutWarehouseBillId and 
                                StockId = @OldStockId
                            if @@rowcount = 0
                            begin
                                raiserror (150637,18,1)
                                return -23
                            end
                        end
                        else
                        begin
                            exec GetId @OpStaffId, @StockOutWarehouseDetailId output 
                            insert into StockOutWarehouseDetail 
                                (
                                    Id,
                                    StockId,
                                    OutWarehouseBillId,
                                    Packages,
                                    Tunnages,
                                    Piles,
                                    TenThousands
                                )
                            values
                                (
                                    @StockOutWarehouseDetailId,
                                    @OldStockId,
                                    @OutWarehouseBillId,
                                    @OldPackages,
                                    @OldTunnages,
                                    @OldPiles,
                                    @OldTenThousands
                                )
                            if @@rowcount = 0
                            begin
                                raiserror (150420,18,1)
                                return -24
                            end
                        end
                        
                        delete from StockOutWarehouseDetail where Id = @OldStockOutWarehouseDetailId
                        if @@rowcount = 0
                        begin
                            raiserror (150422,18,1)
                            return -25
                        end
                    
                        fetch next from Cursor7 into 
                            @OldStockOutWarehouseDetailId,
                            @OldStockId,
                            @OldPackages,
                            @OldTunnages,
                            @OldPiles,
                            @OldTenThousands
                    end
                        
                    close Cursor7
                    deallocate Cursor7
                end
                
                /**/
                if exists(select * from DeliverBill where DispatchBillId = @OldId and PlanId = @OldPlanId)
                begin
                    /**/
                    select @DeliverBillId = Id from DeliverBill where DispatchBillId = @NewId and PlanId = @OldPlanId
                    if @@rowcount = 0
                    begin
                        raiserror (150638,18,1)
                        return -26
                    end
                    
                    /**/
                    select @OldDeliverBillId = Id from DeliverBill where DispatchBillId = @OldId and PlanId = @OldPlanId
                    if @@rowcount = 0
                    begin
                        raiserror (150639,18,1)
                        return -27
                    end
                    
                    /**/
                    delete from DeliverBill where DispatchBillId = @OldId and PlanId = @OldPlanId
                    if @@rowcount = 0
                    begin
                        raiserror (150640,18,1)
                        return -28
                    end
                    
                    /**/
                    declare Cursor8 cursor local for
                        select
                            Id,
                            GoodsId,
                            GoodsName,
                            TypeId,
                            TypeName,
                            TypeFullPath,
                            TypeFullName,
                            GoodsNo,
                            Brand,
                            SpecModel,
                            GWeight,
                            Grade,
                            PieceWeight,
                            Packing,
                            BatchNo,
                            Location,
                            Packages,
                            Tunnages,
                            Piles,
                            TenThousands,
                            ProductionDate,
                            EnterWarehouseBillId
                        from 
                            DeliverBillGoods 
                        where 
                            DeliverBillId = @OldDeliverBillId 
                        
                    open Cursor8
                    fetch next from Cursor8 into 
                        @OldDeliverBillGoodsId,
                        @OldGoodsId,
                        @OldGoodsName,
                        @OldTypeId,
                        @OldTypeName,
                        @OldTypeFullPath,
                        @OldTypeFullName,
                        @OldGoodsNo,
                        @OldBrand,
                        @OldSpecModel,
                        @OldGWeight,
                        @OldGrade,
                        @OldPieceWeight,
                        @OldPacking,
                        @OldBatchNo,
                        @OldLocation,
                        @OldPackages,
                        @OldTunnages,
                        @OldPiles,
                        @OldTenThousands,
                        @OldProductionDate,
                        @OldEnterWarehouseBillId
                        
                    while @@fetch_status = 0
                    begin
                        if exists
                            (
                                select 
                                    * 
                                from 
                                    DeliverBillGoods 
                                where 
                                    DeliverBillId = @DeliverBillId and 
                                    GoodsId = @OldGoodsId and 
                                    Packing = @OldPacking and 
                                    BatchNo = @OldBatchNo and 
                                    Location = @OldLocation and 
                                    ProductionDate = @OldProductionDate and 
                                    EnterWarehouseBillId = @OldEnterWarehouseBillId
                            )
                        begin
                            update DeliverBillGoods set 
                                Packages = Packages + @OldPackages,
                                Tunnages = Tunnages + @OldTunnages,
                                Piles = Piles + @OldPiles,
                                TenThousands = TenThousands + @OldTenThousands
                            where 
                                DeliverBillId = @DeliverBillId and 
                                GoodsId = @OldGoodsId and 
                                Packing = @OldPacking and 
                                BatchNo = @OldBatchNo and 
                                Location = @OldLocation and 
                                ProductionDate = @OldProductionDate and 
                                EnterWarehouseBillId = @OldEnterWarehouseBillId
                            if @@rowcount = 0
                            begin
                                raiserror (150418,18,1)
                                return -29
                            end
                        end
                        else
                        begin
                            exec GetId @OpStaffId, @DeliverBillGoodsId output 
                            insert into DeliverBillGoods 
                                (
                                    Id,
                                    DeliverBillId,
                                    GoodsId,
                                    GoodsName,
                                    TypeId,
                                    TypeName,
                                    TypeFullPath,
                                    TypeFullName,
                                    GoodsNo,
                                    Brand,
                                    SpecModel,
                                    GWeight,
                                    Grade,
                                    PieceWeight,
                                    Packing,
                                    BatchNo,
                                    Location,
                                    Packages,
                                    Tunnages,
                                    Piles,
                                    TenThousands,
                                    ProductionDate,
                                    EnterWarehouseBillId 
                                )
                            values
                                (
                                    @DeliverBillGoodsId,
                                    @DeliverBillId,
                                    @OldGoodsId,
                                    @OldGoodsName,
                                    @OldTypeId,
                                    @OldTypeName,
                                    @OldTypeFullPath,
                                    @OldTypeFullName,
                                    @OldGoodsNo,
                                    @OldBrand,
                                    @OldSpecModel,
                                    @OldGWeight,
                                    @OldGrade,
                                    @OldPieceWeight,
                                    @OldPacking,
                                    @OldBatchNo,
                                    @OldLocation,
                                    @OldPackages,
                                    @OldTunnages,
                                    @OldPiles,
                                    @OldTenThousands,
                                    @OldProductionDate,
                                    @OldEnterWarehouseBillId 
                                )
                            if @@rowcount = 0
                            begin
                                raiserror (150412,18,1)
                                return -30
                            end
                        end
                        
                        delete from DeliverBillGoods where Id = @OldDeliverBillGoodsId
                        if @@rowcount = 0
                        begin
                            raiserror (150419,18,1)
                            return -31
                        end
                    
                        fetch next from Cursor8 into 
                            @OldDeliverBillGoodsId,
                            @OldGoodsId,
                            @OldGoodsName,
                            @OldTypeId,
                            @OldTypeName,
                            @OldTypeFullPath,
                            @OldTypeFullName,
                            @OldGoodsNo,
                            @OldBrand,
                            @OldSpecModel,
                            @OldGWeight,
                            @OldGrade,
                            @OldPieceWeight,
                            @OldPacking,
                            @OldBatchNo,
                            @OldLocation,
                            @OldPackages,
                            @OldTunnages,
                            @OldPiles,
                            @OldTenThousands,
                            @OldProductionDate,
                            @OldEnterWarehouseBillId
                    end
                        
                    close Cursor8
                    deallocate Cursor8
                
                    /**/
                    set @DeliverBillMerged = 1
                    
                    /**/
                    if exists(select * from DeliverBillCustomerTransportPrice where DeliverBillId = @DeliverBillId)
                    begin
                        if exists(select * from DeliverBillCustomerTransportPrice where DeliverBillId = @OldDeliverBillId)
                        begin
                            select 
                                @OldTransportCharges = TransportCharges, 
                                @OldRemark = Remark 
                            from 
                                DeliverBillCustomerTransportPrice 
                            where 
                                DeliverBillId = @OldDeliverBillId
                            if @@rowcount = 0
                            begin
                                raiserror (150641,18,1)
                                return -32
                            end
                            
                            update DeliverBillCustomerTransportPrice set 
                                TransportCharges = TransportCharges + @OldTransportCharges, 
                                Remark = Remark + ', ' + @OldRemark 
                            where 
                                DeliverBillId = @DeliverBillId
                            if @@rowcount = 0
                            begin
                                raiserror (150642,18,1)
                                return -33
                            end
                        end
                    end
                    else
                    begin
                        if exists(select * from DeliverBillCustomerTransportPrice where DeliverBillId = @OldDeliverBillId)
                        begin
                            update DeliverBillCustomerTransportPrice set 
                                DeliverBillId = DeliverBillId 
                            where 
                                DeliverBillId = @OldDeliverBillId
                            if @@rowcount = 0
                            begin
                                raiserror (150642,18,1)
                                return -34
                            end
                        end
                    end
                end
            end
            
            fetch next from Cursor2 into 
                @OldPlanId,
                @OldPackages,
                @OldTunnages,
                @OldPiles,
                @OldTenThousands,
                @OldTransportChargeExpression,
                @OldTransportPriceExpression,
                @OldKM,
                @OldTransportPrice,
                @OldTransportCharges
        end
        
        close Cursor2
        deallocate Cursor2 
        
        /*3.3.*/
        delete from DispatchBill where Id = @OldId
        if @@rowcount = 0
        begin
            raiserror (150349,18,1)
            return -35
        end
        
        delete from DispatchBillDeliverPlan where DispatchBillId = @OldId
        if @@rowcount = 0
        begin
            raiserror (150351,18,1)
            return -36
        end
        
        delete from DispatchBillGoods where DispatchBillId = @OldId
        if @@rowcount = 0
        begin
            raiserror (150353,18,1)
            return -37
        end
        
        fetch next from Cursor1 into 
            @OldId, 
            @OldTotalPackages, 
            @OldTotalTunnages, 
            @OldTotalPiles, 
            @OldTotalTenThousands,
            @OldTotalTransportCharges
    end 
        
    close Cursor1
    deallocate Cursor1 
    
    /**/
    set @OpName = formatmessage(150631)
    set @OpParams = N'Ids=' + @Ids
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -38
    end
    
    return 0
end
go


create procedure ReturnDeliverPlan 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from DispatchBillDeliverPlan where PlanId = @Id)
    begin
        raiserror (150671,18,1)
        return -1
    end
    
    /**/
    update DeliverPlan set PlanState = formatmessage(150241) where Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150270,18,1)
        return -2
    end
    
    /**/
    select @OpName = formatmessage(150624)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure ReturnDispatchDeliverBill 
@DeliverBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @DispatchBillId bigint
declare @ContractId bigint
declare @ReverseId bigint
declare @ReverseAmount numeric(25,9)
declare @WithholdAmount numeric(25,9)
declare @FactpaymentAmount numeric(25,9)
declare @PlanId bigint
declare @OutWarehouseBillId bigint
declare @CreateTime datetime
declare @EnterWarehouseBillId bigint
declare @CustomerId bigint
declare @GoodsId bigint
declare @BatchNo nvarchar(20)
declare @Packing nvarchar(10)
declare @Warehouse nvarchar(20)
declare @Location nvarchar(10)
declare @Packages int
declare @Tunnages numeric(25,9)
declare @Piles numeric(25,9)
declare @TenThousands numeric(25,9)
declare @ProductionDate nvarchar(10)
declare @StockId bigint
declare @DeliveryNo nvarchar(20)
declare @ReturnTime datetime
declare @CustomerTransportChargesSettlementId bigint
declare @TransportCharges numeric(25,9)
declare @CarpoolFee numeric(25,9)
declare @CarrierTransportChargesSettlementId bigint
declare @Msg nvarchar(max)
declare @ErrText nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    set @Msg = ''

    /**************************************************************************************************************************************/
    /*1.*/
    select @DispatchBillId = DispatchBillId from DeliverBill where Id = @DeliverBillId
    if @@rowcount = 0
    begin
        raiserror (150703,18,1)
        return -1
    end
       
    /**************************************************************************************************************************************/
    /*2.*/
    if exists(select * from Contract where DispatchBillId = @DispatchBillId)
    begin
        select @ContractId = Id from Contract where DispatchBillId = @DispatchBillId
        if @@rowcount = 0
        begin
            raiserror (150692,18,1)
            return -2
        end
    
        /**/
        if exists(select * from ContractReverseDetail where ContractId = @ContractId)
        begin
            set @Msg = @Msg + formatmessage(150704)
        end
    
        /*2.1.*/
        delete from ContractApproveComment where ContractId = @ContractId
       
        /*2.2.*/
        delete from ContractDeliverPlan where ContractId = @ContractId
        delete from Contract where Id = @ContractId
    
        /*2.3.*/
        declare Cursor1 cursor local for 
            select ReverseId from ContractReverseDetail where ContractId = @ContractId
           
        open Cursor1
        fetch next from Cursor1 into @ReverseId
        while @@fetch_status = 0
        begin
            select 
                @ReverseAmount = ReverseAmount,
                @WithholdAmount = WithholdAmount,
                @FactpaymentAmount = FactpaymentAmount 
            from 
                ContractReverseDetail 
            where 
                ReverseId = @ReverseId and 
                ContractId = @ContractId 
            if @@rowcount = 0
            begin
                raiserror (150550,18,1)
                return -3
            end
                    
            update ContractReverse set 
                ReverseAmount = ReverseAmount - @ReverseAmount,
                WithholdAmount = WithholdAmount - @WithholdAmount,
                FactpaymentAmount = FactpaymentAmount - @FactpaymentAmount
            where 
                Id = @ReverseId
            if @@rowcount = 0
            begin
                raiserror (150552,18,1)
                return -4
            end
                    
            delete from ContractReverse where Id = @ReverseId and ReverseAmount = 0
            if @@error <> 0
            begin
                raiserror (150553,18,1)
                return -5
            end
                    
            fetch next from Cursor1 into @ReverseId
        end
                
        close Cursor1
        deallocate Cursor1
            
        delete from ContractReverseDetail where ContractId = @ContractId 
        if @@error <> 0
        begin
            raiserror (150551,18,1)
            return -6
        end
    end
    
    /**************************************************************************************************************************************/
    /*3.*/
    declare Cursor2 cursor local for 
        select PlanId from DispatchBillDeliverPlan where DispatchBillId = @DispatchBillId 
            
    open Cursor2
    fetch next from Cursor2 into @PlanId
    while @@fetch_status = 0
    begin
        /*3.1.*/
        if exists(select * from OutWarehouseBill where PlanId = @PlanId and ShipmentBillId in (select Id from ShipmentBill where DispatchBillId = @DispatchBillId))
        begin
            declare Cursor3 cursor local for 
                select Id, CreateTime from OutWarehouseBill where PlanId = @PlanId and ShipmentBillId in (select Id from ShipmentBill where DispatchBillId = @DispatchBillId)
            
            open Cursor3
            fetch next from Cursor3 into @OutWarehouseBillId, @CreateTime
            while @@fetch_status = 0
            begin
                /**/
                delete from OutWarehouseBillGoods where OutWarehouseBillId = @OutWarehouseBillId 
                if @@rowcount = 0
                begin
                    raiserror (150554,18,1)
                    return -7
                end
            
                /**/
                begin try
                    exec RestoreStock @OutWarehouseBillId, @CreateTime, @OpStaffId, @OpStaffName 
                end try
                begin catch
                    select @ErrText = error_message()
                    raiserror (@ErrText,18,1)
                    return -8
                end catch
            
                fetch next from Cursor3 into @OutWarehouseBillId, @CreateTime
            end
        
            close Cursor3
            deallocate Cursor3 
        
            /**/
            delete from OutWarehouseBill where PlanId = @PlanId and ShipmentBillId in (select Id from ShipmentBill where DispatchBillId = @DispatchBillId)
            if @@rowcount = 0
            begin
                raiserror (150555,18,1)
                return -9
            end
        end
    
        /*3.2.*/
        if exists(select * from EnterWarehouseBill where PlanId = @PlanId)
        begin
            declare Cursor4 cursor local for 
                select Id, CustomerId, Warehouse from EnterWarehouseBill where PlanId = @PlanId
            
            open Cursor4
            fetch next from Cursor4 into @EnterWarehouseBillId, @CustomerId, @Warehouse
            while @@fetch_status = 0
            begin
                /**/
                declare Cursor5 cursor local for 
                    select 
                        GoodsId, 
                        BatchNo, 
                        Packing,
                        Location, 
                        Packages, 
                        Tunnages,
                        Piles,
                        TenThousands,
                        ProductionDate
                    from 
                        EnterWarehouseBillGoods 
                    where 
                        EnterWarehouseBillId = @EnterWarehouseBillId
        
                open Cursor5
                fetch next from Cursor5 into 
                    @GoodsId, 
                    @BatchNo, 
                    @Packing,
                    @Location, 
                    @Packages, 
                    @Tunnages,
                    @Piles,
                    @TenThousands,
                    @ProductionDate
                
                while @@fetch_status = 0
                begin
                    /**/
                    select 
                        @StockId = Id 
                    from 
                        Stock 
                    where 
                        CustomerId = @CustomerId and
                        GoodsId = @GoodsId and 
                        BatchNo = @BatchNo and 
                        Packing = @Packing and
                        Warehouse = @Warehouse and
                        Location = @Location and 
                        Packages = @Packages and 
                        Tunnages = @Tunnages and 
                        Piles = @Piles and 
                        TenThousands = @TenThousands and 
                        ProductionDate = @ProductionDate and
                        EnterWarehouseBillId = @EnterWarehouseBillId
                    if @@rowcount = 0
                    begin
                        raiserror (150392,18,1)
                        return -10
                    end
    
                    delete from Stock where Id = @StockId
                    if @@rowcount = 0
                    begin
                        raiserror (150556,18,1)
                        return -11
                    end
    
                    /**/
                    delete from StockDaily where StockId = @StockId
                
                    fetch next from Cursor5 into 
                        @GoodsId, 
                        @BatchNo, 
                        @Packing,
                        @Location, 
                        @Packages, 
                        @Tunnages,
                        @Piles,
                        @TenThousands,
                        @ProductionDate
                end
            
                close Cursor5
                deallocate Cursor5
        
                /**/
                delete from EnterWarehouseBillGoods where EnterWarehouseBillId = @EnterWarehouseBillId 
                if @@rowcount = 0
                begin
                    raiserror (150408,18,1)
                    return -12
                end
            
                fetch next from Cursor4 into @EnterWarehouseBillId, @CustomerId, @Warehouse
            end
        
            close Cursor4
            deallocate Cursor4
        
            /**/
            delete from EnterWarehouseBill where PlanId = @PlanId 
            if @@rowcount = 0
            begin
                raiserror (150555,18,1)
                return -13
            end
        end
    
        /*3.3.*/
        if exists(select * from DeliverBill where PlanId = @PlanId and DispatchBillId = @DispatchBillId)
        begin
            declare Cursor6 cursor local for 
                select Id from DeliverBill where PlanId = @PlanId and DispatchBillId = @DispatchBillId
            
            open Cursor6
            fetch next from Cursor6 into @DeliverBillId
            while @@fetch_status = 0
            begin
                select @DeliveryNo = DeliveryNo, @ReturnTime = ReturnTime, @CustomerTransportChargesSettlementId = CustomerTransportChargesSettlementId from DeliverBill where Id = @DeliverBillId
                if @@rowcount = 0
                begin
                    raiserror (150415,18,1)
                    return -14
                end
                
                /**/
                if @ReturnTime is not null
                begin
                    set @Msg = @Msg + formatmessage(150705, @DeliveryNo)
                end
                
                /**/
                if @CustomerTransportChargesSettlementId is not null and @CustomerTransportChargesSettlementId > 0
                begin
                    set @Msg = @Msg + formatmessage(150706, @DeliveryNo)
                end
                
                /**/
                if exists(select * from CarrierTransportChargesSettlementDetail where DeliverBillId = @DeliverBillId)
                begin
                    set @Msg = @Msg + formatmessage(150707, @DeliveryNo)
                end
            
                /**/
                delete from DeliverBillGoods where DeliverBillId = @DeliverBillId 
                if @@rowcount = 0
                begin
                    raiserror (150426,18,1)
                    return -15
                end
            
                /**/
                delete from DeliverBillCustomerTransportPrice where DeliverBillId = @DeliverBillId 
                if @@error <> 0
                begin
                    raiserror (150557,18,1)
                    return -16
                end
            
                /**/
                delete from DeliverBillCarrierTransportPrice where DeliverBillId = @DeliverBillId 
                if @@error <> 0
                begin
                    raiserror (150697,18,1)
                    return -17
                end
            
                /**/
                declare Cursor7 cursor local for 
                    select CustomerTransportChargesSettlementId, TransportCharges, CarpoolFee from CustomerTransportChargesSettlementDetail where DeliverBillId = @DeliverBillId
            
                open Cursor7
                fetch next from Cursor7 into @CustomerTransportChargesSettlementId, @TransportCharges, @CarpoolFee
                while @@fetch_status = 0
                begin
                    update CustomerTransportChargesSettlement set InvoiceAmount = InvoiceAmount - @TransportCharges - @CarpoolFee where Id = @CustomerTransportChargesSettlementId
                    if @@rowcount = 0
                    begin
                        raiserror (150485,18,1)
                        return -18
                    end
                    
                    delete from CustomerTransportChargesSettlement where Id = @CustomerTransportChargesSettlementId and InvoiceAmount = 0
                    if @@error <> 0
                    begin
                        raiserror (150559,18,1)
                        return -19
                    end
                    
                    fetch next from Cursor7 into @CustomerTransportChargesSettlementId, @TransportCharges, @CarpoolFee
                end
                
                close Cursor7
                deallocate Cursor7
            
                delete from CustomerTransportChargesSettlementDetail where DeliverBillId = @DeliverBillId 
                if @@error <> 0
                begin
                    raiserror (150558,18,1)
                    return -20
                end
            
                /**/
                declare Cursor8 cursor local for 
                    select CarrierTransportChargesSettlementId, TransportCharges from CarrierTransportChargesSettlementDetail where DeliverBillId = @DeliverBillId
            
                open Cursor8
                fetch next from Cursor8 into @CarrierTransportChargesSettlementId, @TransportCharges
                while @@fetch_status = 0
                begin
                    update CarrierTransportChargesSettlement set 
                        SettlementAmount = SettlementAmount - @TransportCharges,
                        FactpaymentAmount =  SettlementAmount - @TransportCharges - WithholdAmount
                    where 
                        Id = @CarrierTransportChargesSettlementId
                    if @@rowcount = 0
                    begin
                        raiserror (150560,18,1)
                        return -21
                    end
                    
                    delete from CarrierTransportChargesSettlement where Id = @CarrierTransportChargesSettlementId and SettlementAmount = 0
                    if @@error <> 0
                    begin
                        raiserror (150561,18,1)
                        return -22
                    end
                    
                    fetch next from Cursor8 into @CarrierTransportChargesSettlementId, @TransportCharges
                end
                
                close Cursor8
                deallocate Cursor8
            
                delete from CarrierTransportChargesSettlementDetail where DeliverBillId = @DeliverBillId 
                if @@error <> 0
                begin
                    raiserror (150562,18,1)
                    return -23
                end
            
                fetch next from Cursor6 into @DeliverBillId
            end
        
            close Cursor6
            deallocate Cursor6
        
            /**/
            delete from DeliverBill where PlanId = @PlanId and DispatchBillId = @DispatchBillId
            if @@rowcount = 0
            begin
                raiserror (150424,18,1)
                return -24
            end
        end
    
        /*3.4.*/
        if exists(select * from ShipmentBill where PlanId = @PlanId and DispatchBillId = @DispatchBillId)
        begin
            delete from ShipmentBillGoods where ShipmentBillId in (select Id from ShipmentBill where PlanId = @PlanId and DispatchBillId = @DispatchBillId)
            if @@rowcount = 0
            begin
                raiserror (150382,18,1)
                return -25
            end
        
            delete from ShipmentBill where PlanId = @PlanId and DispatchBillId = @DispatchBillId
            if @@rowcount = 0
            begin
                raiserror (150563,18,1)
                return -26
            end
        end
        
        fetch next from Cursor2 into @PlanId
    end 
        
    close Cursor2
    deallocate Cursor2
    
    
    /**************************************************************************************************************************************/
    /*4.*/
    update DispatchBill set BillState = formatmessage(150241) where Id = @DispatchBillId and BillState = formatmessage(150242)
    if @@rowcount = 0
    begin
        raiserror (150367,18,1)
        return -27
    end
    
    
    /**/
    select @OpName = formatmessage(150708)
    select @OpParams = N'DeliverBillId=' + convert(nvarchar,@DeliverBillId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -28
    end
    
    print @Msg
    
    return 0
end
go


create procedure ReturnModifyContract 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @TotalTransportCharges numeric(25,9)
declare @DispatchBillId bigint
declare @PlanId bigint
declare @TransportPrice numeric(25,9)
declare @TransportCharges numeric(25,9)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @TotalTransportCharges = isnull(sum(TransportCharges),0.0) from ContractDeliverPlan where ContractId = @Id 
    
    /**/
    update ContractDeliverPlan set ApprovedTransportPrice = null, ApprovedTransportCharges = null where ContractId = @Id 

    if @@rowcount = 0
    begin
        raiserror (150156,18,1)
        return -1
    end
    
    /**/
    update Contract set 
        TotalTransportCharges = @TotalTransportCharges,
        ResidualTransportCharges = @TotalTransportCharges - isnull(PrepayTransportCharges, 0.00),
        ContractState = formatmessage(150241),
        PrintState = 0,
        ApproveState = null,
        ApproveFlowStepNum = null,
        ApproveFlowStepName = null,
        ApproverId = null,
        ApproverName = null
    where 
        Id = @Id and 
		IsPrestowage = 1
        
    if @@rowcount = 0
    begin
        raiserror (150154,18,1)
        return -2
    end
    
    /**/
    select @DispatchBillId = DispatchBillId from Contract where Id = @Id and IsPrestowage = 1
    if @@rowcount = 0
    begin
        raiserror (150142,18,1)
        return -3
    end
   
    /**/
    declare Cursor1 cursor local for 
        select PlanId, TransportPrice, TransportCharges from ContractDeliverPlan where ContractId = @Id 
            
    open Cursor1
    fetch next from Cursor1 into @PlanId, @TransportPrice, @TransportCharges
    while @@fetch_status = 0
    begin
		update DispatchBillDeliverPlan set TransportPrice = @TransportPrice, TransportCharges = @TransportCharges where DispatchBillId = @DispatchBillId and PlanId = @PlanId
		if @@rowcount = 0
        begin
            raiserror (150359,18,1)
            return -4
        end
        
        fetch next from Cursor1 into @PlanId, @TransportPrice, @TransportCharges
    end 
        
    close Cursor1
    deallocate Cursor1 
   
    /**/
    update DispatchBill set TotalTransportCharges = @TotalTransportCharges where Id = @DispatchBillId 
    if @@rowcount = 0
    begin
        raiserror (150315,18,1)
        return -5
    end
    
    
    /**/
    select @OpName = formatmessage(150541)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -6
    end
    
    return 0
end
go


create procedure SubmitContract 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    update Contract set ContractState = formatmessage(150242) where Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150154,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150436)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure SubmitDeliverPlan 
@Id bigint,
@IsAgreed bit,
@ApproveComment nvarchar(200),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @CreatorId bigint
declare @CustomerId bigint
declare @PlanType nvarchar(10)
declare @Warehouse nvarchar(20)
declare @ConsignedDeliveryNo nvarchar(20)
declare @CurrentDisposeFlowStepNum int 
declare @ApproveId bigint
declare @GoodsId bigint
declare @GoodsNo nvarchar(20)
declare @BatchNo nvarchar(20)
declare @Packing nvarchar(10)
declare @Location nvarchar(10)
declare @Packages int 
declare @Tunnages numeric(25,9) 
declare @Piles numeric(25,9)
declare @ProductionDate nvarchar(10)
declare @EnterWarehouseBillId bigint
declare @StockTunnages numeric(25,9)
declare @StockPiles numeric(25,9)
declare @ErrText nvarchar(max)
declare @AccountType nvarchar(20)
declare @WarningStock int 
declare @StopStock int
declare @StepName nvarchar(50)
declare @StepNum int 
declare @DisposerId bigint
declare @DisposerName nvarchar(50)
declare @MaxApproveTime datetime
declare @LastIsAgreed bit 
declare @LastStepNum int 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @CreatorId = CreatorId, 
        @CustomerId = CustomerId, 
        @PlanType = PlanType, 
        @Warehouse = Warehouse, 
        @ConsignedDeliveryNo = ConsignedDeliveryNo, 
        @CurrentDisposeFlowStepNum = isnull(DisposeFlowStepNum,0) 
    from 
        DeliverPlan 
    where 
        Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150251,18,1)
        return -1
    end
    
    /*1.*/
    if @PlanType = formatmessage(150256) or @PlanType = formatmessage(150257)
    begin
        /*1.1.0*/
        if @CurrentDisposeFlowStepNum is null or @CurrentDisposeFlowStepNum = 0
        begin
            /**/
            select @AccountType = AccountType from Account where Id = @CreatorId 
            if @@rowcount = 0
            begin
                raiserror (150005,18,1)
                return -2
            end
    
            /*1.1.1.*/
            if @AccountType = formatmessage(150163)
            begin
                update DeliverPlan set PlanState = formatmessage(150296) where Id = @Id
                if @@rowcount = 0
                begin
                    raiserror (150292,18,1)
                    return -3
                end
            end
            else
            begin
                /*1.1.2.*/
                declare CheckStock_Cursor cursor local for 
                    select 
                        GoodsId, 
                        GoodsNo, 
                        BatchNo, 
                        Packing, 
                        Location, 
                        Packages, 
                        Piles, 
                        ProductionDate, 
                        EnterWarehouseBillId 
                    from 
                        DeliverPlanGoods 
                    where 
                        PlanId = @Id 
                    
                open CheckStock_Cursor
                
                fetch next from CheckStock_Cursor into 
                    @GoodsId, 
                    @GoodsNo, 
                    @BatchNo, 
                    @Packing, 
                    @Location, 
                    @Packages, 
                    @Piles, 
                    @ProductionDate, 
                    @EnterWarehouseBillId
                    
                while @@fetch_status = 0
                begin
                    begin try
                        exec CheckStock 
                        @CustomerId, 
                        @PlanType, 
                        @GoodsId, 
                        @GoodsNo, 
                        @BatchNo, 
                        @Packing, 
                        @Warehouse, 
                        @Location, 
                        @ProductionDate, 
                        @EnterWarehouseBillId, 
                        @ConsignedDeliveryNo,
                        @Packages,
                        @Piles,
                        @OpStaffId, 
                        @OpStaffName 
                    end try
                    begin catch
                        select @ErrText = error_message()
                        raiserror (@ErrText,18,1)
                        return -4
                    end catch
                
                    fetch next from CheckStock_Cursor into 
                        @GoodsId, 
                        @GoodsNo, 
                        @BatchNo, 
                        @Packing, 
                        @Location, 
                        @Packages, 
                        @Piles, 
                        @ProductionDate, 
                        @EnterWarehouseBillId
                end
                close CheckStock_Cursor
                deallocate CheckStock_Cursor
        
                /*1.1.3.*/
                select @WarningStock = WarningStock, @StopStock = StopStock from Customer where Id = @CustomerId 
                if @@rowcount = 0
                begin
                    set @WarningStock = 0
                    set @StopStock = 0
                end
                
                exec GetTotalStock @CustomerId, @Warehouse, @StockTunnages output, @StockPiles output, @OpStaffId, @OpStaffName
            
                select @Tunnages = isnull(sum(Tunnages), 0), @Piles = isnull(sum(Piles), 0) from DeliverPlanGoods where PlanId = @Id 
                
                /*1.1.4.*/
                if (@PlanType = formatmessage(150256) and (@StockTunnages - @Tunnages) < @StopStock) or (@PlanType = formatmessage(150257) and (@StockPiles - @Piles) < @StopStock)
                begin
                    /**/
                    select @MaxApproveTime = isnull(max(ApproveTime),getdate()) from DeliverPlanApproveComment where PlanId = @Id and StepNum > 0
                    select @LastIsAgreed = IsAgreed, @LastStepNum = StepNum from DeliverPlanApproveComment where ApproveTime = @MaxApproveTime and PlanId = @Id 
                    if @@rowcount > 0
                    begin
                        if @LastIsAgreed = 0 set @CurrentDisposeFlowStepNum = @LastStepNum - 1 
                    end
        
                    /**/
                    select top (1) @StepName = StepName, @StepNum = StepNum, @DisposerId = DisposerId, @DisposerName = DisposerName from ApproveFlowStep where FlowType = formatmessage(150284) and StepNum > @CurrentDisposeFlowStepNum order by StepNum
                    if @@rowcount = 0
                    begin
                        /**/
                        update DeliverPlan set PlanState = formatmessage(150242), DisposeFlowStepNum = null, DisposeFlowStepName = null, DisposerId = null, DisposerName = null where Id = @Id
                        if @@rowcount = 0
                        begin
                            raiserror (150291,18,1)
                            return -5
                        end
                    end
                    else
                    begin
                        update DeliverPlan set PlanState = formatmessage(150283), DisposeFlowStepNum = @StepNum, DisposeFlowStepName = @StepName, DisposerId = @DisposerId, DisposerName = @DisposerName where Id = @Id
                        if @@rowcount = 0
                        begin
                            raiserror (150290,18,1)
                            return -6
                        end
                        
                        /**/
                        select @ErrText = formatmessage(150519, @DisposerName)
                        raiserror (@ErrText,0,1)
                    end
                end
                else 
                begin
                    /**/
                    update DeliverPlan set PlanState = formatmessage(150242), DisposeFlowStepNum = null, DisposeFlowStepName = null, DisposerId = null, DisposerName = null where Id = @Id
                    if @@rowcount = 0
                    begin
                        raiserror (150291,18,1)
                        return -7
                    end
                
                    /**/
                    if (@PlanType = formatmessage(150256) and (@StockTunnages - @Tunnages) < @WarningStock) or (@PlanType = formatmessage(150257) and (@StockPiles - @Piles) < @WarningStock)
                    begin
                        raiserror (150289,0,1)
                    end
                end
            end
        end
        else
        begin
            /*1.2.0*/
            exec GetId @OpStaffId, @ApproveId output 
        
            insert into DeliverPlanApproveComment 
                (Id, PlanId, ApproverId, ApproverName, IsAgreed, ApproveComment, ApproveTime, StepNum)
            values 
                (@ApproveId, @Id, @OpStaffId, @OpStaffName, @IsAgreed, @ApproveComment, getdate(), @CurrentDisposeFlowStepNum)
            if @@rowcount = 0
            begin
                raiserror (150288,18,1)
                return -8
            end
    
            /*1.3.*/
            if @IsAgreed = 0
            begin
                update DeliverPlan set PlanState = formatmessage(150241), DisposeFlowStepNum = 0, DisposeFlowStepName = N'', DisposerId = 0, DisposerName = N'' where Id = @Id
                if @@rowcount = 0
                begin
                    raiserror (150293,18,1)
                    return -9
                end
            end
            else
            begin
                /*1.4.*/
                select @MaxApproveTime = isnull(max(ApproveTime),getdate()) from DeliverPlanApproveComment where PlanId = @Id and StepNum > 0
                select @LastIsAgreed = IsAgreed, @LastStepNum = StepNum from DeliverPlanApproveComment where ApproveTime = @MaxApproveTime and PlanId = @Id 
                if @@rowcount > 0
                begin
                    if @LastIsAgreed = 0 set @CurrentDisposeFlowStepNum = @LastStepNum - 1 
                end
        
                /**/
                select top (1) @StepName = StepName, @StepNum = StepNum, @DisposerId = DisposerId, @DisposerName = DisposerName from ApproveFlowStep where FlowType = formatmessage(150284) and StepNum > @CurrentDisposeFlowStepNum order by StepNum
                if @@rowcount = 0
                begin
                    /*1.5.*/
                    update DeliverPlan set PlanState = formatmessage(150242), DisposeFlowStepNum = null, DisposeFlowStepName = null, DisposerId = null, DisposerName = null where Id = @Id
                    if @@rowcount = 0
                    begin
                        raiserror (150291,18,1)
                        return -10
                    end
                end
                else
                begin
                    update DeliverPlan set PlanState = formatmessage(150283), DisposeFlowStepNum = @StepNum, DisposeFlowStepName = @StepName, DisposerId = @DisposerId, DisposerName = @DisposerName where Id = @Id
                    if @@rowcount = 0
                    begin
                        raiserror (150290,18,1)
                        return -11
                    end
                    
                    /**/
                    select @ErrText = formatmessage(150519, @DisposerName)
                    raiserror (@ErrText,0,1)
                end
            end
        end
    end
    /*2.*/
    else if @PlanType = formatmessage(150518)
    begin
        /*2.1.0*/
        if @CurrentDisposeFlowStepNum is null or @CurrentDisposeFlowStepNum = 0
        begin
            /**/
            select @AccountType = AccountType from Account where Id = @CreatorId 
            if @@rowcount = 0
            begin
                raiserror (150005,18,1)
                return -12
            end
    
            /**/
            if @AccountType = formatmessage(150163)
            begin
                update DeliverPlan set PlanState = formatmessage(150296) where Id = @Id
                if @@rowcount = 0
                begin
                    raiserror (150292,18,1)
                    return -13
                end
            end
            else
            begin
                update DeliverPlan set PlanState = formatmessage(150242), DisposeFlowStepNum = null, DisposeFlowStepName = null, DisposerId = null, DisposerName = null where Id = @Id
                if @@rowcount = 0
                begin
                    raiserror (150291,18,1)
                    return -14
                end
            end
        end
    end
    else
    begin
        /*3.*/
        update DeliverPlan set PlanState = formatmessage(150242), DisposeFlowStepNum = null, DisposeFlowStepName = null, DisposerId = null, DisposerName = null where Id = @Id
        if @@rowcount = 0
        begin
            raiserror (150291,18,1)
            return -15
        end
    end
    
    
    /**/
    select @OpName = formatmessage(150271)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -16
    end
    
    return 0
end
go


create procedure SubmitDispatchBill 
@Id bigint,
@ContractId bigint output,/**/
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @CreatorName nvarchar(20)
declare @CreateOrganId bigint
declare @CreateOrganName nvarchar(50)
declare @CreateTime datetime
declare @CarNo nvarchar(20)
declare @TrailerNo nvarchar(10)
declare @CarType nvarchar(10)
declare @DriverName nvarchar(20)
declare @DriverLicenseNo nvarchar(20)
declare @DriverMobileTel nvarchar(20)
declare @DriverHomeTel nvarchar(20)
declare @CarrierId bigint
declare @CarrierName nvarchar(50)
declare @TotalPackages int
declare @TotalTunnages numeric(25,9)
declare @TotalPiles numeric(25,9)
declare @TotalTenThousands numeric(25,9)
declare @TotalTransportCharges numeric(25,9)
declare @PlanId bigint
declare @PlanType nvarchar(10)
declare @CustomerId bigint
declare @CustomerName nvarchar(50)
declare @DeliveryNo nvarchar(20)
declare @OutType nvarchar(10)
declare @ReceiverName nvarchar(50)
declare @ReceiverCountry nvarchar(20)
declare @ReceiverProvince nvarchar(20)
declare @ReceiverCity nvarchar(20)
declare @ReceiverAddress nvarchar(50)
declare @ReceiverContact nvarchar(20)
declare @ReceiverContactTel nvarchar(20)
declare @ReceiveType nvarchar(10)
declare @Warehouse nvarchar(20)
declare @ShipmentBillId bigint
declare @ShipmentBillNo nvarchar(20)
declare @ShipmentBillState nvarchar(10)
declare @GoodsId bigint
declare @GoodsName nvarchar(500)
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @GoodsNo nvarchar(20)
declare @Brand nvarchar(20)
declare @SpecModel nvarchar(50)
declare @GWeight nvarchar(20)
declare @Grade nvarchar(10)
declare @PieceWeight numeric(25,9)
declare @Packing nvarchar(10)
declare @BatchNo nvarchar(20)
declare @Location nvarchar(10)
declare @Packages int
declare @Tunnages numeric(25,9)
declare @Piles numeric(25,9)
declare @TenThousands numeric(25,9)
declare @ProductionDate nvarchar(10)
declare @EnterWarehouseBillId bigint
declare @ShipmentBillGoodsId bigint
declare @DeliverBillId bigint
declare @DeliverBillNo nvarchar(20)
declare @DeliverBillGoodsId bigint
declare @DeliveryCompleted bit
declare @DeliverPackages int
declare @StartPlace nvarchar(20)
declare @DestPlace nvarchar(200)
declare @ContractId1 bigint
declare @TransportChargeExpression nvarchar(100)
declare @TransportPriceExpression nvarchar(100)
declare @KM int
declare @TransportPrice numeric(25,9)
declare @TransportCharges numeric(25,9)
declare @Remark nvarchar(500)
declare @ErrText nvarchar(500)
declare @ShipmentTime datetime
declare @ArrivalTime datetime
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @CreatorName = StaffName, 
        @CreateOrganId = OrganId, 
        @CreateOrganName = OrganFullName 
    from 
        Account 
    where 
        Id = @OpStaffId 
    if @@rowcount = 0
    begin
        raiserror (150004,18,1)
        return -1
    end
    
    /**/
    select 
        @CarNo = CarNo, 
        @TrailerNo = TrailerNo, 
        @CarType = CarType,
        @DriverName = DriverName,
        @DriverLicenseNo = DriverLicenseNo,
        @DriverMobileTel = DriverMobileTel,
        @DriverHomeTel = DriverHomeTel,
        @CarrierId = CarrierId, 
        @CarrierName = CarrierName, 
        @CreateTime = CreateTime,
        @TotalPackages = TotalPackages,
        @TotalTunnages = TotalTunnages,
        @TotalPiles = TotalPiles,
        @TotalTenThousands = TotalTenThousands,
        @TotalTransportCharges = TotalTransportCharges
    from 
        DispatchBill 
    where 
        Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150319,18,1)
        return -2
    end
    
    /**/
    declare Cursor1 cursor local for 
        select PlanId from DispatchBillDeliverPlan where DispatchBillId = @Id 

    open Cursor1
    fetch next from Cursor1 into @PlanId 
    while @@fetch_status = 0
    begin
        select 
            @PlanType = PlanType,
            @CustomerId = CustomerId, 
            @CustomerName = CustomerName, 
            @DeliveryNo = DeliveryNo, 
            @OutType = DeliverType, 
            @ReceiverName = ReceiverName, 
            @ReceiverCountry = ReceiverCountry, 
            @ReceiverProvince = ReceiverProvince, 
            @ReceiverCity = ReceiverCity, 
            @ReceiverAddress = ReceiverAddress, 
            @ReceiverContact = ReceiverContact, 
            @ReceiverContactTel = ReceiverContactTel, 
            @ReceiveType = ReceiveType, 
            @Warehouse = Warehouse 
        from 
            DeliverPlan 
        where 
            Id = @PlanId 
            
        if @@rowcount = 0
        begin
            raiserror (150251,18,1)
            return -3
        end
        
        /**/
        if @PlanType = formatmessage(150256) or @PlanType = formatmessage(150257)
        begin
            if @OutType = formatmessage(150305)
            begin
                /**/
                exec GetId @OpStaffId, @ShipmentBillId output 
    
                /**/
                exec GetNo N'ShipmentBill', @ShipmentBillNo output
                set @ShipmentBillNo = N'C' + @ShipmentBillNo 
    
                /**/
                set @ShipmentBillState = formatmessage(150241)
        
                /**/
                insert into ShipmentBill 
                (
                    Id,
                    BillNo,
                    DispatchBillId,
                    PlanId,
                    CustomerId,
                    CustomerName,
                    DeliveryNo,
                    OutType,
                    ReceiverName,
                    ReceiverCountry,
                    ReceiverProvince,
                    ReceiverCity,
                    ReceiverAddress,
                    ReceiverContact,
                    ReceiverContactTel,
                    ReceiveType,
                    CarNo,
                    TrailerNo,
                    CarrierId,
                    CarrierName,
                    Warehouse,
                    CreatorId,
                    CreatorName,
                    CreateOrganId,
                    CreateOrganName,
                    CreateTime,
                    OwnOrganId,
                    OwnOrganName,
                    BillState,
                    PrintState
                )
                values 
                (
                    @ShipmentBillId,
                    @ShipmentBillNo,
                    @Id,
                    @PlanId,
                    @CustomerId,
                    @CustomerName,
                    @DeliveryNo,
                    @OutType,
                    @ReceiverName,
                    @ReceiverCountry,
                    @ReceiverProvince,
                    @ReceiverCity,
                    @ReceiverAddress,
                    @ReceiverContact,
                    @ReceiverContactTel,
                    @ReceiveType,
                    @CarNo,
                    @TrailerNo,
                    @CarrierId,
                    @CarrierName,
                    @Warehouse,
                    @OpStaffId,
                    @CreatorName,
                    @CreateOrganId,
                    @CreateOrganName,
                    @CreateTime,
                    @CreateOrganId,
                    @CreateOrganName,
                    @ShipmentBillState,
                    0
                )
                if @@rowcount = 0
                begin
                    raiserror (150368,18,1)
                    return -4
                end
            
                /**/
                declare Cursor2 cursor local for 
                    select 
                        GoodsId, 
                        GoodsName, 
                        TypeId, 
                        TypeName, 
                        TypeFullPath, 
                        TypeFullName, 
                        GoodsNo, 
                        Brand, 
                        SpecModel, 
                        GWeight, 
                        Grade, 
                        PieceWeight, 
                        Packing, 
                        BatchNo, 
                        Location, 
                        Packages, 
                        Tunnages,
                        Piles,
                        TenThousands,
                        ProductionDate,
                        EnterWarehouseBillId 
                    from 
                        DispatchBillGoods 
                    where 
                        DispatchBillId = @Id and 
                        PlanId = @PlanId 
            
                open Cursor2
                fetch next from Cursor2 into 
                    @GoodsId, 
                    @GoodsName, 
                    @TypeId, 
                    @TypeName, 
                    @TypeFullPath, 
                    @TypeFullName, 
                    @GoodsNo, 
                    @Brand, 
                    @SpecModel, 
                    @GWeight, 
                    @Grade, 
                    @PieceWeight, 
                    @Packing, 
                    @BatchNo, 
                    @Location, 
                    @Packages, 
                    @Tunnages,
                    @Piles,
                    @TenThousands,
                    @ProductionDate,
                    @EnterWarehouseBillId
                    
                while @@fetch_status = 0
                begin
                    /**/
                    exec GetId @OpStaffId, @ShipmentBillGoodsId output 
            
                    /**/
                    insert into ShipmentBillGoods 
                    (
                        Id,
                        ShipmentBillId,
                        GoodsId,
                        GoodsName,
                        TypeId,
                        TypeName,
                        TypeFullPath,
                        TypeFullName,
                        GoodsNo,
                        Brand,
                        SpecModel,
                        GWeight,
                        Grade,
                        PieceWeight,
                        Packing,
                        BatchNo,
                        Location,
                        Packages,
                        Tunnages,
                        Piles,
                        TenThousands,
                        ProductionDate,
                        EnterWarehouseBillId
                    )
                    values 
                    (
                        @ShipmentBillGoodsId,
                        @ShipmentBillId,
                        @GoodsId,
                        @GoodsName,
                        @TypeId,
                        @TypeName,
                        @TypeFullPath,
                        @TypeFullName,
                        @GoodsNo,
                        @Brand,
                        @SpecModel,
                        @GWeight,
                        @Grade,
                        @PieceWeight,
                        @Packing,
                        @BatchNo,
                        @Location,
                        @Packages,
                        @Tunnages,
                        @Piles,
                        @TenThousands,
                        @ProductionDate,
                        @EnterWarehouseBillId
                    )
                    if @@rowcount = 0
                    begin
                        raiserror (150369,18,1)
                        return -5
                    end
            
                    fetch next from Cursor2 into 
                        @GoodsId, 
                        @GoodsName, 
                        @TypeId, 
                        @TypeName, 
                        @TypeFullPath, 
                        @TypeFullName, 
                        @GoodsNo, 
                        @Brand, 
                        @SpecModel, 
                        @GWeight, 
                        @Grade, 
                        @PieceWeight, 
                        @Packing, 
                        @BatchNo, 
                        @Location, 
                        @Packages, 
                        @Tunnages,
                        @Piles,
                        @TenThousands,
                        @ProductionDate,
                        @EnterWarehouseBillId
                end
        
                close Cursor2
                deallocate Cursor2 
            end
        end
        else
        begin
            /**/
            exec GetId @OpStaffId, @DeliverBillId output 
    
            exec GetNo N'DeliverBill', @DeliverBillNo output
            set @DeliverBillNo = N'S' + @DeliverBillNo 
        
            insert into DeliverBill 
                (
                    Id,
                    BillNo,
                    ShipmentBillId,
                    DispatchBillId,
                    PlanId,
                    CustomerId,
                    CustomerName,
                    DeliveryNo,
                    ReceiverName,
                    ReceiverCountry,
                    ReceiverProvince,
                    ReceiverCity,
                    ReceiverAddress,
                    ReceiverContact,
                    ReceiverContactTel,
                    CarNo,
                    TrailerNo,
                    CarrierId,
                    CarrierName,
                    Warehouse,
                    CreatorId,
                    CreatorName,
                    CreateOrganId,
                    CreateOrganName,
                    CreateTime,
                    OwnOrganId,
                    OwnOrganName,
                    PrintState
                )
            values 
                (
                    @DeliverBillId,
                    @DeliverBillNo,
                    0,
                    @Id,
                    @PlanId,
                    @CustomerId,
                    @CustomerName,
                    @DeliveryNo,
                    @ReceiverName,
                    @ReceiverCountry,
                    @ReceiverProvince,
                    @ReceiverCity,
                    @ReceiverAddress,
                    @ReceiverContact,
                    @ReceiverContactTel,
                    @CarNo,
                    @TrailerNo,
                    @CarrierId,
                    @CarrierName,
                    @Warehouse,
                    @OpStaffId,
                    @OpStaffName,
                    @CreateOrganId,
                    @CreateOrganName,
                    @CreateTime,
                    @CreateOrganId,
                    @CreateOrganName,
                    1 /**/
                )
            if @@rowcount = 0
            begin
                raiserror (150411,18,1)
                return -6
            end
        
            /**/
            declare Cursor3 cursor local for 
                select 
                    GoodsId, 
                    GoodsName, 
                    TypeId, 
                    TypeName, 
                    TypeFullPath, 
                    TypeFullName, 
                    GoodsNo, 
                    Brand, 
                    SpecModel, 
                    GWeight, 
                    Grade, 
                    PieceWeight, 
                    Packing, 
                    BatchNo, 
                    Location, 
                    Packages, 
                    Tunnages, 
                    Piles, 
                    TenThousands,
                    ProductionDate,
                    EnterWarehouseBillId
                from 
                    DispatchBillGoods 
                where 
                    DispatchBillId = @Id and 
                    PlanId = @PlanId 
            
            open Cursor3
            fetch next from Cursor3 into 
                @GoodsId, 
                @GoodsName, 
                @TypeId, 
                @TypeName, 
                @TypeFullPath, 
                @TypeFullName, 
                @GoodsNo, 
                @Brand, 
                @SpecModel, 
                @GWeight, 
                @Grade, 
                @PieceWeight, 
                @Packing, 
                @BatchNo, 
                @Location, 
                @Packages, 
                @Tunnages, 
                @Piles, 
                @TenThousands,
                @ProductionDate,
                @EnterWarehouseBillId
                
            while @@fetch_status = 0
            begin
                exec GetId @OpStaffId, @DeliverBillGoodsId output 
            
                insert into DeliverBillGoods 
                    (
                        Id,
                        DeliverBillId,
                        GoodsId,
                        GoodsName,
                        TypeId,
                        TypeName,
                        TypeFullPath,
                        TypeFullName,
                        GoodsNo,
                        Brand,
                        SpecModel,
                        GWeight,
                        Grade,
                        PieceWeight,
                        Packing,
                        BatchNo,
                        Location,
                        Packages,
                        Tunnages,
                        Piles,
                        TenThousands,
                        ProductionDate,
                        EnterWarehouseBillId
                    )
                    values 
                    (
                        @DeliverBillGoodsId,
                        @DeliverBillId,
                        @GoodsId,
                        @GoodsName,
                        @TypeId,
                        @TypeName,
                        @TypeFullPath,
                        @TypeFullName,
                        @GoodsNo,
                        @Brand,
                        @SpecModel,
                        @GWeight,
                        @Grade,
                        @PieceWeight,
                        @Packing,
                        @BatchNo,
                        @Location,
                        @Packages,
                        @Tunnages,
                        @Piles,
                        @TenThousands,
                        @ProductionDate,
                        @EnterWarehouseBillId
                    )
                    if @@rowcount = 0
                    begin
                        raiserror (150412,18,1)
                        return -7
                    end
            
                    fetch next from Cursor3 into 
                        @GoodsId, 
                        @GoodsName, 
                        @TypeId, 
                        @TypeName, 
                        @TypeFullPath, 
                        @TypeFullName, 
                        @GoodsNo, 
                        @Brand, 
                        @SpecModel, 
                        @GWeight, 
                        @Grade, 
                        @PieceWeight, 
                        @Packing, 
                        @BatchNo, 
                        @Location, 
                        @Packages, 
                        @Tunnages, 
                        @Piles, 
                        @TenThousands,
                        @ProductionDate,
                        @EnterWarehouseBillId
            end
        
            close Cursor3
            deallocate Cursor3
            
        end
         
        fetch next from Cursor1 into @PlanId 
    end
          
    close Cursor1
    deallocate Cursor1 
    
    
    /**/
    update DispatchBill set BillState = formatmessage(150242) where Id = @Id and BillState <> formatmessage(150242)
    if @@rowcount = 0
    begin
        raiserror (150367,18,1)
        return -9
    end
    
    
    /**/
    set @ContractId = 0
    if exists(select * from Carrier where Id = @CarrierId and PaymentType = formatmessage(150238)) and 
       exists(select * from DispatchBillDeliverPlan where DispatchBillId = @Id and PlanId in (select Id from DeliverPlan where ReceiveType = formatmessage(150348)))
    begin
        /**/
        select 
	        @GoodsName = stuff(replace(replace(
	        (
		        select distinct
			        GoodsName 
		        from 
			        DispatchBillGoods 
		        where 
			        DispatchBillId = @Id and 
                    PlanId in (select Id from DeliverPlan where ReceiveType = formatmessage(150348))
		        for xml auto
	        ), '<DispatchBillGoods GoodsName="', ','), '"/>', ''), 1, 1, '')
            
        /**/
        select 
	        @StartPlace = stuff(replace(replace(
	        (
		        select distinct
			        StartCity 
		        from 
			        DeliverPlan 
		        where 
			        Id in (select PlanId from DispatchBillDeliverPlan where DispatchBillId = @Id) and 
                    ReceiveType = formatmessage(150348)
		        for xml auto
	        ), '<DeliverPlan StartCity="', ','), '"/>', ''), 1, 1, '')

        /**/
        select 
	        @DestPlace = stuff(replace(replace(
	        (
		        select distinct
			        ReceiverCity 
		        from 
			        DeliverPlan 
		        where 
			        Id in (select PlanId from DispatchBillDeliverPlan where DispatchBillId = @Id) and 
                    ReceiveType = formatmessage(150348)
		        for xml auto
	        ), '<DeliverPlan ReceiverCity="', ','), '"/>', ''), 1, 1, '')
    
        set @ShipmentTime = getdate()
        set @ArrivalTime = getdate()
    
        select 
            @TotalPackages = isnull(sum(Packages),0), 
            @TotalTunnages = isnull(sum(Tunnages),0.0),
            @TotalPiles = isnull(sum(Piles),0.0),
            @TotalTenThousands = isnull(sum(TenThousands),0.0),
            @TotalTransportCharges = isnull(sum(TransportCharges),0.0)
        from 
            DispatchBillDeliverPlan 
        where 
            DispatchBillId = @Id and 
            PlanId in (select Id from DeliverPlan where ReceiveType = formatmessage(150348))
            
        /**/
        begin try
            exec InsertContract
                @ContractId1 output,
                @Id,
                N'',
                @CarNo,
                @TrailerNo,
                @CarType,
                @DriverName,
                @DriverLicenseNo,
                @DriverMobileTel,
                @DriverHomeTel,
                @CarrierId,
                @CarrierName,
                @GoodsName,
                N'',
                @StartPlace,
                @DestPlace,
                @ShipmentTime,
                @ArrivalTime,
                @TotalPackages,
                @TotalTunnages,
                @TotalPiles,
                @TotalTenThousands,
                @TotalTransportCharges,
                0,
                @TotalTransportCharges,
                0,
                @OpStaffId, 
                @OpStaffName 
        end try
        begin catch
            select @ErrText = error_message()
            raiserror (@ErrText,18,1)
            return -10
        end catch

        /**/
        declare Cursor4 cursor local for 
            select 
                PlanId,
                Packages,
                Tunnages,
                Piles,
                TenThousands,
                TransportChargeExpression,
                TransportPriceExpression,
                KM,
                TransportPrice,
                TransportCharges,
                Remark
            from 
                DispatchBillDeliverPlan 
            where 
                DispatchBillId = @Id and 
                PlanId in (select Id from DeliverPlan where ReceiveType = formatmessage(150348))

        open Cursor4
        fetch next from Cursor4 into 
            @PlanId,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @TransportChargeExpression,
            @TransportPriceExpression,
            @KM,
            @TransportPrice,
            @TransportCharges,
            @Remark
            
        while @@fetch_status = 0
        begin
            begin try
                exec InsertContractDeliverPlan
                    @ContractId1,
                    @PlanId,
                    @Packages,
                    @Tunnages,
                    @Piles,
                    @TenThousands,
                    @TransportChargeExpression,
                    @TransportPriceExpression,
                    @KM,
                    @TransportPrice,
                    @TransportCharges,
                    @Remark,
                    @OpStaffId,
                    @OpStaffName
            end try
            begin catch
                select @ErrText = error_message()
                raiserror (@ErrText,18,1)
                return -11
            end catch
        
            fetch next from Cursor4 into 
                @PlanId,
                @Packages,
                @Tunnages,
                @Piles,
                @TenThousands,
                @TransportChargeExpression,
                @TransportPriceExpression,
                @KM,
                @TransportPrice,
                @TransportCharges,
                @Remark
        end

        close Cursor4
        deallocate Cursor4
        
        /**/
        if not exists(select * from DeliverPlan where (PlanType = formatmessage(150256) or PlanType = formatmessage(150257)) and Id in (select PlanId from DispatchBillDeliverPlan where DispatchBillId = @Id))
        begin
            /**/
            begin try
                exec SubmitContract @ContractId1, @OpStaffId, @OpStaffName
            end try
            begin catch
                select @ErrText = error_message()
                raiserror (@ErrText,18,1)
                return -12
            end catch
        
            /**/
            set @ContractId = @ContractId1
        end
    end
    
    /**/
    select @OpName = formatmessage(150370)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -13
    end
    
    return 0
end
go


create procedure SubmitPrintContract 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    update Contract set PrintState = 1 where Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150154,18,1)
        return -1
    end
    
    /**/
    select @OpName = formatmessage(150438)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure SubmitPrintDeliverBill 
@Id bigint,
@ContractId bigint output,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @PlanId bigint
declare @ReceiveType nvarchar(10)
declare @GoodsId bigint
declare @BatchNo nvarchar(20)
declare @Packing nvarchar(10)
declare @Location nvarchar(20)
declare @Packages int
declare @Piles numeric(25,9)
declare @ProductionDate nvarchar(10)
declare @EnterWarehouseBillId bigint
declare @DeliverPackages int
declare @DeliverPiles numeric(25,9)
declare @DeliveryCompleted bit
declare @DispatchBillId bigint
declare @ErrText nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /*1.*/
    update DeliverBill set PrintState = 1 where Id = @Id and PrintState <> 1
    if @@rowcount = 0
    begin
        raiserror (150428,18,1)
        return -1
    end
    
    /*2.*/
    select @PlanId = PlanId, @DispatchBillId = DispatchBillId from DeliverBill where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150415,18,1)
        return -2
    end
    
    select @ReceiveType = ReceiveType from DeliverPlan where Id = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150251,18,1)
        return -3
    end
    
    if @ReceiveType = formatmessage(150347)
    begin
        set @DeliveryCompleted = 1
    
        declare Cursor1 cursor local for 
            select 
                GoodsId, 
                BatchNo, 
                Packing,
                Location,
                Packages,
                Piles,
                ProductionDate,
                EnterWarehouseBillId
            from 
                DeliverPlanGoods 
            where 
                PlanId = @PlanId 
            
        open Cursor1
        fetch next from Cursor1 into 
            @GoodsId, 
            @BatchNo, 
            @Packing,
            @Location,
            @Packages,
            @Piles,
            @ProductionDate,
            @EnterWarehouseBillId
            
        while @@fetch_status = 0
        begin
            select 
                @DeliverPackages = isnull(sum(g.Packages),0),
                @DeliverPiles = isnull(sum(g.Piles),0)
            from 
                DeliverBillGoods g join 
                DeliverBill b on g.DeliverBillId = b.Id 
            where 
                b.PlanId = @PlanId and
                g.GoodsId = @GoodsId and 
                g.BatchNo = @BatchNo and 
                g.Packing = @Packing and 
                g.Location = @Location and 
                g.ProductionDate = @ProductionDate and 
                g.EnterWarehouseBillId = @EnterWarehouseBillId
            
            if @DeliverPackages < @Packages or @DeliverPiles < @Piles
            begin 
                set @DeliveryCompleted = 0 
                break
            end
        
            fetch next from Cursor1 into 
                @GoodsId, 
                @BatchNo, 
                @Packing,
                @Location,
                @Packages,
                @Piles,
                @ProductionDate,
                @EnterWarehouseBillId
        end 
        
        close Cursor1
        deallocate Cursor1 
    
        if @DeliveryCompleted = 1
        begin
            update DeliverPlan set PlanState = formatmessage(150243) where Id = @PlanId
            if @@rowcount = 0
            begin
                raiserror (150270,18,1)
                return -4
            end
        end
    end
    
    /*3.*/
    set @ContractId = 0
    if not exists(select * from DeliverBill where DispatchBillId = @DispatchBillId and PrintState <> 1)
    begin
        if exists(select * from Contract where ContractState = formatmessage(150241) and IsPrestowage = 0 and DispatchBillId = @DispatchBillId and Id in (select ContractId from ContractDeliverPlan where PlanId = @PlanId))
        begin
            select @ContractId = Id from Contract where ContractState = formatmessage(150241) and IsPrestowage = 0 and DispatchBillId = @DispatchBillId and Id in (select ContractId from ContractDeliverPlan where PlanId = @PlanId)
            if @@rowcount = 0
            begin
                raiserror (150692,18,1)
                return -5
            end
        
            begin try
                exec SubmitContract @ContractId, @OpStaffId, @OpStaffName
            end try
            begin catch
                select @ErrText = error_message()
                raiserror (@ErrText,18,1)
                return -6
            end catch
        end
    end
    
    /**/
    select @OpName = formatmessage(150429)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -7
    end
    
    return 0
end
go


create procedure SubmitPrintShipmentBill 
@Id bigint,
@OutWarehouseBillId bigint output,
@EnterWarehouseBillId bigint output,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OutWarehouseBillNo nvarchar(20)
declare @DispatchBillId bigint
declare @PlanId bigint
declare @CustomerId bigint
declare @CustomerName nvarchar(50)
declare @DeliveryNo nvarchar(20)
declare @OutType nvarchar(10)
declare @ReceiverName nvarchar(50)
declare @ReceiverCountry nvarchar(20)
declare @ReceiverProvince nvarchar(20)
declare @ReceiverCity nvarchar(20)
declare @ReceiverAddress nvarchar(50)
declare @ReceiverContact nvarchar(20)
declare @ReceiverContactTel nvarchar(20)
declare @ReceiveType nvarchar(10)
declare @CarNo nvarchar(20)
declare @TrailerNo nvarchar(10)
declare @CarrierId bigint
declare @CarrierName nvarchar(50)
declare @OwnOrganId bigint
declare @OwnOrganName nvarchar(50)
declare @PayerId bigint
declare @PayerName nvarchar(50)
declare @IsConsigning bit
declare @ConsignedDeliveryNo nvarchar(20)
declare @Warehouse nvarchar(20)
declare @ConsignedReceiverName nvarchar(50)
declare @ConsignedCustomerId bigint
declare @ConsignedCustomerName nvarchar(50)
declare @LoadingForceFeePrice numeric(25,9)
declare @CustomerOwnOrganId bigint
declare @TotalTunnages numeric(25,9)
declare @TotalPiles numeric(25,9)
declare @GoodsId bigint
declare @GoodsName nvarchar(50)
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @GoodsNo nvarchar(20)
declare @Brand nvarchar(20)
declare @SpecModel nvarchar(50)
declare @GWeight nvarchar(20)
declare @Grade nvarchar(10)
declare @PieceWeight numeric(25,9)
declare @Packing nvarchar(10)
declare @BatchNo nvarchar(20)
declare @Location nvarchar(10)
declare @Packages int
declare @Tunnages numeric(25,9)
declare @Piles numeric(25,9)
declare @TenThousands numeric(25,9)
declare @ProductionDate nvarchar(10)
declare @EnterWarehouseBillId2 bigint
declare @DeliveryNo2 nvarchar(20)
declare @OutWarehouseBillGoodsId bigint
declare @ReceiverCustomerId bigint
declare @ReceiverCustomerName nvarchar(50)
declare @UnloadingForceFeePrice numeric(25,9)
declare @EnterType nvarchar(10)
declare @ForceFee numeric(25,9)
declare @CreateOrganId bigint
declare @CreateOrganName nvarchar(50)
declare @CreateTime datetime
declare @DeliveryCompleted bit
declare @ShipmentPackages int
declare @ShipmentBillGoodsId bigint
declare @ShipmentBillGoodsIds nvarchar(500)
declare @PlanType nvarchar(10)
declare @DeliverPlanCreateTime datetime
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /*1.*/
    update ShipmentBill set PrintState = 1 where Id = @Id and PrintState <> 1
    if @@rowcount = 0
    begin
        raiserror (150372,18,1)
        return -1
    end
    
    /*2.*/
    begin
        /*2.1.*/
        select 
            @DispatchBillId = DispatchBillId,
            @PlanId = PlanId, 
            @CustomerId = CustomerId, 
            @CustomerName = CustomerName, 
            @DeliveryNo = DeliveryNo, 
            @OutType = OutType, 
            @ReceiverName = ReceiverName,
            @ReceiverCountry = ReceiverCountry,
            @ReceiverProvince = ReceiverProvince,
            @ReceiverCity = ReceiverCity,
            @ReceiverAddress = ReceiverAddress,
            @ReceiverContact = ReceiverContact,
            @ReceiverContactTel = ReceiverContactTel,
            @ReceiveType = ReceiveType,
            @CarNo = CarNo,
            @TrailerNo = TrailerNo,
            @CarrierId = CarrierId,
            @CarrierName = CarrierName,
            @Warehouse = Warehouse,
            @OwnOrganId = OwnOrganId,
            @OwnOrganName = OwnOrganName,
            @CreateTime = CreateTime 
        from 
            ShipmentBill 
        where 
            Id = @Id 
        if @@rowcount = 0
        begin
            raiserror (150380,18,1)
            return -2
        end
        
        /*2.2.*/
        select 
            @PayerId = PayerId, 
            @PayerName =PayerName, 
            @IsConsigning = IsConsigning, 
            @ConsignedDeliveryNo = ConsignedDeliveryNo,
            @DeliverPlanCreateTime = @CreateTime
        from 
            DeliverPlan 
        where 
            Id = @PlanId
        if @@rowcount = 0
        begin
            raiserror (150251,18,1)
            return -3
        end
        
        /*2.3.*/
        if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
        begin
            /**/
            select 
                @ConsignedReceiverName = ReceiverName 
            from 
                DeliverPlan 
            where 
                CustomerId = @CustomerId and 
                DeliveryNo = @ConsignedDeliveryNo and 
                IsConsigning = 1
            if @@rowcount = 0
            begin
				select 
					@ConsignedReceiverName = CustomerName 
				from 
					EnterWarehouseBill  
				where 
					DeliveryNo = @ConsignedDeliveryNo and 
					IsConsigning = 1
				if @@rowcount = 0
				begin
					raiserror (150389,18,1)
					return -4
				end
            end
            
            /**/
            select 
                @ConsignedCustomerId = c.Id,
                @ConsignedCustomerName = c.Name, 
                @LoadingForceFeePrice = isnull(fp.LoadingForceFeePrice,0.0)
            from 
                Customer c left join 
                CustomerForceFeePrice fp on c.Id = fp.CustomerId and convert(nvarchar(10),@DeliverPlanCreateTime,120) >= convert(nvarchar(10),fp.StartTime,120) and convert(nvarchar(10),@DeliverPlanCreateTime,120) <= convert(nvarchar(10),fp.EndTime,120)
            where 
                c.Name = @ConsignedReceiverName 
            if @@rowcount = 0
            begin
                raiserror (150390,18,1)
                return -5
            end
        end
        else
        begin
            select 
                @LoadingForceFeePrice = isnull(LoadingForceFeePrice,0.0) 
            from 
                CustomerForceFeePrice 
            where 
                CustomerId = @CustomerId and 
                convert(nvarchar(10),@DeliverPlanCreateTime,120) >= convert(nvarchar(10),StartTime,120) and 
                convert(nvarchar(10),@DeliverPlanCreateTime,120) <= convert(nvarchar(10),EndTime,120)
            if @@rowcount = 0
            begin
                raiserror (150670,18,1)
                return -6
            end
        end
        
        /*2.4.*/
        if @OutType = formatmessage(150305)
        begin
            select 
                @TotalTunnages = isnull(sum(Tunnages),0),
                @TotalPiles = isnull(sum(Piles),0)
            from 
                ShipmentBillGoods 
            where 
                ShipmentBillId = @Id 
            
            if @TotalTunnages > 0
            begin
                set @ForceFee = @TotalTunnages * @LoadingForceFeePrice 
            end
            else
            begin
                set @ForceFee = @TotalPiles * @LoadingForceFeePrice 
            end
            set @ForceFee = cast(@ForceFee as numeric(25,2))
        end
        else
        begin
            set @ForceFee = 0
        end
        
        /*2.5.*/
        exec GetId @OpStaffId, @OutWarehouseBillId output 
    
        exec GetNo N'OutWarehouseBill', @OutWarehouseBillNo output
        if @OutType = formatmessage(150305)
        begin
            set @OutWarehouseBillNo = N'C' + @OutWarehouseBillNo 
        end
        else
        begin
            set @OutWarehouseBillNo = N'H' + @OutWarehouseBillNo 
        end
        
        insert into OutWarehouseBill 
            (
                Id,
                BillNo,
                ShipmentBillId,
                PlanId,
                CustomerId,
                CustomerName,
                DeliveryNo,
                OutType,
                ReceiverName,
                ReceiverCountry,
                ReceiverProvince,
                ReceiverCity,
                ReceiverAddress,
                ReceiverContact,
                ReceiverContactTel,
                ReceiveType,
                CarNo,
                TrailerNo,
                CarrierId,
                CarrierName,
                PayerId,
                PayerName,
                IsConsigning,
                ConsignedDeliveryNo,
                Warehouse,
                ForceFee,
                Remark,
                CreatorId,
                CreatorName,
                CreateTime
            )
        values 
            (
                @OutWarehouseBillId,
                @OutWarehouseBillNo,
                @Id,
                @PlanId,
                case when @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> '' then @ConsignedCustomerId else @CustomerId end,
                case when @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> '' then @ConsignedCustomerName else @CustomerName end,
                @DeliveryNo,
                @OutType,
                @ReceiverName,
                @ReceiverCountry,
                @ReceiverProvince,
                @ReceiverCity,
                @ReceiverAddress,
                @ReceiverContact,
                @ReceiverContactTel,
                @ReceiveType,
                @CarNo,
                @TrailerNo,
                @CarrierId,
                @CarrierName,
                @PayerId,
                @PayerName,
                @IsConsigning,
                @ConsignedDeliveryNo,
                @Warehouse,
                @ForceFee,
                N'',
                @OpStaffId,
                @OpStaffName,
                @CreateTime
            )
        if @@rowcount = 0
        begin
            raiserror (150391,18,1)
            return -7
        end
        
        /*2.6.*/
        declare Cursor1 cursor local for 
            select 
                GoodsId, 
                GoodsName, 
                TypeId, 
                TypeName, 
                TypeFullPath, 
                TypeFullName, 
                GoodsNo, 
                Brand, 
                SpecModel, 
                GWeight, 
                Grade, 
                PieceWeight, 
                Packing, 
                BatchNo, 
                Location, 
                Packages, 
                Tunnages,
                Piles,
                TenThousands,
                ProductionDate,
                EnterWarehouseBillId
            from 
                ShipmentBillGoods 
            where 
                ShipmentBillId = @Id 
            
        open Cursor1
        fetch next from Cursor1 into 
            @GoodsId, 
            @GoodsName, 
            @TypeId, 
            @TypeName, 
            @TypeFullPath, 
            @TypeFullName, 
            @GoodsNo, 
            @Brand, 
            @SpecModel, 
            @GWeight, 
            @Grade, 
            @PieceWeight, 
            @Packing, 
            @BatchNo, 
            @Location, 
            @Packages, 
            @Tunnages,
            @Piles,
            @TenThousands,
            @ProductionDate,
            @EnterWarehouseBillId2
            
        while @@fetch_status = 0
        begin
            /**/
            select 
                @DeliveryNo2 = DeliveryNo 
            from 
                EnterWarehouseBill 
            where 
                Id = @EnterWarehouseBillId2
            if @@rowcount = 0 or @DeliveryNo2 is null
            begin
                set @DeliveryNo2 = ''
            end
            
            /**/
            if @Packages > 0
                set @PlanType = formatmessage(150256)
            else
                set @PlanType = formatmessage(150257)
            
            begin try
                exec CheckStock 
                @CustomerId, 
                @PlanType, 
                @GoodsId, 
                @GoodsNo, 
                @BatchNo, 
                @Packing, 
                @Warehouse, 
                @Location, 
                @ProductionDate, 
                @EnterWarehouseBillId2, 
                @ConsignedDeliveryNo,
                0,
                0,
                @OpStaffId, 
                @OpStaffName 
            end try
            begin catch
                select @ErrorText = error_message()
                raiserror (@ErrorText,18,1)
                return -8
            end catch
            
            /**/
            exec GetId @OpStaffId, @OutWarehouseBillGoodsId output 
            insert into OutWarehouseBillGoods 
            (
                Id,
                OutWarehouseBillId,
                GoodsId,
                GoodsName,
                TypeId,
                TypeName,
                TypeFullPath,
                TypeFullName,
                GoodsNo,
                Brand,
                SpecModel,
                GWeight,
                Grade,
                PieceWeight,
                Packing,
                BatchNo,
                Location,
                Packages,
                Tunnages,
                Piles,
                TenThousands,
                ProductionDate,
                EnterWarehouseBillId,
                DeliveryNo 
            )
            values 
            (
                @OutWarehouseBillGoodsId,
                @OutWarehouseBillId,
                @GoodsId,
                @GoodsName,
                @TypeId,
                @TypeName,
                @TypeFullPath,
                @TypeFullName,
                @GoodsNo,
                @Brand,
                @SpecModel,
                @GWeight,
                @Grade,
                @PieceWeight,
                @Packing,
                @BatchNo,
                @Location,
                @Packages,
                @Tunnages,
                @Piles,
                @TenThousands,
                @ProductionDate,
                @EnterWarehouseBillId2,
                @DeliveryNo2 
            )
            if @@rowcount = 0
            begin
                raiserror (150393,18,1)
                return -9
            end
            
            /**/
            begin try
                exec SubtractStock 
                @CustomerId, 
                @DeliveryNo2, 
                @GoodsId, 
                @GoodsNo, 
                @BatchNo, 
                @Packing, 
                @Warehouse, 
                @Location, 
                @ProductionDate, 
                @EnterWarehouseBillId2, 
                @ConsignedDeliveryNo,
                @Packages,
                @Tunnages,
                @Piles,
                @TenThousands,
                @OutWarehouseBillId,
                @CreateTime,
                @OpStaffId, 
                @OpStaffName 
            end try
            begin catch
                select @ErrorText = error_message()
                raiserror (@ErrorText,18,1)
                return -10
            end catch
            
            fetch next from Cursor1 into 
                @GoodsId, 
                @GoodsName, 
                @TypeId, 
                @TypeName, 
                @TypeFullPath, 
                @TypeFullName, 
                @GoodsNo, 
                @Brand, 
                @SpecModel, 
                @GWeight, 
                @Grade, 
                @PieceWeight, 
                @Packing, 
                @BatchNo, 
                @Location, 
                @Packages, 
                @Tunnages,
                @Piles,
                @TenThousands,
                @ProductionDate,
                @EnterWarehouseBillId2
        end
        
        close Cursor1
        deallocate Cursor1 
    end
    
    /*3.*/
    if @OutType = formatmessage(150306)
    begin
        /*3.1.*/
        if exists(select * from Customer where Name = @ReceiverName)
        begin
            select 
                @ReceiverCustomerId = c.Id,
                @ReceiverCustomerName = c.Name,
                @UnloadingForceFeePrice = isnull(fp.UnloadingForceFeePrice,0.0) 
            from 
                Customer c left join 
                CustomerForceFeePrice fp on c.Id = fp.CustomerId and convert(nvarchar(10),@DeliverPlanCreateTime,120) >= convert(nvarchar(10),fp.StartTime,120) and convert(nvarchar(10),@DeliverPlanCreateTime,120) <= convert(nvarchar(10),fp.EndTime,120) 
            where 
                c.Name = @ReceiverName
            if @@rowcount = 0
            begin
                raiserror (150390,18,1)
                return -11
            end
        end
        else
        begin
            select 
                @CustomerOwnOrganId = OwnOrganId 
            from 
                Customer 
            where 
                Id = @CustomerId 
            if @@rowcount = 0
            begin
                raiserror (150082,18,1)
                return -12
            end
        
            set @ReceiverCustomerName = @ReceiverName 
            set @UnloadingForceFeePrice = 0
            
            begin try
                declare @ValuationMode nvarchar(20)
                set @ValuationMode = formatmessage(150620)
                
                exec InsertCustomer 
                    @ReceiverCustomerId output, 
                    @ReceiverCustomerName, 
                    @ReceiverCustomerName,
                    0, 
                    @UnloadingForceFeePrice, 
                    0, 
                    0, 
                    0, 
                    N'', 
                    @ValuationMode, 
                    1,
                    N'',
                    @CustomerOwnOrganId, 
                    @OpStaffId, 
                    @OpStaffName 
            end try
            begin catch
                select @ErrorText = formatmessage(150085) + error_message()
                raiserror (@ErrorText,18,1)
                return -13
            end catch
        end
        
        /*3.2.*/
        begin try
            set @EnterType = formatmessage(150276)
            set @ForceFee = 0 
            exec InsertEnterWarehouseBill 
                @EnterWarehouseBillId output, 
                @PlanId, 
                @ReceiverCustomerId, 
                @DeliveryNo, 
                @EnterType, 
                @IsConsigning, 
                @Warehouse, 
                @ForceFee, 
                0, 
                N'', 
                @CreateTime, 
                @OpStaffId, 
                @OpStaffName 
        end try
        begin catch
            select @ErrorText = formatmessage(150277) + error_message()
            raiserror (@ErrorText,18,1)
            return -14
        end catch
        
        /*3.3.*/
        declare Cursor4 cursor local for 
            select 
                Id,
                GoodsId, 
                GoodsName, 
                GoodsNo, 
                Brand, 
                SpecModel, 
                GWeight, 
                Grade, 
                PieceWeight, 
                Packing, 
                BatchNo, 
                Location, 
                Packages, 
                Tunnages,
                ProductionDate
            from 
                ShipmentBillGoods 
            where 
                ShipmentBillId = @Id 
            
        open Cursor4
        fetch next from Cursor4 into 
            @ShipmentBillGoodsId,
            @GoodsId, 
            @GoodsName, 
            @GoodsNo, 
            @Brand, 
            @SpecModel, 
            @GWeight, 
            @Grade, 
            @PieceWeight, 
            @Packing, 
            @BatchNo, 
            @Location, 
            @Packages, 
            @Tunnages,
            @ProductionDate
            
        while @@fetch_status = 0
        begin
            set @ShipmentBillGoodsIds = convert(nvarchar,@ShipmentBillGoodsId)
            
            begin try
                exec InsertEnterWarehouseBillGoods 
                    0,
                    @ReceiverCustomerId, 
                    @ReceiverCustomerName, 
                    @GoodsId, 
                    @GoodsNo,
                    @GoodsName,
                    @Brand,
                    @SpecModel,
                    @GWeight,
                    @Grade,
                    @BatchNo, 
                    @Packing, 
                    @Warehouse,
                    @Location, 
                    @Packages, 
                    @PieceWeight, 
                    @Tunnages, 
                    0,
                    0,
                    @ProductionDate, 
                    @ShipmentBillGoodsIds,
                    @EnterWarehouseBillId, 
                    @DeliveryNo,
                    @CreateTime,
                    @OpStaffId, 
                    @OpStaffName 
            end try
            begin catch
                select @ErrorText = formatmessage(150279) + error_message()
                raiserror (@ErrorText,18,1)
                return -15
            end catch
        
            fetch next from Cursor4 into 
                @ShipmentBillGoodsId,
                @GoodsId, 
                @GoodsName, 
                @GoodsNo, 
                @Brand, 
                @SpecModel, 
                @GWeight, 
                @Grade, 
                @PieceWeight, 
                @Packing, 
                @BatchNo, 
                @Location, 
                @Packages, 
                @Tunnages,
                @ProductionDate
        end
        
        close Cursor4
        deallocate Cursor4 
        
        /*3.4.*/
        set @DeliveryCompleted = 1
    
        declare Cursor5 cursor local for 
            select 
                GoodsId, 
                BatchNo, 
                Packing,
                Location,
                Packages,
                ProductionDate,
                EnterWarehouseBillId
            from 
                DeliverPlanGoods 
            where 
                PlanId = @PlanId 
            
        open Cursor5
        fetch next from Cursor5 into 
            @GoodsId, 
            @BatchNo, 
            @Packing,
            @Location,
            @Packages,
            @ProductionDate,
            @EnterWarehouseBillId2
            
        while @@fetch_status = 0
        begin
            select 
                @ShipmentPackages = isnull(sum(g.Packages),0) 
            from 
                ShipmentBillGoods g join 
                ShipmentBill b on g.ShipmentBillId = b.Id 
            where 
                b.PlanId = @PlanId and 
                g.GoodsId = @GoodsId and 
                g.BatchNo = @BatchNo and 
                g.Packing = @Packing and 
                g.Location = @Location and 
                g.ProductionDate = @ProductionDate and 
                g.EnterWarehouseBillId = @EnterWarehouseBillId2
            
            if @ShipmentPackages < @Packages
            begin 
                set @DeliveryCompleted = 0 
                break
            end
        
            fetch next from Cursor5 into 
                @GoodsId, 
                @BatchNo, 
                @Packing,
                @Location,
                @Packages,
                @ProductionDate,
                @EnterWarehouseBillId2
        end 
        
        close Cursor5
        deallocate Cursor5 
    
        if @DeliveryCompleted = 1
        begin
            update DeliverPlan set PlanState = formatmessage(150243) where Id = @PlanId
            if @@rowcount = 0
            begin
                raiserror (150270,18,1)
                return -16
            end
        end
    end
    else
    begin
        set @EnterWarehouseBillId = 0
    end
    
    
    /**/
    select @OpName = formatmessage(150373)
    select @OpParams = N'Id=' + convert(nvarchar,@Id)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -17
    end
    
    return 0
end
go


create procedure SubmitShipmentBill 
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @DispatchBillId bigint
declare @PlanId bigint
declare @CustomerId bigint
declare @CustomerName nvarchar(50)
declare @DeliveryNo nvarchar(20)
declare @OutType nvarchar(10)
declare @ReceiverName nvarchar(50)
declare @ReceiverCountry nvarchar(20)
declare @ReceiverProvince nvarchar(20)
declare @ReceiverCity nvarchar(20)
declare @ReceiverAddress nvarchar(50)
declare @ReceiverContact nvarchar(20)
declare @ReceiverContactTel nvarchar(20)
declare @CarNo nvarchar(20)
declare @TrailerNo nvarchar(10)
declare @CarrierId bigint
declare @CarrierName nvarchar(50)
declare @OwnOrganId bigint
declare @OwnOrganName nvarchar(50)
declare @Warehouse nvarchar(20)
declare @GoodsId bigint
declare @GoodsName nvarchar(50)
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @GoodsNo nvarchar(20)
declare @Brand nvarchar(20)
declare @SpecModel nvarchar(50)
declare @GWeight nvarchar(20)
declare @Grade nvarchar(10)
declare @PieceWeight numeric(25,9)
declare @Packing nvarchar(10)
declare @BatchNo nvarchar(20)
declare @Location nvarchar(10)
declare @Packages int
declare @Tunnages numeric(25,9)
declare @Piles numeric(25,9)
declare @TenThousands numeric(25,9)
declare @ProductionDate nvarchar(10)
declare @EnterWarehouseBillId bigint
declare @DeliverBillId bigint
declare @DeliverBillNo nvarchar(20)
declare @CreateOrganId bigint
declare @CreateOrganName nvarchar(50)
declare @CreateTime datetime
declare @DeliverBillGoodsId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from ShipmentBill where Id = @Id and BillState = formatmessage(150242))
    begin
        raiserror (150691,18,1)
        return -1
    end
    
    /*1.*/
    select 
        @DispatchBillId = DispatchBillId,
        @PlanId = PlanId, 
        @CustomerId = CustomerId, 
        @CustomerName = CustomerName, 
        @DeliveryNo = DeliveryNo, 
        @OutType = OutType, 
        @ReceiverName = ReceiverName,
        @ReceiverCountry = ReceiverCountry,
        @ReceiverProvince = ReceiverProvince,
        @ReceiverCity = ReceiverCity,
        @ReceiverAddress = ReceiverAddress,
        @ReceiverContact = ReceiverContact,
        @ReceiverContactTel = ReceiverContactTel,
        @CarNo = CarNo,
        @TrailerNo = TrailerNo,
        @CarrierId = CarrierId,
        @CarrierName = CarrierName,
        @Warehouse = Warehouse,
        @OwnOrganId = OwnOrganId,
        @OwnOrganName = OwnOrganName,
        @CreateTime = CreateTime 
    from 
        ShipmentBill 
    where 
        Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150380,18,1)
        return -2
    end
    
    /*2.*/
    update ShipmentBill set BillState = formatmessage(150242) where Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150388,18,1)
        return -3
    end
    
    /*3.*/
    if @OutType = formatmessage(150305)
    begin
        /*3.1.*/
        select @CreateOrganId = OrganId, @CreateOrganName = OrganFullName from Account where Id = @OpStaffId 
        if @@rowcount = 0
        begin
            raiserror (150004,18,1)
            return -4
        end
    
        /*3.2.*/
        exec GetId @OpStaffId, @DeliverBillId output 
    
        exec GetNo N'DeliverBill', @DeliverBillNo output
        set @DeliverBillNo = N'S' + @DeliverBillNo 
        
        insert into DeliverBill 
            (
                Id,
                BillNo,
                ShipmentBillId,
                DispatchBillId,
                PlanId,
                CustomerId,
                CustomerName,
                DeliveryNo,
                ReceiverName,
                ReceiverCountry,
                ReceiverProvince,
                ReceiverCity,
                ReceiverAddress,
                ReceiverContact,
                ReceiverContactTel,
                CarNo,
                TrailerNo,
                CarrierId,
                CarrierName,
                Warehouse,
                CreatorId,
                CreatorName,
                CreateOrganId,
                CreateOrganName,
                CreateTime,
                OwnOrganId,
                OwnOrganName,
                PrintState
            )
        values 
            (
                @DeliverBillId,
                @DeliverBillNo,
                @Id,
                @DispatchBillId,
                @PlanId,
                @CustomerId,
                @CustomerName,
                @DeliveryNo,
                @ReceiverName,
                @ReceiverCountry,
                @ReceiverProvince,
                @ReceiverCity,
                @ReceiverAddress,
                @ReceiverContact,
                @ReceiverContactTel,
                @CarNo,
                @TrailerNo,
                @CarrierId,
                @CarrierName,
                @Warehouse,
                @OpStaffId,
                @OpStaffName,
                @CreateOrganId,
                @CreateOrganName,
                @CreateTime,
                @OwnOrganId,
                @OwnOrganName,
                0
            )
        if @@rowcount = 0
        begin
            raiserror (150411,18,1)
            return -5
        end
        
        /*3.3.*/
        declare Cursor1 cursor local for 
            select 
                GoodsId, 
                GoodsName, 
                TypeId, 
                TypeName, 
                TypeFullPath, 
                TypeFullName, 
                GoodsNo, 
                Brand, 
                SpecModel, 
                GWeight, 
                Grade, 
                PieceWeight, 
                Packing, 
                BatchNo, 
                Location, 
                Packages, 
                Tunnages,
                Piles,
                TenThousands,
                ProductionDate,
                EnterWarehouseBillId
            from 
                ShipmentBillGoods 
            where 
                ShipmentBillId = @Id 
            
        open Cursor1
        fetch next from Cursor1 into 
            @GoodsId, 
            @GoodsName, 
            @TypeId, 
            @TypeName, 
            @TypeFullPath, 
            @TypeFullName, 
            @GoodsNo, 
            @Brand, 
            @SpecModel, 
            @GWeight, 
            @Grade, 
            @PieceWeight, 
            @Packing, 
            @BatchNo, 
            @Location, 
            @Packages, 
            @Tunnages,
            @Piles,
            @TenThousands,
            @ProductionDate,
            @EnterWarehouseBillId
            
        while @@fetch_status = 0
        begin
            exec GetId @OpStaffId, @DeliverBillGoodsId output 
            
            insert into DeliverBillGoods 
            (
                Id,
                DeliverBillId,
                GoodsId,
                GoodsName,
                TypeId,
                TypeName,
                TypeFullPath,
                TypeFullName,
                GoodsNo,
                Brand,
                SpecModel,
                GWeight,
                Grade,
                PieceWeight,
                Packing,
                BatchNo,
                Location,
                Packages,
                Tunnages,
                Piles,
                TenThousands,
                ProductionDate,
                EnterWarehouseBillId
            )
            values 
            (
                @DeliverBillGoodsId,
                @DeliverBillId,
                @GoodsId,
                @GoodsName,
                @TypeId,
                @TypeName,
                @TypeFullPath,
                @TypeFullName,
                @GoodsNo,
                @Brand,
                @SpecModel,
                @GWeight,
                @Grade,
                @PieceWeight,
                @Packing,
                @BatchNo,
                @Location,
                @Packages,
                @Tunnages,
                @Piles,
                @TenThousands,
                @ProductionDate,
                @EnterWarehouseBillId
            )
            if @@rowcount = 0
            begin
                raiserror (150412,18,1)
                return -6
            end
            
            fetch next from Cursor1 into 
                @GoodsId, 
                @GoodsName, 
                @TypeId, 
                @TypeName, 
                @TypeFullPath, 
                @TypeFullName, 
                @GoodsNo, 
                @Brand, 
                @SpecModel, 
                @GWeight, 
                @Grade, 
                @PieceWeight, 
                @Packing, 
                @BatchNo, 
                @Location, 
                @Packages, 
                @Tunnages,
                @Piles,
                @TenThousands,
                @ProductionDate,
                @EnterWarehouseBillId
        end
        
        close Cursor1
        deallocate Cursor1
    end
    
    
    /**/
    select @OpName = formatmessage(150394)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -7
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure UpdateAccount 
@Id bigint,
@Name nvarchar(20),
@Password nvarchar(50),
@AccountType nvarchar(20),
@OrganId bigint,
@StaffId bigint,
@StaffName nvarchar(50),
@IsCancel bit,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OrganFullName nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if @AccountType = formatmessage(150162)
    begin
        select @OrganFullName = FullName from Organization where Id = @OrganId 
    end
    else 
    begin
        select @OrganFullName = Name from Customer where Id = @OrganId 
    end
    
    if @OrganFullName is null or @OrganFullName = ''
    begin
        raiserror (150164,18,1)
        return -1
    end
    
    /**/
    if @AccountType = formatmessage(150162)
    begin
        select @StaffName = (case when FamilyName is null then N'' else FamilyName end + Name) from Staff where Id = @StaffId 
    end
    
    if @StaffName is null or @StaffName = ''
    begin
        raiserror (150165,18,1)
        return -2
    end
    
    
    /**/
    update Account set 
        Name = @Name,
        Password = @Password,
        AccountType = @AccountType,
        OrganId = @OrganId,
        OrganFullName = @OrganFullName,
        StaffId = @StaffId,
        StaffName = @StaffName,
        IsCancel = @IsCancel 
    where 
        Id = @Id 
        
    if @@rowcount = 0
    begin
        raiserror (150169,18,1)
        return -3
    end

    /**/
    select @OpName = formatmessage(150170)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'Name=' + @Name + N',' +
                       N'Password=' + @Password + N',' +
                       N'AccountType=' + @AccountType + N',' +
                       N'OrganId=' + convert(nvarchar,@OrganId) + N',' +
                       N'StaffId=' + convert(nvarchar,@StaffId) + N',' +
                       N'StaffName=' + @StaffName + N',' +
                       N'IsCancel=' + convert(nvarchar,@IsCancel) 

    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure UpdateApproveFlowStep 
@Id bigint,
@StepName nvarchar(50),
@StepNum int,
@FlowType nvarchar(50),
@DisposerId bigint,
@ConditionExpression nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @DisposerName nvarchar(50)
declare @OldStepNum int
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @DisposerName = (case when FamilyName is null then N'' else FamilyName end + Name) from Staff where Id = @DisposerId 
    if @@rowcount = 0
    begin
        raiserror (150287,18,1)
        return -1
    end
    
    /**/
    select @OldStepNum = StepNum from ApproveFlowStep where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150150,18,1)
        return -2
    end
    
    if @StepNum <> @OldStepNum 
    begin
        update ApproveFlowStep set StepNum = @OldStepNum where FlowType = @FlowType and StepNum = @StepNum 
        if @@error <> 0
        begin
            raiserror (150151,18,1)
            return -3
        end
    end
    
    /**/
    update ApproveFlowStep set StepName = @StepName, StepNum = @StepNum, FlowType = @FlowType, DisposerId = @DisposerId, DisposerName = @DisposerName, ConditionExpression = @ConditionExpression where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150152,18,1)
        return -4
    end
    
    /**/
    set @OpName = formatmessage(150153)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'FlowType=' + @FlowType + N',' +
                    N'StepName=' + @StepName + N',' +
                    N'StepNum=' + convert(nvarchar,@StepNum) + N',' +
                    N'DisposerId=' + convert(nvarchar,@DisposerId) + N',' +
                    N'DisposerName=' + @DisposerName + N',' +
                    N'ConditionExpression=' + @ConditionExpression 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -5
    end
    
    return 0
end
go


create procedure UpdateCarrier
@Id bigint, 
@Name nvarchar(50),
@BusinessType nvarchar(10),
@PaymentType nvarchar(10),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from Carrier where Name = @Name and Id <> @Id)
    begin
        raiserror (150497,18,1)
        return -1
    end

    /**/
    update Carrier set Name = @Name, BusinessType = @BusinessType, PaymentType = @PaymentType where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150207,18,1)
        return -2
    end
    
    /**/
    set @OpName = formatmessage(150208)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'Name=' + @Name + N',' +
                    N'BusinessType=' + @BusinessType + N',' +
                    N'PaymentType=' + @PaymentType 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure UpdateCarrierCar
@Id bigint,
@CarrierId bigint, 
@CarNo nvarchar(20),
@TrailerNo nvarchar(10),
@CarryingCapacity int,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OldCarNo nvarchar(20)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from CarrierCar where CarNo = @CarNo and Id <> @Id)
    begin
        raiserror (150209,18,1)
        return -1
    end

    /**/
    select @OldCarNo = CarNo from CarrierCar where Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150647,18,1)
        return -2
    end
    
    /**/
    update CarrierCar set 
        CarrierId = @CarrierId,
        CarNo = @CarNo,
        TrailerNo = @TrailerNo,
        CarryingCapacity = @CarryingCapacity
    where 
        Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150645,18,1)
        return -3
    end
    
    
    /**/
    update DeliverPlan set CarNo = @CarNo where CarNo = @OldCarNo and CarrierId = @CarrierId
    update DispatchBill set CarNo = @CarNo where CarNo = @OldCarNo and CarrierId = @CarrierId
    update ShipmentBill set CarNo = @CarNo where CarNo = @OldCarNo and CarrierId = @CarrierId
    update OutWarehouseBill set CarNo = @CarNo where CarNo = @OldCarNo and CarrierId = @CarrierId
    update DeliverBill set CarNo = @CarNo where CarNo = @OldCarNo and CarrierId = @CarrierId
    update Contract set CarNo = @CarNo where CarNo = @OldCarNo and CarrierId = @CarrierId and IsPrestowage = 1
    
    
    /**/
    set @OpName = formatmessage(150646)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                    N'CarNo=' + @CarNo + N',' +
                    N'TrailerNo=' + @TrailerNo + N',' +
                    N'CarryingCapacity=' + convert(nvarchar,@CarryingCapacity) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @Name
 * @CountryName
 * @ProvinceName
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure UpdateCity
@Id bigint,
@Name nvarchar(20),
@CountryName nvarchar(20),
@ProvinceName nvarchar(20),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	if exists(select 1 from City where Name = @Name and CountryName = @CountryName and ProvinceName = @ProvinceName and Id <> @Id)
    begin
        raiserror (150046,18,1)
        return -1
    end
    
    /**/
    update 
        City 
    set 
        Name = @Name, 
        CountryName = @CountryName, 
        ProvinceName = @ProvinceName, 
        Remark = @Remark 
    where 
        Id = @Id 
        
    if @@rowcount=0
    begin
        raiserror (150049,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150050)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'Name=' + @Name + N',' +
                       N'CountryName=' + @CountryName + N',' +
                       N'ProvinceName=' + @ProvinceName + N',' +
                       N'Remark=' + @Remark 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure UpdateContract
@Id bigint,
@OriginalContractNo nvarchar(20),
@CarNo nvarchar(20),
@TrailerNo nvarchar(10),
@CarType nvarchar(10),
@DriverName nvarchar(20),
@DriverLicenseNo nvarchar(20),
@DriverMobileTel nvarchar(20),
@DriverHomeTel nvarchar(20),
@CarrierId bigint,
@CarrierName nvarchar(50),
@Packing nvarchar(50),
@ShipmentTime datetime,
@ArrivalTime datetime,
@PrepayTransportCharges numeric(25,9),
@ResidualTransportCharges numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @BusinessType nvarchar(10)
declare @PaymentType nvarchar(10)
declare @DriverId bigint
declare @DispatchBillId bigint
declare @ErrorText nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    if @CarrierId is null or @CarrierId = 0 or not exists(select * from Carrier where Id = @CarrierId)
    begin
        if @CarrierName is not null and @CarrierName <> ''
        begin
            /**/
            set @BusinessType = formatmessage(150341)
            set @PaymentType = formatmessage(150239)
            
            begin try
                exec InsertCarrier @CarrierId output, @CarrierName, @BusinessType, @PaymentType, @OpStaffId, @OpStaffName 
                exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, 50, @OpStaffId, @OpStaffName 
                if @DriverName is not null and @DriverName <> ''
                begin
                    exec InsertCarrierDriver @CarrierId, @CarNo, @DriverName, @DriverLicenseNo, @DriverMobileTel, @DriverHomeTel, @OpStaffId, @OpStaffName
                end
            end try
            begin catch
                select @ErrorText = formatmessage(150199) + error_message()
                raiserror (@ErrorText,18,1)
                return -1
            end catch
        end
    end
    else
    begin
        /**/
        if exists(select * from Carrier where Name = @CarrierName and Id <> @CarrierId)
        begin
            raiserror (150497,18,1)
            return -2
        end
        
        update Carrier set Name = @CarrierName where Id = @CarrierId 
        if @@rowcount = 0
        begin
            raiserror (150207,18,1)
            return -3
        end
        
        if exists(select * from CarrierCar where CarrierId = @CarrierId and CarNo = @CarNo)
        begin
            /**/
            update CarrierCar set TrailerNo = @TrailerNo where CarrierId = @CarrierId and CarNo = @CarNo 
            if @@rowcount = 0
            begin
                raiserror (150316,18,1)
                return -4
            end
        end
        else
        begin
            /**/
            begin try
                exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, 50, @OpStaffId, @OpStaffName 
            end try
            begin catch
                select @ErrorText = formatmessage(150203) + error_message()
                raiserror (@ErrorText,18,1)
                return -5
            end catch
        end
    
        select @DriverId = Id from CarrierDriver where CarrierId = @CarrierId and LicenseNo = @DriverLicenseNo 
        if @@rowcount = 0
        begin
            if @DriverName is not null and @DriverName <> ''
            begin
                /**/
                begin try
                    exec InsertCarrierDriver @CarrierId, @CarNo, @DriverName, @DriverLicenseNo, @DriverMobileTel, @DriverHomeTel, @OpStaffId, @OpStaffName
                end try
                begin catch
                    select @ErrorText = formatmessage(150216) + error_message()
                    raiserror (@ErrorText,18,1)
                    return -6
                end catch
            end
        end
        else
        begin
            if @DriverName is not null and @DriverName <> ''
            begin
                /**/
                update CarrierDriver set 
                    CarNo = case when charindex(@CarNo, CarNo) > 0 then CarNo else (case when CarNo is null or CarNo = '' then @CarNo else CarNo + ',' + @CarNo end) end,
                    Name = @DriverName, 
                    MobileTel = @DriverMobileTel, 
                    HomeTel = @DriverHomeTel 
                where 
                    Id = @DriverId 
                if @@rowcount = 0
                begin
                    raiserror (150299,18,1)
                    return -7
                end
            end
        end
    end
    
    /**/
    update Contract set 
        OriginalContractNo = @OriginalContractNo,
        CarNo = @CarNo,
        TrailerNo = @TrailerNo,
        CarType = @CarType,
        DriverName = @DriverName,
        DriverLicenseNo = @DriverLicenseNo,
        DriverMobileTel = @DriverMobileTel,
        DriverHomeTel = @DriverHomeTel,
        CarrierId = @CarrierId,
        CarrierName = @CarrierName,
        Packing = @Packing,
        ShipmentTime = @ShipmentTime,
        ArrivalTime = @ArrivalTime,
        PrepayTransportCharges = @PrepayTransportCharges,
        ResidualTransportCharges = @ResidualTransportCharges 
    where 
        Id = @Id and 
		IsPrestowage = 1
        
    if @@rowcount=0
    begin
        raiserror (150154,18,1)
        return -8
    end
            
    /**/
    select 
        @DispatchBillId = DispatchBillId 
    from 
        Contract 
    where 
        Id = @Id and 
		IsPrestowage = 1
        
    if @@rowcount=0
    begin
        raiserror (150142,18,1)
        return -9
    end
    
    update DispatchBill set 
        CarNo = @CarNo,
        TrailerNo = @TrailerNo,
        CarType = @CarType,
        DriverName = @DriverName,
        DriverLicenseNo = @DriverLicenseNo,
        DriverMobileTel = @DriverMobileTel,
        DriverHomeTel = @DriverHomeTel,
        CarrierId = @CarrierId,
        CarrierName = @CarrierName
    where 
        Id = @DispatchBillId
    
    if @@rowcount = 0
    begin
        raiserror (150315,18,1)
        return -10
    end

    /**/
    if exists(select * from ShipmentBill where DispatchBillId = @DispatchBillId)
    begin
        update ShipmentBill set 
            CarNo = @CarNo,
            TrailerNo = @TrailerNo,
            CarrierId = @CarrierId,
            CarrierName = @CarrierName 
        where 
            DispatchBillId = @DispatchBillId
            
        if @@rowcount = 0
        begin
            raiserror (150543,18,1)
            return -11
        end
    end
    
    /**/
    if exists(select * from DeliverBill where DispatchBillId = @DispatchBillId)
    begin
        update DeliverBill set 
            CarNo = @CarNo,
            TrailerNo = @TrailerNo,
            CarrierId = @CarrierId,
            CarrierName = @CarrierName 
        where 
            DispatchBillId = @DispatchBillId 
            
        if @@rowcount = 0
        begin
            raiserror (150544,18,1)
            return -12
        end
    end
    
    /**/
    if exists(select * from OutWarehouseBill where ShipmentBillId in (select Id from ShipmentBill where DispatchBillId = @DispatchBillId))
    begin
        update OutWarehouseBill set 
            CarNo = @CarNo,
            TrailerNo = @TrailerNo,
            CarrierId = @CarrierId,
            CarrierName = @CarrierName 
        where 
            ShipmentBillId in 
            (
                select 
                    Id 
                from 
                    ShipmentBill 
                where 
                    DispatchBillId = @DispatchBillId
            ) 
            
        if @@rowcount = 0
        begin
            raiserror (150398,18,1)
            return -13
        end
    end
    
    
    /**/
    select @OpName = formatmessage(150155)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'TrailerNo=' + @TrailerNo + N',' +
                       N'CarType=' + @CarType + N',' +
                       N'DriverName=' + @DriverName + N',' +
                       N'DriverLicenseNo=' + @DriverLicenseNo + N',' +
                       N'DriverMobileTel=' + @DriverMobileTel + N',' +
                       N'DriverHomeTel=' + @DriverHomeTel + N',' +
                       N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                       N'CarrierName=' + @CarrierName + N',' +
                       N'Packing=' + @Packing + N',' +
                       N'ShipmentTime=' + convert(nvarchar,@ShipmentTime,120) + N',' +
                       N'ArrivalTime=' + convert(nvarchar,@ArrivalTime,120) + N',' +
                       N'PrepayTransportCharges=' + convert(nvarchar,@PrepayTransportCharges) + N',' +
                       N'ResidualTransportCharges=' + convert(nvarchar,@ResidualTransportCharges) + N',' +
                       N'OriginalContractNo=' + @OriginalContractNo
                       
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -14
    end
    
    return 0
end
go


create procedure UpdateContractApproveState
@Id bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    update Contract set ApproveState = formatmessage(150439) where Id = @Id 
    if @@rowcount=0
    begin
        raiserror (150443,18,1)
        return -1
    end
            
    
    /**/
    select @OpName = formatmessage(150444)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure UpdateContractApprover
@Id bigint,
@ApproveFlowStepNum int,
@ApproveFlowStepName nvarchar(50),
@ApproverId bigint,
@ApproverName nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    update Contract set 
        ApproveFlowStepNum = @ApproveFlowStepNum,
        ApproveFlowStepName = @ApproveFlowStepName,
        ApproverId = @ApproverId,
        ApproverName = @ApproverName,
        ApproveState = formatmessage(150283)
    where 
        Id = @Id 
        
    if @@rowcount=0
    begin
        raiserror (150440,18,1)
        return -1
    end
            
    
    /**/
    select @OpName = formatmessage(150441)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'ApproveFlowStepNum=' + convert(nvarchar,@ApproveFlowStepNum) + N',' +
                       N'ApproveFlowStepName=' + @ApproveFlowStepName + N',' +
                       N'ApproverId=' + convert(nvarchar,@ApproverId) + N',' +
                       N'ApproverName=' + @ApproverName 
                       
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure UpdateContractDeliverPlan
@Id bigint,
@ContractId bigint,
@PlanId bigint, 
@Packages int,
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@TransportChargeExpression nvarchar(100),
@TransportPriceExpression nvarchar(100),
@KM int,
@TransportPrice numeric(25,9),
@TransportCharges numeric(25,9),
@Remark nvarchar(500),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @DispatchBillId bigint
declare @ContractPackages int
declare @ContractTunnages numeric(25,9)
declare @ContractPiles numeric(25,9)
declare @ContractTenThousands numeric(25,9)
declare @ContractTransportCharges numeric(25,9)
declare @DispatchBillTransportCharges numeric(25,9)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /*************************************************************************************************************************************************/
    /**/
    select 
        @DispatchBillId = DispatchBillId
    from 
        Contract 
    where 
        Id = @ContractId and 
		IsPrestowage = 1
        
    if @@rowcount = 0
    begin
        raiserror (150142,18,1)
        return -1
    end
    
    /*************************************************************************************************************************************************/
    /**/
    begin
        /**/
        select 
            @ContractPackages = Packages,
            @ContractTunnages = Tunnages,
            @ContractPiles = Piles,
            @ContractTenThousands = TenThousands,
            @ContractTransportCharges = TransportCharges 
        from 
            ContractDeliverPlan 
        where 
            Id = @Id 
        
        if @@rowcount = 0
        begin
            raiserror (150143,18,1)
            return -2
        end
    
        /**/
        update ContractDeliverPlan set 
            ContractId = @ContractId,
            PlanId = @PlanId,
            Packages = @Packages,
            Tunnages = @Tunnages,
            Piles = @Piles,
            TenThousands = @TenThousands,
            TransportChargeExpression = @TransportChargeExpression,
            TransportPriceExpression = @TransportPriceExpression,
            KM = @KM,
            TransportPrice = @TransportPrice,
            TransportCharges = @TransportCharges,
            Remark = @Remark
        where 
            Id = @Id 
            
        if @@rowcount = 0
        begin
            raiserror (150156,18,1)
            return -3
        end
        
        /**/
        update Contract set 
            TotalPackages = TotalPackages - @ContractPackages + @Packages,
            TotalTunnages = TotalTunnages - @ContractTunnages + @Tunnages,
            TotalPiles = TotalPiles - @ContractPiles + @Piles,
            TotalTenThousands = TotalTenThousands - @ContractTenThousands + @TenThousands,
            TotalTransportCharges = TotalTransportCharges - @ContractTransportCharges + @TransportCharges,
            ResidualTransportCharges =  TotalTransportCharges - @ContractTransportCharges + @TransportCharges - PrepayTransportCharges
        where 
            Id = @ContractId and 
			IsPrestowage = 1
        
        if @@rowcount = 0
        begin
            raiserror (150154,18,1)
            return -4
        end
    end
    
    /*************************************************************************************************************************************************/
    /**/
    begin
        /**/
        select 
            @DispatchBillTransportCharges = TransportCharges 
        from 
            DispatchBillDeliverPlan 
        where 
            DispatchBillId = @DispatchBillId and 
            PlanId = @PlanId 
        
        if @@rowcount = 0
        begin
            raiserror (150434,18,1)
            return -5
        end
    
        /**/
        update DispatchBillDeliverPlan set 
            TransportChargeExpression = @TransportChargeExpression,
            TransportPriceExpression = @TransportPriceExpression,
            KM = @KM,
            TransportPrice = @TransportPrice, 
            TransportCharges = @TransportCharges 
        where 
            DispatchBillId = @DispatchBillId and 
            PlanId = @PlanId 
        
        if @@rowcount = 0
        begin
            raiserror (150359,18,1)
            return -6
        end
    
        /**/
        update DispatchBill set 
            TotalTransportCharges = TotalTransportCharges - @DispatchBillTransportCharges + @TransportCharges 
        where 
            Id = @DispatchBillId 
        
        if @@rowcount = 0
        begin
            raiserror (150315,18,1)
            return -7
        end
    end
    
    
    
    /**/
    set @OpName = formatmessage(150157)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'ContractId=' + convert(nvarchar,@ContractId) + N',' +
                    N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'TransportChargeExpression=' + @TransportChargeExpression + N',' +
                    N'TransportPriceExpression=' + @TransportPriceExpression + N',' +
                    N'KM=' + convert(nvarchar,@KM) + N',' +
                    N'TransportPrice=' + convert(nvarchar,@TransportPrice) + N',' +
                    N'TransportCharges=' + convert(nvarchar,@TransportCharges) + N',' +
                    N'Remark=' + @Remark
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -8
    end
    
    return 0
end
go


create procedure UpdateContractDeliverPlanApprovedTransportPrice
@Id bigint,
@ContractId bigint,
@PlanId bigint, 
@ApprovedTransportPrice numeric(25,9),
@ApprovedTransportCharges numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OldTransportCharges numeric(25,9)
declare @TotalTransportCharges numeric(25,9)
declare @DispatchBillId bigint
declare @DispatchBillTransportPrice numeric(25,9)
declare @DispatchBillTransportCharges numeric(25,9)
declare @CommentId bigint
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @DispatchBillId = DispatchBillId from Contract where Id = @ContractId
    if @@rowcount = 0
    begin
        raiserror (150142,18,1)
        return -1
    end
    
    /**/
    select 
        @DispatchBillTransportPrice = TransportPrice, 
        @DispatchBillTransportCharges = TransportCharges 
    from 
        DispatchBillDeliverPlan 
    where 
        DispatchBillId = @DispatchBillId and 
        PlanId = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150434,18,1)
        return -2
    end
    
    /**/
    update DispatchBillDeliverPlan set 
        TransportPrice = @ApprovedTransportPrice, 
        TransportCharges = @ApprovedTransportCharges 
    where 
        DispatchBillId = @DispatchBillId and 
        PlanId = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150359,18,1)
        return -3
    end
    
    /**/
    update DispatchBill set 
        TotalTransportCharges = TotalTransportCharges - @DispatchBillTransportCharges + @ApprovedTransportCharges 
    where 
        Id = @DispatchBillId 
    if @@rowcount = 0
    begin
        raiserror (150315,18,1)
        return -4
    end
    
    /**/
    select @TotalTransportCharges = TotalTransportCharges from DispatchBill where Id = @DispatchBillId
    if @@rowcount = 0
    begin
        raiserror (150319,18,1)
        return -5
    end
    
    /**/
    update ContractDeliverPlan set 
        ApprovedTransportPrice = @ApprovedTransportPrice, 
        ApprovedTransportCharges = @ApprovedTransportCharges 
    where 
        Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150156,18,1)
        return -6
    end
    
    /**/
    update Contract set 
        TotalTransportCharges = @TotalTransportCharges,
        ResidualTransportCharges = @TotalTransportCharges - isnull(PrepayTransportCharges, 0.00) 
    where 
        Id = @ContractId
    if @@rowcount = 0
    begin
        raiserror (150154,18,1)
        return -7
    end
    
    /**/
    exec GetId @OpStaffId, @CommentId output 
    insert into ContractApproveComment 
        (
            Id,
            ContractId,
            PlanId,
            ApprovedTransportPrice,
            ApprovedTransportCharges,
            ApproverId,
            ApproverName,
            ApproveTime
        )
    values
        (
            @CommentId,
            @ContractId,
            @PlanId,
            @ApprovedTransportPrice,
            @ApprovedTransportCharges,
            @OpStaffId,
            @OpStaffName,
            getdate()
        )
    if @@rowcount = 0
    begin
        raiserror (150616,18,1)
        return -8
    end
    
        
    /**/
    set @OpName = formatmessage(150445)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'ContractId=' + convert(nvarchar,@ContractId) + N',' +
                    N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                    N'ApprovedTransportPrice=' + convert(nvarchar,@ApprovedTransportPrice) + N',' +
                    N'ApprovedTransportCharges=' + convert(nvarchar,@ApprovedTransportCharges) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -9
    end
    
    return 0
end
go


create procedure UpdateContractFineAmount
@Id bigint,
@FineAmount numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    update Contract set FineAmount = @FineAmount, FineTime = getdate() where Id = @Id
    if @@rowcount=0
    begin
        raiserror (150457,18,1)
        return -1
    end
            
    
    /**/
    select @OpName = formatmessage(150458)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'FineAmount=' + convert(nvarchar,@FineAmount) 
                       
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure UpdateDeliverBillGoods 
@Id bigint,
@DeliverBillId bigint,
@GoodsId bigint,
@GoodsNo nvarchar(20),
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Location nvarchar(10),
@Packages int,
@PieceWeight numeric(25,9),
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @ShipmentBillId bigint
declare @DispatchBillId bigint
declare @PlanId bigint
declare @CustomerId bigint
declare @PlanType nvarchar(10)
declare @Warehouse nvarchar(20)
declare @ConsignedDeliveryNo nvarchar(20)
declare @OldPackages int
declare @OldTunnages numeric(25,9)
declare @OldPiles numeric(25,9)
declare @OldTenThousands numeric(25,9)
declare @DeliveryNo nvarchar(20)
declare @OutWarehouseBillId bigint
declare @OutWarehouseBillPackages int
declare @OutWarehouseBillTunnages numeric(25,9)
declare @OutWarehouseBillPiles numeric(25,9)
declare @OutWarehouseBillTenThousands numeric(25,9)
declare @StockOutWarehouseDetailId bigint
declare @StockId bigint
declare @OldForceFee numeric(25,9)
declare @OutWarehouseBillOldTotalTunnages numeric(25,9)
declare @OutWarehouseBillOldTotalPiles numeric(25,9)
declare @OutWarehouseBillTotalTunnages numeric(25,9)
declare @OutWarehouseBillTotalPiles numeric(25,9)
declare @CheckPackages int
declare @CheckPiles numeric(25,9)
declare @CreateTime datetime
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /*1.*/
    select 
        @ShipmentBillId = ShipmentBillId, 
        @DispatchBillId = DispatchBillId, 
        @PlanId = PlanId 
    from 
        DeliverBill 
    where 
        Id = @DeliverBillId
    if @@rowcount = 0
    begin
        raiserror (150415,18,1)
        return -1
    end
    
    /*2.*/
    select 
        @CustomerId = CustomerId, 
        @PlanType = PlanType,
        @Warehouse = Warehouse, 
        @ConsignedDeliveryNo = ConsignedDeliveryNo 
    from 
        DeliverPlan 
    where 
        Id = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150251,18,1)
        return -2
    end
    
    /*3.*/
    select 
        @OldPackages = Packages, 
        @OldTunnages = Tunnages,
        @OldPiles = Piles,
        @OldTenThousands = TenThousands
    from 
        DeliverBillGoods 
    where 
        Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150417,18,1)
        return -3
    end
    
    /*4.*/
    update DeliverBillGoods set 
        Packages = case when @PlanType = formatmessage(150256) then @Packages else Packages end,
        PieceWeight = case when @PlanType = formatmessage(150256) then @PieceWeight else PieceWeight end,
        Tunnages = case when @PlanType = formatmessage(150256) then @Tunnages else Tunnages end,
        Piles = case when @PlanType = formatmessage(150257) then @Piles else Piles end,
        TenThousands = case when @PlanType = formatmessage(150257) then @TenThousands else TenThousands end
    where 
        Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150418,18,1)
        return -4
    end
        
    /*5.*/
    update ShipmentBillGoods set 
        Packages = case when @PlanType = formatmessage(150256) then @Packages else Packages end,
        PieceWeight = case when @PlanType = formatmessage(150256) then @PieceWeight else PieceWeight end,
        Tunnages = case when @PlanType = formatmessage(150256) then @Tunnages else Tunnages end,
        Piles = case when @PlanType = formatmessage(150257) then @Piles else Piles end,
        TenThousands = case when @PlanType = formatmessage(150257) then @TenThousands else TenThousands end
    where 
        ShipmentBillId = @ShipmentBillId and 
        GoodsId = @GoodsId and 
        BatchNo = @BatchNo and 
        Packing = @Packing and 
        Location = @Location and 
        ProductionDate = @ProductionDate and 
        EnterWarehouseBillId = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150379,18,1)
        return -5
    end
        
    /*6.*/
    select 
        @OutWarehouseBillId = Id,
        @CreateTime = CreateTime
    from 
        OutWarehouseBill 
    where 
        ShipmentBillId = @ShipmentBillId 
    if @@rowcount = 0
    begin
        raiserror (150395,18,1)
        return -6
    end
        
    select 
        @OutWarehouseBillOldTotalTunnages = sum(Tunnages), 
        @OutWarehouseBillOldTotalPiles = sum(Piles)
    from 
        OutWarehouseBillGoods 
    where 
        OutWarehouseBillId = @OutWarehouseBillId 
        
    update OutWarehouseBillGoods set 
        Packages = case when @PlanType = formatmessage(150256) then @Packages else Packages end,
        PieceWeight = case when @PlanType = formatmessage(150256) then @PieceWeight else PieceWeight end,
        Tunnages = case when @PlanType = formatmessage(150256) then @Tunnages else Tunnages end,
        Piles = case when @PlanType = formatmessage(150257) then @Piles else Piles end,
        TenThousands = case when @PlanType = formatmessage(150257) then @TenThousands else TenThousands end
    where 
        OutWarehouseBillId = @OutWarehouseBillId and 
        GoodsId = @GoodsId and 
        BatchNo = @BatchNo and 
        Packing = @Packing and 
        Location = @Location and 
        ProductionDate = @ProductionDate and 
        EnterWarehouseBillId = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150398,18,1)
        return -7
    end
    
    /*7.*/
    select @OldForceFee = ForceFee from OutWarehouseBill where Id = @OutWarehouseBillId 
    if @@rowcount = 0
    begin
        raiserror (150395,18,1)
        return -8
    end
    
    select 
        @OutWarehouseBillTotalTunnages = sum(Tunnages), 
        @OutWarehouseBillTotalPiles = sum(Piles)
    from 
        OutWarehouseBillGoods 
    where 
        OutWarehouseBillId = @OutWarehouseBillId 
        
    update OutWarehouseBill set 
        ForceFee = case 
                       when @OutWarehouseBillOldTotalTunnages > 0 then 
                           round(@OldForceFee / @OutWarehouseBillOldTotalTunnages * @OutWarehouseBillTotalTunnages, 2)
                       else 
                           round(@OldForceFee / @OutWarehouseBillOldTotalPiles * @OutWarehouseBillTotalPiles, 2)
                   end
    where 
        Id = @OutWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150398,18,1)
        return -9
    end
        
    /*7.*/
    update DispatchBillGoods set 
        Packages = case when @PlanType = formatmessage(150256) then @Packages else Packages end,
        PieceWeight = case when @PlanType = formatmessage(150256) then @PieceWeight else PieceWeight end,
        Tunnages = case when @PlanType = formatmessage(150256) then @Tunnages else Tunnages end,
        Piles = case when @PlanType = formatmessage(150257) then @Piles else Piles end,
        TenThousands = case when @PlanType = formatmessage(150257) then @TenThousands else TenThousands end
    where 
        DispatchBillId = @DispatchBillId and 
        PlanId = @PlanId and 
        GoodsId = @GoodsId and 
        BatchNo = @BatchNo and 
        Packing = @Packing and 
        Location = @Location and 
        ProductionDate = @ProductionDate and 
        EnterWarehouseBillId = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150381,18,1)
        return -10
    end
        
    /*8.*/
    update DispatchBillDeliverPlan set 
        Packages = case when @PlanType = formatmessage(150256) then Packages + @Packages - @OldPackages else Packages end,
        Tunnages = case when @PlanType = formatmessage(150256) then Tunnages + @Tunnages - @OldTunnages else Tunnages end,
        Piles = case when @PlanType = formatmessage(150257) then Piles + @Piles - @OldPiles else Piles end,
        TenThousands = case when @PlanType = formatmessage(150257) then TenThousands + @TenThousands - @OldTenThousands else TenThousands end
    where 
        DispatchBillId = @DispatchBillId and 
        PlanId = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150359,18,1)
        return -11
    end
        
    /*9.*/
    update DispatchBill set 
        TotalPackages = case when @PlanType = formatmessage(150256) then TotalPackages + @Packages - @OldPackages else TotalPackages end,
        TotalTunnages = case when @PlanType = formatmessage(150256) then TotalTunnages + @Tunnages - @OldTunnages else TotalTunnages end,
        TotalPiles = case when @PlanType = formatmessage(150257) then TotalPiles + @Piles - @OldPiles else TotalPiles end,
        TotalTenThousands = case when @PlanType = formatmessage(150257) then TotalTenThousands + @TenThousands - @OldTenThousands else TotalTenThousands end
    where 
        Id = @DispatchBillId 
    if @@rowcount = 0
    begin
        raiserror (150315,18,1)
        return -12
    end
        
    /*10.*/
    update DeliverPlanGoods set 
        Packages = case when @PlanType = formatmessage(150256) then Packages - @OldPackages + @Packages else Packages end,
        PieceWeight = case when @PlanType = formatmessage(150256) then @PieceWeight else PieceWeight end,
        Tunnages = case when @PlanType = formatmessage(150256) then Tunnages - @OldTunnages + @Tunnages else Tunnages end,
        Piles = case when @PlanType = formatmessage(150257) then Piles - @OldPiles + @Piles else Piles end,
        TenThousands = case when @PlanType = formatmessage(150257) then TenThousands - @OldTenThousands + @TenThousands else TenThousands end
    where 
        PlanId = @PlanId and 
        GoodsId = @GoodsId and 
        BatchNo = @BatchNo and 
        Packing = @Packing and 
        Location = @Location and 
        ProductionDate = @ProductionDate and 
        EnterWarehouseBillId = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150545,18,1)
        return -13
    end
    
    /*11.*/
    begin try
        exec RestoreStock @OutWarehouseBillId, @CreateTime, @OpStaffId, @OpStaffName 
    end try
    begin catch
        select @ErrorText = error_message()
        raiserror (@ErrorText,18,1)
        return -14
    end catch
        
    /*12.*/
    set @CheckPackages = @Packages - @OldPackages
    set @CheckPiles = @Piles - @OldPiles
    
    begin try
        exec CheckStock 
        @CustomerId, 
        @PlanType, 
        @GoodsId, 
        @GoodsNo, 
        @BatchNo, 
        @Packing, 
        @Warehouse, 
        @Location, 
        @ProductionDate, 
        @EnterWarehouseBillId, 
        @ConsignedDeliveryNo,
        @CheckPackages,
        @CheckPiles,
        @OpStaffId, 
        @OpStaffName 
    end try
    begin catch
        select @ErrorText = error_message()
        raiserror (@ErrorText,18,1)
        return -15
    end catch
    
    /*13.*/
    declare Cursor2 cursor local for 
        select 
            GoodsId, 
            GoodsNo,
            BatchNo,
            Packing,
            Location,
            Packages,
            Tunnages,
            Piles,
            TenThousands,
            ProductionDate,
            EnterWarehouseBillId,
            DeliveryNo
        from 
            OutWarehouseBillGoods 
        where 
            OutWarehouseBillId = @OutWarehouseBillId 
    
    open Cursor2
    fetch next from Cursor2 into 
        @GoodsId, 
        @GoodsNo, 
        @BatchNo, 
        @Packing,
        @Location,
        @Packages,
        @Tunnages,
        @Piles,
        @TenThousands,
        @ProductionDate,
        @EnterWarehouseBillId,
        @DeliveryNo
        
    while @@fetch_status = 0
    begin
        begin try
            exec SubtractStock 
            @CustomerId, 
            @DeliveryNo, 
            @GoodsId, 
            @GoodsNo, 
            @BatchNo, 
            @Packing, 
            @Warehouse, 
            @Location, 
            @ProductionDate, 
            @EnterWarehouseBillId, 
            @ConsignedDeliveryNo,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @OutWarehouseBillId,
            @CreateTime,
            @OpStaffId, 
            @OpStaffName 
        end try
        begin catch
            select @ErrorText = error_message()
            raiserror (@ErrorText,18,1)
            return -16
        end catch
    
        fetch next from Cursor2 into 
            @GoodsId, 
            @GoodsNo, 
            @BatchNo, 
            @Packing,
            @Location,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @ProductionDate,
            @EnterWarehouseBillId,
            @DeliveryNo
    end
        
    close Cursor2
    deallocate Cursor2
        
    
    /**/
    select @OpName = formatmessage(150423)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'DeliverBillId=' + convert(nvarchar,@DeliverBillId) + N',' +
                       N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                       N'GoodsNo=' + @GoodsNo + N',' +
                       N'BatchNo=' + @BatchNo + N',' +
                       N'Packing=' + @Packing + N',' +
                       N'Location=' + @Location + N',' +
                       N'Packages=' + convert(nvarchar,@Packages) + N',' +
                       N'PieceWeight=' + convert(nvarchar,@PieceWeight) + N',' +
                       N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                       N'Piles=' + convert(nvarchar,@Piles) + N',' +
                       N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                       N'ProductionDate=' + @ProductionDate + N',' +
                       N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -17
    end
    
    return 0
end
go


create procedure UpdateContractGoods
@DispatchBillId bigint,
@PlanId bigint, 
@GoodsId bigint,
@GoodsNo nvarchar(20),
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Location nvarchar(10),
@Packages int,
@PieceWeight numeric(25,9),
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @PlanType nvarchar(10)
declare @DeliverBillId bigint
declare @DeliverBillGoodsId bigint
declare @ErrorText nvarchar(max)
declare @OldPackages int 
declare @OldTunnages numeric(25,9)
declare @OldPiles numeric(25,9)
declare @OldTenThousands numeric(25,9)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select @PlanType = PlanType from DeliverPlan where Id = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150251,18,1)
        return -1
    end
    
    /**/
    if @PlanType = formatmessage(150256) or @PlanType = formatmessage(150257)
    begin
        /**/
        select @DeliverBillId =  Id from DeliverBill where DispatchBillId = @DispatchBillId and PlanId = @PlanId
        if @@rowcount = 0
        begin
            raiserror (150415,18,1)
            return -2
        end
        
        /**/
        select 
            @DeliverBillGoodsId = Id 
        from 
            DeliverBillGoods 
        where 
            DeliverBillId = @DeliverBillId and 
            GoodsId = @GoodsId and 
            BatchNo = @BatchNo and 
            Packing = @Packing and 
            Location = @Location and 
            ProductionDate = @ProductionDate and 
            EnterWarehouseBillId = @EnterWarehouseBillId
        if @@rowcount = 0
        begin
            raiserror (150417,18,1)
            return -3
        end
        
        /**/
        begin try
            exec UpdateDeliverBillGoods 
                @DeliverBillGoodsId,
                @DeliverBillId, 
                @GoodsId, 
                @GoodsNo,
                @BatchNo,
                @Packing,
                @Location,
                @Packages,
                @PieceWeight,
                @Tunnages,
                @Piles,
                @TenThousands,
                @ProductionDate,
                @EnterWarehouseBillId,
                @OpStaffId, 
                @OpStaffName 
        end try
        begin catch
            select @ErrorText = error_message()
            raiserror (@ErrorText,18,1)
            return -4
        end catch
    end
    else
    begin
        /*1.*/
        begin
            /**/
            select 
                @OldPackages = Packages,
                @OldTunnages = Tunnages,
                @OldPiles = Piles,
                @OldTenThousands = TenThousands
            from 
                DispatchBillGoods 
            where 
                DispatchBillId = @DispatchBillId and 
                PlanId = @PlanId and 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and 
                Location = @Location and 
                ProductionDate = @ProductionDate and 
                EnterWarehouseBillId = @EnterWarehouseBillId
            if @@rowcount = 0
            begin
                raiserror (150614,18,1)
                return -5
            end
    
            /**/
            update DispatchBillGoods set 
                Packages = @Packages,
                PieceWeight = @PieceWeight,
                Tunnages = @Tunnages,
                Piles = @Piles,
                TenThousands = @TenThousands 
            where 
                DispatchBillId = @DispatchBillId and 
                PlanId = @PlanId and 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and 
                Location = @Location and 
                ProductionDate = @ProductionDate and 
                EnterWarehouseBillId = @EnterWarehouseBillId
            if @@rowcount = 0
            begin
                raiserror (150381,18,1)
                return -6
            end
            
            /**/
            update DispatchBillDeliverPlan set 
                Packages = Packages - @OldPackages + @Packages, 
                Tunnages = Tunnages - @OldTunnages + @Tunnages,
                Piles = Piles - @OldPiles + @Piles,
                TenThousands = TenThousands - @OldTenThousands + @TenThousands
            where 
                DispatchBillId = @DispatchBillId and 
                PlanId = @PlanId 
            if @@rowcount = 0
            begin
                raiserror (150359,18,1)
                return -7
            end
        
            /**/
            update DispatchBill set 
                TotalPackages = TotalPackages - @OldPackages + @Packages, 
                TotalTunnages = TotalTunnages - @OldTunnages + @Tunnages,
                TotalPiles = TotalPiles - @OldPiles + @Piles,
                TotalTenThousands = TotalTenThousands - @OldTenThousands + @TenThousands
            where 
                Id = @DispatchBillId 
            if @@rowcount = 0
            begin
                raiserror (150315,18,1)
                return -8
            end
        end
    
        /*2.*/
        if exists(
            select 
                * 
            from 
                DeliverBillGoods 
            where 
                DeliverBillId in 
                (
                    select Id from DeliverBill where DispatchBillId = @DispatchBillId and PlanId = @PlanId
                ) and 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and 
                Location = @Location and 
                ProductionDate = @ProductionDate and 
                EnterWarehouseBillId = @EnterWarehouseBillId
        )
        begin
            /**/
            update DeliverBillGoods set 
                Packages = @Packages,
                PieceWeight = @PieceWeight,
                Tunnages = @Tunnages,
                Piles = @Piles,
                TenThousands = @TenThousands 
            where 
                DeliverBillId in (select Id from DeliverBill where DispatchBillId = @DispatchBillId and PlanId = @PlanId) and 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and 
                Location = @Location and 
                ProductionDate = @ProductionDate and 
                EnterWarehouseBillId = @EnterWarehouseBillId
            if @@rowcount = 0
            begin
                raiserror (150418,18,1)
                return -9
            end
        end
    
        /*3.*/
        begin
            /**/
            update DeliverPlanGoods set 
                Packages = Packages - @OldPackages + @Packages,
                PieceWeight = @PieceWeight, 
                Tunnages = Tunnages - @OldTunnages + @Tunnages,
                Piles = Piles - @OldPiles + @Piles,
                TenThousands = TenThousands - @OldTenThousands + @TenThousands
            where 
                PlanId = @PlanId and 
                GoodsId = @GoodsId and 
                BatchNo = @BatchNo and 
                Packing = @Packing and 
                Location = @Location and 
                ProductionDate = @ProductionDate and 
                EnterWarehouseBillId = @EnterWarehouseBillId
            if @@rowcount = 0
            begin
                raiserror (150545,18,1)
                return -10
            end
        end
    end
    
    
    /**/
    set @OpName = formatmessage(150546)
    set @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) + N',' +
                    N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'Location=' + @Location + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'PieceWeight=' + convert(nvarchar,@PieceWeight) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId)
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -11
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @Name
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure UpdateCountry
@Id bigint,
@Name nvarchar(20),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	if exists(select 1 from Country where Name = @Name and Id <> @Id)
    begin
        raiserror (150026,18,1)
        return -1
    end

    /**/
    update Country set Name=@Name, Remark=@Remark where Id = @Id 
    if @@rowcount=0
    begin
        raiserror (150031,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150032)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'Name=' + @Name + N',' +
                       N'Remark=' + @Remark 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure UpdateCustomer 
@Id bigint, 
@Name nvarchar(50),
@FullName nvarchar(50),
@WarningStock int,
@StopStock int,
@SettlementExpression nvarchar(100),
@ValuationMode nvarchar(20),
@GrossWeightRate numeric(25,9),
@Remark nvarchar(500),
@OwnOrganId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OwnOrganName nvarchar(50)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from Customer where Name = @Name and Id <> @Id)
    begin
        raiserror (150084,18,1)
        return -1
    end
    
    /**/
    select @OwnOrganName = Name from Organization where Id = @OwnOrganId 
    if @@rowcount = 0
    begin
        raiserror (150073,18,1)
        return -2
    end
    
    /**/
    update Customer set 
        Name = @Name,
        FullName = @FullName,
        WarningStock = @WarningStock,
        StopStock = @StopStock,
        SettlementExpression = @SettlementExpression,
        ValuationMode = @ValuationMode,
        GrossWeightRate = @GrossWeightRate,
        Remark = @Remark,
        OwnOrganId = @OwnOrganId,
        OwnOrganName = @OwnOrganName  
    where 
        Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150087,18,1)
        return -3
    end
    
    /**/
    set @OpName = formatmessage(150088)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'Name=' + @Name + N',' +
                    N'FullName=' + @FullName + N',' +
                    N'WarningStock=' + convert(nvarchar,@WarningStock) + N',' +
                    N'StopStock=' + convert(nvarchar,@StopStock) + N',' +
                    N'SettlementExpression=' + @SettlementExpression + N',' +
                    N'ValuationMode=' + @ValuationMode + N',' +
                    N'GrossWeightRate=' + convert(nvarchar,@GrossWeightRate) + N',' +
                    N'Remark=' + @Remark + N',' +
                    N'OwnOrganId=' + convert(nvarchar,@OwnOrganId) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


create procedure UpdateCustomerForceFeePrice
@Id bigint,
@CustomerId bigint, 
@StartTime datetime,
@EndTime datetime,
@LoadingForceFeePrice numeric(25,9),
@UnloadingForceFeePrice numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    update CustomerForceFeePrice set 
        CustomerId = @CustomerId,
        StartTime = @StartTime,
        EndTime = @EndTime,
        LoadingForceFeePrice = @LoadingForceFeePrice,
        UnloadingForceFeePrice = @UnloadingForceFeePrice 
    where 
        Id = @Id
    
    if @@rowcount = 0
    begin
        raiserror (150664,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150665)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'StartTime=' + convert(nvarchar(10),@StartTime,120) + N',' +
                    N'EndTime=' + convert(nvarchar(10),@EndTime,120) + N',' +
                    N'LoadingForceFeePrice=' + convert(nvarchar,@LoadingForceFeePrice) + N',' +
                    N'UnloadingForceFeePrice=' + convert(nvarchar,@UnloadingForceFeePrice)
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure UpdateCustomerStorageFeePrice
@Id bigint,
@CustomerId bigint, 
@StartTime datetime,
@EndTime datetime,
@StorageFeePrice numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    update CustomerStorageFeePrice set 
        CustomerId = @CustomerId,
        StartTime = @StartTime,
        EndTime = @EndTime,
        StorageFeePrice = @StorageFeePrice
    where 
        Id = @Id
    
    if @@rowcount = 0
    begin
        raiserror (150666,18,1)
        return -1
    end
    
    
    /**/
    set @OpName = formatmessage(150667)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'StartTime=' + convert(nvarchar(10),@StartTime,120) + N',' +
                    N'EndTime=' + convert(nvarchar(10),@EndTime,120) + N',' +
                    N'StorageFeePrice=' + convert(nvarchar,@StorageFeePrice)
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure UpdateDeliverBillDeliveryNo 
@Id bigint,
@DeliveryNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    update DeliverBill set DeliveryNo = @DeliveryNo where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150544,18,1)
        return -1
    end
    
    
    /**/
    select @OpName = formatmessage(150685)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'DeliveryNo=' + @DeliveryNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure UpdateDeliverBillReceipt 
@Id bigint,
@ReturnTime datetime,
@DamageInfo nvarchar(200),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @PlanId bigint
declare @PlanType nvarchar(10)
declare @DeliveryCompleted bit
declare @GoodsId bigint
declare @BatchNo nvarchar(20)
declare @Packages int
declare @DeliverPackages int
declare @Piles numeric(25,9)
declare @DeliverPiles numeric(25,9)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    update DeliverBill set ReturnTime = @ReturnTime, DamageInfo = @DamageInfo where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150431,18,1)
        return -1
    end
    
    /**/
    select @PlanId = PlanId from DeliverBill where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150415,18,1)
        return -2
    end
    
    select @PlanType = PlanType from DeliverPlan where Id = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150251,18,1)
        return -3
    end
    
    set @DeliveryCompleted = 1
    
    declare Cursor1 cursor local for 
        select GoodsId, BatchNo, Packages, Piles from DeliverPlanGoods where PlanId = @PlanId 
            
    open Cursor1
    fetch next from Cursor1 into @GoodsId, @BatchNo, @Packages, @Piles 
    while @@fetch_status = 0
    begin
        select 
            @DeliverPackages = isnull(sum(g.Packages),0),
            @DeliverPiles = isnull(sum(g.Piles),0.0) 
        from 
            DeliverBillGoods g join 
            DeliverBill b on g.DeliverBillId = b.Id 
        where 
            g.GoodsId = @GoodsId and 
            g.BatchNo = @BatchNo and 
            b.PlanId = @PlanId 
            
        if @PlanType <> formatmessage(150257) and @PlanType <> formatmessage(150619)
        begin
            if @DeliverPackages < @Packages
            begin 
                set @DeliveryCompleted = 0 
                break
            end
        end
        else
        begin
            if @DeliverPiles < @Piles
            begin 
                set @DeliveryCompleted = 0 
                break
            end
        end
        
        fetch next from Cursor1 into @GoodsId, @BatchNo, @Packages, @Piles 
    end 
        
    close Cursor1
    deallocate Cursor1 
    
    if @DeliveryCompleted = 1
    begin
        update DeliverPlan set PlanState = formatmessage(150243) where Id = @PlanId
        if @@rowcount = 0
        begin
            raiserror (150270,18,1)
            return -4
        end
    end
    
    
    /**/
    select @OpName = formatmessage(150432)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'ReturnTime=' + convert(nvarchar,@ReturnTime,120) + N',' +
                       N'DamageInfo=' + @DamageInfo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -5
    end
    
    return 0
end
go


create procedure UpdateDeliverPlan
@Id bigint,
@PlanType nvarchar(10),
@CustomerId bigint,
@ShipmentNo nvarchar(20),
@DeliveryNo nvarchar(20),
@DeliverType nvarchar(10),
@ReceiverName nvarchar(50),
@ReceiverCountry nvarchar(20),
@ReceiverProvince nvarchar(20),
@ReceiverCity nvarchar(20),
@ReceiverAddress nvarchar(50),
@ReceiverContact nvarchar(20),
@ReceiverContactTel nvarchar(20),
@OrderNo nvarchar(20),
@ReceiveType nvarchar(10),
@CarNo nvarchar(20),
@TrailerNo nvarchar(10),
@DriverName nvarchar(20),
@DriverLicenseNo nvarchar(20),
@DriverMobileTel nvarchar(20),
@DriverHomeTel nvarchar(20),
@Warehouse nvarchar(20),
@ArrivalTime nvarchar(10),
@PayerId bigint,
@PayerName nvarchar(50),
@IsConsigning bit,
@ConsignedDeliveryNo nvarchar(20),
@IsInstalment bit,
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@Remark nvarchar(500),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @CustomerName nvarchar(50)
declare @SettlementExpression nvarchar(100)
declare @OwnOrganId bigint
declare @OwnOrganName nvarchar(50)
declare @CarrierId bigint
declare @CarrierName nvarchar(50)
declare @ReceiverId bigint
declare @BusinessType nvarchar(10)
declare @PaymentType nvarchar(10)
declare @PlanState nvarchar(10)
declare @DriverId bigint
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    if @ConsignedDeliveryNo is not null and @ConsignedDeliveryNo <> ''
    begin
        if not exists(select * from Stock where Warehouse = @Warehouse and DeliveryNo = @ConsignedDeliveryNo and Packages > 0)
        begin
		    raiserror (150236,18,1)
            return -2
        end
    end

    /**/
    select @CustomerName = Name, @SettlementExpression = SettlementExpression, @OwnOrganId = OwnOrganId, @OwnOrganName = OwnOrganName from Customer where Id = @CustomerId 
    if @@rowcount = 0
    begin
        raiserror (150082,18,1)
        return -3
    end
    
    /**/
    if @CarNo is not null and @CarNo <> ''
    begin
        select @CarrierId = CarrierId from CarrierCar where CarNo = @CarNo 
        if @@rowcount = 0
        begin
            if @DriverName is not null and @DriverName <> ''
            begin
                /**/
                set @CarrierName = @DriverName 
                set @BusinessType = formatmessage(150341)
                set @PaymentType = formatmessage(150239)
            
                begin try
                    exec InsertCarrier @CarrierId output, @CarrierName, @BusinessType, @PaymentType, @OpStaffId, @OpStaffName 
                    exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, 0, @OpStaffId, @OpStaffName 
                    exec InsertCarrierDriver @CarrierId, @CarNo, @DriverName, @DriverLicenseNo, @DriverMobileTel, @DriverHomeTel, @OpStaffId, @OpStaffName
                end try
                begin catch
                    select @ErrorText = formatmessage(150199) + error_message()
                    raiserror (@ErrorText,18,1)
                    return -4
                end catch
            end
        end
        else
        begin
            select @CarrierName = Name from Carrier where Id = @CarrierId 
            if @@rowcount = 0
            begin
                raiserror (150205,18,1)
                return -5
            end
            
            if exists(select * from CarrierCar where CarrierId = @CarrierId and CarNo = @CarNo)
            begin
                /**/
                update CarrierCar set TrailerNo = @TrailerNo where CarrierId = @CarrierId and CarNo = @CarNo 
                if @@rowcount = 0
                begin
                    raiserror (150316,18,1)
                    return -6
                end
            end
            else
            begin
                /**/
                begin try
                    exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, 0, @OpStaffId, @OpStaffName 
                end try
                begin catch
                    select @ErrorText = formatmessage(150203) + error_message()
                    raiserror (@ErrorText,18,1)
                    return -7
                end catch
            end
            
            select @DriverId = Id from CarrierDriver where CarrierId = @CarrierId and LicenseNo = @DriverLicenseNo 
            if @@rowcount = 0
            begin
                if @DriverName is not null and @DriverName <> ''
                begin
                    /**/
                    begin try
                        exec InsertCarrierDriver @CarrierId, @CarNo, @DriverName, @DriverLicenseNo, @DriverMobileTel, @DriverHomeTel, @OpStaffId, @OpStaffName
                    end try
                    begin catch
                        select @ErrorText = formatmessage(150216) + error_message()
                        raiserror (@ErrorText,18,1)
                        return -8
                    end catch
                end
            end
            else
            begin
                if @DriverName is not null and @DriverName <> ''
                begin
                    /**/
                    update CarrierDriver set 
                        CarNo = case when charindex(@CarNo, CarNo) > 0 then CarNo else (case when CarNo is null or CarNo = '' then @CarNo else CarNo + ',' + @CarNo end) end,
                        Name = @DriverName, 
                        MobileTel = @DriverMobileTel, 
                        HomeTel = @DriverHomeTel 
                    where 
                        Id = @DriverId 
                    if @@rowcount = 0
                    begin
                        raiserror (150299,18,1)
                        return -9
                    end
                end
            end
        end
    end
    
    /**/
    if @PayerId is null or @PayerId = 0
    begin
        select @PayerId = Id from Customer where Name = @PayerName
        if @@rowcount = 0
        begin
            /**/
            begin try
                declare @ValuationMode nvarchar(20)
                set @ValuationMode = formatmessage(150620)
                
                exec InsertCustomer 
                    @PayerId output, 
                    @PayerName, 
                    @PayerName, 
                    0, 
                    0, 
                    0, 
                    0, 
                    0, 
                    @SettlementExpression, 
                    @ValuationMode,
                    1,
                    N'', 
                    @OwnOrganId, 
                    @OpStaffId, 
                    @OpStaffName 
            end try
            begin catch
                select @ErrorText = formatmessage(150240) + error_message()
                raiserror (@ErrorText,18,1)
                return -10
            end catch
        end
    end
    
    /**/
    update DeliverPlan set 
        PlanType = @PlanType,
        CustomerId = @CustomerId,
        CustomerName = @CustomerName,
        ShipmentNo = @ShipmentNo,
        DeliveryNo = @DeliveryNo,
        DeliverType = @DeliverType,
        ReceiverName = @ReceiverName,
        ReceiverCountry = @ReceiverCountry,
        ReceiverProvince = @ReceiverProvince,
        ReceiverCity = @ReceiverCity,
        ReceiverAddress = @ReceiverAddress,
        ReceiverContact = @ReceiverContact,
        ReceiverContactTel = @ReceiverContactTel,
        OrderNo = @OrderNo,
        ReceiveType = @ReceiveType,
        CarNo = @CarNo,
        TrailerNo = @TrailerNo,
        DriverName = @DriverName,
        DriverLicenseNo = @DriverLicenseNo,
        DriverMobileTel = @DriverMobileTel,
        DriverHomeTel = @DriverHomeTel,
        CarrierId = @CarrierId,
        CarrierName = @CarrierName,
        Warehouse = @Warehouse,
        ArrivalTime = @ArrivalTime,
        PayerId = @PayerId,
        PayerName = @PayerName,
        IsConsigning = @IsConsigning,
        ConsignedDeliveryNo = @ConsignedDeliveryNo,
        IsInstalment = @IsInstalment,
        StartCountry = @StartCountry,
        StartProvince = @StartProvince,
        StartCity = @StartCity,
        Remark = @Remark,
        CreateTime = @CreateTime,
        OwnOrganId = @OwnOrganId,
        OwnOrganName = @OwnOrganName
    where  
        Id = @Id 
    
    if @@rowcount=0
    begin
        raiserror (150264,18,1)
        return -11
    end
    
    /**/
    if exists(select * from Receiver where Name = @ReceiverName)
    begin
        update Receiver set 
            Country = @ReceiverCountry, 
            Province = @ReceiverProvince, 
            City = @ReceiverCity, 
            Address = @ReceiverAddress, 
            Contact = @ReceiverContact, 
            ContactTel = @ReceiverContactTel 
        where 
            Name = @ReceiverName 
            
        if @@rowcount = 0
        begin
            raiserror (150245,18,1)
            return -12
        end
    end
    else
    begin
        exec GetId @OpStaffId, @ReceiverId output 
    
        insert into Receiver 
            (
                Id,
                Name,
                Country,
                Province,
                City,
                Address,
                Contact,
                ContactTel
            )
        values 
            (
                @ReceiverId,
                @ReceiverName,
                @ReceiverCountry,
                @ReceiverProvince,
                @ReceiverCity,
                @ReceiverAddress,
                @ReceiverContact,
                @ReceiverContactTel
            )
            
        if @@rowcount = 0
        begin
            raiserror (150246,18,1)
            return -13
        end
    end
    
    /**/
    select @OpName = formatmessage(150265)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'PlanType=' + @PlanType + N',' +
                       N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'ShipmentNo=' + @ShipmentNo + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'DeliverType=' + @DeliverType + N',' +
                       N'ReceiverName=' + @ReceiverName + N',' +
                       N'ReceiverCountry=' + @ReceiverCountry + N',' +
                       N'ReceiverProvince=' + @ReceiverProvince + N',' +
                       N'ReceiverCity=' + @ReceiverCity + N',' +
                       N'ReceiverAddress=' + @ReceiverAddress + N',' +
                       N'ReceiverContact=' + @ReceiverContact + N',' +
                       N'ReceiverContactTel=' + @ReceiverContactTel + N',' +
                       N'OrderNo=' + @OrderNo + N',' +
                       N'ReceiveType=' + @ReceiveType + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'TrailerNo=' + @TrailerNo + N',' +
                       N'DriverName=' + @DriverName + N',' +
                       N'DriverLicenseNo=' + @DriverLicenseNo + N',' +
                       N'DriverMobileTel=' + @DriverMobileTel + N',' +
                       N'DriverHomeTel=' + @DriverHomeTel + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'ArrivalTime=' + @ArrivalTime + N',' +
                       N'PayerId=' + convert(nvarchar,@PayerId) + N',' +
                       N'PayerName=' + @PayerName + N',' +
                       N'IsConsigning=' + convert(nvarchar,@IsConsigning) + N',' +
                       N'ConsignedDeliveryNo=' + @ConsignedDeliveryNo + N',' +
                       N'IsInstalment=' + convert(nvarchar,@IsInstalment) + N',' +
                       N'StartCountry=' + @StartCountry + N',' +
                       N'StartProvince=' + @StartProvince + N',' +
                       N'StartCity=' + @StartCity + N',' +
                       N'Remark=' + @Remark + N',' +
                       N'CreateTime=' + convert(nvarchar,@CreateTime,120)
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -14
    end
    
    return 0
end
go


create procedure UpdateDispatchBill
@Id bigint,
@CarNo nvarchar(20),
@TrailerNo nvarchar(10),
@CarType nvarchar(10),
@DriverName nvarchar(20),
@DriverLicenseNo nvarchar(20),
@DriverMobileTel nvarchar(20),
@DriverHomeTel nvarchar(20),
@CarrierId bigint,
@CarrierName nvarchar(50),
@CarryingCapacity int,
@BusinessType nvarchar(10),
@PaymentType nvarchar(10),
@TotalPackages int,
@TotalTunnages numeric(25,9),
@TotalPiles numeric(25,9),
@TotalTenThousands numeric(25,9),
@TotalTransportCharges numeric(25,9),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @BillState nvarchar(10)
declare @DriverId bigint
declare @ContractId bigint
declare @ErrorText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    if @CarrierId is null or @CarrierId = 0 or not exists(select * from Carrier where Id = @CarrierId)
    begin
        if @CarrierName is not null and @CarrierName <> ''
        begin
            /**/
            begin try
                exec InsertCarrier @CarrierId output, @CarrierName, @BusinessType, @PaymentType, @OpStaffId, @OpStaffName 
                exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, @CarryingCapacity, @OpStaffId, @OpStaffName 
                if @DriverName is not null and @DriverName <> ''
                begin
                    exec InsertCarrierDriver @CarrierId, @CarNo, @DriverName, @DriverLicenseNo, @DriverMobileTel, @DriverHomeTel, @OpStaffId, @OpStaffName
                end
            end try
            begin catch
                select @ErrorText = formatmessage(150199) + error_message()
                raiserror (@ErrorText,18,1)
                return -1
            end catch
        end
    end
    else
    begin
        /**/
        if exists(select * from Carrier where Name = @CarrierName and Id <> @CarrierId)
        begin
            raiserror (150497,18,1)
            return -2
        end
        
        update Carrier set Name = @CarrierName, BusinessType = @BusinessType, PaymentType = @PaymentType where Id = @CarrierId 
        if @@rowcount = 0
        begin
            raiserror (150207,18,1)
            return -3
        end
        
        if exists(select * from CarrierCar where CarrierId = @CarrierId and CarNo = @CarNo)
        begin
            /**/
            update CarrierCar set TrailerNo = @TrailerNo, CarryingCapacity = @CarryingCapacity where CarrierId = @CarrierId and CarNo = @CarNo 
            if @@rowcount = 0
            begin
                raiserror (150316,18,1)
                return -4
            end
        end
        else
        begin
            /**/
            begin try
                exec InsertCarrierCar @CarrierId, @CarNo, @TrailerNo, @CarryingCapacity, @OpStaffId, @OpStaffName 
            end try
            begin catch
                select @ErrorText = formatmessage(150203) + error_message()
                raiserror (@ErrorText,18,1)
                return -5
            end catch
        end
    
        select @DriverId = Id from CarrierDriver where CarrierId = @CarrierId and LicenseNo = @DriverLicenseNo 
        if @@rowcount = 0
        begin
            if @DriverName is not null and @DriverName <> ''
            begin
                /**/
                begin try
                    exec InsertCarrierDriver @CarrierId, @CarNo, @DriverName, @DriverLicenseNo, @DriverMobileTel, @DriverHomeTel, @OpStaffId, @OpStaffName
                end try
                begin catch
                    select @ErrorText = formatmessage(150216) + error_message()
                    raiserror (@ErrorText,18,1)
                    return -6
                end catch
            end
        end
        else
        begin
            if @DriverName is not null and @DriverName <> ''
            begin
                /**/
                update CarrierDriver set 
                    CarNo = case when charindex(@CarNo, CarNo) > 0 then CarNo else (case when CarNo is null or CarNo = '' then @CarNo else CarNo + ',' + @CarNo end) end,
                    Name = @DriverName, 
                    MobileTel = @DriverMobileTel, 
                    HomeTel = @DriverHomeTel 
                where 
                    Id = @DriverId 
                if @@rowcount = 0
                begin
                    raiserror (150299,18,1)
                    return -7
                end
            end
        end
    end
    
    /**/
    update DispatchBill set 
        CarNo = @CarNo,
        TrailerNo = @TrailerNo,
        CarType = @CarType,
        DriverName = isnull(@DriverName,''),
        DriverLicenseNo = isnull(@DriverLicenseNo,''),
        DriverMobileTel = isnull(@DriverMobileTel,''),
        DriverHomeTel = isnull(@DriverHomeTel,''),
        CarrierId = isnull(@CarrierId,0),
        CarrierName = isnull(@CarrierName,''),
        TotalPackages = @TotalPackages,
        TotalTunnages = @TotalTunnages,
        TotalPiles = @TotalPiles,
        TotalTenThousands = @TotalTenThousands,
        TotalTransportCharges = @TotalTransportCharges,
        CreateTime = @CreateTime 
    where 
        Id = @Id 
            
    if @@rowcount=0
    begin
        raiserror (150315,18,1)
        return -8
    end
    
    
    /**/
    select @OpName = formatmessage(150362)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'TrailerNo=' + @TrailerNo + N',' +
                       N'CarType=' + @CarType + N',' +
                       N'DriverName=' + @DriverName + N',' +
                       N'DriverLicenseNo=' + @DriverLicenseNo + N',' +
                       N'DriverMobileTel=' + @DriverMobileTel + N',' +
                       N'DriverHomeTel=' + @DriverHomeTel + N',' +
                       N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                       N'CarrierName=' + @CarrierName + N',' +
                       N'CarryingCapacity=' + convert(nvarchar,@CarryingCapacity) + N',' +
                       N'BusinessType=' + @BusinessType + N',' +
                       N'PaymentType=' + @PaymentType + N',' +
                       N'TotalPackages=' + convert(nvarchar,@TotalPackages) + N',' +
                       N'TotalTunnages=' + convert(nvarchar,@TotalTunnages) + N',' +
                       N'TotalPiles=' + convert(nvarchar,@TotalPiles) + N',' +
                       N'TotalTenThousands=' + convert(nvarchar,@TotalTenThousands) + N',' +
                       N'TotalTransportCharges=' + convert(nvarchar,@TotalTransportCharges) + N',' +
                       N'CreateTime=' + convert(nvarchar,@CreateTime,120)
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -9
    end
    
    return 0
end
go


create procedure UpdateDispatchBillDeliverPlan
@DispatchBillId bigint,
@PlanId bigint, 
@Packages int,
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@TransportChargeExpression nvarchar(100),
@TransportPriceExpression nvarchar(100),
@KM int,
@TransportPrice numeric(25,9),
@TransportCharges numeric(25,9),
@Remark nvarchar(500),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @Id bigint
declare @PlanType nvarchar(10)
declare @ReceiverName nvarchar(50)
declare @ReceiverCountry nvarchar(20)
declare @ReceiverProvince nvarchar(20)
declare @ReceiverCity nvarchar(20)
declare @StartCountry nvarchar(20)
declare @StartProvince nvarchar(20)
declare @StartCity nvarchar(20)
declare @CreateTime datetime
declare @EndTime datetime
declare @CarrierId bigint 
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @PlanType = PlanType, 
        @ReceiverName = ReceiverName, 
        @ReceiverCountry = ReceiverCountry, 
        @ReceiverProvince = ReceiverProvince, 
        @ReceiverCity = ReceiverCity, 
        @StartCountry = StartCountry, 
        @StartProvince = StartProvince, 
        @StartCity = StartCity,
        @CreateTime = CreateTime
    from 
        DeliverPlan 
    where 
        Id = @PlanId 
        
    if @@rowcount = 0
    begin
        raiserror (150251,18,1)
        return -1
    end
    
    /**/
    select @CarrierId = CarrierId from DispatchBill where Id = @DispatchBillId 
    if @@rowcount = 0
    begin
        raiserror (150319,18,1)
        return -2
    end
    
    /**/
    if @TransportPrice is not null and @TransportPrice > 0
    begin
        if exists (
            select 
                * 
            from 
                CarrierTransportPrice 
            where 
                CarrierId = @CarrierId and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @ReceiverCountry and 
                DestProvince = @ReceiverProvince and 
                DestCity = @ReceiverCity and 
                PlanType = @PlanType and 
                convert(nvarchar(10),StartTime,120) <= convert(nvarchar(10),@CreateTime,120) and 
                convert(nvarchar(10),EndTime,120) >= convert(nvarchar(10),@CreateTime,120))
        begin
            if not exists(select * from Carrier where Id = @CarrierId and BusinessType = formatmessage(150237))
            begin
                update CarrierTransportPrice set 
                    TransportPrice = @TransportPrice 
                where 
                    CarrierId = @CarrierId and 
                    StartCountry = @StartCountry and 
                    StartProvince = @StartProvince and 
                    StartCity = @StartCity and 
                    DestCountry = @ReceiverCountry and 
                    DestProvince = @ReceiverProvince and 
                    DestCity = @ReceiverCity and 
                    PlanType = @PlanType and 
                    convert(nvarchar(10),StartTime,120) <= convert(nvarchar(10),@CreateTime,120) and 
                    convert(nvarchar(10),EndTime,120) >= convert(nvarchar(10),@CreateTime,120)
                    
                if @@rowcount = 0
                begin
                    raiserror (150339,18,1)
                    return -3
                end
            end
        end
        else
        begin
            select 
                @EndTime = min(StartTime)
            from 
                CarrierTransportPrice 
            where 
                CarrierId = @CarrierId and 
                StartCountry = @StartCountry and 
                StartProvince = @StartProvince and 
                StartCity = @StartCity and 
                DestCountry = @ReceiverCountry and 
                DestProvince = @ReceiverProvince and 
                DestCity = @ReceiverCity and 
                PlanType = @PlanType and 
                convert(nvarchar(10),StartTime,120) > convert(nvarchar(10),@CreateTime,120) 
                
            if @EndTime is null
            begin
                set @EndTime = cast('9999-12-31 23:59:59' as datetime)
            end
            else
            begin
                set @EndTime = cast(convert(nvarchar(10),dateadd(day,-1,@EndTime),120) + ' 23:59:59' as datetime)
            end
        
            exec GetId @OpStaffId, @Id output 
            insert into CarrierTransportPrice 
                (
                    Id,
                    CarrierId,
                    StartCountry,
                    StartProvince,
                    StartCity,
                    DestCountry,
                    DestProvince,
                    DestCity,
                    PlanType,
                    StartTime,
                    EndTime,
                    TransportPrice
                )
            values
                (
                    @Id,
                    @CarrierId,
                    @StartCountry,
                    @StartProvince,
                    @StartCity,
                    @ReceiverCountry,
                    @ReceiverProvince,
                    @ReceiverCity,
                    @PlanType,
                    cast(convert(nvarchar(10),@CreateTime,120) + ' 00:00:00' as datetime),
                    @EndTime,
                    @TransportPrice
                )
            if @@rowcount = 0
            begin
                raiserror (150201,18,1)
                return -4
            end
        end
    end
    
    /**/
    if (@TransportChargeExpression is not null and @TransportChargeExpression <> '') and (@TransportPriceExpression is not null and @TransportPriceExpression <> '')
    begin
        if exists (select * from CarrierSettlementExpression where CarrierId = @CarrierId and PlanType = @PlanType)
        begin
            update CarrierSettlementExpression set TransportChargeExpression = @TransportChargeExpression, TransportPriceExpression = @TransportPriceExpression where CarrierId = @CarrierId and PlanType = @PlanType 
            if @@rowcount = 0
            begin
                raiserror (150340,18,1)
                return -5
            end
        end
        else
        begin
            exec GetId @OpStaffId, @Id output 
            insert into CarrierSettlementExpression 
                (
                    Id,
                    CarrierId,
                    PlanType,
                    TransportChargeExpression,
                    TransportPriceExpression
                )
            values
                (
                    @Id,
                    @CarrierId,
                    @PlanType,
                    @TransportChargeExpression,
                    @TransportPriceExpression
                )
            if @@rowcount = 0
            begin
                raiserror (150335,18,1)
                return -6
            end
        end
    end
    
    /**/
    if @KM is not null and @KM > 0
    begin
        if exists(select * from ReceiverDistance where ReceiverName = @ReceiverName and StartCountry = @StartCountry and StartProvince = @StartProvince and StartCity = @StartCity)
        begin
            update ReceiverDistance set KM = @KM where ReceiverName = @ReceiverName and StartCountry = @StartCountry and StartProvince = @StartProvince and StartCity = @StartCity 
            if @@rowcount = 0
            begin
                raiserror (150331,18,1)
                return -7
            end
        end
        else
        begin
            exec GetId @OpStaffId, @Id output 
            insert into ReceiverDistance 
                (
                    Id, 
                    ReceiverName,
                    StartCountry, 
                    StartProvince, 
                    StartCity, 
                    KM
                ) 
            values 
                (
                    @Id, 
                    @ReceiverName,
                    @StartCountry, 
                    @StartProvince, 
                    @StartCity, 
                    @KM 
                )
            if @@rowcount = 0
            begin
                raiserror (150332,18,1)
                return -8
            end
        end
    end
    
    /**/
    update DispatchBillDeliverPlan set 
        Packages = @Packages,
        Tunnages = @Tunnages,
        Piles = @Piles,
        TenThousands = @TenThousands,
        TransportChargeExpression = @TransportChargeExpression,
        TransportPriceExpression = @TransportPriceExpression,
        KM = @KM,
        TransportPrice = @TransportPrice,
        TransportCharges = @TransportCharges,
        Remark = @Remark
    where 
        DispatchBillId = @DispatchBillId and 
        PlanId = @PlanId 
    
    if @@rowcount = 0
    begin
        raiserror (150359,18,1)
        return -9
    end
    
    /**/
    set @OpName = formatmessage(150360)
    set @OpParams = N'DispatchBillId=' + convert(nvarchar,@DispatchBillId) + N',' +
                    N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'TransportChargeExpression=' + @TransportChargeExpression + N',' +
                    N'TransportPriceExpression=' + @TransportPriceExpression + N',' +
                    N'KM=' + convert(nvarchar,@KM) + N',' +
                    N'TransportPrice=' + convert(nvarchar,@TransportPrice) + N',' +
                    N'TransportCharges=' + convert(nvarchar,@TransportCharges) + N',' +
                    N'Remark=' + @Remark
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -10
    end
    
    return 0
end
go


create procedure UpdateEnterWarehouseBill
@Id bigint,
@BillNo nvarchar(20),
@CustomerId bigint,
@CustomerName nvarchar(50),
@DeliveryNo nvarchar(20),
@EnterType nvarchar(10),
@IsConsigning bit,
@Warehouse nvarchar(20),
@ForceFee numeric(25,9),
@HasDrayage bit,
@Remark nvarchar(200),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    update EnterWarehouseBill set 
        BillNo = @BillNo,
        CustomerId = @CustomerId,
        CustomerName = @CustomerName,
        DeliveryNo = @DeliveryNo,
        EnterType = @EnterType,
        IsConsigning = @IsConsigning,
        Warehouse = @Warehouse,
        ForceFee = @ForceFee,
        HasDrayage = @HasDrayage,
        Remark = @Remark,
        CreateTime = @CreateTime 
    where 
        Id = @Id 
        
    if @@rowcount=0
    begin
        raiserror (150404,18,1)
        return -1
    end
    

    /**/
    select @OpName = formatmessage(150405)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'BillNo=' + @BillNo + N',' +
                       N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'EnterType=' + @EnterType + N',' +
                       N'IsConsigning=' + convert(nvarchar,@IsConsigning) + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'ForceFee=' + convert(nvarchar,@ForceFee) + N',' +
                       N'HasDrayage=' + convert(nvarchar,@HasDrayage) + N',' +
                       N'Remark=' + @Remark + N',' +
                       N'CreateTime=' + convert(nvarchar,@CreateTime,120)
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure UpdateEnterWarehouseBillGoods
@Id bigint,
@CustomerId bigint,
@CustomerName nvarchar(50),
@GoodsId bigint,
@GoodsNo nvarchar(20),
@GoodsName nvarchar(50),
@Brand nvarchar(20),
@SpecModel nvarchar(50),
@GWeight nvarchar(20),
@Grade nvarchar(10),
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Warehouse nvarchar(20),
@Location nvarchar(10),
@Packages int,
@PieceWeight numeric(25,9),
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@ProductionDate nvarchar(10),
@ShipmentBillGoodsIds nvarchar(500),
@EnterWarehouseBillId bigint, 
@DeliveryNo nvarchar(20),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OldCustomerId bigint
declare @OldWarehouse nvarchar(20)
declare @OldGoodsId bigint
declare @OldBatchNo nvarchar(20)
declare @OldLocation nvarchar(10) 
declare @OldPackages int
declare @OldTunnages numeric(25,9)
declare @OldPiles numeric(25,9)
declare @OldTenThousands numeric(25,9)
declare @OldPacking nvarchar(10)
declare @OldProductionDate nvarchar(10)
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @StockId bigint
declare @StockDailyId bigint
declare @ErrText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @OldCustomerId = CustomerId, 
        @OldWarehouse = Warehouse 
    from 
        EnterWarehouseBill 
    where 
        Id = @EnterWarehouseBillId 
    if @@rowcount = 0
    begin
        raiserror (150281,18,1)
        return -1
    end
    
    /**/
    select 
        @OldGoodsId = GoodsId, 
        @OldBatchNo = BatchNo, 
        @OldPacking = Packing,
        @OldLocation = Location, 
        @OldPackages = Packages, 
        @OldTunnages = Tunnages,
        @OldPiles = Piles,
        @OldTenThousands = TenThousands,
        @OldProductionDate = ProductionDate 
    from 
        EnterWarehouseBillGoods 
    where 
        Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150410,18,1)
        return -2
    end
    
    /**/
    select 
        @TypeId = TypeId, 
        @TypeName = TypeName, 
        @TypeFullPath = TypeFullPath, 
        @TypeFullName = TypeFullName 
    from 
        Goods 
    where 
        Id = @GoodsId 
    if @@rowcount = 0
    begin
        raiserror (150248,18,1)
        return -3
    end
    
    /**/
    begin try
        exec UpdateGoods @GoodsId, @GoodsName, @TypeId, @GoodsNo, @SpecModel, @GWeight, @Grade, @Brand, @PieceWeight, @Packing, N'', @OpStaffId, @OpStaffName 
    end try
    begin catch
        select @ErrText = formatmessage(150182) + error_message()
        raiserror (@ErrText,18,1)
        return -4
    end catch
    
    
    /**/
    update EnterWarehouseBillGoods set 
        EnterWarehouseBillId = @EnterWarehouseBillId,
        GoodsId = @GoodsId,
        GoodsName = @GoodsName,
        TypeId = @TypeId,
        TypeName = @TypeName,
        TypeFullPath = @TypeFullPath,
        TypeFullName = @TypeFullName,
        GoodsNo = @GoodsNo,
        Brand = @Brand,
        SpecModel = @SpecModel,
        GWeight = @GWeight,
        Grade = @Grade,
        PieceWeight = @PieceWeight,
        Packing = @Packing,
        BatchNo = @BatchNo,
        Location = @Location,
        Packages = @Packages,
        Tunnages = @Tunnages,
        Piles = @Piles,
        TenThousands = @TenThousands,
        ProductionDate = @ProductionDate,
        ShipmentBillGoodsIds = @ShipmentBillGoodsIds
    where 
        Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150406,18,1)
        return -5
    end
    
    /**/
    select 
        @StockId = Id 
    from 
        Stock 
    where 
        CustomerId = @OldCustomerId and 
        GoodsId = @OldGoodsId and 
        BatchNo = @OldBatchNo and 
        Packing = @OldPacking and
        Warehouse = @OldWarehouse and 
        Location = @OldLocation and 
        Packages = @OldPackages and 
        Tunnages = @OldTunnages and 
        Piles = @OldPiles and
        TenThousands = @OldTenThousands and 
        ProductionDate = @OldProductionDate and
        EnterWarehouseBillId = @EnterWarehouseBillId 
    if @@rowcount = 0
    begin
        raiserror (150392,18,1)
        return -6
    end
    
    update Stock set 
        CustomerId = @CustomerId,
        CustomerName = @CustomerName,
        GoodsId = @GoodsId,
        GoodsNo = @GoodsNo,
        GoodsName = @GoodsName,
        Brand = @Brand,
        SpecModel = @SpecModel,
        GWeight = @GWeight,
        Grade = @Grade,
        PieceWeight = @PieceWeight,
        Packing = @Packing,
        BatchNo = @BatchNo,
        Warehouse = @Warehouse,
        Location = @Location,
        Packages = @Packages,
        Tunnages = @Tunnages,
        Piles = @Piles,
        TenThousands = @TenThousands,
        ProductionDate = @ProductionDate,
        EnterWarehouseBillId = @EnterWarehouseBillId,
        DeliveryNo = @DeliveryNo
    where 
        Id = @StockId
    if @@rowcount = 0
    begin
        raiserror (150556,18,1)
        return -7
    end
    
    /**/
    delete from 
        StockDaily 
    where 
        StockId = @StockId and 
        convert(nvarchar(10),CreateTime,120) < convert(nvarchar(10),@CreateTime,120)
    
    while convert(nvarchar(10),@CreateTime,120) < convert(nvarchar(10),getdate(),120)
    begin
        select 
            @StockDailyId = Id 
        from 
            StockDaily 
        where 
            StockId = @StockId and 
            convert(nvarchar(10),CreateTime,120) = convert(nvarchar(10),@CreateTime,120)
        if @@rowcount = 0
        begin
            insert into StockDaily
                (
                    StockId,
                    Packages,
                    Tunnages,
                    Piles,
                    TenThousands,
                    StorageFee,
                    CreateTime
                )
            values
                (
                    @StockId,
                    @Packages,
                    @Tunnages,
                    @Piles,
                    @TenThousands,
                    0,
                    cast(convert(nvarchar(10),@CreateTime,120) + ' 23:59:59' as datetime)
                )
            if @@rowcount = 0
            begin
                raiserror (150648,18,1)
                return -8
            end
        end
        else
        begin
            update StockDaily set 
                Packages = @Packages,
                Tunnages = @Tunnages,
                Piles = @Piles,
                TenThousands = @TenThousands
            where 
                Id = @StockDailyId
            if @@rowcount = 0
            begin
                raiserror (150649,18,1)
                return -9
            end
        end
            
        set @CreateTime = dateadd(day,1,@CreateTime)
    end
    
    
    
    /**/
    set @OpName = formatmessage(150407)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId) + N',' +
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                    N'GoodsNo=' + @GoodsNo + N',' +
                    N'GoodsName=' + @GoodsName + N',' +
                    N'Brand=' + @Brand + N',' +
                    N'SpecModel=' + @SpecModel + N',' +
                    N'GWeight=' + @GWeight + N',' +
                    N'Grade=' + @Grade + N',' +
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'Warehouse=' + @Warehouse + N',' +
                    N'Location=' + @Location + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'PieceWeight=' + convert(nvarchar,@PieceWeight) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'ShipmentBillGoodsIds=' + @ShipmentBillGoodsIds + N',' +
                    N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                    N'CustomerName=' + @CustomerName + N',' +
                    N'Warehouse=' + @Warehouse + N',' +
                    N'DeliveryNo=' + @DeliveryNo
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -10
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Name
 * @ParentId
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure UpdateGoodsType 
@Id bigint,
@Name nvarchar(50),
@ParentId bigint,
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @ParentFullName nvarchar(500)
declare @ParentFullPath nvarchar(500)
declare @FullName nvarchar(500)
declare @FullPath nvarchar(500)
declare @OldFullName nvarchar(500)
declare @OldFullPath nvarchar(500)
declare @ChildTypeId bigint
declare @ChildTypeFullName nvarchar(500)
declare @ChildTypeFullPath nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    if exists(select 1 from GoodsType where Name = @Name and ParentId = @ParentId and Id <> @Id)
    begin
        raiserror (150094,18,1)
        return -1
    end
    
    /**/
    if @ParentId = 0
    begin
        set @ParentFullPath = N''
        set @ParentFullName = N''
    end
    else
    begin
        select @ParentFullPath = FullPath, @ParentFullName = FullName from GoodsType where Id = @ParentId
        if @@rowcount = 0
        begin
            set @ParentFullPath = N''
            set @ParentFullName = N''
        end
    end

    /**/
    select @OldFullPath = FullPath, @OldFullName = FullName from GoodsType where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150095,18,1)
        return -2
    end
    
    /**/
    if @ParentFullPath = N''
        set @FullPath = convert(nvarchar,@Id) + N'\'
    else
        set @FullPath = @ParentFullPath + convert(nvarchar,@Id) + N'\'

    if @ParentFullName = N''
        set @FullName = @Name
    else
        set @FullName = @ParentFullName + N'\' + @Name 
    
    
    /**/
    update GoodsType set ParentId = @ParentId, Name = @Name, FullPath = @FullPath, FullName = @FullName, Remark = @Remark where Id = @Id
    if @@rowcount=0
    begin
        raiserror (150096,18,1)
        return -3
    end
    
	/**/
	update Goods set TypeName = @Name, TypeFullPath = @FullPath where TypeId = @Id
    

    /**/
    declare UpdateChild_Cursor cursor local for select Id,FullPath,FullName from GoodsType 
    open UpdateChild_Cursor
    fetch next from UpdateChild_Cursor into @ChildTypeId,@ChildTypeFullPath,@ChildTypeFullName 
    while @@fetch_status = 0
    begin
        if charindex(@OldFullPath, @ChildTypeFullPath) = 1 and @ChildTypeId <> @Id 
        begin
            set @ChildTypeFullPath = @FullPath + right(@ChildTypeFullPath, (len(@ChildTypeFullPath) - len(@OldFullPath))) 
            set @ChildTypeFullName = @FullName + right(@ChildTypeFullName, (len(@ChildTypeFullName) - len(@OldFullName)))
            
            /**/
            update GoodsType set FullPath = @ChildTypeFullPath, FullName = @ChildTypeFullName where Id = @ChildTypeId 
            if @@rowcount = 0
            begin
                raiserror (150097,18,1)
                return -4
            end

	        /**/
	        update Goods set TypeFullPath = @ChildTypeFullPath where TypeId = @ChildTypeId
        end
        fetch next from UpdateChild_Cursor into @ChildTypeId,@ChildTypeFullPath,@ChildTypeFullName 
    end
    close UpdateChild_Cursor
    deallocate UpdateChild_Cursor
    

    /**/
    select @OpName = formatmessage(150098)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'ParentId=' + convert(nvarchar,@ParentId) + N',' +
                       N'Name=' + @Name + N',' +
                       N'FullPath=' + @FullPath + N',' +
                       N'FullName=' +@FullName + N',' +
                       N'Remark=' + @Remark 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -5
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @Name
 * @ParentId
 * @CountryName
 * @ProvinceName
 * @CityName
 * @Address
 * @PostalCode
 * @Longitude
 * @Latitude
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure UpdateOrganization 
@Id bigint,
@Name nvarchar(50),
@ParentId bigint,
@CountryName nvarchar(20),
@ProvinceName nvarchar(20),
@CityName nvarchar(20),
@Address nvarchar(50),
@PostalCode nvarchar(10),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @ParentFullName nvarchar(1000)
declare @ParentFullPath nvarchar(500)
declare @FullName nvarchar(1000)
declare @FullPath nvarchar(500)
declare @OldFullName nvarchar(1000)
declare @OldFullPath nvarchar(500)
declare @ChildOrganId bigint
declare @ChildOrganFullName nvarchar(1000)
declare @ChildOrganFullPath nvarchar(500)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    if exists(select 1 from Organization where Name = @Name and ParentId = @ParentId and Id <> @Id)
    begin
        raiserror (150052,18,1)
        return -1
    end
    
    /**/
    if @ParentId = 0
    begin
        set @ParentFullName = ''
        set @ParentFullPath = ''
    end
    else
    begin
        select @ParentFullName = FullName, @ParentFullPath = FullPath from Organization where Id = @ParentId
        if @ParentFullName is null set @ParentFullName = ''
        if @ParentFullPath is null set @ParentFullPath = ''
    end

    /**/
    select @OldFullName = FullName, @OldFullPath = FullPath from Organization where Id = @Id 
    if @OldFullName is null or @OldFullPath is null
    begin
        raiserror (150057,18,1)
        return -2
    end
    
    /**/
    if @ParentFullName = ''
        set @FullName = @Name 
    else
        set @FullName = @ParentFullName + '\' + @Name 
        
    if @ParentFullPath = ''
        set @FullPath = convert(nvarchar,@Id) + '\'
    else
        set @FullPath = @ParentFullPath + convert(nvarchar,@Id) + '\'
        
    /**/
    update Organization set 
            Name = @Name, 
            ParentId = @ParentId, 
            FullName = @FullName, 
            FullPath = @FullPath, 
            CountryName = @CountryName, 
            ProvinceName = @ProvinceName, 
            CityName = @CityName, 
            Address = @Address, 
            PostalCode = @PostalCode, 
            Remark = @Remark 
    where 
        Id = @Id 

    if @@rowcount=0
    begin
        raiserror (150058,18,1)
        return -3
    end

	/**/
	update Staff set OrganName = @Name, OrganFullPath = @FullPath where OrganId = @Id
    
    /**/
    update Account set OrganFullName = @FullName where OrganId = @Id 

    /**/
    declare UpdateChild_Cursor cursor local for select Id, FullName, FullPath from Organization  
    open UpdateChild_Cursor
    fetch next from UpdateChild_Cursor into @ChildOrganId, @ChildOrganFullName, @ChildOrganFullPath 
    while @@fetch_status = 0
    begin
        if charindex(@OldFullPath, @ChildOrganFullPath) = 1 and @ChildOrganId <> @Id 
        begin
            set @ChildOrganFullName = @FullName + right(@ChildOrganFullName, (len(@ChildOrganFullName) - len(@OldFullName))) 
            set @ChildOrganFullPath = @FullPath + right(@ChildOrganFullPath, (len(@ChildOrganFullPath) - len(@OldFullPath))) 
            
            /**/
            update Organization set FullName = @ChildOrganFullName, FullPath = @ChildOrganFullPath where Id = @ChildOrganId 
            if @@rowcount = 0
            begin
                raiserror (150059,18,1)
                return -4
            end

			/**/
			update Staff set OrganFullPath = @ChildOrganFullPath where OrganId = @ChildOrganId
            
            /**/
            update Account set OrganFullName = @ChildOrganFullName where OrganId = @ChildOrganId 
        end
        
        fetch next from UpdateChild_Cursor into @ChildOrganId, @ChildOrganFullName, @ChildOrganFullPath 
    end
    close UpdateChild_Cursor
    deallocate UpdateChild_Cursor

    /**/
    select @OpName = formatmessage(150060)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'Name=' + @Name + N',' +
                       N'ParentId=' + convert(nvarchar,@ParentId) + N',' +
                       N'CountryName=' + @CountryName + N',' +
                       N'ProvinceName=' + @ProvinceName + N',' +
                       N'CityName=' + @CityName + N',' +
                       N'Address=' + @Address + N',' +
                       N'PostalCode=' + @PostalCode + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -5
    end
    
    return 0
end
go


create procedure UpdateOutWarehouseBill
@Id bigint,
@BillNo nvarchar(20),
@PlanId bigint,
@CustomerId bigint,
@CustomerName nvarchar(50),
@DeliveryNo nvarchar(20),
@OutType nvarchar(10),
@ReceiverName nvarchar(50),
@ReceiverCountry nvarchar(20),
@ReceiverProvince nvarchar(20),
@ReceiverCity nvarchar(20),
@ReceiverAddress nvarchar(50),
@ReceiverContact nvarchar(20),
@ReceiverContactTel nvarchar(20),
@ReceiveType nvarchar(10),
@CarNo nvarchar(20),
@TrailerNo nvarchar(10),
@CarrierId bigint,
@CarrierName nvarchar(50),
@PayerId bigint,
@PayerName nvarchar(50),
@IsConsigning bit,
@ConsignedDeliveryNo nvarchar(20),
@Warehouse nvarchar(20),
@ForceFee numeric(25,9),
@Remark nvarchar(200),
@CreateTime datetime,
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/
    
    /**/
    update OutWarehouseBill set 
        BillNo = @BillNo,
        PlanId = @PlanId,
        CustomerId = @CustomerId,
        CustomerName = @CustomerName,
        DeliveryNo = @DeliveryNo,
        OutType = @OutType,
        ReceiverName = @ReceiverName,
        ReceiverCountry = @ReceiverCountry,
        ReceiverProvince = @ReceiverProvince,
        ReceiverCity = @ReceiverCity,
        ReceiverAddress = @ReceiverAddress,
        ReceiverContact = @ReceiverContact,
        ReceiverContactTel = @ReceiverContactTel,
        ReceiveType = @ReceiveType,
        CarNo = @CarNo,
        TrailerNo = @TrailerNo,
        CarrierId = @CarrierId,
        CarrierName = @CarrierName,
        PayerId = @PayerId,
        PayerName = @PayerName,
        IsConsigning = @IsConsigning,
        ConsignedDeliveryNo = @ConsignedDeliveryNo,
        Warehouse = @Warehouse,
        ForceFee = @ForceFee,
        Remark = @Remark,
        CreateTime = @CreateTime 
    where  
        Id = @Id 
        
    if @@rowcount=0
    begin
        raiserror (150398,18,1)
        return -1
    end
    
    
    /**/
    select @OpName = formatmessage(150399)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'BillNo=' + @BillNo + N',' +
                       N'PlanId=' + convert(nvarchar,@PlanId) + N',' +
                       N'CustomerId=' + convert(nvarchar,@CustomerId) + N',' +
                       N'CustomerName=' + @CustomerName + N',' +
                       N'DeliveryNo=' + @DeliveryNo + N',' +
                       N'OutType=' + @OutType + N',' +
                       N'ReceiverName=' + @ReceiverName + N',' +
                       N'ReceiverCountry=' + @ReceiverCountry + N',' +
                       N'ReceiverProvince=' + @ReceiverProvince + N',' +
                       N'ReceiverCity=' + @ReceiverCity + N',' +
                       N'ReceiverAddress=' + @ReceiverAddress + N',' +
                       N'ReceiverContact=' + @ReceiverContact + N',' +
                       N'ReceiverContactTel=' + @ReceiverContactTel + N',' +
                       N'ReceiveType=' + @ReceiveType + N',' +
                       N'CarNo=' + @CarNo + N',' +
                       N'TrailerNo=' + @TrailerNo + N',' +
                       N'CarrierId=' + convert(nvarchar,@CarrierId) + N',' +
                       N'CarrierName=' + @CarrierName + N',' +
                       N'PayerId=' + convert(nvarchar,@PayerId) + N',' +
                       N'PayerName=' + @PayerName + N',' +
                       N'IsConsigning=' + convert(nvarchar,@IsConsigning) + N',' +
                       N'ConsignedDeliveryNo=' + @ConsignedDeliveryNo + N',' +
                       N'Warehouse=' + @Warehouse + N',' +
                       N'ForceFee=' + convert(nvarchar,@ForceFee) + N',' +
                       N'Remark=' + @Remark + N',' +
                       N'CreateTime=' + convert(nvarchar,@CreateTime,120)
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure UpdateOutWarehouseBillGoods
@Id bigint,
@OutWarehouseBillId bigint, 
@GoodsId bigint,
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Location nvarchar(10),
@Packages int,
@PieceWeight numeric(25,9),
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @DeliveryNo nvarchar(20)
declare @GoodsName nvarchar(50)
declare @TypeId bigint
declare @TypeName nvarchar(50)
declare @TypeFullPath nvarchar(500)
declare @TypeFullName nvarchar(500)
declare @GoodsNo nvarchar(20)
declare @Brand nvarchar(20)
declare @SpecModel nvarchar(50)
declare @GWeight nvarchar(20)
declare @Grade nvarchar(10)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    select 
        @DeliveryNo = DeliveryNo 
    from 
        EnterWarehouseBill 
    where 
        Id = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        set @DeliveryNo = ''
    end
    
    /**/
    select 
        @GoodsNo = GoodsNo, 
        @GoodsName = Name, 
        @TypeId = TypeId, 
        @TypeName = TypeName, 
        @TypeFullPath = TypeFullPath, 
        @TypeFullName = TypeFullName, 
        @Brand = Brand, 
        @SpecModel = SpecModel, 
        @GWeight = GWeight, 
        @Grade = Grade 
    from 
        Goods 
    where 
        Id = @GoodsId 
    if @@rowcount = 0
    begin
        raiserror (150248,18,1)
        return -2
    end
    
    /**/
    update OutWarehouseBillGoods set 
        OutWarehouseBillId = @OutWarehouseBillId,
        GoodsId = @GoodsId,
        GoodsName = @GoodsName,
        TypeId = @TypeId,
        TypeName = @TypeName,
        TypeFullPath = @TypeFullPath,
        TypeFullName = @TypeFullName,
        GoodsNo = @GoodsNo,
        Brand = @Brand,
        SpecModel = @SpecModel,
        GWeight = @GWeight,
        Grade = @Grade,
        PieceWeight = @PieceWeight,
        Packing = @Packing,
        BatchNo = @BatchNo,
        Location = @Location,
        Packages = @Packages,
        Tunnages = @Tunnages,
        Piles = @Piles,
        TenThousands = @TenThousands,
        ProductionDate = @ProductionDate,
        EnterWarehouseBillId = @EnterWarehouseBillId,
        DeliveryNo = @DeliveryNo 
    where 
        Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150400,18,1)
        return -3
    end
    
    /**/
    set @OpName = formatmessage(150401)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'OutWarehouseBillId=' + convert(nvarchar,@OutWarehouseBillId) + N',' +
                    N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                    N'BatchNo=' + @BatchNo + N',' +
                    N'Packing=' + @Packing + N',' +
                    N'Location=' + @Location + N',' +
                    N'Packages=' + convert(nvarchar,@Packages) + N',' +
                    N'PieceWeight=' + convert(nvarchar,@PieceWeight) + N',' +
                    N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                    N'Piles=' + convert(nvarchar,@Piles) + N',' +
                    N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                    N'ProductionDate=' + @ProductionDate + N',' +
                    N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId) 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -4
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @Name
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure UpdatePermissionGroup
@Id bigint,
@Name nvarchar(50),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

    /**/
    update SysGroup set Name = @Name, Remark = @Remark where Id = @Id 
    
    if @@rowcount=0
    begin
        raiserror (150158,18,1)
        return -1
    end

    /**/
	select @OpName = formatmessage(150159)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'Name=' + @Name + N',' +
                    N'Remark=' + @Remark 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @Name
 * @ParentPositionId
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure UpdatePosition 
@Id bigint,
@Name nvarchar(50),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/

    /**/
    if exists(select 1 from Position where Name = @Name and Id <> @Id)
    begin
        raiserror (150065,18,1)
        return -1
    end
    
    /**/
    update Position set Name = @Name, Remark = @Remark where Id = @Id 

    if @@rowcount=0
    begin
        raiserror (150068,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150069)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'Name=' + @Name + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go



/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @CountryName
 * @Name
 * @Remark
 * @OpStaffId
 * @OpStaffName
 *
*******************************************************************************************/
create procedure UpdateProvince
@Id bigint,
@Name nvarchar(20),
@CountryName nvarchar(20),
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	if exists(select 1 from Province where Name = @Name and CountryName = @CountryName and Id <> @Id)
    begin
        raiserror (150037,18,1)
        return -1
    end

    /**/
    update Province set Name=@Name, CountryName=@CountryName, Remark=@Remark where Id = @Id 
    if @@rowcount=0
    begin
        raiserror (150040,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150041)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'Name=' + @Name + N',' +
                       N'CountryName=' + @CountryName + N',' +
                       N'Remark=' + @Remark 
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure UpdateReceiver
@Id bigint, 
@Name nvarchar(50),
@CountryName nvarchar(20),
@ProvinceName nvarchar(20),
@CityName nvarchar(20),
@Address nvarchar(50),
@ReceiverContact nvarchar(20),
@ReceiverContactTel nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(select * from Receiver where Name = @Name and Id <> @Id)
    begin
        raiserror (150593,18,1)
        return -1
    end

    /**/
    update Receiver set 
        Name = @Name,
        Country = @CountryName,
        Province = @ProvinceName,
        City = @CityName,
        Address = @Address,
        Contact = @ReceiverContact,
        ContactTel = @ReceiverContactTel
    where 
        Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150245,18,1)
        return -2
    end
    
    /**/
    set @OpName = formatmessage(150599)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'Name=' + @Name + N',' +
                    N'CountryName=' + @CountryName + N',' +
                    N'ProvinceName=' + @ProvinceName + N',' +
                    N'CityName=' + @CityName + N',' +
                    N'Address=' + @Address + N',' +
                    N'ReceiverContact=' + @ReceiverContact + N',' +
                    N'ReceiverContactTel=' + @ReceiverContactTel 
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure UpdateShipmentBillDeliveryNo 
@Id bigint,
@DeliveryNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    update ShipmentBill set DeliveryNo = @DeliveryNo where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150543,18,1)
        return -1
    end
    
    
    /**/
    select @OpName = formatmessage(150684)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'DeliveryNo=' + @DeliveryNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure UpdateShipmentBillGoods 
@Id bigint,
@ShipmentBillId bigint,
@GoodsId bigint,
@GoodsNo nvarchar(20),
@BatchNo nvarchar(20),
@Packing nvarchar(10),
@Location nvarchar(10),
@Packages int,
@PieceWeight numeric(25,9),
@Tunnages numeric(25,9),
@Piles numeric(25,9),
@TenThousands numeric(25,9),
@ProductionDate nvarchar(10),
@EnterWarehouseBillId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @DispatchBillId bigint
declare @PlanId bigint
declare @OutType nvarchar(10)
declare @CustomerId bigint
declare @PlanType nvarchar(10)
declare @DeliveryNo nvarchar(20)
declare @ReceiverName nvarchar(50)
declare @Warehouse nvarchar(20)
declare @ConsignedDeliveryNo nvarchar(20)
declare @OldLocation nvarchar(10)
declare @OldPackages int
declare @OldTunnages numeric(25,9)
declare @OldPiles numeric(25,9)
declare @OldTenThousands numeric(25,9)
declare @OutWarehouseBillId bigint
declare @OutWarehouseBillOldTotalTunnages numeric(25,9)
declare @OutWarehouseBillOldTotalPiles numeric(25,9)
declare @OldForceFee numeric(25,9)
declare @OutWarehouseBillTotalTunnages numeric(25,9)
declare @OutWarehouseBillTotalPiles numeric(25,9)
declare @CheckPackages int
declare @CheckPiles numeric(25,9)
declare @CreateTime nvarchar(20)
declare @ErrText nvarchar(max)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /*1.*/
    select 
        @DispatchBillId = DispatchBillId, 
        @PlanId = PlanId, 
        @OutType = OutType
    from 
        ShipmentBill 
    where 
        Id = @ShipmentBillId
    if @@rowcount = 0
    begin
        raiserror (150380,18,1)
        return -1
    end
    
    /*2.*/
    select 
        @CustomerId = CustomerId, 
        @PlanType = PlanType,
        @DeliveryNo = DeliveryNo,
        @ReceiverName = ReceiverName,
        @Warehouse = Warehouse, 
        @ConsignedDeliveryNo = ConsignedDeliveryNo 
    from 
        DeliverPlan 
    where 
        Id = @PlanId 
    if @@rowcount = 0
    begin
        raiserror (150251,18,1)
        return -2
    end
    
    /*3.*/
    select 
        @OldLocation = Location, 
        @OldPackages = Packages, 
        @OldTunnages = Tunnages,
        @OldPiles = Piles,
        @OldTenThousands = TenThousands
    from 
        ShipmentBillGoods 
    where 
        Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150378,18,1)
        return -3
    end
        
    /*4.*/
    update ShipmentBillGoods set 
        Location = @Location, 
        Packages = case when @PlanType = formatmessage(150256) then @Packages else Packages end,
        PieceWeight = case when @PlanType = formatmessage(150256) then @PieceWeight else PieceWeight end,
        Tunnages = case when @PlanType = formatmessage(150256) then @Tunnages else Tunnages end,
        Piles = case when @PlanType = formatmessage(150257) then @Piles else Piles end,
        TenThousands = case when @PlanType = formatmessage(150257) then @TenThousands else TenThousands end
    where 
        Id = @Id
    if @@rowcount = 0
    begin
        raiserror (150379,18,1)
        return -4
    end
    
    /*5.*/
    select 
        @OutWarehouseBillId = Id,
        @CreateTime = CreateTime
    from 
        OutWarehouseBill 
    where 
        ShipmentBillId = @ShipmentBillId 
    if @@rowcount = 0
    begin
        raiserror (150395,18,1)
        return -5
    end
        
    select 
        @OutWarehouseBillOldTotalTunnages = sum(Tunnages), 
        @OutWarehouseBillOldTotalPiles = sum(Piles)
    from 
        OutWarehouseBillGoods 
    where 
        OutWarehouseBillId = @OutWarehouseBillId 
        
    update OutWarehouseBillGoods set 
        Location = @Location, 
        Packages = case when @PlanType = formatmessage(150256) then @Packages else Packages end,
        PieceWeight = case when @PlanType = formatmessage(150256) then @PieceWeight else PieceWeight end,
        Tunnages = case when @PlanType = formatmessage(150256) then @Tunnages else Tunnages end,
        Piles = case when @PlanType = formatmessage(150257) then @Piles else Piles end,
        TenThousands = case when @PlanType = formatmessage(150257) then @TenThousands else TenThousands end
    where 
        OutWarehouseBillId = @OutWarehouseBillId and 
        GoodsId = @GoodsId and 
        BatchNo = @BatchNo and 
        Packing = @Packing and 
        Location = @OldLocation and 
        ProductionDate = @ProductionDate and 
        EnterWarehouseBillId = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150398,18,1)
        return -6
    end
    
    /*6.*/
    select @OldForceFee = ForceFee from OutWarehouseBill where Id = @OutWarehouseBillId 
    if @@rowcount = 0
    begin
        raiserror (150395,18,1)
        return -7
    end
    
    select 
        @OutWarehouseBillTotalTunnages = sum(Tunnages), 
        @OutWarehouseBillTotalPiles = sum(Piles)
    from 
        OutWarehouseBillGoods 
    where 
        OutWarehouseBillId = @OutWarehouseBillId 
        
    update OutWarehouseBill set 
        ForceFee = case 
                       when @OutWarehouseBillOldTotalTunnages > 0 then 
                           round(@OldForceFee / @OutWarehouseBillOldTotalTunnages * @OutWarehouseBillTotalTunnages, 2)
                       else 
                           round(@OldForceFee / @OutWarehouseBillOldTotalPiles * @OutWarehouseBillTotalPiles, 2)
                   end
    where 
        Id = @OutWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150398,18,1)
        return -8
    end
    
    /*7.*/
    if @OutType = formatmessage(150305)
    begin
        /**/
        update DispatchBillGoods set 
            Location = @Location, 
            Packages = case when @PlanType = formatmessage(150256) then @Packages else Packages end,
            PieceWeight = case when @PlanType = formatmessage(150256) then @PieceWeight else PieceWeight end,
            Tunnages = case when @PlanType = formatmessage(150256) then @Tunnages else Tunnages end,
            Piles = case when @PlanType = formatmessage(150257) then @Piles else Piles end,
            TenThousands = case when @PlanType = formatmessage(150257) then @TenThousands else TenThousands end
        where 
            DispatchBillId = @DispatchBillId and 
            PlanId = @PlanId and 
            GoodsId = @GoodsId and 
            BatchNo = @BatchNo and 
            Packing = @Packing and 
            Location = @OldLocation and 
            ProductionDate = @ProductionDate and 
            EnterWarehouseBillId = @EnterWarehouseBillId
        if @@rowcount = 0
        begin
            raiserror (150381,18,1)
            return -9
        end
        
        /**/
        update DispatchBillDeliverPlan set 
            Packages = case when @PlanType = formatmessage(150256) then Packages - @OldPackages + @Packages else Packages end,
            Tunnages = case when @PlanType = formatmessage(150256) then Tunnages - @OldTunnages + @Tunnages else Tunnages end,
            Piles = case when @PlanType = formatmessage(150257) then Piles - @OldPiles + @Piles else Piles end,
            TenThousands = case when @PlanType = formatmessage(150257) then TenThousands - @OldTenThousands + @TenThousands else TenThousands end
        where 
            DispatchBillId = @DispatchBillId and 
            PlanId = @PlanId 
        if @@rowcount = 0
        begin
            raiserror (150359,18,1)
            return -10
        end
        
        /**/
        update DispatchBill set 
            TotalPackages = case when @PlanType = formatmessage(150256) then TotalPackages - @OldPackages + @Packages else TotalPackages end,
            TotalTunnages = case when @PlanType = formatmessage(150256) then TotalTunnages - @OldTunnages + @Tunnages else TotalTunnages end,
            TotalPiles = case when @PlanType = formatmessage(150257) then TotalPiles - @OldPiles + @Piles else TotalPiles end,
            TotalTenThousands = case when @PlanType = formatmessage(150257) then TotalTenThousands - @OldTenThousands + @TenThousands else TotalTenThousands end
        where 
            Id = @DispatchBillId 
        if @@rowcount = 0
        begin
            raiserror (150315,18,1)
            return -11
        end
    end
    
    /*8.*/
    update DeliverPlanGoods set 
        Location = @Location, 
        Packages = case when @PlanType = formatmessage(150256) then Packages - @OldPackages + @Packages else Packages end,
        PieceWeight = case when @PlanType = formatmessage(150256) then @PieceWeight else PieceWeight end,
        Tunnages = case when @PlanType = formatmessage(150256) then Tunnages - @OldTunnages + @Tunnages else Tunnages end,
        Piles = case when @PlanType = formatmessage(150257) then Piles - @OldPiles + @Piles else Piles end,
        TenThousands = case when @PlanType = formatmessage(150257) then TenThousands - @OldTenThousands + @TenThousands else TenThousands end
    where 
        PlanId = @PlanId and 
        GoodsId = @GoodsId and 
        BatchNo = @BatchNo and 
        Packing = @Packing and 
        Location = @OldLocation and 
        ProductionDate = @ProductionDate and 
        EnterWarehouseBillId = @EnterWarehouseBillId
    if @@rowcount = 0
    begin
        raiserror (150545,18,1)
        return -12
    end
    
    /*11.*/
    begin try
        exec RestoreStock @OutWarehouseBillId, @CreateTime, @OpStaffId, @OpStaffName 
    end try
    begin catch
        select @ErrText = error_message()
        raiserror (@ErrText,18,1)
        return -13
    end catch
    
    /*12.*/
    set @CheckPackages = @Packages - @OldPackages
    set @CheckPiles = @Piles - @OldPiles
    
    begin try
        exec CheckStock 
        @CustomerId, 
        @PlanType, 
        @GoodsId, 
        @GoodsNo, 
        @BatchNo, 
        @Packing, 
        @Warehouse, 
        @Location, 
        @ProductionDate, 
        @EnterWarehouseBillId, 
        @ConsignedDeliveryNo,
        @CheckPackages,
        @CheckPiles,
        @OpStaffId, 
        @OpStaffName 
    end try
    begin catch
        select @ErrText = error_message()
        raiserror (@ErrText,18,1)
        return -14
    end catch
    
    /*13.*/
    declare Cursor2 cursor local for 
        select 
            GoodsId, 
            GoodsNo,
            BatchNo,
            Packing,
            Location,
            Packages,
            Tunnages,
            Piles,
            TenThousands,
            ProductionDate,
            EnterWarehouseBillId,
            DeliveryNo
        from 
            OutWarehouseBillGoods 
        where 
            OutWarehouseBillId = @OutWarehouseBillId 
    
    open Cursor2
    fetch next from Cursor2 into 
        @GoodsId, 
        @GoodsNo, 
        @BatchNo, 
        @Packing,
        @Location,
        @Packages,
        @Tunnages,
        @Piles,
        @TenThousands,
        @ProductionDate,
        @EnterWarehouseBillId,
        @DeliveryNo
        
    while @@fetch_status = 0
    begin
        begin try
            exec SubtractStock 
            @CustomerId, 
            @DeliveryNo, 
            @GoodsId, 
            @GoodsNo, 
            @BatchNo, 
            @Packing, 
            @Warehouse, 
            @Location, 
            @ProductionDate, 
            @EnterWarehouseBillId, 
            @ConsignedDeliveryNo,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @OutWarehouseBillId,
            @CreateTime,
            @OpStaffId, 
            @OpStaffName 
        end try
        begin catch
            select @ErrText = error_message()
            raiserror (@ErrText,18,1)
            return -15
        end catch
    
        fetch next from Cursor2 into 
            @GoodsId, 
            @GoodsNo, 
            @BatchNo, 
            @Packing,
            @Location,
            @Packages,
            @Tunnages,
            @Piles,
            @TenThousands,
            @ProductionDate,
            @EnterWarehouseBillId,
            @DeliveryNo
    end
        
    close Cursor2
    deallocate Cursor2
    
    
    /**/
    select @OpName = formatmessage(150383)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'ShipmentBillId=' + convert(nvarchar,@ShipmentBillId) + N',' +
                       N'GoodsId=' + convert(nvarchar,@GoodsId) + N',' +
                       N'GoodsNo=' + @GoodsNo + N',' +
                       N'BatchNo=' + @BatchNo + N',' +
                       N'Packing=' + @Packing + N',' +
                       N'Location=' + @Location + N',' +
                       N'Packages=' + convert(nvarchar,@Packages) + N',' +
                       N'Tunnages=' + convert(nvarchar,@Tunnages) + N',' +
                       N'Piles=' + convert(nvarchar,@Piles) + N',' +
                       N'TenThousands=' + convert(nvarchar,@TenThousands) + N',' +
                       N'ProductionDate=' + @ProductionDate + N',' +
                       N'EnterWarehouseBillId=' + convert(nvarchar,@EnterWarehouseBillId)
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -16
    end
    
    return 0
end
go


/********************************************************************************************
 * 
 *
 * 
 * @Id
 * @FamilyName
 * @Name
 * @Sex
 * @OrganId
 * @PositionId
 * @OfficeTel
 * @TelExt
 * @Fax
 * @MobileTel11
 * @MobileTel22
 * @MobileTel33
 * @EMail
 * @QQQQ
 * @TakePercent
 * @LimitLoan
 * @LoginAccount
 * @IsOrganLeader
 * @BossStaffId
 * @OpStaffId
 * @OpStaffName
 *
 *******************************************************************************************/
create procedure UpdateStaff 
@Id bigint,
@FamilyName nvarchar(20),
@Name nvarchar(20),
@Sex nchar(1),
@OrganId bigint,
@PositionId bigint,
@OfficeTel nvarchar(20),
@TelExt nvarchar(20),
@Fax nvarchar(20),
@MobileTel1 nvarchar(20),
@MobileTel2 nvarchar(20),
@MobileTel3 nvarchar(20),
@EMail nvarchar(255),
@QQ nvarchar(20),
@IsOrganManager bit,
@IsOrganLeader bit,
@BossStaffId bigint,
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OrganName nvarchar(50)
declare @OrganFullPath nvarchar(500)
declare @PositionName nvarchar(20)
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if @IsOrganLeader = 1 and exists(select * from Staff where OrganId = @OrganId and IsOrganLeader = 1 and Id <> @Id)
    begin
        raiserror (150072,18,1)
        return -1
    end
    
    /**/
    select @OrganName = Name, @OrganFullPath = FullPath from Organization where Id = @OrganId 
    if @@rowcount = 0
    begin
        raiserror (150077,18,1)
        return -2
    end
    
    /**/
    select @PositionName = Name from Position where Id = @PositionId 
    if @@rowcount = 0
    begin
        raiserror (150074,18,1)
        return -3
    end
    
    /**/
    update Staff set 
        FamilyName = @FamilyName,
        Name = @Name,
        Sex = @Sex,
        OrganId = @OrganId,
        OrganName = @OrganName,
		OrganFullPath = @OrganFullPath,
        PositionId = @PositionId,
        PositionName = @PositionName,
        OfficeTel = @OfficeTel,
        TelExt = @TelExt,
        Fax = @Fax,
        MobileTel1 = @MobileTel1,
        MobileTel2 = @MobileTel2,
        MobileTel3 = @MobileTel3,
        EMail = @EMail,
        QQ = @QQ,
        IsOrganManager = @IsOrganManager,
        IsOrganLeader = @IsOrganLeader,
        BossStaffId = @BossStaffId 
    where 
        Id = @Id 
                
    if @@rowcount = 0
    begin
        raiserror (150078,18,1)
        return -4
    end

    /**/
    select @OpName = formatmessage(150079)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'FamilyName=' + @FamilyName + N',' +
                       N'Name=' + @Name + N',' +
                       N'Sex=' + @Sex + N',' +
                       N'OrganId=' + convert(nvarchar,@OrganId) + N',' +
                       N'OrganName=' + @OrganName + N',' +
                       N'OrganFullPath=' + @OrganFullPath + N',' +
                       N'PositionId=' + convert(nvarchar,@PositionId) + N',' +
                       N'PositionName=' + @PositionName + N',' +
                       N'OfficeTel=' + @OfficeTel + N',' +
                       N'TelExt=' + @TelExt + N',' +
                       N'Fax=' + @Fax + N',' +
                       N'MobileTel1=' + @MobileTel1 + N',' +
                       N'MobileTel2=' + @MobileTel2 + N',' +
                       N'MobileTel3=' + @MobileTel3 + N',' +
                       N'EMail=' + @EMail + N',' +
                       N'QQ=' + @QQ + N',' +
                       N'IsOrganManager=' + convert(nvarchar,@IsOrganManager) + N',' +
                       N'IsOrganLeader=' + convert(nvarchar,@IsOrganLeader) + N',' +
                       N'BossStaffId=' + convert(nvarchar,@BossStaffId) 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -5
    end
    
    return 0
end
go


create procedure UpdateStockDeliveryNo 
@Id bigint,
@DeliveryNo nvarchar(20),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    update Stock set DeliveryNo = @DeliveryNo where Id = @Id 
    if @@rowcount = 0
    begin
        raiserror (150295,18,1)
        return -1
    end
    
    
    /**/
    select @OpName = formatmessage(150687)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'DeliveryNo=' + @DeliveryNo 
    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -2
    end
    
    return 0
end
go


create procedure UpdateTransportLimitedPrice
@Id bigint,
@PlanType nvarchar(10),
@StartCountry nvarchar(20),
@StartProvince nvarchar(20),
@StartCity nvarchar(20),
@DestCountry nvarchar(20),
@DestProvince nvarchar(20),
@DestCity nvarchar(20),
@CarType nvarchar(10),
@MinTunnagesOrPiles numeric(25,9),
@MaxTunnagesOrPiles numeric(25,9),
@StartTime datetime,
@EndTime datetime,
@TransportPrice numeric(25,9),
@TransportCharges numeric(25,9),
@OpStaffId bigint,
@OpStaffName nvarchar(50) 
with encryption 
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int 
begin
    set nocount on
    
    /**/
    /*set xact_abort on*/
    
    /**/
    if exists(
        select 
            * 
        from 
            TransportLimitedPrice 
        where 
            PlanType = @PlanType and 
            StartCountry = @StartCountry and 
            StartProvince = @StartProvince and 
            StartCity = @StartCity and 
            DestCountry = @DestCountry and 
            DestProvince = @DestProvince and 
            DestCity = @DestCity and 
            CarType = @CarType and 
            MinTunnagesOrPiles < @MaxTunnagesOrPiles and 
            MaxTunnagesOrPiles > @MinTunnagesOrPiles and 
            StartTime < @EndTime and 
            EndTime > @StartTime and
            Id <> @Id)
    begin
        raiserror (150222,18,1)
        return -1
    end
    
    /**/
    update TransportLimitedPrice set 
        PlanType = @PlanType,
        StartCountry = @StartCountry,
        StartProvince = @StartProvince,
        StartCity = @StartCity,
        DestCountry = @DestCountry,
        DestProvince = @DestProvince,
        DestCity = @DestCity,
        CarType = @CarType,
        MinTunnagesOrPiles = @MinTunnagesOrPiles,
        MaxTunnagesOrPiles = @MaxTunnagesOrPiles,
        StartTime = @StartTime,
        EndTime = @EndTime,
        TransportPrice = @TransportPrice,
        TransportCharges = @TransportCharges
    where 
        Id = @Id 
    
    if @@rowcount = 0
    begin
        raiserror (150225,18,1)
        return -2
    end
    
    /**/
    set @OpName = formatmessage(150226)
    set @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                    N'PlanType=' + @PlanType + N',' +
                    N'StartCountry=' + @StartCountry + N',' +
                    N'StartProvince=' + @StartProvince + N',' +
                    N'StartCity=' + @StartCity + N',' +
                    N'DestCountry=' + @DestCountry + N',' +
                    N'DestProvince=' + @DestProvince + N',' +
                    N'DestCity=' + @DestCity + N',' +
                    N'CarType=' + @CarType + N',' +
                    N'MinTunnagesOrPiles=' + convert(nvarchar,@MinTunnagesOrPiles) + N',' +
                    N'MaxTunnagesOrPiles=' + convert(nvarchar,@MaxTunnagesOrPiles) + N',' +
                    N'StartTime=' + convert(nvarchar(10),@StartTime,120) + N',' +
                    N'EndTime=' + convert(nvarchar(10),@EndTime,120) + N',' +
                    N'TransportPrice=' + convert(nvarchar,@TransportPrice) + N',' +
                    N'TransportCharges=' + convert(nvarchar,@TransportCharges)
                    
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create procedure UpdateWarehouse
@Id bigint,
@Name nvarchar(50),
@IsLease bit,
@Remark nvarchar(100),
@OpStaffId bigint,
@OpStaffName nvarchar(50)
with encryption
as
declare @OpName nvarchar(500)
declare @OpParams nvarchar(max)
declare @OpRet int
begin
	set nocount on

	/**/
	/*set xact_abort on*/

	/**/
	if exists(select 1 from Warehouse where Name = @Name and Id <> @Id)
    begin
        raiserror (150188,18,1)
        return -1
    end

    /**/
    update Warehouse set Name=@Name, IsLease=@IsLease, Remark=@Remark where Id = @Id 
    if @@rowcount=0
    begin
        raiserror (150193,18,1)
        return -2
    end

    /**/
    select @OpName = formatmessage(150194)
    select @OpParams = N'Id=' + convert(nvarchar,@Id) + N',' +
                       N'Name=' + @Name + N',' +
                       N'IsLease=' + convert(nvarchar,@IsLease) + N',' +
                       N'Remark=' + @Remark 
                       
    exec InsertOpLog @OpStaffId,@OpStaffName,@OpName,@OpParams,@OpRet output
    if @OpRet = 1
    begin
        raiserror (150001,18,1)
        return -3
    end
    
    return 0
end
go


create trigger dbo.Trigger_UpdateFlowStep on dbo.ApproveFlowStep with encryption for update as
begin
    declare @OldStepName nvarchar(50)
    declare @OldStepNum int
    declare @FlowType nvarchar(50)
    declare @OldDisposerId bigint
    declare @OldDisposerName nvarchar(50)
    
    declare @NewStepNum int
    declare @NewStepName nvarchar(50)
    declare @NewDisposerId bigint
    declare @NewDisposerName nvarchar(50)
    

    set nocount on
    
    /**/
    select 
        @OldStepName = StepName, 
        @OldStepNum = StepNum, 
        @FlowType = FlowType, 
        @OldDisposerId = DisposerId, 
        @OldDisposerName = DisposerName 
    from 
        deleted
    

    /*1.*/
    if update(StepNum)
    begin
        /**/
        select @NewStepNum = StepNum from inserted 
        
        /**/
        if @FlowType = formatmessage(150672)
        begin
            update Contract set 
                ApproveFlowStepNum = @NewStepNum 
            where 
                ApproveFlowStepNum = @OldStepNum and 
                ApproveFlowStepName = @OldStepName and 
                ApproverId = @OldDisposerId and 
                ApproverName = @OldDisposerName and 
				IsPrestowage = 1
                
            set @OldStepNum = @NewStepNum
        end
    end
    
    /*2.*/
    if update(StepName)
    begin
        /**/
        select @NewStepName = StepName from inserted 
        
        /**/
        if @FlowType = formatmessage(150672)
        begin
            update Contract set 
                ApproveFlowStepName = @NewStepName 
            where 
                ApproveFlowStepNum = @OldStepNum and 
                ApproveFlowStepName = @OldStepName and 
                ApproverId = @OldDisposerId and 
                ApproverName = @OldDisposerName and 
				IsPrestowage = 1
                
            set @OldStepName = @NewStepName
        end
    end
    
    /*3.*/
    if update(DisposerId)
    begin
        /**/
        select @NewDisposerId = DisposerId, @NewDisposerName = DisposerName from inserted 
        
        /**/
        if @FlowType = formatmessage(150672)
        begin
            update Contract set 
                ApproverId = @NewDisposerId,
                ApproverName = @NewDisposerName 
            where 
                ApproveFlowStepNum = @OldStepNum and 
                ApproveFlowStepName = @OldStepName and 
                ApproverId = @OldDisposerId and 
                ApproverName = @OldDisposerName and 
				IsPrestowage = 1
                
            set @OldDisposerId = @NewDisposerId
            set @OldDisposerName = @NewDisposerName
        end
    end
    
    return
end
go


create trigger dbo.Trigger_UpdatePlanState on dbo.DeliverPlan with encryption for update as
begin
    declare @PlanId as bigint
    declare @PlanType as nvarchar(10)
    declare @DeliverType as nvarchar(10)
    declare @CustomerId bigint
    declare @CustomerName nvarchar(50)
    declare @DeliveryNo nvarchar(20)
    declare @ReceiverName nvarchar(50)
    declare @ReceiverCountry nvarchar(20)
    declare @ReceiverProvince nvarchar(20)
    declare @ReceiverCity nvarchar(20)
    declare @ReceiverAddress nvarchar(50)
    declare @ReceiverContact nvarchar(20)
    declare @ReceiverContactTel nvarchar(20)
    declare @ReceiveType nvarchar(10)
    declare @CarNo nvarchar(20)
    declare @TrailerNo nvarchar(10)
    declare @DriverName nvarchar(20)
    declare @DriverLicenseNo nvarchar(20)
    declare @DriverMobileTel nvarchar(20)
    declare @DriverHomeTel nvarchar(20)
    declare @CarrierId bigint
    declare @CarrierName nvarchar(50)
    declare @Warehouse nvarchar(20)
    declare @ConsignedDeliveryNo nvarchar(20)
    declare @PlanState as nvarchar(10)
    declare @ShipmentBillId bigint
    declare @ShipmentBillNo nvarchar(20)
    declare @ShipmentBillState nvarchar(10)
    declare @CreatorId bigint
    declare @CreatorName nvarchar(20)
    declare @CreateTime datetime
    declare @CreateOrganId bigint
    declare @CreateOrganName nvarchar(50)
    declare @OwnOrganId bigint
    declare @OwnOrganName nvarchar(50)
    declare @GoodsId bigint
    declare @GoodsName nvarchar(50)
    declare @TypeId bigint
    declare @TypeName nvarchar(50)
    declare @TypeFullPath nvarchar(500)
    declare @TypeFullName nvarchar(500)
    declare @GoodsNo nvarchar(20)
    declare @Brand nvarchar(20)
    declare @SpecModel nvarchar(50)
    declare @GWeight nvarchar(20)
    declare @Grade nvarchar(10)
    declare @PieceWeight numeric(25,9)
    declare @Packing nvarchar(10)
    declare @BatchNo nvarchar(20)
    declare @Location nvarchar(10)
    declare @DispatchPackages int /**/
    declare @DispatchTunnages numeric(25,9) /**/
    declare @DispatchPiles numeric(25,9) /**/
    declare @DispatchTenThousands numeric(25,9) /**/
    declare @ProductionDate nvarchar(10)
    declare @EnterWarehouseBillId bigint
    declare @ShipmentBillGoodsId bigint
    declare @ErrText nvarchar(max)
    declare @TotalPackages int
    declare @TotalTunnages numeric(25,9)
    declare @TotalPiles numeric(25,9)
    declare @TotalTenThousands numeric(25,9)
    declare @DispatchBillId bigint
    declare @BusinessType nvarchar(10)
    declare @PaymentType nvarchar(10)
    declare @CarryingCapacity int


    set nocount on

    if update(PlanState)
    begin
        /**/
        select 
            @PlanId = Id, 
            @PlanType = PlanType, 
            @DeliverType = DeliverType, 
            @CustomerId = CustomerId, 
            @CustomerName = CustomerName, 
            @DeliveryNo = DeliveryNo, 
            @ReceiverName = ReceiverName, 
            @ReceiverCountry = ReceiverCountry, 
            @ReceiverProvince = ReceiverProvince, 
            @ReceiverCity = ReceiverCity, 
            @ReceiverAddress = ReceiverAddress, 
            @ReceiverContact = ReceiverContact, 
            @ReceiverContactTel = ReceiverContactTel, 
            @ReceiveType = ReceiveType, 
            @CarNo = CarNo,
            @TrailerNo = TrailerNo,
            @DriverName = DriverName,
            @DriverLicenseNo = DriverLicenseNo,
            @DriverMobileTel = DriverMobileTel,
            @DriverHomeTel = DriverHomeTel,
            @CarrierId = CarrierId,
            @CarrierName = CarrierName,
            @Warehouse = Warehouse,
            @ConsignedDeliveryNo = ConsignedDeliveryNo, 
            @PlanState = PlanState,
            @CreatorId = CreatorId,
            @CreatorName = CreatorName,
            @CreateOrganId = CreateOrganId,
            @CreateOrganName = CreateOrganName,
            @OwnOrganId = OwnOrganId,
            @OwnOrganName = OwnOrganName,
            @CreateTime = CreateTime
        from 
            inserted 
        
        /**/
        select 
            @TotalPackages = isnull(sum(Packages),0),
            @TotalTunnages = isnull(sum(Tunnages),0.0),
            @TotalPiles = isnull(sum(Piles),0.0),
            @TotalTenThousands = isnull(sum(TenThousands),0.0)
        from 
            DeliverPlanGoods 
        where 
            PlanId = @PlanId
            
        
        /**/
        if @PlanType = formatmessage(150256) and @DeliverType = formatmessage(150306) and @PlanState = formatmessage(150242)
        begin
            /**/
            exec GetId @CreatorId, @ShipmentBillId output 
    
            /**/
            exec GetNo N'ShipmentBill', @ShipmentBillNo output
            set @ShipmentBillNo = N'C' + @ShipmentBillNo 
    
            /**/
            set @ShipmentBillState = formatmessage(150241)
        
            /**/
            insert into ShipmentBill 
            (
                Id,
                BillNo,
                DispatchBillId,
                PlanId,
                CustomerId,
                CustomerName,
                DeliveryNo,
                OutType,
                ReceiverName,
                ReceiverCountry,
                ReceiverProvince,
                ReceiverCity,
                ReceiverAddress,
                ReceiverContact,
                ReceiverContactTel,
                ReceiveType,
                CarNo,
                TrailerNo,
                CarrierId,
                CarrierName,
                Warehouse,
                CreatorId,
                CreatorName,
                CreateOrganId,
                CreateOrganName,
                CreateTime,
                OwnOrganId,
                OwnOrganName,
                BillState,
                PrintState
            )
            values 
            (
                @ShipmentBillId,
                @ShipmentBillNo,
                0,
                @PlanId,
                @CustomerId,
                @CustomerName,
                @DeliveryNo,
                @DeliverType,
                @ReceiverName,
                @ReceiverCountry,
                @ReceiverProvince,
                @ReceiverCity,
                @ReceiverAddress,
                @ReceiverContact,
                @ReceiverContactTel,
                @ReceiveType,
                N'',
                N'',
                0,
                N'',
                @Warehouse,
                @CreatorId,
                @CreatorName,
                @CreateOrganId,
                @CreateOrganName,
                @CreateTime,
                @OwnOrganId,
                @OwnOrganName,
                @ShipmentBillState,
                0
            )
            if @@rowcount = 0
            begin
                raiserror (150368,18,1)
                return 
            end
            
            /**/
            declare Cursor1 cursor local for 
                select 
                    GoodsId, 
                    GoodsName, 
                    TypeId, 
                    TypeName, 
                    TypeFullPath, 
                    TypeFullName, 
                    GoodsNo, 
                    Brand, 
                    SpecModel, 
                    GWeight, 
                    Grade, 
                    PieceWeight, 
                    Packing, 
                    BatchNo, 
                    Location,
                    Packages, 
                    Tunnages,
                    ProductionDate,
                    EnterWarehouseBillId
                from 
                    DeliverPlanGoods 
                where 
                    PlanId = @PlanId and 
                    (
                        Packages > 0 or Tunnages > 0
                    )
            
            open Cursor1
            fetch next from Cursor1 into 
                @GoodsId, 
                @GoodsName, 
                @TypeId, 
                @TypeName, 
                @TypeFullPath, 
                @TypeFullName, 
                @GoodsNo, 
                @Brand, 
                @SpecModel, 
                @GWeight, 
                @Grade, 
                @PieceWeight, 
                @Packing, 
                @BatchNo, 
                @Location,
                @DispatchPackages, 
                @DispatchTunnages,
                @ProductionDate,
                @EnterWarehouseBillId
                  
            while @@fetch_status = 0
            begin
                /**/
                exec GetId @CreatorId, @ShipmentBillGoodsId output 
           
                /**/
                insert into ShipmentBillGoods 
                (
                    Id,
                    ShipmentBillId,
                    GoodsId,
                    GoodsName,
                    TypeId,
                    TypeName,
                    TypeFullPath,
                    TypeFullName,
                    GoodsNo,
                    Brand,
                    SpecModel,
                    GWeight,
                    Grade,
                    PieceWeight,
                    Packing,
                    BatchNo,
                    Location,
                    Packages,
                    Tunnages,
                    ProductionDate, 
                    EnterWarehouseBillId
                )
                values 
                (
                    @ShipmentBillGoodsId,
                    @ShipmentBillId,
                    @GoodsId,
                    @GoodsName,
                    @TypeId,
                    @TypeName,
                    @TypeFullPath,
                    @TypeFullName,
                    @GoodsNo,
                    @Brand,
                    @SpecModel,
                    @GWeight,
                    @Grade,
                    @PieceWeight,
                    @Packing,
                    @BatchNo,
                    @Location,
                    @DispatchPackages, 
                    @DispatchTunnages,
                    @ProductionDate,
                    @EnterWarehouseBillId
                )
                if @@rowcount = 0
                begin
                    raiserror (150369,18,1)
                    return 
                end
            
                fetch next from Cursor1 into 
                    @GoodsId, 
                    @GoodsName, 
                    @TypeId, 
                    @TypeName, 
                    @TypeFullPath, 
                    @TypeFullName, 
                    @GoodsNo, 
                    @Brand, 
                    @SpecModel, 
                    @GWeight, 
                    @Grade, 
                    @PieceWeight, 
                    @Packing, 
                    @BatchNo, 
                    @Location,
                    @DispatchPackages, 
                    @DispatchTunnages,
                    @ProductionDate,
                    @EnterWarehouseBillId
            end
        
            close Cursor1
            deallocate Cursor1 
        end
        else
        begin
            /**/
            if @DeliverType = formatmessage(150305) and @ReceiveType = formatmessage(150347) and @PlanState = formatmessage(150242)
            begin
                /**/
                select @BusinessType = BusinessType, @PaymentType = PaymentType from Carrier where Id = @CarrierId
                if @@rowcount = 0
                begin
                    set @BusinessType = formatmessage(150341)
                    set @PaymentType = formatmessage(150239)
                end
                
                /**/
                select @CarryingCapacity = CarryingCapacity from CarrierCar where CarrierId = @CarrierId and CarNo = @CarNo
                if @@rowcount = 0
                begin
                    set @CarryingCapacity = 50
                end
            
                /**/
                begin try
                    set @DispatchBillId = 0
                    exec InsertDispatchBill 
                        @DispatchBillId output, 
                        @CarNo, 
                        @TrailerNo, 
                        N'', 
                        @DriverName, 
                        @DriverLicenseNo, 
                        @DriverMobileTel, 
                        @DriverHomeTel, 
                        @CarrierId, 
                        @CarrierName, 
                        @CarryingCapacity, 
                        @BusinessType, 
                        @PaymentType, 
                        @TotalPackages, 
                        @TotalTunnages, 
                        @TotalPiles, 
                        @TotalTenThousands, 
                        0, 
                        @CreateTime, 
                        @CreatorId, 
                        @CreatorName 
                end try
                begin catch
                    select @ErrText =formatmessage(150314) + error_message()
                    raiserror (@ErrText,18,1)
                    return
                end catch
                
                /**/
                begin try
                    exec InsertDispatchBillDeliverPlan 
                        @DispatchBillId, 
                        @PlanId, 
                        @TotalPackages, 
                        @TotalTunnages, 
                        @TotalPiles, 
                        @TotalTenThousands, 
                        N'', 
                        N'', 
                        0, 
                        0, 
                        0, 
                        N'', 
                        N'',
                        @CreatorId, 
                        @CreatorName 
                end try
                begin catch
                    select @ErrText = formatmessage(150317) + error_message()
                    raiserror (@ErrText,18,1)
                    return
                end catch
                
                /**/
                declare Cursor5 cursor local for 
                    select 
                        GoodsId, 
                        BatchNo, 
                        Packing, 
                        Location, 
                        Packages, 
                        PieceWeight, 
                        Tunnages, 
                        Piles,
                        TenThousands,
                        ProductionDate, 
                        EnterWarehouseBillId
                    from 
                        DeliverPlanGoods 
                    where 
                        PlanId = @PlanId and 
                        (
                            Packages > 0 or 
                            Piles > 0
                        )
            
                open Cursor5
                fetch next from Cursor5 into 
                    @GoodsId, 
                    @BatchNo, 
                    @Packing, 
                    @Location, 
                    @DispatchPackages, 
                    @PieceWeight, 
                    @DispatchTunnages, 
                    @DispatchPiles,
                    @DispatchTenThousands,
                    @ProductionDate, 
                    @EnterWarehouseBillId
                    
                while @@fetch_status = 0
                begin
                    begin try
                        exec InsertDispatchBillGoods 
                            @DispatchBillId, 
                            @PlanId, 
                            @GoodsId, 
                            @BatchNo, 
                            @Packing, 
                            @Location, 
                            @DispatchPackages, 
                            @PieceWeight, 
                            @DispatchTunnages, 
                            @DispatchPiles, 
                            @DispatchTenThousands, 
                            @ProductionDate, 
                            @EnterWarehouseBillId, 
                            @CreatorId, 
                            @CreatorName 
                    end try
                    begin catch
                        select @ErrText = formatmessage(150322) + error_message()
                        raiserror (@ErrText,18,1)
                        return
                    end catch
            
                    fetch next from Cursor5 into 
                        @GoodsId, 
                        @BatchNo, 
                        @Packing, 
                        @Location, 
                        @DispatchPackages, 
                        @PieceWeight, 
                        @DispatchTunnages, 
                        @DispatchPiles,
                        @DispatchTenThousands,
                        @ProductionDate, 
                        @EnterWarehouseBillId
                end
        
                close Cursor5
                deallocate Cursor5
            end
        end
    end
    
    return
end
go


/*  Update trigger "Trigger_UpdateStaff" for table "Staff"  */
create trigger Trigger_UpdateStaff on Staff with encryption for update as
begin
    declare @BossId as bigint
    declare @OrganId as bigint
    declare @StaffId as bigint
    declare @SubordinateId as bigint
    declare @IsLeader as bit
    declare @IsManager as bit
    declare @LeaderId as bigint
    declare @LeaderBossId as bigint
    declare @ManagerId as bigint

    set nocount on

    /*1.*/
    if update(BossStaffId)
    begin
        /**/
        select @StaffId = Id, @BossId = BossStaffId from inserted 
        
        /**/
        delete from Boss where StaffId in (select StaffId from Boss where BossId = @StaffId and IsFromLeader = 0) and BossId in (select BossId from Boss where StaffId = @StaffId and IsFromLeader = 0) and IsFromLeader = 0
        
        /**/
        delete from Boss where StaffId = @StaffId and IsFromLeader = 0

        if (@BossId is not null) and (@BossId <> 0)
        begin
            /*Boss*/
            insert into Boss (StaffId, BossId, IsFromLeader) values (@StaffId, @BossId, 0)
    
            /*Boss*/
            insert into Boss (StaffId, BossId, IsFromLeader) select @StaffId, BossId, 0 from Boss where StaffId = @BossId and IsFromLeader = 0

            /**/
            declare Subordinates_Cursor1 cursor local for select StaffId from Boss where BossId = @StaffId and IsFromLeader = 0
            open Subordinates_Cursor1
            fetch next from Subordinates_Cursor1 into @SubordinateId 
            while @@fetch_status = 0
            begin
                /**/
                insert into Boss (StaffId, BossId, IsFromLeader) select @SubordinateId, BossId, 0 from Boss where StaffId = @StaffId
                
                fetch next from Subordinates_Cursor1 into @SubordinateId 
            end
            close Subordinates_Cursor1
            deallocate Subordinates_Cursor1
        end
    end
    
    /*2.*/
    if update(OrganId)
    begin
        /**/
        select @StaffId = Id, @OrganId = OrganId, @IsLeader = IsOrganLeader, @IsManager = IsOrganManager from inserted 
    
        /**/
        delete from Boss where BossId = @StaffId and IsFromLeader = 1
        
        /**/
        if @IsLeader = 0 and @IsManager = 1
        begin
            /**/
            select @LeaderId = Id, @LeaderBossId = BossStaffId from Staff where OrganId = @OrganId and IsOrganLeader = 1
            if (@LeaderId is not null) and (@LeaderId <> 0)
            begin
				/**/
				if @LeaderBossId <> @StaffId 
				begin
                    /**/
	                declare Subordinates_Cursor2 cursor local for select StaffId from Boss where BossId = @LeaderId and StaffId <> @StaffId
                    open Subordinates_Cursor2
                    fetch next from Subordinates_Cursor2 into @SubordinateId 
                    while @@fetch_status = 0
                    begin
                        if not exists(select * from Boss where StaffId = @SubordinateId and BossId = @StaffId)
                        begin
                            /*Boss*/
                            insert into Boss (StaffId, BossId, IsFromLeader) values (@SubordinateId, @StaffId, 1)
                        end
                        fetch next from Subordinates_Cursor2 into @SubordinateId 
                    end
                    close Subordinates_Cursor2
                    deallocate Subordinates_Cursor2
				end
            end
        end
    end
    
    /*3.*/
    if update(IsOrganLeader)
    begin
        /**/
        select @StaffId = Id, @OrganId = OrganId, @IsLeader = IsOrganLeader, @IsManager = IsOrganManager from inserted 
    
        /**/
        delete from Boss where BossId = @StaffId and IsFromLeader = 1
    
        /**/
        if @IsLeader = 1
        begin
            /**/
            declare Subordinates_Cursor3 cursor local for select StaffId from Boss where BossId = @StaffId 
            open Subordinates_Cursor3
            fetch next from Subordinates_Cursor3 into @SubordinateId 
            while @@fetch_status = 0
            begin
                /**/
                declare Managers_Cursor1 cursor local for select Id from Staff where OrganId = @OrganId and IsOrganLeader = 0 and IsOrganManager = 1 and Id <> @SubordinateId
                open Managers_Cursor1
                fetch next from Managers_Cursor1 into @ManagerId 
                while @@fetch_status = 0
                begin
                    if not exists(select * from Boss where StaffId = @SubordinateId and BossId = @ManagerId)
                    begin
                        /*Boss*/
                        insert into Boss (StaffId, BossId, IsFromLeader) values (@SubordinateId, @ManagerId, 1)
                    end
                    fetch next from Managers_Cursor1 into @ManagerId 
                end
                close Managers_Cursor1
                deallocate Managers_Cursor1
            
                fetch next from Subordinates_Cursor3 into @SubordinateId 
            end
            close Subordinates_Cursor3
            deallocate Subordinates_Cursor3
        end
        else
        begin
			/**/
			if @IsManager = 1
			begin
                /**/
                select @LeaderId = Id, @LeaderBossId = BossStaffId from Staff where OrganId = @OrganId and IsOrganLeader = 1
                if (@LeaderId is not null) and (@LeaderId <> 0)
                begin
				    /**/
				    if @LeaderBossId <> @StaffId 
				    begin
                        /**/
	                    declare Subordinates_Cursor4 cursor local for select StaffId from Boss where BossId = @LeaderId and StaffId <> @StaffId
                        open Subordinates_Cursor4
                        fetch next from Subordinates_Cursor4 into @SubordinateId 
                        while @@fetch_status = 0
                        begin
                            if not exists(select * from Boss where StaffId = @SubordinateId and BossId = @StaffId)
                            begin
                                /*Boss*/
                                insert into Boss (StaffId, BossId, IsFromLeader) values (@SubordinateId, @StaffId, 1)
                            end
                            fetch next from Subordinates_Cursor4 into @SubordinateId 
                        end
                        close Subordinates_Cursor4
                        deallocate Subordinates_Cursor4
				    end
                end
			end
        end
    end
    
    /*4.*/
    if update(IsOrganManager)
    begin
        /**/
        select @StaffId = Id, @OrganId = OrganId, @IsLeader = IsOrganLeader, @IsManager = IsOrganManager from inserted 
        
        /**/
        delete from Boss where BossId = @StaffId and IsFromLeader = 1
    
		/**/
		if @IsLeader = 0 and @IsManager = 1
		begin
            /**/
            select @LeaderId = Id, @LeaderBossId = BossStaffId from Staff where OrganId = @OrganId and IsOrganLeader = 1
            if (@LeaderId is not null) and (@LeaderId <> 0)
            begin
                /**/
                if @LeaderBossId <> @StaffId 
                begin
                    /**/
                    declare Subordinates_Cursor5 cursor local for select StaffId from Boss where BossId = @LeaderId and StaffId <> @StaffId
                    open Subordinates_Cursor5
                    fetch next from Subordinates_Cursor5 into @SubordinateId 
                    while @@fetch_status = 0
                    begin
                        if not exists(select * from Boss where StaffId = @SubordinateId and BossId = @StaffId)
                        begin
                            /*Boss*/
                            insert into Boss (StaffId, BossId, IsFromLeader) values (@SubordinateId, @StaffId, 1)
                        end
                        fetch next from Subordinates_Cursor5 into @SubordinateId 
                    end
                    close Subordinates_Cursor5
                    deallocate Subordinates_Cursor5
                end
            end
        end
    end
    
    return
end
go


/*Boss*/
create trigger Trigger_InsertStaff on Staff with encryption for insert as
begin
    declare @DirectBossId as bigint
    declare @StaffId as bigint 
    declare @OrganId as bigint
    declare @IsManager as bit
    declare @IsLeader as bit
    declare @LeaderId as bigint
    declare @SubordinateId as bigint

    set nocount on

    /**/
    select @StaffId = Id, @DirectBossId = BossStaffId, @OrganId = OrganId, @IsLeader = IsOrganLeader, @IsManager = IsOrganManager from inserted 
    
    if (@DirectBossId is not null) and (@DirectBossId <> 0) 
    begin 
        /*Boss*/
        insert into Boss (StaffId, BossId, IsFromLeader) values (@StaffId, @DirectBossId, 0)
    
        /*Boss*/
        insert into Boss (StaffId, BossId, IsFromLeader) select @StaffId, BossId, 0 from Boss where StaffId = @DirectBossId
    end
    
    /**/
    if @IsLeader = 0 and @IsManager = 1
    begin
        /**/
        select @LeaderId = Id from Staff where OrganId = @OrganId and IsOrganLeader = 1
        if (@LeaderId is not null) and (@LeaderId <> 0)
        begin
            /**/
	        declare Subordinates_Cursor cursor local for select StaffId from Boss where BossId = @LeaderId and StaffId <> @StaffId
            open Subordinates_Cursor
            fetch next from Subordinates_Cursor into @SubordinateId 
            while @@fetch_status = 0
            begin
                if not exists(select * from Boss where StaffId = @SubordinateId and BossId = @StaffId)
                begin
                    /*Boss*/
                    insert into Boss (StaffId, BossId, IsFromLeader) values (@SubordinateId, @StaffId, 1)
                end
                fetch next from Subordinates_Cursor into @SubordinateId 
            end
            close Subordinates_Cursor
            deallocate Subordinates_Cursor
        end
    end
    
    return
end
go


/*Boss*/
create trigger Trigger_DeleteStaff on Staff with encryption for delete as
begin
    set nocount on

    /*Boss*/
    delete from Boss where StaffId in (select Id from deleted)
    
    /*Boss*/
    delete from Boss where BossId in (select Id from deleted)
    
    return
end
go

